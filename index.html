<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>DivertScan‚Ñ¢</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--blue-500:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--slate-900);color:var(--slate-200);min-height:100vh;padding-bottom:80px;-webkit-tap-highlight-color:transparent}
.header{background:var(--slate-800);padding:16px 20px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700)}
.logo{font-size:20px;font-weight:700;color:var(--emerald-400)}
.logo span{color:var(--slate-400);font-weight:400;font-size:12px;margin-left:8px}
main{padding:20px;max-width:800px;margin:0 auto}
.card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
.btn{padding:14px 20px;border-radius:8px;font-weight:600;font-size:14px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:48px;transition:all 0.2s}
.btn-primary{background:var(--emerald-500);color:white}
.btn-primary:active{background:var(--emerald-400);transform:scale(0.98)}
.btn-secondary{background:var(--slate-700);color:var(--slate-200)}
.btn-lg{width:100%;padding:18px;font-size:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-input{width:100%;padding:14px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-200);font-size:16px;min-height:48px}
.form-input:focus{outline:none;border-color:var(--emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:40px}
.modal-content{background:var(--slate-800);border-radius:16px;width:100%;max-width:700px;max-height:calc(100vh - 80px);display:flex;flex-direction:column;border:1px solid var(--slate-700)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.modal-title{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{padding:16px 20px;border-top:1px solid var(--slate-700);display:flex;gap:12px;flex-shrink:0}

/* Steps */
.steps{display:flex;justify-content:center;align-items:center;margin-bottom:24px;gap:8px}
.step{width:36px;height:36px;border-radius:50%;background:var(--slate-700);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:var(--slate-400)}
.step.active{background:var(--emerald-500);color:white}
.step.complete{background:var(--emerald-500);color:white}
.step-line{width:40px;height:3px;background:var(--slate-700)}
.step-line.complete{background:var(--emerald-500)}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.photo-slot{aspect-ratio:1;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;color:var(--slate-500);cursor:pointer;position:relative;overflow:hidden}
.photo-slot img{width:100%;height:100%;object-fit:cover}
.photo-slot.filled{border:2px solid var(--emerald-500)}
.photo-slot .remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(--red-500);border-radius:50%;border:none;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Container Select */
.container-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.container-option{background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:18px;font-weight:700}
.container-option small{font-size:11px;color:var(--slate-400)}

/* Verification Box - CRITICAL */
.verification-box{background:var(--slate-700);border:3px solid var(--amber-500);border-radius:12px;padding:20px;margin:20px 0}
.verification-box.verified{border-color:var(--emerald-500);background:rgba(16,185,129,0.15)}
.verification-box label{display:flex;align-items:flex-start;gap:16px;cursor:pointer}
.verification-box input[type="checkbox"]{width:32px;height:32px;min-width:32px;accent-color:var(--emerald-500);cursor:pointer;margin-top:4px}
.verification-box .verify-text{font-weight:700;color:var(--amber-400);font-size:16px}
.verification-box.verified .verify-text{color:var(--emerald-400)}
.verification-box .verify-desc{font-size:13px;color:var(--slate-300);margin-top:6px}

/* Materials */
.material-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--slate-700)}
.material-item:last-child{border-bottom:none}
.material-name{font-size:13px}
.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:60px;padding:8px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:4px;color:white;text-align:center;font-size:14px}

/* Progress */
.progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}
.diversion-badge{font-size:28px;font-weight:700;color:var(--emerald-400)}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--slate-700);color:white;padding:14px 24px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s;font-size:14px;max-width:90%;text-align:center}
.toast.show{opacity:1}
.toast.error{background:var(--red-500)}
.toast.success{background:var(--emerald-500)}

/* Image Preview */
.image-preview{width:100%;aspect-ratio:16/10;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden;color:var(--slate-500);font-size:14px}
.image-preview.filled{border:2px solid var(--emerald-500)}
.image-preview img{width:100%;height:100%;object-fit:contain}

/* Button Row */
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Signature */
.signature-pad{width:100%;height:150px;background:white;border-radius:8px;touch-action:none}

/* Loading */
.loading{text-align:center;padding:20px}
.spinner{width:40px;height:40px;border:3px solid var(--slate-600);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;display:none;align-items:center;justify-content:center;flex-direction:column}
.loading-overlay.active{display:flex}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--slate-800);border-top:1px solid var(--slate-700);display:flex;justify-content:space-around;padding:8px 0;z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--slate-500);font-size:10px;padding:8px 12px;cursor:pointer}
.nav-item.active{color:var(--emerald-400)}
.nav-item svg{width:24px;height:24px}

/* Hide class */
.hidden{display:none !important}
</style>
</head>
<body>

<div class="header">
<div class="logo">DivertScan‚Ñ¢ <span>v4.9</span></div>
<button class="modal-close" onclick="showTab('settings')" style="background:transparent;border:none">‚öôÔ∏è</button>
</div>

<main id="mainContent">
<div id="dashboardTab">
<div class="card">
<div style="font-size:11px;color:var(--slate-400);text-transform:uppercase">Current Project</div>
<div style="font-size:18px;font-weight:600;margin-top:4px" id="currentProjectName">No Project Selected</div>
</div>

<button class="btn btn-primary btn-lg" onclick="startNewTicket()">‚ûï New Ticket</button>

<div class="card" style="margin-top:20px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">Recent Tickets</div>
<div id="recentTickets" style="color:var(--slate-400);font-size:13px">No tickets yet</div>
</div>
</div>

<div id="settingsTab" class="hidden">
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üîë OpenAI API Key</div>
<input type="password" id="apiKeyInput" class="form-input" placeholder="sk-..." style="margin-bottom:12px">
<button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
</div>
</div>
</main>

<nav class="nav">
<div class="nav-item active" onclick="showTab('dashboard')">üè†<span>Home</span></div>
<div class="nav-item" onclick="showTab('settings')">‚öôÔ∏è<span>Settings</span></div>
</nav>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
<div class="spinner"></div>
<p id="loadingText" style="color:white">Processing...</p>
</div>

<!-- New Ticket Modal -->
<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">New Ticket</div>
<button class="modal-close" onclick="closeTicketModal()">√ó</button>
</div>
<div class="modal-body">

<!-- Step Indicators -->
<div class="steps">
<div class="step active" id="stepIndicator1">1</div>
<div class="step-line" id="stepLine1"></div>
<div class="step" id="stepIndicator2">2</div>
<div class="step-line" id="stepLine2"></div>
<div class="step" id="stepIndicator3">3</div>
<div class="step-line" id="stepLine3"></div>
<div class="step" id="stepIndicator4">4</div>
</div>

<!-- STEP 1: Scale Ticket -->
<div id="ticketStep1">
<h3 style="text-align:center;margin-bottom:16px">üìÑ Step 1: Scale Ticket</h3>

<div class="form-group">
<label class="form-label">Project</label>
<select id="ticketProject" class="form-input">
<option value="">Select Project...</option>
<option value="demo">Demo Project</option>
</select>
</div>

<div class="image-preview" id="ticketImagePreview">
<span>Upload scale ticket photo</span>
</div>

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('ticketCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('ticketFileInput').click()">üìÅ Upload</button>
</div>
<input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleTicketPhoto(event)">
<input type="file" id="ticketFileInput" accept="image/*" style="display:none" onchange="handleTicketPhoto(event)">

<div class="form-group">
<label class="form-label">Service Date</label>
<input type="date" id="serviceDate" class="form-input">
</div>

<div class="form-group">
<label class="form-label">Ticket #</label>
<input type="text" id="ticketNumber" class="form-input" placeholder="84600">
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Gross (lbs)</label>
<input type="number" id="grossLbs" class="form-input" placeholder="40000" oninput="updateNetWeight()">
</div>
<div class="form-group">
<label class="form-label">Tare (lbs)</label>
<input type="number" id="tareLbs" class="form-input" placeholder="15000" oninput="updateNetWeight()">
</div>
</div>

<div class="form-group">
<label class="form-label">Net Weight</label>
<div id="netWeightDisplay" style="font-size:28px;font-weight:700;color:var(--emerald-400)">0.00 tons</div>
</div>

<div class="form-group">
<label class="form-label">Hauler</label>
<input type="text" id="haulerName" class="form-input" placeholder="Hauler name">
</div>
</div>

<!-- STEP 2: Debris Photos -->
<div id="ticketStep2" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">üì∏ Step 2: Debris Photos</h3>

<div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between">
<span>Ticket: <strong id="step2TicketNum">--</strong></span>
<span>Net: <strong id="step2NetWeight" style="color:var(--emerald-400)">-- T</strong></span>
</div>

<p style="color:var(--amber-400);text-align:center;margin-bottom:16px;font-size:13px">‚ö†Ô∏è Upload at least 1 photo of debris</p>

<div class="form-group">
<label class="form-label">Container Size</label>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yd</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(0)"><span>?</span><small>other</small></div>
</div>
</div>

<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" id="photoSlot0" onclick="triggerPhotoUpload(0)">‚ûï</div>
<div class="photo-slot" id="photoSlot1" onclick="triggerPhotoUpload(1)">‚ûï</div>
<div class="photo-slot" id="photoSlot2" onclick="triggerPhotoUpload(2)">‚ûï</div>
</div>

<input type="file" id="debrisPhotoInput" accept="image/*" style="display:none" onchange="handleDebrisPhoto(event)">

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="triggerDebrisCamera()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('debrisPhotoInput').click()">üìÅ Upload</button>
</div>

<p style="text-align:center;color:var(--slate-400);margin-bottom:16px">Photos: <span id="photoCount">0</span>/3</p>

<button class="btn btn-primary btn-lg" id="analyzeBtn" onclick="analyzeDebris()">ü§ñ Analyze Materials</button>

<div id="analysisResult" class="hidden" style="margin-top:16px;padding:16px;background:var(--slate-700);border-radius:8px">
<div style="text-align:center">
<div style="font-size:14px;color:var(--slate-400)">Diversion Rate</div>
<div id="analysisRate" style="font-size:36px;font-weight:700;color:var(--emerald-400)">0%</div>
</div>
</div>
</div>

<!-- STEP 3: Review & Verify - WITH CHECKBOX -->
<div id="ticketStep3" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úÖ Step 3: Review & Verify</h3>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400)">Diversion Rate</div>
<div class="diversion-badge" id="reviewDiversionRate">0%</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--slate-400)">LEED Target</div>
<div style="font-size:20px;font-weight:600">75%</div>
</div>
</div>
<div class="progress-bar" style="margin-top:12px">
<div class="progress-fill" id="reviewProgressBar" style="width:0%"></div>
</div>
</div>

<!-- ‚≠ê HUMAN VERIFICATION CHECKBOX ‚≠ê -->
<div class="verification-box" id="verificationBox">
<label>
<input type="checkbox" id="humanVerifyCheckbox" onchange="onVerificationChange()">
<div>
<div class="verify-text">‚ö†Ô∏è REQUIRED: Human Verification</div>
<div class="verify-desc">I have reviewed the photos and confirm the material percentages are accurate or have been corrected.</div>
</div>
</label>
</div>

<div style="font-size:12px;color:var(--slate-400);margin-bottom:8px">MATERIALS (adjust if needed)</div>
<div id="materialsList"></div>

<div style="margin-top:12px;font-size:14px">
Total: <span id="materialsTotal" style="color:var(--emerald-400);font-weight:700">100%</span>
</div>
</div>

<!-- STEP 4: Signature -->
<div id="ticketStep4" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úçÔ∏è Step 4: Sign & Submit</h3>

<div class="card">
<p style="font-size:12px;color:var(--slate-400);margin-bottom:12px">Sign below to certify accuracy</p>
<canvas id="signaturePad" class="signature-pad"></canvas>
<button class="btn btn-secondary" style="margin-top:12px" onclick="clearSignature()">Clear Signature</button>
</div>

<p style="font-size:11px;color:var(--slate-400);margin-top:16px;line-height:1.6">
By signing, I certify that the weights and material percentages are accurate to the best of my knowledge.
</p>
</div>

</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="backBtn" onclick="goBack()" style="flex:1">Back</button>
<button class="btn btn-primary" id="nextBtn" onclick="goNext()" style="flex:1">Next</button>
</div>
</div>
</div>

<script>
// ========== GLOBAL STATE ==========
let currentStep = 1;
let ticketData = {
    projectId: '',
    ticketNumber: '',
    serviceDate: '',
    grossLbs: 0,
    tareLbs: 0,
    netTons: 0,
    hauler: '',
    containerSize: 30,
    photos: [],
    materials: {},
    diversionRate: 0,
    humanVerified: false,
    signature: null
};
let debrisPhotos = [null, null, null];
let currentPhotoSlot = 0;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DivertScan v4.9 initialized');
    
    // Set today's date
    document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
    
    // Load API key
    const savedKey = localStorage.getItem('divertscan_openai');
    if (savedKey) {
        document.getElementById('apiKeyInput').value = savedKey;
    }
});

// ========== TABS ==========
function showTab(tab) {
    document.getElementById('dashboardTab').classList.add('hidden');
    document.getElementById('settingsTab').classList.add('hidden');
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardTab').classList.remove('hidden');
    } else if (tab === 'settings') {
        document.getElementById('settingsTab').classList.remove('hidden');
    }
    
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.toggle('active', (tab === 'dashboard' && i === 0) || (tab === 'settings' && i === 1));
    });
}

// ========== API KEY ==========
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (key) {
        localStorage.setItem('divertscan_openai', key);
        toast('API key saved!', 'success');
    }
}

// ========== TICKET MODAL ==========
function startNewTicket() {
    console.log('Starting new ticket');
    currentStep = 1;
    ticketData = {
        projectId: '',
        ticketNumber: '',
        serviceDate: new Date().toISOString().split('T')[0],
        grossLbs: 0,
        tareLbs: 0,
        netTons: 0,
        hauler: '',
        containerSize: 30,
        photos: [],
        materials: { wood: 20, concrete: 15, metal: 10, cardboard: 20, plastic: 5, drywall: 10, landfill: 20 },
        diversionRate: 0,
        humanVerified: false,
        signature: null
    };
    debrisPhotos = [null, null, null];
    
    // Reset form
    document.getElementById('ticketProject').value = '';
    document.getElementById('serviceDate').value = ticketData.serviceDate;
    document.getElementById('ticketNumber').value = '';
    document.getElementById('grossLbs').value = '';
    document.getElementById('tareLbs').value = '';
    document.getElementById('netWeightDisplay').textContent = '0.00 tons';
    document.getElementById('haulerName').value = '';
    document.getElementById('ticketImagePreview').innerHTML = '<span>Upload scale ticket photo</span>';
    document.getElementById('ticketImagePreview').classList.remove('filled');
    
    // Reset photos
    resetPhotoSlots();
    
    // Reset verification
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) checkbox.checked = false;
    const verifyBox = document.getElementById('verificationBox');
    if (verifyBox) verifyBox.classList.remove('verified');
    
    // Show step 1
    showStep(1);
    
    // Open modal
    document.getElementById('ticketModal').classList.add('active');
}

function closeTicketModal() {
    document.getElementById('ticketModal').classList.remove('active');
}

// ========== STEP NAVIGATION - CRITICAL ==========
function showStep(step) {
    console.log('===== SHOW STEP ' + step + ' =====');
    currentStep = step;
    
    // Hide ALL steps first
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('ticketStep' + i);
        if (stepEl) {
            stepEl.classList.add('hidden');
            stepEl.style.display = 'none';
            console.log('Hidden step ' + i);
        }
    }
    
    // Show current step
    const currentEl = document.getElementById('ticketStep' + step);
    if (currentEl) {
        currentEl.classList.remove('hidden');
        currentEl.style.display = 'block';
        console.log('Showing step ' + step);
    }
    
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById('stepIndicator' + i);
        if (indicator) {
            indicator.classList.remove('active', 'complete');
            if (i < step) indicator.classList.add('complete');
            else if (i === step) indicator.classList.add('active');
        }
        
        if (i < 4) {
            const line = document.getElementById('stepLine' + i);
            if (line) {
                line.classList.toggle('complete', i < step);
            }
        }
    }
    
    // Update buttons
    document.getElementById('backBtn').style.visibility = step === 1 ? 'hidden' : 'visible';
    document.getElementById('nextBtn').textContent = step === 4 ? '‚úÖ Submit' : 'Next';
    
    // Step-specific setup
    if (step === 2) {
        document.getElementById('step2TicketNum').textContent = ticketData.ticketNumber || '--';
        document.getElementById('step2NetWeight').textContent = ticketData.netTons.toFixed(2) + ' T';
    }
    
    if (step === 3) {
        populateReviewStep();
    }
    
    if (step === 4) {
        setupSignaturePad();
    }
    
    // Scroll to top of modal
    const modalBody = document.querySelector('#ticketModal .modal-body');
    if (modalBody) modalBody.scrollTop = 0;
}

function goBack() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function goNext() {
    console.log('goNext called, currentStep:', currentStep);
    
    // STEP 1 VALIDATION
    if (currentStep === 1) {
        const project = document.getElementById('ticketProject').value;
        const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
        const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
        
        if (!project) {
            toast('Please select a project', 'error');
            return;
        }
        if (!gross || !tare) {
            toast('Please enter gross and tare weights', 'error');
            return;
        }
        
        ticketData.projectId = project;
        ticketData.ticketNumber = document.getElementById('ticketNumber').value;
        ticketData.serviceDate = document.getElementById('serviceDate').value;
        ticketData.grossLbs = gross;
        ticketData.tareLbs = tare;
        ticketData.netTons = (gross - tare) / 2000;
        ticketData.hauler = document.getElementById('haulerName').value;
        
        showStep(2);
        return;
    }
    
    // STEP 2 VALIDATION
    if (currentStep === 2) {
        if (ticketData.diversionRate === 0) {
            if (debrisPhotos.some(p => p)) {
                toast('Click "Analyze Materials" first', 'error');
            } else {
                toast('Upload photos and analyze', 'error');
            }
            return;
        }
        
        showStep(3);
        return;
    }
    
    // STEP 3 VALIDATION - CHECK HUMAN VERIFICATION
    if (currentStep === 3) {
        const checkbox = document.getElementById('humanVerifyCheckbox');
        console.log('Checkbox element:', checkbox);
        console.log('Checkbox checked:', checkbox ? checkbox.checked : 'NOT FOUND');
        
        if (!checkbox || !checkbox.checked) {
            toast('Please check the verification box', 'error');
            return;
        }
        
        ticketData.humanVerified = true;
        showStep(4);
        return;
    }
    
    // STEP 4 - SUBMIT
    if (currentStep === 4) {
        submitTicket();
        return;
    }
}

// ========== STEP 1: SCALE TICKET ==========
function handleTicketPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = e.target.result;
        document.getElementById('ticketImagePreview').innerHTML = '<img src="' + img + '">';
        document.getElementById('ticketImagePreview').classList.add('filled');
        
        // Run OCR
        analyzeScaleTicket(img);
    };
    reader.readAsDataURL(file);
}

async function analyzeScaleTicket(imageData) {
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add OpenAI API key in Settings', 'error');
        return;
    }
    
    showLoading('Reading scale ticket...');
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: 'Extract from this scale ticket. Return ONLY JSON: {"ticket_number":"string","date":"MM/DD/YYYY","gross_lbs":number,"tare_lbs":number,"hauler":"string"}' },
                        { type: 'image_url', image_url: { url: imageData } }
                    ]
                }],
                max_tokens: 500
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            toast('API Error: ' + data.error.message, 'error');
            return;
        }
        
        const text = data.choices[0].message.content;
        const match = text.match(/\{[\s\S]*\}/);
        
        if (match) {
            const result = JSON.parse(match[0]);
            
            document.getElementById('ticketNumber').value = result.ticket_number || '';
            document.getElementById('grossLbs').value = result.gross_lbs || '';
            document.getElementById('tareLbs').value = result.tare_lbs || '';
            document.getElementById('haulerName').value = result.hauler || '';
            
            if (result.date) {
                // Try to parse date
                const d = new Date(result.date);
                if (!isNaN(d)) {
                    document.getElementById('serviceDate').value = d.toISOString().split('T')[0];
                }
            }
            
            updateNetWeight();
            toast('‚úÖ Ticket read! Click Next to continue', 'success');
        }
    } catch (err) {
        hideLoading();
        console.error('OCR Error:', err);
        toast('Error reading ticket: ' + err.message, 'error');
    }
}

function updateNetWeight() {
    const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
    const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
    const netLbs = Math.max(0, gross - tare);
    const netTons = netLbs / 2000;
    
    ticketData.grossLbs = gross;
    ticketData.tareLbs = tare;
    ticketData.netTons = netTons;
    
    document.getElementById('netWeightDisplay').textContent = netTons.toFixed(2) + ' tons';
}

// ========== STEP 2: DEBRIS PHOTOS ==========
function selectContainer(size) {
    ticketData.containerSize = size;
    document.querySelectorAll('.container-option').forEach(el => {
        el.classList.toggle('selected', el.querySelector('span').textContent == (size || '?'));
    });
}

function resetPhotoSlots() {
    for (let i = 0; i < 3; i++) {
        const slot = document.getElementById('photoSlot' + i);
        if (slot) {
            slot.innerHTML = '‚ûï';
            slot.classList.remove('filled');
        }
    }
    document.getElementById('photoCount').textContent = '0';
    document.getElementById('analysisResult').classList.add('hidden');
}

function triggerPhotoUpload(slot) {
    currentPhotoSlot = slot;
    document.getElementById('debrisPhotoInput').click();
}

function triggerDebrisCamera() {
    // Find first empty slot
    for (let i = 0; i < 3; i++) {
        if (!debrisPhotos[i]) {
            currentPhotoSlot = i;
            break;
        }
    }
    document.getElementById('debrisPhotoInput').click();
}

function handleDebrisPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = e.target.result;
        debrisPhotos[currentPhotoSlot] = img;
        
        const slot = document.getElementById('photoSlot' + currentPhotoSlot);
        slot.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + currentPhotoSlot + ', event)">√ó</button>';
        slot.classList.add('filled');
        
        updatePhotoCount();
    };
    reader.readAsDataURL(file);
    
    event.target.value = '';
}

function removePhoto(index, event) {
    event.stopPropagation();
    debrisPhotos[index] = null;
    
    const slot = document.getElementById('photoSlot' + index);
    slot.innerHTML = '‚ûï';
    slot.classList.remove('filled');
    
    updatePhotoCount();
}

function updatePhotoCount() {
    const count = debrisPhotos.filter(p => p).length;
    document.getElementById('photoCount').textContent = count;
}

async function analyzeDebris() {
    const photos = debrisPhotos.filter(p => p);
    if (photos.length === 0) {
        toast('Upload at least 1 photo', 'error');
        return;
    }
    
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add OpenAI API key in Settings', 'error');
        return;
    }
    
    showLoading('Analyzing materials...');
    
    try {
        const content = [
            { type: 'text', text: 'Analyze this construction debris. Estimate volume % of each material. Return ONLY JSON: {"wood":0-100,"concrete":0-100,"metal":0-100,"cardboard":0-100,"plastic":0-100,"drywall":0-100,"landfill":0-100}. Must total 100.' }
        ];
        
        photos.forEach(p => {
            content.push({ type: 'image_url', image_url: { url: p } });
        });
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: content }],
                max_tokens: 500
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            toast('API Error: ' + data.error.message, 'error');
            return;
        }
        
        let text = data.choices[0].message.content;
        text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
        
        const match = text.match(/\{[\s\S]*\}/);
        if (match) {
            const result = JSON.parse(match[0]);
            ticketData.materials = result;
            
            // Calculate diversion (everything except landfill)
            const landfill = result.landfill || 0;
            ticketData.diversionRate = 100 - landfill;
            
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = ticketData.diversionRate + '%';
            
            toast('‚úÖ ' + ticketData.diversionRate + '% diversion - Click Next', 'success');
        } else {
            // Fallback
            ticketData.materials = { wood: 25, concrete: 20, metal: 10, cardboard: 15, plastic: 5, drywall: 5, landfill: 20 };
            ticketData.diversionRate = 80;
            
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = '80%';
            
            toast('‚ö†Ô∏è Using estimates - adjust in Step 3', 'success');
        }
        
    } catch (err) {
        hideLoading();
        console.error('Analysis error:', err);
        toast('Analysis failed: ' + err.message, 'error');
    }
}

// ========== STEP 3: REVIEW ==========
function populateReviewStep() {
    console.log('Populating review step');
    
    // Update diversion display
    document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
    document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
    
    // Build materials list
    const materials = ticketData.materials;
    const names = {
        wood: 'ü™µ Wood',
        concrete: 'üß± Concrete',
        metal: 'üî© Metal',
        cardboard: 'üì¶ Cardboard',
        plastic: '‚ôªÔ∏è Plastic',
        drywall: 'üèóÔ∏è Drywall',
        landfill: 'üóëÔ∏è Landfill'
    };
    
    let html = '';
    for (const [key, value] of Object.entries(materials)) {
        html += '<div class="material-item">';
        html += '<span class="material-name">' + (names[key] || key) + '</span>';
        html += '<div class="material-input"><input type="number" id="mat_' + key + '" value="' + (value || 0) + '" min="0" max="100" onchange="updateMaterial(\'' + key + '\')"><span>%</span></div>';
        html += '</div>';
    }
    
    document.getElementById('materialsList').innerHTML = html;
    updateMaterialsTotal();
    
    // Reset verification checkbox
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) {
        checkbox.checked = ticketData.humanVerified;
        onVerificationChange();
    }
}

function updateMaterial(key) {
    const input = document.getElementById('mat_' + key);
    if (input) {
        ticketData.materials[key] = parseInt(input.value) || 0;
        
        // Recalculate diversion
        const landfill = ticketData.materials.landfill || 0;
        ticketData.diversionRate = 100 - landfill;
        document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
        document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
        
        updateMaterialsTotal();
    }
}

function updateMaterialsTotal() {
    let total = 0;
    for (const value of Object.values(ticketData.materials)) {
        total += parseInt(value) || 0;
    }
    
    const totalEl = document.getElementById('materialsTotal');
    totalEl.textContent = total + '%';
    totalEl.style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
}

function onVerificationChange() {
    const checkbox = document.getElementById('humanVerifyCheckbox');
    const box = document.getElementById('verificationBox');
    
    if (checkbox && box) {
        if (checkbox.checked) {
            box.classList.add('verified');
            ticketData.humanVerified = true;
        } else {
            box.classList.remove('verified');
            ticketData.humanVerified = false;
        }
    }
}

// ========== STEP 4: SIGNATURE ==========
function setupSignaturePad() {
    const canvas = document.getElementById('signaturePad');
    if (!canvas) return;
    
    signatureCanvas = canvas;
    signatureCtx = canvas.getContext('2d');
    
    // Set size
    canvas.width = canvas.offsetWidth;
    canvas.height = 150;
    
    // Clear
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    draw(e);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.strokeStyle = 'black';
    
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function stopDrawing() {
    isDrawing = false;
    signatureCtx.beginPath();
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    startDrawing(mouseEvent);
}

function handleTouchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    draw(mouseEvent);
}

function clearSignature() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.fillStyle = 'white';
        signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

// ========== SUBMIT ==========
function submitTicket() {
    // Check signature
    if (signatureCanvas) {
        const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
        let hasSignature = false;
        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i] < 250) { // Not pure white
                hasSignature = true;
                break;
            }
        }
        if (!hasSignature) {
            toast('Please sign to submit', 'error');
            return;
        }
        ticketData.signature = signatureCanvas.toDataURL();
    }
    
    // Check materials total
    let total = 0;
    for (const value of Object.values(ticketData.materials)) {
        total += parseInt(value) || 0;
    }
    if (Math.abs(total - 100) > 1) {
        toast('Materials must total 100%', 'error');
        return;
    }
    
    // Success!
    console.log('Ticket submitted:', ticketData);
    
    closeTicketModal();
    toast('‚úÖ Ticket submitted successfully!', 'success');
}

// ========== UTILITIES ==========
function showLoading(text) {
    document.getElementById('loadingText').textContent = text || 'Processing...';
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function toast(message, type) {
    const t = document.getElementById('toast');
    t.textContent = message;
    t.className = 'toast show ' + (type || '');
    setTimeout(() => t.classList.remove('show'), 3000);
}
</script>

</body>
</html>
