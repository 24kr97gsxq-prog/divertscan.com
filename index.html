<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>DivertScan‚Ñ¢ v7.6 Box Tracker Edition</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ========== COLOR THEME SYSTEM ========== */
:root{
/* Default Theme: Dark Slate (Original) */
--bg-primary:#0f172a;
--bg-secondary:#1e293b;
--bg-tertiary:#334155;
--bg-hover:#475569;
--text-primary:#e2e8f0;
--text-secondary:#94a3b8;
--text-muted:#64748b;
--accent-primary:#10b981;
--accent-secondary:#34d399;
--accent-warning:#f59e0b;
--accent-danger:#ef4444;
--accent-info:#3b82f6;
--border-color:#334155;
--card-bg:#1e293b;
--input-bg:#1e293b;
--nav-bg:rgba(15,23,42,0.95);
--dalmex-green:#2d5a27;
/* Legacy variables for compatibility */
--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--blue-500:#3b82f6
}

/* Theme: DalMex Green */
[data-theme="dalmex"]{
--bg-primary:#1a2e1a;
--bg-secondary:#243524;
--bg-tertiary:#2d5a27;
--bg-hover:#3d6d35;
--text-primary:#e8f5e9;
--text-secondary:#a5d6a7;
--text-muted:#81c784;
--accent-primary:#4caf50;
--accent-secondary:#81c784;
--accent-warning:#ffb74d;
--accent-danger:#ef5350;
--accent-info:#64b5f6;
--border-color:#2d5a27;
--card-bg:#243524;
--input-bg:#1a2e1a;
--nav-bg:rgba(26,46,26,0.95);
--slate-900:#1a2e1a;--slate-800:#243524;--slate-700:#2d5a27;--emerald-500:#4caf50;--emerald-400:#81c784
}

/* Theme: Ocean Blue */
[data-theme="ocean"]{
--bg-primary:#0a1929;
--bg-secondary:#132f4c;
--bg-tertiary:#1e4976;
--bg-hover:#265d97;
--text-primary:#e3f2fd;
--text-secondary:#90caf9;
--text-muted:#64b5f6;
--accent-primary:#2196f3;
--accent-secondary:#64b5f6;
--accent-warning:#ffa726;
--accent-danger:#f44336;
--accent-info:#29b6f6;
--border-color:#1e4976;
--card-bg:#132f4c;
--input-bg:#0a1929;
--nav-bg:rgba(10,25,41,0.95);
--slate-900:#0a1929;--slate-800:#132f4c;--slate-700:#1e4976;--emerald-500:#2196f3;--emerald-400:#64b5f6
}

/* Theme: Sunset Orange */
[data-theme="sunset"]{
--bg-primary:#1a1a2e;
--bg-secondary:#2d2d44;
--bg-tertiary:#4a3f55;
--bg-hover:#5d4e66;
--text-primary:#ffecd2;
--text-secondary:#ffb88c;
--text-muted:#de6262;
--accent-primary:#ff6b6b;
--accent-secondary:#ffa502;
--accent-warning:#ffd93d;
--accent-danger:#ff4757;
--accent-info:#70a1ff;
--border-color:#4a3f55;
--card-bg:#2d2d44;
--input-bg:#1a1a2e;
--nav-bg:rgba(26,26,46,0.95);
--slate-900:#1a1a2e;--slate-800:#2d2d44;--slate-700:#4a3f55;--emerald-500:#ff6b6b;--emerald-400:#ffa502
}

/* Theme: Light Mode */
[data-theme="light"]{
--bg-primary:#f8fafc;
--bg-secondary:#ffffff;
--bg-tertiary:#e2e8f0;
--bg-hover:#cbd5e1;
--text-primary:#1e293b;
--text-secondary:#475569;
--text-muted:#64748b;
--accent-primary:#059669;
--accent-secondary:#10b981;
--accent-warning:#d97706;
--accent-danger:#dc2626;
--accent-info:#2563eb;
--border-color:#e2e8f0;
--card-bg:#ffffff;
--input-bg:#ffffff;
--nav-bg:rgba(248,250,252,0.95);
--slate-900:#f8fafc;--slate-800:#ffffff;--slate-700:#e2e8f0;--slate-400:#475569;--slate-200:#1e293b;--emerald-500:#059669;--emerald-400:#10b981
}

/* Theme: High Contrast */
[data-theme="contrast"]{
--bg-primary:#000000;
--bg-secondary:#121212;
--bg-tertiary:#1e1e1e;
--bg-hover:#2d2d2d;
--text-primary:#ffffff;
--text-secondary:#e0e0e0;
--text-muted:#bdbdbd;
--accent-primary:#00ff88;
--accent-secondary:#00cc6a;
--accent-warning:#ffff00;
--accent-danger:#ff0000;
--accent-info:#00bfff;
--border-color:#333333;
--card-bg:#121212;
--input-bg:#000000;
--nav-bg:rgba(0,0,0,0.98);
--slate-900:#000000;--slate-800:#121212;--slate-700:#1e1e1e;--emerald-500:#00ff88;--emerald-400:#00cc6a
}

/* Theme: Purple Haze */
[data-theme="purple"]{
--bg-primary:#1a1a2e;
--bg-secondary:#25274d;
--bg-tertiary:#3d3d6b;
--bg-hover:#5c5c8a;
--text-primary:#e8e8ff;
--text-secondary:#b8b8d1;
--text-muted:#8888aa;
--accent-primary:#9d4edd;
--accent-secondary:#c77dff;
--accent-warning:#ffbe0b;
--accent-danger:#ff5a5f;
--accent-info:#4cc9f0;
--border-color:#3d3d6b;
--card-bg:#25274d;
--input-bg:#1a1a2e;
--nav-bg:rgba(26,26,46,0.95);
--slate-900:#1a1a2e;--slate-800:#25274d;--slate-700:#3d3d6b;--emerald-500:#9d4edd;--emerald-400:#c77dff
}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;-webkit-tap-highlight-color:transparent;transition:background 0.3s, color 0.3s}
body.logged-in{padding-bottom:80px}

/* Sync/Offline Status Bar */
.status-bar{position:fixed;top:0;left:0;right:0;height:28px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;z-index:500;transition:all 0.3s}
.status-bar.online{background:var(--accent-primary);color:white}
.status-bar.offline{background:var(--accent-danger);color:white}
.status-bar.syncing{background:var(--accent-warning);color:black}
.status-bar.hidden{transform:translateY(-100%)}
body.has-status-bar{padding-top:28px}
body.has-status-bar .header{top:28px}
body.has-status-bar .login-screen{padding-top:48px}

/* Draft indicator */
.draft-badge{background:var(--accent-warning);color:black;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;margin-left:8px}
.autosave-indicator{font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:4px}
.autosave-indicator.saving{color:var(--accent-warning)}
.autosave-indicator.saved{color:var(--accent-primary)}

/* LEED Compliance Badge */
.leed-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600}
.leed-badge.compliant{background:var(--accent-primary);color:white}
.leed-badge.warning{background:var(--accent-warning);color:black}
.leed-badge.fail{background:var(--accent-danger);color:white}

/* Validation errors */
.field-error{border-color:var(--accent-danger)!important}
.error-message{color:var(--accent-danger);font-size:11px;margin-top:4px}

/* Backup panel */
.backup-panel{background:var(--bg-tertiary);border-radius:8px;padding:16px;margin-top:16px}
.backup-info{font-size:11px;color:var(--text-muted);margin-bottom:12px}
.backup-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.backup-stat{background:var(--bg-secondary);padding:8px;border-radius:6px;text-align:center}

/* Report Data Cards */
.report-data-card{background:var(--bg-secondary);border-left:3px solid #2ecc71;border-radius:0 8px 8px 0;padding:14px 16px;margin-bottom:10px;transition:box-shadow 0.2s}
.report-data-card:hover{box-shadow:0 2px 8px rgba(46,204,113,0.15)}
.report-data-card .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.report-data-card .card-title{font-size:13px;font-weight:600;color:var(--text-primary)}
.report-data-card .card-badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.report-data-card .weights-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.report-data-card .weight-cell{background:var(--bg-tertiary);padding:8px;border-radius:6px;text-align:center}
.report-data-card .weight-cell .val{font-size:14px;font-weight:700;color:var(--text-primary)}
.report-data-card .weight-cell .lbl{font-size:9px;color:var(--text-muted);margin-top:2px}
.report-data-card .materials-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.report-data-card .mat-chip{background:var(--bg-tertiary);padding:3px 8px;border-radius:12px;font-size:10px;color:var(--text-secondary)}
.report-data-card .mat-chip.diverted{border:1px solid #2ecc71;color:#2ecc71}
.report-data-card .mat-chip.landfill{border:1px solid var(--accent-danger);color:var(--accent-danger)}

/* Report table hardened headers */
.report-table{width:100%;font-size:11px;border-collapse:collapse}
.report-table thead{background:var(--bg-tertiary)}
.report-table thead th{padding:10px 8px;text-align:left;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:0.3px;color:var(--text-muted);border-bottom:2px solid #2ecc71;position:sticky;top:0;background:var(--bg-tertiary);z-index:1}
.report-table thead th.right{text-align:right}
.report-table thead th.center{text-align:center}
.report-table tbody td{padding:8px;border-bottom:1px solid var(--border-color)}
.report-table tbody tr:hover{background:var(--bg-hover)}
.report-table tfoot td{padding:10px 8px;font-weight:700;border-top:2px solid #2ecc71}

/* Report signature pad */
.report-sig-pad-wrap{background:var(--bg-tertiary);border-radius:8px;padding:16px;margin-top:16px}
.report-sig-pad-wrap canvas{border:1px solid var(--border-color);border-radius:6px;background:white;width:100%;height:100px;touch-action:none}

/* Report project picker */
.report-project-bar{background:linear-gradient(135deg,var(--bg-tertiary),var(--bg-secondary));border:1px solid var(--border-color);border-radius:8px;padding:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.report-project-bar select{flex:1}
.report-project-bar .project-indicator{width:8px;height:8px;border-radius:50%;background:var(--accent-danger)}
.report-project-bar .project-indicator.active{background:#2ecc71}

/* Theme Selector */
.theme-selector{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.theme-option{width:100%;aspect-ratio:1;border-radius:8px;border:3px solid transparent;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.theme-option:hover{transform:scale(1.05)}
.theme-option.active{border-color:var(--accent-primary);box-shadow:0 0 12px var(--accent-primary)}
.theme-option::after{content:attr(data-name);position:absolute;bottom:2px;left:0;right:0;text-align:center;font-size:8px;color:white;text-shadow:0 1px 2px black}
.theme-dark{background:linear-gradient(135deg,#0f172a,#1e293b)}
.theme-dalmex{background:linear-gradient(135deg,#1a2e1a,#2d5a27)}
.theme-ocean{background:linear-gradient(135deg,#0a1929,#1e4976)}
.theme-sunset{background:linear-gradient(135deg,#1a1a2e,#ff6b6b)}
.theme-light{background:linear-gradient(135deg,#f8fafc,#e2e8f0)}
.theme-contrast{background:linear-gradient(135deg,#000000,#00ff88)}
.theme-purple{background:linear-gradient(135deg,#1a1a2e,#9d4edd)}

/* Reduced Motion */
body.reduced-motion *{animation:none!important;transition:none!important}

/* Larger Text */
body.larger-text{font-size:18px}
body.larger-text .form-label{font-size:14px}
body.larger-text .form-input{font-size:16px;padding:14px}
body.larger-text .btn{font-size:15px;padding:14px 20px}
body.larger-text .card{padding:20px}

/* Compact Mode */
body.compact-mode .card{padding:12px;margin-bottom:12px}
body.compact-mode .form-group{margin-bottom:10px}
body.compact-mode .btn{padding:8px 14px}
body.compact-mode main{padding:12px}
.backup-stat-value{font-size:16px;font-weight:700;color:var(--emerald-400)}
.backup-stat-label{font-size:9px;color:var(--slate-400)}

/* Login Screen */
.login-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--slate-900) 0%,var(--slate-800) 100%)}
.login-screen.hidden{display:none}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo h1{font-size:28px;font-weight:700;color:var(--emerald-400)}
.login-logo p{color:var(--slate-400);font-size:13px;margin-top:8px}
.login-box{background:var(--slate-800);border-radius:16px;padding:28px;width:100%;max-width:380px;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:1px solid var(--slate-700)}
.login-tabs{display:flex;margin-bottom:20px;background:var(--slate-700);border-radius:8px;padding:4px}
.login-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s}
.login-tab.active{background:var(--emerald-500);color:white}
.company-badge{display:flex;align-items:center;gap:12px;padding:14px;background:var(--slate-700);border-radius:8px;margin-bottom:20px}
.company-badge-logo{width:48px;height:48px;background:var(--dalmex-green);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:16px}
.company-badge-info{flex:1}
.company-badge-name{font-weight:600;font-size:14px}
.company-badge-address{font-size:10px;color:var(--slate-400);line-height:1.4}
.login-error{color:var(--red-500);font-size:12px;margin-top:8px;text-align:center}
.user-badge{display:flex;align-items:center;gap:8px;font-size:12px}
.user-role{background:var(--emerald-500);color:white;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600}
.user-role.customer{background:var(--blue-500)}
.logout-btn{background:none;border:none;color:var(--slate-400);cursor:pointer;font-size:11px;margin-left:8px}
.portal-banner{background:linear-gradient(135deg,var(--blue-500),#6366f1);padding:14px 20px;color:white}
.portal-banner h2{font-size:15px;font-weight:600}
.portal-banner p{font-size:11px;opacity:0.9;margin-top:2px}
.app-container{display:none}
.app-container.active{display:block}
.header{background:var(--slate-800);padding:16px 20px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700)}
.logo{font-size:20px;font-weight:700;color:var(--emerald-400)}
.logo span{color:var(--slate-400);font-weight:400;font-size:12px;margin-left:8px}
main{padding:20px;max-width:800px;margin:0 auto}
.card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
.btn{padding:14px 20px;border-radius:8px;font-weight:600;font-size:14px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:48px;transition:all 0.2s}
.btn-primary{background:var(--emerald-500);color:white}
.btn-primary:active{background:var(--emerald-400);transform:scale(0.98)}
.btn-secondary{background:var(--slate-700);color:var(--slate-200)}
.btn-lg{width:100%;padding:18px;font-size:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-input{width:100%;padding:14px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-200);font-size:16px;min-height:48px}
.form-input:focus{outline:none;border-color:var(--emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:40px}
.modal-content{background:var(--slate-800);border-radius:16px;width:100%;max-width:700px;max-height:calc(100vh - 80px);display:flex;flex-direction:column;border:1px solid var(--slate-700)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.modal-title{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{padding:16px 20px;border-top:1px solid var(--slate-700);display:flex;gap:12px;flex-shrink:0}

/* Steps */
.steps{display:flex;justify-content:center;align-items:center;margin-bottom:24px;gap:8px}
.step{width:36px;height:36px;border-radius:50%;background:var(--slate-700);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:var(--slate-400)}
.step.active{background:var(--emerald-500);color:white}
.step.complete{background:var(--emerald-500);color:white}
.step-line{width:40px;height:3px;background:var(--slate-700)}
.step-line.complete{background:var(--emerald-500)}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.photo-slot{aspect-ratio:1;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;color:var(--slate-500);cursor:pointer;position:relative;overflow:hidden}
.photo-slot img{width:100%;height:100%;object-fit:cover}
.photo-slot.filled{border:2px solid var(--emerald-500)}
.photo-slot .remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(--red-500);border-radius:50%;border:none;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Container Select */
.container-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.container-option{background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:18px;font-weight:700}
.container-option small{font-size:11px;color:var(--slate-400)}

/* Verification Box - CRITICAL */
.verification-box{background:var(--slate-700);border:3px solid var(--amber-500);border-radius:12px;padding:20px;margin:20px 0}
.verification-box.verified{border-color:var(--emerald-500);background:rgba(16,185,129,0.15)}
.verification-box label{display:flex;align-items:flex-start;gap:16px;cursor:pointer}
.verification-box input[type="checkbox"]{width:32px;height:32px;min-width:32px;accent-color:var(--emerald-500);cursor:pointer;margin-top:4px}
.verification-box .verify-text{font-weight:700;color:var(--amber-400);font-size:16px}
.verification-box.verified .verify-text{color:var(--emerald-400)}
.verification-box .verify-desc{font-size:13px;color:var(--slate-300);margin-top:6px}

/* Materials */
.material-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--slate-700)}
.material-item:last-child{border-bottom:none}
.material-name{font-size:13px}
.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:60px;padding:8px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:4px;color:white;text-align:center;font-size:14px}

/* Progress */
.progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}
.diversion-badge{font-size:28px;font-weight:700;color:var(--emerald-400)}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--slate-700);color:white;padding:14px 24px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s;font-size:14px;max-width:90%;text-align:center}
.toast.show{opacity:1}
.toast.error{background:var(--red-500)}
.toast.success{background:var(--emerald-500)}

/* Image Preview */
.image-preview{width:100%;aspect-ratio:16/10;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden;color:var(--slate-500);font-size:14px}
.image-preview.filled{border:2px solid var(--emerald-500)}
.image-preview img{width:100%;height:100%;object-fit:contain}

/* Button Row */
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Signature */
.signature-pad{width:100%;height:150px;background:white;border-radius:8px;touch-action:none}

/* Loading */
.loading{text-align:center;padding:20px}
.spinner{width:40px;height:40px;border:3px solid var(--slate-600);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;display:none;align-items:center;justify-content:center;flex-direction:column}
.loading-overlay.active{display:flex}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;padding:8px 0;z-index:9999}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--slate-500);font-size:10px;padding:8px 12px;cursor:pointer}
.nav-item.active{color:var(--emerald-400)}
.nav-item svg{width:24px;height:24px}

/* Hide class */
.hidden{display:none !important}

/* Voice Input */
.voice-btn{background:var(--blue-500);color:white;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.2s}
.voice-btn.listening{background:var(--red-500);animation:pulse 1s infinite}
.voice-btn:disabled{background:var(--slate-600);cursor:not-allowed}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.voice-status{font-size:11px;color:var(--slate-400);margin-top:4px;text-align:center}

/* Charts */
.chart-container{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px}
.chart-title{font-size:14px;font-weight:600;margin-bottom:12px}
.chart-wrapper{position:relative;height:200px}

/* Prediction Card */
.prediction-card{background:linear-gradient(135deg,var(--slate-800),var(--slate-700));border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid var(--slate-600)}
.prediction-title{font-size:12px;color:var(--slate-400);text-transform:uppercase;margin-bottom:8px}
.prediction-value{font-size:32px;font-weight:700;color:var(--emerald-400)}
.prediction-label{font-size:12px;color:var(--slate-300);margin-top:4px}
.prediction-progress{height:8px;background:var(--slate-600);border-radius:4px;margin-top:12px;overflow:hidden}
.prediction-progress-fill{height:100%;border-radius:4px;transition:width 0.5s}

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px}
.stat-box{background:var(--slate-800);border-radius:8px;padding:12px;text-align:center}
.stat-box-value{font-size:20px;font-weight:700;color:var(--emerald-400)}
.stat-box-label{font-size:10px;color:var(--slate-400);margin-top:2px}
</style>
</head>
<body>

<!-- SYNC/OFFLINE STATUS BAR -->
<div class="status-bar online hidden" id="statusBar">
<span id="statusBarText">‚úì Online - All data synced</span>
</div>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
<div class="login-logo">
<h1>üîÑ DivertScan‚Ñ¢</h1>
<p>Enterprise Waste Diversion Tracking</p>
<p style="font-size:10px;color:var(--emerald-400);margin-top:4px">v7.1 Bulletproof Edition</p>
</div>

<div class="login-box">
<div class="company-badge">
<div class="company-badge-logo">DM</div>
<div class="company-badge-info">
<div class="company-badge-name">DalMex Recycling LLC</div>
<div class="company-badge-address">2828 Nagel St., Dallas, TX 75220<br>(214) 352-2000</div>
</div>
</div>

<div class="login-tabs">
<div class="login-tab active" onclick="switchLoginTab('admin')">Admin Login</div>
<div class="login-tab" onclick="switchLoginTab('customer')">Customer Portal</div>
</div>

<!-- Admin Login -->
<div id="adminLoginForm">
<div class="form-group">
<label class="form-label">Username</label>
<input type="text" class="form-input" id="adminUsername" placeholder="Enter username">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" class="form-input" id="adminPassword" placeholder="Enter password">
</div>
<button class="btn btn-primary btn-lg" onclick="doAdminLogin()">üîê Login</button>
<div id="adminLoginError" class="login-error"></div>
</div>

<!-- Customer Portal -->
<div id="customerLoginForm" class="hidden">
<div class="form-group">
<label class="form-label">Project Access Code</label>
<input type="text" class="form-input" id="customerCode" placeholder="Enter code (e.g., ABC123)" style="text-transform:uppercase">
</div>
<p style="font-size:10px;color:var(--slate-400);margin-bottom:16px">
Access codes are provided by DalMex Recycling for viewing your project reports.
</p>
<button class="btn btn-primary btn-lg" onclick="doCustomerLogin()">üëÅÔ∏è View Reports</button>
<div id="customerLoginError" class="login-error"></div>
</div>
</div>

<p style="margin-top:20px;color:var(--slate-500);font-size:10px">
DivertScan‚Ñ¢ v7.0 Enterprise ‚Ä¢ Powered by Claude AI
</p>
</div>

<!-- MAIN APP CONTAINER -->
<div class="app-container" id="appContainer">

<div class="header" id="adminHeader">
<div class="logo">DivertScan‚Ñ¢ <span>v7.6</span></div>
<div class="user-badge">
<span id="currentUserName">Admin</span>
<span class="user-role" id="currentUserRole">ADMIN</span>
<button class="logout-btn" onclick="doLogout()">Logout</button>
</div>
</div>

<!-- Customer Portal Header (hidden by default) -->
<div class="header hidden" id="customerHeader">
<div class="logo">DivertScan‚Ñ¢ <span>PORTAL</span></div>
<div class="user-badge">
<span id="portalProjectName">Project</span>
<span class="user-role customer">VIEW ONLY</span>
<button class="logout-btn" onclick="doLogout()">Exit</button>
</div>
</div>

<!-- Portal Banner -->
<div class="portal-banner hidden" id="portalBanner">
<h2>üìä Customer Report Portal</h2>
<p>View-only access to your project's waste diversion data</p>
</div>

<main id="mainContent">
<div id="dashboardTab">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400);text-transform:uppercase">Current Project</div>
<div style="font-size:18px;font-weight:600;margin-top:4px" id="currentProjectName">No Project Selected</div>
<div style="font-size:12px;color:var(--slate-400)" id="currentProjectHauler"></div>
</div>
<button class="btn btn-secondary admin-only" onclick="showProjectPicker()" style="padding:8px 12px;font-size:12px">Change</button>
</div>
</div>

<!-- Quick Actions -->
<div class="card" style="background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary))">
<div style="font-size:12px;font-weight:600;margin-bottom:12px;color:var(--text-secondary)">‚ö° Quick Actions</div>
<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
<button class="btn btn-primary" onclick="startNewTicket()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">‚ûï</span>
<span>New Ticket</span>
</button>
<button class="btn btn-secondary" onclick="triggerExcelImport()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">üìó</span>
<span>Import Excel</span>
</button>
<button class="btn btn-secondary" onclick="showTab('reports');generateReport()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">üìÑ</span>
<span>Report</span>
</button>
<button class="btn btn-secondary" onclick="createFullBackup()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">üíæ</span>
<span>Backup</span>
</button>
<button class="btn btn-secondary" onclick="forceSyncNow()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">üîÑ</span>
<span>Sync</span>
</button>
</div>
</div>

<!-- MAIN Excel Import Input (hidden) -->
<input type="file" id="mainExcelImport" accept=".xlsx,.xls" style="display:none" onchange="importExcelTickets(event)">

<!-- Import Excel Card - Prominent on Dashboard -->
<div class="card" style="margin-top:16px;border:2px solid var(--accent-primary);background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary))">
<div style="display:flex;align-items:center;gap:12px">
<span style="font-size:32px">üìó</span>
<div style="flex:1">
<div style="font-size:15px;font-weight:700;color:var(--accent-primary)">Import Excel Data</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:2px">Import tickets from HD Waste / DalMex Excel reports (.xlsx)</div>
</div>
<button class="btn btn-primary" onclick="triggerExcelImport()" style="padding:12px 20px;font-size:13px;font-weight:600">
üìó Import .xlsx
</button>
</div>
</div>

<div class="card" style="margin-top:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-size:14px;font-weight:600">üìã Ticket Data <span id="ticketCountBadge" style="font-size:11px;background:var(--accent-primary);color:#000;padding:2px 8px;border-radius:10px;margin-left:6px">0</span></div>
<div style="display:flex;gap:6px">
<button class="btn btn-secondary" onclick="loadAllTickets()" style="padding:6px 10px;font-size:10px" title="Load ALL tickets">Load All</button>
<button class="btn btn-secondary" onclick="loadRecentTickets()" style="padding:6px 10px;font-size:10px">Refresh</button>
</div>
</div>
<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" style="display:none;background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(245,158,11,0.1));border:1px solid var(--red-500);border-radius:8px;padding:10px;margin-bottom:10px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="font-size:12px;color:var(--slate-300)"><span id="selectedCount">0</span> selected</div>
<div style="display:flex;gap:6px">
<button class="btn btn-secondary" onclick="selectAllTickets()" style="padding:4px 10px;font-size:10px" id="selectAllBtn">Select All</button>
<button class="btn" onclick="deleteSelectedTickets()" style="background:var(--red-500);color:white;padding:4px 10px;font-size:10px">üóëÔ∏è Delete Selected</button>
</div>
</div>
</div>
<!-- Filter Bar -->
<div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
<input type="text" id="ticketSearchFilter" class="form-input" placeholder="Search ticket #, date..." style="flex:1;min-width:120px;padding:6px 10px;font-size:11px" oninput="filterTicketList()">
<select id="ticketSortOrder" class="form-input" style="width:auto;padding:6px 8px;font-size:11px" onchange="sortTicketList()">
<option value="date-desc">Newest First</option>
<option value="date-asc">Oldest First</option>
<option value="ticket-asc">Ticket # ‚Üë</option>
<option value="tons-desc">Tonnage ‚Üì</option>
<option value="diversion-desc">Diversion % ‚Üì</option>
</select>
</div>
<div id="recentTickets" style="color:var(--text-secondary);font-size:13px;max-height:600px;overflow-y:auto">Loading...</div>
<!-- Bulk Delete All -->
<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--slate-700)">
<button class="btn" onclick="confirmDeleteAllTickets()" style="width:100%;background:rgba(239,68,68,0.15);color:var(--red-400);border:1px solid var(--red-500);font-size:11px;padding:8px">üóëÔ∏è Delete ALL Tickets for This Project</button>
</div>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">üìä Project Stats</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div style="text-align:center;padding:12px;background:var(--bg-tertiary);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--accent-primary)" id="statTotalTons">0.00</div>
<div style="font-size:11px;color:var(--text-muted)">Total Tons</div>
</div>
<div style="text-align:center;padding:12px;background:var(--bg-tertiary);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--accent-primary)" id="statDiversionRate">0%</div>
<div style="font-size:11px;color:var(--text-muted)">Diversion Rate</div>
</div>
</div>
</div>

<!-- LEED Compliance Predictor -->
<div class="prediction-card" id="leedPredictor">
<div class="prediction-title">üéØ LEED MRc5 Compliance Forecast</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div class="prediction-value" id="predictorStatus">--</div>
<div class="prediction-label" id="predictorMessage">Analyzing project data...</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--text-muted)">Target: 75%</div>
<div style="font-size:18px;font-weight:600" id="predictorCurrent">0%</div>
</div>
</div>
<div class="prediction-progress">
<div class="prediction-progress-fill" id="predictorProgressBar" style="width:0%;background:var(--accent-primary)"></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:8px;font-size:10px;color:var(--slate-400)">
<span>0%</span>
<span>50%</span>
<span>75% (LEED)</span>
<span>100%</span>
</div>
</div>

<!-- Material Trend Chart -->
<div class="chart-container">
<div class="chart-title">üìà Material Trends (Last 10 Loads)</div>
<div class="chart-wrapper">
<canvas id="materialTrendChart"></canvas>
</div>
</div>

<!-- Diversion Rate Chart -->
<div class="chart-container">
<div class="chart-title">üìä Diversion Rate Over Time</div>
<div class="chart-wrapper">
<canvas id="diversionChart"></canvas>
</div>
</div>

</div>

<div id="projectsTab" class="hidden">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:18px;font-weight:600">Projects</h2>
<button class="btn btn-primary" onclick="showNewProjectModal()" style="padding:10px 16px">‚ûï New Project</button>
</div>
<div id="projectsList">Loading projects...</div>

<!-- Import/Export Section -->
<div class="card" style="margin-top:20px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üì• Import / Export</div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Import tickets from Excel or export your data</p>

<div style="font-size:12px;font-weight:500;margin-bottom:8px">Import Data</div>
<div class="btn-row" style="margin-bottom:12px">
<button class="btn btn-primary" onclick="triggerExcelImport()" style="flex:1">üìó Import Excel</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="flex:1">üìÑ Import JSON</button>
</div>
<input type="file" id="importFile" accept=".json,.csv" style="display:none" onchange="importProjects(event)">

<div style="font-size:12px;font-weight:500;margin-bottom:8px;margin-top:16px">Export Data</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="exportAllProjects()" style="flex:1">üì§ JSON</button>
<button class="btn btn-secondary" onclick="exportProjectsCSV()" style="flex:1">üìä CSV</button>
<button class="btn btn-primary" onclick="exportProjectsExcel()" style="flex:1">üìó Excel</button>
</div>

<div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-top:12px;font-size:11px">
<div style="font-weight:600;margin-bottom:4px">Excel Import Format:</div>
<div style="color:var(--text-muted)">
Supports HD Waste / DalMex format with columns:<br>
Date, Ticket No, GWT (lbs), Tare (lbs), Net (lbs), Tons, Wood %, Metal %, OCC %, Plastic %, Concrete %, etc.
</div>
</div>
</div>
</div>

<div id="reportsTab" class="hidden">
<h2 style="font-size:18px;font-weight:600;margin-bottom:16px">üìä LEED MRc5 Reports</h2>

<!-- Report Project Picker -->
<div class="report-project-bar">
<div class="project-indicator" id="reportProjectIndicator"></div>
<select id="reportProjectSelect" class="form-input" onchange="onReportProjectChange()" style="margin-bottom:0">
<option value="">‚Äî Select Project ‚Äî</option>
</select>
</div>

<!-- AI Executive Summary Card -->
<div class="card" style="background:linear-gradient(135deg,var(--slate-800),var(--slate-700));border:1px solid var(--emerald-500)">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:24px">ü§ñ</span>
<div>
<div style="font-size:14px;font-weight:600">AI Executive Summary</div>
<div style="font-size:11px;color:var(--slate-400)">Claude AI writes a professional summary for your LEED submission</div>
</div>
</div>
<button class="btn btn-primary" onclick="generateAISummary()" style="width:100%">‚ú® Generate AI Summary</button>
<div id="aiSummaryResult" class="hidden" style="margin-top:12px;padding:12px;background:var(--slate-800);border-radius:8px;font-size:12px;line-height:1.6;color:var(--slate-200)"></div>
<div id="aiSummaryActions" class="hidden" style="margin-top:8px">
<button class="btn btn-primary" onclick="downloadAISummaryPDF()" style="width:100%">üì• Download AI Summary as PDF</button>
</div>
</div>

<!-- Main Report Generation -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">Generate Waste Diversion Report</div>
<p style="font-size:12px;color:var(--slate-400);margin-bottom:16px">LEED v4.1/v5 Construction & Demolition Waste Management compliant report</p>

<div class="form-group">
<label class="form-label">Report Type</label>
<select id="reportType" class="form-input">
<option value="summary">Monthly Summary Report</option>
<option value="detailed">Detailed Load-by-Load Report</option>
<option value="leed">LEED MRc5 Submission Package</option>
<option value="executive">Executive Summary (1-page)</option>
</select>
</div>

<button class="btn btn-primary btn-lg" onclick="generateReport()" style="margin-bottom:12px">üìÑ Generate Report</button>

<div id="reportDownloadBtns" style="display:none">
<div style="font-size:12px;color:var(--emerald-400);margin-bottom:12px">‚úÖ Report generated successfully!</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="previewReportPDF()" style="flex:1">üëÅÔ∏è Preview</button>
<button class="btn btn-primary" onclick="downloadReportPDF()" style="flex:1">üì• Download PDF</button>
</div>
<div class="btn-row" style="margin-top:8px">
<button class="btn btn-secondary" onclick="downloadReportCSV()" style="flex:1">üìä CSV</button>
<button class="btn btn-secondary" onclick="downloadReportExcel()" style="flex:1">üìó Excel</button>
<button class="btn btn-secondary" onclick="emailReport()" style="flex:1">üìß Email</button>
</div>
<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)">
<div style="font-size:12px;font-weight:600;color:var(--slate-300);margin-bottom:8px">üìä Box Tracker Format</div>
<button class="btn btn-primary" onclick="downloadBoxTrackerExcel()" style="width:100%;background:linear-gradient(135deg,#059669,#047857)">üìó Download Box Tracker Report (.xlsx)</button>
<div style="font-size:10px;color:var(--slate-400);margin-top:4px">Monthly tabs ‚Ä¢ GWT/Tare/Net ‚Ä¢ Material % + Tons ‚Ä¢ Totals & Summary</div>
</div>
</div>
</div>

<!-- Report Options -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px;cursor:pointer" onclick="toggleSection('reportOptions')">
‚öôÔ∏è Report Options <span id="reportOptionsArrow">‚ñº</span>
</div>
<div id="reportOptionsContent" class="hidden">
<div class="form-group">
<label class="form-label">Date Range</label>
<div style="display:flex;gap:8px">
<input type="date" id="reportStartDate" class="form-input" style="flex:1">
<input type="date" id="reportEndDate" class="form-input" style="flex:1">
</div>
</div>
<div class="form-group">
<label class="form-label">Include in Report</label>
<div style="display:flex;flex-wrap:wrap;gap:12px;font-size:12px">
<label><input type="checkbox" id="includePhotos" checked> Photos</label>
<label><input type="checkbox" id="includeGPS" checked> GPS Data</label>
<label><input type="checkbox" id="includeSignatures" checked> Signatures</label>
<label><input type="checkbox" id="includeMaterialDetail" checked> Material Detail</label>
<label><input type="checkbox" id="includeAISummary" checked> AI Summary</label>
</div>
</div>
<div class="form-group">
<label class="form-label">Branding</label>
<div style="display:flex;flex-wrap:wrap;gap:12px;font-size:12px">
<label><input type="checkbox" id="includeDalMexBranding" checked> DalMex Header</label>
<label><input type="checkbox" id="includeCertification" checked> Certification Statement</label>
</div>
</div>
</div>
</div>

<!-- LEED Audit Package -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px;cursor:pointer" onclick="toggleSection('bulkExport')">
üì¶ LEED Audit Package <span id="bulkExportArrow">‚ñº</span>
</div>
<div id="bulkExportContent" class="hidden">
<p style="font-size:12px;color:var(--slate-400);margin-bottom:12px">
Complete documentation package for LEED certification review.
</p>

<!-- Audit Report -->
<div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(59,130,246,0.1));border:1px solid var(--emerald-500);border-radius:8px;padding:12px;margin-bottom:12px">
<div style="font-size:13px;font-weight:600;color:var(--emerald-400);margin-bottom:6px">üìã LEED Audit Report</div>
<p style="font-size:11px;color:var(--slate-300);margin-bottom:8px">Multi-page PDF: project summary, material breakdown, diversion rates, photo index, LEED MRc5 compliance.</p>
<button class="btn btn-primary" onclick="generateLEEDAuditReport()" style="width:100%">üìã Generate LEED Audit Report (PDF)</button>
</div>

<!-- Certificate of Destruction -->
<div style="background:linear-gradient(135deg,rgba(239,68,68,0.08),rgba(245,158,11,0.08));border:1px solid var(--amber-500);border-radius:8px;padding:12px;margin-bottom:12px">
<div style="font-size:13px;font-weight:600;color:var(--amber-400);margin-bottom:6px">üîí Certificate of Destruction</div>
<p style="font-size:11px;color:var(--slate-300);margin-bottom:10px">Generate an official certificate verifying materials were securely destroyed/recycled at DalMex Recycling. Used for confidential document destruction (SOP, files, hard drives, etc.).</p>
<div class="form-group" style="margin-bottom:8px">
<label class="form-label" style="font-size:11px">Customer / Company Name *</label>
<input type="text" id="codCustomerName" class="form-input" placeholder="e.g., Junk Luggers" style="font-size:13px">
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Ticket # *</label>
<input type="text" id="codTicketNumber" class="form-input" placeholder="e.g., 83337" style="font-size:13px">
</div>
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Date of Service</label>
<input type="date" id="codServiceDate" class="form-input" style="font-size:13px">
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Material Type *</label>
<select id="codMaterialType" class="form-input" style="font-size:13px">
<option value="Sorted Office Paper (SOP)">Sorted Office Paper (SOP)</option>
<option value="Mixed Paper">Mixed Paper</option>
<option value="Cardboard/OCC">Cardboard/OCC</option>
<option value="Confidential Documents">Confidential Documents</option>
<option value="Hard Drives / Electronics">Hard Drives / Electronics</option>
<option value="Mixed C&D Debris">Mixed C&D Debris</option>
<option value="Commingled Recyclables">Commingled Recyclables</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Net Weight (lbs) *</label>
<input type="number" id="codNetWeight" class="form-input" placeholder="e.g., 5100" style="font-size:13px">
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Gross Weight (lbs)</label>
<input type="number" id="codGrossWeight" class="form-input" placeholder="e.g., 18980" style="font-size:13px">
</div>
<div class="form-group" style="margin-bottom:0">
<label class="form-label" style="font-size:11px">Tare Weight (lbs)</label>
<input type="number" id="codTareWeight" class="form-input" placeholder="e.g., 13880" style="font-size:13px">
</div>
</div>
<div class="form-group" style="margin-bottom:8px">
<label class="form-label" style="font-size:11px">Destruction Method</label>
<select id="codMethod" class="form-input" style="font-size:13px">
<option value="Baled and shipped to certified paper mill for pulping and recycling">Baled & Recycled (Paper Mill)</option>
<option value="Shredded on-site and baled for recycling">Shredded & Recycled</option>
<option value="Mechanically shredded and processed for secure destruction">Mechanically Destroyed</option>
<option value="Processed and recycled through certified downstream facility">Processed & Recycled</option>
<option value="Sorted, processed, and diverted from landfill for recycling">Sorted & Diverted</option>
</select>
</div>
<div class="form-group" style="margin-bottom:10px">
<label class="form-label" style="font-size:11px">Additional Notes (optional)</label>
<input type="text" id="codNotes" class="form-input" placeholder="e.g., COD payment received" style="font-size:13px">
</div>
<button class="btn btn-primary" onclick="generateCertificateOfDestruction()" style="width:100%;background:linear-gradient(135deg,#d97706,#b45309)">üîí Generate Certificate of Destruction (PDF)</button>
</div>

<!-- Quick Exports -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
<button class="btn btn-secondary" onclick="downloadReportPDF()" style="font-size:11px">üìÑ Tonnage Report PDF</button>
<button class="btn btn-secondary" onclick="downloadReportCSV()" style="font-size:11px">üìä CSV Data Export</button>
<button class="btn btn-secondary" onclick="downloadReportExcel()" style="font-size:11px">üìó Excel Workbook</button>
<button class="btn btn-secondary" onclick="downloadBoxTrackerExcel()" style="font-size:11px">üìó Box Tracker Excel</button>
<button class="btn btn-secondary" onclick="exportAllProjects()" style="font-size:11px">üíæ Full JSON Backup</button>
</div>

<!-- Full Package -->
<button class="btn btn-primary" onclick="generateAuditPackage()" style="width:100%;margin-bottom:8px">üì¶ Download All (Full Audit Package)</button>
<div id="auditPackageStatus" style="font-size:11px;color:var(--slate-400)"></div>
</div>
</div>

<!-- Project Comparison -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px;cursor:pointer" onclick="toggleSection('projectComparison')">
üìà Project Comparison <span id="projectComparisonArrow">‚ñº</span>
</div>
<div id="projectComparisonContent" class="hidden">
<p style="font-size:12px;color:var(--slate-400);margin-bottom:12px">
Compare diversion rates across all your projects
</p>
<div id="projectComparisonChart" style="min-height:200px;background:var(--slate-700);border-radius:8px;padding:12px">
<canvas id="comparisonChart"></canvas>
</div>
<button class="btn btn-secondary" onclick="loadProjectComparison()" style="margin-top:12px;width:100%">üîÑ Load Comparison</button>
</div>
</div>

<!-- LEED News Feed -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px;cursor:pointer" onclick="toggleSection('newsFeed')">
üì∞ LEED MRc5 Industry News <span id="newsFeedArrow">‚ñº</span>
</div>
<div id="newsFeedContent" class="hidden">
<div id="leedNewsList" style="font-size:12px">
<div style="padding:12px 0;border-bottom:1px solid var(--slate-700)">
<div style="color:var(--emerald-400);font-weight:600">Loading news...</div>
</div>
</div>
<button class="btn btn-secondary" onclick="refreshLeedNews()" style="margin-top:12px;width:100%">üîÑ Refresh News</button>
</div>
</div>

<div id="reportOutput" class="hidden" style="margin-top:20px">

<!-- Project Header -->
<div class="card" id="reportHeader">
<div style="text-align:center;margin-bottom:16px">
<div style="font-size:20px;font-weight:700">Construction & Demolition Waste Management Report</div>
<div style="font-size:12px;color:var(--slate-400)">LEED v4.1 MRc5 Documentation</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px">
<div>
<div style="color:var(--slate-400);font-size:11px">PROJECT NAME</div>
<div style="font-weight:600" id="reportProjectName">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">REPORT DATE</div>
<div style="font-weight:600" id="reportDate">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">PROJECT ADDRESS</div>
<div id="reportProjectAddress">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">GENERAL CONTRACTOR</div>
<div id="reportProjectGC">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">WASTE HAULER</div>
<div id="reportProjectHauler">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">REPORTING PERIOD</div>
<div id="reportPeriod">-</div>
</div>
</div>
</div>

<!-- Diversion Summary -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:16px">üìà Diversion Summary</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700;color:var(--emerald-400)" id="reportDiversionRate">0%</div>
<div style="font-size:11px;color:var(--slate-400)">DIVERSION RATE</div>
</div>
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700" id="reportTotalTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">TOTAL TONS</div>
</div>
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700;color:var(--emerald-400)" id="reportDivertedTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">DIVERTED TONS</div>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;margin-top:12px">
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600;color:var(--red-500)" id="reportLandfillTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">LANDFILL TONS</div>
</div>
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600" id="reportTicketCount">0</div>
<div style="font-size:11px;color:var(--slate-400)">TOTAL LOADS</div>
</div>
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600" id="reportLeedStatus">-</div>
<div style="font-size:11px;color:var(--slate-400)">LEED STATUS</div>
</div>
</div>
</div>

<!-- Material Breakdown -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:16px">‚ôªÔ∏è Material Breakdown by Weight</div>
<div id="reportMaterialBreakdown"></div>
<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--slate-700)">
<div style="display:flex;justify-content:space-between;font-weight:600">
<span>TOTAL DIVERTED</span>
<span style="color:var(--emerald-400)" id="reportTotalDiverted">0.00 T</span>
</div>
<div style="display:flex;justify-content:space-between;font-weight:600;margin-top:8px">
<span>TOTAL LANDFILL</span>
<span style="color:var(--red-500)" id="reportTotalLandfill">0.00 T</span>
</div>
</div>
</div>

<!-- Load Details -->
<div class="card" style="margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<div style="font-size:14px;font-weight:600">üöõ Load Details</div>
<span style="font-size:11px;color:var(--slate-400)" id="reportLoadCount">0 loads</span>
</div>
<div id="reportContent" style="overflow-x:auto"></div>
</div>

<!-- Certification -->
<div class="card" style="margin-top:16px;border:2px solid var(--emerald-500)">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">‚úÖ Certification Statement</div>
<p style="font-size:12px;color:var(--slate-300);line-height:1.6">
I certify that this information is a true representation of materials processed by Dalmex Recycling LLC. 
All waste materials have been tracked from point of generation through processing and final disposition. 
Material composition percentages are based on AI-assisted visual analysis with human verification for each load.
Photographic documentation, GPS coordinates, and SHA-256 verification hashes are stored for GBCI audit purposes.
</p>
<div class="report-sig-pad-wrap">
<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Authorized Signature (optional)</div>
<canvas id="reportSignatureCanvas" width="600" height="100"></canvas>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn btn-secondary" onclick="clearReportSignature()" style="flex:1;padding:6px;font-size:11px">üóëÔ∏è Clear</button>
<button class="btn btn-primary" onclick="saveReportSignature()" style="flex:1;padding:6px;font-size:11px">üíæ Save Signature</button>
<button class="btn btn-secondary" onclick="printSignedReport()" style="flex:1;padding:6px;font-size:11px">üñ®Ô∏è Print Report</button>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;font-size:12px">
<div>
<div style="color:var(--slate-400)">Prepared By</div>
<div style="font-weight:600">Dalmex Recycling LLC</div>
<div style="font-size:10px;color:var(--slate-400)">2828 Nagle St., Dallas, TX 75220</div>
</div>
<div>
<div style="color:var(--slate-400)">Report Generated</div>
<div style="font-weight:600" id="reportGeneratedDate">-</div>
</div>
</div>
</div>

</div>
</div>

<div id="settingsTab" class="hidden">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:14px;font-weight:600">üîë Anthropic API Key</div>
    <div id="apiKeyStatus" style="font-size:11px">--</div>
</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Required for scale ticket OCR and debris photo analysis. Get your key from console.anthropic.com</p>
<div style="display:flex;gap:8px;align-items:center">
    <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-ant-..." style="margin-bottom:0;flex:1">
    <button class="btn btn-secondary" onclick="toggleKeyVisibility('apiKeyInput')" style="padding:8px 12px;white-space:nowrap;font-size:11px">üëÅÔ∏è</button>
</div>
<button class="btn btn-primary" onclick="saveApiKey()" style="margin-top:12px;width:100%">Save Key</button>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:14px;font-weight:600">üóÑÔ∏è Supabase Connection</div>
    <div id="supabaseStatus" style="font-size:11px">--</div>
</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Required for cloud sync. App works offline without this.</p>
<div class="form-group">
<label class="form-label">Project URL</label>
<input type="text" id="supabaseUrl" class="form-input" placeholder="https://xxxxx.supabase.co">
</div>
<div class="form-group">
<label class="form-label">Anon Key</label>
<div style="display:flex;gap:8px;align-items:center">
    <input type="password" id="supabaseKey" class="form-input" placeholder="eyJ..." style="margin-bottom:0;flex:1">
    <button class="btn btn-secondary" onclick="toggleKeyVisibility('supabaseKey')" style="padding:8px 12px;white-space:nowrap;font-size:11px">üëÅÔ∏è</button>
</div>
</div>
<button class="btn btn-primary" onclick="saveSupabaseConfig()" style="width:100%">Save & Connect</button>
</div>

<!-- LEED Rules Configuration -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üìã LEED Rules Engine</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Configure LEED MRc5 compliance validation</p>
<div class="form-group">
<label class="form-label">LEED Version</label>
<select id="leedVersion" class="form-input" onchange="updateLeedRules()">
<option value="v4.1">LEED v4.1 (Current)</option>
<option value="v5">LEED v5 (2024+)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Default Diversion Target</label>
<select id="defaultDiversionTarget" class="form-input">
<option value="50">50% (1 point)</option>
<option value="75" selected>75% (2 points - Recommended)</option>
</select>
</div>
<div style="background:var(--slate-700);border-radius:8px;padding:12px;font-size:11px">
<div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">Current LEED Rules:</div>
<div id="leedRulesDisplay">
‚Ä¢ MRc5: C&D Waste Management<br>
‚Ä¢ Option 1: Diversion (50% = 1pt, 75% = 2pts)<br>
‚Ä¢ Requires: Tracking by material stream<br>
‚Ä¢ Requires: Facility documentation<br>
‚Ä¢ Photo verification recommended
</div>
</div>
<button class="btn btn-secondary" onclick="saveLeedSettings()" style="margin-top:12px;width:100%">üíæ Save LEED Settings</button>
</div>

<!-- Backup & Restore -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üíæ Backup & Restore</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Export all data or restore from backup</p>

<div class="backup-panel">
<div class="backup-stats">
<div class="backup-stat">
<div class="backup-stat-value" id="backupProjectCount">0</div>
<div class="backup-stat-label">Projects</div>
</div>
<div class="backup-stat">
<div class="backup-stat-value" id="backupTicketCount">0</div>
<div class="backup-stat-label">Tickets</div>
</div>
<div class="backup-stat">
<div class="backup-stat-value" id="backupLastDate">Never</div>
<div class="backup-stat-label">Last Backup</div>
</div>
</div>

<div class="btn-row" style="margin-bottom:12px">
<button class="btn btn-primary" onclick="createFullBackup()" style="flex:1">üì§ Export Backup</button>
<button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()" style="flex:1">üì• Restore</button>
<input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreFromBackup(event)">
</div>

<div class="btn-row">
<button class="btn btn-secondary" onclick="exportToCloud()" style="flex:1">‚òÅÔ∏è Cloud Backup</button>
<button class="btn btn-secondary" onclick="clearLocalData()" style="flex:1;color:var(--red-500)">üóëÔ∏è Clear Local</button>
</div>
</div>
</div>

<!-- Offline Mode Settings -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üì¥ Offline Mode</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Data saved locally when offline, syncs when back online</p>

<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="enableOfflineMode" checked onchange="toggleOfflineMode()">
Enable offline data storage
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="autoSync" checked>
Auto-sync when online
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="autosaveDrafts" checked>
Auto-save ticket drafts
</label>
</div>

<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-top:12px">
<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
<span>Local Storage Used:</span>
<span id="localStorageUsed">0 KB</span>
</div>
<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
<span>Pending Sync Items:</span>
<span id="pendingSyncCount">0</span>
</div>
<div style="display:flex;justify-content:space-between;font-size:11px">
<span>Last Sync:</span>
<span id="lastSyncTime">Never</span>
</div>
</div>

<button class="btn btn-secondary" onclick="forceSyncNow()" style="margin-top:12px;width:100%">üîÑ Force Sync Now</button>
</div>

<!-- Data Validation Settings -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">‚úÖ Data Validation</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Prevent invalid data from being saved</p>

<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="validateWeights" checked>
Validate weight entries (gross > tare)
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="validatePercentages" checked>
Validate percentages total 100%
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="requirePhotos" checked>
Require at least 1 debris photo
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="requireVerification" checked>
Require human verification checkbox
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="flagAnomalies" checked>
Flag anomalies (>90% or <30% diversion)
</label>
</div>
</div>

<!-- Color Theme Selector -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üé® Color Theme</div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Choose your preferred color scheme</p>

<div class="theme-selector">
<div class="theme-option theme-dark active" data-theme="default" data-name="Dark" onclick="setTheme('default')"></div>
<div class="theme-option theme-dalmex" data-theme="dalmex" data-name="DalMex" onclick="setTheme('dalmex')"></div>
<div class="theme-option theme-ocean" data-theme="ocean" data-name="Ocean" onclick="setTheme('ocean')"></div>
<div class="theme-option theme-sunset" data-theme="sunset" data-name="Sunset" onclick="setTheme('sunset')"></div>
<div class="theme-option theme-light" data-theme="light" data-name="Light" onclick="setTheme('light')"></div>
<div class="theme-option theme-contrast" data-theme="contrast" data-name="Hi-Con" onclick="setTheme('contrast')"></div>
<div class="theme-option theme-purple" data-theme="purple" data-name="Purple" onclick="setTheme('purple')"></div>
</div>

<div style="margin-top:16px">
<div style="font-size:12px;font-weight:500;margin-bottom:8px">Quick Adjustments</div>
<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="reducedMotion" onchange="toggleReducedMotion()">
Reduce animations
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="largerText" onchange="toggleLargerText()">
Larger text (accessibility)
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
Compact mode (more content)
</label>
</div>
</div>
</div>

<!-- Company Branding -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üè¢ Company Branding</div>
<div class="form-group">
<label class="form-label">Company Name</label>
<input type="text" id="companyNameInput" class="form-input" value="DalMex Recycling LLC">
</div>
<div class="form-group">
<label class="form-label">Address</label>
<input type="text" id="companyAddressInput" class="form-input" value="2828 Nagel St., Dallas, TX 75220">
</div>
<div class="form-group">
<label class="form-label">Phone</label>
<input type="text" id="companyPhoneInput" class="form-input" value="(214) 352-2000">
</div>
<button class="btn btn-primary" onclick="saveCompanyBranding()">Save Branding</button>
</div>

<!-- Verified Facility Network -->
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üè≠ Verified Facility Network</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Your recycling partners - materials auto-route to these facilities</p>

<div id="facilityNetworkList" style="display:flex;flex-direction:column;gap:8px">
<!-- Metal -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">üî© Metal / Scrap</div>
<div style="font-size:11px;color:var(--emerald-400)">Cyclone Metal Recycling</div>
</div>
<span class="leed-badge compliant" style="font-size:9px">‚úì VERIFIED</span>
</div>
</div>

<!-- Cardboard -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">üì¶ Cardboard / OCC</div>
<div style="font-size:11px;color:var(--emerald-400)">Georgia Pacific, WestRock, GreenSide</div>
</div>
<span class="leed-badge compliant" style="font-size:9px">‚úì VERIFIED</span>
</div>
</div>

<!-- Plastic -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">‚ôªÔ∏è Plastic</div>
<div style="font-size:11px;color:var(--emerald-400)">Recycle USA</div>
</div>
<span class="leed-badge compliant" style="font-size:9px">‚úì VERIFIED</span>
</div>
</div>

<!-- Wood -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">ü™µ Wood / Pallets</div>
<div style="font-size:11px;color:var(--emerald-400)">DalMex Recycling - Pallet Division</div>
</div>
<span class="leed-badge compliant" style="font-size:9px">‚úì OWNED</span>
</div>
</div>

<!-- Concrete -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">üß± Concrete / Masonry</div>
<div style="font-size:11px;color:var(--amber-400)">Specify on ticket</div>
</div>
<span class="leed-badge warning" style="font-size:9px">‚ö† SPECIFY</span>
</div>
</div>

<!-- Drywall -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:12px;font-weight:600">üèóÔ∏è Drywall / Gypsum</div>
<div style="font-size:11px;color:var(--amber-400)">Specify on ticket</div>
</div>
<span class="leed-badge warning" style="font-size:9px">‚ö† SPECIFY</span>
</div>
</div>
</div>

<button class="btn btn-secondary" onclick="showAddFacilityModal()" style="margin-top:12px;width:100%">‚ûï Add New Facility</button>
</div>

</div>
</main>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
<div class="spinner"></div>
<p id="loadingText" style="color:white">Processing...</p>
</div>

<!-- New Ticket Modal -->
<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">New Ticket</div>
<button class="modal-close" onclick="closeTicketModal()">√ó</button>
</div>
<div class="modal-body">

<!-- Step Indicators -->
<div class="steps">
<div class="step active" id="stepIndicator1">1</div>
<div class="step-line" id="stepLine1"></div>
<div class="step" id="stepIndicator2">2</div>
<div class="step-line" id="stepLine2"></div>
<div class="step" id="stepIndicator3">3</div>
<div class="step-line" id="stepLine3"></div>
<div class="step" id="stepIndicator4">4</div>
</div>

<!-- STEP 1: Scale Ticket -->
<div id="ticketStep1">
<h3 style="text-align:center;margin-bottom:16px">üìÑ Step 1: Scale Ticket</h3>

<!-- Voice Input Section -->
<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-bottom:16px;text-align:center">
<div style="display:flex;align-items:center;justify-content:center;gap:12px">
<button class="voice-btn" id="voiceInputBtn" onclick="toggleVoiceInput()">üé§</button>
<div>
<div style="font-size:12px;font-weight:600">Voice Input</div>
<div class="voice-status" id="voiceStatus">Tap to speak ticket info</div>
</div>
</div>
<div id="voiceTranscript" class="hidden" style="margin-top:8px;padding:8px;background:var(--slate-800);border-radius:6px;font-size:12px;color:var(--slate-300)"></div>
</div>

<div class="form-group">
<label class="form-label">Project</label>
<select id="ticketProject" class="form-input">
<option value="">Select Project...</option>
<option value="demo">Demo Project</option>
</select>
</div>

<div class="image-preview" id="ticketImagePreview">
<span>Upload scale ticket photo</span>
</div>

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('ticketCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('ticketFileInput').click()">üìÅ Upload</button>
</div>
<input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleTicketPhoto(event)">
<input type="file" id="ticketFileInput" accept="image/*" style="display:none" onchange="handleTicketPhoto(event)">

<div class="form-group">
<label class="form-label">Service Date</label>
<input type="date" id="serviceDate" class="form-input">
</div>

<div class="form-group">
<label class="form-label">Ticket #</label>
<input type="text" id="ticketNumber" class="form-input" placeholder="84600">
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Gross (lbs)</label>
<input type="number" id="grossLbs" class="form-input" placeholder="40000" oninput="updateNetWeight()">
</div>
<div class="form-group">
<label class="form-label">Tare (lbs)</label>
<input type="number" id="tareLbs" class="form-input" placeholder="15000" oninput="updateNetWeight()">
</div>
</div>

<div class="form-group">
<label class="form-label">Net Weight</label>
<div id="netWeightDisplay" style="font-size:28px;font-weight:700;color:var(--emerald-400)">0.00 tons</div>
</div>

<div class="form-group">
<label class="form-label">Hauler</label>
<input type="text" id="haulerName" class="form-input" placeholder="Hauler name">
</div>
</div>

<!-- STEP 2: Debris Photos -->
<div id="ticketStep2" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">üì∏ Step 2: Debris Photos</h3>

<div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between">
<span>Ticket: <strong id="step2TicketNum">--</strong></span>
<span>Net: <strong id="step2NetWeight" style="color:var(--emerald-400)">-- T</strong></span>
</div>

<p style="color:var(--amber-400);text-align:center;margin-bottom:16px;font-size:13px">‚ö†Ô∏è Upload at least 1 photo of debris</p>

<div class="form-group">
<label class="form-label">Container Size</label>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yd</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(0)"><span>?</span><small>other</small></div>
</div>
</div>

<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" id="photoSlot0" onclick="triggerPhotoUpload(0)">‚ûï</div>
<div class="photo-slot" id="photoSlot1" onclick="triggerPhotoUpload(1)">‚ûï</div>
<div class="photo-slot" id="photoSlot2" onclick="triggerPhotoUpload(2)">‚ûï</div>
</div>

<input type="file" id="debrisPhotoInput" accept="image/*" style="display:none" onchange="handleDebrisPhoto(event)">
<input type="file" id="debrisMultiInput" accept="image/*" multiple style="display:none" onchange="handleMultiplePhotos(event)">
<input type="file" id="debrisCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleDebrisPhoto(event)">

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('debrisCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('debrisMultiInput').click()">üìÅ Upload Multiple</button>
</div>

<p style="text-align:center;color:var(--slate-400);margin-bottom:16px">Photos: <span id="photoCount">0</span>/3</p>

<button class="btn btn-primary btn-lg" id="analyzeBtn" onclick="analyzeDebris()">ü§ñ Analyze Materials</button>

<div id="analysisResult" class="hidden" style="margin-top:16px;padding:16px;background:var(--slate-700);border-radius:8px">
<div style="text-align:center">
<div style="font-size:14px;color:var(--slate-400)">Diversion Rate</div>
<div id="analysisRate" style="font-size:36px;font-weight:700;color:var(--emerald-400)">0%</div>
</div>
</div>
</div>

<!-- STEP 3: Review & Verify - WITH CHECKBOX -->
<div id="ticketStep3" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úÖ Step 3: Review & Verify</h3>

<!-- AI Reasoning Section -->
<div id="aiReasoningSection" class="hidden"></div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400)">Diversion Rate</div>
<div class="diversion-badge" id="reviewDiversionRate">0%</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--slate-400)">LEED Target</div>
<div style="font-size:20px;font-weight:600">75%</div>
</div>
</div>
<div class="progress-bar" style="margin-top:12px">
<div class="progress-fill" id="reviewProgressBar" style="width:0%"></div>
</div>
</div>

<!-- ‚≠ê HUMAN VERIFICATION CHECKBOX ‚≠ê -->
<div class="verification-box" id="verificationBox">
<label>
<input type="checkbox" id="humanVerifyCheckbox" onchange="onVerificationChange()">
<div>
<div class="verify-text">‚ö†Ô∏è REQUIRED: Human Verification</div>
<div class="verify-desc">I have reviewed the photos and confirm the material percentages are accurate or have been corrected.</div>
</div>
</label>
</div>

<div style="font-size:12px;color:var(--slate-400);margin-bottom:8px">MATERIALS (adjust if needed)</div>
<div id="materialsList"></div>

<div style="margin-top:12px;font-size:14px">
Total: <span id="materialsTotal" style="color:var(--emerald-400);font-weight:700">100%</span>
</div>
</div>

<!-- STEP 4: Submit (signature optional) -->
<div id="ticketStep4" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úÖ Step 4: Review & Submit</h3>

<div class="card" style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Ticket</span>
    <span style="font-weight:600" id="step4TicketNum">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Date</span>
    <span style="font-weight:600" id="step4Date">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Net Weight</span>
    <span style="font-weight:600" id="step4Weight">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
    <span style="font-size:12px;color:var(--slate-400)">Diversion Rate</span>
    <span style="font-weight:600;color:var(--emerald-400)" id="step4Diversion">--</span>
</div>
</div>

<details style="margin-bottom:12px">
<summary style="font-size:12px;color:var(--slate-400);cursor:pointer;padding:8px 0">‚úçÔ∏è Optional: Add Signature</summary>
<div class="card" style="margin-top:8px">
<canvas id="signaturePad" class="signature-pad"></canvas>
<button class="btn btn-secondary" style="margin-top:8px;font-size:11px" onclick="clearSignature()">Clear Signature</button>
</div>
</details>

<p style="font-size:11px;color:var(--slate-400);line-height:1.6;text-align:center">
Ticket will be saved with today's date and current material percentages.
</p>
</div>

</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="backBtn" onclick="goBack()" style="flex:1">Back</button>
<button class="btn btn-primary" id="nextBtn" onclick="goNext()" style="flex:1">Next</button>
</div>
</div>
</div>

<!-- New Project Modal -->
<div id="projectModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">New Project</div>
<button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">Project Name *</label>
<input type="text" id="projectName" class="form-input" placeholder="e.g., Children's Hospital Phase 2">
</div>
<div class="form-group">
<label class="form-label">Project Address</label>
<input type="text" id="projectAddress" class="form-input" placeholder="123 Main St, Dallas, TX">
</div>
<div class="form-group">
<label class="form-label">Waste Hauler</label>
<input type="text" id="projectHauler" class="form-input" placeholder="e.g., B&B Waste Management">
</div>
<div class="form-group">
<label class="form-label">LEED Target (%)</label>
<input type="number" id="projectLeedTarget" class="form-input" value="75" min="50" max="100">
</div>
<div class="form-group">
<label class="form-label">General Contractor</label>
<input type="text" id="projectGC" class="form-input" placeholder="e.g., JE Dunn Construction">
</div>
<div class="form-group">
<label class="form-label">Customer Access Code</label>
<input type="text" id="projectAccessCode" class="form-input" placeholder="Auto-generated" style="text-transform:uppercase">
<p style="font-size:10px;color:var(--slate-400);margin-top:4px">Share this code with your customer for portal access</p>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex:1">Cancel</button>
<button class="btn btn-primary" onclick="saveProject()" style="flex:1">Save Project</button>
</div>
</div>
</div>

<!-- Project Picker Modal -->
<div id="projectPickerModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">Select Project</div>
<button class="modal-close" onclick="closeModal('projectPickerModal')">√ó</button>
</div>
<div class="modal-body">
<div id="projectPickerList">Loading...</div>
<button class="btn btn-secondary btn-lg" onclick="closeModal('projectPickerModal');showNewProjectModal()" style="margin-top:16px">‚ûï Create New Project</button>
</div>
</div>
</div>

<script>
// ========== SUPABASE CONFIG ==========
const SUPABASE_URL = localStorage.getItem('divertscan_sb_url') || '';
const SUPABASE_KEY = localStorage.getItem('divertscan_sb_key') || '';
let sb = null;

// Initialize Supabase if configured
if (SUPABASE_URL && SUPABASE_KEY && typeof supabase !== 'undefined') {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// ========== GLOBAL STATE ==========
let currentStep = 1;
let projects = [];
let currentProject = null;
let tickets = [];
let ticketData = {
    projectId: '',
    ticketNumber: '',
    serviceDate: '',
    grossLbs: 0,
    tareLbs: 0,
    netTons: 0,
    hauler: '',
    containerSize: 30,
    photos: [],
    materials: {},
    diversionRate: 0,
    humanVerified: false,
    signature: null
};
let debrisPhotos = [null, null, null];
let currentPhotoSlot = 0;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DivertScan v7.6 initialized');
    
    // Set today's date
    const dateInput = document.getElementById('serviceDate');
    if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
    
    // Restore keys from IndexedDB backup if localStorage was cleared
    // Do NOT call initializeApp() here ‚Äî window.onload handles login flow
    restoreAllKeys().then(() => {
        console.log('Keys restored, waiting for login check...');
    });
});

async function restoreAllKeys() {
    // 1. Load from localStorage
    let apiKey = localStorage.getItem('divertscan_openai');
    let sbUrl = localStorage.getItem('divertscan_sb_url');
    let sbKey = localStorage.getItem('divertscan_sb_key');
    
    // 2. If localStorage is empty, try IndexedDB backup
    if (!apiKey || !sbUrl || !sbKey) {
        try {
            await initIndexedDB();
            if (!apiKey) {
                const saved = await getFromLocal('settings', 'anthropic_key');
                if (saved?.value) {
                    apiKey = saved.value;
                    localStorage.setItem('divertscan_openai', apiKey);
                    console.log('Restored Anthropic key from IndexedDB backup');
                }
            }
            if (!sbUrl) {
                const saved = await getFromLocal('settings', 'supabase_url');
                if (saved?.value) {
                    sbUrl = saved.value;
                    localStorage.setItem('divertscan_sb_url', sbUrl);
                    console.log('Restored Supabase URL from IndexedDB backup');
                }
            }
            if (!sbKey) {
                const saved = await getFromLocal('settings', 'supabase_key');
                if (saved?.value) {
                    sbKey = saved.value;
                    localStorage.setItem('divertscan_sb_key', sbKey);
                    console.log('Restored Supabase key from IndexedDB backup');
                }
            }
        } catch (e) {
            console.log('IndexedDB key restore skipped:', e.message);
        }
    }
    
    // 3. Populate input fields
    if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
    if (sbUrl) document.getElementById('supabaseUrl').value = sbUrl;
    if (sbKey) document.getElementById('supabaseKey').value = sbKey;
    
    // 4. Reinitialize Supabase if keys restored
    if (sbUrl && sbKey && !sb && typeof supabase !== 'undefined') {
        try {
            sb = supabase.createClient(sbUrl, sbKey);
        } catch (e) {
            console.log('Supabase init failed:', e.message);
        }
    }
    
    // 5. Update status indicators
    updateKeyStatusIndicators();
}

function updateKeyStatusIndicators() {
    const apiKey = localStorage.getItem('divertscan_openai');
    const sbUrl = localStorage.getItem('divertscan_sb_url');
    const sbKey = localStorage.getItem('divertscan_sb_key');
    
    // API Key status
    const apiStatus = document.getElementById('apiKeyStatus');
    if (apiStatus) {
        if (apiKey) {
            const masked = apiKey.substring(0, 10) + '...' + apiKey.slice(-4);
            apiStatus.innerHTML = `<span style="color:var(--emerald-400)">‚úÖ ${masked}</span>`;
        } else {
            apiStatus.innerHTML = `<span style="color:var(--red-500)">‚ùå Not set</span>`;
        }
    }
    
    // Supabase status
    const sbStatus = document.getElementById('supabaseStatus');
    if (sbStatus) {
        if (sb && sbUrl && sbKey) {
            sbStatus.innerHTML = `<span style="color:var(--emerald-400)">‚úÖ Connected</span>`;
        } else if (sbUrl || sbKey) {
            sbStatus.innerHTML = `<span style="color:var(--amber-400)">‚ö†Ô∏è Incomplete</span>`;
        } else {
            sbStatus.innerHTML = `<span style="color:var(--slate-400)">Not configured (offline mode)</span>`;
        }
    }
    
    // Dashboard warning banner
    updateDashboardKeyWarning(apiKey, sbUrl, sbKey);
}

function updateDashboardKeyWarning(apiKey, sbUrl, sbKey) {
    let banner = document.getElementById('keyWarningBanner');
    const missing = [];
    if (!apiKey) missing.push('Anthropic API Key');
    if (!sbUrl || !sbKey) missing.push('Supabase');
    
    if (missing.length === 0) {
        if (banner) banner.remove();
        return;
    }
    
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'keyWarningBanner';
        banner.style.cssText = 'background:linear-gradient(135deg,#92400e,#78350f);border:1px solid #b45309;border-radius:8px;padding:12px 16px;margin-bottom:12px;font-size:12px;color:#fef3c7;cursor:pointer;';
        banner.onclick = () => showTab('settings');
        
        const dashTab = document.getElementById('dashboardTab');
        if (dashTab) dashTab.prepend(banner);
    }
    
    banner.innerHTML = `<strong>‚ö†Ô∏è Missing: ${missing.join(' & ')}</strong><br><span style="font-size:11px;opacity:0.8">Tap here to go to Settings and configure</span>`;
}

function toggleKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
    }
}

// Helper to read a single record from IndexedDB
async function getFromLocal(storeName, key) {
    if (!db) await initIndexedDB();
    return new Promise((resolve, reject) => {
        try {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result || null);
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}

async function initializeApp() {
    updateKeyStatusIndicators();
    
    if (sb) {
        await loadProjects();
        await loadRecentTickets();
        updateStats();
    } else {
        // Still functional in offline mode - load from IndexedDB
        try {
            await initIndexedDB();
            const localTickets = await getAllFromLocal('tickets');
            if (localTickets && localTickets.length > 0) {
                document.getElementById('recentTickets').innerHTML = `<p style="color:var(--slate-400)">üì± Offline mode - ${localTickets.length} tickets stored locally</p>`;
            } else {
                document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">No tickets yet. Scan a scale ticket to get started.</p>';
            }
        } catch (e) {
            document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">Ready to scan tickets.</p>';
        }
    }
}

// ========== TABS ==========
function showTab(tab) {
    document.getElementById('dashboardTab').classList.add('hidden');
    document.getElementById('projectsTab').classList.add('hidden');
    document.getElementById('reportsTab').classList.add('hidden');
    document.getElementById('settingsTab').classList.add('hidden');
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardTab').classList.remove('hidden');
        loadRecentTickets();
        updateStats();
    } else if (tab === 'projects') {
        document.getElementById('projectsTab').classList.remove('hidden');
        renderProjectsList();
    } else if (tab === 'reports') {
        document.getElementById('reportsTab').classList.remove('hidden');
        populateReportProjectDropdown();
        setTimeout(initReportSignaturePad, 100);
        // Auto-generate if a project is already selected
        if (currentProject) {
            const sel = document.getElementById('reportProjectSelect');
            if (sel && !sel.value) sel.value = currentProject.id;
            generateReport();
        }
    } else if (tab === 'settings') {
        document.getElementById('settingsTab').classList.remove('hidden');
    }
    
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.remove('active');
        if ((tab === 'dashboard' && i === 0) || (tab === 'projects' && i === 1) || (tab === 'reports' && i === 2) || (tab === 'settings' && i === 3)) {
            item.classList.add('active');
        }
    });
}

// ========== API KEY ==========
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) {
        toast('Please enter an API key', 'error');
        return;
    }
    
    // Validate it looks like an Anthropic key
    if (key.startsWith('sk-') && !key.startsWith('sk-ant-')) {
        toast('‚ö†Ô∏è This looks like an OpenAI key. You need an Anthropic key (starts with sk-ant-)', 'error');
        return;
    }
    
    // Save to localStorage (primary)
    localStorage.setItem('divertscan_openai', key);
    
    // Backup to IndexedDB (survives localStorage clears)
    saveToLocal('settings', { key: 'anthropic_key', value: key }).catch(() => {});
    
    updateKeyStatusIndicators();
    toast('‚úÖ Anthropic API key saved!', 'success');
    
    // Quick validation test
    testApiKey(key);
}

async function testApiKey(key) {
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': key,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 10,
                messages: [{ role: 'user', content: 'hi' }]
            })
        });
        
        if (response.ok) {
            toast('‚úÖ API key verified - connection working!', 'success');
        } else {
            const err = await response.json();
            if (err.error?.type === 'authentication_error') {
                toast('‚ùå Invalid API key - check console.anthropic.com', 'error');
                localStorage.removeItem('divertscan_openai');
            } else if (err.error?.type === 'permission_error') {
                toast('‚ùå Key lacks permissions - check API settings', 'error');
            } else {
                toast('‚ö†Ô∏è Key saved but test returned: ' + (err.error?.message || response.status), 'warning');
            }
        }
    } catch (e) {
        toast('‚ö†Ô∏è Key saved but could not verify (network issue)', 'warning');
    }
}

// ========== SUPABASE CONFIG ==========
function saveSupabaseConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    
    if (!url || !key) {
        toast('Please enter both URL and Key', 'error');
        return;
    }
    
    // Save to localStorage (primary)
    localStorage.setItem('divertscan_sb_url', url);
    localStorage.setItem('divertscan_sb_key', key);
    
    // Backup to IndexedDB (survives localStorage clears)
    saveToLocal('settings', { key: 'supabase_url', value: url }).catch(() => {});
    saveToLocal('settings', { key: 'supabase_key', value: key }).catch(() => {});
    
    // Reinitialize Supabase
    if (typeof supabase !== 'undefined') {
        sb = supabase.createClient(url, key);
        toast('Supabase connected!', 'success');
        updateKeyStatusIndicators();
        initializeApp();
    }
}

// ========== PROJECTS ==========
async function loadProjects() {
    try {
        let remoteProjects = [];
        let localProjects = [];
        
        // Try Supabase if configured (with 5s timeout)
        if (sb) {
            try {
                const sbPromise = sb.from('projects').select('*').order('created_at', { ascending: false });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                );
                const result = await Promise.race([sbPromise, timeoutPromise]);
                if (result && !result.error && result.data) remoteProjects = result.data;
            } catch (e) {
                console.log('Supabase projects fetch skipped:', e.message);
            }
        }
        
        // Always get local projects
        try {
            localProjects = await getAllFromLocal('projects') || [];
        } catch (e) {
            console.log('Local projects fetch error:', e.message);
        }
        
        // Merge and dedupe by project name (prefer remote)
        const projectMap = new Map();
        localProjects.forEach(p => projectMap.set(p.id || p.name, p));
        remoteProjects.forEach(p => projectMap.set(p.id || p.name, p));
        
        projects = Array.from(projectMap.values());
        projects.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        
        // Load current project from localStorage
        const savedProject = localStorage.getItem('divertscan_current_project');
        if (savedProject) {
            try {
                const parsed = JSON.parse(savedProject);
                currentProject = projects.find(p => p.id === (parsed.id || parsed));
            } catch (e) {
                currentProject = projects.find(p => p.id === savedProject);
            }
        }
        if (!currentProject && projects.length > 0) {
            currentProject = projects[0];
            localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
        }
        
        updateProjectDisplay();
        populateProjectDropdown();
        
        // Store for report dropdown access
        window._allProjectsList = projects;
        populateReportProjectDropdown();
    } catch (err) {
        console.error('Error loading projects:', err);
    }
}

function updateProjectDisplay() {
    if (currentProject) {
        document.getElementById('currentProjectName').textContent = currentProject.name;
        document.getElementById('currentProjectHauler').textContent = currentProject.waste_hauler || '';
    } else {
        document.getElementById('currentProjectName').textContent = 'No Project Selected';
        document.getElementById('currentProjectHauler').textContent = 'Create a project to get started';
    }
}

function populateProjectDropdown() {
    const select = document.getElementById('ticketProject');
    select.innerHTML = '<option value="">Select Project...</option>';
    
    projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        if (currentProject && p.id === currentProject.id) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function renderProjectsList() {
    const container = document.getElementById('projectsList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet. Create your first project!</p>';
        return;
    }
    
    container.innerHTML = projects.map(p => `
        <div class="card" style="margin-bottom:12px" id="project-card-${p.id}">
            <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleProjectExpand('${p.id}')">
                <div style="flex:1">
                    <div style="font-weight:600;display:flex;align-items:center;gap:8px">
                        <span id="project-arrow-${p.id}">‚ñ∂</span>
                        ${p.name}
                        ${currentProject && currentProject.id === p.id ? '<span style="background:var(--emerald-500);color:white;padding:2px 8px;border-radius:10px;font-size:10px">ACTIVE</span>' : ''}
                    </div>
                    <div style="font-size:12px;color:var(--slate-400);margin-left:20px">${p.address || 'No address'}</div>
                </div>
            </div>
            <div id="project-expand-${p.id}" class="hidden" style="margin-top:16px;padding-top:16px;border-top:1px solid var(--slate-700)">
                <div class="form-group">
                    <label class="form-label">Project Name</label>
                    <input type="text" class="form-input" id="edit-name-${p.id}" value="${p.name || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="edit-address-${p.id}" value="${p.address || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">Waste Hauler</label>
                    <input type="text" class="form-input" id="edit-hauler-${p.id}" value="${p.waste_hauler || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">General Contractor</label>
                    <input type="text" class="form-input" id="edit-gc-${p.id}" value="${p.general_contractor || ''}">
                </div>
                <div class="form-group">
                    <label class="form-label">LEED Target %</label>
                    <input type="number" class="form-input" id="edit-target-${p.id}" value="${p.leed_target || 75}" min="50" max="100">
                </div>
                <div class="btn-row" style="margin-top:16px">
                    <button class="btn btn-primary" onclick="saveProjectEdit('${p.id}')" style="flex:1">üíæ Save</button>
                    <button class="btn btn-secondary" onclick="selectProject('${p.id}')" style="flex:1">‚úì Set Active</button>
                    <button class="btn btn-secondary" onclick="viewProjectTickets('${p.id}')" style="flex:1">üìã Tickets</button>
                    <button class="btn" onclick="confirmDeleteProject('${p.id}')" style="background:var(--red-500);color:white">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleProjectExpand(projectId) {
    const content = document.getElementById('project-expand-' + projectId);
    const arrow = document.getElementById('project-arrow-' + projectId);
    
    if (content.classList.contains('hidden')) {
        // Close all others first
        projects.forEach(p => {
            document.getElementById('project-expand-' + p.id)?.classList.add('hidden');
            const a = document.getElementById('project-arrow-' + p.id);
            if (a) a.textContent = '‚ñ∂';
        });
        content.classList.remove('hidden');
        arrow.textContent = '‚ñº';
    } else {
        content.classList.add('hidden');
        arrow.textContent = '‚ñ∂';
    }
}

async function saveProjectEdit(projectId) {
    const updates = {
        name: document.getElementById('edit-name-' + projectId)?.value || '',
        address: document.getElementById('edit-address-' + projectId)?.value || '',
        waste_hauler: document.getElementById('edit-hauler-' + projectId)?.value || '',
        general_contractor: document.getElementById('edit-gc-' + projectId)?.value || '',
        leed_target: parseInt(document.getElementById('edit-target-' + projectId)?.value) || 75
    };
    
    try {
        showLoading('Saving...');
        
        // Try Supabase if available
        if (sb) {
            try {
                const { error } = await sb.from('projects').update(updates).eq('id', projectId);
                if (error) throw error;
            } catch (e) {
                console.log('Supabase project save skipped:', e.message);
            }
        }
        
        // Always update local
        const idx = projects.findIndex(p => p.id === projectId);
        if (idx >= 0) projects[idx] = { ...projects[idx], ...updates };
        if (currentProject && currentProject.id === projectId) {
            currentProject = { ...currentProject, ...updates };
            localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
        }
        
        // Update IndexedDB
        try {
            const localProject = await getFromLocal('projects', projectId);
            if (localProject) {
                Object.assign(localProject, updates);
                await saveToLocal('projects', localProject);
            }
        } catch (e) {}
        
        hideLoading();
        updateProjectDisplay();
        renderProjectsList();
        window._allProjectsList = projects;
        populateReportProjectDropdown();
        toast('Project updated!', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

function confirmDeleteProject(projectId) {
    const project = projects.find(p => p.id === projectId);
    // Use setTimeout to ensure confirm dialog fires properly on iPad Safari
    setTimeout(() => {
        if (confirm('Delete project "' + (project?.name || '') + '"? This cannot be undone.')) {
            deleteProject(projectId);
        }
    }, 50);
}

async function deleteProject(projectId) {
    try {
        showLoading('Deleting...');
        
        // Try Supabase if available
        if (sb) {
            try {
                await sb.from('projects').delete().eq('id', projectId);
            } catch (e) { console.log('Supabase project delete skipped:', e.message); }
        }
        
        // Delete from IndexedDB
        try {
            await deleteFromLocal('projects', projectId);
        } catch (e) {}
        
        hideLoading();
        
        projects = projects.filter(p => p.id !== projectId);
        if (currentProject && currentProject.id === projectId) {
            currentProject = projects[0] || null;
            if (currentProject) {
                localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
            } else {
                localStorage.removeItem('divertscan_current_project');
            }
        }
        
        window._allProjectsList = projects;
        updateProjectDisplay();
        renderProjectsList();
        populateReportProjectDropdown();
        toast('Project deleted', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

async function viewProjectTickets(projectId) {
    // Switch to this project and go to home to see tickets
    await selectProject(projectId);
    showTab('dashboard');
}

function showProjectPicker() {
    const container = document.getElementById('projectPickerList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet.</p>';
    } else {
        container.innerHTML = projects.map(p => `
            <div class="card" style="cursor:pointer;margin-bottom:8px" onclick="selectProject('${p.id}');closeModal('projectPickerModal')">
                <div style="font-weight:600">${p.name}</div>
                <div style="font-size:12px;color:var(--slate-400)">${p.waste_hauler || ''}</div>
            </div>
        `).join('');
    }
    
    openModal('projectPickerModal');
}

function generateAccessCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function showNewProjectModal() {
    document.getElementById('projectName').value = '';
    document.getElementById('projectAddress').value = '';
    document.getElementById('projectHauler').value = '';
    document.getElementById('projectLeedTarget').value = '75';
    document.getElementById('projectGC').value = '';
    document.getElementById('projectAccessCode').value = generateAccessCode();
    openModal('projectModal');
}

async function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) {
        toast('Project name is required', 'error');
        return;
    }
    
    const projectData = {
        id: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
        name: name,
        address: document.getElementById('projectAddress').value.trim(),
        waste_hauler: document.getElementById('projectHauler').value.trim(),
        leed_target: parseInt(document.getElementById('projectLeedTarget').value) || 75,
        general_contractor: document.getElementById('projectGC').value.trim(),
        access_code: document.getElementById('projectAccessCode').value.trim().toUpperCase(),
        created_at: new Date().toISOString()
    };
    
    // Close modal IMMEDIATELY - no spinner, no waiting
    closeModal('projectModal');
    
    // === LAYER 1: Always save to localStorage (instant, synchronous, never fails) ===
    try {
        let lsProjects = [];
        try { lsProjects = JSON.parse(localStorage.getItem('divertscan_projects_local') || '[]'); } catch(e) {}
        lsProjects.push(projectData);
        localStorage.setItem('divertscan_projects_local', JSON.stringify(lsProjects));
        console.log('Layer 1 OK: Project saved to localStorage:', projectData.id);
    } catch (e) {
        console.error('localStorage save failed:', e);
    }
    
    // === LAYER 2: Try IndexedDB (async, non-blocking) ===
    try {
        if (!db) { try { await initIndexedDB(); } catch(e) { console.log('IndexedDB init failed:', e); } }
        if (db) {
            await saveToLocal('projects', projectData);
            console.log('Layer 2 OK: Project saved to IndexedDB');
        }
    } catch (e) {
        console.log('IndexedDB save failed (localStorage is fine):', e);
    }
    
    // === LAYER 3: Try Supabase with 3s timeout (fire-and-forget) ===
    if (sb) {
        try {
            const sbData = { ...projectData };
            delete sbData.id;
            const result = await Promise.race([
                sb.from('projects').insert([sbData]).select(),
                new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 3000))
            ]);
            if (result && result.data && result.data[0]) {
                console.log('Layer 3 OK: Project also saved to Supabase');
            }
        } catch (e) {
            console.log('Supabase save skipped:', e.message);
        }
    }
    
    // === Update UI immediately - no async calls needed ===
    if (!Array.isArray(projects)) projects = [];
    projects.push(projectData);
    currentProject = projectData;
    localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
    
    try { updateProjectDisplay(); } catch(e) {}
    try { renderProjectsList(); } catch(e) {}
    try { loadRecentTickets(); } catch(e) {}
    try { updateStats(); } catch(e) {}
    
    toast('Project created: ' + projectData.name, 'success');
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ========== TICKETS ==========
async function loadRecentTickets() {
    if (!currentProject) {
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">Select a project to see tickets</p>';
        return;
    }
    
    try {
        let remoteTickets = [];
        let localTickets = [];
        
        // Try Supabase if configured (with 5s timeout)
        if (sb) {
            try {
                const sbPromise = sb
                    .from('tickets')
                    .select('*')
                    .eq('project_id', currentProject.id)
                    .order('created_at', { ascending: false })
                    .limit(20);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                );
                const result = await Promise.race([sbPromise, timeoutPromise]);
                if (result && !result.error && result.data) remoteTickets = result.data;
            } catch (e) {
                console.log('Supabase tickets fetch skipped:', e.message);
            }
        }
        
        // Always get local tickets (Excel imports, manual entries)
        try {
            const allLocal = await getAllFromLocal('tickets') || [];
            localTickets = allLocal.filter(t => t.project_id === currentProject.id);
        } catch (e) {
            console.log('Local tickets fetch error:', e.message);
        }
        
        // Merge and dedupe
        const ticketMap = new Map();
        localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        
        tickets = Array.from(ticketMap.values());
        tickets.sort((a, b) => new Date(b.created_at || b.service_date) - new Date(a.created_at || a.service_date));
        
        renderRecentTickets();
        updateTicketCount();
    } catch (err) {
        console.error('Error loading tickets:', err);
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--red-500)">Error loading tickets</p>';
    }
}

function renderRecentTickets() {
    const container = document.getElementById('recentTickets');
    
    if (tickets.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No tickets yet for this project</p>';
        updateTicketCount();
        return;
    }
    
    updateTicketCount();
    
    container.innerHTML = tickets.map(t => `
        <div class="ticket-card ticket-card-row" style="border-bottom:1px solid var(--slate-700);padding:10px 0" id="ticket-card-${t.id}" data-searchtext="${(t.ticket_number||'').toLowerCase()} ${(t.service_date||'').toLowerCase()} ${(t.hauler||'').toLowerCase()} ${formatDate(t.service_date).toLowerCase()}">
            <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="cb-${t.id}" onclick="toggleTicketSelect('${t.id}', event)" ${selectedTicketIds.has(t.id) ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer;flex-shrink:0">
                <div style="flex:1;display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleTicketExpand('${t.id}')">
                    <div>
                        <div style="font-weight:600;display:flex;align-items:center;gap:8px">
                            <span id="ticket-arrow-${t.id}" style="font-size:10px">‚ñ∂</span>
                            #${t.ticket_number || 'N/A'}
                            ${t.human_verified ? '<span style="color:var(--emerald-400);font-size:10px">‚úì Verified</span>' : ''}
                            ${t.imported ? '<span style="color:var(--blue-400);font-size:9px;background:rgba(59,130,246,0.15);padding:1px 6px;border-radius:4px">Imported</span>' : ''}
                        </div>
                        <div style="font-size:11px;color:var(--slate-400);margin-left:20px">${formatDate(t.service_date)} ‚Ä¢ ${(t.net_tons || 0).toFixed(2)} T ‚Ä¢ ${t.hauler || 'Unknown hauler'}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color:${(t.diversion_pct || 0) >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'};font-weight:600">${t.diversion_pct || 0}%</div>
                        <div style="font-size:10px;color:var(--slate-500)">${(t.gross_lbs||0).toLocaleString()} lbs gross</div>
                    </div>
                </div>
            </div>
            <div id="ticket-expand-${t.id}" class="hidden" style="margin-top:12px;padding:12px;background:var(--slate-800);border-radius:8px;margin-left:24px">
                <!-- Weight Details -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;font-size:11px;margin-bottom:12px">
                    <div><span style="color:var(--slate-400)">Gross:</span> ${(t.gross_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Tare:</span> ${(t.tare_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Net:</span> ${(t.net_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Tons:</span> ${(t.net_tons || 0).toFixed(2)}</div>
                </div>
                
                <!-- Material Breakdown -->
                <div style="font-size:11px;font-weight:600;margin-bottom:6px;color:var(--slate-300)">MATERIALS</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;font-size:11px;margin-bottom:12px">
                    <div>ü™µ Wood ${t.wood_pct || 0}%</div>
                    <div>üß± Concrete ${t.concrete_pct || 0}%</div>
                    <div>üî© Metal ${t.metal_pct || 0}%</div>
                    <div>üì¶ OCC ${t.cardboard_pct || 0}%</div>
                    <div>‚ôªÔ∏è Plastic ${t.plastic_pct || 0}%</div>
                    <div>üèóÔ∏è Gypsum ${t.drywall_pct || 0}%</div>
                    <div>üóëÔ∏è Landfill ${t.landfill_pct || 0}%</div>
                    <div style="color:${(t.diversion_pct||0) >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'}">‚úÖ Diverted ${t.diversion_pct || 0}%</div>
                </div>
                ${t.import_source ? `<div style="font-size:10px;color:var(--slate-500);margin-bottom:8px">üìÅ Imported from: ${t.import_source}</div>` : ''}
                
                <!-- Photos Preview -->
                ${t.photo_count > 0 ? `
                <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--slate-300)">PHOTOS (${t.photo_count})</div>
                <div style="display:flex;gap:8px;margin-bottom:12px">
                    ${t.debris_photo_1 ? `<img src="${t.debris_photo_1}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewTicketPhoto('${t.id}', 1)">` : ''}
                    ${t.debris_photo_2 ? `<img src="${t.debris_photo_2}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewTicketPhoto('${t.id}', 2)">` : ''}
                    ${t.debris_photo_3 ? `<img src="${t.debris_photo_3}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="viewTicketPhoto('${t.id}', 3)">` : ''}
                </div>
                ` : ''}
                
                <!-- GPS Info -->
                ${t.gps_latitude ? `
                <div style="font-size:11px;color:var(--slate-400);margin-bottom:12px">
                    üìç ${t.gps_latitude.toFixed(6)}, ${t.gps_longitude.toFixed(6)}
                </div>
                ` : ''}
                
                <!-- Actions -->
                <div class="btn-row">
                    <button class="btn btn-secondary" onclick="editTicket('${t.id}')" style="flex:1;padding:8px;font-size:11px">‚úèÔ∏è Edit</button>
                    <button class="btn btn-secondary" onclick="viewTicketDetails('${t.id}')" style="flex:1;padding:8px;font-size:11px">üëÅÔ∏è Full View</button>
                    <button class="btn" onclick="confirmDeleteTicket('${t.id}')" style="background:var(--red-500);color:white;padding:8px;font-size:11px">üóëÔ∏è Delete</button>
                </div>
            </div>
        </div>
    `).join('');
}

function toggleTicketExpand(ticketId) {
    const content = document.getElementById('ticket-expand-' + ticketId);
    const arrow = document.getElementById('ticket-arrow-' + ticketId);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.textContent = '‚ñº';
    } else {
        content.classList.add('hidden');
        arrow.textContent = '‚ñ∂';
    }
}

function viewTicketPhoto(ticketId, photoNum) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    const photoKey = 'debris_photo_' + photoNum;
    const photoData = ticket[photoKey];
    
    if (photoData) {
        // Open in new window/modal
        const win = window.open('', '_blank', 'width=800,height=600');
        win.document.write(`
            <html>
            <head><title>Ticket #${ticket.ticket_number} - Photo ${photoNum}</title></head>
            <body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh">
                <img src="${photoData}" style="max-width:100%;max-height:100vh">
            </body>
            </html>
        `);
    }
}

function viewTicketDetails(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) {
        toast('Ticket not found', 'error');
        return;
    }
    
    // Build photo gallery HTML
    let photosHtml = '<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No photos available</div>';
    const hasPhotos = ticket.debris_photo_1 || ticket.debris_photo_2 || ticket.debris_photo_3 || ticket.scale_ticket_photo;
    
    if (hasPhotos) {
        // Store photos in reference map for safe viewer access
        _photoViewerData = {};
        
        photosHtml = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">';
        
        if (ticket.scale_ticket_photo) {
            _photoViewerData['st_' + ticketId] = ticket.scale_ticket_photo;
            photosHtml += `
                <div style="grid-column:span 2">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">üìã Scale Ticket</div>
                    <img src="${ticket.scale_ticket_photo}" style="width:100%;border-radius:8px;cursor:pointer;border:2px solid var(--accent-info)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Scale Ticket', 'st_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_1) {
            _photoViewerData['dp1_' + ticketId] = ticket.debris_photo_1;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">üì∏ Debris Photo 1</div>
                    <img src="${ticket.debris_photo_1}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 1', 'dp1_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_2) {
            _photoViewerData['dp2_' + ticketId] = ticket.debris_photo_2;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">üì∏ Debris Photo 2</div>
                    <img src="${ticket.debris_photo_2}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 2', 'dp2_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_3) {
            _photoViewerData['dp3_' + ticketId] = ticket.debris_photo_3;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">üì∏ Debris Photo 3</div>
                    <img src="${ticket.debris_photo_3}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 3', 'dp3_${ticketId}')">
                </div>
            `;
        }
        
        photosHtml += '</div>';
    }
    
    // Build material breakdown
    const materials = [
        { name: 'Wood', pct: ticket.wood_pct || 0, tons: ticket.wood_tons || 0, color: '#8B4513' },
        { name: 'Metal', pct: ticket.metal_pct || 0, tons: ticket.metal_tons || 0, color: '#708090' },
        { name: 'Cardboard', pct: ticket.cardboard_pct || 0, tons: ticket.cardboard_tons || 0, color: '#DEB887' },
        { name: 'Concrete', pct: ticket.concrete_pct || 0, tons: ticket.concrete_tons || 0, color: '#A9A9A9' },
        { name: 'Plastic', pct: ticket.plastic_pct || 0, tons: ticket.plastic_tons || 0, color: '#4169E1' },
        { name: 'Drywall', pct: ticket.drywall_pct || 0, tons: ticket.drywall_tons || 0, color: '#F5F5DC' },
        { name: 'Landfill', pct: ticket.landfill_pct || 0, tons: ticket.landfill_tons || 0, color: '#2F4F4F' }
    ].filter(m => m.pct > 0);
    
    let materialsHtml = materials.map(m => `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-color)">
            <div style="width:12px;height:12px;border-radius:2px;background:${m.color}"></div>
            <div style="flex:1;font-size:12px">${m.name}</div>
            <div style="font-size:12px;font-weight:600">${m.pct}%</div>
            <div style="font-size:11px;color:var(--text-muted);width:60px;text-align:right">${m.tons.toFixed(2)} tons</div>
        </div>
    `).join('');
    
    // Diversion status
    const diversionPct = ticket.diversion_pct || 0;
    const diversionColor = diversionPct >= 75 ? 'var(--accent-primary)' : diversionPct >= 50 ? 'var(--accent-warning)' : 'var(--accent-danger)';
    const diversionStatus = diversionPct >= 75 ? '‚úÖ LEED Compliant' : diversionPct >= 50 ? '‚ö†Ô∏è Below Target' : '‚ùå Needs Improvement';
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'ticketDetailModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    
    modal.innerHTML = `
        <div style="background:var(--bg-secondary);border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;position:relative">
            <!-- Header -->
            <div style="background:linear-gradient(135deg, var(--accent-primary), var(--accent-info));padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:1">
                <button onclick="document.getElementById('ticketDetailModal').remove()" style="position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">√ó</button>
                <div style="font-size:12px;color:rgba(255,255,255,0.8)">SCALE TICKET</div>
                <div style="font-size:24px;font-weight:700;color:white">#${ticket.ticket_number}</div>
                <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:4px">${new Date(ticket.service_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
            
            <!-- Content -->
            <div style="padding:20px">
                <!-- Quick Stats -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:var(--text-primary)">${(ticket.net_tons || 0).toFixed(2)}</div>
                        <div style="font-size:10px;color:var(--text-muted)">NET TONS</div>
                    </div>
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:${diversionColor}">${diversionPct}%</div>
                        <div style="font-size:10px;color:var(--text-muted)">DIVERTED</div>
                    </div>
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:var(--accent-primary)">${((ticket.diverted_tons || 0)).toFixed(2)}</div>
                        <div style="font-size:10px;color:var(--text-muted)">DIVERTED TONS</div>
                    </div>
                </div>
                
                <!-- Status Banner -->
                <div style="background:${diversionColor}20;border:1px solid ${diversionColor};border-radius:8px;padding:12px;margin-bottom:20px;text-align:center">
                    <span style="font-size:14px;font-weight:600;color:${diversionColor}">${diversionStatus}</span>
                </div>
                
                <!-- Details Grid -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">HAULER</div>
                        <div style="font-size:13px;font-weight:500">${ticket.hauler || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">IMPORT SOURCE</div>
                        <div style="font-size:13px;font-weight:500">${ticket.import_source || 'Manual Entry'}</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">GROSS WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.gross_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">TARE WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.tare_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">NET WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.net_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">VERIFIED</div>
                        <div style="font-size:13px;font-weight:500">${ticket.human_verified ? '‚úÖ Yes' : '‚ùå No'}</div>
                    </div>
                </div>
                
                <!-- GPS if available -->
                ${ticket.gps_latitude && ticket.gps_longitude ? `
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:20px">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">üìç GPS COORDINATES</div>
                        <div style="font-size:12px;font-family:monospace">${ticket.gps_latitude}, ${ticket.gps_longitude}</div>
                        <a href="https://maps.google.com/?q=${ticket.gps_latitude},${ticket.gps_longitude}" target="_blank" style="font-size:11px;color:var(--accent-info)">View on Google Maps ‚Üí</a>
                    </div>
                ` : ''}
                
                <!-- Material Breakdown -->
                <div style="margin-bottom:20px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">MATERIAL BREAKDOWN</div>
                    ${materialsHtml || '<div style="color:var(--text-muted);font-size:12px">No material data available</div>'}
                </div>
                
                <!-- Photos Section -->
                <div>
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">üì∑ DOCUMENTATION</div>
                    ${photosHtml}
                </div>
            </div>
            
            <!-- Footer -->
            <div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">
                <button class="btn btn-secondary" onclick="document.getElementById('ticketDetailModal').remove()" style="flex:1">Close</button>
                <button class="btn btn-secondary" onclick="editTicket('${ticketId}')" style="flex:1">‚úèÔ∏è Edit</button>
                <button class="btn btn-primary" onclick="printTicketDetail('${ticketId}')" style="flex:1">üñ®Ô∏è Print</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Global photo reference for viewer (avoids base64 in onclick attributes)
let _photoViewerData = {};

function openPhotoViewer(ticketNum, photoName, photoKey) {
    const photoData = _photoViewerData[photoKey] || photoKey;
    
    const viewer = document.createElement('div');
    viewer.id = 'photoViewerModal';
    viewer.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10001;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px';
    viewer.onclick = (e) => { if (e.target === viewer) viewer.remove(); };
    
    const title = document.createElement('div');
    title.style.cssText = 'color:white;font-size:14px;margin-bottom:12px';
    title.textContent = `Ticket #${ticketNum} - ${photoName}`;
    
    const img = document.createElement('img');
    img.src = photoData;
    img.style.cssText = 'max-width:90%;max-height:80vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.style.cssText = 'margin-top:16px;background:white;color:black;border:none;padding:10px 24px;border-radius:8px;font-size:14px;cursor:pointer';
    closeBtn.onclick = () => viewer.remove();
    
    viewer.appendChild(title);
    viewer.appendChild(img);
    viewer.appendChild(closeBtn);
    
    document.body.appendChild(viewer);
}

function printTicketDetail(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Ticket #${ticket.ticket_number}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #059669; }
                .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                .label { color: #666; font-size: 12px; }
                .value { font-weight: bold; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background: #f5f5f5; }
            </style>
        </head>
        <body>
            <h1>Scale Ticket #${ticket.ticket_number}</h1>
            <p><strong>Date:</strong> ${ticket.service_date}</p>
            <p><strong>Hauler:</strong> ${ticket.hauler || 'N/A'}</p>
            <p><strong>Net Tons:</strong> ${(ticket.net_tons || 0).toFixed(2)}</p>
            <p><strong>Diversion Rate:</strong> ${ticket.diversion_pct || 0}%</p>
            <p><strong>Human Verified:</strong> ${ticket.human_verified ? 'Yes' : 'No'}</p>
            <hr>
            <p style="font-size:11px;color:#666">Generated by DivertScan‚Ñ¢ - ${new Date().toLocaleString()}</p>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function editTicket(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) {
        toast('Ticket not found', 'error');
        return;
    }
    
    // Close detail modal if open
    const detailModal = document.getElementById('ticketDetailModal');
    if (detailModal) detailModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'editTicketModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    
    modal.innerHTML = `
        <div style="background:var(--bg-secondary);border-radius:16px;max-width:550px;width:100%;max-height:90vh;overflow-y:auto">
            <div style="background:linear-gradient(135deg, var(--accent-warning), #b45309);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-size:11px;color:rgba(255,255,255,0.7)">EDIT TICKET</div>
                    <div style="font-size:20px;font-weight:700;color:white">#${ticket.ticket_number}</div>
                </div>
                <button onclick="document.getElementById('editTicketModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">√ó</button>
            </div>
            
            <div style="padding:20px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Ticket #</label>
                        <input type="text" id="editTicketNum" class="form-input" value="${ticket.ticket_number || ''}">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Service Date</label>
                        <input type="date" id="editServiceDate" class="form-input" value="${ticket.service_date || ''}">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Hauler</label>
                        <input type="text" id="editHauler" class="form-input" value="${ticket.hauler || ''}">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Container Size</label>
                        <select id="editContainerSize" class="form-input">
                            <option value="20" ${ticket.container_size == 20 ? 'selected' : ''}>20 yd</option>
                            <option value="30" ${ticket.container_size == 30 ? 'selected' : ''}>30 yd</option>
                            <option value="40" ${ticket.container_size == 40 ? 'selected' : ''}>40 yd</option>
                        </select>
                    </div>
                </div>
                
                <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">WEIGHTS (lbs)</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Gross</label>
                        <input type="number" id="editGrossLbs" class="form-input" value="${ticket.gross_lbs || 0}">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label">Tare</label>
                        <input type="number" id="editTareLbs" class="form-input" value="${ticket.tare_lbs || 0}">
                    </div>
                </div>
                
                <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">MATERIAL PERCENTAGES (must total 100%)</div>
                <div id="editMaterialsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">ü™µ Wood %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="wood" value="${ticket.wood_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">ü™® Concrete %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="concrete" value="${ticket.concrete_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">üî© Metal %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="metal" value="${ticket.metal_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">üì¶ Cardboard %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="cardboard" value="${ticket.cardboard_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">‚ôªÔ∏è Plastic %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="plastic" value="${ticket.plastic_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0">
                        <label class="form-label" style="font-size:10px">üèóÔ∏è Drywall %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="drywall" value="${ticket.drywall_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                    <div class="form-group" style="margin-bottom:0;grid-column:span 2">
                        <label class="form-label" style="font-size:10px">üóëÔ∏è Landfill %</label>
                        <input type="number" class="form-input edit-mat-input" data-mat="landfill" value="${ticket.landfill_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                    </div>
                </div>
                <div style="text-align:center;margin-bottom:16px">
                    <span style="font-size:13px">Total: </span>
                    <span id="editMaterialsTotal" style="font-size:14px;font-weight:700;color:var(--emerald-400)">100%</span>
                </div>
            </div>
            
            <div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">
                <button class="btn btn-secondary" onclick="document.getElementById('editTicketModal').remove()" style="flex:1">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditedTicket('${ticketId}')" style="flex:1">üíæ Save Changes</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    updateEditTotal();
}

function updateEditTotal() {
    const inputs = document.querySelectorAll('.edit-mat-input');
    let total = 0;
    inputs.forEach(inp => total += parseInt(inp.value) || 0);
    const el = document.getElementById('editMaterialsTotal');
    if (el) {
        el.textContent = total + '%';
        el.style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
    }
}

async function saveEditedTicket(ticketId) {
    // Validate materials total
    const inputs = document.querySelectorAll('.edit-mat-input');
    let matTotal = 0;
    const mats = {};
    inputs.forEach(inp => {
        const val = parseInt(inp.value) || 0;
        mats[inp.dataset.mat] = val;
        matTotal += val;
    });
    
    if (matTotal < 99 || matTotal > 101) {
        toast('Materials must total 100% (currently ' + matTotal + '%)', 'error');
        return;
    }
    
    const grossLbs = parseFloat(document.getElementById('editGrossLbs').value) || 0;
    const tareLbs = parseFloat(document.getElementById('editTareLbs').value) || 0;
    const netLbs = grossLbs - tareLbs;
    const netTons = netLbs / 2000;
    
    if (grossLbs <= tareLbs) {
        toast('Gross weight must be greater than tare weight', 'error');
        return;
    }
    
    const updates = {
        ticket_number: document.getElementById('editTicketNum').value.trim(),
        service_date: document.getElementById('editServiceDate').value,
        hauler: document.getElementById('editHauler').value.trim(),
        container_size: parseInt(document.getElementById('editContainerSize').value) || 30,
        gross_lbs: grossLbs,
        tare_lbs: tareLbs,
        net_lbs: netLbs,
        net_tons: netTons,
        wood_pct: mats.wood || 0,
        concrete_pct: mats.concrete || 0,
        metal_pct: mats.metal || 0,
        cardboard_pct: mats.cardboard || 0,
        plastic_pct: mats.plastic || 0,
        drywall_pct: mats.drywall || 0,
        landfill_pct: mats.landfill || 0,
        wood_tons: ((mats.wood || 0) / 100) * netTons,
        concrete_tons: ((mats.concrete || 0) / 100) * netTons,
        metal_tons: ((mats.metal || 0) / 100) * netTons,
        cardboard_tons: ((mats.cardboard || 0) / 100) * netTons,
        plastic_tons: ((mats.plastic || 0) / 100) * netTons,
        drywall_tons: ((mats.drywall || 0) / 100) * netTons,
        landfill_tons: ((mats.landfill || 0) / 100) * netTons,
        diversion_pct: 100 - (mats.landfill || 0),
        diverted_tons: netTons * ((100 - (mats.landfill || 0)) / 100),
        updated_at: new Date().toISOString()
    };
    
    showLoading('Saving changes...');
    
    try {
        // Update in Supabase
        if (sb) {
            try {
                const { error } = await sb.from('tickets').update(updates).eq('id', ticketId);
                if (error) throw error;
            } catch (e) {
                console.log('Supabase update skipped:', e.message);
            }
        }
        
        // Update local
        const ticketIdx = tickets.findIndex(t => t.id === ticketId);
        if (ticketIdx >= 0) {
            Object.assign(tickets[ticketIdx], updates);
        }
        
        // Update IndexedDB
        try {
            const localTicket = await getFromLocal('tickets', ticketId);
            if (localTicket) {
                Object.assign(localTicket, updates);
                await saveToLocal('tickets', localTicket);
            }
        } catch (e) {}
        
        hideLoading();
        document.getElementById('editTicketModal').remove();
        renderRecentTickets();
        updateStats();
        toast('‚úÖ Ticket updated!', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

function confirmDeleteTicket(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (confirm(`Delete ticket #${ticket?.ticket_number}? This cannot be undone.`)) {
        deleteTicket(ticketId);
    }
}

async function deleteTicket(ticketId) {
    try {
        showLoading('Deleting...');
        // Delete from Supabase if connected
        if (sb) {
            try {
                await sb.from('tickets').delete().eq('id', ticketId);
            } catch (e) { console.log('Supabase delete skipped:', e.message); }
        }
        // Also delete from local IndexedDB
        try {
            await deleteFromLocal('tickets', ticketId);
        } catch (e) { console.log('Local delete skipped:', e.message); }
        
        hideLoading();
        
        tickets = tickets.filter(t => t.id !== ticketId);
        selectedTicketIds.delete(ticketId);
        renderRecentTickets();
        updateStats();
        updateTicketCount();
        updateBulkActionsBar();
        toast('Ticket deleted', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

async function updateStats() {
    if (!currentProject) {
        document.getElementById('statTotalTons').textContent = '0.00';
        document.getElementById('statDiversionRate').textContent = '0%';
        return;
    }
    
    try {
        let remoteData = [];
        let localData = [];
        
        // Try Supabase (with 5s timeout)
        if (sb) {
            try {
                const sbPromise = sb
                    .from('tickets')
                    .select('net_tons, diversion_pct, landfill_tons')
                    .eq('project_id', currentProject.id);
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                );
                const result = await Promise.race([sbPromise, timeoutPromise]);
                if (result && !result.error && result.data) remoteData = result.data;
            } catch (e) {
                console.log('Supabase stats fetch skipped:', e.message);
            }
        }
        
        // Always get local
        try {
            const allLocal = await getAllFromLocal('tickets') || [];
            localData = allLocal.filter(t => t.project_id === currentProject.id);
        } catch (e) {
            console.log('Local stats fetch error:', e.message);
        }
        
        // Merge
        const ticketMap = new Map();
        localData.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        remoteData.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        const data = Array.from(ticketMap.values());
        
        if (data.length > 0) {
            const totalTons = data.reduce((sum, t) => sum + (t.net_tons || 0), 0);
            const totalLandfill = data.reduce((sum, t) => sum + (t.landfill_tons || 0), 0);
            const diversionRate = totalTons > 0 ? Math.round(((totalTons - totalLandfill) / totalTons) * 100) : 0;
            
            document.getElementById('statTotalTons').textContent = totalTons.toFixed(2);
            document.getElementById('statDiversionRate').textContent = diversionRate + '%';
        }
        
        // Update charts and predictor
        updateCharts();
        updateLeedPredictor();
        
    } catch (err) {
        console.error('Error updating stats:', err);
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ========== GPS CAPTURE FOR AUDIT TRAIL ==========
function captureGPS() {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                ticketData.gpsLatitude = position.coords.latitude;
                ticketData.gpsLongitude = position.coords.longitude;
                ticketData.gpsAccuracy = position.coords.accuracy;
                console.log('GPS captured:', ticketData.gpsLatitude, ticketData.gpsLongitude, '¬±' + ticketData.gpsAccuracy + 'm');
            },
            (error) => {
                console.log('GPS not available:', error.message);
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }
}

// ========== TICKET MODAL ==========
function startNewTicket() {
    if (!currentProject) {
        toast('Please select a project first', 'error');
        showProjectPicker();
        return;
    }
    
    console.log('Starting new ticket');
    currentStep = 1;
    ticketData = {
        projectId: currentProject.id,
        ticketNumber: '',
        serviceDate: new Date().toISOString().split('T')[0],
        grossLbs: 0,
        tareLbs: 0,
        netTons: 0,
        hauler: currentProject.waste_hauler || '',
        containerSize: 30,
        photos: [],
        materials: { wood: 20, concrete: 15, metal: 10, cardboard: 20, plastic: 5, drywall: 10, landfill: 20 },
        diversionRate: 0,
        humanVerified: false,
        signature: null,
        scaleTicketPhoto: null,
        gpsLatitude: null,
        gpsLongitude: null,
        gpsAccuracy: null,
        captureTimestamp: new Date().toISOString(),
        signedBy: ''
    };
    debrisPhotos = [null, null, null];
    
    // Capture GPS location for audit trail
    captureGPS();
    
    // Reset form
    populateProjectDropdown();
    document.getElementById('ticketProject').value = currentProject.id;
    document.getElementById('serviceDate').value = ticketData.serviceDate;
    document.getElementById('ticketNumber').value = '';
    document.getElementById('grossLbs').value = '';
    document.getElementById('tareLbs').value = '';
    document.getElementById('netWeightDisplay').textContent = '0.00 tons';
    document.getElementById('haulerName').value = ticketData.hauler;
    document.getElementById('ticketImagePreview').innerHTML = '<span>Upload scale ticket photo</span>';
    document.getElementById('ticketImagePreview').classList.remove('filled');
    
    // Reset photos
    resetPhotoSlots();
    
    // Reset verification
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) checkbox.checked = false;
    const verifyBox = document.getElementById('verificationBox');
    if (verifyBox) verifyBox.classList.remove('verified');
    
    // Show step 1
    showStep(1);
    
    // Open modal
    document.getElementById('ticketModal').classList.add('active');
}

function closeTicketModal() {
    document.getElementById('ticketModal').classList.remove('active');
}

// ========== STEP NAVIGATION - CRITICAL ==========
function showStep(step) {
    console.log('===== SHOW STEP ' + step + ' =====');
    currentStep = step;
    
    // Hide ALL steps first
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('ticketStep' + i);
        if (stepEl) {
            stepEl.classList.add('hidden');
            stepEl.style.display = 'none';
            console.log('Hidden step ' + i);
        }
    }
    
    // Show current step
    const currentEl = document.getElementById('ticketStep' + step);
    if (currentEl) {
        currentEl.classList.remove('hidden');
        currentEl.style.display = 'block';
        console.log('Showing step ' + step);
    }
    
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById('stepIndicator' + i);
        if (indicator) {
            indicator.classList.remove('active', 'complete');
            if (i < step) indicator.classList.add('complete');
            else if (i === step) indicator.classList.add('active');
        }
        
        if (i < 4) {
            const line = document.getElementById('stepLine' + i);
            if (line) {
                line.classList.toggle('complete', i < step);
            }
        }
    }
    
    // Update buttons
    document.getElementById('backBtn').style.visibility = step === 1 ? 'hidden' : 'visible';
    document.getElementById('nextBtn').textContent = step === 4 ? '‚úÖ Submit' : 'Next';
    
    // Step-specific setup
    if (step === 2) {
        document.getElementById('step2TicketNum').textContent = ticketData.ticketNumber || '--';
        document.getElementById('step2NetWeight').textContent = ticketData.netTons.toFixed(2) + ' T';
    }
    
    if (step === 3) {
        populateReviewStep();
    }
    
    if (step === 4) {
        // Auto-set date if not already set
        if (!ticketData.serviceDate) {
            ticketData.serviceDate = new Date().toISOString().split('T')[0];
        }
        
        // Populate summary
        const s4Ticket = document.getElementById('step4TicketNum');
        const s4Date = document.getElementById('step4Date');
        const s4Weight = document.getElementById('step4Weight');
        const s4Diversion = document.getElementById('step4Diversion');
        
        if (s4Ticket) s4Ticket.textContent = ticketData.ticketNumber || '--';
        if (s4Date) s4Date.textContent = ticketData.serviceDate || new Date().toISOString().split('T')[0];
        if (s4Weight) s4Weight.textContent = (ticketData.netTons || 0).toFixed(2) + ' T';
        if (s4Diversion) {
            const rate = ticketData.diversionRate || 0;
            s4Diversion.textContent = rate + '%';
            s4Diversion.style.color = rate >= 75 ? 'var(--emerald-400)' : rate >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
        }
        
        setupSignaturePad();
    }
    
    // Scroll to top of modal
    const modalBody = document.querySelector('#ticketModal .modal-body');
    if (modalBody) modalBody.scrollTop = 0;
}

function goBack() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function goNext() {
    console.log('goNext called, currentStep:', currentStep);
    
    // STEP 1 VALIDATION
    if (currentStep === 1) {
        const project = document.getElementById('ticketProject').value;
        const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
        const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
        
        if (!project) {
            toast('Please select a project', 'error');
            return;
        }
        if (!gross || !tare) {
            toast('Please enter gross and tare weights', 'error');
            return;
        }
        
        ticketData.projectId = project;
        ticketData.ticketNumber = document.getElementById('ticketNumber').value;
        ticketData.serviceDate = document.getElementById('serviceDate').value;
        ticketData.grossLbs = gross;
        ticketData.tareLbs = tare;
        ticketData.netTons = (gross - tare) / 2000;
        ticketData.hauler = document.getElementById('haulerName').value;
        
        showStep(2);
        return;
    }
    
    // STEP 2 VALIDATION
    if (currentStep === 2) {
        if (ticketData.diversionRate === 0) {
            if (debrisPhotos.some(p => p)) {
                toast('Click "Analyze Materials" first', 'error');
            } else {
                toast('Upload photos and analyze', 'error');
            }
            return;
        }
        
        showStep(3);
        return;
    }
    
    // STEP 3 VALIDATION - CHECK HUMAN VERIFICATION
    if (currentStep === 3) {
        const checkbox = document.getElementById('humanVerifyCheckbox');
        console.log('Checkbox element:', checkbox);
        console.log('Checkbox checked:', checkbox ? checkbox.checked : 'NOT FOUND');
        
        if (!checkbox || !checkbox.checked) {
            toast('Please check the verification box', 'error');
            return;
        }
        
        // Save materials from inputs BEFORE leaving Step 3
        const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
        let total = 0;
        
        keys.forEach(key => {
            const input = document.getElementById('mat_' + key);
            if (input) {
                ticketData.materials[key] = parseInt(input.value) || 0;
                total += ticketData.materials[key];
            }
        });
        
        console.log('Materials saved:', ticketData.materials, 'Total:', total);
        
        // Validate total
        if (total < 99 || total > 101) {
            toast('Materials must total 100% (currently ' + total + '%)', 'error');
            return;
        }
        
        // Recalculate diversion
        ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);
        ticketData.humanVerified = true;
        
        showStep(4);
        return;
    }
    
    // STEP 4 - SUBMIT
    if (currentStep === 4) {
        submitTicket();
        return;
    }
}

// ========== STEP 1: SCALE TICKET ==========
function handleTicketPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = e.target.result;
        document.getElementById('ticketImagePreview').innerHTML = '<img src="' + img + '">';
        document.getElementById('ticketImagePreview').classList.add('filled');
        
        // Store for audit trail
        ticketData.scaleTicketPhoto = img;
        ticketData.captureTimestamp = new Date().toISOString();
        
        // Run OCR
        analyzeScaleTicket(img);
    };
    reader.readAsDataURL(file);
}

async function analyzeScaleTicket(imageData) {
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add Anthropic API key in Settings', 'error');
        return;
    }
    
    // Check if old OpenAI key is stored
    if (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-ant-')) {
        toast('‚ö†Ô∏è Old OpenAI key detected - please update to Anthropic key in Settings', 'error');
        return;
    }
    
    showLoading('Reading scale ticket with Claude AI...');
    
    try {
        // Extract base64 and media type from data URL
        const mediaType = imageData.split(';')[0].split(':')[1] || 'image/jpeg';
        const base64Data = imageData.split(',')[1];
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1024,
                messages: [{
                    role: 'user',
                    content: [
                        {
                            type: 'image',
                            source: {
                                type: 'base64',
                                media_type: mediaType,
                                data: base64Data
                            }
                        },
                        { 
                            type: 'text', 
                            text: `Extract ALL information from this scale ticket. Read every field carefully.

Return ONLY valid JSON with this structure (use null for any field you cannot read):
{
  "ticket_number": "string",
  "date": "MM/DD/YYYY",
  "gross_lbs": number,
  "tare_lbs": number,
  "net_lbs": number,
  "hauler": "string",
  "vehicle_id": "string or null",
  "material_type": "string or null",
  "customer": "string or null"
}

IMPORTANT: Read the actual numbers on the ticket. Do not estimate or guess weights.` 
                        }
                    ]
                }]
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            console.error('Claude API Error:', data.error);
            toast('API Error: ' + (data.error.message || JSON.stringify(data.error)), 'error');
            return;
        }
        
        let text = data.content[0].text;
        console.log('Scale ticket OCR response:', text);
        text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
        
        const match = text.match(/\{[\s\S]*\}/);
        
        if (match) {
            const result = JSON.parse(match[0]);
            console.log('Parsed scale ticket:', result);
            
            document.getElementById('ticketNumber').value = result.ticket_number || '';
            document.getElementById('grossLbs').value = result.gross_lbs || '';
            document.getElementById('tareLbs').value = result.tare_lbs || '';
            document.getElementById('haulerName').value = result.hauler || '';
            
            if (result.date) {
                const d = new Date(result.date);
                if (!isNaN(d)) {
                    document.getElementById('serviceDate').value = d.toISOString().split('T')[0];
                }
            }
            
            updateNetWeight();
            toast('‚úÖ Ticket read! Click Next to continue', 'success');
        } else {
            toast('Could not parse ticket data - try a clearer photo', 'warning');
        }
    } catch (err) {
        hideLoading();
        console.error('OCR Error:', err);
        toast('Error reading ticket: ' + err.message, 'error');
    }
}

function updateNetWeight() {
    const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
    const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
    const netLbs = Math.max(0, gross - tare);
    const netTons = netLbs / 2000;
    
    ticketData.grossLbs = gross;
    ticketData.tareLbs = tare;
    ticketData.netTons = netTons;
    
    document.getElementById('netWeightDisplay').textContent = netTons.toFixed(2) + ' tons';
}

// ========== STEP 2: DEBRIS PHOTOS ==========
function selectContainer(size) {
    ticketData.containerSize = size;
    document.querySelectorAll('.container-option').forEach(el => {
        el.classList.toggle('selected', el.querySelector('span').textContent == (size || '?'));
    });
}

function resetPhotoSlots() {
    for (let i = 0; i < 3; i++) {
        const slot = document.getElementById('photoSlot' + i);
        if (slot) {
            slot.innerHTML = '‚ûï';
            slot.classList.remove('filled');
        }
    }
    document.getElementById('photoCount').textContent = '0';
    document.getElementById('analysisResult').classList.add('hidden');
}

function triggerPhotoUpload(slot) {
    currentPhotoSlot = slot;
    document.getElementById('debrisPhotoInput').click();
}

function triggerDebrisCamera() {
    // Find first empty slot
    for (let i = 0; i < 3; i++) {
        if (!debrisPhotos[i]) {
            currentPhotoSlot = i;
            break;
        }
    }
    document.getElementById('debrisPhotoInput').click();
}

// Compress image to stay under Claude API 5MB limit
function compressImageForAPI(dataUrl, maxSizeBytes = 4500000) {
    return new Promise((resolve) => {
        // If already small enough, return as-is
        const currentSize = Math.round((dataUrl.length - dataUrl.indexOf(',') - 1) * 0.75);
        if (currentSize <= maxSizeBytes) {
            resolve(dataUrl);
            return;
        }
        
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Scale down large images (iPad photos can be 4032x3024)
            const maxDim = 2048;
            if (width > maxDim || height > maxDim) {
                const ratio = Math.min(maxDim / width, maxDim / height);
                width = Math.round(width * ratio);
                height = Math.round(height * ratio);
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Try quality levels until under limit
            let quality = 0.8;
            let result = canvas.toDataURL('image/jpeg', quality);
            let resultSize = Math.round((result.length - result.indexOf(',') - 1) * 0.75);
            
            while (resultSize > maxSizeBytes && quality > 0.3) {
                quality -= 0.1;
                result = canvas.toDataURL('image/jpeg', quality);
                resultSize = Math.round((result.length - result.indexOf(',') - 1) * 0.75);
            }
            
            // If still too big, scale down further
            if (resultSize > maxSizeBytes) {
                const ratio = 0.6;
                canvas.width = Math.round(width * ratio);
                canvas.height = Math.round(height * ratio);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                result = canvas.toDataURL('image/jpeg', 0.7);
            }
            
            console.log(`Image compressed: ${(currentSize/1024/1024).toFixed(1)}MB ‚Üí ${(Math.round((result.length - result.indexOf(',') - 1) * 0.75)/1024/1024).toFixed(1)}MB (${width}x${height})`);
            resolve(result);
        };
        img.src = dataUrl;
    });
}

function handleDebrisPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        const img = await compressImageForAPI(e.target.result);
        debrisPhotos[currentPhotoSlot] = img;
        
        const slot = document.getElementById('photoSlot' + currentPhotoSlot);
        slot.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + currentPhotoSlot + ', event)">√ó</button>';
        slot.classList.add('filled');
        
        updatePhotoCount();
    };
    reader.readAsDataURL(file);
    
    event.target.value = '';
}

function handleMultiplePhotos(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    let slotIndex = 0;
    
    files.forEach((file, i) => {
        // Find next empty slot
        while (slotIndex < 3 && debrisPhotos[slotIndex]) {
            slotIndex++;
        }
        if (slotIndex >= 3) return; // No more slots
        
        const reader = new FileReader();
        const slot = slotIndex;
        
        reader.onload = async function(e) {
            const img = await compressImageForAPI(e.target.result);
            debrisPhotos[slot] = img;
            
            const slotEl = document.getElementById('photoSlot' + slot);
            slotEl.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + slot + ', event)">√ó</button>';
            slotEl.classList.add('filled');
            
            updatePhotoCount();
        };
        reader.readAsDataURL(file);
        slotIndex++;
    });
    
    event.target.value = '';
}

function removePhoto(index, event) {
    event.stopPropagation();
    debrisPhotos[index] = null;
    
    const slot = document.getElementById('photoSlot' + index);
    slot.innerHTML = '‚ûï';
    slot.classList.remove('filled');
    
    updatePhotoCount();
}

function updatePhotoCount() {
    const count = debrisPhotos.filter(p => p).length;
    document.getElementById('photoCount').textContent = count;
}

async function analyzeDebris() {
    const photos = debrisPhotos.filter(p => p);
    if (photos.length === 0) {
        toast('Upload at least 1 photo', 'error');
        return;
    }
    
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add Anthropic API key in Settings', 'error');
        return;
    }
    
    if (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-ant-')) {
        toast('‚ö†Ô∏è Old OpenAI key detected - please update to Anthropic key in Settings', 'error');
        return;
    }
    
    showLoading('Checking photo quality...');
    
    try {
        // Compress any oversized photos before sending to API
        showLoading('Preparing photos...');
        for (let i = 0; i < photos.length; i++) {
            photos[i] = await compressImageForAPI(photos[i]);
        }
        
        // Build image content for Claude
        const imageContent = photos.map(p => ({
            type: 'image',
            source: {
                type: 'base64',
                media_type: p.split(';')[0].split(':')[1] || 'image/jpeg',
                data: p.split(',')[1]
            }
        }));
        
        // ENHANCED PROMPT with quality check, contamination detection, and reasoning
        const prompt = `You are a veteran C&D waste auditor working at a recycling facility in Dallas, TX. You process 50+ loads per day. Analyze these construction debris photos.

NOTE: Actual weights are captured separately from the scale ticket. Your job is ONLY to estimate material composition percentages based on what you see.

CRITICAL RULES FOR ESTIMATION:
1. You can ONLY identify what is CLEARLY VISIBLE. Do NOT assume hidden materials.
2. MOST loads are messier than they look. Default to higher landfill.
3. If you see mixed/tangled debris that would be hard to sort by hand, that is LANDFILL, not recyclable.
4. Broken, contaminated, painted, or treated wood = LANDFILL, not wood recycling.
5. Only count CLEAN, SORTABLE materials as recyclable.
6. Nails, fasteners, small metal pieces embedded in wood = NOT separable metal.
7. Dirty or wet cardboard = LANDFILL.
8. If material is ambiguous or hard to identify = LANDFILL.

REAL FACILITY BENCHMARKS (Dalmex Recycling, Dallas TX - actual weighed data):
- Clean wood-heavy loads: Wood 45-55%, Landfill 25-35%, Metal 5-8%, other 5-10%
- Mixed demo loads: Wood 25-35%, Concrete 10-20%, Landfill 30-40%, Metal 5-10%
- Concrete-heavy loads: Concrete 40-55%, Landfill 20-30%, Metal 5-10%, Wood 5-15%
- Typical overall diversion rate across ALL loads: 62-72%
- Loads above 80% diversion are RARE (< 10% of loads)
- Loads above 85% diversion are EXTREMELY RARE (< 2% of loads)

PERCENTAGE RULES:
- Landfill should almost ALWAYS be 25% or higher for mixed loads
- ONE material dominates most loads (35-55% range, not higher)
- Materials with less than 3% visible should be reported as 0%
- Do NOT spread small amounts across many categories - that looks fake
- Maximum 3-4 non-zero material categories for a typical load
- If diversion would exceed 75%, double-check your landfill estimate

PHOTO QUALITY: Rate as "good", "fair", or "poor".
CONTAMINATION: Note any contamination (wet materials, paint, soil, food waste, hazmat).

Return ONLY valid JSON:
{
  "quality": {
    "rating": "good|fair|poor",
    "issues": ["list of issues if any"]
  },
  "fill_level": {
    "percentage": 75,
    "description": "brief fill level description"
  },
  "contamination": {
    "detected": true|false,
    "types": ["contamination types if any"],
    "impact": "how contamination affects recyclability"
  },
  "materials": {
    "wood": 0,
    "concrete": 0,
    "metal": 0,
    "cardboard": 0,
    "plastic": 0,
    "drywall": 0,
    "landfill": 0
  },
  "reasoning": "2-3 sentences explaining what you see and why you assigned these percentages",
  "dominant_material": "name of most prominent material",
  "confidence": "high|medium|low"
}

Materials must total exactly 100. Err on the side of MORE landfill, not less.`;

        showLoading('Analyzing materials with Claude AI...');
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 2048,
                messages: [{
                    role: 'user',
                    content: [
                        ...imageContent,
                        { type: 'text', text: prompt }
                    ]
                }]
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            console.error('Claude API Error:', data.error);
            toast('API Error: ' + (data.error.message || JSON.stringify(data.error)), 'error');
            return;
        }
        
        let text = data.content[0].text;
        console.log('Claude full response:', text);
        text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
        
        const match = text.match(/\{[\s\S]*\}/);
        if (match) {
            const analysis = JSON.parse(match[0]);
            console.log('Parsed analysis:', analysis);
            
            // Store full analysis
            ticketData.aiAnalysis = analysis;
            
            // PHOTO QUALITY CHECK
            if (analysis.quality) {
                if (analysis.quality.rating === 'poor') {
                    toast('‚ö†Ô∏è Photo quality is poor - consider retaking photos', 'error');
                    // Show quality warning
                    showQualityWarning(analysis.quality.issues);
                } else if (analysis.quality.rating === 'fair') {
                    toast('üì∑ Photo quality is fair - results may vary', 'warning');
                }
            }
            
            // CONTAMINATION DETECTION
            if (analysis.contamination && analysis.contamination.detected) {
                ticketData.contaminationDetected = true;
                ticketData.contaminationTypes = analysis.contamination.types;
                showContaminationWarning(analysis.contamination);
            }
            
            // MATERIAL PROCESSING
            const result = analysis.materials || analysis;
            const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
            
            // Normalize to 100% if needed
            let total = 0;
            keys.forEach(k => { total += (result[k] || 0); });
            
            if (total > 0 && total !== 100) {
                const factor = 100 / total;
                keys.forEach(k => {
                    result[k] = Math.round((result[k] || 0) * factor);
                });
                let newTotal = keys.reduce((s, k) => s + result[k], 0);
                if (newTotal !== 100) result.landfill += (100 - newTotal);
            }
            
            // POST-PROCESSING GUARDRAILS
            let anomalies = [];
            const recyclableKeys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall'];
            
            // Guard 1: Enforce minimum 25% landfill for mixed loads (multiple materials)
            const nonZeroRecyclables = recyclableKeys.filter(k => (result[k] || 0) > 0);
            const minLandfill = nonZeroRecyclables.length >= 3 ? 25 : 20;
            
            if (result.landfill < minLandfill) {
                const deficit = minLandfill - result.landfill;
                anomalies.push(`‚ö†Ô∏è Landfill adjusted from ${result.landfill}% to ${minLandfill}% (mixed loads rarely below ${minLandfill}%)`);
                result.landfill = minLandfill;
                
                // Steal from the largest recyclable category to compensate
                const largestKey = recyclableKeys.reduce((a, b) => (result[a] || 0) > (result[b] || 0) ? a : b);
                result[largestKey] = Math.max(0, (result[largestKey] || 0) - deficit);
            }
            
            // Guard 2: Cap diversion at 75% unless only 1-2 clean materials dominate
            const diversionRate = 100 - result.landfill;
            if (diversionRate > 75 && nonZeroRecyclables.length >= 3) {
                const excess = diversionRate - 72; // Pull back to 72%
                anomalies.push(`‚ö†Ô∏è Diversion ${diversionRate}% exceeds typical range - adjusted to 72%`);
                result.landfill += excess;
                
                // Reduce the smallest non-zero recyclables first
                let remaining = excess;
                const sorted = [...recyclableKeys].sort((a, b) => (result[a] || 0) - (result[b] || 0));
                for (const k of sorted) {
                    if (remaining <= 0) break;
                    if ((result[k] || 0) > 0) {
                        const reduction = Math.min(result[k], remaining);
                        result[k] -= reduction;
                        remaining -= reduction;
                    }
                }
            }
            
            // Guard 3: Zero out tiny percentages (< 3%) - they look like guesses
            recyclableKeys.forEach(k => {
                if (result[k] > 0 && result[k] < 3) {
                    result.landfill += result[k];
                    result[k] = 0;
                }
            });
            
            // Guard 4: Catch suspiciously uniform distributions
            const nonZeroValues = keys.map(k => result[k]).filter(v => v > 0);
            const avg = nonZeroValues.reduce((a, b) => a + b, 0) / nonZeroValues.length;
            const variance = nonZeroValues.reduce((s, v) => s + Math.pow(v - avg, 2), 0) / nonZeroValues.length;
            if (variance < 80 && nonZeroValues.length > 3) {
                anomalies.push('‚ö†Ô∏è Distribution appears too flat/uniform - verify visually');
            }
            
            // Guard 5: Dominant material should actually dominate
            if (analysis.dominant_material) {
                const domKey = analysis.dominant_material.toLowerCase();
                const domValue = result[domKey] || 0;
                if (domValue < 30 && domValue > 0) {
                    anomalies.push(`‚ö†Ô∏è "${analysis.dominant_material}" identified as dominant but only ${domValue}%`);
                }
            }
            
            // Final re-normalize to exactly 100
            let finalTotal = keys.reduce((s, k) => s + (result[k] || 0), 0);
            if (finalTotal !== 100) {
                result.landfill += (100 - finalTotal);
            }
            
            // Store results
            ticketData.materials = result;
            ticketData.diversionRate = 100 - (result.landfill || 0);
            ticketData.aiReasoning = analysis.reasoning || '';
            ticketData.aiConfidence = analysis.confidence || 'medium';
            ticketData.anomalies = anomalies;
            
            // UPDATE UI
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = ticketData.diversionRate + '%';
            
            // Color code the rate
            const rateEl = document.getElementById('analysisRate');
            if (ticketData.diversionRate > 85) {
                rateEl.style.color = 'var(--amber-400)'; // Suspicious - too high
            } else if (ticketData.diversionRate >= 75) {
                rateEl.style.color = 'var(--emerald-400)'; // Good - meets LEED
            } else if (ticketData.diversionRate >= 50) {
                rateEl.style.color = 'var(--amber-400)'; // Below target
            } else {
                rateEl.style.color = 'var(--red-500)'; // Poor
            }
            
            // Show AI reasoning
            if (analysis.reasoning) {
                showAIReasoning(analysis.reasoning, analysis.confidence, anomalies);
            }
            
            // Show anomaly alerts
            if (anomalies.length > 0) {
                toast('‚ö†Ô∏è ' + anomalies.length + ' potential issue(s) detected - review carefully', 'warning');
            } else {
                toast('‚úÖ ' + ticketData.diversionRate + '% diversion estimated', 'success');
            }
            
            console.log('Final analysis:', {
                materials: ticketData.materials,
                diversion: ticketData.diversionRate,
                confidence: ticketData.aiConfidence,
                anomalies: anomalies
            });
            
        } else {
            // Fallback to safe defaults
            ticketData.materials = { wood: 20, concrete: 15, metal: 10, cardboard: 10, plastic: 10, drywall: 5, landfill: 30 };
            ticketData.diversionRate = 70;
            
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = '70%';
            
            toast('‚ö†Ô∏è Could not parse AI response - using estimates', 'warning');
        }
        
    } catch (err) {
        hideLoading();
        console.error('Analysis error:', err);
        toast('Analysis failed: ' + err.message, 'error');
    }
}

// Show photo quality warning
function showQualityWarning(issues) {
    const issueList = issues && issues.length > 0 ? issues.join(', ') : 'Poor lighting or focus';
    const html = `
        <div style="background:var(--amber-500);color:black;padding:12px;border-radius:8px;margin-bottom:12px">
            <strong>üì∑ Photo Quality Issue</strong><br>
            <span style="font-size:12px">${issueList}</span><br>
            <span style="font-size:11px;opacity:0.8">Consider retaking photos for more accurate analysis</span>
        </div>
    `;
    const container = document.getElementById('analysisResult');
    container.insertAdjacentHTML('afterbegin', html);
}

// Show contamination warning
function showContaminationWarning(contamination) {
    const types = contamination.types ? contamination.types.join(', ') : 'Unknown';
    const html = `
        <div style="background:var(--red-500);color:white;padding:12px;border-radius:8px;margin-bottom:12px">
            <strong>‚ö†Ô∏è Contamination Detected</strong><br>
            <span style="font-size:12px">${types}</span><br>
            <span style="font-size:11px;opacity:0.9">${contamination.impact || 'May reduce recyclability of materials'}</span>
        </div>
    `;
    const container = document.getElementById('analysisResult');
    container.insertAdjacentHTML('afterbegin', html);
}

// Show AI reasoning
function showAIReasoning(reasoning, confidence, anomalies) {
    const confidenceColor = confidence === 'high' ? 'var(--emerald-400)' : 
                           confidence === 'medium' ? 'var(--amber-400)' : 'var(--red-500)';
    
    let anomalyHtml = '';
    if (anomalies && anomalies.length > 0) {
        anomalyHtml = `
            <div style="background:var(--amber-500);color:black;padding:8px;border-radius:6px;margin-top:8px;font-size:11px">
                <strong>Anomalies:</strong><br>
                ${anomalies.map(a => '‚Ä¢ ' + a).join('<br>')}
            </div>
        `;
    }
    
    const html = `
        <div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-top:12px;font-size:12px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <strong>ü§ñ AI Analysis</strong>
                <span style="color:${confidenceColor};font-size:11px">Confidence: ${confidence || 'medium'}</span>
            </div>
            <p style="color:var(--slate-300);line-height:1.5">${reasoning}</p>
            ${anomalyHtml}
        </div>
    `;
    
    const container = document.getElementById('analysisResult');
    container.insertAdjacentHTML('beforeend', html);
}

// ========== STEP 3: REVIEW ==========
function populateReviewStep() {
    console.log('Populating review step');
    
    // Update diversion display
    document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
    document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
    
    // Show AI Reasoning if available
    const reasoningContainer = document.getElementById('aiReasoningSection');
    if (reasoningContainer) {
        if (ticketData.aiReasoning) {
            let html = `
                <div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <strong style="font-size:12px">ü§ñ AI Analysis</strong>
                        <span style="font-size:10px;color:${ticketData.aiConfidence === 'high' ? 'var(--emerald-400)' : 'var(--amber-400)'}">
                            ${ticketData.aiConfidence || 'medium'} confidence
                        </span>
                    </div>
                    <p style="font-size:11px;color:var(--slate-300);margin-bottom:8px">${ticketData.aiReasoning}</p>
            `;
            
            // Show anomalies if any
            if (ticketData.anomalies && ticketData.anomalies.length > 0) {
                html += `
                    <div style="background:var(--amber-500);color:black;padding:8px;border-radius:6px;font-size:10px">
                        <strong>‚ö†Ô∏è Review Items:</strong><br>
                        ${ticketData.anomalies.map(a => '‚Ä¢ ' + a.replace('‚ö†Ô∏è ', '')).join('<br>')}
                    </div>
                `;
            }
            
            // Show contamination warning if detected
            if (ticketData.contaminationDetected) {
                html += `
                    <div style="background:var(--red-500);color:white;padding:8px;border-radius:6px;font-size:10px;margin-top:8px">
                        <strong>‚ò£Ô∏è Contamination:</strong> ${ticketData.contaminationTypes ? ticketData.contaminationTypes.join(', ') : 'Detected'}
                    </div>
                `;
            }
            
            html += '</div>';
            reasoningContainer.innerHTML = html;
            reasoningContainer.classList.remove('hidden');
        } else {
            reasoningContainer.classList.add('hidden');
        }
    }
    
    // Build materials list
    const materials = ticketData.materials;
    const names = {
        wood: 'ü™µ Wood',
        concrete: 'üß± Concrete',
        metal: 'üî© Metal',
        cardboard: 'üì¶ Cardboard',
        plastic: '‚ôªÔ∏è Plastic',
        drywall: 'üèóÔ∏è Drywall',
        landfill: 'üóëÔ∏è Landfill'
    };
    
    const container = document.getElementById('materialsList');
    container.innerHTML = '';
    
    Object.entries(materials).forEach(([key, value]) => {
        const div = document.createElement('div');
        div.className = 'material-item';
        div.innerHTML = '<span class="material-name">' + (names[key] || key) + '</span>' +
            '<div class="material-input">' +
            '<input type="number" id="mat_' + key + '" value="' + (value || 0) + '" min="0" max="100">' +
            '<span>%</span></div>';
        
        // Add event listener properly
        const input = div.querySelector('input');
        input.addEventListener('input', function() {
            updateMaterial(key);
        });
        
        container.appendChild(div);
    });
    
    updateMaterialsTotal();
    
    // Reset verification checkbox
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) {
        checkbox.checked = ticketData.humanVerified;
        onVerificationChange();
    }
}

function updateMaterial(key) {
    const input = document.getElementById('mat_' + key);
    if (input) {
        const newValue = parseInt(input.value) || 0;
        ticketData.materials[key] = newValue;
        
        // Recalculate diversion (100 - landfill%)
        const landfill = ticketData.materials.landfill || 0;
        ticketData.diversionRate = 100 - landfill;
        document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
        document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
        
        // Update color based on LEED target
        const badge = document.getElementById('reviewDiversionRate');
        if (ticketData.diversionRate >= 75) {
            badge.style.color = 'var(--emerald-400)';
        } else if (ticketData.diversionRate >= 50) {
            badge.style.color = 'var(--amber-400)';
        } else {
            badge.style.color = 'var(--red-500)';
        }
        
        updateMaterialsTotal();
    }
}

function updateMaterialsTotal() {
    // Read directly from inputs to ensure accuracy
    let total = 0;
    const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
    
    keys.forEach(key => {
        const input = document.getElementById('mat_' + key);
        if (input) {
            const val = parseInt(input.value) || 0;
            ticketData.materials[key] = val;
            total += val;
        }
    });
    
    const totalEl = document.getElementById('materialsTotal');
    totalEl.textContent = total + '%';
    totalEl.style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
}

function onVerificationChange() {
    const checkbox = document.getElementById('humanVerifyCheckbox');
    const box = document.getElementById('verificationBox');
    
    if (checkbox && box) {
        if (checkbox.checked) {
            box.classList.add('verified');
            ticketData.humanVerified = true;
        } else {
            box.classList.remove('verified');
            ticketData.humanVerified = false;
        }
    }
}

// ========== STEP 4: SIGNATURE ==========
function setupSignaturePad() {
    const canvas = document.getElementById('signaturePad');
    if (!canvas) return;
    
    signatureCanvas = canvas;
    signatureCtx = canvas.getContext('2d');
    
    // Set size
    canvas.width = canvas.offsetWidth;
    canvas.height = 150;
    
    // Clear
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    draw(e);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.strokeStyle = 'black';
    
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function stopDrawing() {
    isDrawing = false;
    signatureCtx.beginPath();
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    startDrawing(mouseEvent);
}

function handleTouchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    draw(mouseEvent);
}

function clearSignature() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.fillStyle = 'white';
        signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

// ========== SUBMIT ==========
async function submitTicket() {
    console.log('submitTicket called');
    
    // Auto-set date if missing
    if (!ticketData.serviceDate) {
        ticketData.serviceDate = new Date().toISOString().split('T')[0];
    }
    
    // Capture signature if provided (optional)
    if (signatureCanvas) {
        try {
            const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            let hasSignature = false;
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i] < 250) {
                    hasSignature = true;
                    break;
                }
            }
            if (hasSignature) {
                ticketData.signature = signatureCanvas.toDataURL();
            }
        } catch (e) {
            // Signature pad may not be initialized if details was never opened - that's fine
            console.log('Signature pad not available:', e.message);
        }
    }
    
    // Read materials fresh from inputs
    const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
    let total = 0;
    let foundInputs = 0;
    
    keys.forEach(key => {
        const input = document.getElementById('mat_' + key);
        if (input) {
            foundInputs++;
            ticketData.materials[key] = parseInt(input.value) || 0;
            total += ticketData.materials[key];
        } else {
            // Fallback to ticketData if input not found
            total += ticketData.materials[key] || 0;
        }
    });
    
    console.log('Materials check - Inputs found:', foundInputs, 'Total:', total, ticketData.materials);
    
    // Allow some tolerance (98-102%)
    if (total < 98 || total > 102) {
        toast('Materials must total 100% (currently ' + total + '%). Go back to Step 3 to adjust.', 'error');
        return;
    }
    
    // Recalculate diversion rate
    ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);
    
    // Calculate material tons
    const m = ticketData.materials;
    const netTons = ticketData.netTons || 0;
    
    // Build database record with ONLY columns that exist
    const dbRecord = {
        project_id: ticketData.projectId,
        ticket_number: ticketData.ticketNumber || '',
        service_date: ticketData.serviceDate || new Date().toISOString().split('T')[0],
        hauler: ticketData.hauler || currentProject?.waste_hauler || '',
        container_size: ticketData.containerSize || 30,
        gross_lbs: ticketData.grossLbs || 0,
        tare_lbs: ticketData.tareLbs || 0,
        net_lbs: (ticketData.grossLbs || 0) - (ticketData.tareLbs || 0),
        net_tons: netTons,
        wood_pct: m.wood || 0,
        concrete_pct: m.concrete || 0,
        metal_pct: m.metal || 0,
        cardboard_pct: m.cardboard || 0,
        plastic_pct: m.plastic || 0,
        drywall_pct: m.drywall || 0,
        landfill_pct: m.landfill || 0,
        wood_tons: ((m.wood || 0) / 100) * netTons,
        concrete_tons: ((m.concrete || 0) / 100) * netTons,
        metal_tons: ((m.metal || 0) / 100) * netTons,
        cardboard_tons: ((m.cardboard || 0) / 100) * netTons,
        plastic_tons: ((m.plastic || 0) / 100) * netTons,
        drywall_tons: ((m.drywall || 0) / 100) * netTons,
        landfill_tons: ((m.landfill || 0) / 100) * netTons,
        diversion_pct: ticketData.diversionRate,
        diverted_tons: netTons * (ticketData.diversionRate / 100),
        human_verified: ticketData.humanVerified || false,
        photo_count: debrisPhotos.filter(p => p).length,
        is_closed: true,
        created_at: new Date().toISOString()
    };
    
    // Only add signature fields if a signature was actually captured (prevents schema mismatch)
    if (ticketData.signature) {
        dbRecord.signature = ticketData.signature;
        dbRecord.signed_at = new Date().toISOString();
    }
    
    // Only add optional columns if they have values (to avoid column not found errors)
    if (ticketData.scaleTicketPhoto) dbRecord.scale_ticket_photo = ticketData.scaleTicketPhoto;
    if (debrisPhotos[0]) dbRecord.debris_photo_1 = debrisPhotos[0];
    if (debrisPhotos[1]) dbRecord.debris_photo_2 = debrisPhotos[1];
    if (debrisPhotos[2]) dbRecord.debris_photo_3 = debrisPhotos[2];
    if (ticketData.gpsLatitude) dbRecord.gps_latitude = ticketData.gpsLatitude;
    if (ticketData.gpsLongitude) dbRecord.gps_longitude = ticketData.gpsLongitude;
    if (ticketData.gpsAccuracy) dbRecord.gps_accuracy = ticketData.gpsAccuracy;
    if (ticketData.captureTimestamp) dbRecord.capture_timestamp = ticketData.captureTimestamp;
    
    console.log('dbRecord to save:', Object.keys(dbRecord));
    
    if (sb) {
        try {
            showLoading('Saving ticket...');
            
            // Use bulletproof save with offline support
            const success = await saveTicketWithOfflineSupport(dbRecord);
            
            hideLoading();
            
            if (success) {
                // Clear draft on successful save
                await clearDraft();
                
                closeTicketModal();
                toast('‚úÖ Ticket #' + ticketData.ticketNumber + ' saved!', 'success');
                loadRecentTickets();
                updateStats();
                
                // Check LEED compliance
                const leedResult = validateLeedCompliance(ticketData.diversionRate, netTons);
                if (leedResult.warnings.length > 0) {
                    setTimeout(() => {
                        toast('‚ö†Ô∏è ' + leedResult.warnings[0], 'warning');
                    }, 2000);
                }
            }
        } catch (err) {
            hideLoading();
            console.error('Submit error:', err);
            toast('Error: ' + err.message, 'error');
        }
    } else {
        // No Supabase - save locally only
        try {
            dbRecord.id = 'local_' + Date.now();
            await saveToLocal('tickets', dbRecord);
            await addToSyncQueue('insert', 'tickets', dbRecord);
            await clearDraft();
            
            closeTicketModal();
            toast('‚úÖ Ticket saved locally (connect Supabase to sync)', 'success');
        } catch (err) {
            toast('Local save failed: ' + err.message, 'error');
        }
    }
}

// ========== UTILITIES ==========
function showLoading(text) {
    document.getElementById('loadingText').textContent = text || 'Processing...';
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function toast(message, type) {
    const t = document.getElementById('toast');
    t.textContent = message;
    t.className = 'toast show ' + (type || '');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// ========== REPORTS ==========
let reportData = [];

async function generateReport() {
    console.log('generateReport called');
    console.log('sb:', sb);
    console.log('currentProject:', currentProject);
    
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    showLoading('Generating report...');
    
    try {
        console.log('Fetching tickets for project:', currentProject.id);
        
        let remoteData = [];
        let localData = [];
        
        // Try to fetch from Supabase if configured (with 5s timeout)
        if (sb) {
            try {
                const sbPromise = sb
                    .from('tickets')
                    .select('*')
                    .eq('project_id', currentProject.id)
                    .order('service_date', { ascending: true });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                );
                const result = await Promise.race([sbPromise, timeoutPromise]);
                
                if (result && !result.error && result.data) {
                    remoteData = result.data;
                    console.log('Remote tickets found:', remoteData.length);
                }
            } catch (e) {
                console.log('Supabase fetch skipped:', e.message);
            }
        }
        
        // Always fetch from local IndexedDB (where Excel imports are stored)
        try {
            const allLocalTickets = await getAllFromLocal('tickets') || [];
            localData = allLocalTickets.filter(t => t.project_id === currentProject.id);
            console.log('Local tickets found:', localData.length);
        } catch (e) {
            console.log('Local fetch error:', e.message);
        }
        
        // Merge and dedupe by ticket_number (prefer remote if exists in both)
        const ticketMap = new Map();
        
        // Add local tickets first
        localData.forEach(t => {
            const key = t.ticket_number || t.id;
            ticketMap.set(key, t);
        });
        
        // Remote tickets override local (synced data takes precedence)
        remoteData.forEach(t => {
            const key = t.ticket_number || t.id;
            ticketMap.set(key, t);
        });
        
        reportData = Array.from(ticketMap.values());
        
        // Sort by service_date
        reportData.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));
        
        console.log('Total merged tickets:', reportData.length);
        hideLoading();
        
        if (reportData.length === 0) {
            toast('No tickets found for this project. Import or submit some tickets first!', 'error');
            return;
        }
        
        // Show download buttons
        document.getElementById('reportDownloadBtns').style.display = 'grid';
        
        // Project Header
        document.getElementById('reportProjectName').textContent = currentProject.name || '-';
        document.getElementById('reportProjectAddress').textContent = currentProject.address || '-';
        document.getElementById('reportProjectGC').textContent = currentProject.general_contractor || currentProject.contractor || '-';
        document.getElementById('reportProjectHauler').textContent = currentProject.waste_hauler || '-';
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('reportGeneratedDate').textContent = new Date().toLocaleString();
        
        // Calculate date range
        const dates = reportData.map(t => new Date(t.service_date)).filter(d => !isNaN(d));
        if (dates.length > 0) {
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            document.getElementById('reportPeriod').textContent = 
                minDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' - ' +
                maxDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Calculate totals
        let totalTons = 0, landfillTons = 0;
        let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0;
        let plasticTons = 0, drywallTons = 0;
        
        reportData.forEach(t => {
            totalTons += t.net_tons || 0;
            landfillTons += t.landfill_tons || 0;
            woodTons += t.wood_tons || 0;
            concreteTons += t.concrete_tons || 0;
            metalTons += t.metal_tons || 0;
            cardboardTons += t.cardboard_tons || 0;
            plasticTons += t.plastic_tons || 0;
            drywallTons += t.drywall_tons || 0;
        });
        
        const divertedTons = totalTons - landfillTons;
        const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        
        // Update summary
        document.getElementById('reportTicketCount').textContent = reportData.length;
        document.getElementById('reportLoadCount').textContent = reportData.length + ' loads';
        document.getElementById('reportTotalTons').textContent = totalTons.toFixed(2);
        document.getElementById('reportDivertedTons').textContent = divertedTons.toFixed(2);
        document.getElementById('reportLandfillTons').textContent = landfillTons.toFixed(2);
        document.getElementById('reportTotalDiverted').textContent = divertedTons.toFixed(2) + ' T';
        document.getElementById('reportTotalLandfill').textContent = landfillTons.toFixed(2) + ' T';
        
        // Diversion rate with color
        const rateEl = document.getElementById('reportDiversionRate');
        rateEl.textContent = diversionRate + '%';
        rateEl.style.color = diversionRate >= 75 ? 'var(--emerald-400)' : diversionRate >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
        
        // LEED Status
        const statusEl = document.getElementById('reportLeedStatus');
        if (diversionRate >= 75) {
            statusEl.textContent = '‚úÖ PASS';
            statusEl.style.color = 'var(--emerald-400)';
        } else if (diversionRate >= 50) {
            statusEl.textContent = '‚ö†Ô∏è PARTIAL';
            statusEl.style.color = 'var(--amber-400)';
        } else {
            statusEl.textContent = '‚ùå BELOW';
            statusEl.style.color = 'var(--red-500)';
        }
        
        // Material breakdown with progress bars
        const materials = [
            { name: 'Wood', icon: 'ü™µ', tons: woodTons, diverted: true },
            { name: 'Concrete/Masonry', icon: 'üß±', tons: concreteTons, diverted: true },
            { name: 'Metal', icon: 'üî©', tons: metalTons, diverted: true },
            { name: 'Cardboard/Paper', icon: 'üì¶', tons: cardboardTons, diverted: true },
            { name: 'Plastic', icon: '‚ôªÔ∏è', tons: plasticTons, diverted: true },
            { name: 'Drywall', icon: 'üèóÔ∏è', tons: drywallTons, diverted: true },
            { name: 'Landfill', icon: 'üóëÔ∏è', tons: landfillTons, diverted: false }
        ];
        
        document.getElementById('reportMaterialBreakdown').innerHTML = materials.map(m => {
            const pct = totalTons > 0 ? (m.tons / totalTons) * 100 : 0;
            const barColor = m.diverted ? 'var(--emerald-500)' : 'var(--red-500)';
            return `
                <div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>${m.icon} ${m.name}</span>
                        <span style="font-weight:600">${m.tons.toFixed(2)} T (${pct.toFixed(1)}%)</span>
                    </div>
                    <div style="height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden">
                        <div style="height:100%;width:${Math.min(pct, 100)}%;background:${barColor}"></div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Detailed ticket table with data cards + hardened header
        const reportType = document.getElementById('reportType')?.value || 'summary';
        
        let detailHtml = '';
        
        if (reportType === 'detailed') {
            // Card-based view for detailed reports
            detailHtml = reportData.map((t, idx) => {
                const divPct = t.diversion_pct || 0;
                const badgeColor = divPct >= 75 ? '#2ecc71' : divPct >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
                const matChips = [
                    { name: 'Wood', pct: t.wood_pct, diverted: true },
                    { name: 'Concrete', pct: t.concrete_pct, diverted: true },
                    { name: 'Metal', pct: t.metal_pct, diverted: true },
                    { name: 'Cardboard', pct: t.cardboard_pct, diverted: true },
                    { name: 'Plastic', pct: t.plastic_pct, diverted: true },
                    { name: 'Drywall', pct: t.drywall_pct, diverted: true },
                    { name: 'Landfill', pct: t.landfill_pct, diverted: false }
                ].filter(m => m.pct > 0);
                
                return `
                <div class="report-data-card">
                    <div class="card-header">
                        <div class="card-title">#${t.ticket_number || 'N/A'} ‚Äî ${formatDate(t.service_date)}</div>
                        <div class="card-badge" style="background:${badgeColor}20;color:${badgeColor}">${divPct}% Diverted</div>
                    </div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">${t.hauler || 'No hauler'} ${t.human_verified ? '‚úÖ Verified' : '‚ùå Unverified'}</div>
                    <div class="weights-grid">
                        <div class="weight-cell"><div class="val">${(t.gross_lbs || 0).toLocaleString()}</div><div class="lbl">GROSS LBS</div></div>
                        <div class="weight-cell"><div class="val">${(t.tare_lbs || 0).toLocaleString()}</div><div class="lbl">TARE LBS</div></div>
                        <div class="weight-cell"><div class="val" style="color:#2ecc71">${(t.net_tons || 0).toFixed(2)}</div><div class="lbl">NET TONS</div></div>
                    </div>
                    <div class="materials-row">
                        ${matChips.map(m => `<span class="mat-chip ${m.diverted ? 'diverted' : 'landfill'}">${m.name} ${m.pct}%</span>`).join('')}
                    </div>
                </div>`;
            }).join('');
        } else {
            // Standard table view with hardened headers
            detailHtml = `
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Ticket #</th>
                        <th>Hauler</th>
                        <th class="right">Gross</th>
                        <th class="right">Tare</th>
                        <th class="right">Net (T)</th>
                        <th class="right">Diversion</th>
                        <th class="center">Verified</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(t => `
                        <tr>
                            <td>${formatDate(t.service_date)}</td>
                            <td>${t.ticket_number || '-'}</td>
                            <td>${t.hauler || '-'}</td>
                            <td style="text-align:right">${(t.gross_lbs || 0).toLocaleString()}</td>
                            <td style="text-align:right">${(t.tare_lbs || 0).toLocaleString()}</td>
                            <td style="text-align:right;font-weight:600">${(t.net_tons || 0).toFixed(2)}</td>
                            <td style="text-align:right;color:${(t.diversion_pct || 0) >= 75 ? '#2ecc71' : 'var(--amber-400)'}">${t.diversion_pct || 0}%</td>
                            <td style="text-align:center">${t.human_verified ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5">TOTALS</td>
                        <td style="text-align:right">${totalTons.toFixed(2)}</td>
                        <td style="text-align:right;color:${diversionRate >= 75 ? '#2ecc71' : 'var(--amber-400)'}">${diversionRate}%</td>
                        <td style="text-align:center">${reportData.filter(t => t.human_verified).length}/${reportData.length}</td>
                    </tr>
                </tfoot>
            </table>`;
        }
        
        document.getElementById('reportContent').innerHTML = detailHtml;
        
        document.getElementById('reportOutput').classList.remove('hidden');
        toast('Report generated!', 'success');
        
    } catch (err) {
        hideLoading();
        console.error('Report error:', err);
        toast('Error generating report: ' + err.message, 'error');
    }
}

function downloadReportCSV() {
    if (reportData.length === 0) {
        toast('Generate a report first', 'error');
        return;
    }
    
    // Create comprehensive CSV
    const projectInfo = [
        ['LEED MRc5 WASTE DIVERSION REPORT'],
        [''],
        ['Project Name', currentProject.name || ''],
        ['Project Address', currentProject.address || ''],
        ['General Contractor', currentProject.general_contractor || ''],
        ['Waste Hauler', currentProject.waste_hauler || ''],
        ['Report Date', new Date().toLocaleDateString()],
        [''],
        ['SUMMARY'],
        ['Total Loads', reportData.length],
        ['Total Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0).toFixed(2)],
        ['Diverted Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0).toFixed(2)],
        ['Landfill Tons', reportData.reduce((sum, t) => sum + (t.landfill_tons || 0), 0).toFixed(2)],
        ['Diversion Rate', (reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0) > 0 ? 
            Math.round((reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0) / 
            reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0)) * 100) : 0) + '%'],
        [''],
        ['LOAD DETAILS'],
        ['Date', 'Ticket #', 'Hauler', 'Container', 'Gross Lbs', 'Tare Lbs', 'Net Tons', 
         'Wood %', 'Concrete %', 'Metal %', 'Cardboard %', 'Plastic %', 'Drywall %', 'Landfill %',
         'Wood Tons', 'Concrete Tons', 'Metal Tons', 'Cardboard Tons', 'Plastic Tons', 'Drywall Tons', 'Landfill Tons',
         'Diversion %', 'Human Verified', 'GPS Lat', 'GPS Long', 'Photos']
    ];
    
    const rows = reportData.map(t => [
        t.service_date,
        t.ticket_number || '',
        t.hauler || '',
        t.container_size || '',
        t.gross_lbs || 0,
        t.tare_lbs || 0,
        (t.net_tons || 0).toFixed(2),
        t.wood_pct || 0,
        t.concrete_pct || 0,
        t.metal_pct || 0,
        t.cardboard_pct || 0,
        t.plastic_pct || 0,
        t.drywall_pct || 0,
        t.landfill_pct || 0,
        (t.wood_tons || 0).toFixed(2),
        (t.concrete_tons || 0).toFixed(2),
        (t.metal_tons || 0).toFixed(2),
        (t.cardboard_tons || 0).toFixed(2),
        (t.plastic_tons || 0).toFixed(2),
        (t.drywall_tons || 0).toFixed(2),
        (t.landfill_tons || 0).toFixed(2),
        t.diversion_pct || 0,
        t.human_verified ? 'Yes' : 'No',
        t.gps_latitude || '',
        t.gps_longitude || '',
        t.photo_count || 0
    ]);
    
    const allRows = [...projectInfo, ...rows];
    const csv = allRows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `LEED_MRc5_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    toast('CSV downloaded!', 'success');
}

function downloadReportPDF() {
    if (reportData.length === 0) {
        toast('Generate a report first', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    // Calculate totals
    let totalTons = 0, landfillTons = 0;
    let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0, plasticTons = 0, drywallTons = 0;
    
    reportData.forEach(t => {
        totalTons += t.net_tons || 0;
        landfillTons += t.landfill_tons || 0;
        woodTons += t.wood_tons || 0;
        concreteTons += t.concrete_tons || 0;
        metalTons += t.metal_tons || 0;
        cardboardTons += t.cardboard_tons || 0;
        plasticTons += t.plastic_tons || 0;
        drywallTons += t.drywall_tons || 0;
    });
    
    const divertedTons = totalTons - landfillTons;
    const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
    
    let y = 15;
    
    // Header - Right aligned company info
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Jaguar Waste Management', 280, y, { align: 'right' });
    y += 6;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('214-487-3457', 280, y, { align: 'right' });
    
    // Left side - Recipient
    y = 15;
    doc.setFontSize(9);
    doc.text('ATTN: ' + (currentProject.general_contractor || 'Project Manager'), 14, y);
    y += 5;
    doc.text('RE: ' + (currentProject.name || 'Construction Project'), 14, y);
    y += 8;
    doc.text('Date: ' + new Date().toLocaleDateString(), 14, y);
    y += 10;
    
    // Letter body
    doc.text('Dear Client,', 14, y);
    y += 6;
    const reportMonth = reportData.length > 0 && reportData[0].service_date ? 
        new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 
        'Current Period';
    doc.text('Below are the tonnage reports for ' + reportMonth + '. The report lists all the information needed for each haul.', 14, y);
    y += 12;
    
    // Project Site Address Box
    doc.setFillColor(240, 240, 240);
    doc.rect(14, y, 100, 10, 'F');
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(34, 139, 34); // Green color like HD Waste
    doc.text(currentProject.address || currentProject.name || 'Project Site', 18, y + 7);
    doc.setTextColor(0, 0, 0);
    y += 18;
    
    // Table Header
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setFillColor(255, 255, 255);
    
    const colX = [14, 34, 64, 94, 124, 154, 179, 204, 229, 254];
    const colW = [20, 30, 30, 30, 30, 25, 25, 25, 25, 25];
    const headers = ['Month', 'Date', 'W/O & TKT #', 'Total Ton', 'BRK/BLCK/CON', 'Metal/Alum', 'OCC', 'Plastic', 'Wood', 'Trash'];
    
    // Draw header row
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    headers.forEach((h, i) => {
        doc.rect(colX[i], y, colW[i], 8);
        doc.text(h, colX[i] + 2, y + 5.5);
    });
    y += 8;
    
    // Get month name for first column
    const monthName = reportData.length > 0 && reportData[0].service_date ? 
        new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long' }) : '';
    
    // Data rows
    doc.setFont('helvetica', 'normal');
    let firstRow = true;
    
    reportData.forEach((t, idx) => {
        if (y > 180) {
            doc.addPage('landscape');
            y = 20;
            // Redraw header on new page
            doc.setFont('helvetica', 'bold');
            headers.forEach((h, i) => {
                doc.rect(colX[i], y, colW[i], 8);
                doc.text(h, colX[i] + 2, y + 5.5);
            });
            y += 8;
            doc.setFont('helvetica', 'normal');
            firstRow = true;
        }
        
        const rowData = [
            firstRow ? monthName : '',
            t.service_date ? new Date(t.service_date).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'numeric'}) : '',
            t.ticket_number || '',
            (t.net_tons || 0).toFixed(2),
            (t.concrete_tons || 0) > 0 ? (t.concrete_tons || 0).toFixed(2) : '',
            (t.metal_tons || 0) > 0 ? (t.metal_tons || 0).toFixed(2) : '',
            (t.cardboard_tons || 0) > 0 ? (t.cardboard_tons || 0).toFixed(2) : '',
            (t.plastic_tons || 0) > 0 ? (t.plastic_tons || 0).toFixed(2) : '',
            (t.wood_tons || 0) > 0 ? (t.wood_tons || 0).toFixed(2) : '',
            (t.landfill_tons || 0) > 0 ? (t.landfill_tons || 0).toFixed(2) : ''
        ];
        
        rowData.forEach((d, i) => {
            doc.rect(colX[i], y, colW[i], 6);
            doc.text(String(d), colX[i] + 2, y + 4);
        });
        
        y += 6;
        firstRow = false;
    });
    
    // Totals row
    y += 2;
    doc.setFont('helvetica', 'bold');
    const totalsData = [
        '', 'Total:', '', 
        totalTons.toFixed(2),
        concreteTons.toFixed(2),
        metalTons.toFixed(2),
        cardboardTons.toFixed(2),
        plasticTons.toFixed(2),
        woodTons.toFixed(2),
        landfillTons.toFixed(2)
    ];
    
    totalsData.forEach((d, i) => {
        doc.rect(colX[i], y, colW[i], 6);
        doc.text(String(d), colX[i] + 2, y + 4);
    });
    y += 6;
    
    // Percentage row
    const pctData = [
        '', 'Percentage:', '',
        '',
        totalTons > 0 ? Math.round((concreteTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((metalTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((cardboardTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((plasticTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((woodTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((landfillTons/totalTons)*100) + '%' : '0%'
    ];
    
    pctData.forEach((d, i) => {
        doc.rect(colX[i], y, colW[i], 6);
        doc.text(String(d), colX[i] + 2, y + 4);
    });
    y += 12;
    
    // Diversion Summary
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('DIVERSION SUMMARY', 14, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('Total Diverted: ' + divertedTons.toFixed(2) + ' tons (' + diversionRate + '%)', 14, y);
    y += 5;
    doc.text('Total Landfill: ' + landfillTons.toFixed(2) + ' tons (' + (100-diversionRate) + '%)', 14, y);
    y += 5;
    doc.setFont('helvetica', 'bold');
    doc.text('LEED MRc5 Status: ' + (diversionRate >= 75 ? 'COMPLIANT (>=75%)' : 'NON-COMPLIANT (<75%)'), 14, y);
    
    // Footer
    const pageHeight = doc.internal.pageSize.height;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('Generated by DivertScan‚Ñ¢ | ' + new Date().toLocaleString(), 14, pageHeight - 10);
    doc.text(currentProject.waste_hauler || 'Jaguar Waste Management', 280, pageHeight - 10, { align: 'right' });
    
    // Save
    doc.save(`Tonnage_Report_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    
    toast('PDF downloaded!', 'success');
}

// ========== LEED AUDIT REPORT ==========
async function generateLEEDAuditReport() {
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    showLoading('Generating LEED Audit Report...');
    
    try {
        // Gather all tickets (local + remote)
        let allTickets = [];
        try {
            const localTickets = await getAllFromLocal('tickets') || [];
            allTickets = localTickets.filter(t => t.project_id === currentProject.id);
        } catch(e) {}
        
        if (sb) {
            try {
                const tp = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
                const res = await Promise.race([sb.from('tickets').select('*').eq('project_id', currentProject.id).order('service_date', {ascending:true}), tp]);
                if (res?.data) {
                    const map = new Map();
                    allTickets.forEach(t => map.set(t.ticket_number || t.id, t));
                    res.data.forEach(t => map.set(t.ticket_number || t.id, t));
                    allTickets = Array.from(map.values());
                }
            } catch(e) {}
        }
        
        allTickets.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));
        
        if (allTickets.length === 0) {
            hideLoading();
            toast('No tickets found for this project', 'error');
            return;
        }
        
        // Calculate project-wide stats
        const totalTons = allTickets.reduce((s, t) => s + (t.net_tons || 0), 0);
        const landfillTons = allTickets.reduce((s, t) => s + (t.landfill_tons || 0), 0);
        const divertedTons = totalTons - landfillTons;
        const divRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        const woodTons = allTickets.reduce((s, t) => s + (t.wood_tons || 0), 0);
        const metalTons = allTickets.reduce((s, t) => s + (t.metal_tons || 0), 0);
        const cardboardTons = allTickets.reduce((s, t) => s + (t.cardboard_tons || 0), 0);
        const concreteTons = allTickets.reduce((s, t) => s + (t.concrete_tons || 0), 0);
        const plasticTons = allTickets.reduce((s, t) => s + (t.plastic_tons || 0), 0);
        const drywallTons = allTickets.reduce((s, t) => s + (t.drywall_tons || 0), 0);
        const ticketsWithPhotos = allTickets.filter(t => t.debris_photo_1 || t.debris_photo_2 || t.debris_photo_3 || t.scale_ticket_photo).length;
        const verifiedCount = allTickets.filter(t => t.human_verified).length;
        
        // Group by month
        const monthlyData = {};
        allTickets.forEach(t => {
            const key = t.service_date ? t.service_date.substring(0, 7) : 'Unknown';
            if (!monthlyData[key]) monthlyData[key] = { tickets: [], tons: 0, diverted: 0, landfill: 0 };
            monthlyData[key].tickets.push(t);
            monthlyData[key].tons += t.net_tons || 0;
            monthlyData[key].landfill += t.landfill_tons || 0;
            monthlyData[key].diverted += (t.net_tons || 0) - (t.landfill_tons || 0);
        });
        
        // Generate PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('portrait');
        const pw = doc.internal.pageSize.width;
        const ph = doc.internal.pageSize.height;
        let y = 15;
        let pageNum = 1;
        
        function addFooter() {
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(128);
            doc.text('DivertScan‚Ñ¢ LEED Audit Report | Generated ' + new Date().toLocaleString(), 14, ph - 8);
            doc.text('Page ' + pageNum, pw - 14, ph - 8, { align: 'right' });
            doc.setTextColor(0);
        }
        
        function checkPage(needed) {
            if (y + needed > ph - 20) {
                addFooter();
                doc.addPage();
                pageNum++;
                y = 15;
            }
        }
        
        // ===== PAGE 1: COVER =====
        doc.setFillColor(5, 150, 105);
        doc.rect(0, 0, pw, 50, 'F');
        doc.setTextColor(255);
        doc.setFontSize(24);
        doc.setFont('helvetica', 'bold');
        doc.text('LEED WASTE MANAGEMENT', pw/2, 22, { align: 'center' });
        doc.setFontSize(14);
        doc.text('AUDIT REPORT', pw/2, 32, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text('MRc5 Construction & Demolition Waste Diversion', pw/2, 42, { align: 'center' });
        
        doc.setTextColor(0);
        y = 65;
        
        // Project Info Box
        doc.setFillColor(245, 245, 245);
        doc.roundedRect(14, y, pw - 28, 50, 3, 3, 'F');
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(currentProject.name || 'Project', 20, y + 12);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('Address: ' + (currentProject.address || 'N/A'), 20, y + 20);
        doc.text('General Contractor: ' + (currentProject.general_contractor || currentProject.contractor || 'N/A'), 20, y + 27);
        doc.text('Waste Hauler: ' + (currentProject.waste_hauler || 'N/A'), 20, y + 34);
        doc.text('LEED Target: ' + (currentProject.leed_target || 75) + '% Diversion', 20, y + 41);
        doc.text('Report Date: ' + new Date().toLocaleDateString(), pw - 20, y + 12, { align: 'right' });
        doc.text('LEED Version: ' + (currentProject.leed_version || 'v4.1'), pw - 20, y + 20, { align: 'right' });
        y += 60;
        
        // Compliance Status
        const compliant = divRate >= (currentProject.leed_target || 75);
        doc.setFillColor(compliant ? 5 : 239, compliant ? 150 : 68, compliant ? 105 : 68);
        doc.roundedRect(14, y, pw - 28, 18, 3, 3, 'F');
        doc.setTextColor(255);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.text(compliant ? '‚úì LEED MRc5 COMPLIANT' : '‚úó BELOW LEED TARGET', pw/2, y + 12, { align: 'center' });
        doc.setTextColor(0);
        y += 28;
        
        // Summary Stats Grid
        const stats = [
            { label: 'Total Loads', value: allTickets.length.toString() },
            { label: 'Total Tonnage', value: totalTons.toFixed(2) + ' tons' },
            { label: 'Diverted', value: divertedTons.toFixed(2) + ' tons' },
            { label: 'Landfill', value: landfillTons.toFixed(2) + ' tons' },
            { label: 'Diversion Rate', value: divRate + '%' },
            { label: 'Verified Loads', value: verifiedCount + '/' + allTickets.length },
            { label: 'Photo Documentation', value: ticketsWithPhotos + ' loads' },
            { label: 'Date Range', value: (allTickets[0]?.service_date || 'N/A') + ' to ' + (allTickets[allTickets.length-1]?.service_date || 'N/A') }
        ];
        
        const colWidth = (pw - 28) / 4;
        stats.forEach((s, i) => {
            const col = i % 4;
            const row = Math.floor(i / 4);
            const sx = 14 + col * colWidth;
            const sy = y + row * 18;
            
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(sx + 1, sy, colWidth - 2, 16, 2, 2, 'F');
            doc.setFontSize(7);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100);
            doc.text(s.label, sx + colWidth/2, sy + 5, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);
            doc.text(s.value, sx + colWidth/2, sy + 12, { align: 'center' });
        });
        y += 44;
        
        // Material Breakdown Summary
        checkPage(50);
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.text('MATERIAL BREAKDOWN', 14, y);
        y += 8;
        
        const materials = [
            { name: 'Wood', tons: woodTons, color: [139, 69, 19] },
            { name: 'Metal', tons: metalTons, color: [112, 128, 144] },
            { name: 'Cardboard/OCC', tons: cardboardTons, color: [222, 184, 135] },
            { name: 'Concrete/Masonry', tons: concreteTons, color: [169, 169, 169] },
            { name: 'Plastic', tons: plasticTons, color: [65, 105, 225] },
            { name: 'Drywall', tons: drywallTons, color: [245, 245, 220] },
            { name: 'Landfill', tons: landfillTons, color: [47, 79, 79] }
        ].filter(m => m.tons > 0);
        
        materials.forEach(m => {
            const pct = totalTons > 0 ? (m.tons / totalTons * 100) : 0;
            const barWidth = pct * 1.2;
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(m.name, 14, y + 4);
            doc.text(m.tons.toFixed(2) + ' tons (' + pct.toFixed(1) + '%)', pw - 14, y + 4, { align: 'right' });
            
            // Bar
            doc.setFillColor(230, 230, 230);
            doc.roundedRect(60, y, 80, 5, 1, 1, 'F');
            doc.setFillColor(m.color[0], m.color[1], m.color[2]);
            if (barWidth > 0) doc.roundedRect(60, y, Math.min(barWidth, 80), 5, 1, 1, 'F');
            
            y += 9;
        });
        
        addFooter();
        
        // ===== PAGE 2+: DETAILED LOAD LOG =====
        doc.addPage('landscape');
        pageNum++;
        y = 15;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('DETAILED LOAD LOG', 14, y);
        y += 8;
        
        // Table headers
        const headers = ['#', 'Date', 'Ticket #', 'Net Tons', 'Wood', 'Metal', 'OCC', 'Plastic', 'Conc', 'Drywall', 'Landfill', 'Div %', 'Photos', 'Verified'];
        const cW = [8, 22, 22, 18, 16, 16, 16, 16, 16, 16, 16, 14, 14, 16];
        let cx = 14;
        
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setFillColor(5, 150, 105);
        doc.setTextColor(255);
        const hdrH = 7;
        headers.forEach((h, i) => {
            doc.rect(cx, y, cW[i], hdrH, 'F');
            doc.text(h, cx + 1, y + 5);
            cx += cW[i];
        });
        doc.setTextColor(0);
        y += hdrH;
        
        // Data rows
        doc.setFont('helvetica', 'normal');
        allTickets.forEach((t, idx) => {
            if (y > 185) {
                addFooter();
                doc.addPage('landscape');
                pageNum++;
                y = 15;
                cx = 14;
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setFillColor(5, 150, 105);
                doc.setTextColor(255);
                headers.forEach((h, i) => {
                    doc.rect(cx, y, cW[i], hdrH, 'F');
                    doc.text(h, cx + 1, y + 5);
                    cx += cW[i];
                });
                doc.setTextColor(0);
                y += hdrH;
                doc.setFont('helvetica', 'normal');
            }
            
            const photoCount = [t.debris_photo_1, t.debris_photo_2, t.debris_photo_3, t.scale_ticket_photo].filter(Boolean).length;
            const rowH = 5;
            const bg = idx % 2 === 0 ? [255, 255, 255] : [248, 250, 252];
            cx = 14;
            
            const rowData = [
                String(idx + 1),
                t.service_date ? new Date(t.service_date).toLocaleDateString('en-US', {month:'numeric',day:'numeric',year:'2-digit'}) : '',
                t.ticket_number || '',
                (t.net_tons || 0).toFixed(2),
                (t.wood_tons || 0) > 0 ? (t.wood_tons || 0).toFixed(2) : '-',
                (t.metal_tons || 0) > 0 ? (t.metal_tons || 0).toFixed(2) : '-',
                (t.cardboard_tons || 0) > 0 ? (t.cardboard_tons || 0).toFixed(2) : '-',
                (t.plastic_tons || 0) > 0 ? (t.plastic_tons || 0).toFixed(2) : '-',
                (t.concrete_tons || 0) > 0 ? (t.concrete_tons || 0).toFixed(2) : '-',
                (t.drywall_tons || 0) > 0 ? (t.drywall_tons || 0).toFixed(2) : '-',
                (t.landfill_tons || 0) > 0 ? (t.landfill_tons || 0).toFixed(2) : '-',
                (t.diversion_pct || 0) + '%',
                photoCount > 0 ? photoCount + ' üì∑' : '-',
                t.human_verified ? '‚úì' : '-'
            ];
            
            rowData.forEach((d, i) => {
                doc.setFillColor(bg[0], bg[1], bg[2]);
                doc.rect(cx, y, cW[i], rowH, 'FD');
                doc.setFontSize(6);
                doc.text(String(d), cx + 1, y + 3.5);
                cx += cW[i];
            });
            y += rowH;
        });
        
        // Totals row
        y += 2;
        cx = 14;
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(7);
        doc.setFillColor(5, 150, 105);
        doc.setTextColor(255);
        const totals = ['', 'TOTALS', allTickets.length + ' loads', totalTons.toFixed(2), woodTons.toFixed(2), metalTons.toFixed(2), cardboardTons.toFixed(2), plasticTons.toFixed(2), concreteTons.toFixed(2), drywallTons.toFixed(2), landfillTons.toFixed(2), divRate + '%', ticketsWithPhotos + ' üì∑', verifiedCount + '/' + allTickets.length];
        totals.forEach((d, i) => {
            doc.rect(cx, y, cW[i], 6, 'F');
            doc.text(String(d), cx + 1, y + 4);
            cx += cW[i];
        });
        doc.setTextColor(0);
        
        addFooter();
        
        // ===== MONTHLY SUMMARY PAGE =====
        doc.addPage('portrait');
        pageNum++;
        y = 15;
        
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('MONTHLY DIVERSION SUMMARY', 14, y);
        y += 10;
        
        Object.keys(monthlyData).sort().forEach(month => {
            checkPage(30);
            const md = monthlyData[month];
            const mRate = md.tons > 0 ? Math.round((md.diverted / md.tons) * 100) : 0;
            const monthLabel = new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            doc.setFillColor(248, 250, 252);
            doc.roundedRect(14, y, pw - 28, 22, 2, 2, 'F');
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text(monthLabel, 18, y + 8);
            
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(md.tickets.length + ' loads | ' + md.tons.toFixed(2) + ' total tons | ' + md.diverted.toFixed(2) + ' diverted | ' + md.landfill.toFixed(2) + ' landfill', 18, y + 16);
            
            // Rate badge
            doc.setFillColor(mRate >= 75 ? 5 : mRate >= 50 ? 245 : 239, mRate >= 75 ? 150 : mRate >= 50 ? 158 : 68, mRate >= 75 ? 105 : mRate >= 50 ? 11 : 68);
            doc.roundedRect(pw - 40, y + 3, 24, 16, 2, 2, 'F');
            doc.setTextColor(255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text(mRate + '%', pw - 28, y + 14, { align: 'center' });
            doc.setTextColor(0);
            
            y += 26;
        });
        
        // Photo Documentation Index
        checkPage(30);
        y += 10;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('PHOTO DOCUMENTATION INDEX', 14, y);
        y += 8;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        
        if (ticketsWithPhotos > 0) {
            doc.text(ticketsWithPhotos + ' of ' + allTickets.length + ' loads have photographic documentation on file.', 14, y);
            y += 6;
            doc.text('Photos include debris pile identification images and scale ticket scans.', 14, y);
            y += 6;
            doc.text('All photos are stored in the DivertScan‚Ñ¢ system and available for auditor review.', 14, y);
            y += 10;
            
            allTickets.filter(t => t.debris_photo_1 || t.scale_ticket_photo).forEach(t => {
                checkPage(8);
                const pCnt = [t.debris_photo_1, t.debris_photo_2, t.debris_photo_3].filter(Boolean).length;
                const hasST = t.scale_ticket_photo ? 'Yes' : 'No';
                doc.text('Ticket #' + (t.ticket_number || 'N/A') + ' (' + (t.service_date || '') + ') ‚Äî ' + pCnt + ' debris photo(s), Scale ticket: ' + hasST, 18, y);
                y += 5;
            });
        } else {
            doc.text('No photographic documentation available. Photos can be attached during ticket entry.', 14, y);
        }
        
        // Certification Statement
        checkPage(50);
        y += 10;
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text('CERTIFICATION', 14, y);
        y += 8;
        
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(14, y, pw - 28, 45, 3, 3, 'F');
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('I certify that this information is a true representation of materials processed by Dalmex Recycling LLC.', 20, y + 8);
        doc.text('All waste diversion data has been collected and verified through the DivertScan‚Ñ¢ waste tracking system', 20, y + 14);
        doc.text('with ' + verifiedCount + ' of ' + allTickets.length + ' loads verified by human inspection. SHA-256 hashes stored for each record.', 20, y + 20);
        y += 28;
        doc.text('Processing Facility: Dalmex Recycling LLC, 2828 Nagle St., Dallas, TX 75220', 20, y);
        y += 6;
        doc.text('Authorized Representative: _________________________________     Date: _____________', 20, y);
        
        addFooter();
        
        // Save
        const filename = 'LEED_Audit_Report_' + (currentProject.name || 'Project').replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
        doc.save(filename);
        
        hideLoading();
        toast('LEED Audit Report downloaded! (' + allTickets.length + ' loads, ' + (pageNum) + ' pages)', 'success');
        
    } catch (err) {
        hideLoading();
        console.error('Audit report error:', err);
        toast('Error: ' + err.message, 'error');
    }
}

// ========== CERTIFICATE OF DESTRUCTION ==========
function generateCertificateOfDestruction() {
    const customer = document.getElementById('codCustomerName').value.trim();
    const ticketNum = document.getElementById('codTicketNumber').value.trim();
    const serviceDate = document.getElementById('codServiceDate').value;
    const materialType = document.getElementById('codMaterialType').value;
    const netWeight = parseFloat(document.getElementById('codNetWeight').value) || 0;
    const grossWeight = parseFloat(document.getElementById('codGrossWeight').value) || 0;
    const tareWeight = parseFloat(document.getElementById('codTareWeight').value) || 0;
    const method = document.getElementById('codMethod').value;
    const notes = document.getElementById('codNotes').value.trim();
    
    if (!customer) { toast('Customer name is required', 'error'); return; }
    if (!ticketNum) { toast('Ticket number is required', 'error'); return; }
    if (!netWeight) { toast('Net weight is required', 'error'); return; }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('portrait');
    const pw = doc.internal.pageSize.width;
    const ph = doc.internal.pageSize.height;
    const certNum = 'COD-' + ticketNum + '-' + Date.now().toString(36).toUpperCase().slice(-4);
    const dateStr = serviceDate ? new Date(serviceDate + 'T12:00:00').toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }) : new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
    const netTons = (netWeight / 2000).toFixed(3);
    
    // === DECORATIVE BORDER ===
    doc.setDrawColor(45, 90, 39); // DalMex green
    doc.setLineWidth(2);
    doc.rect(8, 8, pw - 16, ph - 16);
    doc.setLineWidth(0.5);
    doc.rect(11, 11, pw - 22, ph - 22);
    
    let y = 28;
    
    // === HEADER ===
    doc.setFillColor(45, 90, 39);
    doc.rect(14, y - 8, pw - 28, 22, 'F');
    doc.setTextColor(255);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('CERTIFICATE OF DESTRUCTION', pw / 2, y + 2, { align: 'center' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Secure Material Destruction & Recycling Verification', pw / 2, y + 10, { align: 'center' });
    doc.setTextColor(0);
    y += 24;
    
    // === CERTIFICATE NUMBER & DATE ===
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(14, y, pw - 28, 14, 2, 2, 'F');
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('Certificate No: ' + certNum, 20, y + 6);
    doc.text('Date Issued: ' + new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }), 20, y + 11);
    doc.text('Scale Ticket #: ' + ticketNum, pw - 20, y + 6, { align: 'right' });
    doc.text('Date of Service: ' + dateStr, pw - 20, y + 11, { align: 'right' });
    y += 22;
    
    // === FACILITY INFO ===
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(45, 90, 39);
    doc.text('PROCESSING FACILITY', 14, y);
    doc.setTextColor(0);
    y += 6;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('DalMex Recycling LLC', 14, y); y += 5;
    doc.text('2828 Nagle St., Dallas, TX 75220', 14, y); y += 5;
    doc.text('Phone: (214) 352-2000  |  Fax: (214) 352-2002', 14, y); y += 5;
    doc.text('Facility Type: Construction & Demolition Waste Processing / Recycling Center', 14, y);
    y += 12;
    
    // === CUSTOMER INFO ===
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(45, 90, 39);
    doc.text('CUSTOMER', 14, y);
    doc.setTextColor(0);
    y += 6;
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.text(customer, 14, y);
    y += 12;
    
    // === MATERIAL DETAILS TABLE ===
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(45, 90, 39);
    doc.text('MATERIAL DETAILS', 14, y);
    doc.setTextColor(0);
    y += 8;
    
    // Table
    const rows = [
        ['Material Type', materialType],
        ['Gross Weight', grossWeight > 0 ? grossWeight.toLocaleString() + ' lbs' : 'N/A'],
        ['Tare Weight', tareWeight > 0 ? tareWeight.toLocaleString() + ' lbs' : 'N/A'],
        ['Net Weight', netWeight.toLocaleString() + ' lbs (' + netTons + ' tons)'],
        ['Destruction Method', method]
    ];
    
    if (notes) rows.push(['Remarks', notes]);
    
    const labelW = 55;
    const valueW = pw - 28 - labelW;
    
    rows.forEach((row, i) => {
        const bg = i % 2 === 0 ? [248, 250, 252] : [255, 255, 255];
        doc.setFillColor(bg[0], bg[1], bg[2]);
        doc.rect(14, y, labelW, 8, 'F');
        doc.rect(14 + labelW, y, valueW, 8, 'F');
        doc.setDrawColor(200);
        doc.rect(14, y, labelW, 8);
        doc.rect(14 + labelW, y, valueW, 8);
        
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text(row[0], 17, y + 5.5);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text(row[1], 17 + labelW, y + 5.5);
        y += 8;
    });
    
    y += 10;
    
    // === CERTIFICATION STATEMENT ===
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(45, 90, 39);
    doc.text('CERTIFICATION STATEMENT', 14, y);
    doc.setTextColor(0);
    y += 8;
    
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const certText = [
        'This is to certify that the materials described above, received from ' + customer + ' on',
        dateStr + ' (Scale Ticket #' + ticketNum + '), have been processed and/or destroyed',
        'at our facility in accordance with applicable federal, state, and local regulations.',
        '',
        'The materials were: ' + method + '.',
        '',
        'DalMex Recycling LLC guarantees that the described materials have been rendered',
        'unrecoverable and/or recycled in a manner that prevents unauthorized access to any',
        'confidential information that may have been contained therein.',
        '',
        'This certificate is issued for the sole benefit of the named customer and may be',
        'used as proof of secure destruction for compliance and audit purposes.'
    ];
    
    certText.forEach(line => {
        doc.text(line, 14, y);
        y += line === '' ? 3 : 5;
    });
    
    y += 8;
    
    // === DOWNSTREAM FACILITY (for paper) ===
    if (materialType.includes('Paper') || materialType.includes('SOP') || materialType.includes('OCC') || materialType.includes('Cardboard') || materialType.includes('Confidential')) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(45, 90, 39);
        doc.text('END MARKET DESTINATION', 14, y);
        doc.setTextColor(0);
        y += 6;
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.text('Material is baled at DalMex Recycling and shipped to certified domestic paper mills', 14, y); y += 5;
        doc.text('including Georgia Pacific, Smurfit Westrock, and International Paper for final', 14, y); y += 5;
        doc.text('pulping and recycling. Chain of custody documentation is maintained.', 14, y);
        y += 12;
    }
    
    // === SIGNATURES ===
    doc.setDrawColor(0);
    doc.setLineWidth(0.3);
    
    // Left signature
    doc.line(14, y + 10, 90, y + 10);
    doc.setFontSize(8);
    doc.text('Authorized Representative ‚Äî DalMex Recycling LLC', 14, y + 15);
    doc.text('Date: _______________', 14, y + 20);
    
    // Right signature
    doc.line(pw / 2 + 10, y + 10, pw - 14, y + 10);
    doc.text('Customer Acknowledgment (optional)', pw / 2 + 10, y + 15);
    doc.text('Date: _______________', pw / 2 + 10, y + 20);
    
    // === FOOTER ===
    doc.setFontSize(7);
    doc.setTextColor(128);
    doc.text('This certificate was generated by DivertScan‚Ñ¢ Waste Tracking System | ' + new Date().toLocaleString(), pw / 2, ph - 14, { align: 'center' });
    doc.text('DalMex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', pw / 2, ph - 10, { align: 'center' });
    
    // === SAVE ===
    const filename = 'Certificate_of_Destruction_' + customer.replace(/[^a-z0-9]/gi, '_') + '_' + ticketNum + '_' + (serviceDate || new Date().toISOString().split('T')[0]) + '.pdf';
    doc.save(filename);
    
    toast('Certificate of Destruction generated for ' + customer, 'success');
}

// ========== TOGGLE SECTIONS ==========
function toggleSection(sectionId) {
    const content = document.getElementById(sectionId + 'Content');
    const arrow = document.getElementById(sectionId + 'Arrow');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.textContent = '‚ñ≤';
    } else {
        content.classList.add('hidden');
        arrow.textContent = '‚ñº';
    }
}

// ========== PROJECT SELECT (moved here) ==========
function selectProject(projectId) {
    currentProject = projects.find(p => p.id === projectId);
    if (currentProject) {
        localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
    }
    updateProjectDisplay();
    renderProjectsList();
    loadRecentTickets();
    updateStats();
    toast('Project selected: ' + (currentProject?.name || 'Unknown'), 'success');
}

// ========== IMPORT / EXPORT ==========
async function exportAllProjects() {
    showLoading('Exporting...');
    
    try {
        let projectsData = [];
        let ticketsData = [];
        
        // Get from local first
        try {
            projectsData = await getAllFromLocal('projects') || [];
            ticketsData = await getAllFromLocal('tickets') || [];
        } catch (e) { console.log('Local export error:', e); }
        
        // Try Supabase with timeout for additional data
        if (sb) {
            try {
                const tp = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
                const pRes = await Promise.race([sb.from('projects').select('*'), tp]);
                const tRes = await Promise.race([sb.from('tickets').select('*'), tp]);
                if (pRes?.data) {
                    pRes.data.forEach(p => { if (!projectsData.find(lp => lp.id === p.id)) projectsData.push(p); });
                }
                if (tRes?.data) {
                    tRes.data.forEach(t => { if (!ticketsData.find(lt => lt.ticket_number === t.ticket_number)) ticketsData.push(t); });
                }
            } catch (e) { console.log('Supabase export skipped:', e.message); }
        }
        
        const exportData = {
            exported_at: new Date().toISOString(),
            version: '7.4',
            projects: projectsData,
            tickets: ticketsData
        };
        
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `DivertScan_Export_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        hideLoading();
        toast(`Export complete! ${projectsData.length} projects, ${ticketsData.length} tickets`, 'success');
    } catch (err) {
        hideLoading();
        toast('Export error: ' + err.message, 'error');
    }
}

async function importProjects(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showLoading('Importing...');
    
    try {
        const text = await file.text();
        const data = JSON.parse(text);
        
        if (data.projects && Array.isArray(data.projects)) {
            for (const p of data.projects) {
                delete p.id; // Let Supabase assign new IDs
                await sb.from('projects').insert([p]);
            }
        }
        
        hideLoading();
        toast('Import complete! Refresh to see changes.', 'success');
        loadProjects();
    } catch (err) {
        hideLoading();
        toast('Import error: ' + err.message, 'error');
    }
    
    event.target.value = ''; // Reset file input
}

async function exportAllTickets() {
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    showLoading('Exporting tickets...');
    
    try {
        const { data } = await sb.from('tickets').select('*').eq('project_id', currentProject.id);
        
        // Create CSV
        const headers = ['Date', 'Ticket #', 'Hauler', 'Container', 'Gross Lbs', 'Tare Lbs', 'Net Tons',
                        'Wood %', 'Concrete %', 'Metal %', 'Cardboard %', 'Plastic %', 'Drywall %', 'Landfill %',
                        'Diversion %', 'Human Verified', 'GPS Lat', 'GPS Long'];
        
        const rows = (data || []).map(t => [
            t.service_date, t.ticket_number, t.hauler, t.container_size,
            t.gross_lbs, t.tare_lbs, t.net_tons,
            t.wood_pct, t.concrete_pct, t.metal_pct, t.cardboard_pct, t.plastic_pct, t.drywall_pct, t.landfill_pct,
            t.diversion_pct, t.human_verified ? 'Yes' : 'No', t.gps_latitude, t.gps_longitude
        ]);
        
        const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_Tickets_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        hideLoading();
        toast('Tickets exported!', 'success');
    } catch (err) {
        hideLoading();
        toast('Export error: ' + err.message, 'error');
    }
}

async function exportAuditPackage() {
    toast('Audit package export - Coming soon! For now, use PDF + CSV exports.', 'info');
}

function downloadReportExcel() {
    if (!reportData || reportData.length === 0) {
        toast('Generate a report first', 'error');
        return;
    }
    
    // Check if SheetJS is loaded
    if (typeof XLSX === 'undefined') {
        toast('Excel library not loaded. Using CSV instead.', 'warning');
        downloadReportCSV();
        return;
    }
    
    try {
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Calculate totals
        const totalTons = reportData.reduce((s, t) => s + (t.net_tons || 0), 0);
        const landfillTons = reportData.reduce((s, t) => s + (t.landfill_tons || 0), 0);
        const divertedTons = totalTons - landfillTons;
        const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        
        // ===== SUMMARY SHEET =====
        const summaryData = [
            ['LEED MRc5 WASTE DIVERSION REPORT'],
            [''],
            ['Project Information'],
            ['Project Name', currentProject.name || ''],
            ['Project Address', currentProject.address || ''],
            ['General Contractor', currentProject.general_contractor || ''],
            ['Waste Hauler', currentProject.waste_hauler || ''],
            ['Report Generated', new Date().toLocaleString()],
            [''],
            ['Diversion Summary'],
            ['Total Loads', reportData.length],
            ['Total Tonnage', totalTons.toFixed(2)],
            ['Diverted from Landfill', divertedTons.toFixed(2)],
            ['Sent to Landfill', landfillTons.toFixed(2)],
            ['Diversion Rate', diversionRate + '%'],
            ['LEED Target', (currentProject.leed_target || 75) + '%'],
            ['Status', diversionRate >= (currentProject.leed_target || 75) ? 'COMPLIANT' : 'BELOW TARGET'],
            [''],
            ['Material Breakdown (Tons)'],
            ['Wood/Lumber', reportData.reduce((s, t) => s + (t.wood_tons || 0), 0).toFixed(2)],
            ['Concrete/Masonry', reportData.reduce((s, t) => s + (t.concrete_tons || 0), 0).toFixed(2)],
            ['Metals', reportData.reduce((s, t) => s + (t.metal_tons || 0), 0).toFixed(2)],
            ['Cardboard/OCC', reportData.reduce((s, t) => s + (t.cardboard_tons || 0), 0).toFixed(2)],
            ['Plastics', reportData.reduce((s, t) => s + (t.plastic_tons || 0), 0).toFixed(2)],
            ['Drywall/Gypsum', reportData.reduce((s, t) => s + (t.drywall_tons || 0), 0).toFixed(2)],
            [''],
            ['Verified Facilities'],
            ['Wood', 'DalMex Recycling - Pallet Division'],
            ['Metal', 'Cyclone Metal Recycling'],
            ['Cardboard', 'Georgia Pacific / WestRock / GreenSide'],
            ['Plastic', 'Recycle USA']
        ];
        
        const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
        wsSummary['!cols'] = [{ wch: 25 }, { wch: 40 }];
        XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
        
        // ===== LOAD DETAILS SHEET =====
        const detailHeaders = [
            'Date', 'Ticket #', 'Hauler', 'Gross (lbs)', 'Tare (lbs)', 'Net (lbs)', 'Tons',
            'Wood %', 'Wood Tons', 'Concrete %', 'Concrete Tons', 'Metal %', 'Metal Tons',
            'Cardboard %', 'Cardboard Tons', 'Plastic %', 'Plastic Tons', 'Drywall %', 'Drywall Tons',
            'Landfill %', 'Landfill Tons', 'Diversion %', 'Verified'
        ];
        
        const detailRows = reportData.map(t => [
            t.service_date || '',
            t.ticket_number || '',
            t.hauler || '',
            t.gross_lbs || 0,
            t.tare_lbs || 0,
            t.net_lbs || 0,
            (t.net_tons || 0).toFixed(2),
            (t.wood_pct || 0),
            (t.wood_tons || 0).toFixed(2),
            (t.concrete_pct || 0),
            (t.concrete_tons || 0).toFixed(2),
            (t.metal_pct || 0),
            (t.metal_tons || 0).toFixed(2),
            (t.cardboard_pct || 0),
            (t.cardboard_tons || 0).toFixed(2),
            (t.plastic_pct || 0),
            (t.plastic_tons || 0).toFixed(2),
            (t.drywall_pct || 0),
            (t.drywall_tons || 0).toFixed(2),
            (t.landfill_pct || 0),
            (t.landfill_tons || 0).toFixed(2),
            (t.diversion_pct || 0) + '%',
            t.human_verified ? 'Yes' : 'No'
        ]);
        
        const wsDetails = XLSX.utils.aoa_to_sheet([detailHeaders, ...detailRows]);
        wsDetails['!cols'] = detailHeaders.map(() => ({ wch: 12 }));
        XLSX.utils.book_append_sheet(wb, wsDetails, 'Load Details');
        
        // ===== MATERIAL TOTALS SHEET =====
        const materialData = [
            ['Material', 'Tons', 'Percentage', 'Destination Facility', 'Verified'],
            ['Wood/Lumber', reportData.reduce((s, t) => s + (t.wood_tons || 0), 0).toFixed(2), '', 'DalMex Recycling - Pallet Division', 'Yes'],
            ['Concrete/Masonry', reportData.reduce((s, t) => s + (t.concrete_tons || 0), 0).toFixed(2), '', 'Licensed C&D Processor', 'Yes'],
            ['Metals', reportData.reduce((s, t) => s + (t.metal_tons || 0), 0).toFixed(2), '', 'Cyclone Metal Recycling', 'Yes'],
            ['Cardboard/OCC', reportData.reduce((s, t) => s + (t.cardboard_tons || 0), 0).toFixed(2), '', 'Georgia Pacific / WestRock', 'Yes'],
            ['Plastics', reportData.reduce((s, t) => s + (t.plastic_tons || 0), 0).toFixed(2), '', 'Recycle USA', 'Yes'],
            ['Drywall/Gypsum', reportData.reduce((s, t) => s + (t.drywall_tons || 0), 0).toFixed(2), '', 'Gypsum Recycler', 'Yes'],
            ['Landfill', landfillTons.toFixed(2), '', 'Municipal Landfill', 'N/A'],
            [''],
            ['TOTAL', totalTons.toFixed(2), '', '', ''],
            ['DIVERTED', divertedTons.toFixed(2), diversionRate + '%', '', '']
        ];
        
        // Calculate percentages
        materialData.forEach((row, i) => {
            if (i > 0 && i < 8 && totalTons > 0) {
                row[2] = Math.round((parseFloat(row[1]) / totalTons) * 100) + '%';
            }
        });
        
        const wsMaterials = XLSX.utils.aoa_to_sheet(materialData);
        wsMaterials['!cols'] = [{ wch: 18 }, { wch: 12 }, { wch: 12 }, { wch: 35 }, { wch: 10 }];
        XLSX.utils.book_append_sheet(wb, wsMaterials, 'Materials');
        
        // Download
        const filename = `LEED_Report_${currentProject.name || 'Project'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
        
        toast('Excel report downloaded!', 'success');
        
    } catch (err) {
        console.error('Excel export error:', err);
        toast('Excel export failed: ' + err.message, 'error');
    }
}

// ========== BOX TRACKER EXCEL REPORT ==========
function downloadBoxTrackerExcel() {
    // Works with or without prior generateReport - pulls data fresh
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    if (typeof XLSX === 'undefined') {
        toast('Excel library not loaded - refresh page', 'error');
        return;
    }

    // Use reportData if available, otherwise use tickets array
    let data = (reportData && reportData.length > 0) ? reportData : tickets;
    if (!data || data.length === 0) {
        toast('No ticket data available. Generate a report or load tickets first.', 'error');
        return;
    }

    try {
        // Group tickets by month
        const byMonth = {};
        data.forEach(t => {
            const d = t.service_date ? new Date(t.service_date) : new Date(t.created_at);
            const key = d.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            if (!byMonth[key]) byMonth[key] = [];
            byMonth[key].push(t);
        });

        // Sort months chronologically
        const sortedMonths = Object.keys(byMonth).sort((a, b) => new Date(a + ' 1') - new Date(b + ' 1'));

        const wb = XLSX.utils.book_new();

        sortedMonths.forEach(monthLabel => {
            const monthTickets = byMonth[monthLabel];
            monthTickets.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));

            // Build sheet data matching Ross's exact format
            const rows = [];

            // Header section (rows 1-7 in the array, will be rows 7-13 visually)
            rows.push([`Waste Diversion Report for ${monthLabel}`]);
            rows.push([`Company: ${currentProject.waste_hauler || 'Jaguar Waste Management'}`]);
            rows.push([`Location: ${currentProject.address || ''}`]);
            rows.push([`Project: ${currentProject.name || ''}`]);
            rows.push([`Report by: Dalmex Recycling`]);
            rows.push([`Contact: Robert Vandling`]);
            rows.push(['Email: robert@dalmexrecycling.com']);
            rows.push([]); // Blank row

            // Column headers
            const headers = ['Date','Ticket No','GWT (lbs)','GWT (NT)','Tare (lbs)','Tare (NT)',
                'Net (lbs)','Tons','Wood %','Wood','Gypsum %','Gypsum',
                'Plastic %','Plastic','OCC %','OCC','Metal %','Metal',
                'Concrete %','Concrete','Block %','Block','Total Diverted','Diverted %'];
            rows.push(headers);

            // Data rows
            const dataStartRow = rows.length + 1; // 1-indexed Excel row
            monthTickets.forEach(t => {
                const r = rows.length + 1; // Excel row number for this row
                const gross = t.gross_lbs || 0;
                const tare = t.tare_lbs || 0;
                const net = t.net_lbs || (gross - tare);
                const tons = t.net_tons || (net / 2000);

                // Material percentages (stored as 0-100 in DivertScan, Ross wants 0-1 decimals)
                const woodP = (t.wood_pct || 0) / 100;
                const gypsumP = (t.drywall_pct || 0) / 100;
                const plasticP = (t.plastic_pct || 0) / 100;
                const occP = (t.cardboard_pct || 0) / 100;
                const metalP = (t.metal_pct || 0) / 100;
                // Concrete in DivertScan may include block - split back out
                const concreteP = 0; // Most C&D debris doesn't split concrete/block
                const blockP = 0;
                const concreteCombinedP = (t.concrete_pct || 0) / 100;

                const woodT = tons * woodP;
                const gypsumT = tons * gypsumP;
                const plasticT = tons * plasticP;
                const occT = tons * occP;
                const metalT = tons * metalP;
                const concreteT = tons * concreteCombinedP;
                const blockT = 0;
                const totalDiv = woodT + gypsumT + plasticT + occT + metalT + concreteT + blockT;
                const divPct = tons > 0 ? totalDiv / tons : 0;

                rows.push([
                    t.service_date ? new Date(t.service_date) : '',
                    parseInt(t.ticket_number) || t.ticket_number || '',
                    gross, gross / 2000,
                    tare, tare / 2000,
                    net, tons,
                    woodP, woodT,
                    gypsumP, gypsumT,
                    plasticP, plasticT,
                    occP, occT,
                    metalP, metalT,
                    concreteCombinedP, concreteT,
                    0, blockT,
                    totalDiv, divPct
                ]);
            });

            const dataEndRow = rows.length; // Last data row (1-indexed)

            // Blank row then Totals
            rows.push([]);
            const totalsRowIdx = rows.length; // 0-indexed in array

            // Calculate totals
            let tGross=0,tTare=0,tNet=0,tTons=0,tWood=0,tGyp=0,tPlas=0,tOCC=0,tMet=0,tCon=0,tBlk=0,tDiv=0;
            monthTickets.forEach(t => {
                const gross = t.gross_lbs || 0;
                const tare = t.tare_lbs || 0;
                const net = t.net_lbs || (gross - tare);
                const tons = t.net_tons || (net / 2000);
                tGross += gross; tTare += tare; tNet += net; tTons += tons;
                tWood += tons * (t.wood_pct || 0) / 100;
                tGyp += tons * (t.drywall_pct || 0) / 100;
                tPlas += tons * (t.plastic_pct || 0) / 100;
                tOCC += tons * (t.cardboard_pct || 0) / 100;
                tMet += tons * (t.metal_pct || 0) / 100;
                tCon += tons * (t.concrete_pct || 0) / 100;
                tDiv += tons * ((t.wood_pct||0)+(t.drywall_pct||0)+(t.plastic_pct||0)+(t.cardboard_pct||0)+(t.metal_pct||0)+(t.concrete_pct||0)) / 100;
            });

            rows.push([
                'Totals', '',
                tGross, tGross/2000, tTare, tTare/2000, tNet, tTons,
                tTons > 0 ? tWood/tTons : 0, tWood,
                tTons > 0 ? tGyp/tTons : 0, tGyp,
                tTons > 0 ? tPlas/tTons : 0, tPlas,
                tTons > 0 ? tOCC/tTons : 0, tOCC,
                tTons > 0 ? tMet/tTons : 0, tMet,
                tTons > 0 ? tCon/tTons : 0, tCon,
                0, tBlk,
                tDiv, tTons > 0 ? tDiv/tTons : 0
            ]);

            // Summary section
            rows.push([]);
            rows.push(['Total  Tonnage', tTons]);
            rows.push(['Diverted from landfill', tDiv]);
            rows.push(['Recycled Material %', tTons > 0 ? tDiv/tTons : 0]);

            // Create sheet
            const ws = XLSX.utils.aoa_to_sheet(rows);

            // Apply number formats
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 9; R <= range.e.r; R++) { // Data rows start at array index 9
                for (let C = 0; C <= 23; C++) {
                    const addr = XLSX.utils.encode_cell({r: R, c: C});
                    if (!ws[addr]) continue;
                    if (C === 0 && ws[addr].v instanceof Date) ws[addr].z = 'm/d/yyyy';
                    else if (C === 2 || C === 4 || C === 6) ws[addr].z = '#,##0';
                    else if (C === 3 || C === 5 || C === 7) ws[addr].z = '0.00';
                    else if (C === 8 || C === 10 || C === 12 || C === 14 || C === 16 || C === 18 || C === 20 || C === 23) ws[addr].z = '0%';
                    else if (C === 9 || C === 11 || C === 13 || C === 15 || C === 17 || C === 19 || C === 21 || C === 22) ws[addr].z = '0.00';
                }
            }

            // Format summary row percentages
            const summaryPctRow = rows.length - 1;
            const summaryAddr = XLSX.utils.encode_cell({r: summaryPctRow, c: 1});
            if (ws[summaryAddr]) ws[summaryAddr].z = '0%';

            // Column widths
            ws['!cols'] = [
                {wch:12},{wch:10},{wch:12},{wch:10},{wch:12},{wch:10},{wch:12},{wch:8},
                {wch:8},{wch:8},{wch:10},{wch:10},{wch:10},{wch:10},{wch:8},{wch:8},
                {wch:8},{wch:8},{wch:12},{wch:10},{wch:8},{wch:8},{wch:14},{wch:12}
            ];

            // Truncate sheet name to 31 chars (Excel limit)
            const sheetName = monthLabel.length > 31 ? monthLabel.substring(0, 31) : monthLabel;
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });

        const filename = `BoxTracker_${currentProject.name || 'Project'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
        toast(`Box Tracker report downloaded! (${sortedMonths.length} monthly tabs)`, 'success');
    } catch (err) {
        console.error('Box Tracker export error:', err);
        toast('Box Tracker export failed: ' + err.message, 'error');
    }
}

// ========== DATA MANAGEMENT - BULK OPERATIONS ==========
let selectedTicketIds = new Set();
let allTicketsLoaded = false;

async function loadAllTickets() {
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    showLoading('Loading all tickets...');
    try {
        let remoteTickets = [];
        let localTickets = [];

        if (sb) {
            try {
                const sbPromise = sb.from('tickets').select('*')
                    .eq('project_id', currentProject.id)
                    .order('service_date', { ascending: false })
                    .limit(1000);
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 10000));
                const result = await Promise.race([sbPromise, timeoutPromise]);
                if (result && !result.error && result.data) remoteTickets = result.data;
            } catch (e) { console.log('Supabase load all skipped:', e.message); }
        }

        try {
            const allLocal = await getAllFromLocal('tickets') || [];
            localTickets = allLocal.filter(t => t.project_id === currentProject.id);
        } catch (e) { console.log('Local fetch error:', e.message); }

        const ticketMap = new Map();
        localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));

        tickets = Array.from(ticketMap.values());
        tickets.sort((a, b) => new Date(b.service_date || b.created_at) - new Date(a.service_date || a.created_at));
        allTicketsLoaded = true;
        selectedTicketIds.clear();

        hideLoading();
        renderRecentTickets();
        updateTicketCount();
        toast(`Loaded ${tickets.length} total tickets`, 'success');
    } catch (err) {
        hideLoading();
        toast('Error loading tickets: ' + err.message, 'error');
    }
}

function updateTicketCount() {
    const badge = document.getElementById('ticketCountBadge');
    if (badge) badge.textContent = tickets.length;
}

function toggleTicketSelect(ticketId, event) {
    if (event) event.stopPropagation();
    if (selectedTicketIds.has(ticketId)) {
        selectedTicketIds.delete(ticketId);
    } else {
        selectedTicketIds.add(ticketId);
    }
    updateBulkActionsBar();
    // Update checkbox visual
    const cb = document.getElementById('cb-' + ticketId);
    if (cb) cb.checked = selectedTicketIds.has(ticketId);
}

function selectAllTickets() {
    if (selectedTicketIds.size === tickets.length) {
        // Deselect all
        selectedTicketIds.clear();
        document.getElementById('selectAllBtn').textContent = 'Select All';
    } else {
        tickets.forEach(t => selectedTicketIds.add(t.id));
        document.getElementById('selectAllBtn').textContent = 'Deselect All';
    }
    updateBulkActionsBar();
    // Update all checkboxes
    tickets.forEach(t => {
        const cb = document.getElementById('cb-' + t.id);
        if (cb) cb.checked = selectedTicketIds.has(t.id);
    });
}

function updateBulkActionsBar() {
    const bar = document.getElementById('bulkActionsBar');
    const count = selectedTicketIds.size;
    document.getElementById('selectedCount').textContent = count;
    bar.style.display = count > 0 ? 'block' : 'none';
}

async function deleteSelectedTickets() {
    const count = selectedTicketIds.size;
    if (count === 0) return;
    if (!confirm(`Delete ${count} selected ticket${count > 1 ? 's' : ''}? This cannot be undone.`)) return;

    showLoading(`Deleting ${count} tickets...`);
    let deleted = 0;
    let failed = 0;

    for (const ticketId of selectedTicketIds) {
        try {
            // Delete from Supabase
            if (sb) {
                try {
                    await sb.from('tickets').delete().eq('id', ticketId);
                } catch (e) { /* may not exist remotely */ }
            }
            // Delete from local
            try {
                await deleteFromLocal('tickets', ticketId);
            } catch (e) { /* may not exist locally */ }
            deleted++;
        } catch (err) {
            console.error('Delete error:', ticketId, err);
            failed++;
        }
    }

    tickets = tickets.filter(t => !selectedTicketIds.has(t.id));
    selectedTicketIds.clear();

    hideLoading();
    renderRecentTickets();
    updateStats();
    updateTicketCount();
    updateBulkActionsBar();
    toast(`Deleted ${deleted} ticket${deleted !== 1 ? 's' : ''}${failed > 0 ? `, ${failed} failed` : ''}`, deleted > 0 ? 'success' : 'error');
}

async function confirmDeleteAllTickets() {
    if (!currentProject) return;
    const count = tickets.length;
    if (count === 0) {
        toast('No tickets to delete', 'info');
        return;
    }
    const projName = currentProject.name || 'this project';
    if (!confirm(`‚ö†Ô∏è DELETE ALL ${count} TICKETS for "${projName}"?\n\nThis will permanently remove all ticket data for this project. This cannot be undone.`)) return;
    if (!confirm(`Are you absolutely sure? Type-to-confirm: This will delete ${count} tickets.`)) return;

    showLoading(`Deleting all ${count} tickets...`);
    let deleted = 0;

    for (const t of tickets) {
        try {
            if (sb) {
                try { await sb.from('tickets').delete().eq('id', t.id); } catch(e) {}
            }
            try { await deleteFromLocal('tickets', t.id); } catch(e) {}
            deleted++;
        } catch (err) {
            console.error('Bulk delete error:', err);
        }
    }

    tickets = [];
    selectedTicketIds.clear();

    hideLoading();
    renderRecentTickets();
    updateStats();
    updateTicketCount();
    updateBulkActionsBar();
    toast(`Deleted ${deleted} tickets from "${projName}"`, 'success');
}

function filterTicketList() {
    const query = (document.getElementById('ticketSearchFilter')?.value || '').toLowerCase();
    document.querySelectorAll('.ticket-card-row').forEach(el => {
        const text = el.dataset.searchtext || '';
        el.style.display = text.includes(query) ? '' : 'none';
    });
}

function sortTicketList() {
    const order = document.getElementById('ticketSortOrder')?.value || 'date-desc';
    switch(order) {
        case 'date-desc': tickets.sort((a,b) => new Date(b.service_date||b.created_at) - new Date(a.service_date||a.created_at)); break;
        case 'date-asc': tickets.sort((a,b) => new Date(a.service_date||a.created_at) - new Date(b.service_date||b.created_at)); break;
        case 'ticket-asc': tickets.sort((a,b) => String(a.ticket_number||'').localeCompare(String(b.ticket_number||''), undefined, {numeric:true})); break;
        case 'tons-desc': tickets.sort((a,b) => (b.net_tons||0) - (a.net_tons||0)); break;
        case 'diversion-desc': tickets.sort((a,b) => (b.diversion_pct||0) - (a.diversion_pct||0)); break;
    }
    renderRecentTickets();
}

// ========== EXCEL IMPORT ==========
let pendingExcelWorkbook = null;
let pendingExcelFile = null;

function triggerExcelImport() {
    // Check if project is selected first
    if (!currentProject || !currentProject.id) {
        toast('Please select a project first from the Dashboard', 'warning');
        // Show project picker
        if (typeof showProjectPicker === 'function') {
            setTimeout(() => showProjectPicker(), 500);
        }
        return;
    }
    
    // Check if XLSX library loaded
    if (typeof XLSX === 'undefined') {
        toast('Excel library still loading... please wait', 'warning');
        return;
    }
    
    // Trigger file picker
    const input = document.getElementById('mainExcelImport');
    if (input) {
        input.click();
    } else {
        console.error('Excel import input not found');
        toast('Import button error - refresh page', 'error');
    }
}

async function importExcelTickets(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Import started for file:', file.name);
    
    if (!currentProject || !currentProject.id) {
        toast('Select a project first', 'error');
        event.target.value = '';
        return;
    }
    
    if (typeof XLSX === 'undefined') {
        toast('Excel library not loaded - refresh page', 'error');
        event.target.value = '';
        return;
    }
    
    showLoading('Reading Excel file...');
    
    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
        
        // Check if multiple sheets
        if (workbook.SheetNames.length > 1) {
            hideLoading();
            pendingExcelWorkbook = workbook;
            pendingExcelFile = file;
            showSheetSelector(workbook.SheetNames);
            event.target.value = '';
            return;
        }
        
        // Single sheet - import directly
        await processExcelSheet(workbook, workbook.SheetNames[0], file.name);
        
    } catch (err) {
        hideLoading();
        console.error('Excel import error:', err);
        toast('Import failed: ' + err.message, 'error');
    }
    
    event.target.value = '';
}

function showSheetSelector(sheetNames) {
    // Create modal for sheet selection
    let modal = document.getElementById('sheetSelectorModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'sheetSelectorModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width:400px">
                <div class="modal-header">
                    <div class="modal-title">üìó Select Tab to Import</div>
                    <button class="modal-close" onclick="closeSheetSelector()">√ó</button>
                </div>
                <div class="modal-body" id="sheetSelectorBody">
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    const body = document.getElementById('sheetSelectorBody');
    body.innerHTML = `
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">
            This Excel file has multiple tabs. Select which one to import:
        </p>
        <div style="display:flex;flex-direction:column;gap:8px">
            ${sheetNames.map((name, i) => `
                <button class="btn btn-secondary" onclick="importSelectedSheet(${i})" style="text-align:left;padding:12px 16px">
                    <div style="font-weight:600">üìÑ ${name}</div>
                    <div style="font-size:11px;color:var(--text-muted)">Tab ${i + 1} of ${sheetNames.length}</div>
                </button>
            `).join('')}
        </div>
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-color)">
            <button class="btn btn-primary" onclick="importAllSheets()" style="width:100%">
                üì• Import ALL Tabs (${sheetNames.length} total)
            </button>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeSheetSelector() {
    const modal = document.getElementById('sheetSelectorModal');
    if (modal) modal.classList.remove('active');
    pendingExcelWorkbook = null;
    pendingExcelFile = null;
}

async function importSelectedSheet(index) {
    if (!pendingExcelWorkbook) return;
    
    closeSheetSelector();
    showLoading('Importing selected tab...');
    
    const sheetName = pendingExcelWorkbook.SheetNames[index];
    await processExcelSheet(pendingExcelWorkbook, sheetName, pendingExcelFile?.name || 'excel');
    
    pendingExcelWorkbook = null;
    pendingExcelFile = null;
}

async function importAllSheets() {
    if (!pendingExcelWorkbook) return;
    
    closeSheetSelector();
    
    const workbook = pendingExcelWorkbook;
    const filename = pendingExcelFile?.name || 'excel';
    let totalImported = 0;
    let totalFailed = 0;
    
    for (let i = 0; i < workbook.SheetNames.length; i++) {
        showLoading(`Importing tab ${i + 1} of ${workbook.SheetNames.length}...`);
        const result = await processExcelSheet(workbook, workbook.SheetNames[i], filename, true);
        totalImported += result.imported;
        totalFailed += result.failed;
    }
    
    hideLoading();
    
    if (totalFailed > 0) {
        toast(`Imported ${totalImported} tickets total, ${totalFailed} failed`, 'warning');
    } else {
        toast(`Successfully imported ${totalImported} tickets from all tabs!`, 'success');
    }
    
    loadRecentTickets();
    updateStats();
    
    pendingExcelWorkbook = null;
    pendingExcelFile = null;
}

async function processExcelSheet(workbook, sheetName, filename, silent = false) {
    const sheet = workbook.Sheets[sheetName];
    const importLog = []; // On-screen debug log
    const logMsg = (msg) => { importLog.push(msg); console.log(msg); };
    
    // Convert to array of arrays - use raw:true to get actual values, not formatted strings
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: null });
    
    logMsg(`üìã Processing sheet "${sheetName}" with ${rows.length} rows`);
    
    // Find header row (contains "Ticket" or "Date")
    let headerRowIndex = -1;
    let headers = [];
    
    for (let i = 0; i < Math.min(20, rows.length); i++) {
        const row = rows[i];
        if (row && row.some(cell => {
            const str = String(cell || '').toLowerCase();
            return str.includes('ticket') || (str.includes('date') && !str.includes('divert'));
        })) {
            headerRowIndex = i;
            headers = row.map(h => String(h || '').toLowerCase().trim());
            break;
        }
    }
    
    if (headerRowIndex === -1) {
        logMsg(`‚ùå No header row found in "${sheetName}" - looked at first 20 rows`);
        logMsg('Row samples:');
        for (let i = 0; i < Math.min(5, rows.length); i++) {
            logMsg(`  Row ${i}: ${JSON.stringify((rows[i] || []).slice(0, 8))}`);
        }
        showImportDebugLog(importLog, sheetName);
        if (!silent) {
            hideLoading();
            toast(`No header row found in tab "${sheetName}"`, 'error');
        }
        return { imported: 0, failed: 0 };
    }
    
    logMsg(`‚úÖ Headers found at row ${headerRowIndex}: [${headers.join(', ')}]`);
    
    // Debug: Log the first data row to verify parsing
    if (rows[headerRowIndex + 1]) {
        logMsg(`üìä First data row: ${JSON.stringify(rows[headerRowIndex + 1].slice(0, 12))}`);
    }
    
    // Map column indices - more robust matching
    const findCol = (patterns) => {
        for (const pattern of patterns) {
            const idx = headers.findIndex(h => {
                if (typeof pattern === 'string') {
                    return h.includes(pattern);
                } else {
                    return pattern.test(h);
                }
            });
            if (idx >= 0) return idx;
        }
        return -1;
    };
    
    const colMap = {
        date: findCol(['date']),
        ticket: findCol(['ticket']),
        gross: findCol([/gwt.*lbs/, /gross.*lbs/, 'gwt (lbs)']),
        tare: findCol([/tare.*lbs/, 'tare (lbs)']),
        netLbs: findCol([/net.*lbs/, 'net (lbs)']),
        tons: findCol([/^tons$/, /net.*nt/]),
        woodPct: findCol(['wood %']),
        gypsumPct: findCol(['gypsum %']),
        plasticPct: findCol(['plastic %']),
        occPct: findCol(['occ %']),
        metalPct: findCol(['metal %']),
        concretePct: findCol(['concrete %']),
        blockPct: findCol(['block %']),
        divertedPct: findCol(['diverted %'])
    };
    
    // Log which columns matched vs fell back
    const matchedCols = Object.entries(colMap).filter(([k,v]) => v >= 0).map(([k,v]) => `${k}=${v}`);
    const missedCols = Object.entries(colMap).filter(([k,v]) => v < 0).map(([k]) => k);
    logMsg(`‚úÖ Matched columns: ${matchedCols.join(', ')}`);
    if (missedCols.length > 0) {
        logMsg(`‚ö†Ô∏è Unmatched columns (using fallback positions): ${missedCols.join(', ')}`);
    }
    
    // Fallback to position-based if header matching fails (HD Waste format)
    if (colMap.date === -1 && headers[0] === 'date') colMap.date = 0;
    if (colMap.ticket === -1 && headers[1]?.includes('ticket')) colMap.ticket = 1;
    if (colMap.gross === -1) colMap.gross = 2;
    if (colMap.tare === -1) colMap.tare = 4;
    if (colMap.netLbs === -1) colMap.netLbs = 6;
    if (colMap.tons === -1) colMap.tons = 7;
    if (colMap.woodPct === -1) colMap.woodPct = 8;
    if (colMap.gypsumPct === -1) colMap.gypsumPct = 10;
    if (colMap.plasticPct === -1) colMap.plasticPct = 12;
    if (colMap.occPct === -1) colMap.occPct = 14;
    if (colMap.metalPct === -1) colMap.metalPct = 16;
    if (colMap.concretePct === -1) colMap.concretePct = 18;
    if (colMap.blockPct === -1) colMap.blockPct = 20;
    if (colMap.divertedPct === -1) colMap.divertedPct = 23;
    
    logMsg(`üó∫Ô∏è Final column map: ${JSON.stringify(colMap)}`);
    
    // Detect percentage format from first data row
    // Check if percentages are stored as decimals (0.0-1.0) or whole numbers (0-100)
    let pctFormat = 'unknown';
    const firstDataRow = rows[headerRowIndex + 1];
    if (firstDataRow) {
        const pctCols = [colMap.woodPct, colMap.gypsumPct, colMap.plasticPct, colMap.occPct, 
                         colMap.metalPct, colMap.concretePct, colMap.blockPct];
        const pctValues = pctCols.map(c => c >= 0 ? parseFloat(firstDataRow[c]) : NaN).filter(v => !isNaN(v) && v > 0);
        
        if (pctValues.length > 0) {
            const maxPct = Math.max(...pctValues);
            const allSmall = pctValues.every(v => v <= 1.0);
            
            if (allSmall && maxPct <= 1.0) {
                pctFormat = 'decimal'; // Values like 0.85 = 85%
            } else {
                pctFormat = 'whole'; // Values like 85 = 85%
            }
            logMsg(`üìê Percentage format detected: ${pctFormat} (sample values: ${pctValues.map(v => v.toFixed(4)).join(', ')})`);
        } else {
            pctFormat = 'whole'; // Default assumption
            logMsg(`üìê No percentage values found in first row, assuming whole numbers`);
        }
    }
    
    // Smart percentage parser based on detected format
    const parsePercent = (val) => {
        if (val === null || val === undefined || val === '') return 0;
        const num = parseFloat(val);
        if (isNaN(num)) return 0;
        
        if (pctFormat === 'decimal') {
            // All values in this sheet are decimals (0.0 to 1.0)
            return Math.round(num * 100);
        } else {
            // Values are whole numbers (0 to 100)
            return Math.round(num);
        }
    };
    
    // Parse data rows
    const tickets = [];
    let skippedRows = 0;
    
    for (let i = headerRowIndex + 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;
        
        // Skip totals/summary rows
        const firstCell = String(row[0] || '').toLowerCase();
        if (firstCell.includes('total') || firstCell.includes('diverted') || firstCell.includes('recycled') || firstCell.includes('summary')) {
            skippedRows++;
            continue;
        }
        
        // Get values
        const dateVal = colMap.date >= 0 ? row[colMap.date] : null;
        const ticketNum = colMap.ticket >= 0 ? row[colMap.ticket] : null;
        
        // Skip if no date or ticket
        if (!dateVal && !ticketNum) {
            skippedRows++;
            continue;
        }
        
        // Parse date - handle Excel serial numbers, Date objects, and strings
        let serviceDate = '';
        if (dateVal) {
            if (dateVal instanceof Date) {
                serviceDate = dateVal.toISOString().split('T')[0];
            } else if (typeof dateVal === 'number') {
                // Excel serial date (days since 1900-01-01, with Excel's leap year bug)
                const excelEpoch = new Date(1899, 11, 30); // Dec 30, 1899
                let dayOffset = dateVal;
                // Excel incorrectly treats 1900 as a leap year - adjust for dates after Feb 28, 1900
                if (dateVal > 59) dayOffset -= 1;
                const jsDate = new Date(excelEpoch.getTime() + dayOffset * 86400000);
                serviceDate = jsDate.toISOString().split('T')[0];
            } else {
                const parsed = new Date(dateVal);
                if (!isNaN(parsed)) {
                    serviceDate = parsed.toISOString().split('T')[0];
                }
            }
        }
        
        // Parse weights
        const grossLbs = parseFloat(row[colMap.gross]) || 0;
        const tareLbs = parseFloat(row[colMap.tare]) || 0;
        const netLbs = parseFloat(row[colMap.netLbs]) || (grossLbs - tareLbs);
        const netTons = parseFloat(row[colMap.tons]) || (netLbs / 2000);
        
        // Parse percentages using detected format
        const woodPct = parsePercent(row[colMap.woodPct]);
        const gypsumPct = parsePercent(row[colMap.gypsumPct]); // Map to drywall
        const plasticPct = parsePercent(row[colMap.plasticPct]);
        const occPct = parsePercent(row[colMap.occPct]); // Map to cardboard
        const metalPct = parsePercent(row[colMap.metalPct]);
        const concretePct = parsePercent(row[colMap.concretePct]);
        const blockPct = parsePercent(row[colMap.blockPct]); // Add to concrete
        
        // Calculate landfill (remainder)
        const totalRecycled = woodPct + gypsumPct + plasticPct + occPct + metalPct + concretePct + blockPct;
        const landfillPct = Math.max(0, 100 - totalRecycled);
        const diversionPct = Math.min(100, totalRecycled);
        
        // Log first ticket for verification
        if (tickets.length === 0) {
            logMsg(`üé´ First ticket parsed: #${ticketNum}, Date: ${serviceDate}, Net: ${netTons.toFixed(2)}T`);
            logMsg(`   Materials: Wood ${woodPct}%, Gypsum ${gypsumPct}%, Plastic ${plasticPct}%, OCC ${occPct}%, Metal ${metalPct}%, Concrete ${concretePct}%, Block ${blockPct}%`);
            logMsg(`   Diversion: ${diversionPct}%, Landfill: ${landfillPct}%`);
        }
        
        // Create ticket record
        const ticket = {
            project_id: currentProject.id,
            ticket_number: String(ticketNum || ''),
            service_date: serviceDate || new Date().toISOString().split('T')[0],
            hauler: currentProject.waste_hauler || 'Imported',
            gross_lbs: grossLbs,
            tare_lbs: tareLbs,
            net_lbs: netLbs,
            net_tons: netTons,
            wood_pct: woodPct,
            concrete_pct: concretePct + blockPct, // Combine concrete + block
            metal_pct: metalPct,
            cardboard_pct: occPct, // OCC = cardboard
            plastic_pct: plasticPct,
            drywall_pct: gypsumPct, // Gypsum = drywall
            landfill_pct: landfillPct,
            wood_tons: (woodPct / 100) * netTons,
            concrete_tons: ((concretePct + blockPct) / 100) * netTons,
            metal_tons: (metalPct / 100) * netTons,
            cardboard_tons: (occPct / 100) * netTons,
            plastic_tons: (plasticPct / 100) * netTons,
            drywall_tons: (gypsumPct / 100) * netTons,
            landfill_tons: (landfillPct / 100) * netTons,
            diversion_pct: diversionPct,
            diverted_tons: (diversionPct / 100) * netTons,
            human_verified: false,
            imported: true,
            import_source: filename + ' [' + sheetName + ']',
            created_at: new Date().toISOString()
        };
        
        tickets.push(ticket);
    }
    
    logMsg(`‚úÖ Parsed ${tickets.length} tickets from "${sheetName}" (${skippedRows} rows skipped)`);
    
    if (tickets.length === 0) {
        logMsg(`‚ùå No ticket data found in tab "${sheetName}"`);
        showImportDebugLog(importLog, sheetName);
        if (!silent) {
            hideLoading();
            toast(`No ticket data found in tab "${sheetName}"`, 'warning');
        }
        return { imported: 0, failed: 0 };
    }
    
    // Confirm import (only if not silent/batch mode)
    if (!silent) {
        hideLoading();
        
        if (!confirm(`Found ${tickets.length} tickets in "${sheetName}".\n\nProject: ${currentProject.name}\n\nProceed with import?`)) {
            return { imported: 0, failed: 0 };
        }
        
        showLoading(`Importing ${tickets.length} tickets...`);
    }
    
    // Save to database
    let imported = 0;
    let failed = 0;
    
    for (const ticket of tickets) {
        try {
            // Generate unique ID for local storage
            const ticketWithId = { 
                ...ticket, 
                id: 'imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                synced: false 
            };
            
            // Always save locally first (IndexedDB)
            await saveToLocal('tickets', ticketWithId);
            
            // Try Supabase if configured (don't fail if it errors)
            if (sb) {
                try {
                    const { error } = await sb.from('tickets').insert([ticket]);
                    if (!error) {
                        ticketWithId.synced = true;
                        await saveToLocal('tickets', ticketWithId);
                    }
                } catch (sbErr) {
                    console.log('Supabase sync skipped:', sbErr.message);
                }
            }
            
            imported++;
        } catch (err) {
            console.error('Import error for ticket:', ticket.ticket_number, err);
            logMsg(`‚ùå Failed to save ticket #${ticket.ticket_number}: ${err.message}`);
            failed++;
        }
    }
    
    logMsg(`üíæ Saved: ${imported} imported, ${failed} failed`);
    
    // Always show the debug log
    showImportDebugLog(importLog, sheetName);
    
    if (!silent) {
        hideLoading();
        
        if (failed > 0) {
            toast(`Imported ${imported} tickets, ${failed} failed`, 'warning');
        } else {
            toast(`Successfully imported ${imported} tickets from "${sheetName}"!`, 'success');
        }
        
        // Refresh data
        loadRecentTickets();
        updateStats();
    }
    
    return { imported, failed };
}

// On-screen debug panel for import troubleshooting
function showImportDebugLog(logMessages, sheetName) {
    let panel = document.getElementById('importDebugPanel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'importDebugPanel';
        panel.style.cssText = 'position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#1a1a2e;border-top:2px solid #00d4ff;z-index:99999;font-family:monospace;font-size:11px;padding:12px;color:#e0e0e0;';
        document.body.appendChild(panel);
    }
    
    const timestamp = new Date().toLocaleTimeString();
    const header = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #333">
        <strong style="color:#00d4ff">üìä Import Log - "${sheetName}" @ ${timestamp}</strong>
        <button onclick="this.parentElement.parentElement.remove()" style="background:#ff4444;color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-size:11px">‚úï Close</button>
    </div>`;
    
    const lines = logMessages.map(msg => {
        let color = '#e0e0e0';
        if (msg.startsWith('‚úÖ')) color = '#4ade80';
        else if (msg.startsWith('‚ùå')) color = '#f87171';
        else if (msg.startsWith('‚ö†Ô∏è')) color = '#fbbf24';
        else if (msg.startsWith('üìã') || msg.startsWith('üó∫Ô∏è') || msg.startsWith('üìê')) color = '#60a5fa';
        else if (msg.startsWith('üé´')) color = '#c084fc';
        else if (msg.startsWith('üíæ')) color = '#34d399';
        return `<div style="color:${color};padding:2px 0;white-space:pre-wrap">${msg}</div>`;
    }).join('');
    
    panel.innerHTML = header + lines;
    panel.scrollTop = panel.scrollHeight;
}

// Export all projects to Excel
function exportProjectsExcel() {
    if (typeof XLSX === 'undefined') {
        toast('Excel library not loaded', 'error');
        return;
    }
    
    if (!projects || projects.length === 0) {
        toast('No projects to export', 'error');
        return;
    }
    
    try {
        const wb = XLSX.utils.book_new();
        
        // Projects sheet
        const projectData = [
            ['Project Name', 'Address', 'General Contractor', 'Waste Hauler', 'LEED Target', 'Access Code', 'Created']
        ];
        
        projects.forEach(p => {
            projectData.push([
                p.name || '',
                p.address || '',
                p.general_contractor || '',
                p.waste_hauler || '',
                (p.leed_target || 75) + '%',
                p.access_code || '',
                p.created_at || ''
            ]);
        });
        
        const wsProjects = XLSX.utils.aoa_to_sheet(projectData);
        wsProjects['!cols'] = [{ wch: 30 }, { wch: 35 }, { wch: 25 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 20 }];
        XLSX.utils.book_append_sheet(wb, wsProjects, 'Projects');
        
        // Download
        XLSX.writeFile(wb, `DivertScan_Projects_${new Date().toISOString().split('T')[0]}.xlsx`);
        toast('Projects exported to Excel!', 'success');
        
    } catch (err) {
        console.error('Export error:', err);
        toast('Export failed: ' + err.message, 'error');
    }
}

// Export projects to CSV
function exportProjectsCSV() {
    if (!projects || projects.length === 0) {
        toast('No projects to export', 'error');
        return;
    }
    
    const headers = ['Project Name', 'Address', 'General Contractor', 'Waste Hauler', 'LEED Target', 'Access Code'];
    const rows = projects.map(p => [
        p.name || '',
        p.address || '',
        p.general_contractor || '',
        p.waste_hauler || '',
        (p.leed_target || 75) + '%',
        p.access_code || ''
    ]);
    
    const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DivertScan_Projects_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    toast('Projects exported to CSV!', 'success');
}

// ========== LEED NEWS FEED ==========
async function refreshLeedNews() {
    const container = document.getElementById('leedNewsList');
    container.innerHTML = '<div style="padding:12px 0;color:var(--slate-400)">Loading news...</div>';
    
    // Curated LEED MRc5 news sources
    const newsItems = [
        {
            title: 'LEED v5 Beta Released',
            source: 'USGBC',
            date: '2025',
            summary: 'New circular economy credits with 200% weighted multipliers for reuse materials.',
            url: 'https://www.usgbc.org/leed/v5'
        },
        {
            title: 'C&D Waste Diversion Best Practices',
            source: 'EPA',
            summary: 'Updated guidelines for construction waste management and recycling.',
            url: 'https://www.epa.gov/smm/sustainable-management-construction-and-demolition-materials'
        },
        {
            title: 'MRc5 Documentation Requirements',
            source: 'USGBC',
            summary: 'Hauler receipts, material breakdowns, and diversion calculations required for LEED.',
            url: 'https://www.usgbc.org/credits/new-construction-core-and-shell-schools-new-construction-retail-new-construction-healthcare/v4'
        },
        {
            title: 'Texas C&D Recycling Facilities',
            source: 'TCEQ',
            summary: 'List of authorized C&D recycling and processing facilities in Texas.',
            url: 'https://www.tceq.texas.gov/permitting/waste_permits/msw_permits/msw-cd-facilities'
        },
        {
            title: 'Circular Economy in Construction',
            source: 'World Green Building Council',
            summary: 'Global trends in sustainable construction waste management.',
            url: 'https://worldgbc.org/circularity'
        }
    ];
    
    container.innerHTML = newsItems.map(item => `
        <div style="padding:12px 0;border-bottom:1px solid var(--slate-700)">
            <a href="${item.url}" target="_blank" style="color:var(--emerald-400);font-weight:600;text-decoration:none">
                ${item.title} ‚Üó
            </a>
            <div style="color:var(--slate-400);font-size:11px;margin-top:4px">${item.source}</div>
            <div style="color:var(--slate-300);margin-top:4px">${item.summary}</div>
        </div>
    `).join('');
}

// ========== AI EXECUTIVE SUMMARY ==========
let aiSummaryText = '';

async function generateAISummary() {
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add Anthropic API key in Settings', 'error');
        return;
    }
    
    showLoading('Generating AI Executive Summary...');
    
    try {
        // Get project data
        const { data: tickets } = await sb
            .from('tickets')
            .select('*')
            .eq('project_id', currentProject.id)
            .order('service_date', { ascending: true });
        
        if (!tickets || tickets.length === 0) {
            hideLoading();
            toast('No tickets found for this project', 'error');
            return;
        }
        
        // Calculate stats
        const totalTons = tickets.reduce((s, t) => s + (t.net_tons || 0), 0);
        const landfillTons = tickets.reduce((s, t) => s + (t.landfill_tons || 0), 0);
        const divertedTons = totalTons - landfillTons;
        const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        
        // Material breakdown
        const woodTons = tickets.reduce((s, t) => s + (t.wood_tons || 0), 0);
        const concreteTons = tickets.reduce((s, t) => s + (t.concrete_tons || 0), 0);
        const metalTons = tickets.reduce((s, t) => s + (t.metal_tons || 0), 0);
        const cardboardTons = tickets.reduce((s, t) => s + (t.cardboard_tons || 0), 0);
        
        const prompt = `You are a professional environmental consultant writing an executive summary for a LEED MRc5 Construction & Demolition Waste Management report.

PROJECT DATA:
- Project: ${currentProject.name}
- Location: ${currentProject.address || 'Not specified'}
- General Contractor: ${currentProject.general_contractor || 'Not specified'}
- Waste Hauler: ${currentProject.waste_hauler || 'Not specified'}
- Total Loads: ${tickets.length}
- Date Range: ${tickets[0]?.service_date || 'N/A'} to ${tickets[tickets.length-1]?.service_date || 'N/A'}

WASTE SUMMARY:
- Total Waste Generated: ${totalTons.toFixed(2)} tons
- Diverted from Landfill: ${divertedTons.toFixed(2)} tons (${diversionRate}%)
- Sent to Landfill: ${landfillTons.toFixed(2)} tons

MATERIAL BREAKDOWN:
- Wood/Lumber: ${woodTons.toFixed(2)} tons
- Concrete/Masonry: ${concreteTons.toFixed(2)} tons
- Metals: ${metalTons.toFixed(2)} tons
- Cardboard: ${cardboardTons.toFixed(2)} tons

LEED TARGET: ${currentProject.leed_target || 75}%
STATUS: ${diversionRate >= (currentProject.leed_target || 75) ? 'COMPLIANT' : 'BELOW TARGET'}

Write a professional 2-3 paragraph executive summary suitable for LEED certification submission. Include:
1. Overview of waste management achievement
2. Key materials diverted and recycling partners utilized
3. Environmental impact statement (CO2 equivalent saved)
4. Compliance statement

Use professional, formal language. Be specific with numbers. Do not use bullet points.`;

        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 1024,
                messages: [{ role: 'user', content: prompt }]
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            toast('API Error: ' + data.error.message, 'error');
            return;
        }
        
        aiSummaryText = data.content[0].text;
        
        // Display the summary
        const container = document.getElementById('aiSummaryResult');
        container.innerHTML = `
            <div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">‚ú® Executive Summary</div>
            <div style="white-space:pre-wrap">${aiSummaryText}</div>
            <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn btn-secondary" onclick="copyAISummary()" style="flex:1;padding:8px">üìã Copy</button>
                <button class="btn btn-secondary" onclick="editAISummary()" style="flex:1;padding:8px">‚úèÔ∏è Edit</button>
            </div>
        `;
        container.classList.remove('hidden');
        document.getElementById('aiSummaryActions').classList.remove('hidden');
        
        toast('AI Summary generated!', 'success');
        
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

function copyAISummary() {
    navigator.clipboard.writeText(aiSummaryText).then(() => {
        toast('Summary copied to clipboard!', 'success');
    });
}

function editAISummary() {
    const container = document.getElementById('aiSummaryResult');
    container.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">‚úèÔ∏è Edit Summary</div>
        <textarea id="aiSummaryEdit" style="width:100%;height:200px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;padding:12px;color:var(--slate-200);font-size:12px;line-height:1.6">${aiSummaryText}</textarea>
        <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-primary" onclick="saveAISummary()" style="flex:1;padding:8px">üíæ Save</button>
            <button class="btn btn-secondary" onclick="generateAISummary()" style="flex:1;padding:8px">üîÑ Regenerate</button>
        </div>
    `;
}

function saveAISummary() {
    aiSummaryText = document.getElementById('aiSummaryEdit').value;
    const container = document.getElementById('aiSummaryResult');
    container.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">‚ú® Executive Summary</div>
        <div style="white-space:pre-wrap">${aiSummaryText}</div>
        <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="copyAISummary()" style="flex:1;padding:8px">üìã Copy</button>
            <button class="btn btn-secondary" onclick="editAISummary()" style="flex:1;padding:8px">‚úèÔ∏è Edit</button>
        </div>
    `;
    toast('Summary saved!', 'success');
}

// ========== ENHANCED REPORT PREVIEW ==========

// Report Project Picker ‚Äî syncs report tab with a project even when navigating directly
function onReportProjectChange() {
    const sel = document.getElementById('reportProjectSelect');
    const indicator = document.getElementById('reportProjectIndicator');
    const pid = sel.value;
    
    if (!pid) {
        if (indicator) indicator.classList.remove('active');
        currentProject = null;
        return;
    }
    
    // Find project from local list or tickets' projects
    const allOpts = Array.from(sel.options);
    const match = allOpts.find(o => o.value === pid);
    
    // Set currentProject from existing projects array or build minimal object
    const existing = (window._allProjectsList || []).find(p => p.id === pid);
    if (existing) {
        currentProject = existing;
    } else {
        currentProject = { id: pid, name: match?.textContent || 'Unknown' };
    }
    
    if (indicator) indicator.classList.add('active');
    localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
    
    // Auto-generate report when project is selected
    generateReport();
}

// Populate report project dropdown (called from loadProjects and showTab)
function populateReportProjectDropdown() {
    const sel = document.getElementById('reportProjectSelect');
    if (!sel) return;
    
    const currentVal = sel.value || currentProject?.id || '';
    sel.innerHTML = '<option value="">‚Äî Select Project ‚Äî</option>';
    
    const projectList = window._allProjectsList || [];
    projectList.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.name || 'Unnamed Project';
        if (p.id === currentVal) opt.selected = true;
        sel.appendChild(opt);
    });
    
    // Auto-select current project
    if (currentProject?.id && !sel.value) {
        sel.value = currentProject.id;
    }
    
    const indicator = document.getElementById('reportProjectIndicator');
    if (indicator) {
        indicator.classList.toggle('active', !!sel.value);
    }
}

// AI Summary PDF Download
function downloadAISummaryPDF() {
    if (!aiSummaryText) {
        toast('Generate a summary first', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('portrait');
    const pw = doc.internal.pageSize.width;
    const ph = doc.internal.pageSize.height;
    let y = 15;
    
    // Header bar
    doc.setFillColor(45, 90, 39);
    doc.rect(0, 0, pw, 28, 'F');
    doc.setTextColor(255);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text('LEED MRc5 Executive Summary', pw / 2, 12, { align: 'center' });
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Generated by DivertScan‚Ñ¢ ‚Äî Dalmex Recycling LLC', pw / 2, 20, { align: 'center' });
    doc.setTextColor(0);
    y = 38;
    
    // Project info
    if (currentProject) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Project: ' + (currentProject.name || ''), 14, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text('Date: ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 14, y);
        y += 12;
    }
    
    // Body text - word wrap
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    const lines = doc.splitTextToSize(aiSummaryText, pw - 28);
    
    lines.forEach(line => {
        if (y > ph - 30) {
            doc.addPage();
            y = 15;
        }
        doc.text(line, 14, y);
        y += 5;
    });
    
    // Footer
    y += 10;
    doc.setDrawColor(45, 90, 39);
    doc.setLineWidth(0.5);
    doc.line(14, y, pw - 14, y);
    y += 6;
    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text('I certify that this information is a true representation of materials processed by Dalmex Recycling LLC.', 14, y);
    y += 5;
    doc.text('Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', 14, y);
    
    doc.save('DivertScan_AI_Executive_Summary_' + new Date().toISOString().split('T')[0] + '.pdf');
    toast('AI Summary PDF downloaded!', 'success');
}

// Report Signature Pad
let reportSigCanvas = null;
let reportSigCtx = null;
let reportSigDrawing = false;

function initReportSignaturePad() {
    reportSigCanvas = document.getElementById('reportSignatureCanvas');
    if (!reportSigCanvas) return;
    
    reportSigCtx = reportSigCanvas.getContext('2d');
    reportSigCtx.fillStyle = 'white';
    reportSigCtx.fillRect(0, 0, reportSigCanvas.width, reportSigCanvas.height);
    
    // Touch events for iPad
    reportSigCanvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        reportSigDrawing = true;
        const r = reportSigCanvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = (t.clientX - r.left) * (reportSigCanvas.width / r.width);
        const y = (t.clientY - r.top) * (reportSigCanvas.height / r.height);
        reportSigCtx.beginPath();
        reportSigCtx.moveTo(x, y);
    }, { passive: false });
    
    reportSigCanvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!reportSigDrawing) return;
        const r = reportSigCanvas.getBoundingClientRect();
        const t = e.touches[0];
        const x = (t.clientX - r.left) * (reportSigCanvas.width / r.width);
        const y = (t.clientY - r.top) * (reportSigCanvas.height / r.height);
        reportSigCtx.lineWidth = 2;
        reportSigCtx.lineCap = 'round';
        reportSigCtx.strokeStyle = 'black';
        reportSigCtx.lineTo(x, y);
        reportSigCtx.stroke();
        reportSigCtx.beginPath();
        reportSigCtx.moveTo(x, y);
    }, { passive: false });
    
    reportSigCanvas.addEventListener('touchend', () => { reportSigDrawing = false; });
    
    // Mouse events for desktop testing
    reportSigCanvas.addEventListener('mousedown', (e) => {
        reportSigDrawing = true;
        const r = reportSigCanvas.getBoundingClientRect();
        const x = (e.clientX - r.left) * (reportSigCanvas.width / r.width);
        const y = (e.clientY - r.top) * (reportSigCanvas.height / r.height);
        reportSigCtx.beginPath();
        reportSigCtx.moveTo(x, y);
    });
    reportSigCanvas.addEventListener('mousemove', (e) => {
        if (!reportSigDrawing) return;
        const r = reportSigCanvas.getBoundingClientRect();
        const x = (e.clientX - r.left) * (reportSigCanvas.width / r.width);
        const y = (e.clientY - r.top) * (reportSigCanvas.height / r.height);
        reportSigCtx.lineWidth = 2;
        reportSigCtx.lineCap = 'round';
        reportSigCtx.strokeStyle = 'black';
        reportSigCtx.lineTo(x, y);
        reportSigCtx.stroke();
        reportSigCtx.beginPath();
        reportSigCtx.moveTo(x, y);
    });
    reportSigCanvas.addEventListener('mouseup', () => { reportSigDrawing = false; });
}

function clearReportSignature() {
    if (reportSigCanvas && reportSigCtx) {
        reportSigCtx.fillStyle = 'white';
        reportSigCtx.fillRect(0, 0, reportSigCanvas.width, reportSigCanvas.height);
    }
}

function saveReportSignature() {
    if (!reportSigCanvas) { toast('Signature pad not ready', 'error'); return; }
    var imgd = reportSigCtx.getImageData(0, 0, reportSigCanvas.width, reportSigCanvas.height);
    var hasSig = false;
    for (var i = 0; i < imgd.data.length; i += 4) { if (imgd.data[i] < 250) { hasSig = true; break; } }
    if (!hasSig) { toast('Please sign before saving', 'error'); return; }
    localStorage.setItem('divertscan_report_signature', reportSigCanvas.toDataURL('image/png'));
    localStorage.setItem('divertscan_report_sig_date', new Date().toISOString());
    toast('Signature saved!', 'success');
}

function printSignedReport() {
    if (!reportData || reportData.length === 0) { toast('Generate a report first', 'error'); return; }
    var sigImg = '';
    if (reportSigCanvas && reportSigCtx) {
        var id2 = reportSigCtx.getImageData(0, 0, reportSigCanvas.width, reportSigCanvas.height);
        for (var j = 0; j < id2.data.length; j += 4) { if (id2.data[j] < 250) { sigImg = reportSigCanvas.toDataURL('image/png'); break; } }
    }
    if (!sigImg) sigImg = localStorage.getItem('divertscan_report_signature') || '';
    var totalT = 0, lfT = 0;
    reportData.forEach(function(t) { totalT += t.net_tons || 0; lfT += t.landfill_tons || 0; });
    var divT = totalT - lfT;
    var divR = totalT > 0 ? Math.round((divT / totalT) * 100) : 0;
    var rows = reportData.map(function(t) {
        return '<tr><td>' + formatDate(t.service_date) + '</td><td>' + (t.ticket_number || '-') + '</td><td>' + (t.hauler || '-') + '</td><td style="text-align:right">' + (t.gross_lbs || 0).toLocaleString() + '</td><td style="text-align:right">' + (t.tare_lbs || 0).toLocaleString() + '</td><td style="text-align:right;font-weight:700">' + (t.net_tons || 0).toFixed(2) + '</td><td style="text-align:right;color:' + ((t.diversion_pct || 0) >= 75 ? '#2ecc71' : '#e67e22') + '">' + (t.diversion_pct || 0) + '%</td><td style="text-align:center">' + (t.human_verified ? '‚úÖ' : '‚ùå') + '</td></tr>';
    }).join('');
    var sigHtml = sigImg ? '<div style="margin-top:20px"><p style="font-size:11px;color:#666">Authorized Signature:</p><img src="' + sigImg + '" style="max-width:300px;height:60px;border-bottom:1px solid #333"></div>' : '<div style="margin-top:30px;border-bottom:1px solid #333;width:300px"></div><p style="font-size:10px;color:#666">Authorized Signature</p>';
    var w = window.open('', '_blank');
    w.document.write('<!DOCTYPE html><html><head><title>DivertScan Report</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;color:#1a1a1a;font-size:12px}.hdr{background:#2d5a27;color:white;padding:16px;text-align:center;border-radius:4px}.hdr h1{margin:0;font-size:18px}.hdr p{margin:2px 0 0;opacity:0.8;font-size:11px}table{width:100%;border-collapse:collapse;margin:16px 0}th{background:#f0f0f0;padding:6px 8px;text-align:left;font-size:10px;text-transform:uppercase;border-bottom:2px solid #2d5a27}td{padding:6px 8px;border-bottom:1px solid #ddd}tfoot td{font-weight:700;border-top:2px solid #2d5a27}.stats{display:flex;gap:16px;margin:16px 0}.stat{flex:1;background:#f8f8f8;padding:12px;text-align:center;border-radius:4px;border-left:3px solid #2d5a27}.stat .v{font-size:22px;font-weight:700}.stat .l{font-size:9px;color:#666;text-transform:uppercase}.cert{border:2px solid #2d5a27;padding:16px;border-radius:4px;margin-top:20px}@media print{body{padding:10px}.hdr{-webkit-print-color-adjust:exact;print-color-adjust:exact}}</style></head><body><div class="hdr"><h1>Construction &amp; Demolition Waste Management Report</h1><p>LEED v4.1/v5 MRc5 Documentation ‚Äî DivertScan‚Ñ¢ by Dalmex Recycling LLC</p></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0;font-size:12px"><div><strong>Project:</strong> ' + (currentProject ? currentProject.name : '-') + '</div><div><strong>Report Date:</strong> ' + new Date().toLocaleDateString() + '</div><div><strong>Address:</strong> ' + (currentProject ? (currentProject.address || '-') : '-') + '</div><div><strong>Hauler:</strong> ' + (currentProject ? (currentProject.waste_hauler || '-') : '-') + '</div></div><div class="stats"><div class="stat"><div class="v" style="color:#2d5a27">' + divR + '%</div><div class="l">Diversion Rate</div></div><div class="stat"><div class="v">' + totalT.toFixed(2) + '</div><div class="l">Total Tons</div></div><div class="stat"><div class="v" style="color:#2d5a27">' + divT.toFixed(2) + '</div><div class="l">Diverted</div></div><div class="stat"><div class="v" style="color:#c0392b">' + lfT.toFixed(2) + '</div><div class="l">Landfill</div></div></div><table><thead><tr><th>Date</th><th>Ticket #</th><th>Hauler</th><th style="text-align:right">Gross</th><th style="text-align:right">Tare</th><th style="text-align:right">Net (T)</th><th style="text-align:right">Diversion</th><th style="text-align:center">Verified</th></tr></thead><tbody>' + rows + '</tbody><tfoot><tr><td colspan="5">TOTALS</td><td style="text-align:right">' + totalT.toFixed(2) + '</td><td style="text-align:right;color:#2d5a27">' + divR + '%</td><td style="text-align:center">' + reportData.filter(function(t){return t.human_verified}).length + '/' + reportData.length + '</td></tr></tfoot></table><div class="cert"><strong>‚úÖ Certification Statement</strong><p>I certify that this information is a true representation of materials processed by Dalmex Recycling LLC. All waste materials have been tracked from point of generation through processing and final disposition.</p>' + sigHtml + '<p style="font-size:10px;color:#666;margin-top:12px">Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000</p><p style="font-size:10px;color:#666">Generated: ' + new Date().toLocaleString() + '</p></div></body></html>');
    w.document.close();
    setTimeout(function() { w.print(); }, 600);
}

// Add New Facility Modal (was missing ‚Äî button existed but function didn't)
function showAddFacilityModal() {
    const modal = document.createElement('div');
    modal.id = 'addFacilityModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    
    modal.innerHTML = '<div style="background:var(--bg-secondary);border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto">' +
        '<div style="background:linear-gradient(135deg,#2d5a27,#1a3d15);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">' +
            '<div style="font-size:16px;font-weight:700;color:white">‚ûï Add New Facility</div>' +
            '<button onclick="document.getElementById(\'addFacilityModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">√ó</button>' +
        '</div>' +
        '<div style="padding:20px">' +
            '<div class="form-group">' +
                '<label class="form-label">Facility Name *</label>' +
                '<input type="text" id="newFacilityName" class="form-input" placeholder="e.g., ABC Concrete Recycling">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Material Type</label>' +
                '<select id="newFacilityMaterial" class="form-input">' +
                    '<option value="concrete">üß± Concrete / Masonry</option>' +
                    '<option value="metal">üî© Metal / Scrap</option>' +
                    '<option value="wood">ü™µ Wood / Pallets</option>' +
                    '<option value="cardboard">üì¶ Cardboard / Paper</option>' +
                    '<option value="drywall">üèóÔ∏è Drywall / Gypsum</option>' +
                    '<option value="plastic">‚ôªÔ∏è Plastic</option>' +
                    '<option value="mixed">üîÑ Mixed C&amp;D</option>' +
                '</select>' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Address</label>' +
                '<input type="text" id="newFacilityAddress" class="form-input" placeholder="Street, City, State ZIP">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Contact / Phone</label>' +
                '<input type="text" id="newFacilityContact" class="form-input" placeholder="(xxx) xxx-xxxx">' +
            '</div>' +
            '<div class="form-group">' +
                '<label class="form-label">Notes</label>' +
                '<textarea id="newFacilityNotes" class="form-input" rows="2" placeholder="RCI certified, accepts loads Mon-Sat, etc."></textarea>' +
            '</div>' +
        '</div>' +
        '<div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">' +
            '<button class="btn btn-secondary" onclick="document.getElementById(\'addFacilityModal\').remove()" style="flex:1">Cancel</button>' +
            '<button class="btn btn-primary" onclick="saveNewFacility()" style="flex:1">üíæ Save Facility</button>' +
        '</div>' +
    '</div>';
    
    document.body.appendChild(modal);
}

function saveNewFacility() {
    const name = document.getElementById('newFacilityName')?.value?.trim();
    if (!name) {
        toast('Facility name is required', 'error');
        return;
    }
    
    const facility = {
        id: 'facility_' + Date.now(),
        name: name,
        material: document.getElementById('newFacilityMaterial')?.value || 'mixed',
        address: document.getElementById('newFacilityAddress')?.value?.trim() || '',
        contact: document.getElementById('newFacilityContact')?.value?.trim() || '',
        notes: document.getElementById('newFacilityNotes')?.value?.trim() || '',
        created_at: new Date().toISOString()
    };
    
    // Save to local storage
    const facilities = JSON.parse(localStorage.getItem('divertscan_facilities') || '[]');
    facilities.push(facility);
    localStorage.setItem('divertscan_facilities', JSON.stringify(facilities));
    
    document.getElementById('addFacilityModal').remove();
    toast('Facility "' + name + '" added!', 'success');
}

function previewReportPDF() {
    // Open report in new window for preview
    const reportHtml = generateReportHTML();
    const win = window.open('', '_blank');
    win.document.write(reportHtml);
    win.document.close();
}

function generateReportHTML() {
    if (!currentProject || !reportData || reportData.length === 0) {
        return '<html><body><h1>No data to display</h1></body></html>';
    }
    
    // Calculate totals
    const totalTons = reportData.reduce((s, t) => s + (t.net_tons || 0), 0);
    const landfillTons = reportData.reduce((s, t) => s + (t.landfill_tons || 0), 0);
    const divertedTons = totalTons - landfillTons;
    const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
    
    const woodTons = reportData.reduce((s, t) => s + (t.wood_tons || 0), 0);
    const concreteTons = reportData.reduce((s, t) => s + (t.concrete_tons || 0), 0);
    const metalTons = reportData.reduce((s, t) => s + (t.metal_tons || 0), 0);
    const cardboardTons = reportData.reduce((s, t) => s + (t.cardboard_tons || 0), 0);
    const plasticTons = reportData.reduce((s, t) => s + (t.plastic_tons || 0), 0);
    const drywallTons = reportData.reduce((s, t) => s + (t.drywall_tons || 0), 0);
    
    const includeBranding = document.getElementById('includeDalMexBranding')?.checked !== false;
    const includeCert = document.getElementById('includeCertification')?.checked !== false;
    const includeAI = document.getElementById('includeAISummary')?.checked !== false;
    
    return `
<!DOCTYPE html>
<html>
<head>
<title>LEED MRc5 Report - ${currentProject.name}</title>
<style>
body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #333; }
.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #2d5a27; padding-bottom: 20px; margin-bottom: 30px; }
.company { color: #2d5a27; }
.company h1 { font-size: 24px; margin: 0; }
.company p { font-size: 12px; margin: 5px 0 0; color: #666; }
.report-title { text-align: right; }
.report-title h2 { font-size: 18px; margin: 0; color: #333; }
.report-title p { font-size: 11px; color: #666; margin: 5px 0 0; }
h3 { color: #2d5a27; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 30px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background: #f5f5f5; font-weight: 600; }
.highlight { background: #e8f5e9; }
.summary-box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
.summary-box h4 { margin: 0 0 10px; color: #2d5a27; }
.big-number { font-size: 36px; font-weight: bold; color: #2d5a27; }
.certification { border: 2px solid #2d5a27; padding: 20px; margin-top: 30px; }
.certification h4 { color: #2d5a27; margin: 0 0 10px; }
.signature-line { border-top: 1px solid #333; width: 250px; margin-top: 40px; padding-top: 5px; font-size: 11px; }
.ai-summary { background: #f0fdf4; border-left: 4px solid #2d5a27; padding: 15px; margin: 20px 0; font-size: 12px; line-height: 1.6; }
.footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666; text-align: center; }
@media print { body { padding: 20px; } }
</style>
</head>
<body>

${includeBranding ? `
<div class="header">
<div class="company">
<h1>${companyInfo.name}</h1>
<p>${companyInfo.address}<br>${companyInfo.phone}</p>
</div>
<div class="report-title">
<h2>C&D Waste Diversion Report</h2>
<p>LEED MRc5 Documentation<br>Generated: ${new Date().toLocaleDateString()}</p>
</div>
</div>
` : ''}

<h3>Project Information</h3>
<table>
<tr><td width="30%"><strong>Project Name</strong></td><td>${currentProject.name}</td></tr>
<tr><td><strong>Address</strong></td><td>${currentProject.address || 'N/A'}</td></tr>
<tr><td><strong>General Contractor</strong></td><td>${currentProject.general_contractor || 'N/A'}</td></tr>
<tr><td><strong>Waste Hauler</strong></td><td>${currentProject.waste_hauler || 'N/A'}</td></tr>
<tr><td><strong>Report Period</strong></td><td>${reportData[0]?.service_date || 'N/A'} to ${reportData[reportData.length-1]?.service_date || 'N/A'}</td></tr>
</table>

<div class="summary-box">
<h4>Diversion Summary</h4>
<div style="display:flex;justify-content:space-around;text-align:center">
<div><div class="big-number">${totalTons.toFixed(1)}</div><div>Total Tons</div></div>
<div><div class="big-number" style="color:${diversionRate >= 75 ? '#2d5a27' : '#f59e0b'}">${diversionRate}%</div><div>Diversion Rate</div></div>
<div><div class="big-number">${reportData.length}</div><div>Total Loads</div></div>
</div>
</div>

${includeAI && aiSummaryText ? `
<h3>Executive Summary</h3>
<div class="ai-summary">${aiSummaryText}</div>
` : ''}

<h3>Material Breakdown & Verified Destinations</h3>
<table>
<tr><th>Material</th><th>Tons</th><th>%</th><th>Destination Facility</th><th>Verification</th></tr>
<tr><td>Wood/Lumber</td><td>${woodTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(woodTons/totalTons*100) : 0}%</td><td>DalMex Recycling - Pallet Division</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr><td>Metals</td><td>${metalTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(metalTons/totalTons*100) : 0}%</td><td>Cyclone Metal Recycling</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr><td>Cardboard/OCC</td><td>${cardboardTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(cardboardTons/totalTons*100) : 0}%</td><td>Georgia Pacific / WestRock</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr><td>Concrete/Masonry</td><td>${concreteTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(concreteTons/totalTons*100) : 0}%</td><td>Licensed C&D Processor</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr><td>Plastics</td><td>${plasticTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(plasticTons/totalTons*100) : 0}%</td><td>Recycle USA</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr><td>Drywall/Gypsum</td><td>${drywallTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(drywallTons/totalTons*100) : 0}%</td><td>Gypsum Recycler</td><td style="color:#2d5a27">‚úì Verified</td></tr>
<tr class="highlight"><td><strong>Total Diverted</strong></td><td><strong>${divertedTons.toFixed(2)}</strong></td><td><strong>${diversionRate}%</strong></td><td colspan="2"><strong>All facilities verified</strong></td></tr>
<tr style="background:#fff5f5"><td>Landfill</td><td>${landfillTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(landfillTons/totalTons*100) : 0}%</td><td>Municipal Landfill</td><td>N/A</td></tr>
</table>

<h3>Recycling Facility Certifications</h3>
<table>
<tr><th>Facility</th><th>Type</th><th>Materials Accepted</th><th>License Status</th></tr>
<tr><td>DalMex Recycling - Pallet Division</td><td>Wood Recycler</td><td>Wood, Lumber, Pallets</td><td style="color:#2d5a27">‚úì Active - TX Licensed</td></tr>
<tr><td>Cyclone Metal Recycling</td><td>Scrap Metal</td><td>Steel, Aluminum, Copper</td><td style="color:#2d5a27">‚úì Active - TX Licensed</td></tr>
<tr><td>Georgia Pacific</td><td>Paper Mill</td><td>Cardboard, OCC</td><td style="color:#2d5a27">‚úì Active - National</td></tr>
<tr><td>Smurfit WestRock</td><td>Paper Mill</td><td>Cardboard, OCC</td><td style="color:#2d5a27">‚úì Active - National</td></tr>
<tr><td>Recycle USA</td><td>Plastics Recycler</td><td>HDPE, LDPE, PVC</td><td style="color:#2d5a27">‚úì Active - Verified</td></tr>
</table>

<h3>Load Details</h3>
<table>
<tr><th>Date</th><th>Ticket #</th><th>Hauler</th><th>Net Tons</th><th>Diversion</th><th>Verified</th></tr>
${reportData.map(t => `
<tr>
<td>${t.service_date || 'N/A'}</td>
<td>${t.ticket_number || 'N/A'}</td>
<td>${t.hauler || 'N/A'}</td>
<td>${(t.net_tons || 0).toFixed(2)}</td>
<td>${t.diversion_pct || 0}%</td>
<td>${t.human_verified ? '‚úì' : '-'}</td>
</tr>
`).join('')}
</table>

${includeCert ? `
<div class="certification">
<h4>Certification Statement</h4>
<p>I hereby certify that the waste diversion data presented in this report is accurate and complete to the best of my knowledge. All materials were processed at licensed recycling facilities and diverted from landfill disposal in accordance with LEED MRc5 requirements.</p>
<div style="display:flex;justify-content:space-between;margin-top:30px">
<div class="signature-line">Authorized Signature / Date</div>
<div class="signature-line">Title</div>
</div>
</div>
` : ''}

<div class="footer">
Generated by DivertScan‚Ñ¢ Enterprise | ${companyInfo.name} | ${new Date().toLocaleString()}
</div>

</body>
</html>
`;
}

// ========== AUDIT PACKAGE ==========
async function generateAuditPackage() {
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    showLoading('Generating LEED Audit Package...');
    document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">‚è≥ Preparing documentation...</span>';
    
    try {
        // Get tickets from both Supabase AND local storage
        let remoteTickets = [];
        let localTickets = [];
        
        // Try Supabase if configured (with 5s timeout)
        if (sb) {
            try {
                const sbPromise = sb
                    .from('tickets')
                    .select('*')
                    .eq('project_id', currentProject.id)
                    .order('service_date', { ascending: true });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('timeout')), 5000)
                );
                const result = await Promise.race([sbPromise, timeoutPromise]);
                if (result && !result.error && result.data) remoteTickets = result.data;
            } catch (e) {
                console.log('Supabase fetch skipped:', e.message);
            }
        }
        
        // Always get local tickets (Excel imports stored here)
        try {
            const allLocal = await getAllFromLocal('tickets') || [];
            localTickets = allLocal.filter(t => t.project_id === currentProject.id);
        } catch (e) {
            console.log('Local fetch error:', e.message);
        }
        
        // Merge and dedupe
        const ticketMap = new Map();
        localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        
        const allTickets = Array.from(ticketMap.values());
        allTickets.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));
        
        if (allTickets.length === 0) {
            hideLoading();
            toast('No tickets found', 'error');
            return;
        }
        
        // Store for report generation
        reportData = allTickets;
        
        // Generate AI summary if not already done
        if (!aiSummaryText) {
            document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">‚è≥ Generating AI summary...</span>';
            await generateAISummary();
        }
        
        // Generate report HTML
        document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">‚è≥ Creating PDF report...</span>';
        
        // Download the main PDF
        await downloadReportPDF();
        
        // Download CSV data
        document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">‚è≥ Exporting data spreadsheet...</span>';
        downloadReportCSV();
        
        // Download Excel if available
        if (typeof XLSX !== 'undefined') {
            document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">‚è≥ Creating Excel workbook...</span>';
            downloadReportExcel();
        }
        
        hideLoading();
        document.getElementById('auditPackageStatus').innerHTML = `
            <span style="color:var(--emerald-400)">‚úÖ Audit Package Generated!</span><br>
            <span style="font-size:10px">‚Ä¢ PDF Report downloaded<br>‚Ä¢ CSV Data downloaded<br>‚Ä¢ Excel workbook downloaded<br>‚Ä¢ ${allTickets.length} tickets included</span>
        `;
        
        toast('Audit Package complete!', 'success');
        
    } catch (err) {
        hideLoading();
        document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--red-500)">‚ùå Error: ' + err.message + '</span>';
        toast('Error generating package', 'error');
    }
}

// ========== PROJECT COMPARISON ==========
let comparisonChart = null;

async function loadProjectComparison() {
    showLoading('Loading project comparison...');
    
    try {
        // Get all projects from local + remote
        let allProjects = [];
        
        try { allProjects = await getAllFromLocal('projects') || []; } catch(e) {}
        
        if (sb) {
            try {
                const tp = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
                const res = await Promise.race([sb.from('projects').select('id, name'), tp]);
                if (res?.data) {
                    res.data.forEach(p => { if (!allProjects.find(lp => lp.id === p.id)) allProjects.push(p); });
                }
            } catch(e) { console.log('Supabase comparison skipped:', e.message); }
        }
        
        if (allProjects.length === 0) {
            hideLoading();
            toast('No projects found', 'error');
            return;
        }
        
        // Get stats for each project
        const allTickets = await getAllFromLocal('tickets') || [];
        const projectStats = [];
        
        for (const proj of allProjects) {
            const projTickets = allTickets.filter(t => t.project_id === proj.id);
            
            if (projTickets.length > 0) {
                const totalTons = projTickets.reduce((s, t) => s + (t.net_tons || 0), 0);
                const landfillTons = projTickets.reduce((s, t) => s + (t.landfill_tons || 0), 0);
                const rate = totalTons > 0 ? Math.round(((totalTons - landfillTons) / totalTons) * 100) : 0;
                
                projectStats.push({
                    name: proj.name.substring(0, 20),
                    rate: rate,
                    tons: totalTons,
                    loads: projTickets.length
                });
            }
        }
        
        hideLoading();
        
        if (projectStats.length === 0) {
            toast('No ticket data found', 'error');
            return;
        }
        
        // Create chart
        const ctx = document.getElementById('comparisonChart');
        if (comparisonChart) comparisonChart.destroy();
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: projectStats.map(p => p.name),
                datasets: [{
                    label: 'Diversion Rate %',
                    data: projectStats.map(p => p.rate),
                    backgroundColor: projectStats.map(p => p.rate >= 75 ? '#10b981' : p.rate >= 50 ? '#f59e0b' : '#ef4444'),
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        max: 100,
                        ticks: { color: '#94a3b8' },
                        grid: { color: '#334155' }
                    },
                    y: { 
                        ticks: { color: '#94a3b8', font: { size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });
        
        toast('Comparison loaded!', 'success');
        
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

// ========== EMAIL REPORT ==========
function emailReport() {
    if (!currentProject) {
        toast('Generate report first', 'error');
        return;
    }
    
    const subject = encodeURIComponent(`LEED MRc5 Report - ${currentProject.name}`);
    const body = encodeURIComponent(`Please find attached the LEED MRc5 Waste Diversion Report for ${currentProject.name}.\n\n${aiSummaryText ? 'Summary:\n' + aiSummaryText : ''}\n\nGenerated by DivertScan‚Ñ¢ Enterprise`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
    toast('Opening email client...', 'success');
}

// ========== VOICE INPUT ==========
let recognition = null;
let isListening = false;

function initVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
            isListening = true;
            document.getElementById('voiceInputBtn').classList.add('listening');
            document.getElementById('voiceStatus').textContent = 'Listening...';
            document.getElementById('voiceTranscript').classList.remove('hidden');
        };
        
        recognition.onresult = function(event) {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                transcript += event.results[i][0].transcript;
            }
            document.getElementById('voiceTranscript').textContent = transcript;
            
            // If final result, parse it
            if (event.results[event.results.length - 1].isFinal) {
                parseVoiceInput(transcript);
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Voice recognition error:', event.error);
            document.getElementById('voiceStatus').textContent = 'Error: ' + event.error;
            stopVoiceInput();
        };
        
        recognition.onend = function() {
            stopVoiceInput();
        };
        
        return true;
    }
    return false;
}

function toggleVoiceInput() {
    if (!recognition) {
        if (!initVoiceRecognition()) {
            toast('Voice input not supported in this browser', 'error');
            return;
        }
    }
    
    if (isListening) {
        recognition.stop();
    } else {
        try {
            recognition.start();
        } catch (e) {
            console.error('Voice start error:', e);
            toast('Could not start voice input', 'error');
        }
    }
}

function stopVoiceInput() {
    isListening = false;
    document.getElementById('voiceInputBtn').classList.remove('listening');
    document.getElementById('voiceStatus').textContent = 'Tap to speak ticket info';
}

function parseVoiceInput(transcript) {
    console.log('Parsing voice input:', transcript);
    const lower = transcript.toLowerCase();
    
    // Parse ticket number
    const ticketMatch = lower.match(/ticket\s*(?:number|#|num)?\s*(\d+)/i);
    if (ticketMatch) {
        document.getElementById('ticketNumber').value = ticketMatch[1];
        toast('Ticket #: ' + ticketMatch[1], 'success');
    }
    
    // Parse gross weight
    const grossMatch = lower.match(/gross\s*(?:weight|is)?\s*(\d+[\d,]*)/i);
    if (grossMatch) {
        const gross = parseInt(grossMatch[1].replace(/,/g, ''));
        document.getElementById('grossLbs').value = gross;
        updateNetWeight();
        toast('Gross: ' + gross.toLocaleString() + ' lbs', 'success');
    }
    
    // Parse tare weight
    const tareMatch = lower.match(/tare\s*(?:weight|is)?\s*(\d+[\d,]*)/i);
    if (tareMatch) {
        const tare = parseInt(tareMatch[1].replace(/,/g, ''));
        document.getElementById('tareLbs').value = tare;
        updateNetWeight();
        toast('Tare: ' + tare.toLocaleString() + ' lbs', 'success');
    }
    
    // Parse weight without prefix (assume gross if only one number)
    const weightMatch = lower.match(/(\d{4,})\s*(?:pounds|lbs)?/);
    if (weightMatch && !grossMatch && !tareMatch) {
        const weight = parseInt(weightMatch[1].replace(/,/g, ''));
        if (!document.getElementById('grossLbs').value) {
            document.getElementById('grossLbs').value = weight;
            updateNetWeight();
            toast('Gross: ' + weight.toLocaleString() + ' lbs', 'success');
        }
    }
    
    // Parse hauler name
    const haulerMatch = lower.match(/hauler\s*(?:is|name)?\s*(.+?)(?:\s*ticket|\s*gross|\s*$)/i);
    if (haulerMatch) {
        document.getElementById('haulerName').value = haulerMatch[1].trim();
        toast('Hauler: ' + haulerMatch[1].trim(), 'success');
    }
}

// ========== CHARTS ==========
let materialTrendChart = null;
let diversionChart = null;

async function updateCharts() {
    if (!sb || !currentProject) return;
    
    try {
        const { data } = await sb
            .from('tickets')
            .select('*')
            .eq('project_id', currentProject.id)
            .order('created_at', { ascending: true })
            .limit(20);
        
        if (!data || data.length === 0) {
            console.log('No data for charts');
            return;
        }
        
        // Material Trend Chart
        const labels = data.map((t, i) => '#' + (t.ticket_number || (i + 1)));
        const woodData = data.map(t => t.wood_pct || 0);
        const concreteData = data.map(t => t.concrete_pct || 0);
        const metalData = data.map(t => t.metal_pct || 0);
        const landfillData = data.map(t => t.landfill_pct || 0);
        
        const ctx1 = document.getElementById('materialTrendChart');
        if (ctx1) {
            if (materialTrendChart) materialTrendChart.destroy();
            
            materialTrendChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels.slice(-10),
                    datasets: [
                        { label: 'Wood', data: woodData.slice(-10), borderColor: '#a78b5b', backgroundColor: 'rgba(167,139,91,0.1)', tension: 0.3 },
                        { label: 'Concrete', data: concreteData.slice(-10), borderColor: '#6b7280', backgroundColor: 'rgba(107,114,128,0.1)', tension: 0.3 },
                        { label: 'Metal', data: metalData.slice(-10), borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.3 },
                        { label: 'Landfill', data: landfillData.slice(-10), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 }, color: '#94a3b8' } }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
        // Diversion Rate Chart
        const diversionData = data.map(t => t.diversion_pct || 0);
        
        const ctx2 = document.getElementById('diversionChart');
        if (ctx2) {
            if (diversionChart) diversionChart.destroy();
            
            diversionChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: labels.slice(-10),
                    datasets: [{
                        label: 'Diversion %',
                        data: diversionData.slice(-10),
                        backgroundColor: diversionData.slice(-10).map(d => d >= 75 ? '#10b981' : d >= 50 ? '#f59e0b' : '#ef4444'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 75, yMax: 75, borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5] }
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { display: false } }
                    }
                }
            });
        }
        
    } catch (err) {
        console.error('Chart update error:', err);
    }
}

// ========== LEED PREDICTOR ==========
async function updateLeedPredictor() {
    if (!sb || !currentProject) {
        document.getElementById('predictorStatus').textContent = '--';
        document.getElementById('predictorMessage').textContent = 'Select a project';
        return;
    }
    
    try {
        const { data } = await sb
            .from('tickets')
            .select('net_tons, landfill_tons, diversion_pct, created_at')
            .eq('project_id', currentProject.id)
            .order('created_at', { ascending: true });
        
        if (!data || data.length === 0) {
            document.getElementById('predictorStatus').textContent = 'N/A';
            document.getElementById('predictorMessage').textContent = 'Add tickets to see prediction';
            document.getElementById('predictorCurrent').textContent = '0%';
            document.getElementById('predictorProgressBar').style.width = '0%';
            return;
        }
        
        // Calculate current stats
        const totalTons = data.reduce((s, t) => s + (t.net_tons || 0), 0);
        const landfillTons = data.reduce((s, t) => s + (t.landfill_tons || 0), 0);
        const divertedTons = totalTons - landfillTons;
        const currentRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        
        // Calculate trend (moving average of last 5 vs first 5)
        let trend = 0;
        if (data.length >= 5) {
            const recent = data.slice(-5).reduce((s, t) => s + (t.diversion_pct || 0), 0) / 5;
            const earlier = data.slice(0, Math.min(5, data.length)).reduce((s, t) => s + (t.diversion_pct || 0), 0) / Math.min(5, data.length);
            trend = recent - earlier;
        }
        
        // Update UI
        document.getElementById('predictorCurrent').textContent = currentRate + '%';
        document.getElementById('predictorProgressBar').style.width = Math.min(currentRate, 100) + '%';
        
        // Color the progress bar
        const progressBar = document.getElementById('predictorProgressBar');
        if (currentRate >= 75) {
            progressBar.style.background = 'var(--emerald-500)';
        } else if (currentRate >= 50) {
            progressBar.style.background = 'var(--amber-500)';
        } else {
            progressBar.style.background = 'var(--red-500)';
        }
        
        // Predict status
        const target = currentProject.leed_target || 75;
        
        if (currentRate >= target) {
            document.getElementById('predictorStatus').textContent = '‚úÖ ON TRACK';
            document.getElementById('predictorStatus').style.color = 'var(--emerald-400)';
            document.getElementById('predictorMessage').textContent = `Exceeding ${target}% target by ${currentRate - target}%`;
        } else if (currentRate >= target - 10) {
            document.getElementById('predictorStatus').textContent = '‚ö†Ô∏è CLOSE';
            document.getElementById('predictorStatus').style.color = 'var(--amber-400)';
            const needed = target - currentRate;
            document.getElementById('predictorMessage').textContent = `Need ${needed}% more diversion to reach target`;
        } else {
            document.getElementById('predictorStatus').textContent = '‚ùå AT RISK';
            document.getElementById('predictorStatus').style.color = 'var(--red-500)';
            const needed = target - currentRate;
            document.getElementById('predictorMessage').textContent = `${needed}% below target - increase recycling`;
        }
        
        // Add trend indicator
        if (trend > 5) {
            document.getElementById('predictorMessage').textContent += ' üìà Improving';
        } else if (trend < -5) {
            document.getElementById('predictorMessage').textContent += ' üìâ Declining';
        }
        
    } catch (err) {
        console.error('Predictor error:', err);
    }
}

// Load news on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(refreshLeedNews, 2000);
    initVoiceRecognition();
});

// ========== LOGIN / AUTH SYSTEM ==========
const ADMIN_CREDENTIALS = { username: 'admin', password: 'dalmex2024' };
let userRole = null; // 'admin' or 'customer'

// Company Info (DalMex defaults)
let companyInfo = {
    name: 'DalMex Recycling LLC',
    address: '2828 Nagel St., Dallas, TX 75220',
    phone: '(214) 352-2000'
};

function switchLoginTab(tab) {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    if (tab === 'admin') {
        document.getElementById('adminLoginForm').classList.remove('hidden');
        document.getElementById('customerLoginForm').classList.add('hidden');
    } else {
        document.getElementById('adminLoginForm').classList.add('hidden');
        document.getElementById('customerLoginForm').classList.remove('hidden');
    }
}

function doAdminLogin() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value;
    
    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
        userRole = 'admin';
        localStorage.setItem('divertscan_session', JSON.stringify({ role: 'admin', time: Date.now() }));
        showMainApp();
    } else {
        document.getElementById('adminLoginError').textContent = 'Invalid username or password';
    }
}

async function doCustomerLogin() {
    const code = document.getElementById('customerCode').value.trim().toUpperCase();
    
    if (!code) {
        document.getElementById('customerLoginError').textContent = 'Please enter an access code';
        return;
    }
    
    if (!sb) {
        const url = localStorage.getItem('divertscan_sb_url');
        const key = localStorage.getItem('divertscan_sb_key');
        if (url && key) {
            sb = supabase.createClient(url, key);
        } else {
            document.getElementById('customerLoginError').textContent = 'System not configured. Contact DalMex.';
            return;
        }
    }
    
    try {
        const { data, error } = await sb.from('projects').select('*').eq('access_code', code).single();
        
        if (error || !data) {
            document.getElementById('customerLoginError').textContent = 'Invalid access code';
            return;
        }
        
        userRole = 'customer';
        currentProject = data;
        localStorage.setItem('divertscan_session', JSON.stringify({ 
            role: 'customer', 
            projectId: data.id, 
            time: Date.now() 
        }));
        showMainApp();
    } catch (err) {
        document.getElementById('customerLoginError').textContent = 'Error: ' + err.message;
    }
}

function showMainApp() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('appContainer').classList.add('active');
    document.body.classList.add('logged-in');
    
    if (userRole === 'admin') {
        document.getElementById('adminHeader').classList.remove('hidden');
        document.getElementById('customerHeader').classList.add('hidden');
        document.getElementById('portalBanner').classList.add('hidden');
        document.getElementById('adminNav').classList.remove('hidden');
        document.getElementById('customerNav').classList.add('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
        
        initializeApp();
    } else {
        document.getElementById('adminHeader').classList.add('hidden');
        document.getElementById('customerHeader').classList.remove('hidden');
        document.getElementById('portalBanner').classList.remove('hidden');
        document.getElementById('adminNav').classList.add('hidden');
        document.getElementById('customerNav').classList.remove('hidden');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        
        document.getElementById('portalProjectName').textContent = currentProject.name;
        initCustomerPortal();
    }
}

async function initCustomerPortal() {
    const url = localStorage.getItem('divertscan_sb_url');
    const key = localStorage.getItem('divertscan_sb_key');
    
    if (url && key && !sb) {
        sb = supabase.createClient(url, key);
    }
    
    if (sb && currentProject) {
        updateProjectDisplay();
        await loadRecentTickets();
        await updateStats();
    }
}

function doLogout() {
    localStorage.removeItem('divertscan_session');
    userRole = null;
    currentProject = null;
    
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('appContainer').classList.remove('active');
    document.body.classList.remove('logged-in');
    
    // Clear form fields
    document.getElementById('adminUsername').value = '';
    document.getElementById('adminPassword').value = '';
    document.getElementById('customerCode').value = '';
    document.getElementById('adminLoginError').textContent = '';
    document.getElementById('customerLoginError').textContent = '';
}

// Check session on page load
function checkExistingSession() {
    const session = localStorage.getItem('divertscan_session');
    
    if (session) {
        const s = JSON.parse(session);
        // Session expires after 24 hours
        if (Date.now() - s.time < 24 * 60 * 60 * 1000) {
            if (s.role === 'admin') {
                userRole = 'admin';
                showMainApp();
                return true;
            } else if (s.role === 'customer' && s.projectId) {
                userRole = 'customer';
                const url = localStorage.getItem('divertscan_sb_url');
                const key = localStorage.getItem('divertscan_sb_key');
                if (url && key) {
                    sb = supabase.createClient(url, key);
                    sb.from('projects').select('*').eq('id', s.projectId).single().then(({ data }) => {
                        if (data) {
                            currentProject = data;
                            showMainApp();
                        }
                    });
                    return true;
                }
            }
        }
    }
    return false;
}

// ========== KEYBOARD SHORTCUTS ==========
document.addEventListener('keydown', function(e) {
    // Only work when logged in and not in an input field
    if (!userRole) return;
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
    
    // Ctrl/Cmd + key shortcuts
    if (e.ctrlKey || e.metaKey) {
        switch(e.key.toLowerCase()) {
            case 'n': // New ticket
                e.preventDefault();
                startNewTicket();
                break;
            case 's': // Sync
                e.preventDefault();
                forceSyncNow();
                break;
            case 'b': // Backup
                e.preventDefault();
                createFullBackup();
                break;
            case 'r': // Refresh
                e.preventDefault();
                loadRecentTickets();
                updateStats();
                break;
        }
    }
    
    // Number keys for navigation (1-4)
    if (!e.ctrlKey && !e.metaKey && !e.altKey) {
        switch(e.key) {
            case '1':
                showTab('dashboard');
                break;
            case '2':
                showTab('projects');
                break;
            case '3':
                showTab('reports');
                break;
            case '4':
                if (userRole === 'admin') showTab('settings');
                break;
            case '?': // Show shortcuts help
                showKeyboardShortcuts();
                break;
        }
    }
    
    // Escape to close modals
    if (e.key === 'Escape') {
        closeTicketModal();
        closeProjectModal();
    }
});

function showKeyboardShortcuts() {
    const shortcuts = `
‚å®Ô∏è KEYBOARD SHORTCUTS

Navigation:
  1 - Dashboard
  2 - Projects  
  3 - Reports
  4 - Settings (admin)

Actions:
  Ctrl+N - New Ticket
  Ctrl+S - Sync Now
  Ctrl+B - Backup
  Ctrl+R - Refresh
  Esc - Close Modal
  ? - Show this help
    `;
    alert(shortcuts);
}

// ========== COLOR THEME SYSTEM ==========
let currentTheme = 'default';

function setTheme(theme) {
    currentTheme = theme;
    
    // Remove theme attribute for default, set for others
    if (theme === 'default') {
        document.documentElement.removeAttribute('data-theme');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
    
    // Update active state on theme buttons
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('active');
        if (opt.dataset.theme === theme) {
            opt.classList.add('active');
        }
    });
    
    // Save preference
    localStorage.setItem('divertscan_theme', theme);
    
    // Update charts if they exist (they need color updates)
    if (typeof updateCharts === 'function') {
        setTimeout(updateCharts, 100);
    }
    
    toast('Theme changed to ' + getThemeName(theme), 'success');
}

function getThemeName(theme) {
    const names = {
        'default': 'Dark Slate',
        'dalmex': 'DalMex Green',
        'ocean': 'Ocean Blue',
        'sunset': 'Sunset Orange',
        'light': 'Light Mode',
        'contrast': 'High Contrast',
        'purple': 'Purple Haze'
    };
    return names[theme] || theme;
}

function loadSavedTheme() {
    const saved = localStorage.getItem('divertscan_theme');
    if (saved) {
        setTheme(saved);
    }
    
    // Load other display preferences
    if (localStorage.getItem('divertscan_reduced_motion') === 'true') {
        document.getElementById('reducedMotion').checked = true;
        document.body.classList.add('reduced-motion');
    }
    if (localStorage.getItem('divertscan_larger_text') === 'true') {
        document.getElementById('largerText').checked = true;
        document.body.classList.add('larger-text');
    }
    if (localStorage.getItem('divertscan_compact_mode') === 'true') {
        document.getElementById('compactMode').checked = true;
        document.body.classList.add('compact-mode');
    }
}

function toggleReducedMotion() {
    const enabled = document.getElementById('reducedMotion').checked;
    document.body.classList.toggle('reduced-motion', enabled);
    localStorage.setItem('divertscan_reduced_motion', enabled);
}

function toggleLargerText() {
    const enabled = document.getElementById('largerText').checked;
    document.body.classList.toggle('larger-text', enabled);
    localStorage.setItem('divertscan_larger_text', enabled);
}

function toggleCompactMode() {
    const enabled = document.getElementById('compactMode').checked;
    document.body.classList.toggle('compact-mode', enabled);
    localStorage.setItem('divertscan_compact_mode', enabled);
}

// ========== VERIFIED FACILITY DATABASE ==========
const VERIFIED_FACILITIES = {
    // Metal Recyclers
    'cyclone_metal': {
        id: 'cyclone_metal',
        name: 'Cyclone Metal Recycling',
        shortName: 'Cyclone Metal',
        type: 'Scrap Metal Recycler',
        materials: ['metal', 'steel', 'aluminum', 'copper', 'rebar'],
        address: 'Dallas-Fort Worth, TX',
        phone: '',
        license: 'TX-SWR-2024-ACTIVE',
        licenseExpires: '2025-12-31',
        verified: true,
        status: 'active'
    },
    
    // Cardboard/OCC Recyclers
    'georgia_pacific': {
        id: 'georgia_pacific',
        name: 'Georgia-Pacific Recycling',
        shortName: 'Georgia Pacific',
        type: 'Paper Mill',
        materials: ['cardboard', 'occ', 'paper'],
        address: 'Multiple Locations',
        phone: '',
        license: 'NATIONAL-VERIFIED',
        licenseExpires: '2026-12-31',
        verified: true,
        status: 'active'
    },
    'smurfit_westrock': {
        id: 'smurfit_westrock',
        name: 'Smurfit WestRock',
        shortName: 'WestRock',
        type: 'Paper Mill',
        materials: ['cardboard', 'occ', 'paper'],
        address: 'Multiple Locations',
        phone: '',
        license: 'NATIONAL-VERIFIED',
        licenseExpires: '2026-12-31',
        verified: true,
        status: 'active'
    },
    'greenside': {
        id: 'greenside',
        name: 'GreenSide Recycling',
        shortName: 'GreenSide',
        type: 'OCC Recycler',
        materials: ['cardboard', 'occ', 'paper'],
        address: 'Dallas-Fort Worth, TX',
        phone: '',
        license: 'TX-RCY-2024-ACTIVE',
        licenseExpires: '2025-12-31',
        verified: true,
        status: 'active'
    },
    
    // Plastic Recyclers
    'recycle_usa': {
        id: 'recycle_usa',
        name: 'Recycle USA',
        shortName: 'Recycle USA',
        type: 'Plastics Recycler',
        materials: ['plastic', 'hdpe', 'ldpe', 'pvc'],
        address: 'USA',
        phone: '',
        license: 'VERIFIED-RECYCLER',
        licenseExpires: '2025-12-31',
        verified: true,
        status: 'active'
    },
    
    // Wood Recyclers
    'dalmex_pallet': {
        id: 'dalmex_pallet',
        name: 'DalMex Recycling - Pallet Division',
        shortName: 'DalMex Pallets',
        type: 'Wood Recycler / Pallet Manufacturer',
        materials: ['wood', 'lumber', 'pallets', 'plywood'],
        address: '2828 Nagel St., Dallas, TX 75220',
        phone: '(214) 352-2000',
        license: 'TX-WOOD-2024-ACTIVE',
        licenseExpires: '2025-12-31',
        verified: true,
        status: 'active',
        isOwned: true // Flag for company-owned facility
    },
    
    // Concrete/Masonry
    'generic_concrete': {
        id: 'generic_concrete',
        name: 'Concrete Crusher (Specify)',
        shortName: 'Concrete Recycler',
        type: 'C&D Processor',
        materials: ['concrete', 'masonry', 'brick', 'block'],
        address: 'Various',
        phone: '',
        license: 'REQUIRES-VERIFICATION',
        licenseExpires: null,
        verified: false,
        status: 'pending'
    },
    
    // Drywall
    'generic_drywall': {
        id: 'generic_drywall',
        name: 'Drywall Recycler (Specify)',
        shortName: 'Drywall Recycler',
        type: 'Gypsum Recycler',
        materials: ['drywall', 'gypsum'],
        address: 'Various',
        phone: '',
        license: 'REQUIRES-VERIFICATION',
        licenseExpires: null,
        verified: false,
        status: 'pending'
    },
    
    // Landfill
    'landfill': {
        id: 'landfill',
        name: 'Municipal Landfill',
        shortName: 'Landfill',
        type: 'Landfill',
        materials: ['landfill', 'trash', 'mixed waste'],
        address: 'Various',
        phone: '',
        license: 'N/A',
        licenseExpires: null,
        verified: true,
        status: 'active',
        isLandfill: true
    }
};

// Material to Facility Routing (default destinations)
const MATERIAL_ROUTING = {
    'metal': ['cyclone_metal'],
    'cardboard': ['georgia_pacific', 'smurfit_westrock', 'greenside'],
    'occ': ['georgia_pacific', 'smurfit_westrock', 'greenside'],
    'plastic': ['recycle_usa'],
    'wood': ['dalmex_pallet'],
    'concrete': ['generic_concrete'],
    'drywall': ['generic_drywall'],
    'landfill': ['landfill']
};

// Get facilities for a material type
function getFacilitiesForMaterial(material) {
    const facilityIds = MATERIAL_ROUTING[material.toLowerCase()] || [];
    return facilityIds.map(id => VERIFIED_FACILITIES[id]).filter(f => f);
}

// Get all active facilities
function getAllFacilities() {
    return Object.values(VERIFIED_FACILITIES).filter(f => f.status === 'active');
}

// Verify a facility
function verifyFacility(facilityId) {
    const facility = VERIFIED_FACILITIES[facilityId];
    if (!facility) {
        return { valid: false, status: 'not_found', message: 'Facility not in database' };
    }
    
    // Check license expiration
    if (facility.licenseExpires) {
        const expDate = new Date(facility.licenseExpires);
        if (expDate < new Date()) {
            return { 
                valid: false, 
                status: 'expired', 
                message: `License expired ${facility.licenseExpires}`,
                facility 
            };
        }
    }
    
    if (!facility.verified) {
        return { 
            valid: false, 
            status: 'unverified', 
            message: 'Facility requires verification',
            facility 
        };
    }
    
    return { 
        valid: true, 
        status: 'verified', 
        message: `Verified - License valid through ${facility.licenseExpires || 'N/A'}`,
        facility 
    };
}

// Get verification badge HTML
function getFacilityBadge(facilityId) {
    const result = verifyFacility(facilityId);
    
    if (result.status === 'verified') {
        return `<span class="leed-badge compliant">‚úì Verified Facility</span>`;
    } else if (result.status === 'unverified') {
        return `<span class="leed-badge warning">‚ö† Needs Verification</span>`;
    } else if (result.status === 'expired') {
        return `<span class="leed-badge fail">‚úó License Expired</span>`;
    } else {
        return `<span class="leed-badge fail">‚úó Unknown Facility</span>`;
    }
}

// ========== MATERIAL DESTINATION TRACKING ==========
let materialDestinations = {};

function initMaterialDestinations() {
    // Default destinations based on your facility network
    materialDestinations = {
        wood: 'dalmex_pallet',
        metal: 'cyclone_metal',
        cardboard: 'georgia_pacific',
        plastic: 'recycle_usa',
        concrete: 'generic_concrete',
        drywall: 'generic_drywall',
        landfill: 'landfill'
    };
    
    // Load saved preferences
    const saved = localStorage.getItem('divertscan_material_destinations');
    if (saved) {
        materialDestinations = { ...materialDestinations, ...JSON.parse(saved) };
    }
}

function saveMaterialDestination(material, facilityId) {
    materialDestinations[material] = facilityId;
    localStorage.setItem('divertscan_material_destinations', JSON.stringify(materialDestinations));
}

// Generate facility destination summary for reports
function generateDestinationSummary(ticketMaterials) {
    const summary = [];
    const materialNames = {
        wood: 'Wood/Lumber',
        metal: 'Metals',
        cardboard: 'Cardboard/OCC',
        plastic: 'Plastics',
        concrete: 'Concrete/Masonry',
        drywall: 'Drywall/Gypsum',
        landfill: 'Landfill'
    };
    
    for (const [material, percentage] of Object.entries(ticketMaterials)) {
        if (percentage > 0 && material !== 'landfill') {
            const facilityId = materialDestinations[material];
            const facility = VERIFIED_FACILITIES[facilityId];
            const verification = verifyFacility(facilityId);
            
            summary.push({
                material: materialNames[material] || material,
                percentage,
                facility: facility ? facility.name : 'Not specified',
                facilityType: facility ? facility.type : 'Unknown',
                verified: verification.valid,
                license: facility ? facility.license : 'N/A'
            });
        }
    }
    
    // Add landfill if present
    if (ticketMaterials.landfill > 0) {
        summary.push({
            material: 'Landfill/Non-Recyclable',
            percentage: ticketMaterials.landfill,
            facility: 'Municipal Landfill',
            facilityType: 'Landfill',
            verified: true,
            license: 'N/A'
        });
    }
    
    return summary;
}

// Initialize on load
initMaterialDestinations();
const DB_NAME = 'DivertScanDB';
const DB_VERSION = 2; // Bumped to ensure we're >= any previous version
let db = null;

async function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = (event) => {
            console.error('IndexedDB error:', request.error);
            
            // If version conflict, try to recover by opening without a version (uses current)
            if (request.error && request.error.name === 'VersionError') {
                console.log('Version conflict detected - attempting recovery...');
                const recoveryRequest = indexedDB.open(DB_NAME);
                recoveryRequest.onsuccess = () => {
                    db = recoveryRequest.result;
                    console.log('IndexedDB recovered at version', db.version);
                    resolve(db);
                };
                recoveryRequest.onerror = () => {
                    console.error('Recovery failed - deleting and recreating DB');
                    indexedDB.deleteDatabase(DB_NAME);
                    // Retry with our version
                    const retryRequest = indexedDB.open(DB_NAME, DB_VERSION);
                    retryRequest.onupgradeneeded = createStores;
                    retryRequest.onsuccess = () => { db = retryRequest.result; resolve(db); };
                    retryRequest.onerror = () => reject(retryRequest.error);
                };
            } else {
                reject(request.error);
            }
        };
        
        request.onsuccess = () => {
            db = request.result;
            console.log('IndexedDB initialized v' + db.version);
            resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
            createStores(event);
        };
    });
}

function createStores(event) {
    const database = event.target.result;
    
    // Projects store
    if (!database.objectStoreNames.contains('projects')) {
        const projectStore = database.createObjectStore('projects', { keyPath: 'id' });
        projectStore.createIndex('synced', 'synced', { unique: false });
    }
    
    // Tickets store
    if (!database.objectStoreNames.contains('tickets')) {
        const ticketStore = database.createObjectStore('tickets', { keyPath: 'id' });
        ticketStore.createIndex('project_id', 'project_id', { unique: false });
        ticketStore.createIndex('synced', 'synced', { unique: false });
    }
    
    // Drafts store (auto-saved in-progress tickets)
    if (!database.objectStoreNames.contains('drafts')) {
        database.createObjectStore('drafts', { keyPath: 'id' });
    }
    
    // Sync queue
    if (!database.objectStoreNames.contains('syncQueue')) {
        database.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
    }
    
    // Settings store
    if (!database.objectStoreNames.contains('settings')) {
        database.createObjectStore('settings', { keyPath: 'key' });
    }
}

// Save to IndexedDB
async function saveToLocal(storeName, data) {
    if (!db) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.put(data);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Get from IndexedDB
async function getFromLocal(storeName, key) {
    if (!db) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(key);
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Get all from IndexedDB
async function getAllFromLocal(storeName) {
    if (!db) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();
        
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// Delete from IndexedDB
async function deleteFromLocal(storeName, key) {
    if (!db) await initIndexedDB();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

// ========== ONLINE/OFFLINE DETECTION ==========
let isOnline = navigator.onLine;
let pendingSyncItems = [];

function updateOnlineStatus() {
    isOnline = navigator.onLine;
    const statusBar = document.getElementById('statusBar');
    const statusText = document.getElementById('statusBarText');
    
    if (isOnline) {
        statusBar.className = 'status-bar online';
        statusText.textContent = '‚úì Online - All data synced';
        
        // Auto-sync if enabled
        if (document.getElementById('autoSync')?.checked) {
            syncPendingData();
        }
    } else {
        statusBar.className = 'status-bar offline';
        statusText.textContent = '‚ö† Offline - Data saved locally';
    }
    
    statusBar.classList.remove('hidden');
    document.body.classList.add('has-status-bar');
    
    // Hide status bar after 3 seconds if online
    if (isOnline) {
        setTimeout(() => {
            if (pendingSyncItems.length === 0) {
                statusBar.classList.add('hidden');
                document.body.classList.remove('has-status-bar');
            }
        }, 3000);
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// ========== SYNC ENGINE ==========
async function addToSyncQueue(action, table, data) {
    const item = {
        id: Date.now() + Math.random(),
        action, // 'insert', 'update', 'delete'
        table,
        data,
        timestamp: new Date().toISOString(),
        retries: 0
    };
    
    await saveToLocal('syncQueue', item);
    pendingSyncItems.push(item);
    updateSyncStatus();
}

async function syncPendingData() {
    if (!isOnline || !sb) return;
    
    const queue = await getAllFromLocal('syncQueue');
    if (queue.length === 0) return;
    
    const statusBar = document.getElementById('statusBar');
    const statusText = document.getElementById('statusBarText');
    statusBar.className = 'status-bar syncing';
    statusText.textContent = `üîÑ Syncing ${queue.length} items...`;
    
    let synced = 0;
    let failed = 0;
    
    for (const item of queue) {
        try {
            if (item.action === 'insert') {
                const { error } = await sb.from(item.table).insert([item.data]);
                if (error) throw error;
            } else if (item.action === 'update') {
                const { error } = await sb.from(item.table).update(item.data).eq('id', item.data.id);
                if (error) throw error;
            } else if (item.action === 'delete') {
                const { error } = await sb.from(item.table).delete().eq('id', item.data.id);
                if (error) throw error;
            }
            
            // Remove from queue on success
            await deleteFromLocal('syncQueue', item.id);
            synced++;
        } catch (err) {
            console.error('Sync failed for item:', item, err);
            item.retries++;
            if (item.retries < 5) {
                await saveToLocal('syncQueue', item);
            }
            failed++;
        }
    }
    
    // Update status
    pendingSyncItems = await getAllFromLocal('syncQueue');
    updateSyncStatus();
    
    if (failed === 0) {
        statusBar.className = 'status-bar online';
        statusText.textContent = `‚úì Synced ${synced} items successfully`;
        localStorage.setItem('divertscan_last_sync', new Date().toISOString());
    } else {
        statusBar.className = 'status-bar offline';
        statusText.textContent = `‚ö† ${failed} items failed to sync`;
    }
    
    // Refresh data
    await loadProjects();
    await loadRecentTickets();
}

function updateSyncStatus() {
    const countEl = document.getElementById('pendingSyncCount');
    const timeEl = document.getElementById('lastSyncTime');
    
    if (countEl) countEl.textContent = pendingSyncItems.length;
    if (timeEl) {
        const lastSync = localStorage.getItem('divertscan_last_sync');
        timeEl.textContent = lastSync ? new Date(lastSync).toLocaleString() : 'Never';
    }
}

function forceSyncNow() {
    if (!isOnline) {
        toast('Cannot sync while offline', 'error');
        return;
    }
    syncPendingData();
}

// ========== AUTO-SAVE DRAFTS ==========
let autosaveInterval = null;
let currentDraft = null;

function startAutosave() {
    if (autosaveInterval) clearInterval(autosaveInterval);
    
    autosaveInterval = setInterval(async () => {
        if (!document.getElementById('autosaveDrafts')?.checked) return;
        
        // Save current ticket form state
        if (document.getElementById('ticketModal')?.classList.contains('active')) {
            await saveDraft();
        }
    }, 10000); // Every 10 seconds
}

async function saveDraft() {
    const draft = {
        id: 'current_draft',
        projectId: document.getElementById('ticketProject')?.value,
        ticketNumber: document.getElementById('ticketNumber')?.value,
        serviceDate: document.getElementById('serviceDate')?.value,
        grossLbs: document.getElementById('grossLbs')?.value,
        tareLbs: document.getElementById('tareLbs')?.value,
        haulerName: document.getElementById('haulerName')?.value,
        materials: ticketData.materials,
        diversionRate: ticketData.diversionRate,
        photos: debrisPhotos,
        step: currentStep,
        savedAt: new Date().toISOString()
    };
    
    await saveToLocal('drafts', draft);
    currentDraft = draft;
    
    // Update autosave indicator
    const indicator = document.querySelector('.autosave-indicator');
    if (indicator) {
        indicator.className = 'autosave-indicator saved';
        indicator.innerHTML = '‚úì Draft saved ' + new Date().toLocaleTimeString();
    }
    
    console.log('Draft auto-saved');
}

async function checkForDraft() {
    try {
        const draft = await getFromLocal('drafts', 'current_draft');
        
        if (draft && draft.savedAt) {
            const savedTime = new Date(draft.savedAt);
            const age = Date.now() - savedTime.getTime();
            
            // If draft is less than 24 hours old
            if (age < 24 * 60 * 60 * 1000) {
                if (confirm(`Found unsaved ticket from ${savedTime.toLocaleString()}. Restore it?`)) {
                    restoreDraft(draft);
                    return true;
                }
            }
        }
    } catch (err) {
        console.log('No draft found');
    }
    return false;
}

function restoreDraft(draft) {
    if (document.getElementById('ticketProject')) document.getElementById('ticketProject').value = draft.projectId || '';
    if (document.getElementById('ticketNumber')) document.getElementById('ticketNumber').value = draft.ticketNumber || '';
    if (document.getElementById('serviceDate')) document.getElementById('serviceDate').value = draft.serviceDate || '';
    if (document.getElementById('grossLbs')) document.getElementById('grossLbs').value = draft.grossLbs || '';
    if (document.getElementById('tareLbs')) document.getElementById('tareLbs').value = draft.tareLbs || '';
    if (document.getElementById('haulerName')) document.getElementById('haulerName').value = draft.haulerName || '';
    
    if (draft.materials) ticketData.materials = draft.materials;
    if (draft.diversionRate) ticketData.diversionRate = draft.diversionRate;
    if (draft.photos) debrisPhotos = draft.photos;
    
    updateNetWeight();
    openModal('ticketModal');
    
    if (draft.step && draft.step > 1) {
        showStep(draft.step);
    }
    
    toast('Draft restored!', 'success');
}

async function clearDraft() {
    await deleteFromLocal('drafts', 'current_draft');
    currentDraft = null;
}

// ========== LEED RULES ENGINE ==========
const LEED_RULES = {
    'v4.1': {
        name: 'LEED v4.1',
        mrc5: {
            name: 'MRc5: Construction and Demolition Waste Management',
            options: {
                diversion: {
                    description: 'Diversion',
                    thresholds: [
                        { percent: 50, points: 1, label: '50% diversion = 1 point' },
                        { percent: 75, points: 2, label: '75% diversion = 2 points' }
                    ]
                }
            },
            requirements: [
                'Track waste by material stream',
                'Document final destination for each stream',
                'Obtain recycling facility documentation',
                'Calculate diversion rate using weight or volume'
            ],
            excluded: [
                'Hazardous waste',
                'Soil and land clearing debris (may count separately)',
                'Alternative daily cover (ADC) does NOT count as diversion'
            ]
        }
    },
    'v5': {
        name: 'LEED v5 (2024)',
        mrc5: {
            name: 'MRc5: Construction and Demolition Waste Management',
            options: {
                diversion: {
                    description: 'Diversion',
                    thresholds: [
                        { percent: 50, points: 1, label: '50% diversion = 1 point' },
                        { percent: 75, points: 2, label: '75% diversion = 2 points' }
                    ]
                },
                circularity: {
                    description: 'Tier 1 Circularity Credit',
                    multiplier: 2.0,
                    eligibleMaterials: ['reused materials', 'deconstructed materials'],
                    label: 'Reused materials count 200%'
                }
            },
            requirements: [
                'Track waste by material stream',
                'Document final destination for each stream',
                'Obtain recycling facility certification',
                'Calculate diversion rate using weight',
                'NEW: Photo documentation recommended',
                'NEW: GPS verification for audit trail'
            ],
            excluded: [
                'Hazardous waste',
                'Alternative daily cover (ADC)',
                'Waste-to-energy incineration'
            ]
        }
    }
};

let currentLeedVersion = 'v4.1';

function updateLeedRules() {
    currentLeedVersion = document.getElementById('leedVersion')?.value || 'v4.1';
    const rules = LEED_RULES[currentLeedVersion];
    
    const display = document.getElementById('leedRulesDisplay');
    if (display && rules) {
        const mrc5 = rules.mrc5;
        display.innerHTML = `
            <strong>${mrc5.name}</strong><br>
            ${mrc5.options.diversion.thresholds.map(t => `‚Ä¢ ${t.label}`).join('<br>')}
            ${currentLeedVersion === 'v5' ? '<br>‚Ä¢ Tier 1 Circularity: Reused materials count 200%' : ''}
            <br><br><strong>Requirements:</strong><br>
            ${mrc5.requirements.map(r => `‚Ä¢ ${r}`).join('<br>')}
        `;
    }
    
    localStorage.setItem('divertscan_leed_version', currentLeedVersion);
}

function validateLeedCompliance(diversionRate, totalTons) {
    const rules = LEED_RULES[currentLeedVersion];
    const thresholds = rules.mrc5.options.diversion.thresholds;
    
    let result = {
        compliant: false,
        points: 0,
        status: 'fail',
        message: '',
        warnings: []
    };
    
    // Check thresholds
    for (const threshold of thresholds.slice().reverse()) {
        if (diversionRate >= threshold.percent) {
            result.compliant = true;
            result.points = threshold.points;
            result.status = 'compliant';
            result.message = `‚úì LEED Compliant: ${threshold.label}`;
            break;
        }
    }
    
    if (!result.compliant) {
        const needed = thresholds[0].percent - diversionRate;
        result.message = `‚úó ${needed}% below minimum threshold`;
        result.status = 'fail';
    }
    
    // Add warnings
    if (diversionRate > 95) {
        result.warnings.push('Unusually high diversion rate - verify data accuracy');
        result.status = 'warning';
    }
    
    if (totalTons < 1) {
        result.warnings.push('Low total tonnage - may not meet LEED minimum');
    }
    
    return result;
}

function saveLeedSettings() {
    const version = document.getElementById('leedVersion')?.value;
    const target = document.getElementById('defaultDiversionTarget')?.value;
    
    localStorage.setItem('divertscan_leed_version', version);
    localStorage.setItem('divertscan_default_target', target);
    
    toast('LEED settings saved!', 'success');
}

// ========== DATA VALIDATION ==========
function validateTicketData(data) {
    const errors = [];
    const warnings = [];
    
    // Support both camelCase (ticketData) and snake_case (dbRecord) field names
    const projectId = data.projectId || data.project_id;
    const serviceDate = data.serviceDate || data.service_date;
    const grossLbs = data.grossLbs || data.gross_lbs;
    const tareLbs = data.tareLbs || data.tare_lbs;
    const humanVerified = data.humanVerified || data.human_verified;
    const diversionRate = data.diversionRate || data.diversion_pct;
    const materials = data.materials || {
        wood: data.wood_pct || 0,
        concrete: data.concrete_pct || 0,
        metal: data.metal_pct || 0,
        cardboard: data.cardboard_pct || 0,
        plastic: data.plastic_pct || 0,
        drywall: data.drywall_pct || 0,
        landfill: data.landfill_pct || 0
    };
    
    // Required fields
    if (!projectId) errors.push('Project is required');
    if (!serviceDate) errors.push('Service date is required');
    
    // Weight validation
    if (document.getElementById('validateWeights')?.checked) {
        if (!grossLbs || grossLbs <= 0) errors.push('Gross weight is required');
        if (!tareLbs || tareLbs <= 0) errors.push('Tare weight is required');
        if (grossLbs && tareLbs && grossLbs <= tareLbs) {
            errors.push('Gross weight must be greater than tare weight');
        }
        if (grossLbs > 100000) warnings.push('Gross weight seems unusually high');
        if (tareLbs < 5000) warnings.push('Tare weight seems unusually low');
    }
    
    // Percentage validation
    if (document.getElementById('validatePercentages')?.checked && materials) {
        const total = Object.values(materials).reduce((s, v) => s + (v || 0), 0);
        if (Math.abs(total - 100) > 1) {
            errors.push(`Material percentages must total 100% (currently ${total}%)`);
        }
    }
    
    // Photo validation
    if (document.getElementById('requirePhotos')?.checked) {
        const photoCount = debrisPhotos.filter(p => p).length;
        if (photoCount === 0) errors.push('At least 1 debris photo is required');
    }
    
    // Verification validation
    if (document.getElementById('requireVerification')?.checked) {
        if (!humanVerified) errors.push('Human verification is required');
    }
    
    // Anomaly detection
    if (document.getElementById('flagAnomalies')?.checked) {
        if (diversionRate > 90) warnings.push('Diversion rate >90% is unusual - please verify');
        if (diversionRate < 30) warnings.push('Diversion rate <30% is below typical range');
    }
    
    return { valid: errors.length === 0, errors, warnings };
}

function showValidationErrors(errors, warnings) {
    let message = '';
    
    if (errors.length > 0) {
        message += '‚ùå Errors:\n' + errors.map(e => '‚Ä¢ ' + e).join('\n');
    }
    
    if (warnings.length > 0) {
        if (message) message += '\n\n';
        message += '‚ö†Ô∏è Warnings:\n' + warnings.map(w => '‚Ä¢ ' + w).join('\n');
    }
    
    if (errors.length > 0) {
        alert(message);
        return false;
    }
    
    if (warnings.length > 0) {
        return confirm(message + '\n\nProceed anyway?');
    }
    
    return true;
}

// ========== BACKUP & RESTORE ==========
async function createFullBackup() {
    showLoading('Creating backup...');
    
    try {
        const backup = {
            version: '7.6',
            createdAt: new Date().toISOString(),
            app: 'DivertScan Box Tracker',
            settings: {
                leedVersion: currentLeedVersion,
                companyInfo: companyInfo
            },
            projects: [],
            tickets: []
        };
        
        // Get all projects with timeout
        if (sb) {
            try {
                const pPromise = sb.from('projects').select('*');
                const pTimeout = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
                const pResult = await Promise.race([pPromise, pTimeout]);
                if (pResult?.data) backup.projects = pResult.data;
            } catch (e) { console.log('Supabase projects skipped:', e.message); }
            
            try {
                const tPromise = sb.from('tickets').select('*');
                const tTimeout = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 8000));
                const tResult = await Promise.race([tPromise, tTimeout]);
                if (tResult?.data) backup.tickets = tResult.data;
            } catch (e) { console.log('Supabase tickets skipped:', e.message); }
        }
        
        // Also include local data
        try {
            backup.localProjects = await getAllFromLocal('projects') || [];
            backup.localTickets = await getAllFromLocal('tickets') || [];
        } catch (e) { console.log('Local data read error:', e.message); }
        
        // Download backup file ‚Äî use application/octet-stream for iPad Safari compat
        const jsonStr = JSON.stringify(backup, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/octet-stream' });
        const url = URL.createObjectURL(blob);
        const filename = 'DivertScan_Backup_' + new Date().toISOString().split('T')[0] + '.json';
        
        // iPad Safari needs an actual link click with download attribute
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Cleanup after delay (iPad Safari needs time)
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 2000);
        
        // Update backup stats
        try {
            document.getElementById('backupProjectCount').textContent = (backup.projects.length + (backup.localProjects?.length || 0));
            document.getElementById('backupTicketCount').textContent = (backup.tickets.length + (backup.localTickets?.length || 0));
            document.getElementById('backupLastDate').textContent = new Date().toLocaleDateString();
            localStorage.setItem('divertscan_last_backup', new Date().toISOString());
        } catch (e) {}
        
        hideLoading();
        toast('Backup created! (' + (backup.projects.length + backup.tickets.length) + ' records)', 'success');
        
    } catch (err) {
        hideLoading();
        toast('Backup failed: ' + err.message, 'error');
    }
}

async function restoreFromBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!confirm('This will replace all current data. Are you sure?')) {
        event.target.value = '';
        return;
    }
    
    showLoading('Restoring backup...');
    
    try {
        const text = await file.text();
        const backup = JSON.parse(text);
        
        if (!backup.version || !backup.projects) {
            throw new Error('Invalid backup file format');
        }
        
        // Restore settings
        if (backup.settings) {
            if (backup.settings.companyInfo) {
                companyInfo = backup.settings.companyInfo;
                localStorage.setItem('divertscan_company', JSON.stringify(companyInfo));
            }
            if (backup.settings.leedVersion) {
                localStorage.setItem('divertscan_leed_version', backup.settings.leedVersion);
            }
        }
        
        // Restore to Supabase if connected
        if (sb) {
            // Delete existing and insert new
            for (const project of backup.projects) {
                await sb.from('projects').upsert([project]);
            }
            for (const ticket of backup.tickets) {
                await sb.from('tickets').upsert([ticket]);
            }
        }
        
        // Also save to IndexedDB
        for (const project of backup.projects) {
            await saveToLocal('projects', { ...project, synced: true });
        }
        for (const ticket of backup.tickets) {
            await saveToLocal('tickets', { ...ticket, synced: true });
        }
        
        hideLoading();
        toast(`Restored ${backup.projects.length} projects and ${backup.tickets.length} tickets!`, 'success');
        
        // Reload data
        await loadProjects();
        await loadRecentTickets();
        await updateStats();
        
    } catch (err) {
        hideLoading();
        toast('Restore failed: ' + err.message, 'error');
    }
    
    event.target.value = '';
}

function exportToCloud() {
    toast('Cloud backup coming soon! Use Export Backup for now.', 'info');
}

function clearLocalData() {
    if (!confirm('This will clear ALL local data including drafts. Are you sure?')) return;
    if (!confirm('This cannot be undone. Proceed?')) return;
    
    // Clear IndexedDB
    indexedDB.deleteDatabase(DB_NAME);
    
    // Clear localStorage (except connection info)
    const sbUrl = localStorage.getItem('divertscan_sb_url');
    const sbKey = localStorage.getItem('divertscan_sb_key');
    const apiKey = localStorage.getItem('divertscan_openai');
    
    localStorage.clear();
    
    if (sbUrl) localStorage.setItem('divertscan_sb_url', sbUrl);
    if (sbKey) localStorage.setItem('divertscan_sb_key', sbKey);
    if (apiKey) localStorage.setItem('divertscan_openai', apiKey);
    
    toast('Local data cleared!', 'success');
    location.reload();
}

// ========== REAL-TIME SUBSCRIPTIONS ==========
let subscriptions = [];

function setupRealtimeSync() {
    if (!sb) return;
    
    // Subscribe to projects changes
    const projectSub = sb
        .channel('projects-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, (payload) => {
            console.log('Project change:', payload);
            loadProjects();
            toast('Projects updated', 'info');
        })
        .subscribe();
    
    // Subscribe to tickets changes
    const ticketSub = sb
        .channel('tickets-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, (payload) => {
            console.log('Ticket change:', payload);
            loadRecentTickets();
            updateStats();
            toast('Tickets updated', 'info');
        })
        .subscribe();
    
    subscriptions.push(projectSub, ticketSub);
    console.log('Real-time subscriptions active');
}

// ========== LOCAL STORAGE STATS ==========
function updateLocalStorageStats() {
    let total = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            total += localStorage[key].length * 2; // UTF-16
        }
    }
    
    const el = document.getElementById('localStorageUsed');
    if (el) {
        el.textContent = (total / 1024).toFixed(1) + ' KB';
    }
}

// ========== ENHANCED SAVE WITH OFFLINE SUPPORT ==========
async function saveTicketWithOfflineSupport(ticketRecord) {
    // Validate first
    const validation = validateTicketData(ticketRecord);
    if (!showValidationErrors(validation.errors, validation.warnings)) {
        return false;
    }
    
    // Generate local ID if needed
    if (!ticketRecord.id) {
        ticketRecord.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // Always save locally first
    ticketRecord.synced = false;
    await saveToLocal('tickets', ticketRecord);
    
    // Try to save to Supabase if online
    if (isOnline && sb) {
        try {
            // Remove local ID prefix if present
            const remoteRecord = { ...ticketRecord };
            if (remoteRecord.id.startsWith('local_')) {
                delete remoteRecord.id;
            }
            delete remoteRecord.synced;
            
            const sbPromise = sb.from('tickets').insert([remoteRecord]).select();
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Supabase timeout')), 5000)
            );
            const { data, error } = await Promise.race([sbPromise, timeoutPromise]);
            
            if (error) throw error;
            
            // Update local with real ID
            if (data && data[0]) {
                await deleteFromLocal('tickets', ticketRecord.id);
                ticketRecord.id = data[0].id;
                ticketRecord.synced = true;
                await saveToLocal('tickets', ticketRecord);
            }
            
            return true;
        } catch (err) {
            console.error('Remote save failed, queued for sync:', err);
            await addToSyncQueue('insert', 'tickets', ticketRecord);
            toast('Saved locally - will sync when online', 'warning');
            return true;
        }
    } else {
        // Queue for later sync
        await addToSyncQueue('insert', 'tickets', ticketRecord);
        toast('Saved offline - will sync when online', 'warning');
        return true;
    }
}

// ========== TOGGLE OFFLINE MODE ==========
function toggleOfflineMode() {
    const enabled = document.getElementById('enableOfflineMode')?.checked;
    localStorage.setItem('divertscan_offline_enabled', enabled ? 'true' : 'false');
    
    if (enabled) {
        initIndexedDB();
        toast('Offline mode enabled', 'success');
    } else {
        toast('Offline mode disabled - requires internet', 'warning');
    }
}

// ========== COMPANY BRANDING ==========
function saveCompanyBranding() {
    companyInfo = {
        name: document.getElementById('companyNameInput')?.value || 'DalMex Recycling LLC',
        address: document.getElementById('companyAddressInput')?.value || '',
        phone: document.getElementById('companyPhoneInput')?.value || ''
    };
    localStorage.setItem('divertscan_company', JSON.stringify(companyInfo));
    toast('Company branding saved!', 'success');
}

// ========== INITIALIZE BULLETPROOF FEATURES ==========
async function initBulletproof() {
    // Load saved theme first (before anything visual)
    loadSavedTheme();
    
    // Initialize IndexedDB
    try {
        await initIndexedDB();
        console.log('IndexedDB ready');
    } catch (err) {
        console.error('IndexedDB failed:', err);
    }
    
    // Check online status
    updateOnlineStatus();
    
    // Start autosave
    startAutosave();
    
    // Update local storage stats
    updateLocalStorageStats();
    
    // Load LEED settings
    const savedLeedVersion = localStorage.getItem('divertscan_leed_version');
    if (savedLeedVersion && document.getElementById('leedVersion')) {
        document.getElementById('leedVersion').value = savedLeedVersion;
        updateLeedRules();
    }
    
    // Load backup stats
    const lastBackup = localStorage.getItem('divertscan_last_backup');
    if (lastBackup) {
        const el = document.getElementById('backupLastDate');
        if (el) el.textContent = new Date(lastBackup).toLocaleDateString();
    }
    
    // Update sync status
    pendingSyncItems = await getAllFromLocal('syncQueue');
    updateSyncStatus();
    
    // Setup real-time sync when connected
    if (sb) {
        setupRealtimeSync();
    }
    
    // Check for draft on startup
    checkForDraft();
    
    console.log('DivertScan v7.2 Enhanced initialized');
}

// Override initial app load to check session first
window.onload = async function() {
    // Load company info
    const savedCompany = localStorage.getItem('divertscan_company');
    if (savedCompany) {
        try { companyInfo = JSON.parse(savedCompany); } catch(e) {}
    }
    
    // Ensure keys are restored before doing anything
    await restoreAllKeys();
    
    // Initialize bulletproof features
    await initBulletproof();
    
    // Check for existing session ‚Äî if found, skip login screen
    if (!checkExistingSession()) {
        // No session ‚Äî stay on login screen, make sure it's visible
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('appContainer').classList.remove('active');
        console.log('No session found ‚Äî showing login screen');
    }
};
</script>

</div><!-- End app-container -->

<!-- Navigation bars OUTSIDE app-container for reliable position:fixed on iPad Safari -->
<nav class="nav" id="adminNav">
<div class="nav-item active" onclick="showTab('dashboard')">üè†<span>Home</span></div>
<div class="nav-item" onclick="showTab('projects')">üìÅ<span>Projects</span></div>
<div class="nav-item" onclick="showTab('reports')">üìä<span>Reports</span></div>
<div class="nav-item admin-only" onclick="showTab('settings')">‚öôÔ∏è<span>Settings</span></div>
</nav>

<nav class="nav hidden" id="customerNav">
<div class="nav-item active" onclick="showTab('dashboard')">üè†<span>Dashboard</span></div>
<div class="nav-item" onclick="showTab('reports')">üìä<span>Reports</span></div>
</nav>

</body>
</html>
