<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>DivertScan‚Ñ¢ | LEED v5 Carbon Auditor</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2310b981' rx='20' width='100' height='100'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>‚ôª</text></svg>">
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        :root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--emerald-500:#10b981;--emerald-400:#34d399;--emerald-600:#059669;--sky-500:#0ea5e9;--sky-400:#38bdf8;--amber-500:#f59e0b;--amber-600:#d97706;--red-500:#ef4444;--purple-500:#8b5cf6;--purple-600:#7c3aed}
        html{font-family:system-ui,-apple-system,sans-serif;background:var(--slate-900);min-height:100vh}
        body{min-height:100vh;color:#fff}
        .hidden{display:none!important}
        
        .auth-screen{min-height:100vh;padding:24px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--slate-900),var(--slate-800))}
        .auth-card{background:rgba(30,41,59,0.9);border-radius:20px;padding:32px;width:100%;max-width:380px;border:1px solid var(--slate-700)}
        .auth-logo{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px}
        .auth-logo-icon{width:48px;height:48px;background:var(--emerald-500);border-radius:12px;display:flex;align-items:center;justify-content:center}
        .auth-logo-icon svg{width:28px;height:28px;color:#fff}
        .auth-logo-text{font-size:26px;font-weight:700}
        .auth-tagline{text-align:center;color:var(--emerald-400);font-size:13px;margin-bottom:28px}
        .auth-title{font-size:20px;font-weight:600;text-align:center;margin-bottom:20px}
        .auth-error{background:rgba(239,68,68,0.2);border:1px solid var(--red-500);color:#f87171;padding:12px;border-radius:8px;font-size:14px;margin-bottom:16px;display:none}
        .auth-error.show{display:block}
        .auth-switch{text-align:center;margin-top:20px;color:var(--slate-400);font-size:14px}
        .auth-switch a{color:var(--emerald-400);text-decoration:underline;cursor:pointer}
        
        .form-group{margin-bottom:16px}
        .form-label{display:block;color:var(--slate-400);font-size:12px;font-weight:500;margin-bottom:6px}
        .form-input{width:100%;padding:14px 16px;background:var(--slate-800);border:1px solid var(--slate-600);border-radius:10px;color:#fff;font-size:16px;outline:none}
        .form-input:focus{border-color:var(--emerald-500)}
        .form-input::placeholder{color:var(--slate-500)}
        select.form-input{cursor:pointer}
        
        .btn{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;font-size:15px;cursor:pointer;margin-top:12px}
        .btn-primary{background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600));color:#fff}
        .btn-primary:disabled{opacity:0.5}
        .btn-secondary{background:transparent;border:1px solid var(--slate-600);color:var(--slate-300)}
        
        .app{display:none;min-height:100vh;background:var(--slate-900)}
        .app.active{display:block}
        
        .nav{background:rgba(15,23,42,0.95);border-bottom:1px solid var(--slate-700);padding:12px 16px;position:sticky;top:0;z-index:100}
        .nav-content{display:flex;align-items:center;justify-content:space-between;max-width:1000px;margin:0 auto}
        .nav-brand{display:flex;align-items:center;gap:8px}
        .nav-logo{width:32px;height:32px;background:var(--emerald-500);border-radius:8px;display:flex;align-items:center;justify-content:center}
        .nav-logo svg{width:18px;height:18px;color:#fff}
        .nav-title{font-size:17px;font-weight:700}
        .nav-user{color:var(--slate-400);font-size:13px}
        .nav-signout{background:none;border:none;color:var(--slate-400);font-size:13px;cursor:pointer;padding:8px}
        .nav-signout:hover{color:var(--red-500)}
        
        .project-bar{background:var(--slate-800);padding:12px 16px;border-bottom:1px solid var(--slate-700)}
        .project-bar-content{max-width:1000px;margin:0 auto}
        .project-selector{width:100%;padding:10px 12px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:#fff;font-size:14px}
        
        .tabs{display:flex;gap:4px;padding:12px 16px;background:var(--slate-800);overflow-x:auto;border-bottom:1px solid var(--slate-700)}
        .tabs-content{max-width:1000px;margin:0 auto;display:flex;gap:4px}
        .tab{padding:10px 16px;border:none;border-radius:8px;background:transparent;color:var(--slate-400);font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap}
        .tab.active{background:var(--emerald-500);color:#fff}
        
        .main{padding:16px;max-width:1000px;margin:0 auto}
        .page{display:none}
        .page.active{display:block}
        
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .stat-card{background:var(--slate-800);border-radius:12px;padding:16px;border:1px solid var(--slate-700)}
        .stat-label{font-size:11px;color:var(--slate-500);text-transform:uppercase;margin-bottom:4px}
        .stat-value{font-size:22px;font-weight:700}
        .stat-value.emerald{color:var(--emerald-400)}
        .stat-value.sky{color:var(--sky-400)}
        .stat-value.amber{color:var(--amber-500)}
        .stat-value.purple{color:var(--purple-500)}
        
        .card{background:var(--slate-800);border-radius:14px;padding:18px;margin-bottom:16px;border:1px solid var(--slate-700)}
        .card-title{font-size:15px;font-weight:600;margin-bottom:14px;color:var(--slate-300)}
        
        .action-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .action-btn{border:none;padding:20px 16px;border-radius:14px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:10px;color:#fff;font-weight:600;font-size:13px}
        .action-btn svg{width:28px;height:28px}
        .action-btn.scan{background:linear-gradient(135deg,var(--emerald-500),var(--emerald-600))}
        .action-btn.upload{background:linear-gradient(135deg,var(--amber-500),var(--amber-600))}
        .action-btn.report{background:linear-gradient(135deg,var(--sky-500),#0284c7)}
        .action-btn.add{background:linear-gradient(135deg,var(--purple-500),var(--purple-600))}
        
        .list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--slate-900);border-radius:10px;margin-bottom:8px;border:1px solid var(--slate-700)}
        .list-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .list-icon svg{width:18px;height:18px}
        .list-icon.emerald{background:rgba(16,185,129,0.2);color:var(--emerald-400)}
        .list-icon.sky{background:rgba(14,165,233,0.2);color:var(--sky-400)}
        .list-icon.purple{background:rgba(139,92,246,0.2);color:var(--purple-500)}
        .list-content{flex:1;min-width:0}
        .list-title{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .list-subtitle{font-size:12px;color:var(--slate-500)}
        .list-meta{text-align:right}
        .list-value{font-weight:700;font-size:14px;color:var(--emerald-400)}
        .list-label{font-size:11px;color:var(--slate-500)}
        
        .empty{text-align:center;padding:30px;color:var(--slate-500)}
        
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:1000;padding:16px}
        .modal-bg.show{display:flex}
        .modal{background:var(--slate-800);border-radius:16px;padding:24px;max-width:440px;width:100%;max-height:85vh;overflow-y:auto;border:1px solid var(--slate-700)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:18px;font-weight:700}
        .modal-close{background:var(--slate-700);border:none;width:32px;height:32px;border-radius:8px;color:var(--slate-400);cursor:pointer;font-size:18px}
        
        .scan-preview{text-align:center;margin-bottom:16px}
        .scan-preview img{max-width:100%;max-height:180px;border-radius:10px}
        .scan-status{color:var(--sky-400);font-size:14px;margin-top:10px}
        .scan-result{margin-top:16px}
        .scan-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--slate-700)}
        .scan-row:last-child{border-bottom:none}
        .scan-label{color:var(--slate-400);font-size:13px}
        .scan-value{font-weight:600;font-size:14px}
        
        .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--slate-800);border:1px solid var(--slate-600);padding:12px 20px;border-radius:10px;font-size:14px;z-index:2000;opacity:0;transition:all 0.3s}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{border-color:var(--emerald-500);color:var(--emerald-400)}
        .toast.error{border-color:var(--red-500);color:var(--red-500)}
        
        .footer{text-align:center;padding:20px;color:var(--slate-600);font-size:11px}
        
        #cameraInput,#fileInput{display:none}
    </style>
</head>
<body>
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="auth-logo-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></div>
                <span class="auth-logo-text">DivertScan‚Ñ¢</span>
            </div>
            <p class="auth-tagline">LEED v5 MRp2 Carbon Auditor</p>
            <h2 class="auth-title" id="authTitle">Sign In</h2>
            <div class="auth-error" id="authError"></div>
            <div class="form-group hidden" id="nameGroup">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="authName" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="authEmail" placeholder="you@company.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
            </div>
            <button type="button" class="btn btn-primary" id="authSubmit">Sign In</button>
            <p class="auth-switch"><span id="authSwitchText">Don't have an account?</span> <a id="authSwitchLink">Sign Up</a></p>
        </div>
    </div>

    <div class="app" id="mainApp">
        <input type="file" id="cameraInput" accept="image/*" capture="environment">
        <input type="file" id="fileInput" accept="image/*">
        
        <nav class="nav">
            <div class="nav-content">
                <div class="nav-brand">
                    <div class="nav-logo"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></div>
                    <span class="nav-title">DivertScan‚Ñ¢</span>
                </div>
                <div>
                    <span class="nav-user" id="navUser"></span>
                    <button class="nav-signout" id="signOutBtn">Sign Out</button>
                </div>
            </div>
        </nav>
        
        <div class="project-bar">
            <div class="project-bar-content">
                <select class="project-selector" id="projectSelector"><option value="">Select Project...</option></select>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tabs-content">
                <button class="tab active" data-page="dashboard">Dashboard</button>
                <button class="tab" data-page="scans">Scans</button>
                <button class="tab" data-page="projects">Projects</button>
                <button class="tab" data-page="customers">Customers</button>
                <button class="tab" data-page="settings">Settings</button>
            </div>
        </div>
        
        <main class="main">
            <div class="page active" id="page-dashboard">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total CO‚ÇÇe</div><div class="stat-value emerald" id="statCO2">0.00</div></div>
                    <div class="stat-card"><div class="stat-label">Total Weight</div><div class="stat-value sky" id="statWeight">0 T</div></div>
                    <div class="stat-card"><div class="stat-label">Scans</div><div class="stat-value amber" id="statScans">0</div></div>
                    <div class="stat-card"><div class="stat-label">Diversion</div><div class="stat-value purple" id="statDiversion">75%</div></div>
                </div>
                
                <div class="action-grid">
                    <button class="action-btn scan" id="btnCamera"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Camera Scan</button>
                    <button class="action-btn upload" id="btnUpload"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Upload File</button>
                </div>
                <div class="action-grid">
                    <button class="action-btn report" id="btnReport" style="grid-column:span 2"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Generate LEED Report</button>
                </div>
                
                <div class="card">
                    <div class="card-title">Recent Scans</div>
                    <div id="recentScans"><div class="empty">No scans yet</div></div>
                </div>
            </div>
            
            <div class="page" id="page-scans">
                <div class="card">
                    <div class="card-title">All Scans</div>
                    <div id="allScans"><div class="empty">No scans</div></div>
                </div>
            </div>
            
            <div class="page" id="page-projects">
                <div class="action-grid" style="margin-bottom:16px">
                    <button class="action-btn add" id="btnNewProject" style="grid-column:span 2"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>New Project</button>
                </div>
                <div class="card">
                    <div class="card-title">All Projects</div>
                    <div id="projectsList"><div class="empty">No projects</div></div>
                </div>
            </div>
            
            <div class="page" id="page-customers">
                <div class="action-grid" style="margin-bottom:16px">
                    <button class="action-btn add" id="btnNewCustomer" style="grid-column:span 2"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>New Customer</button>
                </div>
                <div class="card">
                    <div class="card-title">All Customers</div>
                    <div id="customersList"><div class="empty">No customers</div></div>
                </div>
            </div>
            
            <div class="page" id="page-settings">
                <div class="card">
                    <div class="card-title">OpenAI API Key</div>
                    <div class="form-group">
                        <input type="password" class="form-input" id="apiKeyInput" placeholder="sk-...">
                    </div>
                    <button type="button" class="btn btn-primary" id="saveApiKey">Save API Key</button>
                </div>
                <div class="card">
                    <div class="card-title">Organization</div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="orgNameInput" placeholder="Organization name">
                    </div>
                    <button type="button" class="btn btn-primary" id="saveOrg">Save</button>
                </div>
            </div>
        </main>
        <div class="footer">DivertScan‚Ñ¢ ¬© 2025 Dalmex Recycling LLC</div>
    </div>

    <!-- Modals -->
    <div class="modal-bg" id="scanModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="scanModalTitle">Analyzing...</span>
                <button class="modal-close" id="closeScanModal">√ó</button>
            </div>
            <div class="scan-preview" id="scanPreview"></div>
            <div class="scan-status" id="scanStatus">üîç Analyzing with GPT-4 Vision...</div>
            <div class="scan-result hidden" id="scanResult">
                <div class="scan-row"><span class="scan-label">Material</span><span class="scan-value" id="resMaterial">-</span></div>
                <div class="scan-row"><span class="scan-label">Weight</span><span class="scan-value" id="resWeight">-</span></div>
                <div class="scan-row"><span class="scan-label">Hauler</span><span class="scan-value" id="resHauler">-</span></div>
                <div class="scan-row"><span class="scan-label">Date</span><span class="scan-value" id="resDate">-</span></div>
                <div class="scan-row"><span class="scan-label">Ticket #</span><span class="scan-value" id="resTicket">-</span></div>
                <div class="scan-row"><span class="scan-label">CO‚ÇÇe</span><span class="scan-value" id="resCO2" style="color:var(--emerald-400)">-</span></div>
            </div>
            <button type="button" class="btn btn-primary hidden" id="saveScanBtn">‚úì Save Scan</button>
            <button type="button" class="btn btn-secondary" id="cancelScanBtn">Cancel</button>
        </div>
    </div>

    <div class="modal-bg" id="projectModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">New Project</span>
                <button class="modal-close" id="closeProjectModal">√ó</button>
            </div>
            <div class="form-group"><label class="form-label">Project Name *</label><input type="text" class="form-input" id="projName"></div>
            <div class="form-group"><label class="form-label">Customer</label><select class="form-input" id="projCustomer"><option value="">Select...</option></select></div>
            <div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="projAddress"></div>
            <div class="form-group"><label class="form-label">City</label><input type="text" class="form-input" id="projCity"></div>
            <div class="form-group"><label class="form-label">State</label><input type="text" class="form-input" id="projState"></div>
            <div class="form-group"><label class="form-label">LEED Target</label><select class="form-input" id="projLeed"><option>Certified</option><option>Silver</option><option selected>Gold</option><option>Platinum</option></select></div>
            <div class="form-group"><label class="form-label">CO‚ÇÇe Target (MT)</label><input type="number" class="form-input" id="projCO2" value="8000"></div>
            <button type="button" class="btn btn-primary" id="saveProjectBtn">Create Project</button>
        </div>
    </div>

    <div class="modal-bg" id="customerModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">New Customer</span>
                <button class="modal-close" id="closeCustomerModal">√ó</button>
            </div>
            <div class="form-group"><label class="form-label">Name *</label><input type="text" class="form-input" id="custName"></div>
            <div class="form-group"><label class="form-label">Company</label><input type="text" class="form-input" id="custCompany"></div>
            <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="custEmail"></div>
            <div class="form-group"><label class="form-label">Phone</label><input type="tel" class="form-input" id="custPhone"></div>
            <button type="button" class="btn btn-primary" id="saveCustomerBtn">Create Customer</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
var SUPABASE_URL = 'https://cyvvlngtojagfoaitoog.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g';
var EMISSION_FACTORS = {concrete:0.159,steel:1.85,aluminum:11.89,wood:0.03,drywall:0.12,asphalt:0.05,glass:0.85,plastic:2.5,cardboard:0.94,'mixed c&d':0.15};

var supabase, currentUser, currentOrg, currentProject, currentScan;
var OPENAI_KEY = localStorage.getItem('divertscan_openai') || '';

function toast(msg, type) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type || '') + ' show';
    setTimeout(function() { t.classList.remove('show'); }, 3000);
}

function loadSupabase(cb) {
    var s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    s.onload = cb;
    document.head.appendChild(s);
}

function init() {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    supabase.auth.getSession().then(function(r) {
        if (r.data.session) {
            currentUser = r.data.session.user;
            showApp();
        }
    });
    setupEvents();
}

function showAuth() {
    document.getElementById('authScreen').classList.remove('hidden');
    document.getElementById('mainApp').classList.remove('active');
}

function showApp() {
    document.getElementById('authScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('active');
    document.getElementById('navUser').textContent = currentUser.email;
    loadUserData();
}

function setupEvents() {
    var isSignUp = false;
    
    document.getElementById('authSwitchLink').onclick = function() {
        isSignUp = !isSignUp;
        document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Sign In';
        document.getElementById('authSubmit').textContent = isSignUp ? 'Sign Up' : 'Sign In';
        document.getElementById('authSwitchText').textContent = isSignUp ? 'Have an account?' : "Don't have an account?";
        document.getElementById('authSwitchLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
        document.getElementById('nameGroup').classList.toggle('hidden', !isSignUp);
    };
    
    document.getElementById('authSubmit').onclick = function() {
        var email = document.getElementById('authEmail').value.trim();
        var pass = document.getElementById('authPassword').value;
        var name = document.getElementById('authName').value.trim();
        var btn = document.getElementById('authSubmit');
        var err = document.getElementById('authError');
        
        if (!email || !pass) { err.textContent = 'Enter email and password'; err.classList.add('show'); return; }
        if (pass.length < 6) { err.textContent = 'Password min 6 characters'; err.classList.add('show'); return; }
        
        err.classList.remove('show');
        btn.disabled = true;
        btn.textContent = isSignUp ? 'Creating...' : 'Signing in...';
        
        if (isSignUp) {
            supabase.auth.signUp({ email: email, password: pass, options: { data: { full_name: name } } }).then(function(r) {
                if (r.error) { err.textContent = r.error.message; err.classList.add('show'); }
                else if (r.data.user) {
                    currentUser = r.data.user;
                    createOrg(name || 'My Organization');
                    showApp();
                    toast('Account created!', 'success');
                }
                btn.disabled = false;
                btn.textContent = 'Sign Up';
            });
        } else {
            supabase.auth.signInWithPassword({ email: email, password: pass }).then(function(r) {
                if (r.error) { err.textContent = r.error.message; err.classList.add('show'); }
                else { currentUser = r.data.user; showApp(); toast('Welcome back!', 'success'); }
                btn.disabled = false;
                btn.textContent = 'Sign In';
            });
        }
    };
    
    document.getElementById('signOutBtn').onclick = function() {
        supabase.auth.signOut();
        currentUser = currentOrg = currentProject = null;
        showAuth();
    };
    
    document.querySelectorAll('.tab').forEach(function(t) {
        t.onclick = function() {
            document.querySelectorAll('.tab').forEach(function(x) { x.classList.remove('active'); });
            document.querySelectorAll('.page').forEach(function(x) { x.classList.remove('active'); });
            t.classList.add('active');
            document.getElementById('page-' + t.dataset.page).classList.add('active');
        };
    });
    
    document.getElementById('projectSelector').onchange = function() {
        var id = this.value;
        if (!id) { currentProject = null; return; }
        supabase.from('projects').select('*').eq('id', id).single().then(function(r) {
            currentProject = r.data;
            loadScans();
        });
    };
    
    document.getElementById('btnCamera').onclick = function() { if (checkReady()) document.getElementById('cameraInput').click(); };
    document.getElementById('btnUpload').onclick = function() { if (checkReady()) document.getElementById('fileInput').click(); };
    document.getElementById('cameraInput').onchange = handleFile;
    document.getElementById('fileInput').onchange = handleFile;
    
    document.getElementById('btnReport').onclick = generateReport;
    document.getElementById('btnNewProject').onclick = function() { document.getElementById('projectModal').classList.add('show'); };
    document.getElementById('btnNewCustomer').onclick = function() { document.getElementById('customerModal').classList.add('show'); };
    
    document.getElementById('closeScanModal').onclick = function() { document.getElementById('scanModal').classList.remove('show'); };
    document.getElementById('cancelScanBtn').onclick = function() { document.getElementById('scanModal').classList.remove('show'); };
    document.getElementById('closeProjectModal').onclick = function() { document.getElementById('projectModal').classList.remove('show'); };
    document.getElementById('closeCustomerModal').onclick = function() { document.getElementById('customerModal').classList.remove('show'); };
    
    document.getElementById('saveScanBtn').onclick = saveScan;
    document.getElementById('saveProjectBtn').onclick = saveProject;
    document.getElementById('saveCustomerBtn').onclick = saveCustomer;
    document.getElementById('saveApiKey').onclick = function() {
        var k = document.getElementById('apiKeyInput').value;
        if (k) { OPENAI_KEY = k; localStorage.setItem('divertscan_openai', k); toast('API key saved', 'success'); }
    };
    document.getElementById('saveOrg').onclick = function() {
        var n = document.getElementById('orgNameInput').value;
        if (n && currentOrg) {
            supabase.from('organizations').update({ name: n }).eq('id', currentOrg.id);
            toast('Saved', 'success');
        }
    };
    
    if (OPENAI_KEY) document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
}

function checkReady() {
    if (!OPENAI_KEY) { toast('Add OpenAI key in Settings', 'error'); return false; }
    if (!currentProject) { toast('Select a project first', 'error'); return false; }
    return true;
}

function createOrg(name) {
    supabase.from('organizations').insert({ name: name, slug: currentUser.id.substring(0,8) }).select().single().then(function(r) {
        if (r.data) {
            currentOrg = r.data;
            supabase.from('users').update({ organization_id: r.data.id, role: 'admin' }).eq('id', currentUser.id);
        }
    });
}

function loadUserData() {
    supabase.from('users').select('*, organizations(*)').eq('id', currentUser.id).single().then(function(r) {
        if (r.data && r.data.organizations) {
            currentOrg = r.data.organizations;
            document.getElementById('orgNameInput').value = currentOrg.name;
            loadProjects();
            loadCustomers();
        }
    });
}

function loadProjects() {
    if (!currentOrg) return;
    supabase.from('projects').select('*, customers(name)').eq('organization_id', currentOrg.id).order('created_at', { ascending: false }).then(function(r) {
        var sel = document.getElementById('projectSelector');
        var list = document.getElementById('projectsList');
        sel.innerHTML = '<option value="">Select Project...</option>';
        if (r.data && r.data.length) {
            r.data.forEach(function(p) {
                sel.innerHTML += '<option value="' + p.id + '">' + p.name + '</option>';
            });
            list.innerHTML = r.data.map(function(p) {
                return '<div class="list-item"><div class="list-icon sky"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></div><div class="list-content"><div class="list-title">' + p.name + '</div><div class="list-subtitle">' + (p.customers ? p.customers.name : 'No customer') + '</div></div></div>';
            }).join('');
            if (!currentProject) { sel.value = r.data[0].id; sel.onchange(); }
        } else {
            list.innerHTML = '<div class="empty">No projects</div>';
        }
    });
}

function loadCustomers() {
    if (!currentOrg) return;
    supabase.from('customers').select('*').eq('organization_id', currentOrg.id).order('name').then(function(r) {
        var sel = document.getElementById('projCustomer');
        var list = document.getElementById('customersList');
        sel.innerHTML = '<option value="">Select...</option>';
        if (r.data && r.data.length) {
            r.data.forEach(function(c) { sel.innerHTML += '<option value="' + c.id + '">' + c.name + '</option>'; });
            list.innerHTML = r.data.map(function(c) {
                return '<div class="list-item"><div class="list-icon purple"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div><div class="list-content"><div class="list-title">' + c.name + '</div><div class="list-subtitle">' + (c.company || '') + '</div></div></div>';
            }).join('');
        } else {
            list.innerHTML = '<div class="empty">No customers</div>';
        }
    });
}

function loadScans() {
    if (!currentProject) return;
    supabase.from('scans').select('*').eq('project_id', currentProject.id).order('created_at', { ascending: false }).then(function(r) {
        var recent = document.getElementById('recentScans');
        var all = document.getElementById('allScans');
        if (r.data && r.data.length) {
            var html = r.data.map(function(s) {
                return '<div class="list-item"><div class="list-icon emerald"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="list-content"><div class="list-title">' + (s.material_name || 'Unknown') + '</div><div class="list-subtitle">' + (s.weight_tons || 0) + ' tons</div></div><div class="list-meta"><div class="list-value">+' + (s.co2e_mt || 0).toFixed(2) + '</div><div class="list-label">MT CO‚ÇÇe</div></div></div>';
            }).join('');
            recent.innerHTML = r.data.slice(0,5).map(function(s) {
                return '<div class="list-item"><div class="list-icon emerald"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="list-content"><div class="list-title">' + (s.material_name || 'Unknown') + '</div><div class="list-subtitle">' + (s.weight_tons || 0) + ' tons</div></div><div class="list-meta"><div class="list-value">+' + (s.co2e_mt || 0).toFixed(2) + '</div><div class="list-label">MT CO‚ÇÇe</div></div></div>';
            }).join('');
            all.innerHTML = html;
            updateStats(r.data);
        } else {
            recent.innerHTML = '<div class="empty">No scans yet</div>';
            all.innerHTML = '<div class="empty">No scans</div>';
            updateStats([]);
        }
    });
}

function updateStats(scans) {
    var co2 = 0, wt = 0;
    scans.forEach(function(s) { co2 += s.co2e_mt || 0; wt += s.weight_tons || 0; });
    document.getElementById('statCO2').textContent = co2.toFixed(2);
    document.getElementById('statWeight').textContent = wt.toFixed(1) + ' T';
    document.getElementById('statScans').textContent = scans.length;
}

function handleFile(e) {
    var file = e.target.files[0];
    if (!file) return;
    e.target.value = '';
    
    document.getElementById('scanModal').classList.add('show');
    document.getElementById('scanModalTitle').textContent = 'Analyzing...';
    document.getElementById('scanStatus').textContent = 'üîç Analyzing with GPT-4 Vision...';
    document.getElementById('scanStatus').classList.remove('hidden');
    document.getElementById('scanResult').classList.add('hidden');
    document.getElementById('saveScanBtn').classList.add('hidden');
    
    var reader = new FileReader();
    reader.onload = function(ev) {
        document.getElementById('scanPreview').innerHTML = '<img src="' + ev.target.result + '">';
        var base64 = ev.target.result.split(',')[1];
        analyzeImage(base64);
    };
    reader.readAsDataURL(file);
}

function analyzeImage(base64) {
    var prompt = 'Analyze this scale ticket. Return ONLY JSON: {"material":"type","weight_tons":number,"hauler":"name","date":"YYYY-MM-DD","ticket_number":"string"}';
    
    fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + OPENAI_KEY },
        body: JSON.stringify({
            model: 'gpt-4o',
            messages: [{ role: 'user', content: [{ type: 'text', text: prompt }, { type: 'image_url', image_url: { url: 'data:image/jpeg;base64,' + base64 } }] }],
            max_tokens: 500
        })
    }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.error) throw new Error(data.error.message);
        var match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
        if (!match) throw new Error('Could not parse response');
        currentScan = JSON.parse(match[0]);
        showScanResult();
    }).catch(function(err) {
        document.getElementById('scanStatus').textContent = '‚ùå ' + err.message;
    });
}

function showScanResult() {
    var mat = (currentScan.material || 'mixed c&d').toLowerCase();
    var wt = currentScan.weight_tons || 0;
    var ef = EMISSION_FACTORS[mat] || 0.15;
    currentScan.co2e = wt * ef;
    currentScan.ef = ef;
    
    document.getElementById('scanModalTitle').textContent = '‚úì Ticket Scanned';
    document.getElementById('scanStatus').classList.add('hidden');
    document.getElementById('scanResult').classList.remove('hidden');
    document.getElementById('saveScanBtn').classList.remove('hidden');
    
    document.getElementById('resMaterial').textContent = currentScan.material || 'Unknown';
    document.getElementById('resWeight').textContent = wt + ' tons';
    document.getElementById('resHauler').textContent = currentScan.hauler || 'Unknown';
    document.getElementById('resDate').textContent = currentScan.date || new Date().toISOString().split('T')[0];
    document.getElementById('resTicket').textContent = currentScan.ticket_number || 'N/A';
    document.getElementById('resCO2').textContent = '+' + currentScan.co2e.toFixed(2) + ' MT';
}

function saveScan() {
    if (!currentScan || !currentProject) return;
    supabase.from('scans').insert({
        organization_id: currentOrg.id,
        project_id: currentProject.id,
        ticket_number: currentScan.ticket_number,
        ticket_date: currentScan.date || new Date().toISOString().split('T')[0],
        material_name: currentScan.material,
        weight_tons: currentScan.weight_tons || 0,
        co2e_mt: currentScan.co2e,
        emission_factor_used: currentScan.ef,
        hauler_name: currentScan.hauler,
        created_by: currentUser.id
    }).then(function(r) {
        if (r.error) { toast('Error: ' + r.error.message, 'error'); return; }
        document.getElementById('scanModal').classList.remove('show');
        loadScans();
        toast('Scan saved!', 'success');
    });
}

function saveProject() {
    var name = document.getElementById('projName').value.trim();
    if (!name) { toast('Enter project name', 'error'); return; }
    supabase.from('projects').insert({
        organization_id: currentOrg.id,
        name: name,
        customer_id: document.getElementById('projCustomer').value || null,
        address: document.getElementById('projAddress').value,
        city: document.getElementById('projCity').value,
        state: document.getElementById('projState').value,
        leed_certification_target: document.getElementById('projLeed').value,
        max_co2e_target: parseFloat(document.getElementById('projCO2').value) || 8000,
        created_by: currentUser.id
    }).select().single().then(function(r) {
        if (r.error) { toast('Error: ' + r.error.message, 'error'); return; }
        document.getElementById('projectModal').classList.remove('show');
        document.getElementById('projName').value = '';
        loadProjects();
        document.getElementById('projectSelector').value = r.data.id;
        currentProject = r.data;
        loadScans();
        toast('Project created!', 'success');
    });
}

function saveCustomer() {
    var name = document.getElementById('custName').value.trim();
    if (!name) { toast('Enter customer name', 'error'); return; }
    supabase.from('customers').insert({
        organization_id: currentOrg.id,
        name: name,
        company: document.getElementById('custCompany').value,
        email: document.getElementById('custEmail').value,
        phone: document.getElementById('custPhone').value,
        created_by: currentUser.id
    }).then(function(r) {
        if (r.error) { toast('Error: ' + r.error.message, 'error'); return; }
        document.getElementById('customerModal').classList.remove('show');
        document.getElementById('custName').value = '';
        loadCustomers();
        toast('Customer created!', 'success');
    });
}

function generateReport() {
    if (!currentProject) { toast('Select a project', 'error'); return; }
    supabase.from('scans').select('*').eq('project_id', currentProject.id).order('ticket_date').then(function(r) {
        var scans = r.data || [];
        var co2 = 0, wt = 0;
        scans.forEach(function(s) { co2 += s.co2e_mt || 0; wt += s.weight_tons || 0; });
        
        var txt = 'LEED v5 MRp2 Carbon Audit Report\n';
        txt += '='.repeat(40) + '\n';
        txt += 'Project: ' + currentProject.name + '\n';
        txt += 'Generated: ' + new Date().toLocaleString() + '\n\n';
        txt += 'SUMMARY\n-------\n';
        txt += 'Total CO‚ÇÇe: ' + co2.toFixed(2) + ' MT\n';
        txt += 'Total Weight: ' + wt.toFixed(2) + ' tons\n';
        txt += 'Scans: ' + scans.length + '\n\n';
        txt += 'SCAN LOG\n--------\n';
        scans.forEach(function(s) {
            txt += '[' + (s.ticket_date || 'N/A') + '] ' + (s.material_name || 'Unknown') + ' - ' + (s.weight_tons || 0) + 'T - ' + (s.co2e_mt || 0).toFixed(2) + ' MT\n';
        });
        txt += '\n' + '='.repeat(40) + '\nGenerated by DivertScan‚Ñ¢';
        
        var blob = new Blob([txt], { type: 'text/plain' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'DivertScan_Report_' + Date.now() + '.txt';
        a.click();
        toast('Report downloaded', 'success');
    });
}

loadSupabase(init);
    </script>
</body>
</html>
