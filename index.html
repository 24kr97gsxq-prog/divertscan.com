<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan‚Ñ¢ v2.2</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --emerald-500: #10b981;
            --emerald-400: #34d399;
            --amber-500: #f59e0b;
            --amber-400: #fbbf24;
            --red-500: #ef4444;
            --blue-500: #3b82f6;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--slate-900);
            color: var(--slate-300);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        /* Header */
        .header {
            background: var(--slate-800);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--slate-700);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 700;
            color: var(--emerald-400);
        }
        
        .logo span { color: var(--slate-400); font-weight: 400; font-size: 12px; }
        
        .header-actions { display: flex; gap: 12px; align-items: center; }
        
        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--slate-800);
            display: flex;
            justify-content: space-around;
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            border-top: 1px solid var(--slate-700);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 16px;
            color: var(--slate-500);
            text-decoration: none;
            font-size: 11px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .nav-item.active { color: var(--emerald-400); }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; }
        
        /* Tabs */
        .tab-content { display: none; padding: 16px; }
        .tab-content.active { display: block; }
        
        /* Cards */
        .card {
            background: var(--slate-800);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--slate-700);
        }
        
        .card-title {
            font-size: 14px;
            color: var(--slate-400);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-card {
            background: var(--slate-700);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--emerald-400);
        }
        
        .stat-label {
            font-size: 11px;
            color: var(--slate-400);
            margin-top: 4px;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            width: 100%;
        }
        
        .btn-primary {
            background: var(--emerald-500);
            color: white;
        }
        
        .btn-primary:hover { background: var(--emerald-400); }
        
        .btn-secondary {
            background: var(--slate-700);
            color: var(--slate-300);
        }
        
        .btn-secondary:hover { background: var(--slate-600); }
        
        .btn-lg { padding: 16px 24px; font-size: 16px; }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        
        .form-label {
            display: block;
            font-size: 12px;
            color: var(--slate-400);
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--slate-700);
            border: 1px solid var(--slate-600);
            border-radius: 8px;
            color: var(--slate-300);
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--emerald-500);
        }
        
        /* Material Grid */
        .material-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .material-item {
            background: var(--slate-700);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .material-name {
            font-size: 13px;
            color: var(--slate-300);
        }
        
        .material-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .material-input input {
            width: 50px;
            padding: 6px;
            background: var(--slate-800);
            border: 1px solid var(--slate-600);
            border-radius: 4px;
            color: var(--slate-300);
            font-size: 14px;
            text-align: right;
        }
        
        .material-input span {
            color: var(--slate-500);
            font-size: 12px;
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: var(--slate-700);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--emerald-500);
            transition: width 0.3s;
        }
        
        .progress-fill.warning { background: var(--amber-500); }
        .progress-fill.danger { background: var(--red-500); }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: var(--slate-800);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            border-radius: 16px 16px 0 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--slate-700);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--slate-200);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--slate-700);
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            font-size: 20px;
        }
        
        .modal-body {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--slate-700);
            display: flex;
            gap: 12px;
        }
        
        /* Steps */
        .steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--slate-700);
            color: var(--slate-500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .step.active {
            background: var(--emerald-500);
            color: white;
        }
        
        .step.complete {
            background: var(--emerald-500);
            color: white;
        }
        
        .step-line {
            width: 40px;
            height: 2px;
            background: var(--slate-700);
            align-self: center;
        }
        
        .step-line.complete { background: var(--emerald-500); }
        
        /* Image Preview */
        .image-preview {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--slate-700);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-500);
            font-size: 14px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .photo-slot {
            aspect-ratio: 1;
            background: var(--slate-700);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--slate-500);
            font-size: 24px;
            cursor: pointer;
            overflow: hidden;
            border: 2px dashed var(--slate-600);
        }
        
        .photo-slot.filled {
            border: 2px solid var(--emerald-500);
        }
        
        .photo-slot img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Analysis Result */
        .analysis-result {
            background: var(--slate-700);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .diversion-badge {
            font-size: 28px;
            font-weight: 700;
        }
        
        .diversion-badge.good { color: var(--emerald-400); }
        .diversion-badge.warning { color: var(--amber-400); }
        .diversion-badge.bad { color: var(--red-500); }
        
        .material-breakdown {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .material-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--slate-600);
        }
        
        .material-row:last-child { border-bottom: none; }
        
        .material-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .material-icon { font-size: 18px; }
        
        .material-values {
            text-align: right;
            font-size: 14px;
        }
        
        .material-pct { font-weight: 600; color: var(--slate-200); }
        .material-tons { color: var(--slate-400); font-size: 12px; }
        
        /* Ticket List */
        .ticket-list { display: flex; flex-direction: column; gap: 12px; }
        
        .ticket-item {
            background: var(--slate-700);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ticket-info h4 {
            color: var(--slate-200);
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .ticket-info p {
            color: var(--slate-400);
            font-size: 12px;
        }
        
        .ticket-stats {
            text-align: right;
        }
        
        .ticket-tons {
            font-size: 18px;
            font-weight: 700;
            color: var(--emerald-400);
        }
        
        .ticket-diversion {
            font-size: 12px;
            color: var(--slate-400);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--slate-700);
            color: var(--slate-200);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 300;
            opacity: 0;
            transition: all 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { background: var(--emerald-500); color: white; }
        .toast.error { background: var(--red-500); color: white; }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--slate-400);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--slate-700);
            border-top-color: var(--emerald-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Container select */
        .container-select {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .container-option {
            flex: 1;
            padding: 12px;
            background: var(--slate-700);
            border: 2px solid var(--slate-600);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .container-option.selected {
            border-color: var(--emerald-500);
            background: rgba(16, 185, 129, 0.1);
        }
        
        .container-option span {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: var(--slate-200);
        }
        
        .container-option small {
            font-size: 11px;
            color: var(--slate-400);
        }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--slate-500);
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Project selector */
        .project-selector {
            background: var(--slate-700);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-name {
            font-weight: 600;
            color: var(--slate-200);
        }
        
        .project-change {
            color: var(--emerald-400);
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">DivertScan‚Ñ¢ <span>v2.2</span></div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showSettings()" style="padding:8px 12px;width:auto;">‚öôÔ∏è</button>
            <button class="btn btn-secondary" onclick="signOut()" style="padding:8px 12px;width:auto;">‚Ü™Ô∏è</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Auth Screen -->
        <div id="authScreen" class="tab-content active">
            <div style="max-width:400px;margin:60px auto;padding:20px;">
                <div style="text-align:center;margin-bottom:32px;">
                    <div style="font-size:48px;margin-bottom:16px;">‚ôªÔ∏è</div>
                    <h1 style="font-size:24px;color:var(--emerald-400);margin-bottom:8px;">DivertScan‚Ñ¢</h1>
                    <p style="color:var(--slate-400);">LEED-Compliant Waste Tracking</p>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="authEmail" class="form-input" placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="authPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="signIn()">Sign In</button>
                    <p style="text-align:center;margin-top:16px;font-size:12px;color:var(--slate-500);">
                        Don't have an account? <a href="#" onclick="signUp()" style="color:var(--emerald-400);">Sign Up</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <div class="project-selector" id="projectSelector">
                <div>
                    <div style="font-size:11px;color:var(--slate-500);">CURRENT PROJECT</div>
                    <div class="project-name" id="currentProjectName">Select a Project</div>
                </div>
                <span class="project-change" onclick="showProjectModal()">Change ‚Üí</span>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statTickets">0</div>
                    <div class="stat-label">Tickets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statTons">0</div>
                    <div class="stat-label">Total Tons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statDiversion">0%</div>
                    <div class="stat-label">Diversion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statCO2">0</div>
                    <div class="stat-label">MT CO‚ÇÇe Avoided</div>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <div class="card-title">LEED v5 Progress</div>
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span style="font-size:12px;color:var(--slate-400);">75% Target</span>
                    <span style="font-size:14px;font-weight:600;" id="leedProgress">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="leedProgressBar" style="width:0%"></div>
                </div>
            </div>

            <button class="btn btn-primary btn-lg" style="margin-top:20px;" onclick="startNewTicket()">
                ‚ûï New Ticket
            </button>

            <div class="card" style="margin-top:20px;">
                <div class="card-title">Recent Tickets</div>
                <div class="ticket-list" id="ticketList">
                    <div class="empty-state">
                        <p>No tickets yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div id="ticketsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">All Tickets</h2>
            <div class="ticket-list" id="allTicketsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading tickets...</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">LEED Reports</h2>
            <div class="card">
                <div class="card-title">Export Options</div>
                <button class="btn btn-secondary" style="margin-bottom:12px;" onclick="exportLEEDReport()">
                    üìä LEED v5 CSV Report
                </button>
                <button class="btn btn-secondary" onclick="exportAuditLog()">
                    üìã Audit Log
                </button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">Settings</h2>
            <div class="card">
                <div class="card-title">OpenAI API Key</div>
                <p style="font-size:12px;color:var(--slate-400);margin-bottom:12px;">
                    Required for OCR and debris analysis
                </p>
                <div class="form-group">
                    <input type="password" id="openaiKeyInput" class="form-input" placeholder="sk-...">
                </div>
                <button class="btn btn-primary" onclick="saveOpenAIKey()">Save API Key</button>
            </div>
            <div class="card">
                <div class="card-title">Account</div>
                <p style="font-size:14px;color:var(--slate-300);margin-bottom:8px;" id="userEmail">-</p>
                <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="nav">
        <div class="nav-item active" onclick="showTab('dashboard')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            </svg>
            Home
        </div>
        <div class="nav-item" onclick="showTab('tickets')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
            </svg>
            Tickets
        </div>
        <div class="nav-item" onclick="showTab('reports')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 20V10M12 20V4M6 20v-6"/>
            </svg>
            Reports
        </div>
        <div class="nav-item" onclick="showTab('settings')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            Settings
        </div>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- New Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">New Ticket</div>
                <button class="modal-close" onclick="closeModal('ticketModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Steps Indicator -->
                <div class="steps">
                    <div class="step active" id="step1">1</div>
                    <div class="step-line" id="stepLine1"></div>
                    <div class="step" id="step2">2</div>
                    <div class="step-line" id="stepLine2"></div>
                    <div class="step" id="step3">3</div>
                </div>

                <!-- Step 1: Scale Ticket -->
                <div id="ticketStep1">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üìÑ Scale Ticket</h3>
                    
                    <div class="image-preview" id="ticketImagePreview">
                        <span>No image</span>
                    </div>
                    
                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <button class="btn btn-secondary" onclick="captureTicketPhoto()" style="flex:1;">üì∑ Camera</button>
                        <button class="btn btn-secondary" onclick="uploadTicketPhoto()" style="flex:1;">üìÅ Upload</button>
                    </div>
                    <input type="file" id="ticketFileInput" accept="image/*" style="display:none;" onchange="handleTicketFile(event)">
                    <input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleTicketFile(event)">

                    <div id="ticketOCRResult" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Ticket #</label>
                            <input type="text" id="ticketNumber" class="form-input" placeholder="84600">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" id="ticketDate" class="form-input">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div class="form-group">
                                <label class="form-label">Gross (lbs)</label>
                                <input type="number" id="grossLbs" class="form-input" placeholder="40620">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tare (lbs)</label>
                                <input type="number" id="tareLbs" class="form-input" placeholder="34840">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Net Weight</label>
                            <div style="font-size:24px;font-weight:700;color:var(--emerald-400);" id="netWeightDisplay">0.00 tons</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hauler</label>
                            <input type="text" id="haulerName" class="form-input" placeholder="Dalmex Recycling">
                        </div>
                    </div>

                    <div id="ticketAnalyzing" class="loading hidden">
                        <div class="spinner"></div>
                        <p>Analyzing ticket...</p>
                    </div>
                </div>

                <!-- Step 2: Debris Photos -->
                <div id="ticketStep2" class="hidden">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üì∏ Debris Photos</h3>
                    
                    <div class="container-select">
                        <div class="container-option" onclick="selectContainer(20)">
                            <span>20</span>
                            <small>yard</small>
                        </div>
                        <div class="container-option selected" onclick="selectContainer(30)">
                            <span>30</span>
                            <small>yard</small>
                        </div>
                        <div class="container-option" onclick="selectContainer(40)">
                            <span>40</span>
                            <small>yard</small>
                        </div>
                    </div>

                    <div class="photo-grid" id="debrisPhotoGrid">
                        <div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div>
                        <div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div>
                        <div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>
                    </div>
                    <input type="file" id="debrisFileInput" accept="image/*" style="display:none;" onchange="handleDebrisFile(event)">
                    <input type="file" id="debrisCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleDebrisFile(event)">
                    
                    <p style="font-size:12px;color:var(--slate-400);text-align:center;margin-bottom:16px;">
                        Add 1-3 photos of the debris load
                    </p>

                    <button class="btn btn-primary" id="analyzeDebrisBtn" onclick="analyzeDebris()" disabled>
                        ü§ñ Analyze Materials
                    </button>

                    <div id="debrisAnalyzing" class="loading hidden">
                        <div class="spinner"></div>
                        <p>Analyzing debris...</p>
                    </div>
                </div>

                <!-- Step 3: Review & Save -->
                <div id="ticketStep3" class="hidden">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">‚úÖ Review & Save</h3>
                    
                    <div class="analysis-result" id="analysisResult">
                        <div class="analysis-header">
                            <div>
                                <div style="font-size:12px;color:var(--slate-400);">Diversion Rate</div>
                                <div class="diversion-badge good" id="finalDiversionRate">0%</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px;color:var(--slate-400);">LEED v5 Target</div>
                                <div style="font-size:14px;color:var(--slate-300);">75%</div>
                            </div>
                        </div>
                        <div class="progress-bar" style="margin-bottom:16px;">
                            <div class="progress-fill" id="finalProgressBar" style="width:0%"></div>
                        </div>
                        
                        <div style="font-size:12px;color:var(--slate-400);margin-bottom:8px;">MATERIAL BREAKDOWN</div>
                        <div class="material-breakdown" id="materialBreakdown">
                            <!-- Filled dynamically -->
                        </div>
                    </div>

                    <div class="card" style="margin-top:16px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div>
                                <div style="font-size:11px;color:var(--slate-500);">TICKET #</div>
                                <div style="font-size:14px;color:var(--slate-200);" id="reviewTicketNum">-</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:var(--slate-500);">DATE</div>
                                <div style="font-size:14px;color:var(--slate-200);" id="reviewDate">-</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:var(--slate-500);">NET WEIGHT</div>
                                <div style="font-size:14px;color:var(--emerald-400);font-weight:700;" id="reviewNetTons">-</div>
                            </div>
                            <div>
                                <div style="font-size:11px;color:var(--slate-500);">CO‚ÇÇe AVOIDED</div>
                                <div style="font-size:14px;color:var(--slate-200);" id="reviewCO2">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Manual adjustment -->
                    <details style="margin-top:16px;">
                        <summary style="color:var(--slate-400);font-size:12px;cursor:pointer;">Adjust Percentages Manually</summary>
                        <div class="material-grid" style="margin-top:12px;" id="manualMaterialGrid">
                            <!-- Filled dynamically -->
                        </div>
                        <div style="margin-top:8px;font-size:12px;color:var(--slate-400);">
                            Total: <span id="manualTotal">100</span>%
                        </div>
                        <button class="btn btn-secondary" style="margin-top:8px;" onclick="recalculateManual()">
                            Recalculate
                        </button>
                    </details>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="prevStepBtn" onclick="prevStep()" style="flex:1;" disabled>Back</button>
                <button class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" style="flex:1;">Next</button>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Select Project</div>
                <button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="projectList" class="ticket-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading projects...</p>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top:16px;" onclick="showNewProjectForm()">
                    ‚ûï New Project
                </button>
                <div id="newProjectForm" class="hidden" style="margin-top:16px;">
                    <div class="form-group">
                        <label class="form-label">Project Name</label>
                        <input type="text" id="newProjectName" class="form-input" placeholder="Children's Medical Center">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <input type="text" id="newProjectAddress" class="form-input" placeholder="1234 Main St">
                    </div>
                    <button class="btn btn-primary" onclick="createProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- DIVERTSCAN CORE MODULE -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
/**
 * DivertScan‚Ñ¢ Core Module v2.2 (Embedded)
 * This is the master core - all shared functions live here
 */
const DivertScan = (function() {
    'use strict';

    const CONFIG = {
        SUPABASE_URL: 'https://cyvvlngtojagfoaitoog.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g',
        VERSION: '2.2.0',
        LEED_V4_TARGET: 50,
        LEED_V5_TARGET: 75,
        CONTAINER_SIZES: [20, 30, 40],
        DEFAULT_CONTAINER: 30
    };

    const MATERIALS = {
        wood: { name: 'Wood/Lumber', icon: 'ü™µ', recyclable: true, gwpFactor: 0.03 },
        gypsum: { name: 'Gypsum/Drywall', icon: 'üß±', recyclable: true, gwpFactor: 0.12 },
        plastic: { name: 'Plastic', icon: '‚ôªÔ∏è', recyclable: true, gwpFactor: 2.5 },
        occ: { name: 'Cardboard/OCC', icon: 'üì¶', recyclable: true, gwpFactor: 0.94 },
        metal: { name: 'Metal/Steel', icon: 'üî©', recyclable: true, gwpFactor: 1.85 },
        concrete: { name: 'Concrete', icon: 'ü™®', recyclable: true, gwpFactor: 0.159 },
        block: { name: 'CMU/Block', icon: 'üß±', recyclable: true, gwpFactor: 0.159 },
        landfill: { name: 'Landfill/Trash', icon: 'üóëÔ∏è', recyclable: false, gwpFactor: 0.52 }
    };

    const MATERIAL_KEYS = ['wood', 'gypsum', 'plastic', 'occ', 'metal', 'concrete', 'block', 'landfill'];

    let state = {
        supabase: null,
        user: null,
        currentProject: null,
        ticketSession: {
            ticketNumber: null,
            ticketDate: null,
            grossLbs: null,
            tareLbs: null,
            netLbs: null,
            netTons: null,
            hauler: null,
            containerSize: 30,
            scaleTicketImage: null,
            debrisImages: [],
            materialBreakdown: {},
            diversionRate: 0,
            co2eAvoided: 0,
            calculatedBreakdown: {},
            gpsLat: null,
            gpsLng: null,
            ipAddress: null,
            capturedAt: null
        },
        openaiKey: localStorage.getItem('divertscan_openai') || '',
        isOnline: navigator.onLine
    };

    function toast(message, type = 'info') {
        const toastEl = document.getElementById('toast');
        if (!toastEl) { console.log(`[${type}] ${message}`); return; }
        toastEl.textContent = message;
        toastEl.className = `toast ${type} show`;
        setTimeout(() => toastEl.classList.remove('show'), 3000);
    }

    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return Number(num).toLocaleString('en-US');
    }

    function formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });
    }

    function generateAuditId() {
        const year = new Date().getFullYear();
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        const seq = Date.now().toString().slice(-5);
        return `DS-${year}-${seq}-${random}`;
    }

    function calculateNetWeight(grossLbs, tareLbs) {
        const gross = parseFloat(grossLbs) || 0;
        const tare = parseFloat(tareLbs) || 0;
        const netLbs = gross - tare;
        return { netLbs: Math.max(0, netLbs), netTons: Math.max(0, netLbs / 2000) };
    }

    function calculateMaterialTonnages(percentages, netTons) {
        const breakdown = {};
        let totalDivertedPct = 0;
        let totalCO2e = 0;

        for (const key of MATERIAL_KEYS) {
            const pct = parseFloat(percentages[key]) || 0;
            const tons = (pct / 100) * netTons;
            const material = MATERIALS[key];
            const co2e = tons * (material?.gwpFactor || 0);

            breakdown[key] = { pct, tons, co2e, recyclable: material?.recyclable || false };

            if (material?.recyclable && key !== 'landfill') {
                totalDivertedPct += pct;
            }
            totalCO2e += co2e;
        }

        return {
            breakdown,
            diversionRate: Math.round(totalDivertedPct),
            totalCO2e,
            meetsLEEDv4: totalDivertedPct >= CONFIG.LEED_V4_TARGET,
            meetsLEEDv5: totalDivertedPct >= CONFIG.LEED_V5_TARGET
        };
    }

    function validateMaterialTotal(percentages) {
        let total = 0;
        for (const key of MATERIAL_KEYS) {
            total += parseFloat(percentages[key]) || 0;
        }
        return { total, valid: Math.abs(total - 100) < 0.1 };
    }

    function initTicketSession() {
        state.ticketSession = {
            ticketNumber: null,
            ticketDate: new Date().toISOString().split('T')[0],
            grossLbs: null,
            tareLbs: null,
            netLbs: null,
            netTons: null,
            hauler: null,
            containerSize: 30,
            scaleTicketImage: null,
            debrisImages: [],
            materialBreakdown: {},
            diversionRate: 0,
            co2eAvoided: 0,
            calculatedBreakdown: {},
            gpsLat: null,
            gpsLng: null,
            ipAddress: null,
            capturedAt: new Date().toISOString()
        };
        return state.ticketSession;
    }

    function updateTicketSession(data) {
        Object.assign(state.ticketSession, data);
        
        if (state.ticketSession.grossLbs && state.ticketSession.tareLbs) {
            const net = calculateNetWeight(state.ticketSession.grossLbs, state.ticketSession.tareLbs);
            state.ticketSession.netLbs = net.netLbs;
            state.ticketSession.netTons = net.netTons;
        }

        if (Object.keys(state.ticketSession.materialBreakdown).length > 0 && state.ticketSession.netTons) {
            const result = calculateMaterialTonnages(state.ticketSession.materialBreakdown, state.ticketSession.netTons);
            state.ticketSession.diversionRate = result.diversionRate;
            state.ticketSession.co2eAvoided = result.totalCO2e;
            state.ticketSession.calculatedBreakdown = result.breakdown;
        }

        return state.ticketSession;
    }

    function setMaterialPercentages(percentages) {
        const normalized = {};
        for (const key of MATERIAL_KEYS) {
            normalized[key] = parseFloat(percentages[key]) || 0;
        }
        state.ticketSession.materialBreakdown = normalized;

        if (state.ticketSession.netTons) {
            const result = calculateMaterialTonnages(normalized, state.ticketSession.netTons);
            state.ticketSession.diversionRate = result.diversionRate;
            state.ticketSession.co2eAvoided = result.totalCO2e;
            state.ticketSession.calculatedBreakdown = result.breakdown;
            return result;
        }

        return { breakdown: normalized, diversionRate: 100 - (normalized.landfill || 0) };
    }

    function getTicketSession() {
        return { ...state.ticketSession };
    }

    async function captureGPS() {
        return new Promise((resolve) => {
            if (!navigator.geolocation) {
                resolve({ lat: null, lng: null });
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    state.ticketSession.gpsLat = pos.coords.latitude;
                    state.ticketSession.gpsLng = pos.coords.longitude;
                    resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                },
                () => resolve({ lat: null, lng: null }),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }

    async function captureIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            state.ticketSession.ipAddress = data.ip;
            return data.ip;
        } catch (e) {
            return null;
        }
    }

    async function analyzeScaleTicket(imageDataUrl) {
        const apiKey = state.openaiKey || localStorage.getItem('divertscan_openai');
        if (!apiKey) throw new Error('OpenAI API key not configured. Go to Settings.');

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: `Extract data from this scale ticket. Return ONLY valid JSON:
{"ticket_number":"string or null","date":"MM/DD/YY or null","hauler":"string or null","gross_lbs":number or null,"tare_lbs":number or null,"net_lbs":number or null,"commodity":"string or null","confidence":0-100}` },
                        { type: 'image_url', image_url: { url: imageDataUrl } }
                    ]
                }],
                max_tokens: 500
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const content = data.choices[0].message.content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('Could not parse OCR response');

        const result = JSON.parse(jsonMatch[0]);

        updateTicketSession({
            ticketNumber: result.ticket_number,
            ticketDate: result.date,
            grossLbs: result.gross_lbs,
            tareLbs: result.tare_lbs,
            hauler: result.hauler,
            scaleTicketImage: imageDataUrl
        });

        return result;
    }

    async function analyzeDebrisPhoto(imageDataUrl, containerSize = 30) {
        const apiKey = state.openaiKey || localStorage.getItem('divertscan_openai');
        if (!apiKey) throw new Error('OpenAI API key not configured. Go to Settings.');

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: `Analyze this ${containerSize}-yard container of construction/demolition debris. Estimate percentage breakdown of visible materials. Return ONLY valid JSON:
{"wood":0-100,"gypsum":0-100,"plastic":0-100,"occ":0-100,"metal":0-100,"concrete":0-100,"block":0-100,"landfill":0-100,"confidence":0-100,"notes":"brief description"}
Percentages MUST total 100. Include landfill for non-recyclable waste.` },
                        { type: 'image_url', image_url: { url: imageDataUrl } }
                    ]
                }],
                max_tokens: 500
            })
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error.message);

        const content = data.choices[0].message.content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('Could not parse debris analysis');

        const result = JSON.parse(jsonMatch[0]);

        const percentages = {
            wood: result.wood || 0,
            gypsum: result.gypsum || 0,
            plastic: result.plastic || 0,
            occ: result.occ || 0,
            metal: result.metal || 0,
            concrete: result.concrete || 0,
            block: result.block || 0,
            landfill: result.landfill || 0
        };

        if (!state.ticketSession.debrisImages) state.ticketSession.debrisImages = [];
        state.ticketSession.debrisImages.push(imageDataUrl);

        const breakdown = setMaterialPercentages(percentages);

        return { raw: result, percentages, breakdown, confidence: result.confidence, notes: result.notes };
    }

    async function initSupabase() {
        if (state.supabase) return state.supabase;

        if (typeof supabase === 'undefined') {
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = resolve;
                script.onerror = () => reject(new Error('Failed to load Supabase'));
                document.head.appendChild(script);
            });
        }

        state.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        return state.supabase;
    }

    async function saveTicket(projectId) {
        await initSupabase();

        const session = state.ticketSession;
        const breakdown = session.calculatedBreakdown || {};

        const ticketData = {
            project_id: projectId || state.currentProject?.id,
            user_id: state.user?.id,
            ticket_number: session.ticketNumber,
            ticket_date: session.ticketDate,
            hauler: session.hauler,
            container_size: session.containerSize,
            gross_lbs: session.grossLbs,
            tare_lbs: session.tareLbs,
            net_lbs: session.netLbs,
            net_tons: session.netTons,
            wood_pct: session.materialBreakdown.wood || 0,
            gypsum_pct: session.materialBreakdown.gypsum || 0,
            plastic_pct: session.materialBreakdown.plastic || 0,
            occ_pct: session.materialBreakdown.occ || 0,
            metal_pct: session.materialBreakdown.metal || 0,
            concrete_pct: session.materialBreakdown.concrete || 0,
            block_pct: session.materialBreakdown.block || 0,
            landfill_pct: session.materialBreakdown.landfill || 0,
            wood_tons: breakdown.wood?.tons || 0,
            gypsum_tons: breakdown.gypsum?.tons || 0,
            plastic_tons: breakdown.plastic?.tons || 0,
            occ_tons: breakdown.occ?.tons || 0,
            metal_tons: breakdown.metal?.tons || 0,
            concrete_tons: breakdown.concrete?.tons || 0,
            block_tons: breakdown.block?.tons || 0,
            landfill_tons: breakdown.landfill?.tons || 0,
            diversion_pct: session.diversionRate,
            diverted_tons: session.netTons * (session.diversionRate / 100),
            co2e_avoided: session.co2eAvoided,
            gps_lat: session.gpsLat,
            gps_lng: session.gpsLng,
            ip_address: session.ipAddress,
            captured_at: session.capturedAt,
            scale_ticket_image: session.scaleTicketImage,
            debris_images: JSON.stringify(session.debrisImages || []),
            created_at: new Date().toISOString(),
            audit_id: generateAuditId()
        };

        const { data, error } = await state.supabase.from('tickets').insert([ticketData]).select().single();
        if (error) throw error;

        toast('Ticket saved successfully!', 'success');
        return data;
    }

    async function loadTickets(projectId) {
        await initSupabase();
        const { data, error } = await state.supabase.from('tickets').select('*').eq('project_id', projectId).order('created_at', { ascending: false });
        if (error) throw error;
        return data;
    }

    async function loadProjects() {
        await initSupabase();
        const { data, error } = await state.supabase.from('projects').select('*').eq('user_id', state.user?.id).order('created_at', { ascending: false });
        if (error) throw error;
        return data;
    }

    function generateLEEDReport(tickets) {
        const headers = ['Date','Ticket #','Gross (lbs)','Gross (tons)','Tare (lbs)','Tare (tons)','Net (lbs)','Net (tons)','Wood %','Wood (T)','Gypsum %','Gypsum (T)','Plastic %','Plastic (T)','OCC %','OCC (T)','Metal %','Metal (T)','Concrete %','Concrete (T)','Block %','Block (T)','Landfill %','Landfill (T)','Total Diverted (T)','Diversion %'];
        let csv = headers.join(',') + '\n';

        for (const t of tickets) {
            const row = [
                formatDate(t.ticket_date), t.ticket_number, t.gross_lbs, (t.gross_lbs/2000).toFixed(2),
                t.tare_lbs, (t.tare_lbs/2000).toFixed(2), t.net_lbs, t.net_tons?.toFixed(2),
                t.wood_pct, t.wood_tons?.toFixed(3), t.gypsum_pct, t.gypsum_tons?.toFixed(3),
                t.plastic_pct, t.plastic_tons?.toFixed(3), t.occ_pct, t.occ_tons?.toFixed(3),
                t.metal_pct, t.metal_tons?.toFixed(3), t.concrete_pct, t.concrete_tons?.toFixed(3),
                t.block_pct, t.block_tons?.toFixed(3), t.landfill_pct, t.landfill_tons?.toFixed(3),
                t.diverted_tons?.toFixed(3), t.diversion_pct
            ];
            csv += row.join(',') + '\n';
        }
        return csv;
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename || 'divertscan-report.csv';
        a.click();
        URL.revokeObjectURL(url);
    }

    return {
        CONFIG, MATERIALS, MATERIAL_KEYS,
        getState: () => state,
        setState: (key, value) => { state[key] = value; },
        setOpenAIKey: (key) => { state.openaiKey = key; localStorage.setItem('divertscan_openai', key); },
        toast, formatNumber, formatDate, generateAuditId,
        calculateNetWeight, calculateMaterialTonnages, validateMaterialTotal,
        initTicketSession, updateTicketSession, setMaterialPercentages, getTicketSession,
        captureGPS, captureIP,
        analyzeScaleTicket, analyzeDebrisPhoto,
        initSupabase, saveTicket, loadTickets, loadProjects,
        generateLEEDReport, downloadCSV,
        version: CONFIG.VERSION
    };
})();

window.DivertScan = DivertScan;
    </script>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- APPLICATION LOGIC -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentStep = 1;
let selectedContainerSize = 30;
let debrisPhotoSlot = 0;
let debrisPhotos = [null, null, null];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function initialize() {
    try {
        await DivertScan.initSupabase();
        const sb = DivertScan.getState().supabase;
        
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            DivertScan.setState('user', session.user);
            showApp();
        }

        sb.auth.onAuthStateChange((event, session) => {
            if (session) {
                DivertScan.setState('user', session.user);
                showApp();
            } else {
                DivertScan.setState('user', null);
                showAuth();
            }
        });
    } catch (e) {
        console.error('Init error:', e);
        DivertScan.toast('Failed to initialize', 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function signIn() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (!email || !password) {
        DivertScan.toast('Enter email and password', 'error');
        return;
    }

    try {
        const sb = DivertScan.getState().supabase;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        DivertScan.toast('Signed in!', 'success');
    } catch (e) {
        DivertScan.toast(e.message, 'error');
    }
}

async function signUp() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (!email || !password) {
        DivertScan.toast('Enter email and password', 'error');
        return;
    }

    try {
        const sb = DivertScan.getState().supabase;
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) throw error;
        DivertScan.toast('Account created! Check email to confirm.', 'success');
    } catch (e) {
        DivertScan.toast(e.message, 'error');
    }
}

async function signOut() {
    const sb = DivertScan.getState().supabase;
    await sb.auth.signOut();
    showAuth();
}

function showAuth() {
    document.getElementById('authScreen').classList.add('active');
    document.getElementById('dashboardTab').classList.remove('active');
    document.querySelector('.nav').style.display = 'none';
}

function showApp() {
    document.getElementById('authScreen').classList.remove('active');
    document.querySelector('.nav').style.display = 'flex';
    document.getElementById('userEmail').textContent = DivertScan.getState().user?.email || '-';
    document.getElementById('openaiKeyInput').value = DivertScan.getState().openaiKey || '';
    loadProjectsAndData();
    showTab('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    document.getElementById(tab + 'Tab').classList.add('active');
    document.querySelectorAll('.nav-item')[['dashboard','tickets','reports','settings'].indexOf(tab)].classList.add('active');
    
    if (tab === 'tickets') loadAllTickets();
}

function showSettings() {
    showTab('settings');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadProjectsAndData() {
    try {
        const projects = await DivertScan.loadProjects();
        
        if (projects && projects.length > 0) {
            DivertScan.setState('currentProject', projects[0]);
            document.getElementById('currentProjectName').textContent = projects[0].name;
            await loadDashboardData();
        } else {
            document.getElementById('currentProjectName').textContent = 'No Projects - Create One';
        }
    } catch (e) {
        console.error('Load projects error:', e);
    }
}

function showProjectModal() {
    openModal('projectModal');
    loadProjectList();
}

async function loadProjectList() {
    const projects = await DivertScan.loadProjects();
    const list = document.getElementById('projectList');
    
    if (!projects || projects.length === 0) {
        list.innerHTML = '<div class="empty-state"><p>No projects yet</p></div>';
        return;
    }

    list.innerHTML = projects.map(p => `
        <div class="ticket-item" onclick="selectProject('${p.id}', '${p.name}')">
            <div class="ticket-info">
                <h4>${p.name}</h4>
                <p>${p.address || 'No address'}</p>
            </div>
            <span style="color:var(--emerald-400);">‚Üí</span>
        </div>
    `).join('');
}

function selectProject(id, name) {
    const state = DivertScan.getState();
    DivertScan.setState('currentProject', { id, name });
    document.getElementById('currentProjectName').textContent = name;
    closeModal('projectModal');
    loadDashboardData();
}

function showNewProjectForm() {
    document.getElementById('newProjectForm').classList.toggle('hidden');
}

async function createProject() {
    const name = document.getElementById('newProjectName').value;
    const address = document.getElementById('newProjectAddress').value;
    
    if (!name) {
        DivertScan.toast('Enter project name', 'error');
        return;
    }

    try {
        const sb = DivertScan.getState().supabase;
        const { data, error } = await sb.from('projects').insert([{
            name,
            address,
            user_id: DivertScan.getState().user.id
        }]).select().single();

        if (error) throw error;

        DivertScan.toast('Project created!', 'success');
        selectProject(data.id, data.name);
        document.getElementById('newProjectForm').classList.add('hidden');
        document.getElementById('newProjectName').value = '';
        document.getElementById('newProjectAddress').value = '';
    } catch (e) {
        DivertScan.toast(e.message, 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadDashboardData() {
    const project = DivertScan.getState().currentProject;
    if (!project) return;

    try {
        const tickets = await DivertScan.loadTickets(project.id);
        
        const totalTickets = tickets.length;
        const totalTons = tickets.reduce((sum, t) => sum + (parseFloat(t.net_tons) || 0), 0);
        const totalDiverted = tickets.reduce((sum, t) => sum + (parseFloat(t.diverted_tons) || 0), 0);
        const avgDiversion = totalTons > 0 ? (totalDiverted / totalTons * 100) : 0;
        const totalCO2 = tickets.reduce((sum, t) => sum + (parseFloat(t.co2e_avoided) || 0), 0);

        document.getElementById('statTickets').textContent = totalTickets;
        document.getElementById('statTons').textContent = totalTons.toFixed(2);
        document.getElementById('statDiversion').textContent = avgDiversion.toFixed(0) + '%';
        document.getElementById('statCO2').textContent = totalCO2.toFixed(2);
        document.getElementById('leedProgress').textContent = avgDiversion.toFixed(0) + '%';
        
        const progressBar = document.getElementById('leedProgressBar');
        progressBar.style.width = Math.min(avgDiversion, 100) + '%';
        progressBar.className = 'progress-fill' + (avgDiversion >= 75 ? '' : avgDiversion >= 50 ? ' warning' : ' danger');

        // Recent tickets
        const list = document.getElementById('ticketList');
        if (tickets.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No tickets yet</p></div>';
        } else {
            list.innerHTML = tickets.slice(0, 5).map(t => `
                <div class="ticket-item">
                    <div class="ticket-info">
                        <h4>#${t.ticket_number || 'N/A'}</h4>
                        <p>${DivertScan.formatDate(t.ticket_date)}</p>
                    </div>
                    <div class="ticket-stats">
                        <div class="ticket-tons">${(t.net_tons || 0).toFixed(2)}T</div>
                        <div class="ticket-diversion">${t.diversion_pct || 0}% diverted</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (e) {
        console.error('Dashboard error:', e);
    }
}

async function loadAllTickets() {
    const project = DivertScan.getState().currentProject;
    if (!project) return;

    try {
        const tickets = await DivertScan.loadTickets(project.id);
        const list = document.getElementById('allTicketsList');
        
        if (tickets.length === 0) {
            list.innerHTML = '<div class="empty-state"><p>No tickets yet</p></div>';
        } else {
            list.innerHTML = tickets.map(t => `
                <div class="ticket-item">
                    <div class="ticket-info">
                        <h4>#${t.ticket_number || 'N/A'}</h4>
                        <p>${DivertScan.formatDate(t.ticket_date)} ‚Ä¢ ${t.hauler || 'Unknown hauler'}</p>
                    </div>
                    <div class="ticket-stats">
                        <div class="ticket-tons">${(t.net_tons || 0).toFixed(2)}T</div>
                        <div class="ticket-diversion">${t.diversion_pct || 0}% diverted</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (e) {
        console.error('Load tickets error:', e);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW TICKET FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function startNewTicket() {
    const project = DivertScan.getState().currentProject;
    if (!project) {
        DivertScan.toast('Select a project first', 'error');
        return;
    }

    // Initialize fresh ticket session
    DivertScan.initTicketSession();
    
    // Reset UI
    currentStep = 1;
    debrisPhotos = [null, null, null];
    
    document.getElementById('ticketImagePreview').innerHTML = '<span>No image</span>';
    document.getElementById('ticketOCRResult').classList.add('hidden');
    document.getElementById('ticketStep1').classList.remove('hidden');
    document.getElementById('ticketStep2').classList.add('hidden');
    document.getElementById('ticketStep3').classList.add('hidden');
    
    updateStepIndicators();
    resetDebrisPhotoGrid();
    
    openModal('ticketModal');
    
    // Capture verification data
    DivertScan.captureGPS();
    DivertScan.captureIP();
}

function updateStepIndicators() {
    for (let i = 1; i <= 3; i++) {
        const step = document.getElementById('step' + i);
        step.className = 'step' + (i < currentStep ? ' complete' : i === currentStep ? ' active' : '');
    }
    document.getElementById('stepLine1').className = 'step-line' + (currentStep > 1 ? ' complete' : '');
    document.getElementById('stepLine2').className = 'step-line' + (currentStep > 2 ? ' complete' : '');
    
    document.getElementById('prevStepBtn').disabled = currentStep === 1;
    document.getElementById('nextStepBtn').textContent = currentStep === 3 ? 'Save Ticket' : 'Next';
}

function nextStep() {
    if (currentStep === 3) {
        saveCurrentTicket();
        return;
    }
    
    if (currentStep === 1) {
        // Validate step 1
        const session = DivertScan.getTicketSession();
        if (!session.grossLbs || !session.tareLbs) {
            DivertScan.toast('Enter gross and tare weights', 'error');
            return;
        }
    }
    
    if (currentStep === 2) {
        // Validate step 2
        const session = DivertScan.getTicketSession();
        if (Object.keys(session.materialBreakdown).length === 0 || session.diversionRate === 0) {
            DivertScan.toast('Analyze debris photos first', 'error');
            return;
        }
    }
    
    currentStep++;
    showCurrentStep();
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showCurrentStep();
    }
}

function showCurrentStep() {
    document.getElementById('ticketStep1').classList.toggle('hidden', currentStep !== 1);
    document.getElementById('ticketStep2').classList.toggle('hidden', currentStep !== 2);
    document.getElementById('ticketStep3').classList.toggle('hidden', currentStep !== 3);
    updateStepIndicators();
    
    if (currentStep === 3) {
        populateReviewStep();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 1: SCALE TICKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function captureTicketPhoto() {
    document.getElementById('ticketCameraInput').click();
}

function uploadTicketPhoto() {
    document.getElementById('ticketFileInput').click();
}

async function handleTicketFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageData = e.target.result;
        document.getElementById('ticketImagePreview').innerHTML = `<img src="${imageData}" alt="Ticket">`;
        
        // Analyze with OCR
        document.getElementById('ticketAnalyzing').classList.remove('hidden');
        
        try {
            const result = await DivertScan.analyzeScaleTicket(imageData);
            
            // Populate form fields
            document.getElementById('ticketNumber').value = result.ticket_number || '';
            document.getElementById('ticketDate').value = result.date ? formatDateForInput(result.date) : new Date().toISOString().split('T')[0];
            document.getElementById('grossLbs').value = result.gross_lbs || '';
            document.getElementById('tareLbs').value = result.tare_lbs || '';
            document.getElementById('haulerName').value = result.hauler || '';
            
            updateNetWeightDisplay();
            document.getElementById('ticketOCRResult').classList.remove('hidden');
            
            DivertScan.toast('Ticket analyzed!', 'success');
        } catch (err) {
            DivertScan.toast(err.message, 'error');
        } finally {
            document.getElementById('ticketAnalyzing').classList.add('hidden');
        }
    };
    reader.readAsDataURL(file);
}

function formatDateForInput(dateStr) {
    // Convert MM/DD/YY to YYYY-MM-DD
    if (!dateStr) return '';
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
        return `${year}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
    }
    return dateStr;
}

function updateNetWeightDisplay() {
    const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
    const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
    const net = DivertScan.calculateNetWeight(gross, tare);
    
    document.getElementById('netWeightDisplay').textContent = net.netTons.toFixed(2) + ' tons';
    
    // Update session
    DivertScan.updateTicketSession({
        ticketNumber: document.getElementById('ticketNumber').value,
        ticketDate: document.getElementById('ticketDate').value,
        grossLbs: gross,
        tareLbs: tare,
        hauler: document.getElementById('haulerName').value
    });
}

// Add event listeners for weight inputs
document.getElementById('grossLbs')?.addEventListener('input', updateNetWeightDisplay);
document.getElementById('tareLbs')?.addEventListener('input', updateNetWeightDisplay);
document.getElementById('ticketNumber')?.addEventListener('input', () => {
    DivertScan.updateTicketSession({ ticketNumber: document.getElementById('ticketNumber').value });
});
document.getElementById('haulerName')?.addEventListener('input', () => {
    DivertScan.updateTicketSession({ hauler: document.getElementById('haulerName').value });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 2: DEBRIS PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function selectContainer(size) {
    selectedContainerSize = size;
    DivertScan.updateTicketSession({ containerSize: size });
    
    document.querySelectorAll('.container-option').forEach(opt => {
        opt.classList.toggle('selected', opt.querySelector('span').textContent == size);
    });
}

function resetDebrisPhotoGrid() {
    const grid = document.getElementById('debrisPhotoGrid');
    grid.innerHTML = `
        <div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div>
        <div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div>
        <div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>
    `;
    document.getElementById('analyzeDebrisBtn').disabled = true;
}

function addDebrisPhoto(slot) {
    debrisPhotoSlot = slot;
    document.getElementById('debrisFileInput').click();
}

function handleDebrisFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        debrisPhotos[debrisPhotoSlot] = e.target.result;
        updateDebrisPhotoGrid();
    };
    reader.readAsDataURL(file);
}

function updateDebrisPhotoGrid() {
    const grid = document.getElementById('debrisPhotoGrid');
    grid.innerHTML = debrisPhotos.map((photo, i) => {
        if (photo) {
            return `<div class="photo-slot filled" onclick="addDebrisPhoto(${i})"><img src="${photo}" alt="Debris ${i+1}"></div>`;
        }
        return `<div class="photo-slot" onclick="addDebrisPhoto(${i})">‚ûï</div>`;
    }).join('');
    
    const hasPhotos = debrisPhotos.some(p => p !== null);
    document.getElementById('analyzeDebrisBtn').disabled = !hasPhotos;
}

async function analyzeDebris() {
    const photos = debrisPhotos.filter(p => p !== null);
    if (photos.length === 0) {
        DivertScan.toast('Add at least one photo', 'error');
        return;
    }

    document.getElementById('debrisAnalyzing').classList.remove('hidden');
    document.getElementById('analyzeDebrisBtn').disabled = true;

    try {
        // Analyze the first photo (or could average multiple)
        const result = await DivertScan.analyzeDebrisPhoto(photos[0], selectedContainerSize);
        
        // If multiple photos, we could average them - for now use first
        for (let i = 1; i < photos.length; i++) {
            DivertScan.getState().ticketSession.debrisImages.push(photos[i]);
        }
        
        DivertScan.toast(`Analysis complete: ${result.breakdown.diversionRate}% diversion`, 'success');
        
        // Auto-advance to step 3
        currentStep = 3;
        showCurrentStep();
        
    } catch (err) {
        DivertScan.toast(err.message, 'error');
        document.getElementById('analyzeDebrisBtn').disabled = false;
    } finally {
        document.getElementById('debrisAnalyzing').classList.add('hidden');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEP 3: REVIEW & SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function populateReviewStep() {
    const session = DivertScan.getTicketSession();
    const breakdown = session.calculatedBreakdown || {};
    
    // Diversion rate badge
    const divRate = session.diversionRate || 0;
    const badge = document.getElementById('finalDiversionRate');
    badge.textContent = divRate + '%';
    badge.className = 'diversion-badge ' + (divRate >= 75 ? 'good' : divRate >= 50 ? 'warning' : 'bad');
    
    document.getElementById('finalProgressBar').style.width = Math.min(divRate, 100) + '%';
    
    // Material breakdown
    const breakdownEl = document.getElementById('materialBreakdown');
    breakdownEl.innerHTML = DivertScan.MATERIAL_KEYS.map(key => {
        const mat = DivertScan.MATERIALS[key];
        const data = breakdown[key] || { pct: 0, tons: 0 };
        if (data.pct === 0) return '';
        return `
            <div class="material-row">
                <div class="material-info">
                    <span class="material-icon">${mat.icon}</span>
                    <span>${mat.name}</span>
                </div>
                <div class="material-values">
                    <div class="material-pct">${data.pct}%</div>
                    <div class="material-tons">${data.tons.toFixed(3)}T ${data.recyclable ? '‚ôªÔ∏è' : 'üóëÔ∏è'}</div>
                </div>
            </div>
        `;
    }).join('');
    
    // Summary info
    document.getElementById('reviewTicketNum').textContent = session.ticketNumber || '-';
    document.getElementById('reviewDate').textContent = session.ticketDate || '-';
    document.getElementById('reviewNetTons').textContent = (session.netTons || 0).toFixed(2) + ' tons';
    document.getElementById('reviewCO2').textContent = (session.co2eAvoided || 0).toFixed(2) + ' MT';
    
    // Manual adjustment grid
    const manualGrid = document.getElementById('manualMaterialGrid');
    manualGrid.innerHTML = DivertScan.MATERIAL_KEYS.map(key => {
        const mat = DivertScan.MATERIALS[key];
        const pct = session.materialBreakdown[key] || 0;
        return `
            <div class="material-item">
                <div class="material-name">${mat.icon} ${key}</div>
                <div class="material-input">
                    <input type="number" id="manual_${key}" value="${pct}" min="0" max="100" onchange="updateManualTotal()">
                    <span>%</span>
                </div>
            </div>
        `;
    }).join('');
    updateManualTotal();
}

function updateManualTotal() {
    let total = 0;
    DivertScan.MATERIAL_KEYS.forEach(key => {
        total += parseFloat(document.getElementById('manual_' + key)?.value) || 0;
    });
    document.getElementById('manualTotal').textContent = total.toFixed(0);
}

function recalculateManual() {
    const percentages = {};
    DivertScan.MATERIAL_KEYS.forEach(key => {
        percentages[key] = parseFloat(document.getElementById('manual_' + key)?.value) || 0;
    });
    
    const validation = DivertScan.validateMaterialTotal(percentages);
    if (!validation.valid) {
        DivertScan.toast(`Total is ${validation.total}%, must equal 100%`, 'error');
        return;
    }
    
    DivertScan.setMaterialPercentages(percentages);
    populateReviewStep();
    DivertScan.toast('Recalculated!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE TICKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function saveCurrentTicket() {
    const project = DivertScan.getState().currentProject;
    if (!project) {
        DivertScan.toast('No project selected', 'error');
        return;
    }

    try {
        await DivertScan.saveTicket(project.id);
        closeModal('ticketModal');
        loadDashboardData();
    } catch (err) {
        DivertScan.toast('Save failed: ' + err.message, 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPORTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function exportLEEDReport() {
    const project = DivertScan.getState().currentProject;
    if (!project) {
        DivertScan.toast('Select a project first', 'error');
        return;
    }

    try {
        const tickets = await DivertScan.loadTickets(project.id);
        if (tickets.length === 0) {
            DivertScan.toast('No tickets to export', 'error');
            return;
        }
        
        const csv = DivertScan.generateLEEDReport(tickets);
        DivertScan.downloadCSV(csv, `DivertScan-LEED-${project.name}-${new Date().toISOString().split('T')[0]}.csv`);
        DivertScan.toast('Report downloaded!', 'success');
    } catch (e) {
        DivertScan.toast(e.message, 'error');
    }
}

function exportAuditLog() {
    DivertScan.toast('Audit log export coming soon', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveOpenAIKey() {
    const key = document.getElementById('openaiKeyInput').value;
    if (!key) {
        DivertScan.toast('Enter API key', 'error');
        return;
    }
    DivertScan.setOpenAIKey(key);
    DivertScan.toast('API key saved!', 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openModal(id) {
    document.getElementById(id).classList.add('active');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
