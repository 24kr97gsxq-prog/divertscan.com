<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan ¬© 2026 | The Carbon Truth in Every Load</title>
    <meta name="description" content="LEED-compliant waste diversion tracking with Point-of-Capture Verification">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Supabase SDK directly in head -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #10b981;
            --accent: #f59e0b; --danger: #dc2626; --success: #16a34a;
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #475569; --shadow: 0 4px 6px -1px rgba(0,0,0,0.3); --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        
        .screen { position: fixed; inset: 0; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s ease; }
        .screen.hidden { opacity: 0; pointer-events: none; }
        .loader-logo, .login-logo { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 1.5rem; }
        .loader-logo span, .login-logo span { color: var(--text-primary); }
        .loader-spinner { width: 48px; height: 48px; border: 4px solid var(--bg-card); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-status { margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem; }
        .loader-error { color: var(--danger); margin-top: 1rem; text-align: center; max-width: 300px; display: none; }
        .loader-error.show { display: block; }
        .loader-error button { margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; }

        .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; width: 90%; max-width: 400px; }
        .login-title { text-align: center; margin-bottom: 1.5rem; }
        .login-title h2 { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .login-title p { color: var(--text-muted); font-size: 0.875rem; }
        .user-select-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .user-btn { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left; color: var(--text-primary); }
        .user-btn:hover { border-color: var(--primary); background: rgba(5, 150, 105, 0.1); }
        .user-btn.selected { border-color: var(--primary); background: rgba(5, 150, 105, 0.15); }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 600; flex-shrink: 0; }
        .user-avatar.admin { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .user-avatar.operator { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .user-avatar.driver { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
        .user-info h3 { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .user-info p { font-size: 0.75rem; color: var(--text-muted); }
        .pin-input-group { margin-top: 1.5rem; display: none; }
        .pin-input-group.show { display: block; }
        .pin-input-group label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .pin-input { width: 100%; padding: 0.875rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); }
        .pin-input:focus { outline: none; border-color: var(--primary); }
        .login-btn { width: 100%; margin-top: 1rem; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .login-btn:hover { background: var(--primary-dark); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .login-error { color: var(--danger); font-size: 0.875rem; text-align: center; margin-top: 1rem; display: none; }
        .login-error.show { display: block; }

        #app { display: none; }
        #app.loaded { display: block; }
        
        .header { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-dark) 100%); border-bottom: 1px solid var(--border); padding: 1rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo span { color: var(--text-primary); }
        .tagline { font-size: 0.75rem; color: var(--text-muted); display: block; }
        .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .current-user { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-input); border-radius: 8px; font-size: 0.875rem; }
        .current-user .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: white; }
        .current-user .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; margin-left: 0.5rem; }
        .current-user .logout-btn:hover { color: var(--danger); }

        .btn { padding: 0.625rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .main { max-width: 1400px; margin: 0 auto; padding: 1.5rem 1rem; }
        
        .tabs { display: flex; gap: 0.25rem; background: var(--bg-card); padding: 0.25rem; border-radius: var(--radius); margin-bottom: 1.5rem; overflow-x: auto; }
        .tab { padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; cursor: pointer; background: transparent; color: var(--text-secondary); border: none; white-space: nowrap; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; }
        .tab:hover:not(.active) { background: var(--bg-input); color: var(--text-primary); }
        .tab.admin-only { display: none; }
        body.is-admin .tab.admin-only { display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1rem; }
        .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; text-align: center; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.625rem 0.875rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }

        .table-container { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-input); font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
        tr:last-child td { border-bottom: none; }

        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-header h3 { font-size: 1.125rem; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; line-height: 1; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end; }

        .verification-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(5, 150, 105, 0.1); border: 1px solid var(--primary); border-radius: 8px; font-size: 0.875rem; }
        .capture-info { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); background: var(--bg-input); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; }

        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; min-width: 280px; box-shadow: var(--shadow); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }

        .footer { text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.75rem; border-top: 1px solid var(--border); margin-top: 2rem; }
        .footer a { color: var(--primary); }

        .connection-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.connected { background: var(--success); }
        .status-dot.offline { background: var(--accent); }

        .admin-export-btns { display: none; }
        body.is-admin .admin-export-btns { display: flex; gap: 0.5rem; }

        @media (max-width: 640px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .header-actions { flex-direction: column; }
            .current-user { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="screen" id="loading-screen">
        <div class="loader-logo">Divert<span>Scan</span></div>
        <div class="loader-spinner" id="loader-spinner"></div>
        <div class="loader-status" id="loader-status">Initializing...</div>
        <div class="loader-error" id="loader-error">
            <p id="error-message">Failed to load</p>
            <button onclick="location.reload()">Retry</button>
            <button onclick="continueOffline()" style="margin-left:0.5rem;background:var(--bg-input);">Continue Offline</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="screen hidden" id="login-screen">
        <div class="login-box">
            <div class="login-title">
                <div class="login-logo">Divert<span>Scan</span></div>
                <h2>Select Your Account</h2>
                <p>Choose who you are to continue</p>
            </div>
            <div class="user-select-grid" id="user-select-grid"></div>
            <div class="pin-input-group" id="pin-group">
                <label>Enter PIN</label>
                <input type="tel" class="pin-input" id="pin-input" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            </div>
            <button class="login-btn" id="login-btn" disabled>Sign In</button>
            <p class="login-error" id="login-error">Incorrect PIN. Please try again.</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <header class="header">
            <div class="header-content">
                <div>
                    <div class="logo">Divert<span>Scan</span></div>
                    <span class="tagline">The Carbon Truth in Every Load</span>
                </div>
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-text">Connecting...</span>
                </div>
                <div class="header-actions">
                    <div class="current-user" id="current-user-display">
                        <div class="avatar admin" id="user-avatar">R</div>
                        <span id="user-name">User</span>
                        <button class="logout-btn" onclick="logout()" title="Sign Out">‚úï</button>
                    </div>
                    <div class="admin-export-btns">
                        <button class="btn btn-secondary" onclick="exportExcel()">Export</button>
                    </div>
                    <button class="btn btn-primary" onclick="openNewLoadModal()">+ New Load</button>
                </div>
            </div>
        </header>

        <main class="main">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-loads">0</div><div class="stat-label">Loads</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-tonnage">0</div><div class="stat-label">Tons</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-diversion">0%</div><div class="stat-label">Diverted</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-carbon">0</div><div class="stat-label">CO‚ÇÇe Saved</div></div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="loads">Loads</button>
                <button class="tab" data-tab="projects">Projects</button>
                <button class="tab admin-only" data-tab="reports">Reports</button>
            </div>

            <div class="tab-content active" id="tab-loads">
                <div class="card">
                    <div class="card-title">üì¶ Recent Loads</div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Project</th><th>Material</th><th>Tons</th><th>Destination</th><th>By</th><th>Status</th></tr></thead>
                            <tbody id="loads-table"><tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-projects">
                <div class="card">
                    <div class="card-title">üìÅ Projects</div>
                    <div id="projects-list"><p style="color:var(--text-muted);">Loading...</p></div>
                </div>
            </div>

            <div class="tab-content" id="tab-reports">
                <div class="card">
                    <div class="card-title">üìä Reports</div>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="exportExcel()">Dalmex Excel (24-col)</button>
                        <button class="btn btn-secondary" onclick="exportLEEDReport()">LEED Report</button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p><strong>DivertScan ¬© 2026</strong> | Powered by Dalmex Recycling LLC</p>
        </footer>
    </div>

    <!-- New Load Modal -->
    <div class="modal-overlay" id="new-load-modal">
        <div class="modal">
            <div class="modal-header"><h3>Add New Load</h3><button class="modal-close" onclick="closeModal('new-load-modal')">√ó</button></div>
            <div class="modal-body">
                <div class="verification-badge" style="margin-bottom:1rem;">üõ°Ô∏è Point-of-Capture Verification Active</div>
                <form id="new-load-form">
                    <div class="form-grid">
                        <div class="form-group"><label>Project *</label><select id="load-project" required><option value="">Select Project</option></select></div>
                        <div class="form-group"><label>Date *</label><input type="date" id="load-date" required></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Material *</label><select id="load-material" required><option value="">Select Material</option></select></div>
                        <div class="form-group"><label>Weight (tons) *</label><input type="number" id="load-weight" step="0.01" min="0" required placeholder="0.00"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Destination *</label><select id="load-destination-type" required><option value="">Select</option><option value="recycling">Recycling</option><option value="reuse">Reuse</option><option value="landfill">Landfill</option><option value="composting">Composting</option></select></div>
                        <div class="form-group"><label>Facility</label><input type="text" id="load-facility" placeholder="Facility name"></div>
                    </div>
                    <div class="form-group"><label>Hauler</label><input type="text" id="load-hauler" placeholder="Hauler company"></div>
                    <div class="form-group"><label>Ticket #</label><input type="text" id="load-ticket" placeholder="Scale ticket"></div>
                    <div class="form-group"><label>Notes</label><textarea id="load-notes" rows="2" placeholder="Notes..."></textarea></div>
                    <div class="capture-info" id="capture-info">Capturing data...</div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('new-load-modal')">Cancel</button><button class="btn btn-primary" onclick="saveLoad()">Save Load</button></div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    // ===== CONFIG =====
    const CONFIG = {
        SUPABASE_URL: 'https://rnaujdajnrlvndhmhvbk.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJuYXVqZGFqbnJsdm5kaG1odmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NTY2NDUsImV4cCI6MjA1MzMzMjY0NX0.T-DPJVQkfhngFDgcPOVNgnbBJbRpWxgi3D7Ts3ZWSRM'
    };

    // ===== USERS =====
    const USERS = [
        { id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', name: 'Robert', company: 'DivertScan', role: 'admin', pin: '1234', initials: 'RA' },
        { id: 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', name: 'Dalmex Floor', company: 'Dalmex Recycling', role: 'operator', pin: '5678', initials: 'DF' },
        { id: 'cccccccc-cccc-cccc-cccc-cccccccccccc', name: 'Jaguar Driver', company: 'Jaguar Waste', role: 'driver', pin: '9012', initials: 'JD' }
    ];

    // ===== MATERIALS =====
    const MATERIALS = [
        { name: 'Concrete', category: 'Aggregate', gwp: 0.107, tier: 'Standard' },
        { name: 'Asphalt', category: 'Aggregate', gwp: 0.094, tier: 'Standard' },
        { name: 'Wood - Clean', category: 'Wood', gwp: 0.912, tier: 'Tier 1' },
        { name: 'Wood - Treated', category: 'Wood', gwp: 0.312, tier: 'Standard' },
        { name: 'Metal - Ferrous', category: 'Metal', gwp: 1.831, tier: 'Standard' },
        { name: 'Metal - Non-Ferrous', category: 'Metal', gwp: 4.876, tier: 'Standard' },
        { name: 'Drywall/Gypsum', category: 'Drywall', gwp: 0.184, tier: 'Standard' },
        { name: 'Cardboard/OCC', category: 'Paper', gwp: 3.112, tier: 'Standard' },
        { name: 'Plastic - Mixed', category: 'Plastic', gwp: 1.423, tier: 'Standard' },
        { name: 'Roofing Materials', category: 'Mixed', gwp: 0.156, tier: 'Standard' },
        { name: 'Brick/Masonry', category: 'Aggregate', gwp: 0.089, tier: 'Standard' },
        { name: 'Glass', category: 'Glass', gwp: 0.423, tier: 'Standard' },
        { name: 'Mixed C&D', category: 'Mixed', gwp: 0.267, tier: 'Standard' },
        { name: 'Land Clearing Debris', category: 'Organic', gwp: 0.756, tier: 'Tier 1' },
        { name: 'Fixtures - Reuse', category: 'Reuse', gwp: 2.5, tier: 'Tier 1' },
        { name: 'Appliances - Reuse', category: 'Reuse', gwp: 3.2, tier: 'Tier 1' }
    ];

    // ===== PROJECTS =====
    const DEFAULT_PROJECTS = [
        { id: '11111111-1111-1111-1111-111111111111', name: "Children's Hospital Phase 2", client: "Children's Medical Center" },
        { id: '22222222-2222-2222-2222-222222222222', name: 'DFW Airport Terminal C', client: 'DFW Airport' },
        { id: '33333333-3333-3333-3333-333333333333', name: 'Frisco Town Center', client: 'City of Frisco' }
    ];

    // ===== STATE =====
    let supabaseClient = null;
    let currentUser = null;
    let selectedUserId = null;
    let gpsData = null;
    let ipData = null;
    let isConnected = false;

    // ===== INIT =====
    async function initialize() {
        try {
            updateStatus('Connecting...');
            
            // Try to init Supabase
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                // Test connection
                const { error } = await supabaseClient.from('loads').select('id').limit(1);
                isConnected = !error;
            }
            
            updateStatus('Loading...');
            
            // Get GPS/IP in background
            getGPSData().then(d => gpsData = d);
            getIPData().then(d => ipData = d);
            
            // Check saved session
            const saved = localStorage.getItem('divertscan_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            } else {
                showLogin();
            }
            
            updateConnectionStatus();
        } catch (e) {
            console.error('Init error:', e);
            showError('Connection failed. ' + e.message);
        }
    }

    function updateStatus(msg) {
        const el = document.getElementById('loader-status');
        if (el) el.textContent = msg;
    }

    function showError(msg) {
        document.getElementById('loader-spinner').style.display = 'none';
        document.getElementById('loader-status').style.display = 'none';
        document.getElementById('error-message').textContent = msg;
        document.getElementById('loader-error').classList.add('show');
    }

    function continueOffline() {
        isConnected = false;
        showLogin();
    }

    function showLogin() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        renderUserSelect();
    }

    function showApp() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.add('loaded');
        initApp();
        applyUserRole();
    }

    // ===== LOGIN =====
    function renderUserSelect() {
        document.getElementById('user-select-grid').innerHTML = USERS.map(u => `
            <button type="button" class="user-btn" data-id="${u.id}">
                <div class="user-avatar ${u.role}">${u.initials}</div>
                <div class="user-info"><h3>${u.name}</h3><p>${u.company} ‚Ä¢ ${u.role}</p></div>
            </button>
        `).join('');
        
        document.querySelectorAll('.user-btn').forEach(btn => {
            btn.addEventListener('click', () => selectUser(btn.dataset.id));
        });
    }

    function selectUser(id) {
        selectedUserId = id;
        document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('selected'));
        document.querySelector(`.user-btn[data-id="${id}"]`).classList.add('selected');
        document.getElementById('pin-group').classList.add('show');
        document.getElementById('pin-input').value = '';
        document.getElementById('pin-input').focus();
        document.getElementById('login-btn').disabled = false;
        document.getElementById('login-error').classList.remove('show');
    }

    document.getElementById('pin-input').addEventListener('input', function() {
        if (this.value.length === 4) doLogin();
    });

    document.getElementById('login-btn').addEventListener('click', doLogin);

    function doLogin() {
        const pin = document.getElementById('pin-input').value;
        const user = USERS.find(u => u.id === selectedUserId);
        if (user && user.pin === pin) {
            currentUser = user;
            localStorage.setItem('divertscan_user', JSON.stringify(user));
            showApp();
            showToast('Welcome, ' + user.name + '!', 'success');
        } else {
            document.getElementById('login-error').classList.add('show');
            document.getElementById('pin-input').value = '';
            document.getElementById('pin-input').focus();
        }
    }

    function logout() {
        localStorage.removeItem('divertscan_user');
        currentUser = null;
        document.getElementById('app').classList.remove('loaded');
        document.body.classList.remove('is-admin');
        showLogin();
    }

    function applyUserRole() {
        if (!currentUser) return;
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.initials;
        document.getElementById('user-avatar').className = 'avatar ' + currentUser.role;
        document.body.classList.toggle('is-admin', currentUser.role === 'admin');
    }

    // ===== APP =====
    function initApp() {
        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        
        // Set today's date
        document.getElementById('load-date').valueAsDate = new Date();
        
        // Load data
        loadMaterials();
        loadProjects();
        loadLoads();
    }

    function loadMaterials() {
        document.getElementById('load-material').innerHTML = '<option value="">Select Material</option>' + 
            MATERIALS.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
    }

    async function loadProjects() {
        let projects = DEFAULT_PROJECTS;
        
        if (isConnected && supabaseClient) {
            try {
                const { data } = await supabaseClient.from('projects').select('*');
                if (data && data.length) projects = data;
            } catch (e) { console.warn('Projects fetch failed'); }
        }
        
        window.projectsData = projects;
        
        document.getElementById('load-project').innerHTML = '<option value="">Select Project</option>' + 
            projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        
        document.getElementById('projects-list').innerHTML = projects.map(p => `
            <div style="padding:1rem;border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;">
                <strong>${p.name}</strong><br>
                <span style="color:var(--text-muted);font-size:0.875rem;">${p.client || ''}</span>
            </div>
        `).join('');
    }

    async function loadLoads() {
        let loads = [];
        
        if (isConnected && supabaseClient) {
            try {
                const { data } = await supabaseClient.from('loads').select('*').order('created_at', { ascending: false }).limit(50);
                if (data) loads = data;
            } catch (e) { console.warn('Loads fetch failed'); }
        }
        
        window.loadsData = loads;
        renderLoads(loads);
        updateStats();
    }

    function renderLoads(loads) {
        const tbody = document.getElementById('loads-table');
        if (!loads.length) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem;">No loads yet. Tap "+ New Load" to add one.</td></tr>';
            return;
        }
        tbody.innerHTML = loads.map(l => {
            const proj = (window.projectsData || []).find(p => p.id === l.project_id);
            const isDiverted = ['recycling','reuse','composting'].includes(l.destination_type);
            return `<tr>
                <td>${new Date(l.load_date || l.created_at).toLocaleDateString()}</td>
                <td>${proj?.name || '-'}</td>
                <td>${l.material || '-'}</td>
                <td>${parseFloat(l.weight_tons||0).toFixed(2)}</td>
                <td>${l.facility_name || l.destination_type || '-'}</td>
                <td>${l.entered_by_name || '-'}</td>
                <td><span class="badge ${isDiverted?'badge-success':'badge-warning'}">${isDiverted?'Diverted':'Disposed'}</span></td>
            </tr>`;
        }).join('');
    }

    function updateStats() {
        const loads = window.loadsData || [];
        const total = loads.reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
        const diverted = loads.filter(l => ['recycling','reuse','composting'].includes(l.destination_type)).reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
        let carbon = 0;
        loads.forEach(l => {
            if (['recycling','reuse','composting'].includes(l.destination_type)) {
                const m = MATERIALS.find(x => x.name === l.material);
                if (m) carbon += parseFloat(l.weight_tons||0) * m.gwp;
            }
        });
        document.getElementById('stat-loads').textContent = loads.length;
        document.getElementById('stat-tonnage').textContent = total.toFixed(1);
        document.getElementById('stat-diversion').textContent = (total > 0 ? (diverted/total*100) : 0).toFixed(0) + '%';
        document.getElementById('stat-carbon').textContent = carbon.toFixed(1);
    }

    function updateConnectionStatus() {
        document.getElementById('status-dot').classList.toggle('connected', isConnected);
        document.getElementById('connection-text').textContent = isConnected ? 'Online' : 'Offline';
    }

    // ===== GPS/IP =====
    async function getGPSData() {
        return new Promise(resolve => {
            if (!navigator.geolocation) { resolve(null); return; }
            navigator.geolocation.getCurrentPosition(
                p => resolve({ lat: p.coords.latitude.toFixed(6), lng: p.coords.longitude.toFixed(6), acc: p.coords.accuracy }),
                () => resolve(null),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }

    async function getIPData() {
        try {
            const r = await fetch('https://api.ipify.org?format=json');
            const d = await r.json();
            return { ip: d.ip };
        } catch { return null; }
    }

    // ===== MODAL =====
    function openNewLoadModal() {
        document.getElementById('new-load-modal').classList.add('active');
        document.getElementById('load-date').valueAsDate = new Date();
        updateCaptureInfo();
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    function updateCaptureInfo() {
        const parts = [];
        if (gpsData) parts.push('GPS: ' + gpsData.lat + ', ' + gpsData.lng);
        else parts.push('GPS: N/A');
        if (ipData) parts.push('IP: ' + ipData.ip);
        parts.push('User: ' + (currentUser?.name || 'Unknown'));
        parts.push('Time: ' + new Date().toLocaleString());
        document.getElementById('capture-info').textContent = parts.join(' | ');
    }

    // ===== SAVE LOAD =====
    async function saveLoad() {
        const data = {
            project_id: document.getElementById('load-project').value,
            load_date: document.getElementById('load-date').value,
            material: document.getElementById('load-material').value,
            weight_tons: parseFloat(document.getElementById('load-weight').value),
            destination_type: document.getElementById('load-destination-type').value,
            facility_name: document.getElementById('load-facility').value || null,
            hauler: document.getElementById('load-hauler').value || null,
            ticket_number: document.getElementById('load-ticket').value || null,
            notes: document.getElementById('load-notes').value || null,
            gps_latitude: gpsData?.lat || null,
            gps_longitude: gpsData?.lng || null,
            ip_address: ipData?.ip || null,
            capture_timestamp: new Date().toISOString(),
            entered_by: currentUser?.id || null,
            entered_by_name: currentUser?.name || 'Unknown'
        };

        if (!data.project_id || !data.material || !data.weight_tons || !data.destination_type) {
            showToast('Fill in all required fields', 'error');
            return;
        }

        try {
            if (isConnected && supabaseClient) {
                const { error } = await supabaseClient.from('loads').insert([data]);
                if (error) throw error;
            } else {
                // Offline - add to local
                data.id = 'local-' + Date.now();
                data.created_at = new Date().toISOString();
                window.loadsData = window.loadsData || [];
                window.loadsData.unshift(data);
                renderLoads(window.loadsData);
                updateStats();
            }
            
            showToast('Load saved!', 'success');
            closeModal('new-load-modal');
            document.getElementById('new-load-form').reset();
            if (isConnected) loadLoads();
        } catch (e) {
            console.error('Save error:', e);
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ===== TOAST =====
    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = 'toast toast-' + type;
        t.textContent = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    // ===== EXPORT =====
    async function exportExcel() {
        showToast('Generating Excel...', 'info');
        try {
            // Load SheetJS if needed
            if (!window.XLSX) {
                await new Promise((resolve, reject) => {
                    const s = document.createElement('script');
                    s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                    s.onload = resolve;
                    s.onerror = reject;
                    document.head.appendChild(s);
                });
            }
            
            const loads = window.loadsData || [];
            const wb = XLSX.utils.book_new();
            
            // Summary
            const summary = [['DivertScan ¬© 2026'],['Powered by Dalmex Recycling LLC'],[''],['Generated:', new Date().toLocaleString()],['Loads:', loads.length]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');
            
            // Loads
            const headers = ['Date','Project','Material','Tons','Destination','Facility','Hauler','Ticket','GPS','IP','Entered By','Status'];
            const rows = loads.map(l => {
                const proj = (window.projectsData||[]).find(p=>p.id===l.project_id);
                const isDiverted = ['recycling','reuse','composting'].includes(l.destination_type);
                return [l.load_date, proj?.name||'', l.material, l.weight_tons, l.destination_type, l.facility_name||'', l.hauler||'', l.ticket_number||'', l.gps_latitude ? l.gps_latitude+','+l.gps_longitude : '', l.ip_address||'', l.entered_by_name||'', isDiverted?'Diverted':'Disposed'];
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headers,...rows]), 'Loads');
            
            XLSX.writeFile(wb, 'DivertScan_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showToast('Downloaded!', 'success');
        } catch (e) {
            showToast('Export failed', 'error');
            console.error(e);
        }
    }

    async function exportLEEDReport() {
        showToast('Generating LEED report...', 'info');
        // Same as exportExcel but with LEED format
        exportExcel();
    }

    // ===== START =====
    window.addEventListener('online', () => { isConnected = true; updateConnectionStatus(); showToast('Back online', 'success'); });
    window.addEventListener('offline', () => { isConnected = false; updateConnectionStatus(); showToast('Offline mode', 'info'); });
    
    // Wait for DOM
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
    } else {
        initialize();
    }
    </script>
</body>
</html>
