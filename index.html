<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan‚Ñ¢ | LEED Waste Diversion Platform</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôªÔ∏è</text></svg>">
    <style>
        :root {
            --slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;
            --slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;
            --emerald-600:#059669;--emerald-500:#10b981;--emerald-400:#34d399;
            --blue-600:#2563eb;--blue-500:#3b82f6;--purple-500:#8b5cf6;
            --amber-500:#f59e0b;--red-500:#ef4444;--teal-500:#14b8a6;
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--slate-900);color:var(--slate-200);min-height:100vh}
        .hidden{display:none!important}
        .loading-screen{position:fixed;inset:0;background:var(--slate-900);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
        .loading-logo{width:80px;height:80px;background:linear-gradient(135deg,var(--emerald-500),var(--teal-500));border-radius:20px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
        .loading-logo svg{width:48px;height:48px;color:white}
        .loading-text{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--emerald-400),var(--teal-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:24px}
        .loading-spinner{width:40px;height:40px;border:3px solid var(--slate-700);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
        .auth-card{background:var(--slate-800);border-radius:16px;padding:32px;width:100%;max-width:400px;border:1px solid var(--slate-700)}
        .auth-logo{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px}
        .auth-logo-icon{width:48px;height:48px;background:linear-gradient(135deg,var(--emerald-500),var(--teal-500));border-radius:12px;display:flex;align-items:center;justify-content:center}
        .auth-logo-icon svg{width:28px;height:28px;color:white}
        .auth-logo-text{font-size:24px;font-weight:700;background:linear-gradient(135deg,var(--emerald-400),var(--teal-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .auth-tagline{text-align:center;color:var(--slate-400);font-size:13px;margin-bottom:24px}
        .auth-title{text-align:center;font-size:20px;margin-bottom:20px}
        .auth-error{background:rgba(239,68,68,0.1);border:1px solid var(--red-500);color:var(--red-500);padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;display:none}
        .auth-switch{text-align:center;margin-top:20px;color:var(--slate-400);font-size:14px}
        .auth-switch a{color:var(--emerald-400);cursor:pointer;text-decoration:none}
        .form-group{margin-bottom:16px}
        .form-label{display:block;font-size:13px;color:var(--slate-400);margin-bottom:6px}
        .form-input{width:100%;padding:12px 14px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:white;font-size:15px;outline:none;transition:border-color 0.2s}
        .form-input:focus{border-color:var(--emerald-500)}
        .form-input::placeholder{color:var(--slate-500)}
        .btn{padding:12px 20px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
        .btn-primary{background:linear-gradient(135deg,var(--emerald-600),var(--teal-500));color:white;width:100%}
        .btn-primary:hover{opacity:0.9}
        .btn-primary:active{transform:scale(0.98)}
        .btn-secondary{background:var(--slate-700);color:var(--slate-200);border:1px solid var(--slate-600)}
        .btn-danger{background:var(--red-500);color:white}
        .btn-sm{padding:8px 14px;font-size:13px}
        .nav{background:var(--slate-800);border-bottom:1px solid var(--slate-700);padding:12px 16px;position:sticky;top:0;z-index:100}
        .nav-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        .nav-brand{display:flex;align-items:center;gap:10px}
        .nav-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--emerald-500),var(--teal-500));border-radius:10px;display:flex;align-items:center;justify-content:center}
        .nav-logo svg{width:22px;height:22px;color:white}
        .nav-title{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--emerald-400),var(--teal-500));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .nav-user{font-size:13px;color:var(--slate-400)}
        .nav-signout{background:none;border:none;color:var(--emerald-400);cursor:pointer;font-size:13px;margin-left:12px}
        .project-bar{background:var(--slate-800);border-bottom:1px solid var(--slate-700);padding:10px 16px}
        .project-bar-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px}
        .project-selector{flex:1;padding:10px 12px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:white;font-size:14px}
        .tabs{background:var(--slate-800);border-bottom:1px solid var(--slate-700);padding:0 16px;overflow-x:auto}
        .tabs-content{max-width:1200px;margin:0 auto;display:flex;gap:4px}
        .tab{padding:14px 18px;background:none;border:none;color:var(--slate-400);font-size:14px;font-weight:500;cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap}
        .tab.active{color:var(--emerald-400);border-bottom-color:var(--emerald-400)}
        .main{max-width:1200px;margin:0 auto;padding:20px 16px}
        .page{display:none}
        .page.active{display:block}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px}
        .stat-card{background:var(--slate-800);border-radius:12px;padding:16px;border:1px solid var(--slate-700)}
        .stat-label{font-size:12px;color:var(--slate-400);margin-bottom:4px}
        .stat-value{font-size:24px;font-weight:700;color:white}
        .stat-value.green{color:var(--emerald-400)}
        .stat-value.blue{color:var(--blue-500)}
        .stat-value.purple{color:var(--purple-500)}
        .card{background:var(--slate-800);border-radius:12px;padding:20px;border:1px solid var(--slate-700);margin-bottom:16px}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .card-title{font-size:16px;font-weight:600}
        .table-wrap{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th,td{padding:12px 10px;text-align:left;border-bottom:1px solid var(--slate-700)}
        th{color:var(--slate-400);font-weight:500;font-size:11px;text-transform:uppercase}
        tr:hover{background:var(--slate-700)}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.active{display:flex}
        .modal{background:var(--slate-800);border-radius:16px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;border:1px solid var(--slate-700)}
        .modal-header{padding:20px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:18px;font-weight:600}
        .modal-close{background:none;border:none;color:var(--slate-400);font-size:24px;cursor:pointer;line-height:1}
        .modal-body{padding:20px}
        .modal-footer{padding:16px 20px;border-top:1px solid var(--slate-700);display:flex;gap:12px;justify-content:flex-end}
        .material-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        .material-item{background:var(--slate-700);border-radius:8px;padding:12px}
        .material-name{font-size:13px;font-weight:500;margin-bottom:8px;display:flex;align-items:center;gap:6px}
        .material-input{display:flex;align-items:center;gap:8px}
        .material-input input{width:60px;padding:6px 8px;background:var(--slate-800);border:1px solid var(--slate-600);border-radius:6px;color:white;font-size:14px;text-align:center}
        .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--slate-800);border:1px solid var(--slate-600);padding:12px 20px;border-radius:10px;font-size:14px;z-index:2000;opacity:0;transition:all 0.3s}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{border-color:var(--emerald-500);color:var(--emerald-400)}
        .toast.error{border-color:var(--red-500);color:var(--red-500)}
        .scan-options{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px}
        .scan-option{background:var(--slate-700);border:2px solid var(--slate-600);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
        .scan-option:hover{border-color:var(--emerald-500)}
        .scan-option-icon{font-size:32px;margin-bottom:8px}
        .scan-option-title{font-size:14px;font-weight:600}
        .scan-option-desc{font-size:12px;color:var(--slate-400)}
        .photo-preview{width:100%;max-height:200px;object-fit:contain;border-radius:8px;margin-bottom:12px;background:var(--slate-900)}
        .progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden;margin-top:8px}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--emerald-500),var(--teal-500));transition:width 0.3s}
        .footer{text-align:center;padding:24px;color:var(--slate-600);font-size:11px}
        input[type="file"]{display:none}
        .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s linear infinite}
        @media(max-width:768px){.stats-grid{grid-template-columns:repeat(2,1fr)}.material-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></div>
        <div class="loading-text">DivertScan‚Ñ¢</div>
        <div class="loading-spinner"></div>
    </div>
    <div class="auth-screen hidden" id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="auth-logo-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></div>
                <span class="auth-logo-text">DivertScan‚Ñ¢</span>
            </div>
            <p class="auth-tagline">LEED v5 MRp2 Waste Diversion</p>
            <h2 class="auth-title" id="authTitle">Sign In</h2>
            <div class="auth-error" id="authError"></div>
            <div class="form-group hidden" id="nameGroup">
                <label class="form-label">Full Name</label>
                <input type="text" class="form-input" id="authName" placeholder="Your name">
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="authEmail" placeholder="you@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
            </div>
            <button type="button" class="btn btn-primary" id="authSubmit">Sign In</button>
            <p class="auth-switch"><span id="authSwitchText">Don't have an account?</span> <a id="authSwitchLink">Sign Up</a></p>
        </div>
    </div>
    <div class="app hidden" id="mainApp">
        <input type="file" id="ticketCamera" accept="image/*" capture="environment">
        <input type="file" id="ticketUpload" accept="image/*,.pdf">
        <input type="file" id="debrisCamera" accept="image/*" capture="environment">
        <input type="file" id="debrisUpload" accept="image/*">
        <input type="file" id="importFile" accept=".xlsx,.xls,.csv">
        <nav class="nav">
            <div class="nav-content">
                <div class="nav-brand">
                    <div class="nav-logo"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg></div>
                    <span class="nav-title">DivertScan‚Ñ¢</span>
                </div>
                <div>
                    <span class="nav-user" id="navUser"></span>
                    <button class="nav-signout" id="signOutBtn">Sign Out</button>
                </div>
            </div>
        </nav>
        <div class="project-bar">
            <div class="project-bar-content">
                <select class="project-selector" id="projectSelector"><option value="">Select Project...</option></select>
                <button class="btn btn-sm btn-secondary" id="newProjectBtn">+ New</button>
            </div>
        </div>
        <div class="tabs">
            <div class="tabs-content">
                <button class="tab active" data-page="dashboard">Dashboard</button>
                <button class="tab" data-page="tickets">Tickets</button>
                <button class="tab" data-page="scan">Scan</button>
                <button class="tab" data-page="reports">Reports</button>
                <button class="tab" data-page="settings">Settings</button>
            </div>
        </div>
        <main class="main">
            <div class="page active" id="dashboardPage">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Total Tickets</div><div class="stat-value" id="statTickets">0</div></div>
                    <div class="stat-card"><div class="stat-label">Total Tons</div><div class="stat-value green" id="statTons">0.00</div></div>
                    <div class="stat-card"><div class="stat-label">Diversion Rate</div><div class="stat-value blue" id="statDiversion">0%</div></div>
                    <div class="stat-card"><div class="stat-label">CO‚ÇÇe Saved</div><div class="stat-value purple" id="statCO2">0 MT</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Recent Tickets</span></div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Date</th><th>Ticket #</th><th>Net (tons)</th><th>Diversion</th></tr></thead><tbody id="recentTicketsBody"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="page" id="ticketsPage">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">All Tickets</span>
                        <button class="btn btn-sm btn-primary" id="addTicketBtn">+ Add Ticket</button>
                    </div>
                    <div class="table-wrap">
                        <table><thead><tr><th>Date</th><th>Ticket #</th><th>Gross</th><th>Tare</th><th>Net</th><th>Diversion</th><th>Actions</th></tr></thead><tbody id="ticketsTableBody"></tbody></table>
                    </div>
                </div>
            </div>
            <div class="page" id="scanPage">
                <div class="card">
                    <div class="card-title" style="margin-bottom:16px">Capture Data</div>
                    <div class="scan-options">
                        <div class="scan-option" id="scanTicketOption">
                            <div class="scan-option-icon">üìÑ</div>
                            <div class="scan-option-title">Scale Ticket</div>
                            <div class="scan-option-desc">OCR scan ticket</div>
                        </div>
                        <div class="scan-option" id="scanDebrisOption">
                            <div class="scan-option-icon">üì∏</div>
                            <div class="scan-option-title">Debris Photo</div>
                            <div class="scan-option-desc">AI material analysis</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page" id="reportsPage">
                <div class="card">
                    <div class="card-title" style="margin-bottom:16px">Export Reports</div>
                    <div style="display:grid;gap:12px">
                        <button class="btn btn-secondary" id="exportExcelBtn">üìä Excel Export (Dalmex Format)</button>
                        <button class="btn btn-secondary" id="exportLEEDBtn">üìã LEED MRp2/MRc5 Report (PDF)</button>
                        <button class="btn btn-secondary" id="exportAuditorBtn">üì¶ Auditor Package (PDF)</button>
                        <button class="btn btn-secondary" id="exportCSVBtn">üìë CSV Export</button>
                        <hr style="border-color:var(--slate-700)">
                        <button class="btn btn-secondary" id="importExcelBtn">üì• Import from Excel</button>
                    </div>
                </div>
            </div>
            <div class="page" id="settingsPage">
                <div class="card">
                    <div class="card-title" style="margin-bottom:16px">Settings</div>
                    <div class="form-group">
                        <label class="form-label">OpenAI API Key (for OCR/AI)</label>
                        <input type="password" class="form-input" id="apiKeyInput" placeholder="sk-...">
                    </div>
                    <button class="btn btn-primary" id="saveSettingsBtn" style="width:auto">Save Settings</button>
                </div>
            </div>
        </main>
        <div class="footer">DivertScan‚Ñ¢ v1.0 | LEED v5 MRp2 Waste Diversion | ¬© 2025</div>
    </div>
    <div class="modal-overlay" id="projectModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">New Project</span><button class="modal-close" onclick="closeModal('projectModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Project Name *</label><input type="text" class="form-input" id="projectName" placeholder="Project name"></div>
                <div class="form-group"><label class="form-label">Client</label><input type="text" class="form-input" id="projectClient" placeholder="Client name"></div>
                <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="projectLocation" placeholder="City, State"></div>
                <div class="form-group"><label class="form-label">LEED Version</label><select class="form-input" id="projectLEED"><option value="v4">LEED v4</option><option value="v4.1">LEED v4.1</option><option value="v5" selected>LEED v5</option></select></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button><button class="btn btn-primary" id="saveProjectBtn">Create Project</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="ticketModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title" id="ticketModalTitle">Add Ticket</span><button class="modal-close" onclick="closeModal('ticketModal')">&times;</button></div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Ticket # *</label><input type="text" class="form-input" id="ticketNumber" placeholder="12345"></div>
                    <div class="form-group"><label class="form-label">Date *</label><input type="date" class="form-input" id="ticketDate"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" class="form-input" id="ticketGross" placeholder="40000"></div>
                    <div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" class="form-input" id="ticketTare" placeholder="15000"></div>
                </div>
                <div class="form-group"><label class="form-label">Hauler</label><input type="text" class="form-input" id="ticketHauler" placeholder="Hauler name"></div>
                <div class="form-group"><label class="form-label">Container Size</label><select class="form-input" id="ticketContainer"><option value="20">20 yard</option><option value="30" selected>30 yard</option><option value="40">40 yard</option></select></div>
                <div class="form-group">
                    <label class="form-label">Material Breakdown (%)</label>
                    <div class="material-grid">
                        <div class="material-item"><div class="material-name">ü™µ Wood</div><div class="material-input"><input type="number" id="matWood" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">üß± Gypsum</div><div class="material-input"><input type="number" id="matGypsum" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">‚ôªÔ∏è Plastic</div><div class="material-input"><input type="number" id="matPlastic" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">üì¶ OCC</div><div class="material-input"><input type="number" id="matOCC" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">üî© Metal</div><div class="material-input"><input type="number" id="matMetal" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">ü™® Concrete</div><div class="material-input"><input type="number" id="matConcrete" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">üß± Block</div><div class="material-input"><input type="number" id="matBlock" value="0" min="0" max="100"><span>%</span></div></div>
                        <div class="material-item"><div class="material-name">üóëÔ∏è Landfill</div><div class="material-input"><input type="number" id="matLandfill" value="0" min="0" max="100"><span>%</span></div></div>
                    </div>
                    <div style="margin-top:8px;font-size:12px;color:var(--slate-400)">Total: <span id="materialTotal">0</span>%</div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('ticketModal')">Cancel</button><button class="btn btn-primary" id="saveTicketBtn">Save Ticket</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="scanTicketModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Scan Scale Ticket</span><button class="modal-close" onclick="closeModal('scanTicketModal')">&times;</button></div>
            <div class="modal-body">
                <img id="ticketPreview" class="photo-preview hidden">
                <div id="ticketScanButtons">
                    <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="document.getElementById('ticketCamera').click()">üì∑ Take Photo</button>
                    <button class="btn btn-secondary" style="width:100%" onclick="document.getElementById('ticketUpload').click()">üìÅ Upload Image</button>
                </div>
                <div id="ticketAnalyzing" class="hidden" style="text-align:center;padding:20px"><div class="loading" style="width:32px;height:32px;margin:0 auto 12px"></div><div>Analyzing ticket with OCR...</div></div>
                <div id="ticketResults" class="hidden"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('scanTicketModal')">Cancel</button><button class="btn btn-primary hidden" id="saveScannedTicketBtn">Save Ticket</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="scanDebrisModal">
        <div class="modal">
            <div class="modal-header"><span class="modal-title">Analyze Debris Photo</span><button class="modal-close" onclick="closeModal('scanDebrisModal')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Container Size</label><select class="form-input" id="debrisContainer"><option value="20">20 yard</option><option value="30" selected>30 yard</option><option value="40">40 yard</option></select></div>
                <img id="debrisPreview" class="photo-preview hidden">
                <div id="debrisScanButtons">
                    <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="document.getElementById('debrisCamera').click()">üì∑ Take Photo</button>
                    <button class="btn btn-secondary" style="width:100%" onclick="document.getElementById('debrisUpload').click()">üìÅ Upload Image</button>
                </div>
                <div id="debrisAnalyzing" class="hidden" style="text-align:center;padding:20px"><div class="loading" style="width:32px;height:32px;margin:0 auto 12px"></div><div>Analyzing debris with AI...</div></div>
                <div id="debrisResults" class="hidden"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('scanDebrisModal')">Cancel</button><button class="btn btn-primary hidden" id="applyDebrisBtn">Apply to New Ticket</button></div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
    var SUPABASE_URL = 'https://cyvvlngtojagfoaitoog.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g';
    var GWP = {wood:-0.77,gypsum:0.02,plastic:1.52,occ:-3.12,metal:-4.21,concrete:0.01,block:0.01,landfill:0.52};
    var supabase, currentUser, currentProject, tickets = [], projects = [], editingTicketId = null, scannedTicketData = null, analyzedDebrisData = null, isSignUp = false;

    function loadSupabase(callback) {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = callback;
        script.onerror = function() { alert('Failed to load. Check internet connection.'); };
        document.head.appendChild(script);
    }

    function init() {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        supabase.auth.getSession().then(function(result) {
            if (result.data.session) {
                currentUser = result.data.session.user;
                showApp();
            } else {
                showAuth();
            }
        }).catch(function() { showAuth(); });
    }

    function showAuth() {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }

    function showApp() {
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('navUser').textContent = currentUser.email;
        var apiKey = localStorage.getItem('openai_api_key');
        if (apiKey) document.getElementById('apiKeyInput').value = apiKey;
        loadProjects();
        setupEventListeners();
    }

    document.getElementById('authSwitchLink').onclick = function() {
        isSignUp = !isSignUp;
        document.getElementById('authTitle').textContent = isSignUp ? 'Sign Up' : 'Sign In';
        document.getElementById('authSubmit').textContent = isSignUp ? 'Sign Up' : 'Sign In';
        document.getElementById('authSwitchText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
        document.getElementById('authSwitchLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
        document.getElementById('nameGroup').classList.toggle('hidden', !isSignUp);
        document.getElementById('authError').style.display = 'none';
    };

    document.getElementById('authSubmit').onclick = function() {
        var email = document.getElementById('authEmail').value.trim();
        var password = document.getElementById('authPassword').value;
        var name = document.getElementById('authName').value.trim();
        if (!email || !password) { showAuthError('Please enter email and password'); return; }
        if (isSignUp && !name) { showAuthError('Please enter your name'); return; }
        var btn = document.getElementById('authSubmit');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Please wait...';
        var authPromise = isSignUp ? 
            supabase.auth.signUp({email:email,password:password,options:{data:{full_name:name}}}) :
            supabase.auth.signInWithPassword({email:email,password:password});
        authPromise.then(function(result) {
            if (result.error) { showAuthError(result.error.message); btn.disabled = false; btn.textContent = isSignUp ? 'Sign Up' : 'Sign In'; return; }
            if (isSignUp && !result.data.session) { showAuthError('Check your email to confirm your account'); btn.disabled = false; btn.textContent = 'Sign Up'; return; }
            currentUser = result.data.user;
            showApp();
        }).catch(function(err) { showAuthError(err.message); btn.disabled = false; btn.textContent = isSignUp ? 'Sign Up' : 'Sign In'; });
    };

    document.getElementById('signOutBtn').onclick = function() {
        supabase.auth.signOut().then(function() {
            currentUser = null; currentProject = null; tickets = []; projects = [];
            showAuth();
        });
    };

    function showAuthError(msg) { var el = document.getElementById('authError'); el.textContent = msg; el.style.display = 'block'; }

    function loadProjects() {
        supabase.from('projects').select('*').eq('user_id', currentUser.id).order('created_at', {ascending:false}).then(function(result) {
            projects = result.data || [];
            var select = document.getElementById('projectSelector');
            select.innerHTML = '<option value="">Select Project...</option>';
            projects.forEach(function(p) {
                var opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                select.appendChild(opt);
            });
            if (projects.length > 0) { select.value = projects[0].id; selectProject(projects[0].id); }
        });
    }

    function selectProject(projectId) {
        currentProject = projects.find(function(p) { return p.id === projectId; });
        if (currentProject) loadTickets();
    }

    function saveProject() {
        var name = document.getElementById('projectName').value.trim();
        if (!name) { showToast('Project name is required', 'error'); return; }
        var projectData = {
            user_id: currentUser.id, name: name,
            client: document.getElementById('projectClient').value.trim(),
            location: document.getElementById('projectLocation').value.trim(),
            leed_version: document.getElementById('projectLEED').value
        };
        supabase.from('projects').insert([projectData]).select().then(function(result) {
            if (result.error) { showToast('Error: ' + result.error.message, 'error'); return; }
            closeModal('projectModal');
            showToast('Project created!', 'success');
            loadProjects();
        });
    }

    function loadTickets() {
        if (!currentProject) return;
        supabase.from('tickets').select('*').eq('project_id', currentProject.id).order('ticket_date', {ascending:false}).then(function(result) {
            tickets = result.data || [];
            updateDashboard();
            updateTicketsTable();
        });
    }

    function updateDashboard() {
        document.getElementById('statTickets').textContent = tickets.length;
        var totalTons = tickets.reduce(function(sum, t) { return sum + (t.net_tons || 0); }, 0);
        document.getElementById('statTons').textContent = totalTons.toFixed(2);
        var totalDiverted = 0, totalWeight = 0;
        tickets.forEach(function(t) {
            var net = t.net_tons || 0, div = t.diversion_rate || 0;
            totalDiverted += net * (div / 100);
            totalWeight += net;
        });
        var avgDiversion = totalWeight > 0 ? (totalDiverted / totalWeight * 100) : 0;
        document.getElementById('statDiversion').textContent = avgDiversion.toFixed(1) + '%';
        var totalCO2 = 0;
        tickets.forEach(function(t) {
            if (t.material_breakdown) {
                var mb = typeof t.material_breakdown === 'string' ? JSON.parse(t.material_breakdown) : t.material_breakdown;
                var net = t.net_tons || 0;
                Object.keys(mb).forEach(function(mat) {
                    var pct = mb[mat] / 100, tons = net * pct;
                    totalCO2 += tons * (GWP[mat] || 0);
                });
            }
        });
        document.getElementById('statCO2').textContent = Math.abs(totalCO2).toFixed(2) + ' MT';
        var tbody = document.getElementById('recentTicketsBody');
        tbody.innerHTML = '';
        tickets.slice(0, 5).forEach(function(t) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + formatDate(t.ticket_date) + '</td><td>' + (t.ticket_number || '-') + '</td><td>' + (t.net_tons || 0).toFixed(2) + '</td><td>' + (t.diversion_rate || 0) + '%</td>';
            tbody.appendChild(tr);
        });
    }

    function updateTicketsTable() {
        var tbody = document.getElementById('ticketsTableBody');
        tbody.innerHTML = '';
        tickets.forEach(function(t) {
            var tr = document.createElement('tr');
            tr.innerHTML = '<td>' + formatDate(t.ticket_date) + '</td><td>' + (t.ticket_number || '-') + '</td><td>' + (t.gross_lbs || 0).toLocaleString() + '</td><td>' + (t.tare_lbs || 0).toLocaleString() + '</td><td>' + (t.net_tons || 0).toFixed(2) + 'T</td><td>' + (t.diversion_rate || 0) + '%</td><td><button class="btn btn-sm btn-secondary" onclick="editTicket(\'' + t.id + '\')">Edit</button> <button class="btn btn-sm btn-danger" onclick="deleteTicket(\'' + t.id + '\')">Del</button></td>';
            tbody.appendChild(tr);
        });
    }
    function openTicketModal(ticket) {
        editingTicketId = ticket ? ticket.id : null;
        document.getElementById('ticketModalTitle').textContent = ticket ? 'Edit Ticket' : 'Add Ticket';
        document.getElementById('ticketNumber').value = ticket ? ticket.ticket_number : '';
        document.getElementById('ticketDate').value = ticket ? ticket.ticket_date : new Date().toISOString().split('T')[0];
        document.getElementById('ticketGross').value = ticket ? ticket.gross_lbs : '';
        document.getElementById('ticketTare').value = ticket ? ticket.tare_lbs : '';
        document.getElementById('ticketHauler').value = ticket ? ticket.hauler : '';
        document.getElementById('ticketContainer').value = ticket ? ticket.container_size : '30';
        var mb = ticket && ticket.material_breakdown ? (typeof ticket.material_breakdown === 'string' ? JSON.parse(ticket.material_breakdown) : ticket.material_breakdown) : {};
        document.getElementById('matWood').value = mb.wood || 0;
        document.getElementById('matGypsum').value = mb.gypsum || 0;
        document.getElementById('matPlastic').value = mb.plastic || 0;
        document.getElementById('matOCC').value = mb.occ || 0;
        document.getElementById('matMetal').value = mb.metal || 0;
        document.getElementById('matConcrete').value = mb.concrete || 0;
        document.getElementById('matBlock').value = mb.block || 0;
        document.getElementById('matLandfill').value = mb.landfill || 0;
        updateMaterialTotal();
        openModal('ticketModal');
    }

    function updateMaterialTotal() {
        var total = ['Wood','Gypsum','Plastic','OCC','Metal','Concrete','Block','Landfill'].reduce(function(sum, m) { return sum + parseInt(document.getElementById('mat'+m).value || 0); }, 0);
        document.getElementById('materialTotal').textContent = total;
        document.getElementById('materialTotal').style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
    }

    function saveTicket() {
        if (!currentProject) { showToast('Please select a project first', 'error'); return; }
        var ticketNumber = document.getElementById('ticketNumber').value.trim();
        var ticketDate = document.getElementById('ticketDate').value;
        if (!ticketNumber || !ticketDate) { showToast('Ticket # and Date are required', 'error'); return; }
        var grossLbs = parseInt(document.getElementById('ticketGross').value) || 0;
        var tareLbs = parseInt(document.getElementById('ticketTare').value) || 0;
        var netLbs = grossLbs - tareLbs;
        var netTons = netLbs / 2000;
        var materialBreakdown = {
            wood: parseInt(document.getElementById('matWood').value) || 0,
            gypsum: parseInt(document.getElementById('matGypsum').value) || 0,
            plastic: parseInt(document.getElementById('matPlastic').value) || 0,
            occ: parseInt(document.getElementById('matOCC').value) || 0,
            metal: parseInt(document.getElementById('matMetal').value) || 0,
            concrete: parseInt(document.getElementById('matConcrete').value) || 0,
            block: parseInt(document.getElementById('matBlock').value) || 0,
            landfill: parseInt(document.getElementById('matLandfill').value) || 0
        };
        var diversionRate = 100 - materialBreakdown.landfill;
        var ticketData = {
            project_id: currentProject.id, user_id: currentUser.id, ticket_number: ticketNumber, ticket_date: ticketDate,
            gross_lbs: grossLbs, tare_lbs: tareLbs, net_lbs: netLbs, net_tons: netTons,
            hauler: document.getElementById('ticketHauler').value.trim(),
            container_size: parseInt(document.getElementById('ticketContainer').value),
            material_breakdown: materialBreakdown, diversion_rate: diversionRate
        };
        var promise = editingTicketId ? supabase.from('tickets').update(ticketData).eq('id', editingTicketId) : supabase.from('tickets').insert([ticketData]);
        promise.then(function(result) {
            if (result.error) { showToast('Error: ' + result.error.message, 'error'); return; }
            closeModal('ticketModal');
            showToast('Ticket saved!', 'success');
            loadTickets();
        });
    }

    function editTicket(id) { var ticket = tickets.find(function(t) { return t.id === id; }); if (ticket) openTicketModal(ticket); }

    function deleteTicket(id) {
        if (!confirm('Delete this ticket?')) return;
        supabase.from('tickets').delete().eq('id', id).then(function(result) {
            if (result.error) { showToast('Error deleting ticket', 'error'); return; }
            showToast('Ticket deleted', 'success');
            loadTickets();
        });
    }

    function analyzeTicketPhoto(imageData) {
        var apiKey = localStorage.getItem('openai_api_key');
        if (!apiKey) { showToast('Please add OpenAI API key in Settings', 'error'); return; }
        document.getElementById('ticketScanButtons').classList.add('hidden');
        document.getElementById('ticketAnalyzing').classList.remove('hidden');
        fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey},
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{role: 'user', content: [
                    {type: 'text', text: 'Extract scale ticket data from this image. Return ONLY valid JSON: {"ticket_number":"string or null","date":"YYYY-MM-DD or null","gross_lbs":number or null,"tare_lbs":number or null,"net_lbs":number or null,"hauler":"string or null"}'},
                    {type: 'image_url', image_url: {url: imageData}}
                ]}],
                max_tokens: 500
            })
        }).then(function(r) { return r.json(); }).then(function(data) {
            document.getElementById('ticketAnalyzing').classList.add('hidden');
            if (data.error) { showToast('OCR Error: ' + data.error.message, 'error'); document.getElementById('ticketScanButtons').classList.remove('hidden'); return; }
            var content = data.choices[0].message.content;
            var jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) { showToast('Could not parse response', 'error'); document.getElementById('ticketScanButtons').classList.remove('hidden'); return; }
            scannedTicketData = JSON.parse(jsonMatch[0]);
            displayScannedTicket(scannedTicketData);
        }).catch(function(err) { showToast('OCR Error: ' + err.message, 'error'); document.getElementById('ticketAnalyzing').classList.add('hidden'); document.getElementById('ticketScanButtons').classList.remove('hidden'); });
    }

    function displayScannedTicket(data) {
        var resultsDiv = document.getElementById('ticketResults');
        resultsDiv.innerHTML = '<div style="background:var(--slate-700);border-radius:8px;padding:16px"><h4 style="margin-bottom:12px;color:var(--emerald-400)">‚úì Ticket Scanned</h4><div style="display:grid;gap:8px;font-size:14px"><div><strong>Ticket #:</strong> ' + (data.ticket_number || 'N/A') + '</div><div><strong>Date:</strong> ' + (data.date || 'N/A') + '</div><div><strong>Gross:</strong> ' + (data.gross_lbs ? data.gross_lbs.toLocaleString() : 'N/A') + ' lbs</div><div><strong>Tare:</strong> ' + (data.tare_lbs ? data.tare_lbs.toLocaleString() : 'N/A') + ' lbs</div><div><strong>Net:</strong> ' + (data.net_lbs ? data.net_lbs.toLocaleString() : 'N/A') + ' lbs</div><div><strong>Hauler:</strong> ' + (data.hauler || 'N/A') + '</div></div></div>';
        resultsDiv.classList.remove('hidden');
        document.getElementById('saveScannedTicketBtn').classList.remove('hidden');
    }

    function saveScannedTicket() {
        if (!scannedTicketData || !currentProject) return;
        openTicketModal();
        document.getElementById('ticketNumber').value = scannedTicketData.ticket_number || '';
        document.getElementById('ticketDate').value = scannedTicketData.date || new Date().toISOString().split('T')[0];
        document.getElementById('ticketGross').value = scannedTicketData.gross_lbs || '';
        document.getElementById('ticketTare').value = scannedTicketData.tare_lbs || '';
        document.getElementById('ticketHauler').value = scannedTicketData.hauler || '';
        closeModal('scanTicketModal');
        scannedTicketData = null;
    }

    function analyzeDebrisPhoto(imageData) {
        var apiKey = localStorage.getItem('openai_api_key');
        if (!apiKey) { showToast('Please add OpenAI API key in Settings', 'error'); return; }
        var containerSize = document.getElementById('debrisContainer').value;
        document.getElementById('debrisScanButtons').classList.add('hidden');
        document.getElementById('debrisAnalyzing').classList.remove('hidden');
        fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey},
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{role: 'user', content: [
                    {type: 'text', text: 'You are analyzing construction/demolition debris for LEED waste diversion reporting. Look at this photo of a ' + containerSize + '-yard container and estimate the percentage breakdown of visible materials.\n\nYou MUST respond with ONLY a JSON object (no markdown, no explanation):\n{"wood":25,"gypsum":10,"plastic":5,"occ":15,"metal":5,"concrete":10,"block":10,"landfill":20,"confidence":75,"notes":"brief description"}\n\nCategories:\n- wood: lumber, pallets, plywood, OSB\n- gypsum: drywall, sheetrock\n- plastic: film, wrap, containers\n- occ: cardboard, paper\n- metal: steel, aluminum, copper\n- concrete: concrete pieces\n- block: CMU, cinder blocks, bricks\n- landfill: mixed waste, trash, non-recyclable\n\nPercentages MUST total exactly 100. Respond with JSON only.'},
                    {type: 'image_url', image_url: {url: imageData}}
                ]}],
                max_tokens: 500
            })
        }).then(function(r) { return r.json(); }).then(function(data) {
            document.getElementById('debrisAnalyzing').classList.add('hidden');
            console.log('API Response:', data);
            if (data.error) { showToast('Analysis Error: ' + data.error.message, 'error'); document.getElementById('debrisScanButtons').classList.remove('hidden'); return; }
            var content = data.choices[0].message.content;
            console.log('Content:', content);
            // Remove markdown code blocks if present
            content = content.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
            var jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) { showToast('Could not parse: ' + content.substring(0,100), 'error'); document.getElementById('debrisScanButtons').classList.remove('hidden'); return; }
            try {
                analyzedDebrisData = JSON.parse(jsonMatch[0]);
                console.log('Parsed data:', analyzedDebrisData);
                displayDebrisAnalysis(analyzedDebrisData, containerSize);
            } catch(e) {
                showToast('JSON parse error: ' + e.message, 'error');
                document.getElementById('debrisScanButtons').classList.remove('hidden');
            }
        }).catch(function(err) { showToast('Analysis Error: ' + err.message, 'error'); document.getElementById('debrisAnalyzing').classList.add('hidden'); document.getElementById('debrisScanButtons').classList.remove('hidden'); });
    }

    function displayDebrisAnalysis(data, containerSize) {
        var diversionRate = 100 - (data.landfill || 0);
        var materials = ['wood','gypsum','plastic','occ','metal','concrete','block','landfill'];
        var icons = {wood:'ü™µ',gypsum:'üß±',plastic:'‚ôªÔ∏è',occ:'üì¶',metal:'üî©',concrete:'ü™®',block:'üß±',landfill:'üóëÔ∏è'};
        var html = '<div style="background:var(--slate-700);border-radius:8px;padding:16px"><h4 style="margin-bottom:12px;color:var(--emerald-400)">‚úì Analysis Complete</h4><div style="margin-bottom:12px"><div style="font-size:12px;color:var(--slate-400)">Diversion Potential</div><div style="font-size:28px;font-weight:700;color:' + (diversionRate >= 75 ? 'var(--emerald-400)' : 'var(--amber-500)') + '">' + diversionRate + '%</div><div class="progress-bar"><div class="progress-fill" style="width:' + diversionRate + '%"></div></div><div style="font-size:11px;color:var(--slate-500);margin-top:4px">LEED v5 Target: 75%</div></div><div style="font-size:14px">';
        materials.forEach(function(mat) {
            var pct = data[mat] || 0;
            if (pct > 0) html += '<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--slate-600)"><span>' + icons[mat] + ' ' + mat.charAt(0).toUpperCase() + mat.slice(1) + '</span><span>' + pct + '% ' + (mat !== 'landfill' ? '‚ôªÔ∏è' : 'üóëÔ∏è') + '</span></div>';
        });
        html += '</div><div style="margin-top:12px;font-size:12px;color:var(--slate-400)">Confidence: ' + (data.confidence || 'N/A') + '% | ' + (data.notes || '') + '</div></div>';
        document.getElementById('debrisResults').innerHTML = html;
        document.getElementById('debrisResults').classList.remove('hidden');
        document.getElementById('applyDebrisBtn').classList.remove('hidden');
    }

    function applyDebrisToTicket() {
        if (!analyzedDebrisData) return;
        openTicketModal();
        document.getElementById('ticketContainer').value = document.getElementById('debrisContainer').value;
        document.getElementById('matWood').value = analyzedDebrisData.wood || 0;
        document.getElementById('matGypsum').value = analyzedDebrisData.gypsum || 0;
        document.getElementById('matPlastic').value = analyzedDebrisData.plastic || 0;
        document.getElementById('matOCC').value = analyzedDebrisData.occ || 0;
        document.getElementById('matMetal').value = analyzedDebrisData.metal || 0;
        document.getElementById('matConcrete').value = analyzedDebrisData.concrete || 0;
        document.getElementById('matBlock').value = analyzedDebrisData.block || 0;
        document.getElementById('matLandfill').value = analyzedDebrisData.landfill || 0;
        updateMaterialTotal();
        closeModal('scanDebrisModal');
        analyzedDebrisData = null;
    }
    function exportExcel() {
        if (tickets.length === 0) { showToast('No tickets to export', 'error'); return; }
        var headers = ['Date','Ticket No','GVW (lbs)','GVW (NT)','Tare (lbs)','Tare (NT)','Net (lbs)','Tons','Wood %','Wood','Gypsum %','Gypsum','Plastic %','Plastic','OCC %','OCC','Metal %','Metal','Concrete %','Concrete','Block %','Block','Landfill %','Landfill','Total Diverted','Diverted %'];
        var data = [headers];
        tickets.forEach(function(t) {
            var mb = t.material_breakdown ? (typeof t.material_breakdown === 'string' ? JSON.parse(t.material_breakdown) : t.material_breakdown) : {};
            var netTons = t.net_tons || 0;
            data.push([formatDate(t.ticket_date),t.ticket_number||'',t.gross_lbs||0,((t.gross_lbs||0)/2000).toFixed(4),t.tare_lbs||0,((t.tare_lbs||0)/2000).toFixed(4),t.net_lbs||0,netTons.toFixed(4),mb.wood||0,(netTons*(mb.wood||0)/100).toFixed(4),mb.gypsum||0,(netTons*(mb.gypsum||0)/100).toFixed(4),mb.plastic||0,(netTons*(mb.plastic||0)/100).toFixed(4),mb.occ||0,(netTons*(mb.occ||0)/100).toFixed(4),mb.metal||0,(netTons*(mb.metal||0)/100).toFixed(4),mb.concrete||0,(netTons*(mb.concrete||0)/100).toFixed(4),mb.block||0,(netTons*(mb.block||0)/100).toFixed(4),mb.landfill||0,(netTons*(mb.landfill||0)/100).toFixed(4),(netTons*(100-(mb.landfill||0))/100).toFixed(4),(100-(mb.landfill||0))+'%']);
        });
        var ws = XLSX.utils.aoa_to_sheet(data);
        var wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Diversion Report');
        XLSX.writeFile(wb, 'DivertScan_' + (currentProject ? currentProject.name : 'Export') + '_' + new Date().toISOString().split('T')[0] + '.xlsx');
        showToast('Excel exported!', 'success');
    }

    function exportLEEDReport() {
        if (tickets.length === 0) { showToast('No tickets to export', 'error'); return; }
        var jsPDF = window.jspdf.jsPDF;
        var doc = new jsPDF();
        doc.setFontSize(20); doc.setTextColor(16, 185, 129); doc.text('DivertScan‚Ñ¢ LEED MRp2/MRc5 Report', 20, 20);
        doc.setFontSize(12); doc.setTextColor(100);
        doc.text('Project: ' + (currentProject ? currentProject.name : 'N/A'), 20, 32);
        doc.text('Generated: ' + new Date().toLocaleDateString(), 20, 40);
        doc.text('LEED Version: ' + (currentProject ? currentProject.leed_version : 'v5'), 20, 48);
        var totalTons = tickets.reduce(function(sum, t) { return sum + (t.net_tons || 0); }, 0);
        var totalDiverted = 0;
        tickets.forEach(function(t) { totalDiverted += (t.net_tons || 0) * ((t.diversion_rate || 0) / 100); });
        var avgDiversion = totalTons > 0 ? (totalDiverted / totalTons * 100) : 0;
        doc.setFontSize(14); doc.setTextColor(0); doc.text('Summary', 20, 65);
        doc.setFontSize(11);
        doc.text('Total Tickets: ' + tickets.length, 25, 75);
        doc.text('Total Weight: ' + totalTons.toFixed(2) + ' tons', 25, 83);
        doc.text('Total Diverted: ' + totalDiverted.toFixed(2) + ' tons', 25, 91);
        doc.text('Diversion Rate: ' + avgDiversion.toFixed(1) + '%', 25, 99);
        doc.text('LEED Target: 75%', 25, 107);
        doc.text('Status: ' + (avgDiversion >= 75 ? 'COMPLIANT' : 'BELOW TARGET'), 25, 115);
        doc.setFontSize(8); doc.setTextColor(150); doc.text('Generated by DivertScan‚Ñ¢ | Point-of-Capture Verification Technology', 20, 280);
        doc.save('LEED_Report_' + (currentProject ? currentProject.name : 'Project') + '_' + new Date().toISOString().split('T')[0] + '.pdf');
        showToast('LEED Report exported!', 'success');
    }

    function exportAuditorPackage() {
        if (tickets.length === 0) { showToast('No tickets to export', 'error'); return; }
        var jsPDF = window.jspdf.jsPDF;
        var doc = new jsPDF();
        doc.setFontSize(24); doc.setTextColor(16, 185, 129); doc.text('LEED Auditor Package', 20, 40);
        doc.setFontSize(14); doc.setTextColor(0);
        doc.text('Project: ' + (currentProject ? currentProject.name : 'N/A'), 20, 60);
        doc.text('Client: ' + (currentProject ? currentProject.client : 'N/A'), 20, 70);
        doc.text('Location: ' + (currentProject ? currentProject.location : 'N/A'), 20, 80);
        doc.text('Report Date: ' + new Date().toLocaleDateString(), 20, 90);
        doc.addPage();
        doc.setFontSize(16); doc.text('Ticket Register', 20, 20);
        var y = 35;
        doc.setFontSize(8);
        tickets.slice(0, 30).forEach(function(t, i) {
            if (y > 270) { doc.addPage(); y = 20; }
            doc.text((i+1) + '. ' + formatDate(t.ticket_date) + ' | #' + t.ticket_number + ' | ' + (t.net_tons||0).toFixed(2) + 'T | ' + (t.diversion_rate||0) + '% diverted', 20, y);
            y += 7;
        });
        doc.setFontSize(8); doc.setTextColor(150); doc.text('Generated by DivertScan‚Ñ¢ | Patent Pending', 20, 280);
        doc.save('Auditor_Package_' + (currentProject ? currentProject.name : 'Project') + '_' + new Date().toISOString().split('T')[0] + '.pdf');
        showToast('Auditor Package exported!', 'success');
    }

    function exportCSV() {
        if (tickets.length === 0) { showToast('No tickets to export', 'error'); return; }
        var headers = ['Date','Ticket #','Gross (lbs)','Tare (lbs)','Net (lbs)','Net (tons)','Diversion Rate','Hauler'];
        var rows = tickets.map(function(t) { return [t.ticket_date,t.ticket_number,t.gross_lbs,t.tare_lbs,t.net_lbs,(t.net_tons||0).toFixed(4),(t.diversion_rate||0)+'%',t.hauler||'']; });
        var csv = [headers].concat(rows).map(function(r) { return r.join(','); }).join('\n');
        var blob = new Blob([csv], {type:'text/csv'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = 'DivertScan_' + (currentProject ? currentProject.name : 'Export') + '_' + new Date().toISOString().split('T')[0] + '.csv';
        a.click(); URL.revokeObjectURL(url);
        showToast('CSV exported!', 'success');
    }

    function importExcel() { document.getElementById('importFile').click(); }

    function processImportFile(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var data = new Uint8Array(e.target.result);
            var workbook = XLSX.read(data, {type:'array'});
            var sheet = workbook.Sheets[workbook.SheetNames[0]];
            var rows = XLSX.utils.sheet_to_json(sheet, {header:1});
            if (rows.length < 2) { showToast('No data found', 'error'); return; }
            var headers = rows[0].map(function(h) { return (h||'').toString().toLowerCase(); });
            var findCol = function(names) { return headers.findIndex(function(h) { return names.some(function(n) { return h.indexOf(n) >= 0; }); }); };
            var dateCol = findCol(['date']), ticketCol = findCol(['ticket','number','#']), grossCol = findCol(['gross','gvw']), tareCol = findCol(['tare']);
            var imported = 0;
            var importNext = function(i) {
                if (i >= rows.length) { showToast('Imported ' + imported + ' tickets!', 'success'); loadTickets(); return; }
                var row = rows[i];
                if (!row || row.length === 0) { importNext(i+1); return; }
                var ticketData = {
                    project_id: currentProject.id, user_id: currentUser.id,
                    ticket_number: ticketCol >= 0 ? String(row[ticketCol] || '') : 'IMP-' + i,
                    ticket_date: dateCol >= 0 ? parseExcelDate(row[dateCol]) : new Date().toISOString().split('T')[0],
                    gross_lbs: grossCol >= 0 ? parseInt(row[grossCol]) || 0 : 0,
                    tare_lbs: tareCol >= 0 ? parseInt(row[tareCol]) || 0 : 0,
                    material_breakdown: {wood:40,gypsum:15,metal:10,concrete:10,landfill:25}, diversion_rate: 75
                };
                ticketData.net_lbs = ticketData.gross_lbs - ticketData.tare_lbs;
                ticketData.net_tons = ticketData.net_lbs / 2000;
                supabase.from('tickets').insert([ticketData]).then(function(result) { if (!result.error) imported++; importNext(i+1); });
            };
            importNext(1);
        };
        reader.readAsArrayBuffer(file);
    }

    function parseExcelDate(value) {
        if (!value) return new Date().toISOString().split('T')[0];
        if (typeof value === 'number') { var date = new Date((value - 25569) * 86400 * 1000); return date.toISOString().split('T')[0]; }
        var d = new Date(value);
        return isNaN(d) ? new Date().toISOString().split('T')[0] : d.toISOString().split('T')[0];
    }

    function setupEventListeners() {
        document.querySelectorAll('.tab').forEach(function(tab) {
            tab.onclick = function() {
                document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
                tab.classList.add('active');
                document.getElementById(tab.dataset.page + 'Page').classList.add('active');
            };
        });
        document.getElementById('projectSelector').onchange = function(e) { selectProject(e.target.value); };
        document.getElementById('newProjectBtn').onclick = function() { document.getElementById('projectName').value = ''; document.getElementById('projectClient').value = ''; document.getElementById('projectLocation').value = ''; openModal('projectModal'); };
        document.getElementById('saveProjectBtn').onclick = saveProject;
        document.getElementById('addTicketBtn').onclick = function() { openTicketModal(); };
        document.getElementById('saveTicketBtn').onclick = saveTicket;
        ['Wood','Gypsum','Plastic','OCC','Metal','Concrete','Block','Landfill'].forEach(function(m) { document.getElementById('mat'+m).oninput = updateMaterialTotal; });
        document.getElementById('scanTicketOption').onclick = function() { document.getElementById('ticketPreview').classList.add('hidden'); document.getElementById('ticketResults').classList.add('hidden'); document.getElementById('ticketScanButtons').classList.remove('hidden'); document.getElementById('saveScannedTicketBtn').classList.add('hidden'); openModal('scanTicketModal'); };
        document.getElementById('scanDebrisOption').onclick = function() { document.getElementById('debrisPreview').classList.add('hidden'); document.getElementById('debrisResults').classList.add('hidden'); document.getElementById('debrisScanButtons').classList.remove('hidden'); document.getElementById('applyDebrisBtn').classList.add('hidden'); openModal('scanDebrisModal'); };
        document.getElementById('ticketCamera').onchange = handleTicketImage;
        document.getElementById('ticketUpload').onchange = handleTicketImage;
        document.getElementById('debrisCamera').onchange = handleDebrisImage;
        document.getElementById('debrisUpload').onchange = handleDebrisImage;
        document.getElementById('importFile').onchange = function(e) { if (e.target.files[0]) processImportFile(e.target.files[0]); };
        document.getElementById('saveScannedTicketBtn').onclick = saveScannedTicket;
        document.getElementById('applyDebrisBtn').onclick = applyDebrisToTicket;
        document.getElementById('exportExcelBtn').onclick = exportExcel;
        document.getElementById('exportLEEDBtn').onclick = exportLEEDReport;
        document.getElementById('exportAuditorBtn').onclick = exportAuditorPackage;
        document.getElementById('exportCSVBtn').onclick = exportCSV;
        document.getElementById('importExcelBtn').onclick = importExcel;
        document.getElementById('saveSettingsBtn').onclick = function() { var apiKey = document.getElementById('apiKeyInput').value.trim(); if (apiKey) { localStorage.setItem('openai_api_key', apiKey); showToast('Settings saved!', 'success'); } };
    }

    function handleTicketImage(e) { var file = e.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(ev) { document.getElementById('ticketPreview').src = ev.target.result; document.getElementById('ticketPreview').classList.remove('hidden'); analyzeTicketPhoto(ev.target.result); }; reader.readAsDataURL(file); e.target.value = ''; }
    function handleDebrisImage(e) { var file = e.target.files[0]; if (!file) return; var reader = new FileReader(); reader.onload = function(ev) { document.getElementById('debrisPreview').src = ev.target.result; document.getElementById('debrisPreview').classList.remove('hidden'); analyzeDebrisPhoto(ev.target.result); }; reader.readAsDataURL(file); e.target.value = ''; }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(message, type) { var toast = document.getElementById('toast'); toast.textContent = message; toast.className = 'toast ' + (type||'info') + ' show'; setTimeout(function() { toast.classList.remove('show'); }, 3000); }
    function formatDate(dateStr) { if (!dateStr) return '-'; var d = new Date(dateStr); return d.toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'2-digit'}); }

    loadSupabase(init);
    </script>
</body>
</html>
