<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan‚Ñ¢ v2.3</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--red-400:#f87171;--blue-500:#3b82f6}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--slate-900);color:var(--slate-300);min-height:100vh;padding-bottom:80px}
        .header{background:var(--slate-800);padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700);position:sticky;top:0;z-index:100}
        .logo{font-size:20px;font-weight:700;color:var(--emerald-400)}
        .logo span{color:var(--slate-400);font-weight:400;font-size:12px}
        .nav{position:fixed;bottom:0;left:0;right:0;background:var(--slate-800);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));border-top:1px solid var(--slate-700);z-index:100}
        .nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 16px;color:var(--slate-500);font-size:11px;cursor:pointer}
        .nav-item.active{color:var(--emerald-400)}
        .nav-item svg{width:24px;height:24px;margin-bottom:4px}
        .tab-content{display:none;padding:16px}
        .tab-content.active{display:block}
        .card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
        .card-title{font-size:14px;color:var(--slate-400);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px}
        .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .stat-card{background:var(--slate-700);border-radius:8px;padding:12px;text-align:center}
        .stat-value{font-size:24px;font-weight:700;color:var(--emerald-400)}
        .stat-label{font-size:11px;color:var(--slate-400);margin-top:4px}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;width:100%}
        .btn-primary{background:var(--emerald-500);color:white}
        .btn-primary:hover{background:var(--emerald-400)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed}
        .btn-secondary{background:var(--slate-700);color:var(--slate-300)}
        .btn-danger{background:var(--red-500);color:white}
        .btn-sm{padding:8px 12px;font-size:12px}
        .btn-lg{padding:16px 24px;font-size:16px}
        .form-group{margin-bottom:16px}
        .form-label{display:block;font-size:12px;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase}
        .form-input{width:100%;padding:12px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-300);font-size:16px}
        .form-input:focus{outline:none;border-color:var(--emerald-500)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .weight-input-group{display:flex;gap:8px}
        .weight-input-group .form-input{flex:1}
        .capture-btn{background:var(--blue-500);color:white;padding:12px;border-radius:8px;border:none;font-size:16px;cursor:pointer;min-width:48px}
        .capture-btn:disabled{opacity:0.5;cursor:not-allowed}
        .material-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
        .material-item{background:var(--slate-700);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
        .material-name{font-size:12px;color:var(--slate-300)}
        .material-input{display:flex;align-items:center;gap:4px}
        .material-input input{width:50px;padding:6px;background:var(--slate-800);border:1px solid var(--slate-600);border-radius:4px;color:var(--slate-300);font-size:14px;text-align:right}
        .material-input span{color:var(--slate-500);font-size:12px}
        .progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden;margin-top:8px}
        .progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}
        .progress-fill.warning{background:var(--amber-500)}
        .progress-fill.danger{background:var(--red-500)}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;align-items:flex-end;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--slate-800);width:100%;max-width:500px;max-height:90vh;border-radius:16px 16px 0 0;overflow:hidden;display:flex;flex-direction:column}
        .modal-header{padding:16px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:18px;font-weight:600;color:var(--slate-200)}
        .modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);cursor:pointer;font-size:20px}
        .modal-body{padding:16px;overflow-y:auto;flex:1}
        .modal-footer{padding:16px;border-top:1px solid var(--slate-700);display:flex;gap:12px}
        .steps{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
        .step{width:32px;height:32px;border-radius:50%;background:var(--slate-700);color:var(--slate-500);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
        .step.active,.step.complete{background:var(--emerald-500);color:white}
        .step-line{width:40px;height:2px;background:var(--slate-700);align-self:center}
        .step-line.complete{background:var(--emerald-500)}
        .image-preview{width:100%;aspect-ratio:4/3;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:14px;overflow:hidden;margin-bottom:12px}
        .image-preview img{width:100%;height:100%;object-fit:cover}
        .photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
        .photo-slot{aspect-ratio:1;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:24px;cursor:pointer;overflow:hidden;border:2px dashed var(--slate-600)}
        .photo-slot.filled{border:2px solid var(--emerald-500)}
        .photo-slot img{width:100%;height:100%;object-fit:cover}
        .container-select{display:flex;gap:8px;margin-bottom:16px}
        .container-option{flex:1;padding:12px;background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;text-align:center;cursor:pointer}
        .container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
        .container-option span{display:block;font-size:20px;font-weight:700;color:var(--slate-200)}
        .container-option small{font-size:11px;color:var(--slate-400)}
        .ticket-list{display:flex;flex-direction:column;gap:12px}
        .ticket-item{background:var(--slate-700);border-radius:8px;padding:12px;cursor:pointer;transition:background 0.2s}
        .ticket-item:hover{background:var(--slate-600)}
        .ticket-row{display:flex;justify-content:space-between;align-items:center}
        .ticket-info h4{color:var(--slate-200);font-size:14px;margin-bottom:4px}
        .ticket-info p{color:var(--slate-400);font-size:12px}
        .ticket-stats{text-align:right}
        .ticket-tons{font-size:18px;font-weight:700;color:var(--emerald-400)}
        .ticket-diversion{font-size:12px;color:var(--slate-400)}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--slate-700);color:var(--slate-200);padding:12px 24px;border-radius:8px;font-size:14px;z-index:300;opacity:0;transition:all 0.3s}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.success{background:var(--emerald-500);color:white}
        .toast.error{background:var(--red-500);color:white}
        .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--slate-400)}
        .spinner{width:40px;height:40px;border:3px solid var(--slate-700);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .project-selector{background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
        .project-name{font-weight:600;color:var(--slate-200)}
        .project-change{color:var(--emerald-400);font-size:12px;cursor:pointer}
        .hidden{display:none!important}
        .empty-state{text-align:center;padding:40px 20px;color:var(--slate-500)}
        .edit-badge{background:var(--amber-500);color:var(--slate-900);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;margin-left:8px}
        .diversion-badge{font-size:28px;font-weight:700}
        .diversion-badge.good{color:var(--emerald-400)}
        .diversion-badge.warning{color:var(--amber-400)}
        .diversion-badge.bad{color:var(--red-400)}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">DivertScan‚Ñ¢ <span>v2.3</span></div>
        <div class="header-actions">
            <button class="btn btn-secondary btn-sm" onclick="showTab('settings')" style="width:auto;">‚öôÔ∏è</button>
        </div>
    </header>
    <main>
        <div id="authScreen" class="tab-content active">
            <div style="max-width:400px;margin:60px auto;padding:20px;">
                <div style="text-align:center;margin-bottom:32px;">
                    <div style="font-size:48px;margin-bottom:16px;">‚ôªÔ∏è</div>
                    <h1 style="font-size:24px;color:var(--emerald-400);margin-bottom:8px;">DivertScan‚Ñ¢</h1>
                    <p style="color:var(--slate-400);">LEED-Compliant Waste Tracking</p>
                </div>
                <div class="card">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="authEmail" class="form-input" placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="authPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-lg" onclick="signIn()">Sign In</button>
                    <p style="text-align:center;margin-top:16px;font-size:12px;color:var(--slate-500);">
                        Don't have an account? <a href="#" onclick="signUp()" style="color:var(--emerald-400);">Sign Up</a>
                    </p>
                </div>
            </div>
        </div>
        <div id="dashboardTab" class="tab-content">
            <div class="project-selector">
                <div>
                    <div style="font-size:11px;color:var(--slate-500);">CURRENT PROJECT</div>
                    <div class="project-name" id="currentProjectName">Select a Project</div>
                </div>
                <span class="project-change" onclick="showProjectModal()">Change ‚Üí</span>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statTickets">0</div><div class="stat-label">Tickets</div></div>
                <div class="stat-card"><div class="stat-value" id="statTons">0</div><div class="stat-label">Total Tons</div></div>
                <div class="stat-card"><div class="stat-value" id="statDiversion">0%</div><div class="stat-label">Diversion Rate</div></div>
                <div class="stat-card"><div class="stat-value" id="statCO2">0</div><div class="stat-label">MT CO‚ÇÇe Avoided</div></div>
            </div>
            <div class="card" style="margin-top:16px;">
                <div class="card-title">LEED v5 Progress</div>
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span style="font-size:12px;color:var(--slate-400);">75% Target</span>
                    <span style="font-size:14px;font-weight:600;" id="leedProgress">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="leedProgressBar" style="width:0%"></div></div>
            </div>
            <button class="btn btn-primary btn-lg" style="margin-top:20px;" onclick="startNewTicket()">‚ûï New Ticket</button>
            <div class="card" style="margin-top:20px;">
                <div class="card-title">Recent Tickets <span style="font-size:11px;color:var(--slate-500);font-weight:normal;">(tap to edit)</span></div>
                <div class="ticket-list" id="ticketList"><div class="empty-state"><p>No tickets yet</p></div></div>
            </div>
        </div>
        <div id="ticketsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">All Tickets</h2>
            <div class="ticket-list" id="allTicketsList"><div class="loading"><div class="spinner"></div><p>Loading...</p></div></div>
        </div>
        <div id="reportsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">LEED Reports</h2>
            <div class="card">
                <div class="card-title">Export Options</div>
                <button class="btn btn-secondary" style="margin-bottom:12px;" onclick="exportLEEDReport()">üìä LEED Waste Diversion CSV</button>
                <p style="font-size:11px;color:var(--slate-500);">Format: Date, Ticket No, GWT, Tare, Net, Wood, Gypsum, Plastic, OCC, Metal, Concrete, Block</p>
            </div>
        </div>
        <div id="settingsTab" class="tab-content">
            <h2 style="font-size:20px;margin-bottom:16px;">Settings</h2>
            <div class="card">
                <div class="card-title">OpenAI API Key</div>
                <p style="font-size:12px;color:var(--slate-500);margin-bottom:8px;">Required for OCR & debris analysis</p>
                <div class="form-group"><input type="password" id="openaiKeyInput" class="form-input" placeholder="sk-..."></div>
                <button class="btn btn-primary" onclick="saveOpenAIKey()">Save API Key</button>
            </div>
            <div class="card">
                <div class="card-title">Account</div>
                <p style="font-size:14px;color:var(--slate-300);margin-bottom:8px;" id="userEmail">-</p>
                <button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
            </div>
        </div>
    </main>
    <nav class="nav">
        <div class="nav-item active" onclick="showTab('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Home</div>
        <div class="nav-item" onclick="showTab('tickets')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>Tickets</div>
        <div class="nav-item" onclick="showTab('reports')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>Reports</div>
        <div class="nav-item" onclick="showTab('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>Settings</div>
    </nav>
    <div id="toast" class="toast"></div>
    <!-- Ticket Modal -->
    <div id="ticketModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="ticketModalTitle">New Ticket</div>
                <button class="modal-close" onclick="closeModal('ticketModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="steps">
                    <div class="step active" id="step1">1</div>
                    <div class="step-line" id="stepLine1"></div>
                    <div class="step" id="step2">2</div>
                    <div class="step-line" id="stepLine2"></div>
                    <div class="step" id="step3">3</div>
                </div>
                <div id="ticketStep1">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üìÑ Scale Ticket & Weights</h3>
                    <div class="image-preview" id="ticketImagePreview"><span>Tap to scan ticket</span></div>
                    <div style="display:flex;gap:8px;margin-bottom:16px;">
                        <button class="btn btn-secondary" onclick="captureTicketPhoto()" style="flex:1;">üì∑ Camera</button>
                        <button class="btn btn-secondary" onclick="uploadTicketPhoto()" style="flex:1;">üìÅ Upload</button>
                    </div>
                    <input type="file" id="ticketFileInput" accept="image/*" style="display:none;" onchange="handleTicketFile(event)">
                    <input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleTicketFile(event)">
                    <div id="ticketFormFields">
                        <div class="form-group">
                            <label class="form-label">Service Date (Haul Date)</label>
                            <input type="date" id="serviceDate" class="form-input" onchange="updateServiceDate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ticket #</label>
                            <input type="text" id="ticketNumber" class="form-input" placeholder="84600" oninput="syncTicketField('ticketNumber', this.value)">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Gross (lbs)</label>
                                <input type="number" id="grossLbs" class="form-input" placeholder="40620" oninput="updateWeights()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tare (lbs)</label>
                                <input type="number" id="tareLbs" class="form-input" placeholder="34840" oninput="updateWeights()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Net Weight</label>
                            <div style="font-size:28px;font-weight:700;color:var(--emerald-400);" id="netWeightDisplay">0.00 tons</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hauler</label>
                            <input type="text" id="haulerName" class="form-input" placeholder="Dalmex Recycling" oninput="syncTicketField('hauler', this.value)">
                        </div>
                    </div>
                    <div id="ticketAnalyzing" class="loading hidden"><div class="spinner"></div><p>Analyzing ticket...</p></div>
                </div>
                <div id="ticketStep2" class="hidden">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üì∏ Debris Photos</h3>
                    <div class="container-select">
                        <div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yard</small></div>
                        <div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yard</small></div>
                        <div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yard</small></div>
                    </div>
                    <div class="photo-grid" id="debrisPhotoGrid">
                        <div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div>
                        <div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div>
                        <div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>
                    </div>
                    <input type="file" id="debrisFileInput" accept="image/*" style="display:none;" onchange="handleDebrisFile(event)">
                    <p style="font-size:12px;color:var(--slate-400);text-align:center;margin-bottom:16px;">Add 1-3 photos of debris load</p>
                    <button class="btn btn-primary" id="analyzeDebrisBtn" onclick="analyzeDebris()" disabled>ü§ñ Analyze Materials</button>
                    <div id="debrisAnalyzing" class="loading hidden"><div class="spinner"></div><p>Analyzing debris...</p></div>
                </div>
                <div id="ticketStep3" class="hidden">
                    <h3 style="font-size:16px;margin-bottom:16px;text-align:center;">‚úÖ Review & Save</h3>
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <div>
                                <div style="font-size:12px;color:var(--slate-400);">Diversion Rate</div>
                                <div class="diversion-badge good" id="finalDiversionRate">0%</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px;color:var(--slate-400);">LEED v5 Target</div>
                                <div style="font-size:14px;color:var(--slate-300);">75%</div>
                            </div>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="finalProgressBar" style="width:0%"></div></div>
                    </div>
                    <div style="font-size:12px;color:var(--slate-400);margin:16px 0 8px;">MATERIAL BREAKDOWN (editable)</div>
                    <div class="material-grid" id="materialBreakdownEdit"></div>
                    <div style="margin-top:8px;font-size:12px;">
                        <span style="color:var(--slate-400);">Total:</span>
                        <span id="materialTotal" style="color:var(--emerald-400);font-weight:600;">100%</span>
                    </div>
                    <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="recalculateMaterials()">üîÑ Recalculate</button>
                    <div class="card" style="margin-top:16px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div><div style="font-size:11px;color:var(--slate-500);">TICKET #</div><div style="font-size:14px;color:var(--slate-200);" id="reviewTicketNum">-</div></div>
                            <div><div style="font-size:11px;color:var(--slate-500);">SERVICE DATE</div><div style="font-size:14px;color:var(--slate-200);" id="reviewDate">-</div></div>
                            <div><div style="font-size:11px;color:var(--slate-500);">NET WEIGHT</div><div style="font-size:14px;color:var(--emerald-400);font-weight:700;" id="reviewNetTons">-</div></div>
                            <div><div style="font-size:11px;color:var(--slate-500);">CO‚ÇÇe AVOIDED</div><div style="font-size:14px;color:var(--slate-200);" id="reviewCO2">-</div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="prevStepBtn" onclick="prevStep()" style="flex:1;" disabled>Back</button>
                <button class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" style="flex:1;">Next</button>
            </div>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit Ticket <span class="edit-badge">EDIT</span></div>
                <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Service Date</label><input type="date" id="editServiceDate" class="form-input"></div>
                <div class="form-group"><label class="form-label">Ticket #</label><input type="text" id="editTicketNumber" class="form-input"></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" id="editGrossLbs" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" id="editTareLbs" class="form-input"></div>
                </div>
                <div class="form-group"><label class="form-label">Net Weight</label><div style="font-size:24px;font-weight:700;color:var(--emerald-400);" id="editNetDisplay">0.00 tons</div></div>
                <div style="font-size:12px;color:var(--slate-400);margin:16px 0 8px;">MATERIAL PERCENTAGES</div>
                <div class="material-grid" id="editMaterialGrid"></div>
                <div style="margin-top:8px;font-size:12px;"><span style="color:var(--slate-400);">Total:</span><span id="editMaterialTotal" style="color:var(--emerald-400);font-weight:600;">100%</span></div>
                <div style="margin-top:16px;padding:12px;background:var(--slate-700);border-radius:8px;">
                    <div style="font-size:12px;color:var(--slate-400);margin-bottom:4px;">CALCULATED DIVERSION</div>
                    <div style="font-size:24px;font-weight:700;" id="editDiversionRate">0%</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentTicket()" style="flex:1;">üóëÔ∏è Delete</button>
                <button class="btn btn-primary" onclick="saveEditedTicket()" style="flex:1;">üíæ Save</button>
            </div>
        </div>
    </div>
    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">Select Project</div><button class="modal-close" onclick="closeModal('projectModal')">√ó</button></div>
            <div class="modal-body">
                <div id="projectList" class="ticket-list"><div class="loading"><div class="spinner"></div><p>Loading...</p></div></div>
                <button class="btn btn-primary" style="margin-top:16px;" onclick="showNewProjectForm()">‚ûï New Project</button>
                <div id="newProjectForm" class="hidden" style="margin-top:16px;">
                    <div class="form-group"><label class="form-label">Project Name</label><input type="text" id="newProjectName" class="form-input" placeholder="Children's Medical Center"></div>
                    <div class="form-group"><label class="form-label">Address</label><input type="text" id="newProjectAddress" class="form-input" placeholder="1234 Main St, Dallas TX"></div>
                    <button class="btn btn-primary" onclick="createProject()">Create Project</button>
                </div>
            </div>
        </div>
    </div>
    <script>
const DivertScan=(function(){'use strict';const CONFIG={SUPABASE_URL:'https://cyvvlngtojagfoaitoog.supabase.co',SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g',VERSION:'2.3.0',LEED_V5_TARGET:75};
const MATERIALS={wood:{name:'Wood',icon:'ü™µ',recyclable:true,gwpFactor:0.03},gypsum:{name:'Gypsum',icon:'üß±',recyclable:true,gwpFactor:0.12},plastic:{name:'Plastic',icon:'‚ôªÔ∏è',recyclable:true,gwpFactor:2.5},occ:{name:'OCC',icon:'üì¶',recyclable:true,gwpFactor:0.94},metal:{name:'Metal',icon:'üî©',recyclable:true,gwpFactor:1.85},concrete:{name:'Concrete',icon:'ü™®',recyclable:true,gwpFactor:0.159},block:{name:'Block',icon:'üß±',recyclable:true,gwpFactor:0.159},landfill:{name:'Landfill',icon:'üóëÔ∏è',recyclable:false,gwpFactor:0.52}};
const MATERIAL_KEYS=['wood','gypsum','plastic','occ','metal','concrete','block','landfill'];
let state={supabase:null,user:null,currentProject:null,editingTicketId:null,ticketSession:createEmptySession(),openaiKey:localStorage.getItem('divertscan_openai')||''};
function createEmptySession(){return{id:null,ticketNumber:null,serviceDate:getCurrentDate(),grossLbs:null,tareLbs:null,netLbs:null,netTons:null,hauler:null,containerSize:30,scaleTicketImage:null,debrisImages:[],materialBreakdown:{},diversionRate:0,co2eAvoided:0,calculatedBreakdown:{}};}
function toast(message,type='info'){const el=document.getElementById('toast');if(!el){console.log(`[${type}] ${message}`);return;}el.textContent=message;el.className=`toast ${type} show`;setTimeout(()=>el.classList.remove('show'),3000);}
function getCurrentDate(){return new Date().toISOString().split('T')[0];}
function formatDate(date){if(!date)return'';const d=new Date(date+'T00:00:00');return d.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'2-digit'});}
function formatNumber(num){return num===null||num===undefined?'0':Number(num).toLocaleString('en-US');}
function calculateNetWeight(grossLbs,tareLbs){const gross=parseFloat(grossLbs)||0;const tare=parseFloat(tareLbs)||0;const netLbs=Math.max(0,gross-tare);return{netLbs,netTons:netLbs/2000};}
function calculateMaterialTonnages(percentages,netTons){const breakdown={};let totalDivertedPct=0;let totalCO2e=0;for(const key of MATERIAL_KEYS){const pct=parseFloat(percentages[key])||0;const tons=(pct/100)*netTons;const mat=MATERIALS[key];const co2e=tons*(mat?.gwpFactor||0);breakdown[key]={pct,tons,co2e,recyclable:mat?.recyclable};if(mat?.recyclable&&key!=='landfill')totalDivertedPct+=pct;totalCO2e+=co2e;}return{breakdown,diversionRate:Math.round(totalDivertedPct),totalCO2e,meetsLEEDv5:totalDivertedPct>=CONFIG.LEED_V5_TARGET};}
function validateMaterialTotal(percentages){let total=0;for(const key of MATERIAL_KEYS)total+=parseFloat(percentages[key])||0;return{total:Math.round(total),valid:Math.abs(total-100)<0.5};}
function recalculateTicket(){const s=state.ticketSession;if(s.grossLbs&&s.tareLbs){const net=calculateNetWeight(s.grossLbs,s.tareLbs);s.netLbs=net.netLbs;s.netTons=net.netTons;}if(Object.keys(s.materialBreakdown).length>0&&s.netTons){const result=calculateMaterialTonnages(s.materialBreakdown,s.netTons);s.diversionRate=result.diversionRate;s.co2eAvoided=result.totalCO2e;s.calculatedBreakdown=result.breakdown;}return s;}
function initTicketSession(){state.ticketSession=createEmptySession();state.editingTicketId=null;return state.ticketSession;}
function loadTicketForEdit(ticket){state.editingTicketId=ticket.id;state.ticketSession={id:ticket.id,ticketNumber:ticket.ticket_number,serviceDate:ticket.service_date||ticket.ticket_date,grossLbs:ticket.gross_lbs,tareLbs:ticket.tare_lbs,netLbs:ticket.net_lbs,netTons:ticket.net_tons,hauler:ticket.hauler,containerSize:ticket.container_size||30,scaleTicketImage:ticket.scale_ticket_image,debrisImages:ticket.debris_images?JSON.parse(ticket.debris_images):[],materialBreakdown:{wood:ticket.wood_pct||0,gypsum:ticket.gypsum_pct||0,plastic:ticket.plastic_pct||0,occ:ticket.occ_pct||0,metal:ticket.metal_pct||0,concrete:ticket.concrete_pct||0,block:ticket.block_pct||0,landfill:ticket.landfill_pct||0},diversionRate:ticket.diversion_pct||0,co2eAvoided:ticket.co2e_avoided||0,calculatedBreakdown:{}};recalculateTicket();return state.ticketSession;}
function updateTicketSession(data){Object.assign(state.ticketSession,data);return recalculateTicket();}
function setMaterialPercentages(percentages){const normalized={};for(const key of MATERIAL_KEYS)normalized[key]=parseFloat(percentages[key])||0;state.ticketSession.materialBreakdown=normalized;return recalculateTicket();}
function getTicketSession(){return{...state.ticketSession};}
function isEditingTicket(){return state.editingTicketId!==null;}
async function analyzeScaleTicket(imageDataUrl){const apiKey=state.openaiKey||localStorage.getItem('divertscan_openai');if(!apiKey)throw new Error('OpenAI API key required. Go to Settings.');const response=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o',messages:[{role:'user',content:[{type:'text',text:'Extract data from this scale ticket. Return ONLY JSON: {"ticket_number":"string","date":"MM/DD/YY","hauler":"string","gross_lbs":number,"tare_lbs":number}'},{type:'image_url',image_url:{url:imageDataUrl}}]}],max_tokens:500})});const data=await response.json();if(data.error)throw new Error(data.error.message);const content=data.choices[0].message.content;const match=content.match(/\{[\s\S]*\}/);if(!match)throw new Error('Could not parse response');const result=JSON.parse(match[0]);updateTicketSession({ticketNumber:result.ticket_number,serviceDate:result.date?formatDateDB(result.date):getCurrentDate(),grossLbs:result.gross_lbs,tareLbs:result.tare_lbs,hauler:result.hauler,scaleTicketImage:imageDataUrl});return result;}
function formatDateDB(dateStr){if(!dateStr)return getCurrentDate();if(/^\d{4}-\d{2}-\d{2}$/.test(dateStr))return dateStr;const parts=dateStr.split('/');if(parts.length===3){const year=parts[2].length===2?'20'+parts[2]:parts[2];return`${year}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;}return getCurrentDate();}
async function analyzeDebrisPhoto(imageDataUrl,containerSize=30){const apiKey=state.openaiKey||localStorage.getItem('divertscan_openai');if(!apiKey)throw new Error('OpenAI API key required. Go to Settings.');const response=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o',messages:[{role:'user',content:[{type:'text',text:`Analyze this ${containerSize}-yard container of C&D debris. Return ONLY JSON: {"wood":0-100,"gypsum":0-100,"plastic":0-100,"occ":0-100,"metal":0-100,"concrete":0-100,"block":0-100,"landfill":0-100} Percentages MUST total 100.`},{type:'image_url',image_url:{url:imageDataUrl}}]}],max_tokens:500})});const data=await response.json();if(data.error)throw new Error(data.error.message);const content=data.choices[0].message.content;const match=content.match(/\{[\s\S]*\}/);if(!match)throw new Error('Could not parse response');const result=JSON.parse(match[0]);const percentages={};for(const key of MATERIAL_KEYS)percentages[key]=result[key]||0;state.ticketSession.debrisImages.push(imageDataUrl);setMaterialPercentages(percentages);return{percentages,raw:result};}
async function initSupabase(){if(state.supabase)return state.supabase;if(typeof supabase==='undefined'){await new Promise((resolve,reject)=>{const script=document.createElement('script');script.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';script.onload=resolve;script.onerror=reject;document.head.appendChild(script);});}state.supabase=supabase.createClient(CONFIG.SUPABASE_URL,CONFIG.SUPABASE_KEY);return state.supabase;}
async function createTicket(projectId){await initSupabase();const s=state.ticketSession;const b=s.calculatedBreakdown||{};const data={project_id:projectId||state.currentProject?.id,user_id:state.user?.id,ticket_number:s.ticketNumber,service_date:s.serviceDate||getCurrentDate(),ticket_date:s.serviceDate||getCurrentDate(),hauler:s.hauler,container_size:s.containerSize,gross_lbs:s.grossLbs,tare_lbs:s.tareLbs,net_lbs:s.netLbs,net_tons:s.netTons,wood_pct:s.materialBreakdown.wood||0,gypsum_pct:s.materialBreakdown.gypsum||0,plastic_pct:s.materialBreakdown.plastic||0,occ_pct:s.materialBreakdown.occ||0,metal_pct:s.materialBreakdown.metal||0,concrete_pct:s.materialBreakdown.concrete||0,block_pct:s.materialBreakdown.block||0,landfill_pct:s.materialBreakdown.landfill||0,wood_tons:b.wood?.tons||0,gypsum_tons:b.gypsum?.tons||0,plastic_tons:b.plastic?.tons||0,occ_tons:b.occ?.tons||0,metal_tons:b.metal?.tons||0,concrete_tons:b.concrete?.tons||0,block_tons:b.block?.tons||0,landfill_tons:b.landfill?.tons||0,diversion_pct:s.diversionRate,diverted_tons:s.netTons?s.netTons*(s.diversionRate/100):0,co2e_avoided:s.co2eAvoided,scale_ticket_image:s.scaleTicketImage,debris_images:JSON.stringify(s.debrisImages||[]),audit_id:`DS-${Date.now()}`};const{data:result,error}=await state.supabase.from('tickets').insert([data]).select().single();if(error)throw error;toast('Ticket saved!','success');return result;}
async function updateTicket(ticketId){await initSupabase();const s=state.ticketSession;const b=s.calculatedBreakdown||{};const data={ticket_number:s.ticketNumber,service_date:s.serviceDate,ticket_date:s.serviceDate,hauler:s.hauler,gross_lbs:s.grossLbs,tare_lbs:s.tareLbs,net_lbs:s.netLbs,net_tons:s.netTons,wood_pct:s.materialBreakdown.wood||0,gypsum_pct:s.materialBreakdown.gypsum||0,plastic_pct:s.materialBreakdown.plastic||0,occ_pct:s.materialBreakdown.occ||0,metal_pct:s.materialBreakdown.metal||0,concrete_pct:s.materialBreakdown.concrete||0,block_pct:s.materialBreakdown.block||0,landfill_pct:s.materialBreakdown.landfill||0,wood_tons:b.wood?.tons||0,gypsum_tons:b.gypsum?.tons||0,plastic_tons:b.plastic?.tons||0,occ_tons:b.occ?.tons||0,metal_tons:b.metal?.tons||0,concrete_tons:b.concrete?.tons||0,block_tons:b.block?.tons||0,landfill_tons:b.landfill?.tons||0,diversion_pct:s.diversionRate,diverted_tons:s.netTons?s.netTons*(s.diversionRate/100):0,co2e_avoided:s.co2eAvoided,last_modified:new Date().toISOString(),modified_by:state.user?.email};const{data:result,error}=await state.supabase.from('tickets').update(data).eq('id',ticketId).select().single();if(error)throw error;toast('Ticket updated!','success');return result;}
async function deleteTicket(ticketId){await initSupabase();const{error}=await state.supabase.from('tickets').delete().eq('id',ticketId);if(error)throw error;toast('Ticket deleted','success');return true;}
async function saveTicket(projectId){return state.editingTicketId?updateTicket(state.editingTicketId):createTicket(projectId);}
async function loadTickets(projectId){await initSupabase();const{data,error}=await state.supabase.from('tickets').select('*').eq('project_id',projectId).order('service_date',{ascending:false});if(error)throw error;return data||[];}
async function loadProjects(){await initSupabase();const{data,error}=await state.supabase.from('projects').select('*').eq('user_id',state.user?.id).order('created_at',{ascending:false});if(error)throw error;return data||[];}
function generateLEEDReport(tickets,projectName=''){const headers=['Date','Ticket No','Gross (lbs)','Tare (lbs)','Net (lbs)','Net (tons)','Wood (T)','Gypsum (T)','Plastic (T)','OCC (T)','Metal (T)','Concrete (T)','Block (T)','Landfill (T)','Diverted (T)','Diversion %'];let csv=projectName?`LEED Waste Diversion Report - ${projectName}\nGenerated: ${new Date().toLocaleDateString()}\n\n`:'';csv+=headers.join(',')+'\n';let totals={gross:0,tare:0,net:0,netTons:0,wood:0,gypsum:0,plastic:0,occ:0,metal:0,concrete:0,block:0,landfill:0,diverted:0};for(const t of tickets){csv+=[formatDate(t.service_date||t.ticket_date),t.ticket_number||'',t.gross_lbs||0,t.tare_lbs||0,t.net_lbs||0,(t.net_tons||0).toFixed(3),(t.wood_tons||0).toFixed(3),(t.gypsum_tons||0).toFixed(3),(t.plastic_tons||0).toFixed(3),(t.occ_tons||0).toFixed(3),(t.metal_tons||0).toFixed(3),(t.concrete_tons||0).toFixed(3),(t.block_tons||0).toFixed(3),(t.landfill_tons||0).toFixed(3),(t.diverted_tons||0).toFixed(3),(t.diversion_pct||0)+'%'].join(',')+'\n';totals.gross+=parseFloat(t.gross_lbs)||0;totals.tare+=parseFloat(t.tare_lbs)||0;totals.net+=parseFloat(t.net_lbs)||0;totals.netTons+=parseFloat(t.net_tons)||0;totals.wood+=parseFloat(t.wood_tons)||0;totals.gypsum+=parseFloat(t.gypsum_tons)||0;totals.plastic+=parseFloat(t.plastic_tons)||0;totals.occ+=parseFloat(t.occ_tons)||0;totals.metal+=parseFloat(t.metal_tons)||0;totals.concrete+=parseFloat(t.concrete_tons)||0;totals.block+=parseFloat(t.block_tons)||0;totals.landfill+=parseFloat(t.landfill_tons)||0;totals.diverted+=parseFloat(t.diverted_tons)||0;}const overallDiv=totals.netTons>0?((totals.diverted/totals.netTons)*100).toFixed(1):0;csv+='\nTOTALS,'+tickets.length+','+totals.gross.toFixed(0)+','+totals.tare.toFixed(0)+','+totals.net.toFixed(0)+','+totals.netTons.toFixed(3)+','+totals.wood.toFixed(3)+','+totals.gypsum.toFixed(3)+','+totals.plastic.toFixed(3)+','+totals.occ.toFixed(3)+','+totals.metal.toFixed(3)+','+totals.concrete.toFixed(3)+','+totals.block.toFixed(3)+','+totals.landfill.toFixed(3)+','+totals.diverted.toFixed(3)+','+overallDiv+'%\n';return csv;}
function downloadCSV(csv,filename){const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename||`DivertScan-Report-${getCurrentDate()}.csv`;a.click();URL.revokeObjectURL(url);}
return{CONFIG,MATERIALS,MATERIAL_KEYS,getState:()=>state,setState:(k,v)=>{state[k]=v;},setOpenAIKey:k=>{state.openaiKey=k;localStorage.setItem('divertscan_openai',k);},toast,getCurrentDate,formatDate,formatNumber,calculateNetWeight,calculateMaterialTonnages,validateMaterialTotal,recalculateTicket,initTicketSession,loadTicketForEdit,updateTicketSession,setMaterialPercentages,getTicketSession,isEditingTicket,analyzeScaleTicket,analyzeDebrisPhoto,initSupabase,createTicket,updateTicket,deleteTicket,saveTicket,loadTickets,loadProjects,generateLEEDReport,downloadCSV,version:CONFIG.VERSION};})();
window.DivertScan=DivertScan;
    </script>
    <script>
let currentStep=1,selectedContainerSize=30,debrisPhotoSlot=0,debrisPhotos=[null,null,null],currentEditTicket=null;
async function initialize(){try{await DivertScan.initSupabase();const sb=DivertScan.getState().supabase;const{data:{session}}=await sb.auth.getSession();if(session){DivertScan.setState('user',session.user);showApp();}sb.auth.onAuthStateChange((event,session)=>{if(session){DivertScan.setState('user',session.user);showApp();}else{DivertScan.setState('user',null);showAuth();}});}catch(e){console.error('Init error:',e);DivertScan.toast('Failed to initialize','error');}}
async function signIn(){const email=document.getElementById('authEmail').value;const password=document.getElementById('authPassword').value;if(!email||!password){DivertScan.toast('Enter email and password','error');return;}try{const sb=DivertScan.getState().supabase;const{error}=await sb.auth.signInWithPassword({email,password});if(error)throw error;}catch(e){DivertScan.toast(e.message,'error');}}
async function signUp(){const email=document.getElementById('authEmail').value;const password=document.getElementById('authPassword').value;if(!email||!password){DivertScan.toast('Enter email and password','error');return;}try{const sb=DivertScan.getState().supabase;const{error}=await sb.auth.signUp({email,password});if(error)throw error;DivertScan.toast('Check email to confirm account','success');}catch(e){DivertScan.toast(e.message,'error');}}
async function signOut(){await DivertScan.getState().supabase.auth.signOut();showAuth();}
function showAuth(){document.getElementById('authScreen').classList.add('active');document.getElementById('dashboardTab').classList.remove('active');document.querySelector('.nav').style.display='none';}
function showApp(){document.getElementById('authScreen').classList.remove('active');document.querySelector('.nav').style.display='flex';document.getElementById('userEmail').textContent=DivertScan.getState().user?.email||'-';document.getElementById('openaiKeyInput').value=DivertScan.getState().openaiKey||'';loadProjectsAndData();showTab('dashboard');}
function showTab(tab){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.getElementById(tab+'Tab').classList.add('active');document.querySelectorAll('.nav-item')[['dashboard','tickets','reports','settings'].indexOf(tab)].classList.add('active');if(tab==='tickets')loadAllTickets();}
async function loadProjectsAndData(){try{const projects=await DivertScan.loadProjects();if(projects?.length>0){DivertScan.setState('currentProject',projects[0]);document.getElementById('currentProjectName').textContent=projects[0].name;await loadDashboardData();}else{document.getElementById('currentProjectName').textContent='Create a Project ‚Üí';}}catch(e){console.error('Load projects error:',e);}}
function showProjectModal(){openModal('projectModal');loadProjectList();}
async function loadProjectList(){const projects=await DivertScan.loadProjects();const list=document.getElementById('projectList');if(!projects?.length){list.innerHTML='<div class="empty-state"><p>No projects</p></div>';return;}list.innerHTML=projects.map(p=>`<div class="ticket-item" onclick="selectProject('${p.id}','${p.name.replace(/'/g,"\\'")}')"><div class="ticket-row"><div class="ticket-info"><h4>${p.name}</h4><p>${p.address||''}</p></div><span style="color:var(--emerald-400);">‚Üí</span></div></div>`).join('');}
function selectProject(id,name){DivertScan.setState('currentProject',{id,name});document.getElementById('currentProjectName').textContent=name;closeModal('projectModal');loadDashboardData();}
function showNewProjectForm(){document.getElementById('newProjectForm').classList.toggle('hidden');}
async function createProject(){const name=document.getElementById('newProjectName').value;const address=document.getElementById('newProjectAddress').value;if(!name){DivertScan.toast('Enter project name','error');return;}try{const sb=DivertScan.getState().supabase;const{data,error}=await sb.from('projects').insert([{name,address,user_id:DivertScan.getState().user.id}]).select().single();if(error)throw error;DivertScan.toast('Project created!','success');selectProject(data.id,data.name);document.getElementById('newProjectForm').classList.add('hidden');document.getElementById('newProjectName').value='';document.getElementById('newProjectAddress').value='';}catch(e){DivertScan.toast(e.message,'error');}}
async function loadDashboardData(){const project=DivertScan.getState().currentProject;if(!project)return;try{const tickets=await DivertScan.loadTickets(project.id);const totalTickets=tickets.length;const totalTons=tickets.reduce((sum,t)=>sum+(parseFloat(t.net_tons)||0),0);const totalDiverted=tickets.reduce((sum,t)=>sum+(parseFloat(t.diverted_tons)||0),0);const avgDiversion=totalTons>0?(totalDiverted/totalTons*100):0;const totalCO2=tickets.reduce((sum,t)=>sum+(parseFloat(t.co2e_avoided)||0),0);document.getElementById('statTickets').textContent=totalTickets;document.getElementById('statTons').textContent=totalTons.toFixed(2);document.getElementById('statDiversion').textContent=avgDiversion.toFixed(0)+'%';document.getElementById('statCO2').textContent=totalCO2.toFixed(2);document.getElementById('leedProgress').textContent=avgDiversion.toFixed(0)+'%';const bar=document.getElementById('leedProgressBar');bar.style.width=Math.min(avgDiversion,100)+'%';bar.className='progress-fill'+(avgDiversion>=75?'':avgDiversion>=50?' warning':' danger');renderTicketList(tickets.slice(0,10),'ticketList');}catch(e){console.error('Dashboard error:',e);}}
async function loadAllTickets(){const project=DivertScan.getState().currentProject;if(!project)return;try{const tickets=await DivertScan.loadTickets(project.id);renderTicketList(tickets,'allTicketsList');}catch(e){console.error('Load tickets error:',e);}}
function renderTicketList(tickets,containerId){const list=document.getElementById(containerId);if(!tickets.length){list.innerHTML='<div class="empty-state"><p>No tickets</p></div>';return;}list.innerHTML=tickets.map(t=>`<div class="ticket-item" onclick="openEditTicket('${t.id}')"><div class="ticket-row"><div class="ticket-info"><h4>#${t.ticket_number||'N/A'}</h4><p>${DivertScan.formatDate(t.service_date||t.ticket_date)} ‚Ä¢ ${t.hauler||'Unknown'}</p></div><div class="ticket-stats"><div class="ticket-tons">${(t.net_tons||0).toFixed(2)}T</div><div class="ticket-diversion">${t.diversion_pct||0}% div</div></div></div></div>`).join('');}
function startNewTicket(){const project=DivertScan.getState().currentProject;if(!project){DivertScan.toast('Select a project first','error');return;}DivertScan.initTicketSession();currentStep=1;debrisPhotos=[null,null,null];document.getElementById('ticketModalTitle').textContent='New Ticket';document.getElementById('ticketImagePreview').innerHTML='<span>Tap to scan ticket</span>';document.getElementById('serviceDate').value=DivertScan.getCurrentDate();document.getElementById('ticketNumber').value='';document.getElementById('grossLbs').value='';document.getElementById('tareLbs').value='';document.getElementById('netWeightDisplay').textContent='0.00 tons';document.getElementById('haulerName').value='';showStep(1);resetDebrisPhotoGrid();openModal('ticketModal');}
function showStep(step){currentStep=step;document.getElementById('ticketStep1').classList.toggle('hidden',step!==1);document.getElementById('ticketStep2').classList.toggle('hidden',step!==2);document.getElementById('ticketStep3').classList.toggle('hidden',step!==3);for(let i=1;i<=3;i++){document.getElementById('step'+i).className='step'+(i<step?' complete':i===step?' active':'');}document.getElementById('stepLine1').className='step-line'+(step>1?' complete':'');document.getElementById('stepLine2').className='step-line'+(step>2?' complete':'');document.getElementById('prevStepBtn').disabled=step===1;document.getElementById('nextStepBtn').textContent=step===3?'Save Ticket':'Next';if(step===3)populateReviewStep();}
function nextStep(){if(currentStep===3){saveCurrentTicket();return;}const session=DivertScan.getTicketSession();if(currentStep===1&&(!session.grossLbs||!session.tareLbs)){DivertScan.toast('Enter gross and tare weights','error');return;}if(currentStep===2&&session.diversionRate===0){DivertScan.toast('Analyze debris photos first','error');return;}showStep(currentStep+1);}
function prevStep(){if(currentStep>1)showStep(currentStep-1);}
function captureTicketPhoto(){document.getElementById('ticketCameraInput').click();}
function uploadTicketPhoto(){document.getElementById('ticketFileInput').click();}
async function handleTicketFile(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async(e)=>{const imageData=e.target.result;document.getElementById('ticketImagePreview').innerHTML=`<img src="${imageData}">`;document.getElementById('ticketAnalyzing').classList.remove('hidden');try{const result=await DivertScan.analyzeScaleTicket(imageData);const session=DivertScan.getTicketSession();document.getElementById('ticketNumber').value=session.ticketNumber||'';document.getElementById('serviceDate').value=session.serviceDate||DivertScan.getCurrentDate();document.getElementById('grossLbs').value=session.grossLbs||'';document.getElementById('tareLbs').value=session.tareLbs||'';document.getElementById('haulerName').value=session.hauler||'';updateWeightsDisplay();DivertScan.toast('Ticket analyzed!','success');}catch(err){DivertScan.toast(err.message,'error');}finally{document.getElementById('ticketAnalyzing').classList.add('hidden');}};reader.readAsDataURL(file);}
function updateServiceDate(){DivertScan.updateTicketSession({serviceDate:document.getElementById('serviceDate').value});}
function syncTicketField(field,value){DivertScan.updateTicketSession({[field]:value});}
function updateWeights(){const gross=parseFloat(document.getElementById('grossLbs').value)||0;const tare=parseFloat(document.getElementById('tareLbs').value)||0;DivertScan.updateTicketSession({grossLbs:gross,tareLbs:tare});updateWeightsDisplay();}
function updateWeightsDisplay(){const session=DivertScan.getTicketSession();document.getElementById('netWeightDisplay').textContent=(session.netTons||0).toFixed(2)+' tons';}
function selectContainer(size){selectedContainerSize=size;DivertScan.updateTicketSession({containerSize:size});document.querySelectorAll('.container-option').forEach(opt=>{opt.classList.toggle('selected',opt.querySelector('span').textContent==size);});}
function resetDebrisPhotoGrid(){const grid=document.getElementById('debrisPhotoGrid');grid.innerHTML='<div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div><div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div><div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>';document.getElementById('analyzeDebrisBtn').disabled=true;}
function addDebrisPhoto(slot){debrisPhotoSlot=slot;document.getElementById('debrisFileInput').click();}
function handleDebrisFile(event){const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(e)=>{debrisPhotos[debrisPhotoSlot]=e.target.result;updateDebrisPhotoGrid();};reader.readAsDataURL(file);}
function updateDebrisPhotoGrid(){const grid=document.getElementById('debrisPhotoGrid');grid.innerHTML=debrisPhotos.map((photo,i)=>photo?`<div class="photo-slot filled" onclick="addDebrisPhoto(${i})"><img src="${photo}"></div>`:`<div class="photo-slot" onclick="addDebrisPhoto(${i})">‚ûï</div>`).join('');document.getElementById('analyzeDebrisBtn').disabled=!debrisPhotos.some(p=>p);}
async function analyzeDebris(){const photos=debrisPhotos.filter(p=>p);if(!photos.length){DivertScan.toast('Add at least one photo','error');return;}document.getElementById('debrisAnalyzing').classList.remove('hidden');document.getElementById('analyzeDebrisBtn').disabled=true;try{await DivertScan.analyzeDebrisPhoto(photos[0],selectedContainerSize);const session=DivertScan.getTicketSession();DivertScan.toast(`Analysis: ${session.diversionRate}% diversion`,'success');showStep(3);}catch(err){DivertScan.toast(err.message,'error');document.getElementById('analyzeDebrisBtn').disabled=false;}finally{document.getElementById('debrisAnalyzing').classList.add('hidden');}}
function populateReviewStep(){const session=DivertScan.getTicketSession();const divRate=session.diversionRate||0;const badge=document.getElementById('finalDiversionRate');badge.textContent=divRate+'%';badge.className='diversion-badge '+(divRate>=75?'good':divRate>=50?'warning':'bad');const bar=document.getElementById('finalProgressBar');bar.style.width=Math.min(divRate,100)+'%';bar.className='progress-fill'+(divRate>=75?'':divRate>=50?' warning':' danger');const grid=document.getElementById('materialBreakdownEdit');grid.innerHTML=DivertScan.MATERIAL_KEYS.map(key=>{const mat=DivertScan.MATERIALS[key];const pct=session.materialBreakdown[key]||0;return`<div class="material-item"><div class="material-name">${mat.icon} ${mat.name}</div><div class="material-input"><input type="number" id="mat_${key}" value="${pct}" min="0" max="100" onchange="updateMaterialPct('${key}')"><span>%</span></div></div>`;}).join('');updateMaterialTotal();document.getElementById('reviewTicketNum').textContent=session.ticketNumber||'-';document.getElementById('reviewDate').textContent=DivertScan.formatDate(session.serviceDate)||'-';document.getElementById('reviewNetTons').textContent=(session.netTons||0).toFixed(2)+' tons';document.getElementById('reviewCO2').textContent=(session.co2eAvoided||0).toFixed(2)+' MT';}
function updateMaterialPct(key){const val=parseFloat(document.getElementById('mat_'+key).value)||0;const session=DivertScan.getTicketSession();session.materialBreakdown[key]=val;DivertScan.setMaterialPercentages(session.materialBreakdown);updateMaterialTotal();}
function updateMaterialTotal(){const session=DivertScan.getTicketSession();const validation=DivertScan.validateMaterialTotal(session.materialBreakdown);const el=document.getElementById('materialTotal');el.textContent=validation.total+'%';el.style.color=validation.valid?'var(--emerald-400)':'var(--red-400)';}
function recalculateMaterials(){const validation=DivertScan.validateMaterialTotal(DivertScan.getTicketSession().materialBreakdown);if(!validation.valid){DivertScan.toast('Total must equal 100%','error');return;}DivertScan.recalculateTicket();populateReviewStep();DivertScan.toast('Recalculated!','success');}
async function saveCurrentTicket(){const project=DivertScan.getState().currentProject;if(!project){DivertScan.toast('No project selected','error');return;}try{await DivertScan.saveTicket(project.id);closeModal('ticketModal');loadDashboardData();}catch(err){DivertScan.toast('Save failed: '+err.message,'error');}}
async function openEditTicket(ticketId){try{const sb=DivertScan.getState().supabase;const{data:ticket,error}=await sb.from('tickets').select('*').eq('id',ticketId).single();if(error)throw error;currentEditTicket=ticket;DivertScan.loadTicketForEdit(ticket);const session=DivertScan.getTicketSession();document.getElementById('editServiceDate').value=session.serviceDate||'';document.getElementById('editTicketNumber').value=session.ticketNumber||'';document.getElementById('editGrossLbs').value=session.grossLbs||'';document.getElementById('editTareLbs').value=session.tareLbs||'';document.getElementById('editNetDisplay').textContent=(session.netTons||0).toFixed(2)+' tons';const grid=document.getElementById('editMaterialGrid');grid.innerHTML=DivertScan.MATERIAL_KEYS.map(key=>{const mat=DivertScan.MATERIALS[key];const pct=session.materialBreakdown[key]||0;return`<div class="material-item"><div class="material-name">${mat.icon} ${mat.name}</div><div class="material-input"><input type="number" id="edit_${key}" value="${pct}" min="0" max="100" onchange="updateEditMaterial()"><span>%</span></div></div>`;}).join('');updateEditTotals();openModal('editModal');}catch(e){DivertScan.toast('Failed to load ticket','error');}}
function updateEditMaterial(){const percentages={};DivertScan.MATERIAL_KEYS.forEach(key=>{percentages[key]=parseFloat(document.getElementById('edit_'+key).value)||0;});DivertScan.setMaterialPercentages(percentages);const gross=parseFloat(document.getElementById('editGrossLbs').value)||0;const tare=parseFloat(document.getElementById('editTareLbs').value)||0;DivertScan.updateTicketSession({serviceDate:document.getElementById('editServiceDate').value,ticketNumber:document.getElementById('editTicketNumber').value,grossLbs:gross,tareLbs:tare});updateEditTotals();}
function updateEditTotals(){const session=DivertScan.getTicketSession();const validation=DivertScan.validateMaterialTotal(session.materialBreakdown);document.getElementById('editNetDisplay').textContent=(session.netTons||0).toFixed(2)+' tons';document.getElementById('editMaterialTotal').textContent=validation.total+'%';document.getElementById('editMaterialTotal').style.color=validation.valid?'var(--emerald-400)':'var(--red-400)';const divEl=document.getElementById('editDiversionRate');divEl.textContent=session.diversionRate+'%';divEl.style.color=session.diversionRate>=75?'var(--emerald-400)':session.diversionRate>=50?'var(--amber-400)':'var(--red-400)';}
async function saveEditedTicket(){updateEditMaterial();const validation=DivertScan.validateMaterialTotal(DivertScan.getTicketSession().materialBreakdown);if(!validation.valid){DivertScan.toast('Material percentages must total 100%','error');return;}try{await DivertScan.updateTicket(currentEditTicket.id);closeModal('editModal');loadDashboardData();loadAllTickets();}catch(e){DivertScan.toast('Update failed: '+e.message,'error');}}
async function deleteCurrentTicket(){if(!confirm('Delete this ticket? This cannot be undone.'))return;try{await DivertScan.deleteTicket(currentEditTicket.id);closeModal('editModal');loadDashboardData();loadAllTickets();}catch(e){DivertScan.toast('Delete failed: '+e.message,'error');}}
async function exportLEEDReport(){const project=DivertScan.getState().currentProject;if(!project){DivertScan.toast('Select a project first','error');return;}try{const tickets=await DivertScan.loadTickets(project.id);if(!tickets.length){DivertScan.toast('No tickets to export','error');return;}const csv=DivertScan.generateLEEDReport(tickets,project.name);DivertScan.downloadCSV(csv,`LEED-Report-${project.name}-${DivertScan.getCurrentDate()}.csv`);DivertScan.toast('Report downloaded!','success');}catch(e){DivertScan.toast(e.message,'error');}}
function saveOpenAIKey(){const key=document.getElementById('openaiKeyInput').value;if(!key){DivertScan.toast('Enter API key','error');return;}DivertScan.setOpenAIKey(key);DivertScan.toast('API key saved!','success');}
function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
document.addEventListener('DOMContentLoaded',initialize);
    </script>
</body>
</html>
