<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DivertScanâ„¢ | LEED v5 Carbon Auditor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:system-ui,sans-serif;background:#0f172a;min-height:100vh;color:#fff;padding:20px}
        .debug{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:20px}
        .debug-title{color:#10b981;font-size:14px;margin-bottom:10px}
        .debug-msg{color:#94a3b8;font-size:13px;margin:5px 0}
        .debug-error{color:#ef4444}
        .debug-success{color:#10b981}
        .auth-card{background:#1e293b;border-radius:16px;padding:24px;max-width:400px;margin:20px auto;border:1px solid #334155}
        .auth-title{font-size:20px;text-align:center;margin-bottom:20px}
        .form-group{margin-bottom:16px}
        .form-label{display:block;color:#94a3b8;font-size:12px;margin-bottom:6px}
        .form-input{width:100%;padding:12px;background:#0f172a;border:1px solid #475569;border-radius:8px;color:#fff;font-size:16px}
        .btn{width:100%;padding:14px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:bold;cursor:pointer;margin-top:10px}
        .btn:disabled{opacity:0.5}
        .error-box{background:rgba(239,68,68,0.2);border:1px solid #ef4444;color:#f87171;padding:12px;border-radius:8px;margin-bottom:16px;display:none}
        .error-box.show{display:block}
        .switch{text-align:center;margin-top:16px;color:#94a3b8}
        .switch a{color:#10b981;cursor:pointer}
        .hidden{display:none}
    </style>
</head>
<body>
    <div class="debug" id="debugPanel">
        <div class="debug-title">ðŸ”§ Debug Panel</div>
        <div id="debugLog"></div>
    </div>

    <div class="auth-card" id="authCard">
        <h2 class="auth-title" id="authTitle">Sign In</h2>
        <div class="error-box" id="errorBox"></div>
        <div class="form-group hidden" id="nameGroup">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="nameInput" placeholder="Your name">
        </div>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="emailInput" placeholder="you@email.com">
        </div>
        <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" minlength="6">
        </div>
        <button class="btn" id="submitBtn" onclick="handleAuth()">Sign In</button>
        <p class="switch"><span id="switchText">Don't have an account?</span> <a id="switchLink" onclick="toggleMode()">Sign Up</a></p>
    </div>

    <div class="auth-card hidden" id="dashboard">
        <h2 class="auth-title">âœ… Welcome!</h2>
        <p style="text-align:center;color:#94a3b8;margin-bottom:20px">You are signed in as:<br><strong id="userEmailDisplay"></strong></p>
        <button class="btn" onclick="signOut()">Sign Out</button>
    </div>

    <script>
const SUPABASE_URL = 'https://cyvvlngtojagfoaitoog.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g';

let supabase;
let isSignUp = false;

function log(msg, isError = false) {
    const el = document.getElementById('debugLog');
    const div = document.createElement('div');
    div.className = 'debug-msg ' + (isError ? 'debug-error' : 'debug-success');
    div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
    el.appendChild(div);
    console.log(msg);
}

async function init() {
    log('Starting init...');
    
    try {
        log('Creating Supabase client...');
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        log('Supabase client created âœ“');
        
        log('Checking session...');
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            log('Session error: ' + error.message, true);
            return;
        }
        
        if (session) {
            log('User is logged in: ' + session.user.email);
            showDashboard(session.user.email);
        } else {
            log('No session - showing auth form');
        }
        
        log('Init complete âœ“');
    } catch (e) {
        log('Init error: ' + e.message, true);
    }
}

function showDashboard(email) {
    document.getElementById('authCard').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('userEmailDisplay').textContent = email;
}

function showAuth() {
    document.getElementById('authCard').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
}

function toggleMode() {
    isSignUp = !isSignUp;
    document.getElementById('authTitle').textContent = isSignUp ? 'Create Account' : 'Sign In';
    document.getElementById('submitBtn').textContent = isSignUp ? 'Sign Up' : 'Sign In';
    document.getElementById('switchText').textContent = isSignUp ? 'Already have an account?' : "Don't have an account?";
    document.getElementById('switchLink').textContent = isSignUp ? 'Sign In' : 'Sign Up';
    document.getElementById('nameGroup').classList.toggle('hidden', !isSignUp);
}

async function handleAuth() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    const name = document.getElementById('nameInput').value;
    const errorBox = document.getElementById('errorBox');
    const btn = document.getElementById('submitBtn');
    
    errorBox.classList.remove('show');
    btn.disabled = true;
    btn.textContent = isSignUp ? 'Creating...' : 'Signing in...';
    
    log(isSignUp ? 'Attempting sign up...' : 'Attempting sign in...');
    
    try {
        if (isSignUp) {
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: { data: { full_name: name } }
            });
            
            if (error) throw error;
            
            log('Sign up successful!');
            
            if (data.user) {
                // Create default org
                log('Creating organization...');
                const { data: org, error: orgError } = await supabase
                    .from('organizations')
                    .insert({ name: 'My Organization', slug: data.user.id.slice(0, 8) })
                    .select()
                    .single();
                
                if (orgError) {
                    log('Org error: ' + orgError.message, true);
                } else {
                    log('Organization created âœ“');
                    await supabase.from('users').update({ organization_id: org.id, role: 'admin' }).eq('id', data.user.id);
                }
                
                showDashboard(data.user.email);
            }
        } else {
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            
            if (error) throw error;
            
            log('Sign in successful!');
            showDashboard(data.user.email);
        }
    } catch (e) {
        log('Auth error: ' + e.message, true);
        errorBox.textContent = e.message;
        errorBox.classList.add('show');
    }
    
    btn.disabled = false;
    btn.textContent = isSignUp ? 'Sign Up' : 'Sign In';
}

async function signOut() {
    log('Signing out...');
    await supabase.auth.signOut();
    log('Signed out âœ“');
    showAuth();
}

// Start
init();
    </script>
</body>
</html>
