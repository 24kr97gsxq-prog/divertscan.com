<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DivertScanâ„¢ | LEED v5 Carbon Auditor</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:system-ui,sans-serif;background:#0f172a;min-height:100vh;color:#fff;padding:20px}
        .debug{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:20px;margin-bottom:20px;max-height:200px;overflow-y:auto}
        .debug-title{color:#10b981;font-size:14px;margin-bottom:10px}
        .debug-msg{color:#94a3b8;font-size:12px;margin:5px 0;font-family:monospace}
        .debug-error{color:#ef4444}
        .debug-success{color:#10b981}
        .auth-card{background:#1e293b;border-radius:16px;padding:24px;max-width:400px;margin:20px auto;border:1px solid #334155}
        .auth-title{font-size:20px;text-align:center;margin-bottom:20px}
        .form-group{margin-bottom:16px}
        .form-label{display:block;color:#94a3b8;font-size:12px;margin-bottom:6px}
        .form-input{width:100%;padding:12px;background:#0f172a;border:1px solid #475569;border-radius:8px;color:#fff;font-size:16px}
        .btn{width:100%;padding:14px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:bold;font-size:16px;margin-top:10px}
        .btn:disabled{opacity:0.5}
        .error-box{background:rgba(239,68,68,0.2);border:1px solid #ef4444;color:#f87171;padding:12px;border-radius:8px;margin-bottom:16px;display:none}
        .error-box.show{display:block}
        .success-box{background:rgba(16,185,129,0.2);border:1px solid #10b981;color:#34d399;padding:12px;border-radius:8px;margin-bottom:16px;display:none}
        .success-box.show{display:block}
        .hidden{display:none!important}
    </style>
</head>
<body>
    <div class="debug" id="debugPanel">
        <div class="debug-title">ðŸ”§ Debug Panel</div>
        <div id="debugLog"></div>
    </div>

    <div class="auth-card" id="authCard">
        <h2 class="auth-title" id="authTitle">Sign Up</h2>
        <div class="error-box" id="errorBox"></div>
        <div class="success-box" id="successBox"></div>
        
        <div class="form-group">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-input" id="nameInput" placeholder="Your name">
        </div>
        <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="emailInput" placeholder="you@email.com">
        </div>
        <div class="form-group">
            <label class="form-label">Password (min 6 characters)</label>
            <input type="password" class="form-input" id="passwordInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button type="button" class="btn" id="submitBtn">Create Account</button>
        
        <p id="statusText" style="text-align:center;margin-top:16px;color:#94a3b8;font-size:13px"></p>
    </div>

    <script>
// Debug log function
function log(msg, isError) {
    var el = document.getElementById('debugLog');
    var div = document.createElement('div');
    div.className = 'debug-msg ' + (isError ? 'debug-error' : 'debug-success');
    var time = new Date().toLocaleTimeString();
    div.textContent = time + ' - ' + msg;
    el.appendChild(div);
    el.scrollTop = el.scrollHeight;
    console.log(msg);
}

// Show error
function showError(msg) {
    var box = document.getElementById('errorBox');
    box.textContent = msg;
    box.classList.add('show');
    document.getElementById('successBox').classList.remove('show');
}

// Show success
function showSuccess(msg) {
    var box = document.getElementById('successBox');
    box.textContent = msg;
    box.classList.add('show');
    document.getElementById('errorBox').classList.remove('show');
}

// Set status
function setStatus(msg) {
    document.getElementById('statusText').textContent = msg;
}

// Initialize
log('Page loaded');
log('Checking Supabase library...');

var supabase = null;
var SUPABASE_URL = 'https://cyvvlngtojagfoaitoog.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g';

// Load Supabase dynamically
function loadSupabase() {
    log('Loading Supabase script...');
    var script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    script.onload = function() {
        log('Supabase script loaded âœ“');
        initSupabase();
    };
    script.onerror = function() {
        log('FAILED to load Supabase script!', true);
        showError('Could not load authentication library. Check your internet connection.');
    };
    document.head.appendChild(script);
}

// Initialize Supabase client
function initSupabase() {
    try {
        log('Creating Supabase client...');
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        log('Supabase client created âœ“');
        setStatus('Ready to create account');
    } catch (e) {
        log('Error creating client: ' + e.message, true);
        showError('Error: ' + e.message);
    }
}

// Handle sign up
function handleSignUp() {
    var name = document.getElementById('nameInput').value.trim();
    var email = document.getElementById('emailInput').value.trim();
    var password = document.getElementById('passwordInput').value;
    var btn = document.getElementById('submitBtn');
    
    log('Sign up clicked');
    log('Email: ' + email);
    
    // Validation
    if (!email) {
        showError('Please enter an email address');
        return;
    }
    if (!password) {
        showError('Please enter a password');
        return;
    }
    if (password.length < 6) {
        showError('Password must be at least 6 characters');
        return;
    }
    if (!supabase) {
        showError('Authentication not ready. Please refresh the page.');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'Creating account...';
    setStatus('Connecting to server...');
    log('Calling Supabase signUp...');
    
    supabase.auth.signUp({
        email: email,
        password: password,
        options: {
            data: { full_name: name }
        }
    }).then(function(result) {
        log('signUp response received');
        
        if (result.error) {
            log('Error: ' + result.error.message, true);
            showError(result.error.message);
            setStatus('');
        } else if (result.data && result.data.user) {
            log('User created: ' + result.data.user.email);
            showSuccess('Account created successfully! Welcome ' + (name || email));
            setStatus('Creating your organization...');
            
            // Create organization
            supabase.from('organizations').insert({
                name: name || 'My Organization',
                slug: result.data.user.id.substring(0, 8)
            }).select().single().then(function(orgResult) {
                if (orgResult.error) {
                    log('Org error: ' + orgResult.error.message, true);
                } else {
                    log('Organization created âœ“');
                    supabase.from('users').update({
                        organization_id: orgResult.data.id,
                        role: 'admin'
                    }).eq('id', result.data.user.id);
                }
                setStatus('âœ… All done! You are now signed in.');
            });
        } else {
            log('Unexpected response', true);
            showError('Unexpected response from server');
        }
        
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }).catch(function(e) {
        log('Catch error: ' + e.message, true);
        showError('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Create Account';
        setStatus('');
    });
}

// Attach click handler
document.getElementById('submitBtn').onclick = handleSignUp;

// Start loading
loadSupabase();
    </script>
</body>
</html>
