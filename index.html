<!DOCTYPE html>
<html lang="en">
<!-- ¬© 2024-2025 DivertScan‚Ñ¢. Confidential and Proprietary. -->
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>DivertScan‚Ñ¢ v3.3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
:root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--red-400:#f87171;--blue-500:#3b82f6}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--slate-900);color:var(--slate-300);min-height:100vh;padding-bottom:80px}
.header{background:var(--slate-800);padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700);position:sticky;top:0;z-index:100}
.logo{font-size:20px;font-weight:700;color:var(--emerald-400)}
.logo span{color:var(--slate-400);font-weight:400;font-size:12px}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--slate-800);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));border-top:1px solid var(--slate-700);z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 12px;color:var(--slate-500);font-size:10px;cursor:pointer}
.nav-item.active{color:var(--emerald-400)}
.nav-item svg{width:22px;height:22px;margin-bottom:3px}
.tab-content{display:none;padding:16px;max-width:600px;margin:0 auto}
.tab-content.active{display:block}
.card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
.card-title{font-size:13px;color:var(--slate-400);margin-bottom:12px;text-transform:uppercase}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.stat-card{background:var(--slate-700);border-radius:8px;padding:12px;text-align:center}
.stat-value{font-size:22px;font-weight:700;color:var(--emerald-400)}
.stat-label{font-size:10px;color:var(--slate-400);margin-top:4px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;width:100%}
.btn-primary{background:var(--emerald-500);color:white}
.btn-secondary{background:var(--slate-700);color:var(--slate-300)}
.btn-danger{background:var(--red-500);color:white}
.btn-sm{padding:8px 12px;font-size:12px}
.btn-lg{padding:16px 24px;font-size:16px}
.btn-row{display:flex;gap:8px}
.btn-row .btn{flex:1}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase}
.form-input,.form-select{width:100%;padding:12px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-300);font-size:16px}
.form-input:focus{outline:none;border-color:var(--emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}
.progress-fill.warning{background:var(--amber-500)}
.progress-fill.danger{background:var(--red-500)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200;align-items:flex-end;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--slate-800);width:100%;max-width:500px;max-height:90vh;border-radius:16px 16px 0 0;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:16px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:18px;font-weight:600;color:var(--slate-200)}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);cursor:pointer;font-size:20px}
.modal-body{padding:16px;overflow-y:auto;flex:1}
.modal-footer{padding:16px;border-top:1px solid var(--slate-700);display:flex;gap:12px}
.steps{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
.step{width:32px;height:32px;border-radius:50%;background:var(--slate-700);color:var(--slate-500);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
.step.active,.step.complete{background:var(--emerald-500);color:white}
.step-line{width:32px;height:2px;background:var(--slate-700);align-self:center}
.step-line.complete{background:var(--emerald-500)}
.image-preview{width:100%;aspect-ratio:4/3;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:14px;overflow:hidden;margin-bottom:12px;border:2px dashed var(--slate-600)}
.image-preview.filled{border-color:var(--emerald-500)}
.image-preview img{width:100%;height:100%;object-fit:cover}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.photo-slot{aspect-ratio:1;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:24px;cursor:pointer;overflow:hidden;border:2px dashed var(--slate-600);position:relative}
.photo-slot.filled{border-color:var(--emerald-500)}
.photo-slot img{width:100%;height:100%;object-fit:cover}
.photo-remove{position:absolute;top:2px;right:2px;width:20px;height:20px;background:var(--red-500);border-radius:50%;border:none;color:white;font-size:12px;cursor:pointer;display:none}
.photo-slot.filled .photo-remove{display:block}
.container-select{display:flex;gap:8px;margin-bottom:16px}
.container-option{flex:1;padding:12px;background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:20px;font-weight:700;color:var(--slate-200)}
.container-option small{font-size:11px;color:var(--slate-400)}
.material-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.material-item{background:var(--slate-700);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
.material-name{font-size:11px;color:var(--slate-300)}
.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:50px;padding:6px;background:var(--slate-800);border:1px solid var(--slate-600);border-radius:4px;color:var(--slate-300);font-size:14px;text-align:right}
.material-input span{color:var(--slate-500);font-size:12px}
.ticket-list{display:flex;flex-direction:column;gap:12px}
.ticket-item{background:var(--slate-700);border-radius:8px;padding:12px;cursor:pointer;border-left:4px solid var(--amber-500)}
.ticket-item.closed{border-left-color:var(--emerald-500)}
.ticket-row{display:flex;justify-content:space-between;align-items:center}
.ticket-info h4{color:var(--slate-200);font-size:14px;margin-bottom:4px}
.ticket-info p{color:var(--slate-400);font-size:12px}
.ticket-tons{font-size:18px;font-weight:700;color:var(--emerald-400)}
.ticket-div{font-size:12px;color:var(--slate-400)}
.badge{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;margin-left:6px}
.badge-closed{background:var(--emerald-500);color:white}
.badge-open{background:var(--amber-500);color:var(--slate-900)}
.project-item{background:var(--slate-700);border-radius:8px;padding:12px;margin-bottom:12px;cursor:pointer}
.project-item h4{color:var(--slate-200);font-size:14px;margin-bottom:4px}
.project-item p{color:var(--slate-400);font-size:12px}
.project-selector{background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.diversion-badge{font-size:28px;font-weight:700}
.diversion-badge.good{color:var(--emerald-400)}
.diversion-badge.warning{color:var(--amber-400)}
.diversion-badge.bad{color:var(--red-400)}
.signature-pad{width:100%;height:120px;background:white;border-radius:8px;touch-action:none}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--slate-700);color:var(--slate-200);padding:12px 24px;border-radius:8px;font-size:14px;z-index:300;opacity:0;transition:all 0.3s}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.success{background:var(--emerald-500)}
.toast.error{background:var(--red-500)}
.loading{display:flex;flex-direction:column;align-items:center;padding:40px;color:var(--slate-400)}
.spinner{width:40px;height:40px;border:3px solid var(--slate-700);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none!important}
.empty-state{text-align:center;padding:40px;color:var(--slate-500)}

.project-card{background:var(--slate-700);border-radius:12px;padding:16px;margin-bottom:16px;cursor:pointer}
.project-card h3{color:var(--slate-200);font-size:16px;margin-bottom:4px}
.project-card .meta{color:var(--slate-400);font-size:12px;margin-bottom:12px}
.project-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}
.project-stat{text-align:center;padding:8px;background:var(--slate-800);border-radius:6px}
.project-stat .value{font-size:16px;font-weight:700;color:var(--emerald-400)}
.project-stat .label{font-size:9px;color:var(--slate-500);text-transform:uppercase}
.report-table{width:100%;font-size:11px;border-collapse:collapse}
.report-table th,.report-table td{padding:6px 4px;text-align:left;border-bottom:1px solid var(--slate-600)}
.report-table th{color:var(--slate-400)}.report-table .num{text-align:right}
.btn-blue{background:var(--blue-500);color:white}
.audit-section{margin-top:12px;padding:12px;background:var(--slate-800);border-radius:8px}
.audit-photos{display:flex;gap:8px;overflow-x:auto}.audit-photo{width:60px;height:60px;border-radius:6px;object-fit:cover}
</style>
</head>
<body>
<header class="header">
<div class="logo">DivertScan‚Ñ¢ <span>v3.3</span></div>
<button class="btn btn-secondary btn-sm" onclick="showTab('settings')" style="width:auto">‚öôÔ∏è</button>
</header>
<main>
<!-- Auth Screen -->
<div id="authScreen" class="tab-content active">
<div style="max-width:400px;margin:40px auto;padding:20px">
<div style="text-align:center;margin-bottom:32px">
<div style="font-size:48px;margin-bottom:16px">‚ôªÔ∏è</div>
<h1 style="font-size:24px;color:var(--emerald-400);margin-bottom:8px">DivertScan‚Ñ¢</h1>
<p style="color:var(--slate-400)">LEED-Compliant Waste Tracking</p>
</div>
<div class="card">
<div class="form-group"><label class="form-label">Email</label><input type="email" id="authEmail" class="form-input" placeholder="you@company.com"></div>
<div class="form-group"><label class="form-label">Password</label><input type="password" id="authPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
<button class="btn btn-primary btn-lg" onclick="signIn()">Sign In</button>
<p style="text-align:center;margin-top:16px;font-size:12px;color:var(--slate-500)">No account? <a href="#" onclick="signUp();return false" style="color:var(--emerald-400)">Sign Up</a></p>
</div>
<p style="text-align:center;font-size:10px;color:var(--slate-500);margin-top:20px">¬© 2024-2025 DivertScan‚Ñ¢</p>
</div>
</div>

<!-- Dashboard -->
<div id="dashboardTab" class="tab-content">
<div class="project-selector" onclick="showProjectModal()">
<div>
<div style="font-size:10px;color:var(--slate-500)">CURRENT PROJECT</div>
<div style="font-weight:600;color:var(--slate-200)" id="currentProjectName">Select Project</div>
<div style="font-size:11px;color:var(--emerald-400)" id="currentProjectHauler"></div>
</div>
<span style="color:var(--emerald-400);font-size:12px">Change ‚Üí</span>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statTickets">0</div><div class="stat-label">Tickets</div></div>
<div class="stat-card"><div class="stat-value" id="statTons">0</div><div class="stat-label">Total Tons</div></div>
<div class="stat-card"><div class="stat-value" id="statDiversion">0%</div><div class="stat-label">Diversion</div></div>
<div class="stat-card"><div class="stat-value" id="statCO2">0</div><div class="stat-label">CO‚ÇÇe</div></div>
</div>
<div class="card" style="margin-top:16px">
<div class="card-title">LEED v5 Progress (75% Target)</div>
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span style="font-size:11px;color:var(--slate-400)">Current</span>
<span style="font-size:14px;font-weight:600" id="leedProgress">0%</span>
</div>
<div class="progress-bar"><div class="progress-fill" id="leedProgressBar" style="width:0%"></div></div>
</div>
<button class="btn btn-primary btn-lg" style="margin-top:20px" onclick="startNewTicket()">‚ûï New Ticket</button>
<div class="card" style="margin-top:20px">
<div class="card-title">Recent Tickets <span style="font-size:10px;color:var(--slate-500);font-weight:normal">(tap to edit)</span></div>
<div class="ticket-list" id="ticketList"><div class="empty-state">No tickets yet</div></div>
</div>
</div>

<!-- Projects Tab -->
<div id="projectsTab" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:18px">Projects</h2>
<button class="btn btn-primary btn-sm" onclick="showNewProjectModal()" style="width:auto">‚ûï New</button>
</div>
<div id="projectListFull"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- Tickets Tab -->
<div id="ticketsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:16px">All Tickets</h2>
<div class="ticket-list" id="allTicketsList"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- Reports Tab -->
<div id="reportsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:8px">LEED Reports</h2>
<p style="font-size:12px;color:var(--slate-400);margin-bottom:16px">Tap a project to view tickets and export reports</p>
<div id="projectReportList"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- Settings Tab -->
<div id="settingsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:16px">Settings</h2>
<div class="card">
<div class="card-title">OpenAI API Key</div>
<div class="form-group"><input type="password" id="openaiKeyInput" class="form-input" placeholder="sk-..."></div>
<button class="btn btn-primary" onclick="saveOpenAIKey()">Save Key</button>
</div>
<div class="card">
<div class="card-title">Account</div>
<p style="color:var(--slate-300);margin-bottom:8px" id="userEmail">-</p>
<button class="btn btn-secondary" onclick="signOut()">Sign Out</button>
</div>
</div>
</main>

<nav class="nav">
<div class="nav-item active" onclick="showTab('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Home</div>
<div class="nav-item" onclick="showTab('projects')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Projects</div>
<div class="nav-item" onclick="showTab('tickets')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>Tickets</div>
<div class="nav-item" onclick="showTab('reports')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>Reports</div>
<div class="nav-item" onclick="showTab('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2"/></svg>Settings</div>
</nav>

<div id="toast" class="toast"></div>

<!-- New Ticket Modal -->
<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title" id="ticketModalTitle">New Ticket</div>
<button class="modal-close" onclick="closeModal('ticketModal')">√ó</button>
</div>
<div class="modal-body">
<div class="steps">
<div class="step active" id="step1">1</div><div class="step-line" id="stepLine1"></div>
<div class="step" id="step2">2</div><div class="step-line" id="stepLine2"></div>
<div class="step" id="step3">3</div><div class="step-line" id="stepLine3"></div>
<div class="step" id="step4">4</div>
</div>

<!-- Step 1: Scale Ticket -->
<div id="ticketStep1">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center">üìÑ Scale Ticket & Weights</h3>
<div class="form-group">
<label class="form-label">Project *</label>
<select id="ticketProject" class="form-input" onchange="onProjectChange()" style="appearance:auto">
<option value="">Select Project...</option>
</select>
</div>
<div class="image-preview" id="ticketImagePreview"><span>Use buttons below to scan ticket</span></div>
<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('ticketCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-secondary" onclick="document.getElementById('ticketFileInput').click()">üìÅ Upload</button>
</div>
<input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleTicketFile(event)">
<input type="file" id="ticketFileInput" accept="image/*" style="display:none" onchange="handleTicketFile(event)">
<div id="ticketAnalyzing" class="loading hidden"><div class="spinner"></div><p>Analyzing with AI...</p></div>
<div class="form-group"><label class="form-label">Service Date</label><input type="date" id="serviceDate" class="form-input"></div>
<div class="form-group"><label class="form-label">Ticket #</label><input type="text" id="ticketNumber" class="form-input" placeholder="84600"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" id="grossLbs" class="form-input" placeholder="40620" oninput="updateWeights()"></div>
<div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" id="tareLbs" class="form-input" placeholder="34840" oninput="updateWeights()"></div>
</div>
<div class="form-group"><label class="form-label">Net Weight</label><div style="font-size:24px;font-weight:700;color:var(--emerald-400)" id="netWeightDisplay">0.00 tons</div></div>
<div class="form-group"><label class="form-label">Hauler</label><input type="text" id="haulerName" class="form-input" placeholder="Dalmex Recycling"></div>
</div>

<!-- Step 2: Debris Photos -->
<div id="ticketStep2" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center">üì∏ Debris Photos (1-3)</h3>
<p style="font-size:12px;color:var(--slate-400);margin-bottom:12px;text-align:center">Use "Select Photos" to pick multiple at once. AI analyzes ALL photos together.</p>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yard</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yard</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yard</small></div>
</div>
<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" onclick="clickPhotoSlot(0)">‚ûï</div>
<div class="photo-slot" onclick="clickPhotoSlot(1)">‚ûï</div>
<div class="photo-slot" onclick="clickPhotoSlot(2)">‚ûï</div>
</div>
<div class="btn-row" style="margin-bottom:12px">
<button class="btn btn-secondary" onclick="document.getElementById('debrisCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('debrisMultiInput').click()">üìÅ Select Photos</button>
</div>
<input type="file" id="debrisCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleDebrisSingle(event)">
<input type="file" id="debrisSingleInput" accept="image/*" style="display:none" onchange="handleDebrisSingle(event)">
<input type="file" id="debrisMultiInput" accept="image/*" multiple="multiple" style="display:none" onchange="handleDebrisMultiple(event)">
<p style="font-size:12px;color:var(--slate-400);text-align:center;margin-bottom:16px">Photos: <span id="photoCount">0</span>/3</p>
<button class="btn btn-primary" id="analyzeDebrisBtn" onclick="analyzeDebris()" disabled>ü§ñ Analyze Materials</button>
<div id="debrisAnalyzing" class="loading hidden"><div class="spinner"></div><p>AI analyzing photos...</p></div>
</div>

<!-- Step 3: Review -->
<div id="ticketStep3" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center">‚úèÔ∏è Review & Edit</h3>
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div><div style="font-size:11px;color:var(--slate-400)">Diversion</div><div class="diversion-badge" id="finalDiversionRate">0%</div></div>
<div style="text-align:right"><div style="font-size:11px;color:var(--slate-400)">LEED v5</div><div style="font-size:14px">75%</div></div>
</div>
<div class="progress-bar" style="margin-top:8px"><div class="progress-fill" id="finalProgressBar" style="width:0%"></div></div>
</div>
<div style="font-size:11px;color:var(--slate-400);margin:12px 0 8px">MATERIALS (editable - must = 100%)</div>
<div class="material-grid" id="materialBreakdownEdit"></div>
<div style="margin-top:8px;font-size:12px">Total: <span id="materialTotal" style="color:var(--emerald-400);font-weight:600">100%</span></div>
<div class="card" style="margin-top:16px">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px">
<div><div style="color:var(--slate-500)">Ticket #</div><div id="reviewTicketNum">-</div></div>
<div><div style="color:var(--slate-500)">Date</div><div id="reviewDate">-</div></div>
<div><div style="color:var(--slate-500)">Net</div><div id="reviewNetTons" style="color:var(--emerald-400);font-weight:700">-</div></div>
<div><div style="color:var(--slate-500)">CO‚ÇÇe</div><div id="reviewCO2">-</div></div>
</div>
</div>
</div>

<!-- Step 4: Sign -->
<div id="ticketStep4" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center">‚úçÔ∏è Sign & Finalize</h3>
<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-bottom:16px">
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Sign below to certify</p>
<canvas id="signaturePad" class="signature-pad"></canvas>
<button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="clearSignaturePad()">Clear</button>
</div>
<p style="font-size:10px;color:var(--slate-400);line-height:1.5">By signing: weights and materials are accurate, diverted materials not used for ADC, data processed via AI Volumetric Mass-Balance.</p>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="prevStepBtn" onclick="prevStep()" style="flex:1" disabled>Back</button>
<button class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" style="flex:1">Next</button>
</div>
</div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">Edit Ticket</div>
<button class="modal-close" onclick="closeModal('editModal')">√ó</button>
</div>
<div class="modal-body">
<div id="editClosedWarning" class="hidden" style="background:var(--blue-500);color:white;padding:12px;border-radius:8px;margin-bottom:16px">‚úÖ Finalized ticket - edits will update the record</div>
<div id="editFields">
<div class="form-group"><label class="form-label">Date</label><input type="date" id="editServiceDate" class="form-input"></div>
<div class="form-group"><label class="form-label">Ticket #</label><input type="text" id="editTicketNumber" class="form-input"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Gross</label><input type="number" id="editGrossLbs" class="form-input" oninput="updateEditCalcs()"></div>
<div class="form-group"><label class="form-label">Tare</label><input type="number" id="editTareLbs" class="form-input" oninput="updateEditCalcs()"></div>
</div>
<div class="form-group"><label class="form-label">Net</label><div style="font-size:20px;font-weight:700;color:var(--emerald-400)" id="editNetDisplay">0 tons</div></div>
<div style="font-size:11px;color:var(--slate-400);margin:12px 0 8px">MATERIALS</div>
<div class="material-grid" id="editMaterialGrid"></div>
<div style="margin-top:8px">Total: <span id="editMaterialTotal">100%</span></div>
<div style="margin-top:12px;padding:12px;background:var(--slate-700);border-radius:8px">
<div style="font-size:11px;color:var(--slate-400)">Diversion</div>
<div style="font-size:20px;font-weight:700" id="editDiversionRate">0%</div>
</div>
</div>
</div>
<div class="modal-footer" id="editFooter">
<button class="btn btn-danger" onclick="deleteCurrentTicket()" style="flex:1">üóëÔ∏è Delete</button>
<button class="btn btn-primary" onclick="saveEditedTicket()" style="flex:1">üíæ Save</button>
</div>
</div>
</div>

<!-- Project Select Modal -->
<div id="projectModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title">Select Project</div><button class="modal-close" onclick="closeModal('projectModal')">√ó</button></div>
<div class="modal-body">
<div id="projectList"><div class="loading"><div class="spinner"></div></div></div>
<button class="btn btn-primary" style="margin-top:16px" onclick="showNewProjectModal()">‚ûï New Project</button>
</div>
</div>
</div>

<!-- New Project Modal -->
<div id="newProjectModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title" id="projectModalTitle">New Project</div><button class="modal-close" onclick="closeModal('newProjectModal')">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Project Name *</label><input type="text" id="projectName" class="form-input" placeholder="Children's Hospital"></div>
<div class="form-group"><label class="form-label">Address</label><input type="text" id="projectAddress" class="form-input" placeholder="1234 Main St, Dallas TX"></div>
<div class="form-group"><label class="form-label">Waste Hauler</label><input type="text" id="projectHauler" class="form-input" placeholder="Dalmex Recycling"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('newProjectModal')" style="flex:1">Cancel</button>
<button class="btn btn-primary" onclick="saveProject()" style="flex:1">Save</button>
</div>
</div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal"><div class="modal-content" style="max-height:95vh">
<div class="modal-header"><div class="modal-title" id="rptProjName">Report</div><button class="modal-close" onclick="closeModal('reportModal')">√ó</button></div>
<div class="modal-body">
<div id="rptMeta" style="color:var(--slate-400);font-size:12px;margin-bottom:16px"></div>
<div class="project-stats" id="rptStats"></div>
<div class="card"><div style="display:flex;justify-content:space-between"><div><div style="font-size:11px;color:var(--slate-400)">Diversion</div><div class="diversion-badge" id="rptDiv">0%</div></div><div style="text-align:right"><div style="font-size:11px;color:var(--slate-400)">LEED v5</div><div style="font-size:20px;font-weight:700">75%</div></div></div><div class="progress-bar" style="margin-top:12px"><div class="progress-fill" id="rptBar" style="width:0%"></div></div><div style="margin-top:8px;text-align:center;font-size:12px" id="rptLeed"></div></div>
<div class="card"><div class="card-title">Export Reports</div><div class="btn-row" style="margin-bottom:8px"><button class="btn btn-blue" onclick="exportPDF()">üìÑ PDF</button><button class="btn btn-primary" onclick="exportExcel()">üìä Excel</button></div><div class="btn-row"><button class="btn btn-secondary" onclick="exportAudit()">üîç Audit</button><button class="btn btn-secondary" onclick="exportCSV()">üìã CSV</button></div></div>
<div style="background:var(--slate-700);border-radius:8px;padding:16px"><h4 style="margin-bottom:12px">Tickets (<span id="rptCount">0</span>)</h4><div style="overflow-x:auto"><table class="report-table"><thead><tr><th>Date</th><th>Ticket</th><th class="num">Tons</th><th class="num">Div%</th><th>üì∑</th></tr></thead><tbody id="rptBody"></tbody></table></div></div>
<div style="background:var(--slate-700);border-radius:8px;padding:16px;margin-top:16px"><h4 style="margin-bottom:12px">Materials</h4><div id="rptMats"></div></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('reportModal')">Close</button></div>
</div></div>

<script>
// ¬© 2024-2025 DivertScan‚Ñ¢. Confidential and Proprietary.
const SUPABASE_URL = 'https://cyvvlngtojagfoaitoog.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g';
const MATERIAL_KEYS = ['wood', 'gypsum', 'plastic', 'occ', 'metal', 'concrete', 'block', 'landfill'];
const MATERIALS = {
    wood: {name:'Wood',icon:'ü™µ',gwp:0.03,density:25},
    gypsum: {name:'Gypsum',icon:'üß±',gwp:0.12,density:50},
    plastic: {name:'Plastic',icon:'‚ôªÔ∏è',gwp:2.5,density:30},
    occ: {name:'OCC',icon:'üì¶',gwp:0.94,density:12},
    metal: {name:'Metal',icon:'üî©',gwp:1.85,density:490},
    concrete: {name:'Concrete',icon:'ü™®',gwp:0.159,density:150},
    block: {name:'Block',icon:'üß±',gwp:0.159,density:125},
    landfill: {name:'Landfill',icon:'üóëÔ∏è',gwp:0.52,density:45}
};

// Convert volume % to weight % using material densities
function volumeToWeight(volPcts) {
    let totalWt = 0;
    const wts = {};
    for (const k of MATERIAL_KEYS) {
        const v = volPcts[k] || 0;
        wts[k] = v * MATERIALS[k].density;
        totalWt += wts[k];
    }
    const wtPcts = {};
    for (const k of MATERIAL_KEYS) {
        wtPcts[k] = totalWt > 0 ? Math.round((wts[k] / totalWt) * 100) : 0;
    }
    // Ensure = 100%
    let sum = Object.values(wtPcts).reduce((a,b) => a+b, 0);
    if (sum !== 100 && sum > 0) {
        wtPcts.landfill = Math.max(0, (wtPcts.landfill || 0) + (100 - sum));
    }
    return wtPcts;
}

let sb = null;
let currentUser = null;
let currentProject = null;
let projects = [];
let ticketSession = {};
let editingTicketId = null;
let currentEditTicket = null;
let currentStep = 1;
let selectedContainer = 30;
let debrisPhotos = [null, null, null];
let currentPhotoSlot = 0;
let signatureCanvas, signatureCtx, isDrawing = false;

function toast(msg, type = 'info') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + type + ' show';
    setTimeout(() => el.classList.remove('show'), 3000);
}

function getCurrentDate() {
    return new Date().toISOString().split('T')[0];
}

function formatDate(d) {
    if (!d) return '';
    return new Date(d + 'T00:00:00').toLocaleDateString('en-US', {month:'2-digit',day:'2-digit',year:'2-digit'});
}

function formatDateDB(s) {
    if (!s) return getCurrentDate();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const p = s.split('/');
    if (p.length === 3) {
        const y = p[2].length === 2 ? '20' + p[2] : p[2];
        return y + '-' + p[0].padStart(2,'0') + '-' + p[1].padStart(2,'0');
    }
    return getCurrentDate();
}

function initSession() {
    ticketSession = {
        projectId: currentProject?.id,
        ticketNumber: null,
        serviceDate: getCurrentDate(),
        grossLbs: null,
        tareLbs: null,
        netLbs: null,
        netTons: null,
        hauler: currentProject?.waste_hauler || '',
        containerSize: 30,
        scaleTicketImage: null,
        debrisImages: [],
        materialBreakdown: {},
        diversionRate: 0,
        co2eAvoided: 0,
        signature: null,
        isClosed: false
    };
    editingTicketId = null;
}

function recalcSession() {
    const g = parseFloat(ticketSession.grossLbs) || 0;
    const t = parseFloat(ticketSession.tareLbs) || 0;
    ticketSession.netLbs = Math.max(0, g - t);
    ticketSession.netTons = ticketSession.netLbs / 2000;
    
    let divPct = 0, co2 = 0;
    for (const k of MATERIAL_KEYS) {
        const pct = parseFloat(ticketSession.materialBreakdown[k]) || 0;
        const tons = (pct / 100) * ticketSession.netTons;
        if (k !== 'landfill') divPct += pct;
        co2 += tons * (MATERIALS[k]?.gwp || 0);
    }
    ticketSession.diversionRate = Math.round(divPct);
    ticketSession.co2eAvoided = co2;
}

async function initSupabase() {
    if (sb) return sb;
    if (typeof supabase === 'undefined') {
        await new Promise((res, rej) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            s.onload = res;
            s.onerror = rej;
            document.head.appendChild(s);
        });
    }
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    return sb;
}

async function initialize() {
    try {
        await initSupabase();
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            currentUser = session.user;
            showApp();
        }
        sb.auth.onAuthStateChange((e, s) => {
            if (s) { currentUser = s.user; showApp(); }
            else { currentUser = null; showAuth(); }
        });
    } catch (e) {
        console.error(e);
        toast('Init failed', 'error');
    }
}

async function signIn() {
    const email = document.getElementById('authEmail').value;
    const pw = document.getElementById('authPassword').value;
    if (!email || !pw) { toast('Enter email & password', 'error'); return; }
    try {
        const { error } = await sb.auth.signInWithPassword({ email, password: pw });
        if (error) throw error;
    } catch (e) { toast(e.message, 'error'); }
}

async function signUp() {
    const email = document.getElementById('authEmail').value;
    const pw = document.getElementById('authPassword').value;
    if (!email || !pw) { toast('Enter email & password', 'error'); return; }
    try {
        const { error } = await sb.auth.signUp({ email, password: pw });
        if (error) throw error;
        toast('Check email to confirm', 'success');
    } catch (e) { toast(e.message, 'error'); }
}

async function signOut() {
    await sb.auth.signOut();
    showAuth();
}

function showAuth() {
    document.getElementById('authScreen').classList.add('active');
    document.getElementById('dashboardTab').classList.remove('active');
    document.querySelector('.nav').style.display = 'none';
}

function showApp() {
    document.getElementById('authScreen').classList.remove('active');
    document.querySelector('.nav').style.display = 'flex';
    document.getElementById('userEmail').textContent = currentUser?.email || '-';
    document.getElementById('openaiKeyInput').value = localStorage.getItem('divertscan_openai') || '';
    loadProjectsAndData();
    showTab('dashboard');
}

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(tab + 'Tab').classList.add('active');
    const idx = ['dashboard','projects','tickets','reports','settings'].indexOf(tab);
    if (idx >= 0) document.querySelectorAll('.nav-item')[idx].classList.add('active');
    if (tab === 'projects') loadProjectListFull();
    if (tab === 'tickets') loadAllTickets();
    if (tab === 'reports') loadReportList();
}

async function loadProjectsAndData() {
    try {
        const { data } = await sb.from('projects').select('*').eq('user_id', currentUser?.id).order('created_at', {ascending:false});
        projects = data || [];
        if (projects.length > 0) {
            currentProject = projects[0];
            document.getElementById('currentProjectName').textContent = currentProject.name;
            document.getElementById('currentProjectHauler').textContent = currentProject.waste_hauler || '';
            loadDashboard();
        } else {
            document.getElementById('currentProjectName').textContent = 'Create Project ‚Üí';
        }
    } catch (e) { console.error(e); }
}

async function loadDashboard() {
    if (!currentProject) return;
    try {
        const { data: tickets } = await sb.from('tickets').select('*').eq('project_id', currentProject.id).order('service_date', {ascending:false});
        const tks = tickets || [];
        const tons = tks.reduce((s,t) => s + (+t.net_tons||0), 0);
        const diverted = tks.reduce((s,t) => s + (+t.diverted_tons||0), 0);
        const avgDiv = tons > 0 ? (diverted/tons*100) : 0;
        const co2 = tks.reduce((s,t) => s + (+t.co2e_avoided||0), 0);
        
        document.getElementById('statTickets').textContent = tks.length;
        document.getElementById('statTons').textContent = tons.toFixed(2);
        document.getElementById('statDiversion').textContent = avgDiv.toFixed(0) + '%';
        document.getElementById('statCO2').textContent = co2.toFixed(1);
        document.getElementById('leedProgress').textContent = avgDiv.toFixed(0) + '%';
        
        const bar = document.getElementById('leedProgressBar');
        bar.style.width = Math.min(avgDiv, 100) + '%';
        bar.className = 'progress-fill' + (avgDiv >= 75 ? '' : avgDiv >= 50 ? ' warning' : ' danger');
        
        renderTicketList(tks.slice(0, 8), 'ticketList');
    } catch (e) { console.error(e); }
}

async function loadAllTickets() {
    if (!currentProject) {
        document.getElementById('allTicketsList').innerHTML = '<div class="empty-state">Select a project</div>';
        return;
    }
    try {
        const { data } = await sb.from('tickets').select('*').eq('project_id', currentProject.id).order('service_date', {ascending:false});
        renderTicketList(data || [], 'allTicketsList');
    } catch (e) { console.error(e); }
}

function renderTicketList(tickets, containerId) {
    const list = document.getElementById(containerId);
    if (!tickets.length) {
        list.innerHTML = '<div class="empty-state">No tickets</div>';
        return;
    }
    list.innerHTML = tickets.map(t => `
        <div class="ticket-item ${t.is_closed ? 'closed' : ''}" onclick="openEditTicket('${t.id}')">
            <div class="ticket-row">
                <div class="ticket-info">
                    <h4>#${t.ticket_number || 'N/A'}${t.is_closed ? '<span class="badge badge-closed">CLOSED</span>' : '<span class="badge badge-open">OPEN</span>'}</h4>
                    <p>${formatDate(t.service_date)} ‚Ä¢ ${t.hauler || 'Unknown'}</p>
                </div>
                <div>
                    <div class="ticket-tons">${(t.net_tons||0).toFixed(2)}T</div>
                    <div class="ticket-div">${t.diversion_pct||0}%</div>
                </div>
            </div>
        </div>
    `).join('');
}
</script>

<script>
// Project Management
function showProjectModal() {
    openModal('projectModal');
    loadProjectList();
}

async function loadProjectList() {
    const list = document.getElementById('projectList');
    if (!projects.length) {
        list.innerHTML = '<div class="empty-state">No projects</div>';
        return;
    }
    list.innerHTML = projects.map(p => `
        <div class="project-item ${currentProject?.id === p.id ? 'selected' : ''}" onclick="selectProject('${p.id}')" style="${currentProject?.id === p.id ? 'border:2px solid var(--emerald-500)' : ''}">
            <h4>${p.name}</h4>
            <p>${p.address || 'No address'}</p>
            <p style="color:var(--emerald-400);font-size:11px">${p.waste_hauler || ''}</p>
        </div>
    `).join('');
}

async function loadProjectListFull() {
    const list = document.getElementById('projectListFull');
    if (!projects.length) {
        list.innerHTML = '<div class="empty-state">No projects yet</div>';
        return;
    }
    list.innerHTML = projects.map(p => `
        <div class="project-item">
            <h4>${p.name}</h4>
            <p>${p.address || 'No address'}</p>
            <p style="color:var(--emerald-400);font-size:11px">${p.waste_hauler || 'No hauler'}</p>
            <div class="btn-row" style="margin-top:8px">
                <button class="btn btn-secondary btn-sm" onclick="editProject('${p.id}');event.stopPropagation()">‚úèÔ∏è Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}');event.stopPropagation()">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

function selectProject(id) {
    currentProject = projects.find(p => p.id === id);
    if (currentProject) {
        document.getElementById('currentProjectName').textContent = currentProject.name;
        document.getElementById('currentProjectHauler').textContent = currentProject.waste_hauler || '';
        closeModal('projectModal');
        loadDashboard();
    }
}

let editingProjectId = null;

function showNewProjectModal() {
    editingProjectId = null;
    document.getElementById('projectModalTitle').textContent = 'New Project';
    document.getElementById('projectName').value = '';
    document.getElementById('projectAddress').value = '';
    document.getElementById('projectHauler').value = '';
    closeModal('projectModal');
    openModal('newProjectModal');
}

function editProject(id) {
    const p = projects.find(x => x.id === id);
    if (!p) return;
    editingProjectId = id;
    document.getElementById('projectModalTitle').textContent = 'Edit Project';
    document.getElementById('projectName').value = p.name || '';
    document.getElementById('projectAddress').value = p.address || '';
    document.getElementById('projectHauler').value = p.waste_hauler || '';
    openModal('newProjectModal');
}

async function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) { toast('Enter project name', 'error'); return; }
    const data = {
        name,
        address: document.getElementById('projectAddress').value.trim() || null,
        waste_hauler: document.getElementById('projectHauler').value.trim() || null
    };
    try {
        if (editingProjectId) {
            await sb.from('projects').update(data).eq('id', editingProjectId);
            toast('Project updated!', 'success');
        } else {
            data.user_id = currentUser?.id;
            const { data: newP } = await sb.from('projects').insert([data]).select().single();
            projects.unshift(newP);
            selectProject(newP.id);
            toast('Project created!', 'success');
        }
        await loadProjectsAndData();
        closeModal('newProjectModal');
        loadProjectListFull();
    } catch (e) { toast(e.message, 'error'); }
}

async function deleteProject(id) {
    if (!confirm('Delete this project?')) return;
    try {
        await sb.from('projects').delete().eq('id', id);
        projects = projects.filter(p => p.id !== id);
        if (currentProject?.id === id) currentProject = projects[0] || null;
        toast('Deleted', 'success');
        loadProjectsAndData();
        loadProjectListFull();
    } catch (e) { toast(e.message, 'error'); }
}

// New Ticket Flow
function populateProjectDropdown() {
    const sel = document.getElementById('ticketProject');
    sel.innerHTML = '<option value="">Select Project...</option>' + 
        projects.map(p => `<option value="${p.id}" ${p.id === currentProject?.id ? 'selected' : ''}>${p.name}</option>`).join('');
}

function onProjectChange() {
    const id = document.getElementById('ticketProject').value;
    const p = projects.find(x => x.id === id);
    if (p) {
        ticketSession.projectId = p.id;
        ticketSession.hauler = p.waste_hauler || '';
        document.getElementById('haulerName').value = p.waste_hauler || '';
    }
}

function startNewTicket() {
    if (!projects.length) { toast('Create a project first', 'error'); return; }
    initSession();
    currentStep = 1;
    debrisPhotos = [null, null, null];
    
    document.getElementById('ticketModalTitle').textContent = 'New Ticket';
    document.getElementById('ticketImagePreview').innerHTML = '<span>Use buttons below to scan ticket</span>';
    document.getElementById('ticketImagePreview').classList.remove('filled');
    document.getElementById('serviceDate').value = getCurrentDate();
    document.getElementById('ticketNumber').value = '';
    document.getElementById('grossLbs').value = '';
    document.getElementById('tareLbs').value = '';
    document.getElementById('netWeightDisplay').textContent = '0.00 tons';
    document.getElementById('haulerName').value = currentProject?.waste_hauler || '';
    
    populateProjectDropdown();
    showStep(1);
    resetDebrisGrid();
    openModal('ticketModal');
}

function showStep(step) {
    currentStep = step;
    for (let i = 1; i <= 4; i++) {
        document.getElementById('ticketStep' + i).classList.toggle('hidden', i !== step);
        document.getElementById('step' + i).className = 'step' + (i < step ? ' complete' : i === step ? ' active' : '');
    }
    for (let i = 1; i <= 3; i++) {
        document.getElementById('stepLine' + i).className = 'step-line' + (step > i ? ' complete' : '');
    }
    document.getElementById('prevStepBtn').disabled = step === 1;
    document.getElementById('nextStepBtn').textContent = step === 4 ? '‚úÖ Finalize' : 'Next';
    
    if (step === 3) populateReview();
    if (step === 4) setupSignaturePad();
}

function nextStep() {
    if (currentStep === 4) { finalizeTicket(); return; }
    
    if (currentStep === 1) {
        const projId = document.getElementById('ticketProject').value;
        if (!projId) { toast('Select a project', 'error'); return; }
        if (!ticketSession.grossLbs || !ticketSession.tareLbs) { toast('Enter weights', 'error'); return; }
    }
    if (currentStep === 2) {
        if (ticketSession.diversionRate === 0 && !debrisPhotos.some(p => p)) {
            toast('Add & analyze photos', 'error'); return;
        }
    }
    showStep(currentStep + 1);
}

function prevStep() {
    if (currentStep > 1) showStep(currentStep - 1);
}

// Step 1: Scale Ticket
async function handleTicketFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (ev) => {
        const img = ev.target.result;
        document.getElementById('ticketImagePreview').innerHTML = '<img src="' + img + '">';
        document.getElementById('ticketImagePreview').classList.add('filled');
        document.getElementById('ticketAnalyzing').classList.remove('hidden');
        
        try {
            const apiKey = localStorage.getItem('divertscan_openai');
            if (!apiKey) throw new Error('Add OpenAI key in Settings');
            
            const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: 'Extract from scale ticket. Return ONLY JSON: {"ticket_number":"string","date":"MM/DD/YY","hauler":"string","gross_lbs":number,"tare_lbs":number}' },
                            { type: 'image_url', image_url: { url: img } }
                        ]
                    }],
                    max_tokens: 500
                })
            });
            const data = await resp.json();
            if (data.error) throw new Error(data.error.message);
            
            const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
            if (!match) throw new Error('Parse failed');
            const res = JSON.parse(match[0]);
            
            ticketSession.ticketNumber = res.ticket_number;
            ticketSession.serviceDate = res.date ? formatDateDB(res.date) : getCurrentDate();
            ticketSession.grossLbs = res.gross_lbs;
            ticketSession.tareLbs = res.tare_lbs;
            ticketSession.hauler = res.hauler || ticketSession.hauler;
            ticketSession.scaleTicketImage = img;
            
            document.getElementById('ticketNumber').value = res.ticket_number || '';
            document.getElementById('serviceDate').value = ticketSession.serviceDate;
            document.getElementById('grossLbs').value = res.gross_lbs || '';
            document.getElementById('tareLbs').value = res.tare_lbs || '';
            document.getElementById('haulerName').value = ticketSession.hauler || '';
            updateWeights();
            toast('Ticket analyzed!', 'success');
        } catch (err) {
            toast(err.message, 'error');
        } finally {
            document.getElementById('ticketAnalyzing').classList.add('hidden');
        }
    };
    reader.readAsDataURL(file);
    e.target.value = '';
}

function updateWeights() {
    ticketSession.grossLbs = parseFloat(document.getElementById('grossLbs').value) || 0;
    ticketSession.tareLbs = parseFloat(document.getElementById('tareLbs').value) || 0;
    ticketSession.serviceDate = document.getElementById('serviceDate').value;
    ticketSession.ticketNumber = document.getElementById('ticketNumber').value;
    ticketSession.hauler = document.getElementById('haulerName').value;
    ticketSession.projectId = document.getElementById('ticketProject').value;
    recalcSession();
    document.getElementById('netWeightDisplay').textContent = (ticketSession.netTons || 0).toFixed(2) + ' tons';
}

// Step 2: Debris Photos
function selectContainer(size) {
    selectedContainer = size;
    ticketSession.containerSize = size;
    document.querySelectorAll('.container-option').forEach(o => {
        o.classList.toggle('selected', o.querySelector('span').textContent == size);
    });
}

function resetDebrisGrid() {
    debrisPhotos = [null, null, null];
    updateDebrisGrid();
}

function clickPhotoSlot(slot) {
    currentPhotoSlot = slot;
    document.getElementById('debrisSingleInput').click();
}

function handleDebrisSingle(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        debrisPhotos[currentPhotoSlot] = ev.target.result;
        updateDebrisGrid();
    };
    reader.readAsDataURL(file);
    e.target.value = '';
}

function handleDebrisMultiple(e) {
    const files = Array.from(e.target.files).slice(0, 3);
    let loaded = 0;
    debrisPhotos = [null, null, null];
    files.forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            debrisPhotos[i] = ev.target.result;
            loaded++;
            if (loaded === files.length) updateDebrisGrid();
        };
        reader.readAsDataURL(file);
    });
    e.target.value = '';
}

function removeDebrisPhoto(slot, e) {
    e.stopPropagation();
    debrisPhotos[slot] = null;
    updateDebrisGrid();
}

function updateDebrisGrid() {
    const grid = document.getElementById('debrisPhotoGrid');
    grid.innerHTML = debrisPhotos.map((p, i) => p
        ? '<div class="photo-slot filled" onclick="clickPhotoSlot(' + i + ')"><img src="' + p + '"><button class="photo-remove" onclick="removeDebrisPhoto(' + i + ',event)">√ó</button></div>'
        : '<div class="photo-slot" onclick="clickPhotoSlot(' + i + ')">‚ûï</div>'
    ).join('');
    const count = debrisPhotos.filter(p => p).length;
    document.getElementById('photoCount').textContent = count;
    document.getElementById('analyzeDebrisBtn').disabled = count === 0;
}

async function analyzeDebris() {
    const photos = debrisPhotos.filter(p => p);
    if (!photos.length) { toast('Add at least 1 photo', 'error'); return; }
    
    document.getElementById('debrisAnalyzing').classList.remove('hidden');
    document.getElementById('analyzeDebrisBtn').disabled = true;
    
    try {
        const apiKey = localStorage.getItem('divertscan_openai');
        if (!apiKey) throw new Error('Add OpenAI key in Settings');
        
        const content = [
            { type: 'text', text: 'Analyze ' + photos.length + ' C&D debris photo(s) from ' + selectedContainer + '-yard roll-off. Estimate visible VOLUME % accurately. Categories: wood (lumber/plywood/pallets), gypsum (drywall), plastic (film/pipe), occ (cardboard), metal (steel/aluminum), concrete (cement), block (CMU/brick), landfill (mixed/contaminated/trash). If uncertain, use landfill. Return ONLY JSON: {"wood":0-100,"gypsum":0-100,"plastic":0-100,"occ":0-100,"metal":0-100,"concrete":0-100,"block":0-100,"landfill":0-100} MUST total exactly 100.' }
        ];
        photos.forEach(img => content.push({ type: 'image_url', image_url: { url: img } }));
        
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content }],
                max_tokens: 500
            })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error.message);
        
        const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
        if (!match) throw new Error('Parse failed');
        const res = JSON.parse(match[0]);
        
        ticketSession.debrisImages = photos;
        // Convert AI volume % to weight % using densities
        const volPcts = {};
        MATERIAL_KEYS.forEach(k => { volPcts[k] = res[k] || 0; });
        ticketSession.materialBreakdown = volumeToWeight(volPcts);
        recalcSession();
        
        toast(photos.length + ' photo(s) ‚Üí ' + ticketSession.diversionRate + '% diversion', 'success');
        showStep(3);
    } catch (err) {
        toast(err.message, 'error');
        document.getElementById('analyzeDebrisBtn').disabled = false;
    } finally {
        document.getElementById('debrisAnalyzing').classList.add('hidden');
    }
}
</script>

<script>
// Step 3: Review
function populateReview() {
    const d = ticketSession.diversionRate || 0;
    const badge = document.getElementById('finalDiversionRate');
    badge.textContent = d + '%';
    badge.className = 'diversion-badge ' + (d >= 75 ? 'good' : d >= 50 ? 'warning' : 'bad');
    
    const bar = document.getElementById('finalProgressBar');
    bar.style.width = Math.min(d, 100) + '%';
    bar.className = 'progress-fill' + (d >= 75 ? '' : d >= 50 ? ' warning' : ' danger');
    
    const grid = document.getElementById('materialBreakdownEdit');
    grid.innerHTML = MATERIAL_KEYS.map(k => {
        const m = MATERIALS[k];
        const pct = ticketSession.materialBreakdown[k] || 0;
        return '<div class="material-item"><div class="material-name">' + m.icon + ' ' + m.name + '</div><div class="material-input"><input type="number" id="mat_' + k + '" value="' + pct + '" min="0" max="100" onchange="updateMatPct(\'' + k + '\')"><span>%</span></div></div>';
    }).join('');
    
    updateMatTotal();
    document.getElementById('reviewTicketNum').textContent = ticketSession.ticketNumber || '-';
    document.getElementById('reviewDate').textContent = formatDate(ticketSession.serviceDate) || '-';
    document.getElementById('reviewNetTons').textContent = (ticketSession.netTons || 0).toFixed(2) + ' T';
    document.getElementById('reviewCO2').textContent = (ticketSession.co2eAvoided || 0).toFixed(2) + ' MT';
}

function updateMatPct(k) {
    ticketSession.materialBreakdown[k] = parseFloat(document.getElementById('mat_' + k).value) || 0;
    recalcSession();
    updateMatTotal();
    document.getElementById('finalDiversionRate').textContent = ticketSession.diversionRate + '%';
    document.getElementById('reviewCO2').textContent = (ticketSession.co2eAvoided || 0).toFixed(2) + ' MT';
}

function updateMatTotal() {
    let total = 0;
    MATERIAL_KEYS.forEach(k => { total += parseFloat(ticketSession.materialBreakdown[k]) || 0; });
    const el = document.getElementById('materialTotal');
    el.textContent = Math.round(total) + '%';
    el.style.color = Math.abs(total - 100) < 0.5 ? 'var(--emerald-400)' : 'var(--red-400)';
}

// Step 4: Signature
function setupSignaturePad() {
    signatureCanvas = document.getElementById('signaturePad');
    if (!signatureCanvas) return;
    signatureCanvas.width = signatureCanvas.offsetWidth || 300;
    signatureCanvas.height = signatureCanvas.offsetHeight || 120;
    signatureCtx = signatureCanvas.getContext('2d');
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    signatureCtx.strokeStyle = '#000';
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    
    signatureCanvas.onpointerdown = (e) => {
        isDrawing = true;
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCtx.beginPath();
        signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    };
    signatureCanvas.onpointermove = (e) => {
        if (!isDrawing) return;
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
        signatureCtx.stroke();
    };
    signatureCanvas.onpointerup = () => { isDrawing = false; };
    signatureCanvas.onpointerleave = () => { isDrawing = false; };
}

function clearSignaturePad() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.fillStyle = 'white';
        signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

async function finalizeTicket() {
    // Validate materials
    let total = 0;
    MATERIAL_KEYS.forEach(k => { total += parseFloat(ticketSession.materialBreakdown[k]) || 0; });
    if (Math.abs(total - 100) > 0.5) {
        toast('Materials must = 100%', 'error');
        return;
    }
    
    // Get signature
    ticketSession.signature = signatureCanvas ? signatureCanvas.toDataURL('image/png') : null;
    ticketSession.isClosed = true;
    
    recalcSession();
    
    try {
        const b = ticketSession;
        const data = {
            project_id: b.projectId,
            user_id: currentUser?.id,
            ticket_number: b.ticketNumber,
            service_date: b.serviceDate || getCurrentDate(),
            ticket_date: b.serviceDate || getCurrentDate(),
            hauler: b.hauler,
            container_size: b.containerSize,
            gross_lbs: b.grossLbs,
            tare_lbs: b.tareLbs,
            net_lbs: b.netLbs,
            net_tons: b.netTons,
            wood_pct: b.materialBreakdown.wood || 0,
            gypsum_pct: b.materialBreakdown.gypsum || 0,
            plastic_pct: b.materialBreakdown.plastic || 0,
            occ_pct: b.materialBreakdown.occ || 0,
            metal_pct: b.materialBreakdown.metal || 0,
            concrete_pct: b.materialBreakdown.concrete || 0,
            block_pct: b.materialBreakdown.block || 0,
            landfill_pct: b.materialBreakdown.landfill || 0,
            wood_tons: (b.materialBreakdown.wood/100) * b.netTons || 0,
            gypsum_tons: (b.materialBreakdown.gypsum/100) * b.netTons || 0,
            plastic_tons: (b.materialBreakdown.plastic/100) * b.netTons || 0,
            occ_tons: (b.materialBreakdown.occ/100) * b.netTons || 0,
            metal_tons: (b.materialBreakdown.metal/100) * b.netTons || 0,
            concrete_tons: (b.materialBreakdown.concrete/100) * b.netTons || 0,
            block_tons: (b.materialBreakdown.block/100) * b.netTons || 0,
            landfill_tons: (b.materialBreakdown.landfill/100) * b.netTons || 0,
            diversion_pct: b.diversionRate,
            diverted_tons: b.netTons * (b.diversionRate / 100),
            co2e_avoided: b.co2eAvoided,
            signature: b.signature,
            signed_at: new Date().toISOString(),
            is_closed: true,
            closed_at: new Date().toISOString(),
            audit_id: 'DS-' + Date.now()
        };
        
        await sb.from('tickets').insert([data]);
        closeModal('ticketModal');
        toast('Ticket finalized!', 'success');
        loadDashboard();
    } catch (err) {
        toast(err.message, 'error');
    }
}

// Edit Ticket
async function openEditTicket(id) {
    try {
        const { data: t } = await sb.from('tickets').select('*').eq('id', id).single();
        currentEditTicket = t;
        editingTicketId = id;
        
        const closed = t.is_closed;
        document.getElementById('editClosedWarning').classList.toggle('hidden', !closed);
        // Allow editing even if closed - just show info message
        document.getElementById('editFields').style.opacity = '1';
        document.getElementById('editFields').style.pointerEvents = 'auto';
        document.getElementById('editFooter').style.display = 'flex';
        
        document.getElementById('editServiceDate').value = t.service_date || '';
        document.getElementById('editTicketNumber').value = t.ticket_number || '';
        document.getElementById('editGrossLbs').value = t.gross_lbs || '';
        document.getElementById('editTareLbs').value = t.tare_lbs || '';
        document.getElementById('editNetDisplay').textContent = (t.net_tons || 0).toFixed(2) + ' tons';
        
        ticketSession.materialBreakdown = {
            wood: t.wood_pct || 0,
            gypsum: t.gypsum_pct || 0,
            plastic: t.plastic_pct || 0,
            occ: t.occ_pct || 0,
            metal: t.metal_pct || 0,
            concrete: t.concrete_pct || 0,
            block: t.block_pct || 0,
            landfill: t.landfill_pct || 0
        };
        
        const grid = document.getElementById('editMaterialGrid');
        grid.innerHTML = MATERIAL_KEYS.map(k => {
            const m = MATERIALS[k];
            return '<div class="material-item"><div class="material-name">' + m.icon + ' ' + m.name + '</div><div class="material-input"><input type="number" id="edit_' + k + '" value="' + (ticketSession.materialBreakdown[k]||0) + '" min="0" max="100" onchange="updateEditCalcs()"><span>%</span></div></div>';
        }).join('');
        
        updateEditCalcs();
        openModal('editModal');
    } catch (e) {
        toast('Load failed', 'error');
    }
}

function updateEditCalcs() {
    MATERIAL_KEYS.forEach(k => {
        ticketSession.materialBreakdown[k] = parseFloat(document.getElementById('edit_' + k).value) || 0;
    });
    
    ticketSession.grossLbs = parseFloat(document.getElementById('editGrossLbs').value) || 0;
    ticketSession.tareLbs = parseFloat(document.getElementById('editTareLbs').value) || 0;
    recalcSession();
    
    document.getElementById('editNetDisplay').textContent = (ticketSession.netTons || 0).toFixed(2) + ' tons';
    
    let total = 0;
    MATERIAL_KEYS.forEach(k => { total += ticketSession.materialBreakdown[k]; });
    document.getElementById('editMaterialTotal').textContent = Math.round(total) + '%';
    document.getElementById('editMaterialTotal').style.color = Math.abs(total - 100) < 0.5 ? 'var(--emerald-400)' : 'var(--red-400)';
    
    document.getElementById('editDiversionRate').textContent = ticketSession.diversionRate + '%';
    document.getElementById('editDiversionRate').style.color = ticketSession.diversionRate >= 75 ? 'var(--emerald-400)' : ticketSession.diversionRate >= 50 ? 'var(--amber-400)' : 'var(--red-400)';
}

async function saveEditedTicket() {
    let total = 0;
    MATERIAL_KEYS.forEach(k => { total += ticketSession.materialBreakdown[k]; });
    if (Math.abs(total - 100) > 0.5) {
        toast('Materials must = 100%', 'error');
        return;
    }
    
    recalcSession();
    
    try {
        const data = {
            service_date: document.getElementById('editServiceDate').value,
            ticket_number: document.getElementById('editTicketNumber').value,
            gross_lbs: ticketSession.grossLbs,
            tare_lbs: ticketSession.tareLbs,
            net_lbs: ticketSession.netLbs,
            net_tons: ticketSession.netTons,
            wood_pct: ticketSession.materialBreakdown.wood,
            gypsum_pct: ticketSession.materialBreakdown.gypsum,
            plastic_pct: ticketSession.materialBreakdown.plastic,
            occ_pct: ticketSession.materialBreakdown.occ,
            metal_pct: ticketSession.materialBreakdown.metal,
            concrete_pct: ticketSession.materialBreakdown.concrete,
            block_pct: ticketSession.materialBreakdown.block,
            landfill_pct: ticketSession.materialBreakdown.landfill,
            wood_tons: (ticketSession.materialBreakdown.wood/100) * ticketSession.netTons,
            gypsum_tons: (ticketSession.materialBreakdown.gypsum/100) * ticketSession.netTons,
            plastic_tons: (ticketSession.materialBreakdown.plastic/100) * ticketSession.netTons,
            occ_tons: (ticketSession.materialBreakdown.occ/100) * ticketSession.netTons,
            metal_tons: (ticketSession.materialBreakdown.metal/100) * ticketSession.netTons,
            concrete_tons: (ticketSession.materialBreakdown.concrete/100) * ticketSession.netTons,
            block_tons: (ticketSession.materialBreakdown.block/100) * ticketSession.netTons,
            landfill_tons: (ticketSession.materialBreakdown.landfill/100) * ticketSession.netTons,
            diversion_pct: ticketSession.diversionRate,
            diverted_tons: ticketSession.netTons * (ticketSession.diversionRate / 100),
            co2e_avoided: ticketSession.co2eAvoided,
            last_modified: new Date().toISOString(),
            modified_by: currentUser?.email
        };
        
        await sb.from('tickets').update(data).eq('id', editingTicketId);
        closeModal('editModal');
        toast('Saved!', 'success');
        loadDashboard();
        loadAllTickets();
    } catch (e) {
        toast(e.message, 'error');
    }
}

async function deleteCurrentTicket() {
    if (!confirm('Delete this ticket?')) return;
    try {
        await sb.from('tickets').delete().eq('id', editingTicketId);
        closeModal('editModal');
        toast('Deleted', 'success');
        loadDashboard();
        loadAllTickets();
    } catch (e) { toast(e.message, 'error'); }
}

// Reports
async function exportAllTickets() {
    if (!currentProject) { toast('Select project', 'error'); return; }
    try {
        const { data } = await sb.from('tickets').select('*').eq('project_id', currentProject.id).order('service_date');
        if (!data?.length) { toast('No tickets', 'error'); return; }
        downloadReport(data);
    } catch (e) { toast(e.message, 'error'); }
}

async function exportClosedTickets() {
    if (!currentProject) { toast('Select project', 'error'); return; }
    try {
        const { data } = await sb.from('tickets').select('*').eq('project_id', currentProject.id).eq('is_closed', true).order('service_date');
        if (!data?.length) { toast('No finalized tickets', 'error'); return; }
        downloadReport(data);
    } catch (e) { toast(e.message, 'error'); }
}

function downloadReport(tickets) {
    const h = ['Date','Ticket No','Gross','Tare','Net (lbs)','Net (T)','Wood','Gypsum','Plastic','OCC','Metal','Concrete','Block','Landfill','Diverted','Div %'];
    let csv = 'LEED WASTE DIVERSION REPORT\n';
    csv += 'Project: ' + currentProject.name + '\n';
    if (currentProject.address) csv += 'Address: ' + currentProject.address + '\n';
    if (currentProject.waste_hauler) csv += 'Hauler: ' + currentProject.waste_hauler + '\n';
    csv += 'Generated: ' + new Date().toLocaleDateString() + '\n\n';
    csv += h.join(',') + '\n';
    
    let tot = {g:0,t:0,n:0,nt:0,w:0,gy:0,pl:0,oc:0,me:0,co:0,bl:0,lf:0,dv:0};
    tickets.forEach(tk => {
        csv += [formatDate(tk.service_date),tk.ticket_number||'',tk.gross_lbs||0,tk.tare_lbs||0,tk.net_lbs||0,(tk.net_tons||0).toFixed(3),(tk.wood_tons||0).toFixed(3),(tk.gypsum_tons||0).toFixed(3),(tk.plastic_tons||0).toFixed(3),(tk.occ_tons||0).toFixed(3),(tk.metal_tons||0).toFixed(3),(tk.concrete_tons||0).toFixed(3),(tk.block_tons||0).toFixed(3),(tk.landfill_tons||0).toFixed(3),(tk.diverted_tons||0).toFixed(3),(tk.diversion_pct||0)+'%'].join(',') + '\n';
        tot.g+=+tk.gross_lbs||0;tot.t+=+tk.tare_lbs||0;tot.n+=+tk.net_lbs||0;tot.nt+=+tk.net_tons||0;
        tot.w+=+tk.wood_tons||0;tot.gy+=+tk.gypsum_tons||0;tot.pl+=+tk.plastic_tons||0;tot.oc+=+tk.occ_tons||0;
        tot.me+=+tk.metal_tons||0;tot.co+=+tk.concrete_tons||0;tot.bl+=+tk.block_tons||0;tot.lf+=+tk.landfill_tons||0;tot.dv+=+tk.diverted_tons||0;
    });
    
    const ovr = tot.nt > 0 ? ((tot.dv/tot.nt)*100).toFixed(1) : '0';
    csv += '\nTOTALS,' + tickets.length + ',' + tot.g + ',' + tot.t + ',' + tot.n + ',' + tot.nt.toFixed(3) + ',' + tot.w.toFixed(3) + ',' + tot.gy.toFixed(3) + ',' + tot.pl.toFixed(3) + ',' + tot.oc.toFixed(3) + ',' + tot.me.toFixed(3) + ',' + tot.co.toFixed(3) + ',' + tot.bl.toFixed(3) + ',' + tot.lf.toFixed(3) + ',' + tot.dv.toFixed(3) + ',' + ovr + '%\n';
    csv += '\nDiversion Rate: ' + ovr + '%\nLEED v5 (75%): ' + (parseFloat(ovr) >= 75 ? 'ACHIEVED' : 'NOT MET') + '\n';
    csv += '\nThis report represents a project-specific sort of commingled construction and demolition waste. All materials reported as diverted have been recycled or salvaged; no diverted tons include Alternative Daily Cover (ADC). Data processed via DivertScan AI Volumetric Analysis.\n';
    csv += '\n¬© 2024-2025 DivertScan‚Ñ¢\n';
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'LEED-' + currentProject.name.replace(/\s+/g, '-') + '-' + getCurrentDate() + '.csv';
    a.click();
    toast('Downloaded!', 'success');
}

// Utilities
function saveOpenAIKey() {
    const k = document.getElementById('openaiKeyInput').value;
    if (!k) { toast('Enter key', 'error'); return; }
    localStorage.setItem('divertscan_openai', k);
    toast('Saved!', 'success');
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }


// Report variables
let rptProj = null;
let rptTks = [];
const REPORT_FOOTER = 'This report represents a project-specific sort of commingled construction and demolition waste. All materials reported as diverted have been recycled or salvaged; no diverted tons include Alternative Daily Cover (ADC). Data processed via DivertScan AI Volumetric Analysis.';

// Report functions
async function loadReportList() {
    const el = document.getElementById('projectReportList');
    if (!projects.length) { el.innerHTML = '<div class="empty-state">No projects</div>'; return; }
    let html = '';
    // Batch fetch summaries for all projects at once
    const { data: allTks } = await sb.from('tickets').select('project_id, net_tons, diverted_tons');
    const tksByProj = {};
    (allTks || []).forEach(t => {
        if (!tksByProj[t.project_id]) tksByProj[t.project_id] = { count: 0, tons: 0, div: 0 };
        tksByProj[t.project_id].count++;
        tksByProj[t.project_id].tons += +t.net_tons || 0;
        tksByProj[t.project_id].div += +t.diverted_tons || 0;
    });
    for (const p of projects) {
        const s = tksByProj[p.id] || { count: 0, tons: 0, div: 0 };
        const rate = s.tons > 0 ? (s.div/s.tons*100) : 0;
        html += '<div class="project-card" onclick="openReport(\'' + p.id + '\')"><h3>' + p.name + '</h3><div class="meta">' + (p.address||'') + ' ‚Ä¢ ' + (p.waste_hauler||'') + '</div><div class="project-stats"><div class="project-stat"><div class="value">' + s.count + '</div><div class="label">Tickets</div></div><div class="project-stat"><div class="value">' + s.tons.toFixed(1) + '</div><div class="label">Tons</div></div><div class="project-stat"><div class="value" style="color:' + (rate>=75?'var(--emerald-400)':rate>=50?'var(--amber-400)':'var(--red-400)') + '">' + rate.toFixed(0) + '%</div><div class="label">Div</div></div><div class="project-stat"><div class="value">' + (rate>=75?'‚úì':'‚Äî') + '</div><div class="label">LEED</div></div></div><div style="text-align:center;font-size:12px;color:var(--emerald-400)">Tap for reports ‚Üí</div></div>';
    }
    el.innerHTML = html;
}

async function openReport(pid) {
    const p = projects.find(x => x.id === pid);
    if (!p) return;
    rptProj = p;
    const { data: tks } = await sb.from('tickets').select('*').eq('project_id', pid).order('service_date', {ascending:true});
    rptTks = tks || [];
    const tot = calcTotals(rptTks);
    document.getElementById('rptProjName').textContent = p.name;
    document.getElementById('rptMeta').innerHTML = (p.address ? '<strong>Address:</strong> ' + p.address + '<br>' : '') + (p.waste_hauler ? '<strong>Hauler:</strong> ' + p.waste_hauler + '<br>' : '') + '<strong>Generated:</strong> ' + new Date().toLocaleDateString();
    document.getElementById('rptStats').innerHTML = '<div class="project-stat"><div class="value">' + rptTks.length + '</div><div class="label">Tickets</div></div><div class="project-stat"><div class="value">' + tot.tons.toFixed(2) + '</div><div class="label">Tons</div></div><div class="project-stat"><div class="value">' + tot.div.toFixed(2) + '</div><div class="label">Diverted</div></div><div class="project-stat"><div class="value">' + tot.co2.toFixed(1) + '</div><div class="label">CO‚ÇÇe</div></div>';
    const rate = tot.rate;
    document.getElementById('rptDiv').textContent = rate.toFixed(1) + '%';
    document.getElementById('rptDiv').className = 'diversion-badge ' + (rate>=75?'good':rate>=50?'warning':'bad');
    document.getElementById('rptBar').style.width = Math.min(rate,100) + '%';
    document.getElementById('rptBar').className = 'progress-fill' + (rate>=75?'':rate>=50?' warning':' danger');
    document.getElementById('rptLeed').innerHTML = rate>=75 ? '<span style="color:var(--emerald-400)">‚úì LEED v5 Achieved</span>' : '<span style="color:var(--amber-400)">‚ö† Below 75%</span>';
    document.getElementById('rptCount').textContent = rptTks.length;
    document.getElementById('rptBody').innerHTML = rptTks.map(t => {
        const ph = t.debris_images ? (typeof t.debris_images === 'string' ? JSON.parse(t.debris_images) : t.debris_images) : [];
        return '<tr><td>' + formatDate(t.service_date) + '</td><td>' + (t.ticket_number||'-') + '</td><td class="num">' + (t.net_tons||0).toFixed(3) + '</td><td class="num">' + (t.diversion_pct||0) + '%</td><td>' + (ph.length>0?'üì∑'+ph.length:'-') + '</td></tr>';
    }).join('');
    document.getElementById('rptMats').innerHTML = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">' + MATERIAL_KEYS.map(k => {
        const tons = tot.mats[k] || 0;
        const pct = tot.tons > 0 ? (tons/tot.tons*100) : 0;
        return '<div style="display:flex;justify-content:space-between;padding:6px 8px;background:var(--slate-800);border-radius:4px"><span>' + MATERIALS[k].icon + ' ' + MATERIALS[k].name + '</span><span style="color:' + (k==='landfill'?'var(--red-400)':'var(--emerald-400)') + '">' + tons.toFixed(3) + ' T</span></div>';
    }).join('') + '</div>';
    openModal('reportModal');
}

function calcTotals(tks) {
    const tot = {tons:0, div:0, lf:0, co2:0, rate:0, mats:{}};
    MATERIAL_KEYS.forEach(k => tot.mats[k] = 0);
    for (const t of tks) {
        tot.tons += +t.net_tons || 0;
        tot.div += +t.diverted_tons || 0;
        tot.lf += +t.landfill_tons || 0;
        tot.co2 += +t.co2e_avoided || 0;
        MATERIAL_KEYS.forEach(k => tot.mats[k] += +t[k + '_tons'] || 0);
    }
    tot.rate = tot.tons > 0 ? (tot.div/tot.tons*100) : 0;
    return tot;
}


function exportPDF() {
    if (!rptProj || !rptTks.length) { DivertScan.toast('No data', 'error'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tot = calcTotals(rptTks);
    doc.setFontSize(20); doc.setTextColor(16,185,129);
    doc.text('LEED WASTE DIVERSION REPORT', 105, 20, {align:'center'});
    doc.setFontSize(10); doc.setTextColor(100);
    doc.text('DivertScan‚Ñ¢', 105, 27, {align:'center'});
    doc.setFontSize(12); doc.setTextColor(0);
    doc.text('Project: ' + rptProj.name, 14, 40);
    let y = 47;
    if (rptProj.address) { doc.text('Address: ' + rptProj.address, 14, y); y += 7; }
    if (rptProj.waste_hauler) { doc.text('Hauler: ' + rptProj.waste_hauler, 14, y); y += 7; }
    doc.text('Date: ' + new Date().toLocaleDateString(), 14, y); y += 15;
    doc.setFillColor(240,240,240); doc.rect(14, y, 182, 35, 'F');
    doc.setFontSize(10);
    doc.text('Generated: ' + tot.tons.toFixed(2) + ' tons', 20, y+10);
    doc.text('Diverted: ' + tot.div.toFixed(2) + ' tons', 20, y+18);
    doc.text('Landfill: ' + tot.lf.toFixed(2) + ' tons', 20, y+26);
    doc.text('Diversion: ' + tot.rate.toFixed(1) + '%', 110, y+10);
    doc.text('LEED Target: 75%', 110, y+18);
    doc.text('Status: ' + (tot.rate>=75?'ACHIEVED':'NOT MET'), 110, y+26);
    y += 45;
    doc.autoTable({startY:y, head:[['Material','Tons','%']], body:MATERIAL_KEYS.map(k=>[MATERIALS[k].name,(tot.mats[k]||0).toFixed(3),(tot.tons>0?(tot.mats[k]/tot.tons*100):0).toFixed(1)+'%']), theme:'striped', headStyles:{fillColor:[16,185,129]}});
    y = doc.lastAutoTable.finalY + 10;
    doc.autoTable({startY:y, head:[['Date','Ticket','Net(T)','Div%','Audit']], body:rptTks.map(t=>[formatDate(t.service_date),t.ticket_number||'-',(t.net_tons||0).toFixed(3),(t.diversion_pct||0)+'%',t.audit_id||'-']), theme:'striped', headStyles:{fillColor:[16,185,129]}, styles:{fontSize:8}});
    doc.setFontSize(8); doc.setTextColor(100);
    doc.text(REPORT_FOOTER.substring(0,90) + '...', 14, doc.internal.pageSize.height-15);
    doc.text('¬© 2024-2025 DivertScan‚Ñ¢', 14, doc.internal.pageSize.height-10);
    doc.save('LEED-' + rptProj.name.replace(/\s+/g,'-') + '.pdf');
    DivertScan.toast('PDF saved!', 'success');
}

function exportExcel() {
    if (!rptProj || !rptTks.length) { DivertScan.toast('No data', 'error'); return; }
    const tot = calcTotals(rptTks);
    const wb = XLSX.utils.book_new();
    const sum = [['LEED WASTE DIVERSION REPORT'],['Project:',rptProj.name],['Address:',rptProj.address||''],['Hauler:',rptProj.waste_hauler||''],['Date:',new Date().toLocaleDateString()],[],['Generated:',tot.tons.toFixed(3)],['Diverted:',tot.div.toFixed(3)],['Landfill:',tot.lf.toFixed(3)],['Diversion:',tot.rate.toFixed(1)+'%'],['LEED:',tot.rate>=75?'ACHIEVED':'NOT MET'],[],['MATERIALS']];
    MATERIAL_KEYS.forEach(k => sum.push([MATERIALS[k].name, (tot.mats[k]||0).toFixed(3)]));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sum), 'Summary');
    const th = ['Date','Ticket','Gross','Tare','Net(T)','Wood','Gypsum','Plastic','OCC','Metal','Concrete','Block','Landfill','Diverted','Div%','Audit'];
    const td = [th];
    rptTks.forEach(t => td.push([formatDate(t.service_date),t.ticket_number||'',t.gross_lbs||0,t.tare_lbs||0,(t.net_tons||0).toFixed(3),(t.wood_tons||0).toFixed(3),(t.gypsum_tons||0).toFixed(3),(t.plastic_tons||0).toFixed(3),(t.occ_tons||0).toFixed(3),(t.metal_tons||0).toFixed(3),(t.concrete_tons||0).toFixed(3),(t.block_tons||0).toFixed(3),(t.landfill_tons||0).toFixed(3),(t.diverted_tons||0).toFixed(3),(t.diversion_pct||0)+'%',t.audit_id||'']));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(td), 'Tickets');
    XLSX.writeFile(wb, 'LEED-' + rptProj.name.replace(/\s+/g,'-') + '.xlsx');
    DivertScan.toast('Excel saved!', 'success');
}

function exportCSV() {
    if (!rptProj || !rptTks.length) { DivertScan.toast('No data', 'error'); return; }
    const tot = calcTotals(rptTks);
    let csv = 'LEED REPORT\nProject:,' + rptProj.name + '\n';
    csv += 'Diversion:,' + tot.rate.toFixed(1) + '%\nLEED:,' + (tot.rate>=75?'ACHIEVED':'NOT MET') + '\n\n';
    csv += 'Date,Ticket,Net(T),Wood,Gypsum,Plastic,OCC,Metal,Concrete,Block,Landfill,Div%,Audit\n';
    rptTks.forEach(t => csv += [formatDate(t.service_date),t.ticket_number||'',(t.net_tons||0).toFixed(3),(t.wood_tons||0).toFixed(3),(t.gypsum_tons||0).toFixed(3),(t.plastic_tons||0).toFixed(3),(t.occ_tons||0).toFixed(3),(t.metal_tons||0).toFixed(3),(t.concrete_tons||0).toFixed(3),(t.block_tons||0).toFixed(3),(t.landfill_tons||0).toFixed(3),(t.diversion_pct||0)+'%',t.audit_id||''].join(',') + '\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'LEED-' + rptProj.name.replace(/\s+/g,'-') + '.csv'; a.click();
    DivertScan.toast('CSV saved!', 'success');
}

function exportAudit() {
    if (!rptProj || !rptTks.length) { DivertScan.toast('No data', 'error'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tot = calcTotals(rptTks);
    doc.setFontSize(18); doc.setTextColor(16,185,129);
    doc.text('AUDIT TRAIL REPORT', 105, 20, {align:'center'});
    doc.setFontSize(11); doc.setTextColor(0);
    doc.text('Project: ' + rptProj.name, 14, 35);
    doc.text('Audit Date: ' + new Date().toLocaleString(), 14, 42);
    doc.text('Tickets: ' + rptTks.length + ' | Tons: ' + tot.tons.toFixed(2) + ' | Div: ' + tot.rate.toFixed(1) + '%', 14, 52);
    let y = 65;
    for (let i = 0; i < rptTks.length && y < 270; i++) {
        const t = rptTks[i];
        const ph = t.debris_images ? (typeof t.debris_images === 'string' ? JSON.parse(t.debris_images) : t.debris_images) : [];
        doc.setFontSize(9);
        doc.text('#' + (t.ticket_number||'N/A') + ' | ' + formatDate(t.service_date) + ' | ' + (t.net_tons||0).toFixed(3) + 'T | ' + (t.diversion_pct||0) + '% | ' + ph.length + ' photo(s) | ' + (t.audit_id||''), 14, y);
        y += 8;
    }
    doc.setFontSize(8); doc.setTextColor(100);
    doc.text('Point-of-Capture verification. Photos stored in database.', 14, doc.internal.pageSize.height-15);
    doc.text('¬© 2024-2025 DivertScan‚Ñ¢', 14, doc.internal.pageSize.height-10);
    doc.save('Audit-' + rptProj.name.replace(/\s+/g,'-') + '.pdf');
    DivertScan.toast('Audit PDF saved!', 'success');
}

document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
