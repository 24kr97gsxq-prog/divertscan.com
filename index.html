<!DOCTYPE html>
<html lang="en">
<!-- ¬© 2024-2025 DivertScan‚Ñ¢. Confidential and Proprietary. -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan‚Ñ¢ v3.0</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôªÔ∏è</text></svg>">
    <style>
:root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--red-400:#f87171;--blue-500:#3b82f6}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--slate-900);color:var(--slate-300);min-height:100vh;padding-bottom:80px}
.header{background:var(--slate-800);padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700);position:sticky;top:0;z-index:100}
.logo{font-size:20px;font-weight:700;color:var(--emerald-400)}.logo span{color:var(--slate-400);font-weight:400;font-size:12px}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--slate-800);display:flex;justify-content:space-around;padding:8px 0 max(8px,env(safe-area-inset-bottom));border-top:1px solid var(--slate-700);z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 12px;color:var(--slate-500);font-size:10px;cursor:pointer}.nav-item.active{color:var(--emerald-400)}.nav-item svg{width:22px;height:22px;margin-bottom:3px}
.tab-content{display:none;padding:16px;max-width:600px;margin:0 auto}.tab-content.active{display:block}
.card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
.card-title{font-size:13px;color:var(--slate-400);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px;display:flex;justify-content:space-between;align-items:center}
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.stat-card{background:var(--slate-700);border-radius:8px;padding:12px;text-align:center}
.stat-value{font-size:22px;font-weight:700;color:var(--emerald-400)}.stat-label{font-size:10px;color:var(--slate-400);margin-top:4px;text-transform:uppercase}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all 0.2s;width:100%}
.btn-primary{background:var(--emerald-500);color:white}.btn-primary:hover{background:var(--emerald-400)}.btn-primary:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:var(--slate-700);color:var(--slate-300)}.btn-danger{background:var(--red-500);color:white}.btn-warning{background:var(--amber-500);color:var(--slate-900)}
.btn-sm{padding:8px 12px;font-size:12px}.btn-lg{padding:16px 24px;font-size:16px}
.form-group{margin-bottom:16px}.form-label{display:block;font-size:11px;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase}
.form-input{width:100%;padding:12px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-300);font-size:16px}.form-input:focus{outline:none;border-color:var(--emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.material-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.material-item{background:var(--slate-700);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center}
.material-name{font-size:11px;color:var(--slate-300)}.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:50px;padding:6px;background:var(--slate-800);border:1px solid var(--slate-600);border-radius:4px;color:var(--slate-300);font-size:14px;text-align:right}
.material-input span{color:var(--slate-500);font-size:12px}
.progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden;margin-top:8px}
.progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}.progress-fill.warning{background:var(--amber-500)}.progress-fill.danger{background:var(--red-500)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:200;align-items:flex-end;justify-content:center}.modal.active{display:flex}
.modal-content{background:var(--slate-800);width:100%;max-width:500px;max-height:90vh;border-radius:16px 16px 0 0;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:16px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center}
.modal-title{font-size:18px;font-weight:600;color:var(--slate-200)}.modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);cursor:pointer;font-size:20px}
.modal-body{padding:16px;overflow-y:auto;flex:1}.modal-footer{padding:16px;border-top:1px solid var(--slate-700);display:flex;gap:12px}
.steps{display:flex;justify-content:center;gap:8px;margin-bottom:20px}
.step{width:32px;height:32px;border-radius:50%;background:var(--slate-700);color:var(--slate-500);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
.step.active,.step.complete{background:var(--emerald-500);color:white}.step-line{width:32px;height:2px;background:var(--slate-700);align-self:center}.step-line.complete{background:var(--emerald-500)}
.image-preview{width:100%;aspect-ratio:4/3;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:14px;overflow:hidden;margin-bottom:12px;border:2px dashed var(--slate-600)}
.image-preview.filled{border:2px solid var(--emerald-500)}.image-preview img{width:100%;height:100%;object-fit:cover}
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.photo-slot{aspect-ratio:1;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:24px;cursor:pointer;overflow:hidden;border:2px dashed var(--slate-600);position:relative}
.photo-slot.filled{border:2px solid var(--emerald-500)}.photo-slot img{width:100%;height:100%;object-fit:cover}
.container-select{display:flex;gap:8px;margin-bottom:16px}
.container-option{flex:1;padding:12px;background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:20px;font-weight:700;color:var(--slate-200)}.container-option small{font-size:11px;color:var(--slate-400)}
.ticket-list{display:flex;flex-direction:column;gap:12px}
.ticket-item{background:var(--slate-700);border-radius:8px;padding:12px;cursor:pointer;transition:all 0.2s;border-left:4px solid var(--amber-500)}
.ticket-item:hover{background:var(--slate-600)}.ticket-item.closed{border-left-color:var(--emerald-500)}
.ticket-row{display:flex;justify-content:space-between;align-items:center}
.ticket-info h4{color:var(--slate-200);font-size:14px;margin-bottom:4px}.ticket-info p{color:var(--slate-400);font-size:12px}
.ticket-stats{text-align:right}.ticket-tons{font-size:18px;font-weight:700;color:var(--emerald-400)}.ticket-diversion{font-size:12px;color:var(--slate-400)}
.badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;text-transform:uppercase;margin-left:6px}
.badge-closed{background:var(--emerald-500);color:white}.badge-open{background:var(--amber-500);color:var(--slate-900)}.badge-edit{background:var(--blue-500);color:white}
.project-item{background:var(--slate-700);border-radius:8px;padding:12px;margin-bottom:12px;cursor:pointer}.project-item:hover{background:var(--slate-600)}
.project-item.selected{border:2px solid var(--emerald-500)}.project-item h4{color:var(--slate-200);font-size:14px;margin-bottom:4px}.project-item p{color:var(--slate-400);font-size:12px}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--slate-700);color:var(--slate-200);padding:12px 24px;border-radius:8px;font-size:14px;z-index:300;opacity:0;transition:all 0.3s;max-width:90%;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}.toast.success{background:var(--emerald-500);color:white}.toast.error{background:var(--red-500);color:white}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--slate-400)}
.spinner{width:40px;height:40px;border:3px solid var(--slate-700);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px}
@keyframes spin{to{transform:rotate(360deg)}}
.project-selector{background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.project-name{font-weight:600;color:var(--slate-200)}.project-hauler{font-size:11px;color:var(--slate-400)}.project-change{color:var(--emerald-400);font-size:12px}
.hidden{display:none!important}.empty-state{text-align:center;padding:40px 20px;color:var(--slate-500)}
.diversion-badge{font-size:28px;font-weight:700}.diversion-badge.good{color:var(--emerald-400)}.diversion-badge.warning{color:var(--amber-400)}.diversion-badge.bad{color:var(--red-400)}
.signature-container{background:var(--slate-700);border-radius:8px;padding:12px;margin:16px 0}
.signature-pad{width:100%;height:120px;background:white;border-radius:8px;touch-action:none;cursor:crosshair}
.signature-actions{display:flex;gap:8px;margin-top:8px}
.terms-text{font-size:11px;color:var(--slate-400);line-height:1.6;max-height:300px;overflow-y:auto;padding:12px;background:var(--slate-700);border-radius:8px}
.footer-text{text-align:center;font-size:10px;color:var(--slate-500);margin-top:20px;padding:12px}
    </style>
</head>
<body>
<header class="header"><div class="logo">DivertScan‚Ñ¢ <span>v3.0</span></div><button class="btn btn-secondary btn-sm" onclick="showTab('settings')" style="width:auto;padding:8px 12px;">‚öôÔ∏è</button></header>
<main>
<!-- Auth Screen -->
<div id="authScreen" class="tab-content active">
<div style="max-width:400px;margin:40px auto;padding:20px;">
<div style="text-align:center;margin-bottom:32px;"><div style="font-size:48px;margin-bottom:16px;">‚ôªÔ∏è</div><h1 style="font-size:24px;color:var(--emerald-400);margin-bottom:8px;">DivertScan‚Ñ¢</h1><p style="color:var(--slate-400);">LEED-Compliant Waste Tracking</p></div>
<div class="card">
<div class="form-group"><label class="form-label">Email</label><input type="email" id="authEmail" class="form-input" placeholder="you@company.com"></div>
<div class="form-group"><label class="form-label">Password</label><input type="password" id="authPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
<button class="btn btn-primary btn-lg" onclick="signIn()">Sign In</button>
<p style="text-align:center;margin-top:16px;font-size:12px;color:var(--slate-500);">No account? <a href="#" onclick="signUp();return false" style="color:var(--emerald-400);">Sign Up</a></p>
</div>
<p class="footer-text">¬© 2024-2025 DivertScan‚Ñ¢</p>
</div></div>

<!-- Dashboard -->
<div id="dashboardTab" class="tab-content">
<div class="project-selector" onclick="showProjectModal()">
<div><div style="font-size:10px;color:var(--slate-500);text-transform:uppercase;">Current Project</div><div class="project-name" id="currentProjectName">Select Project</div><div class="project-hauler" id="currentProjectHauler"></div></div>
<span class="project-change">Change ‚Üí</span>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-value" id="statTickets">0</div><div class="stat-label">Tickets</div></div>
<div class="stat-card"><div class="stat-value" id="statTons">0</div><div class="stat-label">Total Tons</div></div>
<div class="stat-card"><div class="stat-value" id="statDiversion">0%</div><div class="stat-label">Diversion</div></div>
<div class="stat-card"><div class="stat-value" id="statCO2">0</div><div class="stat-label">CO‚ÇÇe</div></div>
</div>
<div class="card" style="margin-top:16px;"><div class="card-title">LEED v5 Progress (75%)</div>
<div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="font-size:11px;color:var(--slate-400);">Current</span><span style="font-size:14px;font-weight:600;" id="leedProgress">0%</span></div>
<div class="progress-bar"><div class="progress-fill" id="leedProgressBar" style="width:0%"></div></div></div>
<button class="btn btn-primary btn-lg" style="margin-top:20px;" onclick="startNewTicket()">‚ûï New Ticket</button>
<div class="card" style="margin-top:20px;"><div class="card-title">Recent Tickets <span style="font-size:10px;color:var(--slate-500);font-weight:normal;">tap to edit</span></div>
<div class="ticket-list" id="ticketList"><div class="empty-state"><p>No tickets yet</p></div></div></div>
</div>

<!-- Projects Tab -->
<div id="projectsTab" class="tab-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><h2 style="font-size:18px;">Projects</h2><button class="btn btn-primary btn-sm" onclick="showNewProjectModal()" style="width:auto;">‚ûï New</button></div>
<div id="projectListFull"><div class="loading"><div class="spinner"></div><p>Loading...</p></div></div>
</div>

<!-- Tickets Tab -->
<div id="ticketsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:16px;">All Tickets</h2>
<div class="ticket-list" id="allTicketsList"><div class="loading"><div class="spinner"></div><p>Loading...</p></div></div>
</div>

<!-- Reports Tab -->
<div id="reportsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:16px;">LEED Reports</h2>
<div class="card"><div class="card-title">Export Project Report</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px;">Dalmex format: Date, Ticket No, GWT, Tare, Net, 7-stream breakdown</p>
<button class="btn btn-secondary" style="margin-bottom:8px;" onclick="exportAllTickets()">üìä All Tickets</button>
<button class="btn btn-primary" onclick="exportClosedTickets()">‚úÖ Finalized Only</button>
</div>
<div class="card"><div class="card-title">Certification</div>
<p style="font-size:10px;color:var(--slate-400);line-height:1.5;">Reports include legal certification: diverted materials not used for ADC. Processed via DivertScan‚Ñ¢ AI Volumetric Analysis.</p></div>
</div>

<!-- Settings Tab -->
<div id="settingsTab" class="tab-content">
<h2 style="font-size:18px;margin-bottom:16px;">Settings</h2>
<div class="card"><div class="card-title">OpenAI API Key</div>
<div class="form-group"><input type="password" id="openaiKeyInput" class="form-input" placeholder="sk-..."></div>
<button class="btn btn-primary" onclick="saveOpenAIKey()">Save Key</button></div>
<div class="card"><div class="card-title">Account</div>
<p style="font-size:14px;color:var(--slate-300);margin-bottom:8px;" id="userEmail">-</p>
<button class="btn btn-secondary" onclick="signOut()">Sign Out</button></div>
<p class="footer-text">¬© 2024-2025 DivertScan‚Ñ¢ v3.0<br>AI Volumetric Mass-Balance Methodology</p>
</div>
</main>

<nav class="nav">
<div class="nav-item active" onclick="showTab('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>Home</div>
<div class="nav-item" onclick="showTab('projects')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Projects</div>
<div class="nav-item" onclick="showTab('tickets')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16c0 1.1.9 2 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8"/></svg>Tickets</div>
<div class="nav-item" onclick="showTab('reports')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>Reports</div>
<div class="nav-item" onclick="showTab('settings')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72 1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>Settings</div>
</nav>
<div id="toast" class="toast"></div>

<!-- Ticket Modal (4 Steps: Scale, Photos, Review, Sign) -->
<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title" id="ticketModalTitle">New Ticket</div><button class="modal-close" onclick="closeModal('ticketModal')">√ó</button></div>
<div class="modal-body">
<div class="steps">
<div class="step active" id="step1">1</div><div class="step-line" id="stepLine1"></div>
<div class="step" id="step2">2</div><div class="step-line" id="stepLine2"></div>
<div class="step" id="step3">3</div><div class="step-line" id="stepLine3"></div>
<div class="step" id="step4">4</div>
</div>

<!-- Step 1: Scale Ticket -->
<div id="ticketStep1">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üìÑ Scale Ticket</h3>
<div class="image-preview" id="ticketImagePreview" onclick="uploadTicketPhoto()"><span>Tap to upload ticket</span></div>
<input type="file" id="ticketFileInput" accept="image/*" style="display:none;" onchange="handleTicketFile(event)">
<div class="form-group"><label class="form-label">Service Date</label><input type="date" id="serviceDate" class="form-input"></div>
<div class="form-group"><label class="form-label">Ticket #</label><input type="text" id="ticketNumber" class="form-input" placeholder="84600"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" id="grossLbs" class="form-input" placeholder="40620" oninput="updateWeights()"></div>
<div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" id="tareLbs" class="form-input" placeholder="34840" oninput="updateWeights()"></div>
</div>
<div class="form-group"><label class="form-label">Net Weight</label><div style="font-size:24px;font-weight:700;color:var(--emerald-400);" id="netWeightDisplay">0.00 tons</div></div>
<div class="form-group"><label class="form-label">Hauler</label><input type="text" id="haulerName" class="form-input" placeholder="Dalmex Recycling"></div>
<div id="ticketAnalyzing" class="loading hidden"><div class="spinner"></div><p>Analyzing ticket...</p></div>
</div>

<!-- Step 2: Debris Photos (1-3 batch) -->
<div id="ticketStep2" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center;">üì∏ Debris Photos (1-3)</h3>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yard</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yard</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yard</small></div>
</div>
<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div>
<div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div>
<div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>
</div>
<input type="file" id="debrisFileInput" accept="image/*" style="display:none;" onchange="handleDebrisFile(event)">
<p style="font-size:11px;color:var(--slate-400);text-align:center;margin-bottom:16px;">AI analyzes all photos for unified material breakdown</p>
<button class="btn btn-primary" id="analyzeDebrisBtn" onclick="analyzeDebris()" disabled>ü§ñ Analyze Materials</button>
<div id="debrisAnalyzing" class="loading hidden"><div class="spinner"></div><p>AI analyzing debris...</p></div>
</div>

<!-- Step 3: Review & Edit -->
<div id="ticketStep3" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center;">‚úèÔ∏è Review & Edit</h3>
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
<div><div style="font-size:11px;color:var(--slate-400);">Diversion Rate</div><div class="diversion-badge good" id="finalDiversionRate">0%</div></div>
<div style="text-align:right;"><div style="font-size:11px;color:var(--slate-400);">LEED v5</div><div style="font-size:14px;color:var(--slate-300);">75%</div></div>
</div>
<div class="progress-bar"><div class="progress-fill" id="finalProgressBar" style="width:0%"></div></div>
</div>
<div style="font-size:11px;color:var(--slate-400);margin:12px 0 8px;">MATERIALS (editable)</div>
<div class="material-grid" id="materialBreakdownEdit"></div>
<div style="margin-top:8px;font-size:12px;"><span style="color:var(--slate-400);">Total:</span> <span id="materialTotal" style="color:var(--emerald-400);font-weight:600;">100%</span></div>
<div class="card" style="margin-top:16px;">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px;">
<div><div style="color:var(--slate-500);">Ticket #</div><div style="color:var(--slate-200);" id="reviewTicketNum">-</div></div>
<div><div style="color:var(--slate-500);">Date</div><div style="color:var(--slate-200);" id="reviewDate">-</div></div>
<div><div style="color:var(--slate-500);">Net Weight</div><div style="color:var(--emerald-400);font-weight:700;" id="reviewNetTons">-</div></div>
<div><div style="color:var(--slate-500);">CO‚ÇÇe Avoided</div><div style="color:var(--slate-200);" id="reviewCO2">-</div></div>
</div></div>
</div>

<!-- Step 4: Signature & Closeout -->
<div id="ticketStep4" class="hidden">
<h3 style="font-size:16px;margin-bottom:16px;text-align:center;">‚úçÔ∏è Sign & Finalize</h3>
<div class="signature-container">
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px;">Sign below to certify this ticket</p>
<canvas id="signaturePad" class="signature-pad"></canvas>
<div class="signature-actions">
<button class="btn btn-secondary btn-sm" onclick="clearSignature()" style="flex:1;">Clear</button>
</div>
</div>
<div class="card">
<p style="font-size:10px;color:var(--slate-400);line-height:1.5;">By signing, I certify that: (1) The weights and material percentages are accurate to the best of my knowledge. (2) Diverted materials were recycled/salvaged and not used for ADC. (3) Data was processed via AI Volumetric Mass-Balance analysis.</p>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="prevStepBtn" onclick="prevStep()" style="flex:1;" disabled>Back</button>
<button class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" style="flex:1;">Next</button>
</div>
</div></div>

<!-- Edit Ticket Modal -->
<div id="editModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title">Edit Ticket <span class="badge badge-edit">EDIT</span></div><button class="modal-close" onclick="closeModal('editModal')">√ó</button></div>
<div class="modal-body">
<div id="editClosedWarning" class="hidden" style="background:var(--emerald-500);color:white;padding:12px;border-radius:8px;margin-bottom:16px;font-size:12px;">‚úÖ This ticket is finalized and cannot be edited.</div>
<div id="editFields">
<div class="form-group"><label class="form-label">Service Date</label><input type="date" id="editServiceDate" class="form-input"></div>
<div class="form-group"><label class="form-label">Ticket #</label><input type="text" id="editTicketNumber" class="form-input"></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" id="editGrossLbs" class="form-input" oninput="updateEditCalcs()"></div>
<div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" id="editTareLbs" class="form-input" oninput="updateEditCalcs()"></div>
</div>
<div class="form-group"><label class="form-label">Net Weight</label><div style="font-size:20px;font-weight:700;color:var(--emerald-400);" id="editNetDisplay">0.00 tons</div></div>
<div style="font-size:11px;color:var(--slate-400);margin:12px 0 8px;">MATERIAL %</div>
<div class="material-grid" id="editMaterialGrid"></div>
<div style="margin-top:8px;font-size:12px;"><span style="color:var(--slate-400);">Total:</span> <span id="editMaterialTotal">100%</span></div>
<div style="margin-top:16px;padding:12px;background:var(--slate-700);border-radius:8px;">
<div style="font-size:11px;color:var(--slate-400);">Diversion Rate</div>
<div style="font-size:20px;font-weight:700;" id="editDiversionRate">0%</div>
</div>
</div>
</div>
<div class="modal-footer" id="editFooter">
<button class="btn btn-danger" onclick="deleteCurrentTicket()" style="flex:1;">üóëÔ∏è Delete</button>
<button class="btn btn-primary" onclick="saveEditedTicket()" style="flex:1;">üíæ Save</button>
</div>
</div></div>

<!-- Project Modal -->
<div id="projectModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title">Select Project</div><button class="modal-close" onclick="closeModal('projectModal')">√ó</button></div>
<div class="modal-body">
<div id="projectList"><div class="loading"><div class="spinner"></div></div></div>
<button class="btn btn-primary" style="margin-top:16px;" onclick="showNewProjectModal()">‚ûï New Project</button>
</div></div></div>

<!-- New/Edit Project Modal -->
<div id="newProjectModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title" id="projectModalTitle">New Project</div><button class="modal-close" onclick="closeModal('newProjectModal')">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label class="form-label">Project Name *</label><input type="text" id="projectName" class="form-input" placeholder="Children's Hospital"></div>
<div class="form-group"><label class="form-label">Job Address</label><input type="text" id="projectAddress" class="form-input" placeholder="1234 Main St, Dallas TX"></div>
<div class="form-group"><label class="form-label">Waste Hauler</label><input type="text" id="projectHauler" class="form-input" placeholder="Dalmex Recycling"></div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('newProjectModal')" style="flex:1;">Cancel</button>
<button class="btn btn-primary" onclick="saveProject()" style="flex:1;">Save</button>
</div></div></div>

<!-- Terms Modal -->
<div id="termsModal" class="modal">
<div class="modal-content">
<div class="modal-header"><div class="modal-title">Terms of Service</div><button class="modal-close" onclick="closeModal('termsModal')">√ó</button></div>
<div class="modal-body">
<div class="terms-text">
<strong>DivertScan‚Ñ¢ Terms of Service</strong><br><br>
<strong>ACCURACY</strong><br>DivertScan‚Ñ¢ provides AI-driven estimations using Volumetric Mass-Balance methodology. The final responsibility for data accuracy lies with the user.<br><br>
<strong>AUDIT RIGHTS</strong><br>Users are encouraged to use the Edit Feature to correct any OCR or AI discrepancies before finalizing reports.<br><br>
<strong>OWNERSHIP</strong><br>The DivertScan‚Ñ¢ name, logo, and core logic are protected under copyright and trade secret laws. ¬© 2024-2025 DivertScan‚Ñ¢<br><br>
<strong>LEED COMPLIANCE</strong><br>This tool assists in LEED v4/v4.1/v5 documentation. DivertScan‚Ñ¢ confirms that reported diverted materials are not used for ADC (Alternative Daily Cover).<br><br>
<strong>METHODOLOGY</strong><br>AI analysis uses Volumetric Mass-Balance:<br>1. Volume % identified based on visual spread (1-foot rule)<br>2. Percentage multiplied by Certified Net Weight<br>3. Weight-of-Volume method - industry standard
</div>
</div>
<div class="modal-footer"><button class="btn btn-primary" onclick="closeModal('termsModal')">Close</button></div>
</div></div>

<script>
// ¬© 2024-2025 DivertScan‚Ñ¢. Confidential and Proprietary.
const DivertScan=(function(){'use strict';
const CONFIG={SUPABASE_URL:'https://cyvvlngtojagfoaitoog.supabase.co',SUPABASE_KEY:'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g',VERSION:'3.0.0',LEED_V5_TARGET:75,MAX_PHOTOS:3,
REPORT_FOOTER:'This report represents a project-specific sort of commingled construction and demolition waste. All materials reported as diverted have been recycled or salvaged; no diverted tons include Alternative Daily Cover (ADC). Data processed via DivertScan‚Ñ¢ AI Volumetric Analysis.'};
const MATERIALS={wood:{name:'Wood',icon:'ü™µ',recyclable:true,gwp:0.03},gypsum:{name:'Gypsum',icon:'üß±',recyclable:true,gwp:0.12},plastic:{name:'Plastic',icon:'‚ôªÔ∏è',recyclable:true,gwp:2.5},occ:{name:'OCC',icon:'üì¶',recyclable:true,gwp:0.94},metal:{name:'Metal',icon:'üî©',recyclable:true,gwp:1.85},concrete:{name:'Concrete',icon:'ü™®',recyclable:true,gwp:0.159},block:{name:'Block',icon:'üß±',recyclable:true,gwp:0.159},landfill:{name:'Landfill',icon:'üóëÔ∏è',recyclable:false,gwp:0.52}};
const MATERIAL_KEYS=['wood','gypsum','plastic','occ','metal','concrete','block','landfill'];
let state={supabase:null,user:null,currentProject:null,projects:[],editingTicketId:null,ticketSession:createEmpty(),signatureData:null,openaiKey:localStorage.getItem('divertscan_openai')||''};
function createEmpty(){return{id:null,ticketNumber:null,serviceDate:getCurrentDate(),grossLbs:null,tareLbs:null,netLbs:null,netTons:null,hauler:null,containerSize:30,scaleTicketImage:null,debrisImages:[],materialBreakdown:{},diversionRate:0,co2eAvoided:0,calculatedBreakdown:{},signature:null,signedAt:null,isClosed:false,closedAt:null};}
function toast(msg,type='info'){const el=document.getElementById('toast');if(!el)return;el.textContent=msg;el.className=`toast ${type} show`;setTimeout(()=>el.classList.remove('show'),3000);}
function getCurrentDate(){return new Date().toISOString().split('T')[0];}
function formatDate(d){if(!d)return'';const dt=new Date(d+'T00:00:00');return dt.toLocaleDateString('en-US',{month:'2-digit',day:'2-digit',year:'2-digit'});}
function formatDateDB(s){if(!s)return getCurrentDate();if(/^\d{4}-\d{2}-\d{2}$/.test(s))return s;const p=s.split('/');if(p.length===3){const y=p[2].length===2?'20'+p[2]:p[2];return`${y}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`;}return getCurrentDate();}
function calcNet(g,t){const gross=parseFloat(g)||0,tare=parseFloat(t)||0,net=Math.max(0,gross-tare);return{netLbs:net,netTons:net/2000};}
function calcMaterials(pcts,tons){const b={};let divPct=0,co2=0;for(const k of MATERIAL_KEYS){const p=parseFloat(pcts[k])||0,t=(p/100)*tons,m=MATERIALS[k];b[k]={pct:p,tons:t,co2e:t*(m?.gwp||0)};if(m?.recyclable&&k!=='landfill')divPct+=p;co2+=b[k].co2e;}return{breakdown:b,diversionRate:Math.round(divPct),co2e:co2};}
function validateTotal(pcts){let t=0;for(const k of MATERIAL_KEYS)t+=parseFloat(pcts[k])||0;return{total:Math.round(t),valid:Math.abs(t-100)<0.5};}
function recalc(){const s=state.ticketSession;if(s.grossLbs&&s.tareLbs){const n=calcNet(s.grossLbs,s.tareLbs);s.netLbs=n.netLbs;s.netTons=n.netTons;}if(Object.keys(s.materialBreakdown).length>0&&s.netTons){const r=calcMaterials(s.materialBreakdown,s.netTons);s.diversionRate=r.diversionRate;s.co2eAvoided=r.co2e;s.calculatedBreakdown=r.breakdown;}return s;}
function initSession(){state.ticketSession=createEmpty();state.editingTicketId=null;state.signatureData=null;return state.ticketSession;}
function loadForEdit(t){state.editingTicketId=t.id;state.ticketSession={id:t.id,ticketNumber:t.ticket_number,serviceDate:t.service_date||t.ticket_date||getCurrentDate(),grossLbs:t.gross_lbs,tareLbs:t.tare_lbs,netLbs:t.net_lbs,netTons:t.net_tons,hauler:t.hauler,containerSize:t.container_size||30,scaleTicketImage:t.scale_ticket_image,debrisImages:t.debris_images?(typeof t.debris_images==='string'?JSON.parse(t.debris_images):t.debris_images):[],materialBreakdown:{wood:t.wood_pct||0,gypsum:t.gypsum_pct||0,plastic:t.plastic_pct||0,occ:t.occ_pct||0,metal:t.metal_pct||0,concrete:t.concrete_pct||0,block:t.block_pct||0,landfill:t.landfill_pct||0},diversionRate:t.diversion_pct||0,co2eAvoided:t.co2e_avoided||0,calculatedBreakdown:{},signature:t.signature,signedAt:t.signed_at,isClosed:t.is_closed||false,closedAt:t.closed_at};recalc();return state.ticketSession;}
function updateSession(data){Object.assign(state.ticketSession,data);return recalc();}
function setMaterials(pcts){const n={};for(const k of MATERIAL_KEYS)n[k]=parseFloat(pcts[k])||0;state.ticketSession.materialBreakdown=n;return recalc();}
function getSession(){return{...state.ticketSession};}
function setSignature(data){state.signatureData=data;state.ticketSession.signature=data;state.ticketSession.signedAt=new Date().toISOString();return state.ticketSession;}
function closeout(){if(!state.ticketSession.signature)throw new Error('Signature required');state.ticketSession.isClosed=true;state.ticketSession.closedAt=new Date().toISOString();return state.ticketSession;}
async function analyzeTicket(img){const key=state.openaiKey;if(!key)throw new Error('OpenAI API key required');const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o',messages:[{role:'user',content:[{type:'text',text:'Extract from scale ticket. Return ONLY JSON: {"ticket_number":"string","date":"MM/DD/YY","hauler":"string","gross_lbs":number,"tare_lbs":number}'},{type:'image_url',image_url:{url:img}}]}],max_tokens:500})});const d=await r.json();if(d.error)throw new Error(d.error.message);const m=d.choices[0].message.content.match(/\{[\s\S]*\}/);if(!m)throw new Error('Parse failed');const res=JSON.parse(m[0]);updateSession({ticketNumber:res.ticket_number,serviceDate:res.date?formatDateDB(res.date):getCurrentDate(),grossLbs:res.gross_lbs,tareLbs:res.tare_lbs,hauler:res.hauler,scaleTicketImage:img});return res;}
async function analyzePhotos(imgs,size=30){const key=state.openaiKey;if(!key)throw new Error('OpenAI API key required');if(!imgs.length)throw new Error('Add at least one photo');const content=[{type:'text',text:`Analyze ${imgs.length} photo(s) of ${size}-yard C&D container. Volumetric Mass-Balance: estimate VOLUME % across ALL photos. Return ONLY JSON: {"wood":0-100,"gypsum":0-100,"plastic":0-100,"occ":0-100,"metal":0-100,"concrete":0-100,"block":0-100,"landfill":0-100} MUST total 100.`}];for(const img of imgs)content.push({type:'image_url',image_url:{url:img}});const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${key}`,'Content-Type':'application/json'},body:JSON.stringify({model:'gpt-4o',messages:[{role:'user',content}],max_tokens:500})});const d=await r.json();if(d.error)throw new Error(d.error.message);const m=d.choices[0].message.content.match(/\{[\s\S]*\}/);if(!m)throw new Error('Parse failed');const res=JSON.parse(m[0]);const pcts={};for(const k of MATERIAL_KEYS)pcts[k]=res[k]||0;state.ticketSession.debrisImages=[...imgs];setMaterials(pcts);return{pcts,photos:imgs.length};}
async function initSupabase(){if(state.supabase)return state.supabase;if(typeof supabase==='undefined'){await new Promise((res,rej)=>{const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';s.onload=res;s.onerror=rej;document.head.appendChild(s);});}state.supabase=supabase.createClient(CONFIG.SUPABASE_URL,CONFIG.SUPABASE_KEY);return state.supabase;}
async function createProject(data){await initSupabase();const{data:r,error}=await state.supabase.from('projects').insert([{user_id:state.user?.id,name:data.name,address:data.address||null,waste_hauler:data.wasteHauler||null}]).select().single();if(error)throw error;toast('Project created!','success');return r;}
async function updateProject(id,data){await initSupabase();const{data:r,error}=await state.supabase.from('projects').update({name:data.name,address:data.address,waste_hauler:data.wasteHauler}).eq('id',id).select().single();if(error)throw error;toast('Project updated!','success');return r;}
async function deleteProject(id){await initSupabase();const{error}=await state.supabase.from('projects').delete().eq('id',id);if(error)throw error;toast('Project deleted','success');}
async function loadProjects(){await initSupabase();const{data,error}=await state.supabase.from('projects').select('*').eq('user_id',state.user?.id).order('created_at',{ascending:false});if(error)throw error;state.projects=data||[];return state.projects;}
async function createTicket(pid){await initSupabase();const s=state.ticketSession,b=s.calculatedBreakdown||{};const data={project_id:pid||state.currentProject?.id,user_id:state.user?.id,ticket_number:s.ticketNumber,service_date:s.serviceDate||getCurrentDate(),ticket_date:s.serviceDate||getCurrentDate(),hauler:s.hauler||state.currentProject?.waste_hauler,container_size:s.containerSize,gross_lbs:s.grossLbs,tare_lbs:s.tareLbs,net_lbs:s.netLbs,net_tons:s.netTons,wood_pct:s.materialBreakdown.wood||0,gypsum_pct:s.materialBreakdown.gypsum||0,plastic_pct:s.materialBreakdown.plastic||0,occ_pct:s.materialBreakdown.occ||0,metal_pct:s.materialBreakdown.metal||0,concrete_pct:s.materialBreakdown.concrete||0,block_pct:s.materialBreakdown.block||0,landfill_pct:s.materialBreakdown.landfill||0,wood_tons:b.wood?.tons||0,gypsum_tons:b.gypsum?.tons||0,plastic_tons:b.plastic?.tons||0,occ_tons:b.occ?.tons||0,metal_tons:b.metal?.tons||0,concrete_tons:b.concrete?.tons||0,block_tons:b.block?.tons||0,landfill_tons:b.landfill?.tons||0,diversion_pct:s.diversionRate,diverted_tons:s.netTons?s.netTons*(s.diversionRate/100):0,co2e_avoided:s.co2eAvoided,scale_ticket_image:s.scaleTicketImage,debris_images:JSON.stringify(s.debrisImages||[]),signature:s.signature,signed_at:s.signedAt,is_closed:s.isClosed,closed_at:s.closedAt,audit_id:`DS-${Date.now()}`};const{data:r,error}=await state.supabase.from('tickets').insert([data]).select().single();if(error)throw error;toast('Ticket saved!','success');return r;}
async function updateTicket(tid){await initSupabase();const s=state.ticketSession,b=s.calculatedBreakdown||{};const data={ticket_number:s.ticketNumber,service_date:s.serviceDate,ticket_date:s.serviceDate,hauler:s.hauler,gross_lbs:s.grossLbs,tare_lbs:s.tareLbs,net_lbs:s.netLbs,net_tons:s.netTons,wood_pct:s.materialBreakdown.wood||0,gypsum_pct:s.materialBreakdown.gypsum||0,plastic_pct:s.materialBreakdown.plastic||0,occ_pct:s.materialBreakdown.occ||0,metal_pct:s.materialBreakdown.metal||0,concrete_pct:s.materialBreakdown.concrete||0,block_pct:s.materialBreakdown.block||0,landfill_pct:s.materialBreakdown.landfill||0,wood_tons:b.wood?.tons||0,gypsum_tons:b.gypsum?.tons||0,plastic_tons:b.plastic?.tons||0,occ_tons:b.occ?.tons||0,metal_tons:b.metal?.tons||0,concrete_tons:b.concrete?.tons||0,block_tons:b.block?.tons||0,landfill_tons:b.landfill?.tons||0,diversion_pct:s.diversionRate,diverted_tons:s.netTons?s.netTons*(s.diversionRate/100):0,co2e_avoided:s.co2eAvoided,signature:s.signature,signed_at:s.signedAt,is_closed:s.isClosed,closed_at:s.closedAt,last_modified:new Date().toISOString(),modified_by:state.user?.email};const{data:r,error}=await state.supabase.from('tickets').update(data).eq('id',tid).select().single();if(error)throw error;toast('Ticket updated!','success');return r;}
async function deleteTicket(tid){await initSupabase();const{error}=await state.supabase.from('tickets').delete().eq('id',tid);if(error)throw error;toast('Ticket deleted','success');}
async function saveTicket(pid){return state.editingTicketId?updateTicket(state.editingTicketId):createTicket(pid);}
async function loadTickets(pid,opts={}){await initSupabase();let q=state.supabase.from('tickets').select('*').eq('project_id',pid);if(opts.closedOnly)q=q.eq('is_closed',true);q=q.order('service_date',{ascending:false});const{data,error}=await q;if(error)throw error;return data||[];}
function genReport(tickets,proj){const h=['Date','Ticket No','Gross','Tare','Net (lbs)','Net (T)','Wood','Gypsum','Plastic','OCC','Metal','Concrete','Block','Landfill','Diverted','Div %'];let csv=`LEED WASTE DIVERSION REPORT\nProject: ${proj?.name||'Unknown'}\n`;if(proj?.address)csv+=`Address: ${proj.address}\n`;if(proj?.waste_hauler)csv+=`Hauler: ${proj.waste_hauler}\n`;csv+=`Generated: ${new Date().toLocaleDateString()}\n\n${h.join(',')}\n`;let tot={g:0,t:0,n:0,nt:0,w:0,gy:0,pl:0,oc:0,me:0,co:0,bl:0,lf:0,dv:0};for(const tk of tickets){csv+=[formatDate(tk.service_date),tk.ticket_number||'',tk.gross_lbs||0,tk.tare_lbs||0,tk.net_lbs||0,(tk.net_tons||0).toFixed(3),(tk.wood_tons||0).toFixed(3),(tk.gypsum_tons||0).toFixed(3),(tk.plastic_tons||0).toFixed(3),(tk.occ_tons||0).toFixed(3),(tk.metal_tons||0).toFixed(3),(tk.concrete_tons||0).toFixed(3),(tk.block_tons||0).toFixed(3),(tk.landfill_tons||0).toFixed(3),(tk.diverted_tons||0).toFixed(3),(tk.diversion_pct||0)+'%'].join(',')+'\n';tot.g+=+tk.gross_lbs||0;tot.t+=+tk.tare_lbs||0;tot.n+=+tk.net_lbs||0;tot.nt+=+tk.net_tons||0;tot.w+=+tk.wood_tons||0;tot.gy+=+tk.gypsum_tons||0;tot.pl+=+tk.plastic_tons||0;tot.oc+=+tk.occ_tons||0;tot.me+=+tk.metal_tons||0;tot.co+=+tk.concrete_tons||0;tot.bl+=+tk.block_tons||0;tot.lf+=+tk.landfill_tons||0;tot.dv+=+tk.diverted_tons||0;}const ovr=tot.nt>0?((tot.dv/tot.nt)*100).toFixed(1):'0';csv+=`\nTOTALS,${tickets.length},${tot.g},${tot.t},${tot.n},${tot.nt.toFixed(3)},${tot.w.toFixed(3)},${tot.gy.toFixed(3)},${tot.pl.toFixed(3)},${tot.oc.toFixed(3)},${tot.me.toFixed(3)},${tot.co.toFixed(3)},${tot.bl.toFixed(3)},${tot.lf.toFixed(3)},${tot.dv.toFixed(3)},${ovr}%\n`;csv+=`\nSUMMARY\nTotal Generated: ${tot.nt.toFixed(2)} tons\nDiverted: ${tot.dv.toFixed(2)} tons\nLandfill: ${tot.lf.toFixed(2)} tons\nDiversion Rate: ${ovr}%\nLEED v5 (75%): ${parseFloat(ovr)>=75?'ACHIEVED':'NOT MET'}\n`;csv+=`\nCERTIFICATION\n${CONFIG.REPORT_FOOTER}\n¬© 2024-2025 DivertScan‚Ñ¢`;return csv;}
function downloadCSV(csv,fn){const b=new Blob([csv],{type:'text/csv'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=fn||`DivertScan-Report-${getCurrentDate()}.csv`;a.click();URL.revokeObjectURL(u);}
return{CONFIG,MATERIALS,MATERIAL_KEYS,getState:()=>state,setState:(k,v)=>{state[k]=v;},setOpenAIKey:k=>{state.openaiKey=k;localStorage.setItem('divertscan_openai',k);},toast,getCurrentDate,formatDate,calcNet,calcMaterials,validateTotal,recalc,initSession,loadForEdit,updateSession,setMaterials,getSession,setSignature,closeout,analyzeTicket,analyzePhotos,initSupabase,createProject,updateProject,deleteProject,loadProjects,createTicket,updateTicket,deleteTicket,saveTicket,loadTickets,genReport,downloadCSV,version:CONFIG.VERSION};})();
window.DivertScan=DivertScan;
</script>

<script>
// ¬© 2024-2025 DivertScan‚Ñ¢ - App UI Logic
let currentStep=1,selectedContainer=30,debrisSlot=0,debrisPhotos=[null,null,null],currentEditTicket=null,editingProjectId=null,signatureCanvas=null,signatureCtx=null,isDrawing=false;

async function initialize(){try{await DivertScan.initSupabase();const sb=DivertScan.getState().supabase;const{data:{session}}=await sb.auth.getSession();if(session){DivertScan.setState('user',session.user);showApp();}sb.auth.onAuthStateChange((e,s)=>{if(s){DivertScan.setState('user',s.user);showApp();}else{DivertScan.setState('user',null);showAuth();}});}catch(e){console.error(e);DivertScan.toast('Init failed','error');}}

async function signIn(){const email=document.getElementById('authEmail').value,pw=document.getElementById('authPassword').value;if(!email||!pw){DivertScan.toast('Enter email & password','error');return;}try{const{error}=await DivertScan.getState().supabase.auth.signInWithPassword({email,password:pw});if(error)throw error;}catch(e){DivertScan.toast(e.message,'error');}}
async function signUp(){const email=document.getElementById('authEmail').value,pw=document.getElementById('authPassword').value;if(!email||!pw){DivertScan.toast('Enter email & password','error');return;}try{const{error}=await DivertScan.getState().supabase.auth.signUp({email,password:pw});if(error)throw error;DivertScan.toast('Check email to confirm','success');}catch(e){DivertScan.toast(e.message,'error');}}
async function signOut(){await DivertScan.getState().supabase.auth.signOut();showAuth();}
function showAuth(){document.getElementById('authScreen').classList.add('active');document.getElementById('dashboardTab').classList.remove('active');document.querySelector('.nav').style.display='none';}
function showApp(){document.getElementById('authScreen').classList.remove('active');document.querySelector('.nav').style.display='flex';document.getElementById('userEmail').textContent=DivertScan.getState().user?.email||'-';document.getElementById('openaiKeyInput').value=DivertScan.getState().openaiKey||'';loadProjectsAndData();showTab('dashboard');}

function showTab(tab){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.getElementById(tab+'Tab').classList.add('active');const idx=['dashboard','projects','tickets','reports','settings'].indexOf(tab);if(idx>=0)document.querySelectorAll('.nav-item')[idx].classList.add('active');if(tab==='projects')loadProjectListFull();if(tab==='tickets')loadAllTickets();}

async function loadProjectsAndData(){try{const projects=await DivertScan.loadProjects();if(projects?.length>0){DivertScan.setState('currentProject',projects[0]);document.getElementById('currentProjectName').textContent=projects[0].name;document.getElementById('currentProjectHauler').textContent=projects[0].waste_hauler||'';await loadDashboard();}else{document.getElementById('currentProjectName').textContent='Create Project ‚Üí';}}catch(e){console.error(e);}}

async function loadDashboard(){const proj=DivertScan.getState().currentProject;if(!proj)return;try{const tickets=await DivertScan.loadTickets(proj.id);const total=tickets.length,tons=tickets.reduce((s,t)=>s+(+t.net_tons||0),0),diverted=tickets.reduce((s,t)=>s+(+t.diverted_tons||0),0),avgDiv=tons>0?(diverted/tons*100):0,co2=tickets.reduce((s,t)=>s+(+t.co2e_avoided||0),0);document.getElementById('statTickets').textContent=total;document.getElementById('statTons').textContent=tons.toFixed(2);document.getElementById('statDiversion').textContent=avgDiv.toFixed(0)+'%';document.getElementById('statCO2').textContent=co2.toFixed(1);document.getElementById('leedProgress').textContent=avgDiv.toFixed(0)+'%';const bar=document.getElementById('leedProgressBar');bar.style.width=Math.min(avgDiv,100)+'%';bar.className='progress-fill'+(avgDiv>=75?'':avgDiv>=50?' warning':' danger');renderTickets(tickets.slice(0,8),'ticketList');}catch(e){console.error(e);}}

async function loadAllTickets(){const proj=DivertScan.getState().currentProject;if(!proj)return;try{const tickets=await DivertScan.loadTickets(proj.id);renderTickets(tickets,'allTicketsList');}catch(e){console.error(e);}}

function renderTickets(tickets,containerId){const list=document.getElementById(containerId);if(!tickets.length){list.innerHTML='<div class="empty-state"><p>No tickets</p></div>';return;}list.innerHTML=tickets.map(t=>`<div class="ticket-item ${t.is_closed?'closed':''}" onclick="openEditTicket('${t.id}')"><div class="ticket-row"><div class="ticket-info"><h4>#${t.ticket_number||'N/A'}${t.is_closed?'<span class="badge badge-closed">CLOSED</span>':'<span class="badge badge-open">OPEN</span>'}</h4><p>${DivertScan.formatDate(t.service_date)} ‚Ä¢ ${t.hauler||'Unknown'}</p></div><div class="ticket-stats"><div class="ticket-tons">${(t.net_tons||0).toFixed(2)}T</div><div class="ticket-diversion">${t.diversion_pct||0}%</div></div></div></div>`).join('');}

// Project Management
function showProjectModal(){openModal('projectModal');loadProjectList();}
async function loadProjectList(){const projects=await DivertScan.loadProjects();const list=document.getElementById('projectList');if(!projects?.length){list.innerHTML='<div class="empty-state"><p>No projects</p></div>';return;}list.innerHTML=projects.map(p=>`<div class="project-item ${DivertScan.getState().currentProject?.id===p.id?'selected':''}" onclick="selectProject('${p.id}')"><h4>${p.name}</h4><p>${p.address||'No address'}</p><p style="color:var(--emerald-400);font-size:11px;">${p.waste_hauler||''}</p></div>`).join('');}
async function loadProjectListFull(){const projects=await DivertScan.loadProjects();const list=document.getElementById('projectListFull');if(!projects?.length){list.innerHTML='<div class="empty-state"><p>No projects yet</p></div>';return;}list.innerHTML=projects.map(p=>`<div class="project-item"><h4>${p.name}</h4><p>${p.address||'No address'}</p><p style="color:var(--emerald-400);font-size:11px;">${p.waste_hauler||'No hauler assigned'}</p><div style="display:flex;gap:8px;margin-top:8px;"><button class="btn btn-secondary btn-sm" onclick="editProject('${p.id}');event.stopPropagation();" style="flex:1;">‚úèÔ∏è Edit</button><button class="btn btn-danger btn-sm" onclick="confirmDeleteProject('${p.id}');event.stopPropagation();" style="flex:1;">üóëÔ∏è</button></div></div>`).join('');}
function selectProject(id){const proj=DivertScan.getState().projects.find(p=>p.id===id);if(proj){DivertScan.setState('currentProject',proj);document.getElementById('currentProjectName').textContent=proj.name;document.getElementById('currentProjectHauler').textContent=proj.waste_hauler||'';closeModal('projectModal');loadDashboard();}}
function showNewProjectModal(){editingProjectId=null;document.getElementById('projectModalTitle').textContent='New Project';document.getElementById('projectName').value='';document.getElementById('projectAddress').value='';document.getElementById('projectHauler').value='';closeModal('projectModal');openModal('newProjectModal');}
async function editProject(id){const proj=DivertScan.getState().projects.find(p=>p.id===id);if(!proj)return;editingProjectId=id;document.getElementById('projectModalTitle').textContent='Edit Project';document.getElementById('projectName').value=proj.name||'';document.getElementById('projectAddress').value=proj.address||'';document.getElementById('projectHauler').value=proj.waste_hauler||'';openModal('newProjectModal');}
async function saveProject(){const name=document.getElementById('projectName').value.trim();if(!name){DivertScan.toast('Enter project name','error');return;}const data={name,address:document.getElementById('projectAddress').value.trim(),wasteHauler:document.getElementById('projectHauler').value.trim()};try{if(editingProjectId){await DivertScan.updateProject(editingProjectId,data);}else{const p=await DivertScan.createProject(data);selectProject(p.id);}closeModal('newProjectModal');loadProjectListFull();}catch(e){DivertScan.toast(e.message,'error');}}
async function confirmDeleteProject(id){if(!confirm('Delete this project?'))return;try{await DivertScan.deleteProject(id);loadProjectListFull();}catch(e){DivertScan.toast(e.message,'error');}}

// New Ticket Flow (4 steps)
function startNewTicket(){const proj=DivertScan.getState().currentProject;if(!proj){DivertScan.toast('Select project first','error');return;}DivertScan.initSession();currentStep=1;debrisPhotos=[null,null,null];document.getElementById('ticketModalTitle').textContent='New Ticket';document.getElementById('ticketImagePreview').innerHTML='<span>Tap to upload ticket</span>';document.getElementById('ticketImagePreview').classList.remove('filled');document.getElementById('serviceDate').value=DivertScan.getCurrentDate();document.getElementById('ticketNumber').value='';document.getElementById('grossLbs').value='';document.getElementById('tareLbs').value='';document.getElementById('netWeightDisplay').textContent='0.00 tons';document.getElementById('haulerName').value=proj.waste_hauler||'';DivertScan.updateSession({hauler:proj.waste_hauler||''});showStep(1);resetDebrisGrid();initSignaturePad();openModal('ticketModal');}

function showStep(step){currentStep=step;for(let i=1;i<=4;i++){document.getElementById('ticketStep'+i).classList.toggle('hidden',i!==step);document.getElementById('step'+i).className='step'+(i<step?' complete':i===step?' active':'');}for(let i=1;i<=3;i++)document.getElementById('stepLine'+i).className='step-line'+(step>i?' complete':'');document.getElementById('prevStepBtn').disabled=step===1;document.getElementById('nextStepBtn').textContent=step===4?'‚úÖ Finalize':'Next';if(step===3)populateReview();if(step===4)setupSignaturePad();}
function nextStep(){if(currentStep===4){finalizeTicket();return;}const s=DivertScan.getSession();if(currentStep===1&&(!s.grossLbs||!s.tareLbs)){DivertScan.toast('Enter weights','error');return;}if(currentStep===2&&s.diversionRate===0){DivertScan.toast('Analyze photos first','error');return;}showStep(currentStep+1);}
function prevStep(){if(currentStep>1)showStep(currentStep-1);}

// Step 1: Scale Ticket
function uploadTicketPhoto(){document.getElementById('ticketFileInput').click();}
async function handleTicketFile(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=async(ev)=>{const img=ev.target.result;document.getElementById('ticketImagePreview').innerHTML=`<img src="${img}">`;document.getElementById('ticketImagePreview').classList.add('filled');document.getElementById('ticketAnalyzing').classList.remove('hidden');try{await DivertScan.analyzeTicket(img);const s=DivertScan.getSession();document.getElementById('ticketNumber').value=s.ticketNumber||'';document.getElementById('serviceDate').value=s.serviceDate||DivertScan.getCurrentDate();document.getElementById('grossLbs').value=s.grossLbs||'';document.getElementById('tareLbs').value=s.tareLbs||'';document.getElementById('haulerName').value=s.hauler||'';updateWeights();DivertScan.toast('Ticket analyzed!','success');}catch(err){DivertScan.toast(err.message,'error');}finally{document.getElementById('ticketAnalyzing').classList.add('hidden');}};reader.readAsDataURL(file);}
function updateWeights(){const g=parseFloat(document.getElementById('grossLbs').value)||0,t=parseFloat(document.getElementById('tareLbs').value)||0;DivertScan.updateSession({grossLbs:g,tareLbs:t,serviceDate:document.getElementById('serviceDate').value,ticketNumber:document.getElementById('ticketNumber').value,hauler:document.getElementById('haulerName').value});const s=DivertScan.getSession();document.getElementById('netWeightDisplay').textContent=(s.netTons||0).toFixed(2)+' tons';}

// Step 2: Debris Photos (Batch 1-3)
function selectContainer(size){selectedContainer=size;DivertScan.updateSession({containerSize:size});document.querySelectorAll('.container-option').forEach(o=>o.classList.toggle('selected',o.querySelector('span').textContent==size));}
function resetDebrisGrid(){document.getElementById('debrisPhotoGrid').innerHTML='<div class="photo-slot" onclick="addDebrisPhoto(0)">‚ûï</div><div class="photo-slot" onclick="addDebrisPhoto(1)">‚ûï</div><div class="photo-slot" onclick="addDebrisPhoto(2)">‚ûï</div>';document.getElementById('analyzeDebrisBtn').disabled=true;}
function addDebrisPhoto(slot){debrisSlot=slot;document.getElementById('debrisFileInput').click();}
function handleDebrisFile(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=(ev)=>{debrisPhotos[debrisSlot]=ev.target.result;updateDebrisGrid();};reader.readAsDataURL(file);}
function updateDebrisGrid(){const grid=document.getElementById('debrisPhotoGrid');grid.innerHTML=debrisPhotos.map((p,i)=>p?`<div class="photo-slot filled" onclick="addDebrisPhoto(${i})"><img src="${p}"></div>`:`<div class="photo-slot" onclick="addDebrisPhoto(${i})">‚ûï</div>`).join('');document.getElementById('analyzeDebrisBtn').disabled=!debrisPhotos.some(p=>p);}
async function analyzeDebris(){const photos=debrisPhotos.filter(p=>p);if(!photos.length){DivertScan.toast('Add at least 1 photo','error');return;}document.getElementById('debrisAnalyzing').classList.remove('hidden');document.getElementById('analyzeDebrisBtn').disabled=true;try{await DivertScan.analyzePhotos(photos,selectedContainer);const s=DivertScan.getSession();DivertScan.toast(`${s.diversionRate}% diversion`,'success');showStep(3);}catch(err){DivertScan.toast(err.message,'error');document.getElementById('analyzeDebrisBtn').disabled=false;}finally{document.getElementById('debrisAnalyzing').classList.add('hidden');}}

// Step 3: Review
function populateReview(){const s=DivertScan.getSession(),d=s.diversionRate||0;const badge=document.getElementById('finalDiversionRate');badge.textContent=d+'%';badge.className='diversion-badge '+(d>=75?'good':d>=50?'warning':'bad');const bar=document.getElementById('finalProgressBar');bar.style.width=Math.min(d,100)+'%';bar.className='progress-fill'+(d>=75?'':d>=50?' warning':' danger');const grid=document.getElementById('materialBreakdownEdit');grid.innerHTML=DivertScan.MATERIAL_KEYS.map(k=>{const m=DivertScan.MATERIALS[k],p=s.materialBreakdown[k]||0;return`<div class="material-item"><div class="material-name">${m.icon} ${m.name}</div><div class="material-input"><input type="number" id="mat_${k}" value="${p}" min="0" max="100" onchange="updateMatPct('${k}')"><span>%</span></div></div>`;}).join('');updateMatTotal();document.getElementById('reviewTicketNum').textContent=s.ticketNumber||'-';document.getElementById('reviewDate').textContent=DivertScan.formatDate(s.serviceDate)||'-';document.getElementById('reviewNetTons').textContent=(s.netTons||0).toFixed(2)+' T';document.getElementById('reviewCO2').textContent=(s.co2eAvoided||0).toFixed(2)+' MT';}
function updateMatPct(k){const v=parseFloat(document.getElementById('mat_'+k).value)||0;const s=DivertScan.getSession();s.materialBreakdown[k]=v;DivertScan.setMaterials(s.materialBreakdown);updateMatTotal();const newS=DivertScan.getSession();document.getElementById('finalDiversionRate').textContent=newS.diversionRate+'%';document.getElementById('reviewCO2').textContent=(newS.co2eAvoided||0).toFixed(2)+' MT';}
function updateMatTotal(){const v=DivertScan.validateTotal(DivertScan.getSession().materialBreakdown);const el=document.getElementById('materialTotal');el.textContent=v.total+'%';el.style.color=v.valid?'var(--emerald-400)':'var(--red-400)';}

// Step 4: Signature
function initSignaturePad(){signatureCanvas=document.getElementById('signaturePad');if(!signatureCanvas)return;signatureCtx=signatureCanvas.getContext('2d');signatureCanvas.width=signatureCanvas.offsetWidth;signatureCanvas.height=signatureCanvas.offsetHeight;}
function setupSignaturePad(){if(!signatureCanvas)initSignaturePad();if(!signatureCanvas)return;signatureCtx.fillStyle='white';signatureCtx.fillRect(0,0,signatureCanvas.width,signatureCanvas.height);signatureCtx.strokeStyle='#000';signatureCtx.lineWidth=2;signatureCtx.lineCap='round';signatureCanvas.onpointerdown=startDraw;signatureCanvas.onpointermove=draw;signatureCanvas.onpointerup=endDraw;signatureCanvas.onpointerleave=endDraw;}
function startDraw(e){isDrawing=true;signatureCtx.beginPath();signatureCtx.moveTo(e.offsetX,e.offsetY);}
function draw(e){if(!isDrawing)return;signatureCtx.lineTo(e.offsetX,e.offsetY);signatureCtx.stroke();}
function endDraw(){isDrawing=false;}
function clearSignature(){if(signatureCtx&&signatureCanvas){signatureCtx.fillStyle='white';signatureCtx.fillRect(0,0,signatureCanvas.width,signatureCanvas.height);}}

async function finalizeTicket(){if(!signatureCanvas)return;const imgData=signatureCanvas.toDataURL('image/png');DivertScan.setSignature(imgData);try{DivertScan.closeout();const proj=DivertScan.getState().currentProject;await DivertScan.saveTicket(proj.id);closeModal('ticketModal');DivertScan.toast('Ticket finalized!','success');loadDashboard();}catch(err){DivertScan.toast(err.message,'error');}}

// Edit Ticket
async function openEditTicket(id){try{const sb=DivertScan.getState().supabase;const{data:t,error}=await sb.from('tickets').select('*').eq('id',id).single();if(error)throw error;currentEditTicket=t;DivertScan.loadForEdit(t);const s=DivertScan.getSession();const closed=s.isClosed;document.getElementById('editClosedWarning').classList.toggle('hidden',!closed);document.getElementById('editFields').style.opacity=closed?'0.5':'1';document.getElementById('editFields').style.pointerEvents=closed?'none':'auto';document.getElementById('editFooter').style.display=closed?'none':'flex';document.getElementById('editServiceDate').value=s.serviceDate||'';document.getElementById('editTicketNumber').value=s.ticketNumber||'';document.getElementById('editGrossLbs').value=s.grossLbs||'';document.getElementById('editTareLbs').value=s.tareLbs||'';document.getElementById('editNetDisplay').textContent=(s.netTons||0).toFixed(2)+' tons';const grid=document.getElementById('editMaterialGrid');grid.innerHTML=DivertScan.MATERIAL_KEYS.map(k=>{const m=DivertScan.MATERIALS[k],p=s.materialBreakdown[k]||0;return`<div class="material-item"><div class="material-name">${m.icon} ${m.name}</div><div class="material-input"><input type="number" id="edit_${k}" value="${p}" min="0" max="100" onchange="updateEditCalcs()"><span>%</span></div></div>`;}).join('');updateEditCalcs();openModal('editModal');}catch(e){DivertScan.toast('Load failed','error');}}
function updateEditCalcs(){const pcts={};DivertScan.MATERIAL_KEYS.forEach(k=>{pcts[k]=parseFloat(document.getElementById('edit_'+k).value)||0;});DivertScan.setMaterials(pcts);const g=parseFloat(document.getElementById('editGrossLbs').value)||0,t=parseFloat(document.getElementById('editTareLbs').value)||0;DivertScan.updateSession({serviceDate:document.getElementById('editServiceDate').value,ticketNumber:document.getElementById('editTicketNumber').value,grossLbs:g,tareLbs:t});const s=DivertScan.getSession();document.getElementById('editNetDisplay').textContent=(s.netTons||0).toFixed(2)+' tons';const v=DivertScan.validateTotal(s.materialBreakdown);document.getElementById('editMaterialTotal').textContent=v.total+'%';document.getElementById('editMaterialTotal').style.color=v.valid?'var(--emerald-400)':'var(--red-400)';document.getElementById('editDiversionRate').textContent=s.diversionRate+'%';document.getElementById('editDiversionRate').style.color=s.diversionRate>=75?'var(--emerald-400)':s.diversionRate>=50?'var(--amber-400)':'var(--red-400)';}
async function saveEditedTicket(){if(!DivertScan.validateTotal(DivertScan.getSession().materialBreakdown).valid){DivertScan.toast('Materials must = 100%','error');return;}try{await DivertScan.updateTicket(currentEditTicket.id);closeModal('editModal');loadDashboard();loadAllTickets();}catch(e){DivertScan.toast(e.message,'error');}}
async function deleteCurrentTicket(){if(!confirm('Delete this ticket?'))return;try{await DivertScan.deleteTicket(currentEditTicket.id);closeModal('editModal');loadDashboard();loadAllTickets();}catch(e){DivertScan.toast(e.message,'error');}}

// Reports
async function exportAllTickets(){const proj=DivertScan.getState().currentProject;if(!proj){DivertScan.toast('Select project','error');return;}try{const tickets=await DivertScan.loadTickets(proj.id);if(!tickets.length){DivertScan.toast('No tickets','error');return;}const csv=DivertScan.genReport(tickets,proj);DivertScan.downloadCSV(csv,`LEED-${proj.name.replace(/\s+/g,'-')}-${DivertScan.getCurrentDate()}.csv`);DivertScan.toast('Report downloaded!','success');}catch(e){DivertScan.toast(e.message,'error');}}
async function exportClosedTickets(){const proj=DivertScan.getState().currentProject;if(!proj){DivertScan.toast('Select project','error');return;}try{const tickets=await DivertScan.loadTickets(proj.id,{closedOnly:true});if(!tickets.length){DivertScan.toast('No finalized tickets','error');return;}const csv=DivertScan.genReport(tickets,proj);DivertScan.downloadCSV(csv,`LEED-Finalized-${proj.name.replace(/\s+/g,'-')}-${DivertScan.getCurrentDate()}.csv`);DivertScan.toast('Report downloaded!','success');}catch(e){DivertScan.toast(e.message,'error');}}

// Settings
function saveOpenAIKey(){const k=document.getElementById('openaiKeyInput').value;if(!k){DivertScan.toast('Enter key','error');return;}DivertScan.setOpenAIKey(k);DivertScan.toast('Key saved!','success');}

// Modals
function openModal(id){document.getElementById(id).classList.add('active');}
function closeModal(id){document.getElementById(id).classList.remove('active');}
function showTermsModal(){openModal('termsModal');}

document.addEventListener('DOMContentLoaded',initialize);
</script>
</body>
</html>
