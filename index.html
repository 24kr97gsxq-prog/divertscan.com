<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DivertScan">
<meta name="robots" content="noindex,nofollow">
<meta name="author" content="DivertScanâ„¢">
<meta name="copyright" content="Â© 2026 DivertScanâ„¢. All Rights Reserved.">
<title>DivertScanâ„¢ v7.5 â€” LEED Waste Tracking</title>
<link rel="manifest" href="manifest.json">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
:root {
--bg-primary:#0f1117;--bg-secondary:#1a1d27;--bg-tertiary:#252836;--bg-card:#1e2130;
--text-primary:#f0f0f5;--text-secondary:#a0a3b5;--text-muted:#6b6f82;
--accent-primary:#10b981;--accent-secondary:#3b82f6;--accent-warning:#f59e0b;
--accent-danger:#ef4444;--accent-info:#06b6d4;--accent-purple:#8b5cf6;
--border:#2d3045;--radius:12px;--radius-sm:8px;--radius-lg:16px;
--shadow:0 4px 24px rgba(0,0,0,.3);--shadow-lg:0 8px 40px rgba(0,0,0,.5);
--transition:all .2s ease;
}
[data-theme="ocean"]{--accent-primary:#00d4aa;--accent-secondary:#00b4d8;--bg-primary:#0a1628;--bg-secondary:#0f1f38;--bg-tertiary:#162a4a;--bg-card:#0f1f38;--border:#1e3a5f}
[data-theme="sunset"]{--accent-primary:#ff6b6b;--accent-secondary:#ffa500;--bg-primary:#1a0f0f;--bg-secondary:#271717;--bg-tertiary:#351f1f;--bg-card:#271717;--border:#4a2828}
[data-theme="forest"]{--accent-primary:#4ade80;--accent-secondary:#86efac;--bg-primary:#0a160a;--bg-secondary:#0f200f;--bg-tertiary:#162916;--bg-card:#0f200f;--border:#1e3a1e}
[data-theme="night"]{--accent-primary:#a78bfa;--accent-secondary:#818cf8;--bg-primary:#0f0a1a;--bg-secondary:#170f27;--bg-tertiary:#1f1535;--bg-card:#170f27;--border:#2d1f4a}
[data-theme="light"]{--bg-primary:#f8fafc;--bg-secondary:#ffffff;--bg-tertiary:#f1f5f9;--bg-card:#ffffff;--text-primary:#1e293b;--text-secondary:#475569;--text-muted:#94a3b8;--border:#e2e8f0;--shadow:0 4px 24px rgba(0,0,0,.08);--accent-primary:#059669;--accent-secondary:#2563eb}
[data-theme="jaguar"]{--accent-primary:#c9a227;--accent-secondary:#8b6914;--bg-primary:#1a1510;--bg-secondary:#272015;--bg-tertiary:#352a1c;--bg-card:#272015;--border:#4a3d28}

*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-primary);color:var(--text-primary);-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}

/* Login Screen */
.login-screen{position:fixed;inset:0;background:var(--bg-primary);z-index:9999;display:flex;align-items:center;justify-content:center}
.login-box{width:90%;max-width:380px;padding:40px 32px;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);text-align:center;box-shadow:var(--shadow-lg)}
.login-logo{font-size:48px;margin-bottom:8px}
.login-title{font-size:22px;font-weight:700;margin-bottom:4px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.login-subtitle{font-size:12px;color:var(--text-muted);margin-bottom:28px}
.login-error{color:var(--accent-danger);font-size:12px;margin-top:12px;min-height:18px}

/* App Shell */
.app{display:none;height:100vh;flex-direction:column}
.app.active{display:flex}

/* Header */
.header{background:var(--bg-secondary);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:100}
.header-left{display:flex;align-items:center;gap:10px}
.header-brand{font-size:15px;font-weight:700;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-project{font-size:11px;color:var(--text-muted);max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.header-right{display:flex;align-items:center;gap:8px}
.header-badge{background:var(--accent-primary);color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:12px}
.header-btn{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-secondary);padding:8px 10px;border-radius:var(--radius-sm);font-size:12px;cursor:pointer;transition:var(--transition)}
.header-btn:active{transform:scale(.95);background:var(--bg-primary)}

/* Content Area */
.content{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;padding-bottom:90px}

/* Bottom Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border);display:flex;padding:8px 8px calc(8px + env(safe-area-inset-bottom));z-index:100}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 0;cursor:pointer;transition:var(--transition);border-radius:var(--radius-sm)}
.nav-item.active{background:rgba(16,185,129,.1)}
.nav-item.active .nav-icon{color:var(--accent-primary)}
.nav-item.active .nav-label{color:var(--accent-primary)}
.nav-icon{font-size:20px;color:var(--text-muted);transition:var(--transition)}
.nav-label{font-size:9px;color:var(--text-muted);font-weight:500;transition:var(--transition)}

/* Cards */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)}
.card-title{font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;margin-bottom:12px}

/* Forms */
.form-group{margin-bottom:12px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(--text-secondary);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
.form-input,.form-select{width:100%;padding:10px 12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:14px;outline:none;transition:var(--transition);font-family:inherit}
.form-input:focus,.form-select:focus{border-color:var(--accent-primary);box-shadow:0 0 0 2px rgba(16,185,129,.15)}
.form-input::placeholder{color:var(--text-muted)}

/* Buttons */
.btn{padding:10px 16px;border:none;border-radius:var(--radius-sm);font-size:13px;font-weight:600;cursor:pointer;transition:var(--transition);font-family:inherit;display:inline-flex;align-items:center;justify-content:center;gap:6px}
.btn:active{transform:scale(.96)}
.btn-primary{background:var(--accent-primary);color:#fff}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border)}
.btn-danger{background:var(--accent-danger);color:#fff}
.btn-warning{background:var(--accent-warning);color:#000}
.btn-info{background:var(--accent-info);color:#fff}
.btn-sm{padding:6px 10px;font-size:11px}
.btn-lg{padding:14px 20px;font-size:15px;width:100%}
.btn-block{width:100%}

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.stat-card{background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 8px;text-align:center}
.stat-value{font-size:18px;font-weight:700;color:var(--accent-primary)}
.stat-label{font-size:9px;color:var(--text-muted);margin-top:2px;text-transform:uppercase;letter-spacing:.3px}

/* Tab Panels */
.tab-panel{display:none}
.tab-panel.active{display:block}

/* Ticket List */
.ticket-item{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:var(--transition)}
.ticket-item:active{background:var(--bg-primary)}
.ticket-check{width:20px;height:20px;border:2px solid var(--border);border-radius:4px;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.ticket-check.checked{background:var(--accent-primary);border-color:var(--accent-primary)}
.ticket-check.checked::after{content:'âœ“';color:#fff;font-size:12px;font-weight:700}
.ticket-info{flex:1;min-width:0}
.ticket-number{font-size:13px;font-weight:600}
.ticket-meta{font-size:11px;color:var(--text-muted);margin-top:2px}
.ticket-diversion{font-size:13px;font-weight:700;flex-shrink:0}
.ticket-diversion.good{color:var(--accent-primary)}
.ticket-diversion.ok{color:var(--accent-warning)}
.ticket-diversion.low{color:var(--accent-danger)}

/* Search Bar */
.search-bar{display:flex;gap:8px;margin-bottom:12px}
.search-bar input{flex:1}
.search-bar select{width:auto;min-width:120px}

/* Quick Export Grid */
.export-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.export-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:14px 8px;background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition);font-size:10px;color:var(--text-secondary);font-weight:500;text-align:center}
.export-btn:active{transform:scale(.95);background:var(--bg-primary)}
.export-btn span:first-child{font-size:22px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.active{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
.modal h2{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}

/* Toast */
.toast-container{position:fixed;top:60px;right:16px;z-index:1000;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 16px;border-radius:var(--radius-sm);font-size:13px;font-weight:500;animation:slideIn .3s ease;box-shadow:var(--shadow)}
.toast.success{background:#065f46;color:#6ee7b7;border:1px solid #047857}
.toast.error{background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b}
.toast.info{background:#0c4a6e;color:#7dd3fc;border:1px solid #0369a1}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* Loading */
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9998;display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px}
.loading-overlay.active{display:flex}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent-primary);border-radius:50%;animation:spin 1s linear infinite}
.loading-text{color:var(--text-secondary);font-size:13px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Density Table */
.density-table{width:100%;border-collapse:collapse;font-size:11px}
.density-table th{background:var(--bg-tertiary);padding:6px 8px;text-align:left;font-size:10px;text-transform:uppercase;color:var(--text-muted)}
.density-table td{padding:6px 8px;border-bottom:1px solid var(--border)}

/* Hidden utility */
.hidden{display:none!important}
.admin-only{display:none}
.admin-mode .admin-only{display:inline-flex}

/* Scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="login-logo">â™»ï¸</div>
<div class="login-title">DivertScanâ„¢ v7.5</div>
<div class="login-subtitle">LEED Waste Diversion Tracking</div>
<div class="form-group">
<input type="text" class="form-input" id="loginUser" placeholder="Username" autocomplete="username">
</div>
<div class="form-group">
<input type="password" class="form-input" id="loginPass" placeholder="Password" autocomplete="current-password">
</div>
<button class="btn btn-primary btn-lg" onclick="doLogin()" style="margin-top:8px">ğŸ” Login</button>
<div class="login-error" id="loginError"></div>
</div>
</div>

<!-- APP -->
<div class="app" id="app">

<!-- HEADER -->
<div class="header">
<div class="header-left">
<div>
<div class="header-brand">DivertScanâ„¢ <span style="font-size:10px;font-weight:400;color:var(--text-muted)">v7.5</span></div>
<div class="header-project" id="headerProject">No project selected</div>
</div>
</div>
<div class="header-right">
<span class="header-badge" id="ticketBadge" title="Total tickets">0</span>
<button class="header-btn" onclick="showSyncStatus()">ğŸ”„</button>
<button class="header-btn" onclick="showSettings()">âš™ï¸</button>
<button class="header-btn" onclick="doLogout()">ğŸšª</button>
</div>
</div>

<!-- CONTENT -->
<div class="content" id="mainContent">

<!-- DASHBOARD TAB -->
<div class="tab-panel active" id="tab-dashboard">
<div class="stats-row">
<div class="stat-card"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total Tons</div></div>
<div class="stat-card"><div class="stat-value" id="statDiverted">0</div><div class="stat-label">Diverted</div></div>
<div class="stat-card"><div class="stat-value" id="statRate">0%</div><div class="stat-label">Rate</div></div>
<div class="stat-card"><div class="stat-value" id="statTickets">0</div><div class="stat-label">Tickets</div></div>
</div>

<!-- Quick Actions -->
<div class="card">
<div class="card-title"><span>âš¡</span> Quick Actions</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
<button class="btn btn-primary" onclick="startNewTicket()" style="padding:12px 6px;font-size:10px;flex-direction:column"><span style="font-size:18px">â•</span>New Ticket</button>
<button class="btn btn-secondary" onclick="showTab('scan')" style="padding:12px 6px;font-size:10px;flex-direction:column"><span style="font-size:18px">ğŸ“·</span>AI Scan</button>
<button class="btn btn-secondary" onclick="showTab('reports')" style="padding:12px 6px;font-size:10px;flex-direction:column"><span style="font-size:18px">ğŸ“„</span>Reports</button>
<button class="btn btn-secondary" onclick="triggerExcelImport()" style="padding:12px 6px;font-size:10px;flex-direction:column"><span style="font-size:18px">ğŸ“—</span>Import</button>
</div>
</div>

<!-- Data Management -->
<div class="card">
<div class="card-title"><span>ğŸ“‹</span> Ticket Data <span class="header-badge" id="dashTicketCount" style="margin-left:auto">0</span></div>

<!-- Search & Sort -->
<div class="search-bar">
<input type="text" class="form-input" id="ticketSearch" placeholder="Search ticket #, date, hauler..." oninput="filterTickets()">
<select class="form-select" id="ticketSort" onchange="filterTickets()" style="min-width:110px">
<option value="newest">Newest</option>
<option value="oldest">Oldest</option>
<option value="ticket">Ticket #</option>
<option value="tonnage">Tonnage</option>
<option value="diversion">Diversion %</option>
</select>
</div>

<!-- Bulk Controls -->
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
<button class="btn btn-sm btn-secondary" onclick="loadAllTickets()">ğŸ“¥ Load All</button>
<button class="btn btn-sm btn-secondary" id="btnSelectAll" onclick="toggleSelectAll()">â˜‘ï¸ Select All</button>
<button class="btn btn-sm btn-danger" id="btnDeleteSelected" onclick="deleteSelected()" style="display:none">ğŸ—‘ï¸ Delete Selected (<span id="selectedCount">0</span>)</button>
<button class="btn btn-sm btn-danger admin-only" onclick="deleteAllTickets()">âš ï¸ Delete ALL</button>
</div>

<!-- Ticket List -->
<div id="ticketList" style="max-height:400px;overflow-y:auto">
<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">Loading tickets...</div>
</div>
</div>

<!-- Quick Exports -->
<div class="card">
<div class="card-title"><span>ğŸ“¤</span> Quick Exports</div>
<div class="export-grid">
<div class="export-btn" onclick="generateBoxTrackerExcel()"><span>ğŸ“Š</span>Box Tracker Excel</div>
<div class="export-btn" onclick="generateLEEDPDF()"><span>ğŸ“„</span>LEED PDF</div>
<div class="export-btn" onclick="exportCSV()"><span>ğŸ“‹</span>CSV</div>
<div class="export-btn" onclick="exportJSON()"><span>ğŸ’¾</span>JSON Backup</div>
<div class="export-btn" onclick="generateExecSummary()"><span>ğŸ“‘</span>Executive Summary</div>
<div class="export-btn" onclick="triggerExcelImport()"><span>ğŸ“—</span>Import .xlsx</div>
</div>
</div>
</div>

<!-- SCAN TAB -->
<div class="tab-panel" id="tab-scan">
<div class="card">
<div class="card-title"><span>ğŸ“·</span> AI Debris Analysis</div>
<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Upload 1-3 photos of the debris pile. AI will identify materials and estimate percentages.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px">
<label style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:20px 8px;background:var(--bg-tertiary);border:2px dashed var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:10px;color:var(--text-muted)">
<span style="font-size:24px">ğŸ“¸</span>Photo 1
<input type="file" accept="image/*" capture="environment" onchange="handleDebrisPhoto(this,0)" style="display:none">
</label>
<label style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:20px 8px;background:var(--bg-tertiary);border:2px dashed var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:10px;color:var(--text-muted)">
<span style="font-size:24px">ğŸ“¸</span>Photo 2
<input type="file" accept="image/*" capture="environment" onchange="handleDebrisPhoto(this,1)" style="display:none">
</label>
<label style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:20px 8px;background:var(--bg-tertiary);border:2px dashed var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:10px;color:var(--text-muted)">
<span style="font-size:24px">ğŸ“¸</span>Photo 3
<input type="file" accept="image/*" capture="environment" onchange="handleDebrisPhoto(this,2)" style="display:none">
</label>
</div>
<div id="debrisPreview" style="display:none;margin-bottom:12px"></div>
<div class="form-group">
<label class="form-label">Container Size</label>
<select class="form-select" id="containerSize">
<option value="20">20 Yard Roll-Off</option>
<option value="30" selected>30 Yard Roll-Off</option>
<option value="40">40 Yard Roll-Off</option>
</select>
</div>
<button class="btn btn-primary btn-lg" onclick="runAIAnalysis()" id="btnAnalyze">ğŸ¤– Analyze with AI</button>
<div id="aiResults" style="display:none;margin-top:12px"></div>
</div>

<div class="card">
<div class="card-title"><span>ğŸ«</span> Scale Ticket OCR</div>
<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Photograph a scale ticket to auto-extract weight data.</p>
<label style="display:flex;flex-direction:column;align-items:center;gap:4px;padding:24px;background:var(--bg-tertiary);border:2px dashed var(--border);border-radius:var(--radius-sm);cursor:pointer;font-size:12px;color:var(--text-muted);margin-bottom:12px">
<span style="font-size:28px">ğŸ«</span>Tap to scan scale ticket
<input type="file" accept="image/*" capture="environment" onchange="handleScaleTicket(this)" style="display:none">
</label>
<div id="ocrResults" style="display:none"></div>
</div>
</div>

<!-- TICKETS TAB (New/Edit Ticket) -->
<div class="tab-panel" id="tab-tickets">
<div class="card">
<div class="card-title"><span>ğŸ«</span> <span id="ticketFormTitle">New Ticket</span></div>
<div class="form-group"><label class="form-label">Ticket Number</label><input type="text" class="form-input" id="fTicketNum" placeholder="e.g. 85060"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" id="fDate"></div>
<div class="form-group"><label class="form-label">Time</label><input type="time" class="form-input" id="fTime"></div>
</div>
<div class="form-group"><label class="form-label">Hauler</label>
<select class="form-select" id="fHauler">
<option value="">Select Hauler</option>
<option value="Jaguar Waste Management">Jaguar Waste Management</option>
<option value="B&B Waste">B&amp;B Waste</option>
<option value="Liberty Demolition">Liberty Demolition</option>
<option value="Other">Other</option>
</select></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
<div class="form-group"><label class="form-label">Gross (lbs)</label><input type="number" class="form-input" id="fGross" oninput="calcNet()"></div>
<div class="form-group"><label class="form-label">Tare (lbs)</label><input type="number" class="form-input" id="fTare" oninput="calcNet()"></div>
<div class="form-group"><label class="form-label">Net (lbs)</label><input type="number" class="form-input" id="fNet" readonly style="background:var(--bg-primary)"></div>
</div>
<div class="form-group"><label class="form-label">Tons</label><input type="number" class="form-input" id="fTons" readonly style="background:var(--bg-primary)"></div>

<div class="card-title" style="margin-top:16px"><span>ğŸ“Š</span> Material Breakdown (%)</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div class="form-group"><label class="form-label">Wood</label><input type="number" class="form-input mat-pct" id="fWood" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">Gypsum</label><input type="number" class="form-input mat-pct" id="fGypsum" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">Plastic</label><input type="number" class="form-input mat-pct" id="fPlastic" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">OCC</label><input type="number" class="form-input mat-pct" id="fOCC" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">Metal</label><input type="number" class="form-input mat-pct" id="fMetal" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">Concrete</label><input type="number" class="form-input mat-pct" id="fConcrete" min="0" max="100" step="1" oninput="calcDiversion()"></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
<div class="form-group"><label class="form-label">Block</label><input type="number" class="form-input mat-pct" id="fBlock" min="0" max="100" step="1" oninput="calcDiversion()"></div>
<div class="form-group"><label class="form-label">Trash/Landfill</label><input type="number" class="form-input" id="fTrash" min="0" max="100" step="1" readonly style="background:var(--bg-primary)"></div>
</div>
<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-sm);margin-bottom:12px">
<span style="font-size:13px;font-weight:600">Diversion Rate:</span>
<span style="font-size:20px;font-weight:700;color:var(--accent-primary)" id="fDivRate">0%</span>
</div>

<div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="fNotes" rows="2" placeholder="Optional notes..."></textarea></div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
<button class="btn btn-secondary btn-lg" onclick="cancelTicket()">Cancel</button>
<button class="btn btn-primary btn-lg" onclick="saveTicket()">ğŸ’¾ Save Ticket</button>
</div>
</div>
</div>

<!-- PROJECTS TAB -->
<div class="tab-panel" id="tab-projects">
<div class="card">
<div class="card-title"><span>ğŸ“</span> Projects</div>
<button class="btn btn-primary btn-block admin-only" onclick="showNewProject()" style="margin-bottom:12px">â• New Project</button>
<div id="projectList" style="color:var(--text-muted);font-size:13px">Loading projects...</div>
</div>
<div class="card">
<div class="card-title"><span>ğŸ“—</span> Excel Import</div>
<p style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Select a project above, then import scale ticket data from an Excel file.</p>
<button class="btn btn-primary btn-block" onclick="triggerExcelImport()">ğŸ“¥ Import .xlsx File</button>
<input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" onchange="processExcelImport(this)" style="display:none">
</div>
</div>

<!-- REPORTS TAB -->
<div class="tab-panel" id="tab-reports">
<div class="card">
<div class="card-title"><span>ğŸ“„</span> Reports</div>
<button class="btn btn-primary btn-block" onclick="generateReport()" style="margin-bottom:8px">ğŸ“Š Generate LEED Report</button>
<button class="btn btn-secondary btn-block" onclick="generateBoxTrackerExcel()" style="margin-bottom:8px">ğŸ“— Box Tracker Excel Report</button>
<button class="btn btn-secondary btn-block" onclick="generateLEEDPDF()">ğŸ“„ LEED Audit PDF</button>
<div id="reportOutput" style="margin-top:16px;display:none"></div>
</div>
<div class="card">
<div class="card-title"><span>ğŸ“¤</span> Quick Exports</div>
<div class="export-grid">
<div class="export-btn" onclick="generateBoxTrackerExcel()"><span>ğŸ“Š</span>Box Tracker Excel</div>
<div class="export-btn" onclick="generateLEEDPDF()"><span>ğŸ“„</span>LEED PDF</div>
<div class="export-btn" onclick="exportCSV()"><span>ğŸ“‹</span>CSV</div>
<div class="export-btn" onclick="exportJSON()"><span>ğŸ’¾</span>JSON</div>
<div class="export-btn" onclick="generateExecSummary()"><span>ğŸ“‘</span>Exec Summary</div>
<div class="export-btn" onclick="generateV5Report()"><span>ğŸ—ï¸</span>LEED v5</div>
</div>
</div>
<div class="card">
<div class="card-title"><span>âš–ï¸</span> Density Reference</div>
<table class="density-table">
<thead><tr><th>Material</th><th>Density (lbs/CY)</th><th>30 CY Max (tons)</th></tr></thead>
<tbody>
<tr><td>Mixed C&D</td><td>300-500</td><td>7.5</td></tr>
<tr><td>Wood/Drywall</td><td>200-300</td><td>4.5</td></tr>
<tr><td>Metal</td><td>500-800</td><td>12</td></tr>
<tr><td>Concrete/Masonry</td><td>2,000-2,500</td><td>37.5</td></tr>
<tr><td>Dirt/Clean Fill</td><td>2,200-2,800</td><td>42</td></tr>
<tr><td>MSW/Trash</td><td>150-250</td><td>3.75</td></tr>
</tbody>
</table>
</div>
</div>

<!-- SETTINGS TAB -->
<div class="tab-panel" id="tab-settings">
<div class="card">
<div class="card-title"><span>ğŸ¨</span> Theme</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
<button class="btn btn-sm btn-secondary" onclick="setTheme('')" style="font-size:10px">Default</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('ocean')" style="font-size:10px">Ocean</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('sunset')" style="font-size:10px">Sunset</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('forest')" style="font-size:10px">Forest</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('night')" style="font-size:10px">Night</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('light')" style="font-size:10px">Light</button>
<button class="btn btn-sm btn-secondary" onclick="setTheme('jaguar')" style="font-size:10px">Jaguar</button>
</div>
</div>
<div class="card">
<div class="card-title"><span>â˜ï¸</span> Supabase Connection</div>
<div class="form-group"><label class="form-label">Supabase URL</label><input type="text" class="form-input" id="setSupaUrl" placeholder="https://xxxx.supabase.co"></div>
<div class="form-group"><label class="form-label">Supabase Anon Key</label><input type="text" class="form-input" id="setSupaKey" placeholder="eyJhbGciOiJIUzI1NiIs..."></div>
<button class="btn btn-primary btn-block" onclick="saveSupabaseConfig()">ğŸ’¾ Save & Connect</button>
<div id="supaStatus" style="margin-top:8px;font-size:12px;color:var(--text-muted)"></div>
</div>
<div class="card">
<div class="card-title"><span>ğŸ¤–</span> AI Configuration</div>
<div class="form-group"><label class="form-label">Anthropic API Key</label><input type="password" class="form-input" id="setAnthropicKey" placeholder="sk-ant-..."></div>
<button class="btn btn-primary btn-block" onclick="saveAIConfig()">ğŸ’¾ Save AI Key</button>
</div>
<div class="card">
<div class="card-title"><span>ğŸ’¾</span> Data Management</div>
<button class="btn btn-secondary btn-block" onclick="createFullBackup()" style="margin-bottom:8px">ğŸ“¥ Full Backup (JSON)</button>
<button class="btn btn-secondary btn-block" onclick="document.getElementById('restoreInput').click()" style="margin-bottom:8px">ğŸ“¤ Restore from Backup</button>
<input type="file" id="restoreInput" accept=".json" onchange="restoreBackup(this)" style="display:none">
<button class="btn btn-danger btn-block admin-only" onclick="factoryReset()">ğŸ”´ Factory Reset</button>
</div>
<div style="text-align:center;padding:20px;font-size:10px;color:var(--text-muted)">
Â© 2026 DivertScanâ„¢. All Rights Reserved.<br>
Personal IP of Robert â€” Licensed to Dalmex Recycling LLC
</div>
</div>

</div><!-- /content -->

<!-- BOTTOM NAV -->
<div class="nav">
<div class="nav-item active" onclick="showTab('dashboard')"><div class="nav-icon">ğŸ“Š</div><div class="nav-label">Dashboard</div></div>
<div class="nav-item" onclick="showTab('scan')"><div class="nav-icon">ğŸ“·</div><div class="nav-label">Scan</div></div>
<div class="nav-item" onclick="showTab('tickets')"><div class="nav-icon">ğŸ«</div><div class="nav-label">Tickets</div></div>
<div class="nav-item" onclick="showTab('projects')"><div class="nav-icon">ğŸ“</div><div class="nav-label">Projects</div></div>
<div class="nav-item" onclick="showTab('reports')"><div class="nav-icon">ğŸ“„</div><div class="nav-label">Reports</div></div>
<div class="nav-item" onclick="showTab('settings')"><div class="nav-icon">âš™ï¸</div><div class="nav-label">Settings</div></div>
</div>

</div><!-- /app -->

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<!-- LOADING OVERLAY -->
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
<div class="loading-text" id="loadingText">Loading...</div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modalOverlay">
<div class="modal" id="modalContent"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DivertScanâ„¢ v7.5 â€” Complete JavaScript Engine
// Â© 2026 DivertScanâ„¢. All Rights Reserved.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_VERSION = '7.5';
const DB_NAME = 'DivertScanDB';
const DB_VERSION = 3;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let db = null;           // IndexedDB reference
let sb = null;           // Supabase client
let currentUser = null;
let currentProject = null;
let allTickets = [];
let selectedTickets = new Set();
let debrisPhotos = [null, null, null];
let editingTicketId = null;
let isAdminMode = false;

// â”€â”€ DEMO DATA (53 Children's Hospital tickets) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEMO_TICKETS = [
{ticket_number:'85060',service_date:'2025-09-08',hauler:'Jaguar Waste Management',gross_weight:41100,tare_weight:33800,net_weight:7300,tons:3.65,wood_pct:85,gypsum_pct:0,plastic_pct:0,occ_pct:0,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:95},
{ticket_number:'85231',service_date:'2025-09-29',hauler:'Jaguar Waste Management',gross_weight:41780,tare_weight:34260,net_weight:7520,tons:3.76,wood_pct:45,gypsum_pct:10,plastic_pct:10,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:85},
{ticket_number:'85292',service_date:'2025-09-30',hauler:'Jaguar Waste Management',gross_weight:42200,tare_weight:33360,net_weight:8840,tons:4.42,wood_pct:30,gypsum_pct:5,plastic_pct:5,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'85411',service_date:'2025-10-03',hauler:'Jaguar Waste Management',gross_weight:38920,tare_weight:33480,net_weight:5440,tons:2.72,wood_pct:50,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'85503',service_date:'2025-10-07',hauler:'Jaguar Waste Management',gross_weight:43600,tare_weight:34080,net_weight:9520,tons:4.76,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'85541',service_date:'2025-10-08',hauler:'Jaguar Waste Management',gross_weight:41440,tare_weight:34240,net_weight:7200,tons:3.60,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'85621',service_date:'2025-10-10',hauler:'Jaguar Waste Management',gross_weight:40280,tare_weight:33560,net_weight:6720,tons:3.36,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'85699',service_date:'2025-10-14',hauler:'Jaguar Waste Management',gross_weight:39640,tare_weight:33440,net_weight:6200,tons:3.10,wood_pct:35,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:50},
{ticket_number:'85755',service_date:'2025-10-16',hauler:'Jaguar Waste Management',gross_weight:44100,tare_weight:34400,net_weight:9700,tons:4.85,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:83},
{ticket_number:'85801',service_date:'2025-10-17',hauler:'Jaguar Waste Management',gross_weight:40800,tare_weight:33600,net_weight:7200,tons:3.60,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'85880',service_date:'2025-10-21',hauler:'Jaguar Waste Management',gross_weight:42400,tare_weight:34000,net_weight:8400,tons:4.20,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'85933',service_date:'2025-10-23',hauler:'Jaguar Waste Management',gross_weight:43800,tare_weight:34200,net_weight:9600,tons:4.80,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86010',service_date:'2025-10-27',hauler:'Jaguar Waste Management',gross_weight:41600,tare_weight:33800,net_weight:7800,tons:3.90,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'86055',service_date:'2025-10-28',hauler:'Jaguar Waste Management',gross_weight:39800,tare_weight:33400,net_weight:6400,tons:3.20,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86101',service_date:'2025-10-29',hauler:'Jaguar Waste Management',gross_weight:40600,tare_weight:33600,net_weight:7000,tons:3.50,wood_pct:35,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:50},
{ticket_number:'86155',service_date:'2025-10-31',hauler:'Jaguar Waste Management',gross_weight:43200,tare_weight:34100,net_weight:9100,tons:4.55,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:70},
{ticket_number:'86188',service_date:'2025-10-31',hauler:'Jaguar Waste Management',gross_weight:41800,tare_weight:33700,net_weight:8100,tons:4.05,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:68},
{ticket_number:'86250',service_date:'2025-11-04',hauler:'Jaguar Waste Management',gross_weight:42600,tare_weight:34000,net_weight:8600,tons:4.30,wood_pct:45,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'86310',service_date:'2025-11-06',hauler:'Jaguar Waste Management',gross_weight:40400,tare_weight:33600,net_weight:6800,tons:3.40,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'86388',service_date:'2025-11-10',hauler:'Jaguar Waste Management',gross_weight:43400,tare_weight:34200,net_weight:9200,tons:4.60,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86430',service_date:'2025-11-12',hauler:'Jaguar Waste Management',gross_weight:41200,tare_weight:33800,net_weight:7400,tons:3.70,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'86500',service_date:'2025-11-14',hauler:'Jaguar Waste Management',gross_weight:44200,tare_weight:34400,net_weight:9800,tons:4.90,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86555',service_date:'2025-11-17',hauler:'Jaguar Waste Management',gross_weight:39600,tare_weight:33400,net_weight:6200,tons:3.10,wood_pct:35,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:55},
{ticket_number:'86610',service_date:'2025-11-19',hauler:'Jaguar Waste Management',gross_weight:42800,tare_weight:34000,net_weight:8800,tons:4.40,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86660',service_date:'2025-11-20',hauler:'Jaguar Waste Management',gross_weight:41000,tare_weight:33600,net_weight:7400,tons:3.70,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'86720',service_date:'2025-11-24',hauler:'Jaguar Waste Management',gross_weight:43600,tare_weight:34200,net_weight:9400,tons:4.70,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'86780',service_date:'2025-11-25',hauler:'Jaguar Waste Management',gross_weight:40200,tare_weight:33500,net_weight:6700,tons:3.35,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'86830',service_date:'2025-11-26',hauler:'Jaguar Waste Management',gross_weight:42000,tare_weight:33800,net_weight:8200,tons:4.10,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'86890',service_date:'2025-11-28',hauler:'Jaguar Waste Management',gross_weight:44000,tare_weight:34400,net_weight:9600,tons:4.80,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:70},
{ticket_number:'86940',service_date:'2025-11-30',hauler:'Jaguar Waste Management',gross_weight:41400,tare_weight:33700,net_weight:7700,tons:3.85,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:68},
{ticket_number:'87050',service_date:'2026-01-06',hauler:'Jaguar Waste Management',gross_weight:42200,tare_weight:34000,net_weight:8200,tons:4.10,wood_pct:45,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'87100',service_date:'2026-01-07',hauler:'Jaguar Waste Management',gross_weight:40800,tare_weight:33600,net_weight:7200,tons:3.60,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'87150',service_date:'2026-01-08',hauler:'Jaguar Waste Management',gross_weight:43400,tare_weight:34200,net_weight:9200,tons:4.60,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87200',service_date:'2026-01-09',hauler:'Jaguar Waste Management',gross_weight:41600,tare_weight:33800,net_weight:7800,tons:3.90,wood_pct:55,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:70},
{ticket_number:'87250',service_date:'2026-01-10',hauler:'Jaguar Waste Management',gross_weight:39800,tare_weight:33400,net_weight:6400,tons:3.20,wood_pct:35,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'87301',service_date:'2026-01-13',hauler:'Jaguar Waste Management',gross_weight:44200,tare_weight:34400,net_weight:9800,tons:4.90,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87340',service_date:'2026-01-14',hauler:'Jaguar Waste Management',gross_weight:40600,tare_weight:33600,net_weight:7000,tons:3.50,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'87390',service_date:'2026-01-15',hauler:'Jaguar Waste Management',gross_weight:42800,tare_weight:34000,net_weight:8800,tons:4.40,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87430',service_date:'2026-01-16',hauler:'Jaguar Waste Management',gross_weight:41200,tare_weight:33700,net_weight:7500,tons:3.75,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'87480',service_date:'2026-01-17',hauler:'Jaguar Waste Management',gross_weight:43600,tare_weight:34200,net_weight:9400,tons:4.70,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'87520',service_date:'2026-01-20',hauler:'Jaguar Waste Management',gross_weight:40400,tare_weight:33500,net_weight:6900,tons:3.45,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:60},
{ticket_number:'87560',service_date:'2026-01-21',hauler:'Jaguar Waste Management',gross_weight:42000,tare_weight:33800,net_weight:8200,tons:4.10,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87600',service_date:'2026-01-22',hauler:'Jaguar Waste Management',gross_weight:44400,tare_weight:34400,net_weight:10000,tons:5.00,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87640',service_date:'2026-01-23',hauler:'Jaguar Waste Management',gross_weight:41000,tare_weight:33600,net_weight:7400,tons:3.70,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'87680',service_date:'2026-01-24',hauler:'Jaguar Waste Management',gross_weight:39600,tare_weight:33400,net_weight:6200,tons:3.10,wood_pct:35,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:50},
{ticket_number:'87720',service_date:'2026-01-27',hauler:'Jaguar Waste Management',gross_weight:43200,tare_weight:34100,net_weight:9100,tons:4.55,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:78},
{ticket_number:'87760',service_date:'2026-01-28',hauler:'Jaguar Waste Management',gross_weight:41400,tare_weight:33700,net_weight:7700,tons:3.85,wood_pct:45,gypsum_pct:5,plastic_pct:0,occ_pct:5,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'87800',service_date:'2026-01-29',hauler:'Jaguar Waste Management',gross_weight:42600,tare_weight:34000,net_weight:8600,tons:4.30,wood_pct:50,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:5,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'87840',service_date:'2026-01-30',hauler:'Jaguar Waste Management',gross_weight:40200,tare_weight:33500,net_weight:6700,tons:3.35,wood_pct:40,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:65},
{ticket_number:'87880',service_date:'2026-01-30',hauler:'Jaguar Waste Management',gross_weight:43800,tare_weight:34200,net_weight:9600,tons:4.80,wood_pct:55,gypsum_pct:5,plastic_pct:3,occ_pct:10,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:83},
{ticket_number:'87510',service_date:'2026-01-19',hauler:'Jaguar Waste Management',gross_weight:41800,tare_weight:33800,net_weight:8000,tons:4.00,wood_pct:48,gypsum_pct:5,plastic_pct:2,occ_pct:8,metal_pct:10,concrete_pct:0,block_pct:0,diversion_pct:73},
{ticket_number:'87620',service_date:'2026-01-22',hauler:'Jaguar Waste Management',gross_weight:42400,tare_weight:34000,net_weight:8400,tons:4.20,wood_pct:52,gypsum_pct:5,plastic_pct:3,occ_pct:8,metal_pct:8,concrete_pct:0,block_pct:0,diversion_pct:76},
{ticket_number:'87860',service_date:'2026-01-30',hauler:'Jaguar Waste Management',gross_weight:40600,tare_weight:33600,net_weight:7000,tons:3.50,wood_pct:42,gypsum_pct:5,plastic_pct:0,occ_pct:10,metal_pct:8,concrete_pct:0,block_pct:0,diversion_pct:65}
];

const DEMO_PROJECT = {
id: 'proj-childrens-hospital',
name: "Children's Health Pediatric Campus",
address: '2350 N Stemmons Freeway, Dallas, TX 75207',
contractor: 'McCarthy Building Companies',
hauler: 'Jaguar Waste Management',
leed_target: 75,
created: '2025-09-01'
};

// â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const USERS = {
admin: { password: 'dalmex2024', role: 'admin', name: 'Robert' },
ross: { password: 'jaguar2026', role: 'customer', name: 'Ross Halford' },
raul: { password: 'field2024', role: 'field', name: 'Raul' }
};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async () => {
await initIndexedDB();
loadSavedConfig();
const saved = localStorage.getItem('ds_session');
if (saved) {
try {
const s = JSON.parse(saved);
if (s.user && USERS[s.user]) {
currentUser = s.user;
isAdminMode = USERS[s.user].role === 'admin';
await enterApp();
return;
}
} catch(e) {}
}
});

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
const user = document.getElementById('loginUser').value.trim().toLowerCase();
const pass = document.getElementById('loginPass').value;
if (!USERS[user] || USERS[user].password !== pass) {
document.getElementById('loginError').textContent = 'Invalid credentials';
return;
}
currentUser = user;
isAdminMode = USERS[user].role === 'admin';
localStorage.setItem('ds_session', JSON.stringify({ user }));
enterApp();
}

function doLogout() {
localStorage.removeItem('ds_session');
currentUser = null;
isAdminMode = false;
document.getElementById('app').classList.remove('active', 'admin-mode');
document.getElementById('loginScreen').style.display = 'flex';
document.getElementById('loginUser').value = '';
document.getElementById('loginPass').value = '';
document.getElementById('loginError').textContent = '';
}

async function enterApp() {
document.getElementById('loginScreen').style.display = 'none';
const app = document.getElementById('app');
app.classList.add('active');
if (isAdminMode) app.classList.add('admin-mode');

// Load saved theme
const theme = localStorage.getItem('ds_theme') || '';
if (theme) document.documentElement.setAttribute('data-theme', theme);

// Load projects
await loadProjects();

// Load tickets for current project
await loadTickets();
updateDashboard();
}

// â”€â”€ INDEXEDDB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initIndexedDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open(DB_NAME, DB_VERSION);
request.onupgradeneeded = (e) => {
const database = e.target.result;
if (!database.objectStoreNames.contains('tickets')) {
const store = database.createObjectStore('tickets', { keyPath: 'id' });
store.createIndex('project_id', 'project_id', { unique: false });
store.createIndex('ticket_number', 'ticket_number', { unique: false });
}
if (!database.objectStoreNames.contains('projects')) {
database.createObjectStore('projects', { keyPath: 'id' });
}
if (!database.objectStoreNames.contains('settings')) {
database.createObjectStore('settings', { keyPath: 'key' });
}
};
request.onsuccess = (e) => { db = e.target.result; resolve(); };
request.onerror = (e) => { console.error('IDB error:', e); resolve(); };
});
}

async function idbPut(store, data) {
return new Promise((resolve, reject) => {
const tx = db.transaction([store], 'readwrite');
tx.objectStore(store).put(data);
tx.oncomplete = () => resolve();
tx.onerror = (e) => reject(e);
});
}

async function idbGetAll(store) {
return new Promise((resolve, reject) => {
const tx = db.transaction([store], 'readonly');
const req = tx.objectStore(store).getAll();
req.onsuccess = () => resolve(req.result || []);
req.onerror = (e) => reject(e);
});
}

async function idbDelete(store, key) {
return new Promise((resolve, reject) => {
const tx = db.transaction([store], 'readwrite');
tx.objectStore(store).delete(key);
tx.oncomplete = () => resolve();
tx.onerror = (e) => reject(e);
});
}

async function idbClear(store) {
return new Promise((resolve, reject) => {
const tx = db.transaction([store], 'readwrite');
tx.objectStore(store).clear();
tx.oncomplete = () => resolve();
tx.onerror = (e) => reject(e);
});
}

// â”€â”€ PROJECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadProjects() {
let projects = await idbGetAll('projects');
if (projects.length === 0) {
// Seed demo project
await idbPut('projects', DEMO_PROJECT);
projects = [DEMO_PROJECT];
// Also seed demo tickets
await seedDemoTickets();
}
renderProjectList(projects);
// Auto-select first project
if (!currentProject && projects.length > 0) {
selectProject(projects[0]);
}
}

async function seedDemoTickets() {
for (const t of DEMO_TICKETS) {
const ticket = {
id: 'demo-' + t.ticket_number,
project_id: DEMO_PROJECT.id,
...t,
source: 'demo',
created_at: new Date().toISOString()
};
await idbPut('tickets', ticket);
}
}

function selectProject(project) {
currentProject = project;
document.getElementById('headerProject').textContent = project.name;
localStorage.setItem('ds_currentProject', project.id);
loadTickets();
}

function renderProjectList(projects) {
const el = document.getElementById('projectList');
if (projects.length === 0) {
el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No projects yet</div>';
return;
}
el.innerHTML = projects.map(p => `
<div class="ticket-item" onclick="selectProject(${JSON.stringify(p).replace(/"/g,'&quot;')})">
<div class="ticket-info">
<div class="ticket-number">${p.name}</div>
<div class="ticket-meta">${p.address || ''} Â· Target: ${p.leed_target || 75}%</div>
</div>
<div style="font-size:11px;color:${currentProject?.id === p.id ? 'var(--accent-primary)' : 'var(--text-muted)'}">${currentProject?.id === p.id ? 'âœ… Active' : 'Select'}</div>
</div>
`).join('');
}

function showNewProject() {
document.getElementById('modalContent').innerHTML = `
<h2>â• New Project</h2>
<div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" id="npName" placeholder="e.g. Children's Hospital"></div>
<div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="npAddr" placeholder="Full address"></div>
<div class="form-group"><label class="form-label">Contractor</label><input type="text" class="form-input" id="npContractor" placeholder="e.g. McCarthy"></div>
<div class="form-group"><label class="form-label">Hauler</label><input type="text" class="form-input" id="npHauler" placeholder="e.g. Jaguar Waste"></div>
<div class="form-group"><label class="form-label">LEED Target (%)</label><input type="number" class="form-input" id="npTarget" value="75"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
<button class="btn btn-primary" onclick="createProject()">Create</button>
</div>`;
openModal();
}

async function createProject() {
const project = {
id: 'proj-' + Date.now(),
name: document.getElementById('npName').value,
address: document.getElementById('npAddr').value,
contractor: document.getElementById('npContractor').value,
hauler: document.getElementById('npHauler').value,
leed_target: parseInt(document.getElementById('npTarget').value) || 75,
created: new Date().toISOString().split('T')[0]
};
await idbPut('projects', project);
closeModal();
await loadProjects();
selectProject(project);
toast('Project created', 'success');
}

// â”€â”€ TICKETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTickets(showAll = false) {
if (!currentProject) return;
let tickets = await idbGetAll('tickets');
tickets = tickets.filter(t => t.project_id === currentProject.id);

// Also try Supabase
if (sb) {
try {
const { data, error } = await sb.from('tickets').select('*').eq('project_id', currentProject.id);
if (!error && data) {
const map = new Map();
tickets.forEach(t => map.set(t.ticket_number || t.id, t));
data.forEach(t => map.set(t.ticket_number || t.id, { ...t, id: t.id || ('sb-' + t.ticket_number) }));
tickets = Array.from(map.values());
}
} catch(e) {}
}

allTickets = tickets.sort((a,b) => (b.service_date || '').localeCompare(a.service_date || ''));
selectedTickets.clear();
updateDashboard();
filterTickets();
}

async function loadAllTickets() {
showLoading('Loading all tickets...');
await loadTickets(true);
hideLoading();
toast(`Loaded ${allTickets.length} tickets`, 'success');
}

function filterTickets() {
const search = (document.getElementById('ticketSearch').value || '').toLowerCase();
const sort = document.getElementById('ticketSort').value;

let filtered = allTickets.filter(t => {
if (!search) return true;
return (t.ticket_number || '').toLowerCase().includes(search) ||
(t.service_date || '').includes(search) ||
(t.hauler || '').toLowerCase().includes(search);
});

switch(sort) {
case 'oldest': filtered.sort((a,b) => (a.service_date||'').localeCompare(b.service_date||'')); break;
case 'newest': filtered.sort((a,b) => (b.service_date||'').localeCompare(a.service_date||'')); break;
case 'ticket': filtered.sort((a,b) => (a.ticket_number||'').localeCompare(b.ticket_number||'')); break;
case 'tonnage': filtered.sort((a,b) => (b.tons||0) - (a.tons||0)); break;
case 'diversion': filtered.sort((a,b) => (b.diversion_pct||0) - (a.diversion_pct||0)); break;
}

renderTicketList(filtered);
document.getElementById('dashTicketCount').textContent = allTickets.length;
document.getElementById('ticketBadge').textContent = allTickets.length;
}

function renderTicketList(tickets) {
const el = document.getElementById('ticketList');
if (tickets.length === 0) {
el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px">No tickets found</div>';
return;
}
el.innerHTML = tickets.map(t => {
const div = t.diversion_pct || 0;
const cls = div >= 75 ? 'good' : div >= 50 ? 'ok' : 'low';
const checked = selectedTickets.has(t.id) ? 'checked' : '';
return `<div class="ticket-item">
<div class="ticket-check ${checked}" onclick="event.stopPropagation();toggleTicketSelect('${t.id}')"></div>
<div class="ticket-info" onclick="editTicket('${t.id}')">
<div class="ticket-number">#${t.ticket_number || 'â€”'} Â· ${(t.tons||0).toFixed(2)} tons</div>
<div class="ticket-meta">${t.service_date || 'â€”'} Â· ${t.hauler || 'â€”'}</div>
</div>
<div class="ticket-diversion ${cls}">${div}%</div>
</div>`;
}).join('');
}

function toggleTicketSelect(id) {
if (selectedTickets.has(id)) selectedTickets.delete(id);
else selectedTickets.add(id);
updateSelectionUI();
filterTickets();
}

function toggleSelectAll() {
if (selectedTickets.size === allTickets.length) {
selectedTickets.clear();
} else {
allTickets.forEach(t => selectedTickets.add(t.id));
}
updateSelectionUI();
filterTickets();
}

function updateSelectionUI() {
const count = selectedTickets.size;
document.getElementById('selectedCount').textContent = count;
document.getElementById('btnDeleteSelected').style.display = count > 0 ? 'inline-flex' : 'none';
document.getElementById('btnSelectAll').textContent = selectedTickets.size === allTickets.length ? 'â˜ Deselect All' : 'â˜‘ï¸ Select All';
}

async function deleteSelected() {
const count = selectedTickets.size;
if (!confirm(`Delete ${count} selected ticket(s)?`)) return;
showLoading('Deleting...');
for (const id of selectedTickets) {
await idbDelete('tickets', id);
if (sb) { try { await sb.from('tickets').delete().eq('id', id); } catch(e) {} }
}
selectedTickets.clear();
updateSelectionUI();
await loadTickets();
hideLoading();
toast(`Deleted ${count} tickets`, 'success');
}

async function deleteAllTickets() {
if (!confirm('âš ï¸ Delete ALL tickets for this project?')) return;
if (!confirm('This cannot be undone. Are you absolutely sure?')) return;
showLoading('Deleting all tickets...');
const toDelete = allTickets.map(t => t.id);
for (const id of toDelete) { await idbDelete('tickets', id); }
if (sb) { try { await sb.from('tickets').delete().eq('project_id', currentProject.id); } catch(e) {} }
selectedTickets.clear();
updateSelectionUI();
await loadTickets();
hideLoading();
toast('All tickets deleted', 'success');
}

// â”€â”€ NEW / EDIT TICKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startNewTicket() {
editingTicketId = null;
document.getElementById('ticketFormTitle').textContent = 'New Ticket';
clearTicketForm();
document.getElementById('fDate').value = new Date().toISOString().split('T')[0];
document.getElementById('fTime').value = new Date().toTimeString().slice(0,5);
showTab('tickets');
}

function editTicket(id) {
const t = allTickets.find(x => x.id === id);
if (!t) return;
editingTicketId = id;
document.getElementById('ticketFormTitle').textContent = 'Edit Ticket #' + t.ticket_number;
document.getElementById('fTicketNum').value = t.ticket_number || '';
document.getElementById('fDate').value = t.service_date || '';
document.getElementById('fTime').value = t.time || '';
document.getElementById('fHauler').value = t.hauler || '';
document.getElementById('fGross').value = t.gross_weight || '';
document.getElementById('fTare').value = t.tare_weight || '';
document.getElementById('fNet').value = t.net_weight || '';
document.getElementById('fTons').value = t.tons || '';
document.getElementById('fWood').value = t.wood_pct || '';
document.getElementById('fGypsum').value = t.gypsum_pct || '';
document.getElementById('fPlastic').value = t.plastic_pct || '';
document.getElementById('fOCC').value = t.occ_pct || '';
document.getElementById('fMetal').value = t.metal_pct || '';
document.getElementById('fConcrete').value = t.concrete_pct || '';
document.getElementById('fBlock').value = t.block_pct || '';
document.getElementById('fNotes').value = t.notes || '';
calcDiversion();
showTab('tickets');
}

function clearTicketForm() {
['fTicketNum','fDate','fTime','fGross','fTare','fNet','fTons','fWood','fGypsum','fPlastic','fOCC','fMetal','fConcrete','fBlock','fNotes'].forEach(id => {
const el = document.getElementById(id);
if (el) el.value = '';
});
document.getElementById('fHauler').value = '';
document.getElementById('fTrash').value = '';
document.getElementById('fDivRate').textContent = '0%';
}

function calcNet() {
const g = parseFloat(document.getElementById('fGross').value) || 0;
const t = parseFloat(document.getElementById('fTare').value) || 0;
const net = Math.max(0, g - t);
document.getElementById('fNet').value = net;
document.getElementById('fTons').value = (net / 2000).toFixed(2);
}

function calcDiversion() {
const fields = ['fWood','fGypsum','fPlastic','fOCC','fMetal','fConcrete','fBlock'];
let total = 0;
fields.forEach(id => { total += parseFloat(document.getElementById(id).value) || 0; });
const trash = Math.max(0, 100 - total);
document.getElementById('fTrash').value = trash;
document.getElementById('fDivRate').textContent = total + '%';
const el = document.getElementById('fDivRate');
el.style.color = total >= 75 ? 'var(--accent-primary)' : total >= 50 ? 'var(--accent-warning)' : 'var(--accent-danger)';
}

async function saveTicket() {
const ticketNum = document.getElementById('fTicketNum').value.trim();
if (!ticketNum) { toast('Ticket number required', 'error'); return; }
if (!currentProject) { toast('Select a project first', 'error'); return; }

const fields = ['fWood','fGypsum','fPlastic','fOCC','fMetal','fConcrete','fBlock'];
let divPct = 0;
fields.forEach(id => { divPct += parseFloat(document.getElementById(id).value) || 0; });

const ticket = {
id: editingTicketId || ('t-' + Date.now()),
project_id: currentProject.id,
ticket_number: ticketNum,
service_date: document.getElementById('fDate').value,
time: document.getElementById('fTime').value,
hauler: document.getElementById('fHauler').value,
gross_weight: parseFloat(document.getElementById('fGross').value) || 0,
tare_weight: parseFloat(document.getElementById('fTare').value) || 0,
net_weight: parseFloat(document.getElementById('fNet').value) || 0,
tons: parseFloat(document.getElementById('fTons').value) || 0,
wood_pct: parseFloat(document.getElementById('fWood').value) || 0,
gypsum_pct: parseFloat(document.getElementById('fGypsum').value) || 0,
plastic_pct: parseFloat(document.getElementById('fPlastic').value) || 0,
occ_pct: parseFloat(document.getElementById('fOCC').value) || 0,
metal_pct: parseFloat(document.getElementById('fMetal').value) || 0,
concrete_pct: parseFloat(document.getElementById('fConcrete').value) || 0,
block_pct: parseFloat(document.getElementById('fBlock').value) || 0,
diversion_pct: divPct,
notes: document.getElementById('fNotes').value,
source: 'manual',
created_at: new Date().toISOString()
};

await idbPut('tickets', ticket);

// Also sync to Supabase
if (sb) {
try { await sb.from('tickets').upsert(ticket); } catch(e) { console.log('Supabase sync skipped'); }
}

toast(editingTicketId ? 'Ticket updated' : 'Ticket saved', 'success');
editingTicketId = null;
showTab('dashboard');
await loadTickets();
}

function cancelTicket() {
editingTicketId = null;
showTab('dashboard');
}

// â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboard() {
const tickets = allTickets;
const totalTons = tickets.reduce((s,t) => s + (t.tons || 0), 0);
const divertedTons = tickets.reduce((s,t) => s + ((t.tons || 0) * (t.diversion_pct || 0) / 100), 0);
const rate = totalTons > 0 ? ((divertedTons / totalTons) * 100).toFixed(1) : '0.0';

document.getElementById('statTotal').textContent = totalTons.toFixed(1);
document.getElementById('statDiverted').textContent = divertedTons.toFixed(1);
document.getElementById('statRate').textContent = rate + '%';
document.getElementById('statTickets').textContent = tickets.length;
document.getElementById('statRate').style.color = parseFloat(rate) >= 75 ? 'var(--accent-primary)' : parseFloat(rate) >= 50 ? 'var(--accent-warning)' : 'var(--accent-danger)';
}

// â”€â”€ EXCEL IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function triggerExcelImport() {
if (!currentProject) { toast('Select a project first', 'error'); return; }
document.getElementById('excelFileInput').click();
}

async function processExcelImport(input) {
if (!input.files.length) return;
showLoading('Reading Excel file...');

const file = input.files[0];
const data = await file.arrayBuffer();
const wb = XLSX.read(data, { type: 'array', cellDates: true });

let imported = 0;
for (const sheetName of wb.SheetNames) {
const ws = wb.Sheets[sheetName];
const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

for (const row of rows) {
const ticketNum = row['Ticket No'] || row['Ticket'] || row['ticket_number'] || row['Ticket #'] || '';
if (!ticketNum) continue;

let date = row['Date'] || row['date'] || row['service_date'] || '';
if (date instanceof Date) date = date.toISOString().split('T')[0];
else if (typeof date === 'number') {
const d = new Date((date - 25569) * 86400 * 1000);
date = d.toISOString().split('T')[0];
}

const gross = parseFloat(row['GWT (lbs)'] || row['Gross'] || row['gross_weight'] || 0);
const tare = parseFloat(row['Tare (lbs)'] || row['Tare'] || row['tare_weight'] || 0);
const net = parseFloat(row['Net (lbs)'] || row['Net'] || row['net_weight'] || 0) || (gross - tare);
const tons = parseFloat(row['Tons'] || row['tons'] || 0) || (net / 2000);

const woodPct = parsePct(row['Wood %'] || row['Wood'] || row['wood_pct'] || 0);
const gypsumPct = parsePct(row['Gypsum %'] || row['Gypsum'] || row['gypsum_pct'] || 0);
const plasticPct = parsePct(row['Plastic %'] || row['Plastic'] || row['plastic_pct'] || 0);
const occPct = parsePct(row['OCC %'] || row['OCC'] || row['occ_pct'] || 0);
const metalPct = parsePct(row['Metal %'] || row['Metal'] || row['metal_pct'] || 0);
const concretePct = parsePct(row['Concrete %'] || row['Concrete'] || row['concrete_pct'] || 0);
const blockPct = parsePct(row['Block %'] || row['Block'] || row['block_pct'] || 0);
const divPct = woodPct + gypsumPct + plasticPct + occPct + metalPct + concretePct + blockPct;

const ticket = {
id: 'xlsx-' + String(ticketNum).trim() + '-' + sheetName.replace(/\s/g,''),
project_id: currentProject.id,
ticket_number: String(ticketNum).trim(),
service_date: date,
hauler: currentProject.hauler || '',
gross_weight: gross,
tare_weight: tare,
net_weight: net || (gross - tare),
tons: tons,
wood_pct: woodPct,
gypsum_pct: gypsumPct,
plastic_pct: plasticPct,
occ_pct: occPct,
metal_pct: metalPct,
concrete_pct: concretePct,
block_pct: blockPct,
diversion_pct: Math.min(divPct, 100),
source: 'excel-' + sheetName,
created_at: new Date().toISOString()
};
await idbPut('tickets', ticket);
imported++;
}
}

input.value = '';
hideLoading();
await loadTickets();
toast(`Imported ${imported} tickets from ${wb.SheetNames.length} tab(s)`, 'success');
}

function parsePct(val) {
const n = parseFloat(val) || 0;
return n > 1 ? n : n * 100; // Handle both 0.85 and 85 formats
}

// â”€â”€ BOX TRACKER EXCEL REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateBoxTrackerExcel() {
if (!allTickets.length) { toast('No tickets to export', 'error'); return; }
showLoading('Generating Box Tracker Excel...');

const wb = XLSX.utils.book_new();
const months = {};

// Group by month
allTickets.forEach(t => {
const d = t.service_date || '';
const key = d.substring(0, 7); // YYYY-MM
if (!months[key]) months[key] = [];
months[key].push(t);
});

// Sort months
const sortedMonths = Object.keys(months).sort();

for (const monthKey of sortedMonths) {
const tickets = months[monthKey].sort((a,b) => (a.service_date||'').localeCompare(b.service_date||''));
const monthName = new Date(monthKey + '-01').toLocaleString('en-US', { month: 'long', year: 'numeric' });

// Build rows in Ross's exact format
const headerRow = ['Date', 'Ticket No', 'GWT (lbs)', 'Tare (lbs)', 'Net (lbs)', 'Tons',
'Wood %', 'Wood (tons)', 'Gypsum %', 'Gypsum (tons)', 'Plastic %', 'Plastic (tons)',
'OCC %', 'OCC (tons)', 'Metal %', 'Metal (tons)', 'Concrete %', 'Concrete (tons)',
'Block %', 'Block (tons)', 'Trash %', 'Trash (tons)', 'Diverted %', 'Diverted (tons)'];

const dataRows = tickets.map(t => {
const tons = t.tons || 0;
const woodT = tons * (t.wood_pct || 0) / 100;
const gypT = tons * (t.gypsum_pct || 0) / 100;
const plasT = tons * (t.plastic_pct || 0) / 100;
const occT = tons * (t.occ_pct || 0) / 100;
const metT = tons * (t.metal_pct || 0) / 100;
const conT = tons * (t.concrete_pct || 0) / 100;
const blkT = tons * (t.block_pct || 0) / 100;
const trashPct = Math.max(0, 100 - (t.diversion_pct || 0));
const trashT = tons * trashPct / 100;
const divT = tons * (t.diversion_pct || 0) / 100;

return [t.service_date, t.ticket_number, t.gross_weight, t.tare_weight, t.net_weight, r2(tons),
t.wood_pct, r2(woodT), t.gypsum_pct, r2(gypT), t.plastic_pct, r2(plasT),
t.occ_pct, r2(occT), t.metal_pct, r2(metT), t.concrete_pct, r2(conT),
t.block_pct, r2(blkT), trashPct, r2(trashT), t.diversion_pct, r2(divT)];
});

// Totals row (weighted averages for %, sums for tons)
const totalTons = tickets.reduce((s,t) => s + (t.tons||0), 0);
const sumGross = tickets.reduce((s,t) => s + (t.gross_weight||0), 0);
const sumTare = tickets.reduce((s,t) => s + (t.tare_weight||0), 0);
const sumNet = tickets.reduce((s,t) => s + (t.net_weight||0), 0);

const wAvg = (field) => totalTons > 0 ? tickets.reduce((s,t) => s + (t[field]||0) * (t.tons||0), 0) / totalTons : 0;
const matSum = (field) => tickets.reduce((s,t) => s + (t.tons||0) * (t[field]||0) / 100, 0);

const totalsRow = ['TOTALS', '', sumGross, sumTare, sumNet, r2(totalTons),
r2(wAvg('wood_pct')), r2(matSum('wood_pct')),
r2(wAvg('gypsum_pct')), r2(matSum('gypsum_pct')),
r2(wAvg('plastic_pct')), r2(matSum('plastic_pct')),
r2(wAvg('occ_pct')), r2(matSum('occ_pct')),
r2(wAvg('metal_pct')), r2(matSum('metal_pct')),
r2(wAvg('concrete_pct')), r2(matSum('concrete_pct')),
r2(wAvg('block_pct')), r2(matSum('block_pct')),
r2(100 - wAvg('wood_pct') - wAvg('gypsum_pct') - wAvg('plastic_pct') - wAvg('occ_pct') - wAvg('metal_pct') - wAvg('concrete_pct') - wAvg('block_pct')),
r2(totalTons - matSum('wood_pct') - matSum('gypsum_pct') - matSum('plastic_pct') - matSum('occ_pct') - matSum('metal_pct') - matSum('concrete_pct') - matSum('block_pct')),
r2(wAvg('diversion_pct') || (totalTons > 0 ? matSum('diversion_pct') / totalTons * 100 : 0)),
r2(matSum('diversion_pct') || (totalTons * wAvg('diversion_pct') / 100))
];

// Summary footer
const divertedTotal = matSum('diversion_pct') || tickets.reduce((s,t) => s + (t.tons||0) * (t.diversion_pct||0) / 100, 0);
const summaryRows = [
[], // blank
['Project:', currentProject?.name || ''],
['Hauler:', currentProject?.hauler || ''],
['Period:', monthName],
['Total Tickets:', tickets.length],
['Total Tons:', r2(totalTons)],
['Diverted Tons:', r2(divertedTotal)],
['Landfill Tons:', r2(totalTons - divertedTotal)],
['Diversion Rate:', r2(totalTons > 0 ? (divertedTotal/totalTons)*100 : 0) + '%'],
['LEED Target:', (currentProject?.leed_target || 75) + '%'],
['Status:', (totalTons > 0 && (divertedTotal/totalTons)*100 >= (currentProject?.leed_target||75)) ? 'âœ… ON TRACK' : 'âš ï¸ BELOW TARGET']
];

const allRows = [headerRow, ...dataRows, totalsRow, ...summaryRows];
const ws = XLSX.utils.aoa_to_sheet(allRows);

// Column widths
ws['!cols'] = [
{wch:12},{wch:10},{wch:12},{wch:12},{wch:12},{wch:8},
{wch:8},{wch:10},{wch:9},{wch:11},{wch:9},{wch:11},
{wch:7},{wch:10},{wch:8},{wch:10},{wch:10},{wch:12},
{wch:8},{wch:10},{wch:8},{wch:10},{wch:10},{wch:12}
];

XLSX.utils.book_append_sheet(wb, ws, monthName.length > 31 ? monthName.substring(0,31) : monthName);
}

const filename = `DivertScan_BoxTracker_${currentProject?.name?.replace(/[^a-zA-Z0-9]/g,'_') || 'Report'}_${new Date().toISOString().split('T')[0]}.xlsx`;
XLSX.writeFile(wb, filename);
hideLoading();
toast('Box Tracker Excel exported', 'success');
}

function r2(n) { return Math.round((n||0) * 100) / 100; }

// â”€â”€ REPORTS (LEED) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateReport() {
if (!currentProject) { toast('Select a project first', 'error'); return; }
if (!allTickets.length) { toast('No tickets found', 'error'); return; }
showLoading('Generating report...');

const tickets = allTickets;
const totalTons = tickets.reduce((s,t) => s + (t.tons||0), 0);
const divertedTons = tickets.reduce((s,t) => s + (t.tons||0) * (t.diversion_pct||0) / 100, 0);
const rate = totalTons > 0 ? ((divertedTons / totalTons) * 100).toFixed(1) : '0.0';

// Build monthly breakdown
const months = {};
tickets.forEach(t => {
const m = (t.service_date||'').substring(0,7);
if (!months[m]) months[m] = { tickets: 0, tons: 0, diverted: 0 };
months[m].tickets++;
months[m].tons += t.tons || 0;
months[m].diverted += (t.tons||0) * (t.diversion_pct||0) / 100;
});

let reportHTML = `
<div style="padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);margin-bottom:12px">
<div style="font-size:16px;font-weight:700;margin-bottom:4px">${currentProject.name}</div>
<div style="font-size:12px;color:var(--text-muted)">${currentProject.address || ''}</div>
<div style="font-size:12px;color:var(--text-muted)">Contractor: ${currentProject.contractor || 'N/A'} Â· Hauler: ${currentProject.hauler || 'N/A'}</div>
</div>
<div class="stats-row">
<div class="stat-card"><div class="stat-value">${totalTons.toFixed(1)}</div><div class="stat-label">Total Tons</div></div>
<div class="stat-card"><div class="stat-value">${divertedTons.toFixed(1)}</div><div class="stat-label">Diverted</div></div>
<div class="stat-card"><div class="stat-value">${(totalTons - divertedTons).toFixed(1)}</div><div class="stat-label">Landfill</div></div>
<div class="stat-card"><div class="stat-value" style="color:${parseFloat(rate)>=75?'var(--accent-primary)':'var(--accent-warning)'}">${rate}%</div><div class="stat-label">Rate</div></div>
</div>
<div style="font-size:13px;font-weight:600;margin:12px 0 8px">Monthly Breakdown</div>
<table class="density-table">
<thead><tr><th>Month</th><th>Tickets</th><th>Tons</th><th>Diverted</th><th>Rate</th></tr></thead>
<tbody>${Object.entries(months).sort(([a],[b]) => a.localeCompare(b)).map(([m, d]) => {
const mr = d.tons > 0 ? ((d.diverted/d.tons)*100).toFixed(1) : '0.0';
return `<tr><td>${m}</td><td>${d.tickets}</td><td>${d.tons.toFixed(1)}</td><td>${d.diverted.toFixed(1)}</td><td style="color:${parseFloat(mr)>=75?'var(--accent-primary)':'var(--accent-warning)'}">${mr}%</td></tr>`;
}).join('')}</tbody>
</table>`;

document.getElementById('reportOutput').innerHTML = reportHTML;
document.getElementById('reportOutput').style.display = 'block';
hideLoading();
}

// â”€â”€ PDF REPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateLEEDPDF() {
if (!allTickets.length) { toast('No tickets', 'error'); return; }
const { jsPDF } = window.jspdf;
const doc = new jsPDF();

const totalTons = allTickets.reduce((s,t) => s + (t.tons||0), 0);
const divertedTons = allTickets.reduce((s,t) => s + (t.tons||0)*(t.diversion_pct||0)/100, 0);
const rate = totalTons > 0 ? ((divertedTons/totalTons)*100).toFixed(1) : '0.0';

// Header
doc.setFillColor(16, 185, 129);
doc.rect(0, 0, 210, 30, 'F');
doc.setTextColor(255, 255, 255);
doc.setFontSize(18);
doc.text('DivertScanâ„¢ LEED Waste Diversion Report', 105, 15, { align: 'center' });
doc.setFontSize(10);
doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 23, { align: 'center' });

// Project Info
doc.setTextColor(30, 30, 30);
doc.setFontSize(12);
let y = 40;
doc.text(`Project: ${currentProject?.name || ''}`, 15, y); y += 6;
doc.text(`Address: ${currentProject?.address || ''}`, 15, y); y += 6;
doc.text(`Contractor: ${currentProject?.contractor || ''}`, 15, y); y += 6;
doc.text(`Hauler: ${currentProject?.hauler || ''}`, 15, y); y += 10;

// Summary
doc.setFontSize(14);
doc.text('Summary', 15, y); y += 8;
doc.setFontSize(11);
doc.text(`Total Weight: ${totalTons.toFixed(2)} tons`, 15, y); y += 6;
doc.text(`Diverted: ${divertedTons.toFixed(2)} tons`, 15, y); y += 6;
doc.text(`Landfill: ${(totalTons - divertedTons).toFixed(2)} tons`, 15, y); y += 6;
doc.text(`Diversion Rate: ${rate}%`, 15, y); y += 6;
doc.text(`LEED Target: ${currentProject?.leed_target || 75}%`, 15, y); y += 6;
doc.text(`Status: ${parseFloat(rate) >= (currentProject?.leed_target||75) ? 'ON TRACK âœ“' : 'BELOW TARGET'}`, 15, y); y += 12;

// Ticket table header
doc.setFontSize(10);
doc.setFillColor(240, 240, 240);
doc.rect(15, y-3, 180, 7, 'F');
doc.text('Date', 17, y+1);
doc.text('Ticket #', 45, y+1);
doc.text('Tons', 80, y+1);
doc.text('Diversion', 105, y+1);
doc.text('Hauler', 135, y+1);
y += 9;

allTickets.forEach((t, i) => {
if (y > 275) { doc.addPage(); y = 20; }
if (i % 2 === 0) { doc.setFillColor(248, 248, 248); doc.rect(15, y-3, 180, 6, 'F'); }
doc.setFontSize(9);
doc.text(t.service_date || '', 17, y);
doc.text(t.ticket_number || '', 45, y);
doc.text((t.tons||0).toFixed(2), 80, y);
doc.text((t.diversion_pct||0) + '%', 105, y);
doc.text((t.hauler||'').substring(0,20), 135, y);
y += 6;
});

// Footer
const pages = doc.internal.getNumberOfPages();
for (let i = 1; i <= pages; i++) {
doc.setPage(i);
doc.setFontSize(8);
doc.setTextColor(150);
doc.text('Â© 2026 DivertScanâ„¢. All Rights Reserved.', 105, 287, { align: 'center' });
doc.text(`Page ${i} of ${pages}`, 195, 287, { align: 'right' });
}

doc.save(`DivertScan_LEED_${currentProject?.name?.replace(/[^a-zA-Z0-9]/g,'_') || 'Report'}.pdf`);
toast('PDF downloaded', 'success');
}

// â”€â”€ AI ANALYSIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleDebrisPhoto(input, index) {
if (!input.files.length) return;
const reader = new FileReader();
reader.onload = (e) => {
debrisPhotos[index] = e.target.result;
const preview = document.getElementById('debrisPreview');
preview.style.display = 'flex';
preview.style.gap = '8px';
preview.innerHTML = debrisPhotos.filter(Boolean).map((p,i) =>
`<img src="${p}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid var(--accent-primary)">`
).join('');
};
reader.readAsDataURL(input.files[0]);
}

async function runAIAnalysis() {
const photos = debrisPhotos.filter(Boolean);
if (!photos.length) { toast('Add at least one photo', 'error'); return; }

const apiKey = localStorage.getItem('ds_anthropic_key');
if (!apiKey) { toast('Set your Anthropic API key in Settings', 'error'); return; }

showLoading('AI analyzing debris...');
const containerSize = document.getElementById('containerSize').value;

try {
const content = [];
content.push({ type: 'text', text: `You are an expert C&D waste analyst. Analyze these debris pile photo(s) from a ${containerSize}-yard roll-off container. Identify materials by VOLUME percentage (not surface area). Return ONLY valid JSON: {"materials":{"wood":N,"gypsum":N,"plastic":N,"occ":N,"metal":N,"concrete":N,"block":N,"trash":N},"confidence":"high|medium|low","notes":"brief observation"}. Percentages must sum to 100. Be conservative and realistic.` });

for (const photo of photos) {
content.push({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: photo.split(',')[1] }});
}

const resp = await fetch('https://api.anthropic.com/v1/messages', {
method: 'POST',
headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 500, messages: [{ role: 'user', content }] })
});

const data = await resp.json();
const text = data.content?.[0]?.text || '';
const jsonMatch = text.match(/\{[\s\S]*\}/);
if (!jsonMatch) throw new Error('No JSON in response');

const result = JSON.parse(jsonMatch[0]);
hideLoading();
displayAIResults(result);
} catch(e) {
hideLoading();
toast('AI analysis failed: ' + e.message, 'error');
}
}

function displayAIResults(result) {
const el = document.getElementById('aiResults');
const m = result.materials || {};
const conf = result.confidence || 'unknown';
const confColor = conf === 'high' ? 'var(--accent-primary)' : conf === 'medium' ? 'var(--accent-warning)' : 'var(--accent-danger)';

el.style.display = 'block';
el.innerHTML = `
<div style="padding:12px;background:var(--bg-tertiary);border-radius:var(--radius-sm);border-left:3px solid ${confColor}">
<div style="font-size:12px;font-weight:600;margin-bottom:8px">AI Results <span style="color:${confColor};font-size:10px">(${conf} confidence)</span></div>
${Object.entries(m).map(([k,v]) => v > 0 ? `
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
<span style="font-size:12px;text-transform:capitalize">${k}</span>
<div style="display:flex;align-items:center;gap:8px">
<div style="width:100px;height:6px;background:var(--bg-primary);border-radius:3px;overflow:hidden"><div style="width:${v}%;height:100%;background:var(--accent-primary);border-radius:3px"></div></div>
<span style="font-size:12px;font-weight:600;width:35px;text-align:right">${v}%</span>
</div></div>` : '').join('')}
${result.notes ? `<div style="font-size:11px;color:var(--text-muted);margin-top:8px">${result.notes}</div>` : ''}
<button class="btn btn-primary btn-block" onclick="applyAIToTicket(${JSON.stringify(m).replace(/"/g,'&quot;')})" style="margin-top:12px">âœ… Apply to New Ticket</button>
</div>`;
}

function applyAIToTicket(materials) {
startNewTicket();
document.getElementById('fWood').value = materials.wood || 0;
document.getElementById('fGypsum').value = materials.gypsum || 0;
document.getElementById('fPlastic').value = materials.plastic || 0;
document.getElementById('fOCC').value = materials.occ || 0;
document.getElementById('fMetal').value = materials.metal || 0;
document.getElementById('fConcrete').value = materials.concrete || 0;
document.getElementById('fBlock').value = materials.block || 0;
calcDiversion();
toast('AI results applied to ticket', 'success');
}

function handleScaleTicket(input) {
if (!input.files.length) return;
toast('OCR processing â€” for full OCR, use the Anthropic API in Settings', 'info');
// Placeholder: would call AI vision for OCR
}

// â”€â”€ EXPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportCSV() {
if (!allTickets.length) { toast('No tickets', 'error'); return; }
const headers = ['Date','Ticket #','Hauler','Gross (lbs)','Tare (lbs)','Net (lbs)','Tons','Wood %','Gypsum %','Plastic %','OCC %','Metal %','Concrete %','Block %','Diversion %'];
const rows = allTickets.map(t => [t.service_date,t.ticket_number,t.hauler,t.gross_weight,t.tare_weight,t.net_weight,t.tons,t.wood_pct,t.gypsum_pct,t.plastic_pct,t.occ_pct,t.metal_pct,t.concrete_pct,t.block_pct,t.diversion_pct]);
let csv = headers.join(',') + '\n';
rows.forEach(r => { csv += r.map(c => '"' + (c||'') + '"').join(',') + '\n'; });
downloadBlob(csv, 'text/csv', `DivertScan_${new Date().toISOString().split('T')[0]}.csv`);
toast('CSV exported', 'success');
}

function exportJSON() {
const backup = { version: APP_VERSION, exported: new Date().toISOString(), project: currentProject, tickets: allTickets };
downloadBlob(JSON.stringify(backup, null, 2), 'application/json', `DivertScan_Backup_${new Date().toISOString().split('T')[0]}.json`);
toast('JSON backup exported', 'success');
}

async function createFullBackup() {
const projects = await idbGetAll('projects');
const tickets = await idbGetAll('tickets');
const backup = { version: APP_VERSION, exported: new Date().toISOString(), projects, tickets };
downloadBlob(JSON.stringify(backup, null, 2), 'application/json', `DivertScan_FullBackup_${new Date().toISOString().split('T')[0]}.json`);
toast('Full backup created', 'success');
}

async function restoreBackup(input) {
if (!input.files.length) return;
if (!confirm('This will replace ALL current data. Continue?')) { input.value=''; return; }
showLoading('Restoring backup...');
try {
const text = await input.files[0].text();
const data = JSON.parse(text);
if (data.projects) { await idbClear('projects'); for (const p of data.projects) await idbPut('projects', p); }
if (data.tickets) { await idbClear('tickets'); for (const t of data.tickets) await idbPut('tickets', t); }
await loadProjects();
await loadTickets();
hideLoading();
toast('Backup restored', 'success');
} catch(e) { hideLoading(); toast('Restore failed: ' + e.message, 'error'); }
input.value = '';
}

function generateExecSummary() { toast('Executive Summary coming soon', 'info'); }
function generateV5Report() { toast('LEED v5 Report coming soon', 'info'); }

function downloadBlob(content, type, filename) {
const blob = new Blob([content], { type });
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
a.download = filename;
a.click();
}

// â”€â”€ SUPABASE CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSavedConfig() {
const url = localStorage.getItem('ds_supa_url');
const key = localStorage.getItem('ds_supa_key');
if (url && key) {
try {
sb = window.supabase.createClient(url, key);
} catch(e) { sb = null; }
}
const el1 = document.getElementById('setSupaUrl');
const el2 = document.getElementById('setSupaKey');
if (el1) el1.value = url || '';
if (el2) el2.value = key || '';

const aiKey = localStorage.getItem('ds_anthropic_key');
const el3 = document.getElementById('setAnthropicKey');
if (el3) el3.value = aiKey || '';
}

function saveSupabaseConfig() {
const url = document.getElementById('setSupaUrl').value.trim();
const key = document.getElementById('setSupaKey').value.trim();
if (url && key) {
localStorage.setItem('ds_supa_url', url);
localStorage.setItem('ds_supa_key', key);
try {
sb = window.supabase.createClient(url, key);
document.getElementById('supaStatus').textContent = 'âœ… Connected';
toast('Supabase connected', 'success');
} catch(e) {
document.getElementById('supaStatus').textContent = 'âŒ Error: ' + e.message;
}
} else {
localStorage.removeItem('ds_supa_url');
localStorage.removeItem('ds_supa_key');
sb = null;
document.getElementById('supaStatus').textContent = 'Disconnected';
toast('Supabase cleared', 'info');
}
}

function saveAIConfig() {
const key = document.getElementById('setAnthropicKey').value.trim();
localStorage.setItem('ds_anthropic_key', key);
toast(key ? 'AI key saved' : 'AI key cleared', 'success');
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tabId) {
document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
const panel = document.getElementById('tab-' + tabId);
if (panel) panel.classList.add('active');
const navItems = document.querySelectorAll('.nav-item');
const tabMap = ['dashboard','scan','tickets','projects','reports','settings'];
const idx = tabMap.indexOf(tabId);
if (idx >= 0 && navItems[idx]) navItems[idx].classList.add('active');
document.getElementById('mainContent').scrollTop = 0;
}

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTheme(theme) {
if (theme) document.documentElement.setAttribute('data-theme', theme);
else document.documentElement.removeAttribute('data-theme');
localStorage.setItem('ds_theme', theme);
toast('Theme updated', 'success');
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info') {
const container = document.getElementById('toastContainer');
const el = document.createElement('div');
el.className = 'toast ' + type;
el.textContent = msg;
container.appendChild(el);
setTimeout(() => el.remove(), 3000);
}

// â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoading(text) {
document.getElementById('loadingText').textContent = text || 'Loading...';
document.getElementById('loadingOverlay').classList.add('active');
}
function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }

// â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSyncStatus() {
toast(sb ? 'Supabase connected â€” syncing...' : 'Offline mode (IndexedDB only)', 'info');
if (sb) loadTickets();
}

function showSettings() { showTab('settings'); }

async function factoryReset() {
if (!confirm('âš ï¸ FACTORY RESET: Delete ALL data?')) return;
if (!confirm('This will delete ALL projects, tickets, and settings. Type YES to confirm.')) return;
await idbClear('tickets');
await idbClear('projects');
await idbClear('settings');
localStorage.clear();
location.reload();
}

// Enter key on login
document.getElementById('loginPass')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') doLogin(); });
document.getElementById('loginUser')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });

// Click outside modal to close
document.getElementById('modalOverlay')?.addEventListener('click', (e) => { if (e.target.id === 'modalOverlay') closeModal(); });
</script>
</body>
</html>
