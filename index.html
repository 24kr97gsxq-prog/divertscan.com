<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DivertScan">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="DivertScan‚Ñ¢ - AI-Powered LEED v5 MRp2 Construction Waste Carbon Auditor">

    <title>DivertScan‚Ñ¢ | LEED v5 Carbon Auditor</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%2310b981' rx='20' width='100' height='100'/><text x='50' y='68' font-size='50' text-anchor='middle' fill='white'>‚ôª</text></svg>">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --slate-900: #0f172a; --slate-800: #1e293b; --slate-700: #334155;
            --slate-600: #475569; --slate-500: #64748b; --slate-400: #94a3b8;
            --emerald-500: #10b981; --emerald-400: #34d399; --emerald-600: #059669;
            --sky-500: #0ea5e9; --sky-400: #38bdf8; --sky-600: #0284c7;
            --amber-500: #f59e0b; --red-500: #ef4444;
        }
        
        html {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--slate-900) 0%, var(--slate-800) 50%, var(--slate-900) 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { min-height: 100vh; padding: 16px; padding-bottom: 32px; color: white; }
        
        .header { text-align: center; margin-bottom: 24px; }
        .logo-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 4px; }
        .logo-icon { width: 32px; height: 32px; background: var(--emerald-500); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 20px; height: 20px; color: white; }
        .logo-text { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        .tagline { color: var(--emerald-400); font-size: 14px; font-weight: 500; }
        .project-name { color: var(--slate-400); font-size: 12px; margin-top: 4px; }
        
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
        .action-btn {
            border: none; font-family: inherit; font-weight: 700; padding: 20px 16px;
            border-radius: 16px; cursor: pointer; transition: all 0.2s ease;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .action-btn:active { transform: scale(0.96); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .action-btn.scan { background: linear-gradient(135deg, var(--emerald-500) 0%, var(--emerald-600) 100%); box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3); color: white; }
        .action-btn.generate { background: linear-gradient(135deg, var(--sky-500) 0%, var(--sky-600) 100%); box-shadow: 0 8px 24px rgba(14, 165, 233, 0.3); color: white; }
        .action-btn svg { width: 32px; height: 32px; }
        .action-btn span { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .action-btn.loading svg { animation: pulse 1s infinite; }
        .action-btn.loading.generate svg { animation: spin 1s linear infinite; }
        
        .card {
            background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(10px);
            border-radius: 24px; padding: 24px; margin-bottom: 24px;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .card-title { color: var(--slate-400); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; text-align: center; }
        
        .gauge-container { display: flex; justify-content: center; }
        .gauge { position: relative; width: 192px; height: 192px; }
        .gauge svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .gauge-bg { fill: none; stroke: var(--slate-700); stroke-width: 12; }
        .gauge-progress { fill: none; stroke: url(#gaugeGradient); stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1.5s ease-out; }
        .gauge-center { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .gauge-value { font-size: 36px; font-weight: 700; }
        .gauge-unit { color: var(--slate-400); font-size: 14px; }
        .gauge-percent { color: var(--emerald-400); font-size: 12px; margin-top: 4px; }
        
        .hotspot-item { margin-bottom: 16px; }
        .hotspot-item:last-child { margin-bottom: 0; }
        .hotspot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .hotspot-name { font-weight: 500; font-size: 14px; }
        .hotspot-percent { color: var(--slate-400); font-size: 14px; }
        .hotspot-bar-bg { height: 12px; background: var(--slate-700); border-radius: 6px; overflow: hidden; }
        .hotspot-bar { height: 100%; border-radius: 6px; transition: width 1.2s ease-out; }
        .hotspot-bar.concrete { background: var(--slate-500); }
        .hotspot-bar.aluminum { background: var(--sky-500); }
        .hotspot-bar.steel { background: var(--amber-500); }
        .hotspot-mt { text-align: right; margin-top: 4px; color: var(--slate-500); font-size: 11px; }
        
        .audit-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .audit-header svg { width: 16px; height: 16px; color: var(--emerald-400); }
        .audit-title { color: var(--slate-400); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .verified-badge { margin-left: auto; background: rgba(16, 185, 129, 0.2); color: var(--emerald-400); font-size: 11px; font-weight: 500; padding: 2px 10px; border-radius: 100px; }
        .hash-box { background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 12px; border: 1px solid rgba(51, 65, 85, 0.3); }
        .hash-label { color: var(--slate-500); font-size: 11px; margin-bottom: 4px; }
        .hash-value { color: var(--sky-400); font-family: 'JetBrains Mono', monospace; font-size: 12px; word-break: break-all; line-height: 1.6; }
        .audit-footer { color: var(--slate-600); font-size: 11px; text-align: center; margin-top: 12px; }
        
        .footer { text-align: center; margin-top: 24px; color: var(--slate-600); font-size: 11px; }
        
        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--slate-800); border: 1px solid var(--slate-700);
            padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 500;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); opacity: 0; transition: all 0.3s ease; z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--emerald-500); color: var(--emerald-400); }
        .toast.info { border-color: var(--sky-500); color: var(--sky-400); }
        .toast.error { border-color: var(--red-500); color: var(--red-500); }
        
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 16px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--slate-800); border-radius: 24px; padding: 24px;
            max-width: 400px; width: 100%; max-height: 80vh; overflow-y: auto;
            border: 1px solid var(--slate-700);
        }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; text-align: center; }
        
        .scan-result { margin-top: 16px; }
        .scan-result-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--slate-700); }
        .scan-result-item:last-child { border-bottom: none; }
        .scan-result-label { color: var(--slate-400); font-size: 13px; }
        .scan-result-value { font-weight: 600; font-size: 14px; }
        
        .btn-primary {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: var(--emerald-500); color: white; font-weight: 700;
            font-size: 14px; cursor: pointer; margin-top: 16px;
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            width: 100%; padding: 16px; border: 1px solid var(--slate-600); border-radius: 12px;
            background: transparent; color: var(--slate-300); font-weight: 600;
            font-size: 14px; cursor: pointer; margin-top: 8px;
        }
        
        .recent-scans { margin-top: 8px; }
        .scan-entry {
            background: rgba(15, 23, 42, 0.5); border-radius: 12px; padding: 12px;
            margin-bottom: 8px; border: 1px solid var(--slate-700);
        }
        .scan-entry-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .scan-entry-material { font-weight: 600; font-size: 14px; }
        .scan-entry-weight { color: var(--emerald-400); font-size: 14px; }
        .scan-entry-details { display: flex; gap: 16px; font-size: 11px; color: var(--slate-500); }
        
        #cameraInput { display: none; }
        
        .preview-container { margin: 16px 0; text-align: center; }
        .preview-image { max-width: 100%; max-height: 200px; border-radius: 12px; }
        .analyzing-text { color: var(--sky-400); font-size: 14px; margin-top: 12px; }
    </style>
</head>
<body>
    <input type="file" id="cameraInput" accept="image/*" capture="environment">

    <header class="header">
        <div class="logo-row">
            <div class="logo-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
            </div>
            <h1 class="logo-text">DivertScan‚Ñ¢</h1>
        </div>
        <p class="tagline">LEED v5 MRp2 Carbon Auditor</p>
        <p class="project-name" id="projectName">Evergreen Commercial Tower</p>
    </header>

    <div class="button-grid">
        <button class="action-btn scan" id="scanBtn" onclick="openCamera()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
            </svg>
            <span id="scanText">Scan Scale Ticket</span>
        </button>
        
        <button class="action-btn generate" id="generateBtn" onclick="generatePDF()">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <span id="generateText">Generate LEED PDF</span>
        </button>
    </div>

    <div class="card">
        <h2 class="card-title">Total Embodied Carbon</h2>
        <div class="gauge-container">
            <div class="gauge">
                <svg viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#10b981"/>
                            <stop offset="50%" stop-color="#f59e0b"/>
                            <stop offset="100%" stop-color="#ef4444"/>
                        </linearGradient>
                    </defs>
                    <circle class="gauge-bg" cx="100" cy="100" r="85"/>
                    <circle class="gauge-progress" id="gaugeProgress" cx="100" cy="100" r="85"/>
                </svg>
                <div class="gauge-center">
                    <span class="gauge-value" id="gaugeValue">0</span>
                    <span class="gauge-unit">MT CO‚ÇÇe</span>
                    <span class="gauge-percent" id="gaugePercent">0% of target</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title">Recent Scans</h2>
        <div class="recent-scans" id="recentScans">
            <p style="color: var(--slate-500); text-align: center; font-size: 13px;">No scans yet. Tap "Scan Scale Ticket" to begin.</p>
        </div>
    </div>

    <div class="card">
        <h2 class="card-title">Carbon Hotspots</h2>
        <div id="hotspotsContainer">
            <div class="hotspot-item">
                <div class="hotspot-header">
                    <span class="hotspot-name">Concrete-Mix-A</span>
                    <span class="hotspot-percent">43.95%</span>
                </div>
                <div class="hotspot-bar-bg">
                    <div class="hotspot-bar concrete" style="width: 43.95%"></div>
                </div>
                <div class="hotspot-mt">2,249.75 MT</div>
            </div>
            <div class="hotspot-item">
                <div class="hotspot-header">
                    <span class="hotspot-name">Aluminum</span>
                    <span class="hotspot-percent">33.21%</span>
                </div>
                <div class="hotspot-bar-bg">
                    <div class="hotspot-bar aluminum" style="width: 33.21%"></div>
                </div>
                <div class="hotspot-mt">1,700.18 MT</div>
            </div>
            <div class="hotspot-item">
                <div class="hotspot-header">
                    <span class="hotspot-name">Steel</span>
                    <span class="hotspot-percent">19.53%</span>
                </div>
                <div class="hotspot-bar-bg">
                    <div class="hotspot-bar steel" style="width: 19.53%"></div>
                </div>
                <div class="hotspot-mt">999.84 MT</div>
            </div>
        </div>
    </div>

    <div class="card" style="padding: 20px;">
        <div class="audit-header">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
            </svg>
            <span class="audit-title">Audit Verification</span>
            <span class="verified-badge">VERIFIED</span>
        </div>
        <div class="hash-box">
            <p class="hash-label">SHA-256 Hash</p>
            <p class="hash-value" id="hashValue">Calculating...</p>
        </div>
        <p class="audit-footer">Tamper-proof audit trail for LEED v5 compliance</p>
    </div>

    <footer class="footer">
        <p>DivertScan‚Ñ¢ ¬© Dalmex Recycling LLC</p>
    </footer>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="scanModal">
        <div class="modal">
            <h3 class="modal-title" id="modalTitle">Analyzing Ticket...</h3>
            
            <div class="preview-container" id="previewContainer">
                <img id="previewImage" class="preview-image" src="" alt="Ticket preview">
                <p class="analyzing-text" id="analyzingText">üîç GPT-4 Vision analyzing...</p>
            </div>
            
            <div class="scan-result" id="scanResult" style="display: none;">
                <div class="scan-result-item">
                    <span class="scan-result-label">Material</span>
                    <span class="scan-result-value" id="resultMaterial">‚Äî</span>
                </div>
                <div class="scan-result-item">
                    <span class="scan-result-label">Weight</span>
                    <span class="scan-result-value" id="resultWeight">‚Äî</span>
                </div>
                <div class="scan-result-item">
                    <span class="scan-result-label">Hauler</span>
                    <span class="scan-result-value" id="resultHauler">‚Äî</span>
                </div>
                <div class="scan-result-item">
                    <span class="scan-result-label">Date</span>
                    <span class="scan-result-value" id="resultDate">‚Äî</span>
                </div>
                <div class="scan-result-item">
                    <span class="scan-result-label">Ticket #</span>
                    <span class="scan-result-value" id="resultTicket">‚Äî</span>
                </div>
                <div class="scan-result-item">
                    <span class="scan-result-label">CO‚ÇÇe Impact</span>
                    <span class="scan-result-value" id="resultCO2" style="color: var(--emerald-400);">‚Äî</span>
                </div>
            </div>
            
            <button class="btn-primary" id="confirmBtn" onclick="confirmScan()" style="display: none;">
                ‚úì Confirm & Add to Project
            </button>
            <button class="btn-secondary" id="cancelBtn" onclick="closeModal()">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // ============ CONFIGURATION ============
        let OPENAI_API_KEY = localStorage.getItem('divertscan_api_key') || '';
        
        function checkApiKey() {
            if (!OPENAI_API_KEY) {
                const key = prompt('Enter your OpenAI API key (starts with sk-):');
                if (key && key.startsWith('sk-')) {
                    OPENAI_API_KEY = key;
                    localStorage.setItem('divertscan_api_key', key);
                    showToast('API key saved!', 'success');
                    return true;
                } else {
                    showToast('Invalid API key', 'error');
                    return false;
                }
            }
            return true;
        }
        
        // Carbon emission factors (MT CO2e per ton of material)
        const EMISSION_FACTORS = {
            'concrete': 0.159,
            'steel': 1.85,
            'aluminum': 11.89,
            'wood': 0.03,
            'drywall': 0.12,
            'asphalt': 0.05,
            'glass': 0.85,
            'plastic': 2.5,
            'cardboard': 0.94,
            'mixed c&d': 0.15,
            'default': 0.15
        };
        
        // ============ STATE ============
        let projectData = JSON.parse(localStorage.getItem('divertscan_data')) || {
            name: "Evergreen Commercial Tower",
            totalCO2e: 0,
            maxCO2e: 8000,
            scans: [],
            materials: {}
        };
        
        let currentScanResult = null;
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('projectName').textContent = projectData.name;
            updateGauge();
            renderRecentScans();
            updateHotspots();
            updateHash();
            document.getElementById('cameraInput').addEventListener('change', handleImageCapture);
        });
        
        // ============ CAMERA & SCAN ============
        function openCamera() {
            if (!checkApiKey()) return;
            document.getElementById('cameraInput').click();
        }
        
        async function handleImageCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const modal = document.getElementById('scanModal');
            const preview = document.getElementById('previewImage');
            const previewContainer = document.getElementById('previewContainer');
            const scanResult = document.getElementById('scanResult');
            const confirmBtn = document.getElementById('confirmBtn');
            const analyzingText = document.getElementById('analyzingText');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = 'Analyzing Ticket...';
            previewContainer.style.display = 'block';
            scanResult.style.display = 'none';
            confirmBtn.style.display = 'none';
            analyzingText.style.display = 'block';
            analyzingText.style.color = 'var(--sky-400)';
            analyzingText.textContent = 'üîç GPT-4 Vision analyzing...';
            
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; };
            reader.readAsDataURL(file);
            
            modal.classList.add('show');
            
            try {
                const base64 = await fileToBase64(file);
                const result = await analyzeWithGPT4Vision(base64);
                
                if (result.success) {
                    displayScanResult(result.data);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Scan error:', error);
                modalTitle.textContent = 'Scan Failed';
                analyzingText.textContent = '‚ùå ' + error.message;
                analyzingText.style.color = 'var(--red-500)';
            }
            
            event.target.value = '';
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        async function analyzeWithGPT4Vision(base64Image) {
            const prompt = `Analyze this scale ticket / weight ticket image and extract the following information. Return ONLY valid JSON with these fields:
{
    "material": "type of material (e.g., concrete, steel, wood, drywall, mixed C&D, etc.)",
    "weight_tons": numeric weight in TONS (convert if necessary),
    "hauler": "company name on ticket",
    "date": "date on ticket in YYYY-MM-DD format",
    "ticket_number": "ticket or receipt number",
    "confidence": "high/medium/low"
}
If any field cannot be determined, use null. Be precise with the weight - this is critical for carbon calculations.`;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{
                            role: 'user',
                            content: [
                                { type: 'text', text: prompt },
                                { type: 'image_url', image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                            ]
                        }],
                        max_tokens: 500
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Could not parse ticket data');
                
                return { success: true, data: JSON.parse(jsonMatch[0]) };
                
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    return { success: false, error: 'Request timed out. Check your connection.' };
                }
                return { success: false, error: error.message };
            }
        }
        
        function displayScanResult(data) {
            currentScanResult = data;
            
            const modalTitle = document.getElementById('modalTitle');
            const analyzingText = document.getElementById('analyzingText');
            const scanResult = document.getElementById('scanResult');
            const confirmBtn = document.getElementById('confirmBtn');
            
            modalTitle.textContent = '‚úì Ticket Scanned';
            analyzingText.style.display = 'none';
            scanResult.style.display = 'block';
            confirmBtn.style.display = 'block';
            
            const material = (data.material || 'mixed c&d').toLowerCase();
            const weight = data.weight_tons || 0;
            const emissionFactor = EMISSION_FACTORS[material] || EMISSION_FACTORS['default'];
            const co2e = (weight * emissionFactor).toFixed(4);
            
            currentScanResult.co2e = parseFloat(co2e);
            
            document.getElementById('resultMaterial').textContent = data.material || 'Unknown';
            document.getElementById('resultWeight').textContent = weight ? `${weight} tons` : 'Unknown';
            document.getElementById('resultHauler').textContent = data.hauler || 'Unknown';
            document.getElementById('resultDate').textContent = data.date || new Date().toISOString().split('T')[0];
            document.getElementById('resultTicket').textContent = data.ticket_number || 'N/A';
            document.getElementById('resultCO2').textContent = `+${parseFloat(co2e).toFixed(2)} MT CO‚ÇÇe`;
        }
        
        function confirmScan() {
            if (!currentScanResult) return;
            
            const scan = {
                id: Date.now(),
                ...currentScanResult,
                timestamp: new Date().toISOString()
            };
            
            projectData.scans.unshift(scan);
            projectData.totalCO2e = parseFloat((projectData.totalCO2e + currentScanResult.co2e).toFixed(4));
            
            const material = (currentScanResult.material || 'Other').toLowerCase();
            projectData.materials[material] = parseFloat(((projectData.materials[material] || 0) + currentScanResult.co2e).toFixed(4));
            
            localStorage.setItem('divertscan_data', JSON.stringify(projectData));
            
            updateGauge();
            renderRecentScans();
            updateHotspots();
            updateHash();
            
            closeModal();
            showToast('Scan added to project!', 'success');
        }
        
        function closeModal() {
            document.getElementById('scanModal').classList.remove('show');
            currentScanResult = null;
        }
        
        // ============ UI UPDATES ============
        function updateGauge() {
            const circumference = 2 * Math.PI * 85;
            const percentage = Math.min((projectData.totalCO2e / projectData.maxCO2e) * 100, 100);
            const offset = circumference - (percentage / 100) * circumference;
            
            document.getElementById('gaugeProgress').style.strokeDasharray = circumference;
            document.getElementById('gaugeProgress').style.strokeDashoffset = offset;
            document.getElementById('gaugeValue').textContent = projectData.totalCO2e.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('gaugePercent').textContent = `${percentage.toFixed(1)}% of target`;
        }
        
        function renderRecentScans() {
            const container = document.getElementById('recentScans');
            
            if (projectData.scans.length === 0) {
                container.innerHTML = '<p style="color: var(--slate-500); text-align: center; font-size: 13px;">No scans yet. Tap "Scan Scale Ticket" to begin.</p>';
                return;
            }
            
            container.innerHTML = projectData.scans.slice(0, 5).map(scan => `
                <div class="scan-entry">
                    <div class="scan-entry-header">
                        <span class="scan-entry-material">${scan.material || 'Unknown'}</span>
                        <span class="scan-entry-weight">+${scan.co2e?.toFixed(2) || '0.00'} MT</span>
                    </div>
                    <div class="scan-entry-details">
                        <span>${scan.weight_tons || '?'} tons</span>
                        <span>${scan.hauler || 'Unknown'}</span>
                        <span>${scan.date || ''}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function updateHotspots() {
            const container = document.getElementById('hotspotsContainer');
            const materials = Object.entries(projectData.materials).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            if (materials.length === 0) {
                container.innerHTML = '<p style="color: var(--slate-500); text-align: center; font-size: 13px;">No data yet.</p>';
                return;
            }
            
            const total = Object.values(projectData.materials).reduce((a, b) => a + b, 0);
            const colors = ['concrete', 'aluminum', 'steel'];
            
            container.innerHTML = materials.map(([name, co2], i) => {
                const pct = total > 0 ? ((co2 / total) * 100).toFixed(2) : 0;
                return `
                    <div class="hotspot-item">
                        <div class="hotspot-header">
                            <span class="hotspot-name">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                            <span class="hotspot-percent">${pct}%</span>
                        </div>
                        <div class="hotspot-bar-bg">
                            <div class="hotspot-bar ${colors[i]}" style="width: ${pct}%"></div>
                        </div>
                        <div class="hotspot-mt">${co2.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MT</div>
                    </div>
                `;
            }).join('');
        }
        
        async function updateHash() {
            const dataString = JSON.stringify(projectData);
            const encoder = new TextEncoder();
            const data = encoder.encode(dataString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            document.getElementById('hashValue').textContent = hashHex.slice(0, 32) + '...';
        }
        
        // ============ PDF GENERATION ============
        function generatePDF() {
            const btn = document.getElementById('generateBtn');
            const text = document.getElementById('generateText');
            
            btn.classList.add('loading');
            text.textContent = 'Generating...';
            
            setTimeout(async () => {
                btn.classList.remove('loading');
                text.textContent = 'Generate LEED PDF';
                
                const hashEl = document.getElementById('hashValue').textContent;
                
                const summary = `LEED v5 MRp2 Carbon Audit Report
=====================================
Project: ${projectData.name}
Generated: ${new Date().toLocaleString()}
SHA-256 Hash: ${hashEl}

SUMMARY
-------
Total Embodied Carbon: ${projectData.totalCO2e.toFixed(2)} MT CO‚ÇÇe
Target Maximum: ${projectData.maxCO2e.toFixed(2)} MT CO‚ÇÇe
Progress: ${((projectData.totalCO2e / projectData.maxCO2e) * 100).toFixed(1)}%
Total Scans: ${projectData.scans.length}

TOP CARBON HOTSPOTS
-------------------
${Object.entries(projectData.materials)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([mat, co2], i) => `${i + 1}. ${mat.charAt(0).toUpperCase() + mat.slice(1)}: ${co2.toFixed(2)} MT CO‚ÇÇe`)
    .join('\n')}

SCAN LOG
--------
${projectData.scans.slice(0, 20).map(s => 
    `[${s.date || 'N/A'}] ${s.material || 'Unknown'} - ${s.weight_tons || 0} tons - ${s.co2e?.toFixed(2) || '0.00'} MT CO‚ÇÇe - Ticket #${s.ticket_number || 'N/A'}`
).join('\n')}

=====================================
This report was generated by DivertScan‚Ñ¢
GBCI Audit-Ready | SHA-256 Verified
`;
                
                const blob = new Blob([summary], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DivertScan_LEED_Report_${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Report downloaded!', 'info');
            }, 1500);
        }
        
        // ============ UTILITIES ============
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
