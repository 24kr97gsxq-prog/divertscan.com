<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan Â© 2026 | The Carbon Truth in Every Load</title>
    <meta name="description" content="LEED-compliant waste diversion tracking with Point-of-Capture Verification">
    
    <!-- Preconnect for faster loading -->
    <link rel="preconnect" href="https://rnaujdajnrlvndhmhvbk.supabase.co">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10b981;
            --accent: #f59e0b;
            --danger: #dc2626;
            --success: #16a34a;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #475569;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        #loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .loader-logo {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }
        .loader-logo span { color: var(--text-primary); }
        
        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-card);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loader-status {
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .loader-error {
            color: var(--danger);
            margin-top: 1rem;
            text-align: center;
            max-width: 300px;
        }
        .loader-error button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Main App */
        #app { display: none; }
        #app.loaded { display: block; }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-dark) 100%);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        .logo span { color: var(--text-primary); }
        .tagline {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: block;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--border); }
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        .btn-success {
            background: var(--success);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--bg-card);
            padding: 0.25rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .tab {
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active {
            background: var(--primary);
            color: white;
        }
        .tab:hover:not(.active) {
            background: var(--bg-input);
            color: var(--text-primary);
        }

        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-title svg {
            width: 20px;
            height: 20px;
            color: var(--primary);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-group input::placeholder { color: var(--text-muted); }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        tr:hover { background: rgba(5, 150, 105, 0.05); }
        tr:last-child td { border-bottom: none; }

        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-danger { background: rgba(220, 38, 38, 0.2); color: #f87171; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h3 { font-size: 1.125rem; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.5rem;
            line-height: 1;
        }
        .modal-body { padding: 1.5rem; }
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        /* File Upload */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.05);
        }
        .upload-zone input { display: none; }
        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--text-muted);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
        }
        .status-dot.connected { background: var(--success); }
        .status-dot.offline { background: var(--accent); }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            min-width: 300px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }

        /* Verification Badge */
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(5, 150, 105, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        .verification-badge svg {
            width: 16px;
            height: 16px;
            color: var(--primary);
        }

        /* GPS/IP Capture Display */
        .capture-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 0.75rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }
        .footer a { color: var(--primary); }

        /* Print styles */
        @media print {
            .header, .tabs, .btn, .footer { display: none; }
            .card { break-inside: avoid; }
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; }
            .header-actions .btn { flex: 1; justify-content: center; }
            .tabs { flex-wrap: nowrap; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader-logo">Divert<span>Scan</span></div>
        <div class="loader-spinner"></div>
        <div class="loader-status" id="loader-status">Initializing...</div>
        <div class="loader-error" id="loader-error" style="display:none;">
            <p id="error-message"></p>
            <button onclick="location.reload()">Retry</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div>
                    <div class="logo">Divert<span>Scan</span></div>
                    <span class="tagline">The Carbon Truth in Every Load</span>
                </div>
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-text">Connecting...</span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="exportExcel()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Export Excel
                    </button>
                    <button class="btn btn-secondary" onclick="exportLEEDReport()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        LEED Report
                    </button>
                    <button class="btn btn-primary" onclick="openNewLoadModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        New Load
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-loads">0</div>
                    <div class="stat-label">Total Loads</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-tonnage">0</div>
                    <div class="stat-label">Total Tons</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-diversion">0%</div>
                    <div class="stat-label">Diversion Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-carbon">0</div>
                    <div class="stat-label">COâ‚‚e Avoided (MT)</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="loads">Loads</button>
                <button class="tab" data-tab="projects">Projects</button>
                <button class="tab" data-tab="materials">Materials</button>
                <button class="tab" data-tab="reports">Reports</button>
                <button class="tab" data-tab="watchtower">Industry Watchtower</button>
            </div>

            <!-- Loads Tab -->
            <div class="tab-content active" id="tab-loads">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"/>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                            <circle cx="5.5" cy="18.5" r="2.5"/>
                            <circle cx="18.5" cy="18.5" r="2.5"/>
                        </svg>
                        Recent Loads
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Project</th>
                                    <th>Material</th>
                                    <th>Weight (tons)</th>
                                    <th>Destination</th>
                                    <th>Status</th>
                                    <th>Verified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="loads-table">
                                <tr>
                                    <td colspan="8" style="text-align:center;color:var(--text-muted);">
                                        Loading loads data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div class="tab-content" id="tab-projects">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                        </svg>
                        Active Projects
                    </div>
                    <div id="projects-list">
                        <p style="color:var(--text-muted);">Loading projects...</p>
                    </div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div class="tab-content" id="tab-materials">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        </svg>
                        Material Categories &amp; GWP Coefficients
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Category</th>
                                    <th>Default Density (lb/ydÂ³)</th>
                                    <th>GWP (MT COâ‚‚e/ton)</th>
                                    <th>LEED v5 Tier</th>
                                </tr>
                            </thead>
                            <tbody id="materials-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="tab-reports">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        Generate Reports
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project</label>
                            <select id="report-project">
                                <option value="">All Projects</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <select id="report-range">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;">
                        <button class="btn btn-primary" onclick="exportExcel()">Export Dalmex Excel (24-col)</button>
                        <button class="btn btn-secondary" onclick="exportLEEDReport()">LEED Compliance Report</button>
                        <button class="btn btn-secondary" onclick="exportAuditLog()">Audit Trail PDF</button>
                    </div>
                </div>
            </div>

            <!-- Industry Watchtower Tab -->
            <div class="tab-content" id="tab-watchtower">
                <div class="card">
                    <div class="card-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        Industry Watchtower - LEED v5 Updates
                    </div>
                    <div id="watchtower-content">
                        <div style="margin-bottom:1.5rem;">
                            <h4 style="color:var(--primary);margin-bottom:0.5rem;">ðŸŒ¿ LEED v5 Key Changes (2024-2025)</h4>
                            <ul style="color:var(--text-secondary);margin-left:1.25rem;">
                                <li>Tier 1 Circularity credits now provide enhanced weighted multipliers for reuse materials</li>
                                <li>Global Warming Potential (GWP) coefficients required for carbon tracking</li>
                                <li>Stricter chain-of-custody documentation requirements</li>
                                <li>Point-of-capture verification becoming industry standard</li>
                            </ul>
                        </div>
                        <div style="margin-bottom:1.5rem;">
                            <h4 style="color:var(--primary);margin-bottom:0.5rem;">ðŸ“° Recent Industry News</h4>
                            <div id="news-links"></div>
                        </div>
                        <div>
                            <h4 style="color:var(--primary);margin-bottom:0.5rem;">ðŸ”— Official Resources</h4>
                            <ul style="color:var(--text-secondary);margin-left:1.25rem;">
                                <li><a href="https://www.usgbc.org/leed" target="_blank" style="color:var(--primary);">USGBC LEED Official</a></li>
                                <li><a href="https://www.epa.gov/warm" target="_blank" style="color:var(--primary);">EPA WARM Calculator</a></li>
                                <li><a href="https://www.usgbc.org/credits/new-construction-core-and-shell-schools-new-construction-retail-new-construction-data-702" target="_blank" style="color:var(--primary);">MR Credit: Construction Waste Management</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p><strong>DivertScan Â© 2026</strong> | Powered by <a href="#">Dalmex Recycling LLC</a></p>
            <p style="margin-top:0.5rem;">Point-of-Capture Verificationâ„¢ Technology | LEED v5 Compliant</p>
        </footer>
    </div>

    <!-- New Load Modal -->
    <div class="modal-overlay" id="new-load-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Add New Load</h3>
                <button class="modal-close" onclick="closeModal('new-load-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="verification-badge" style="margin-bottom:1rem;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    Point-of-Capture Verification Active
                </div>
                
                <form id="new-load-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Project *</label>
                            <select id="load-project" required>
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" id="load-date" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Material *</label>
                            <select id="load-material" required>
                                <option value="">Select Material</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Weight (tons) *</label>
                            <input type="number" id="load-weight" step="0.01" min="0" required placeholder="0.00">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Destination Type *</label>
                            <select id="load-destination-type" required>
                                <option value="">Select Type</option>
                                <option value="recycling">Recycling Facility</option>
                                <option value="reuse">Reuse/Donation</option>
                                <option value="landfill">Landfill</option>
                                <option value="composting">Composting</option>
                                <option value="wte">Waste-to-Energy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Destination Facility</label>
                            <input type="text" id="load-facility" placeholder="Facility name">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Hauler</label>
                        <input type="text" id="load-hauler" placeholder="Hauler company">
                    </div>
                    
                    <div class="form-group">
                        <label>Ticket/Manifest #</label>
                        <input type="text" id="load-ticket" placeholder="Scale ticket or manifest number">
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="load-notes" rows="2" placeholder="Additional notes..."></textarea>
                    </div>
                    
                    <div class="capture-info" id="capture-info">
                        Capturing verification data...
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('new-load-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLoad()">Save Load</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- External Dependencies - Load in specific order -->
    <script>
        // Configuration
        const CONFIG = {
            SUPABASE_URL: 'https://rnaujdajnrlvndhmhvbk.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJuYXVqZGFqbnJsdm5kaG1odmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NTY2NDUsImV4cCI6MjA1MzMzMjY0NX0.T-DPJVQkfhngFDgcPOVNgnbBJbRpWxgi3D3Ts3ZWSRM',
            VERSION: '2.0.0'
        };

        // Global state
        let supabase = null;
        let isOnline = navigator.onLine;
        let gpsData = null;
        let ipData = null;

        // Loading status updates
        function updateLoadStatus(message) {
            const statusEl = document.getElementById('loader-status');
            if (statusEl) statusEl.textContent = message;
        }

        function showLoadError(message) {
            document.getElementById('loader-status').style.display = 'none';
            document.querySelector('.loader-spinner').style.display = 'none';
            const errorEl = document.getElementById('loader-error');
            document.getElementById('error-message').textContent = message;
            errorEl.style.display = 'block';
        }

        // Load Supabase dynamically with proper error handling
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                updateLoadStatus('Loading Supabase SDK...');
                
                // Check if already loaded
                if (window.supabase) {
                    resolve(window.supabase);
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';
                script.async = true;
                
                const timeout = setTimeout(() => {
                    reject(new Error('Supabase SDK load timeout'));
                }, 15000);

                script.onload = () => {
                    clearTimeout(timeout);
                    if (window.supabase) {
                        resolve(window.supabase);
                    } else {
                        reject(new Error('Supabase SDK loaded but not available'));
                    }
                };

                script.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('Failed to load Supabase SDK'));
                };

                document.head.appendChild(script);
            });
        }

        // Load SheetJS for Excel export
        function loadSheetJS() {
            return new Promise((resolve, reject) => {
                if (window.XLSX) {
                    resolve(window.XLSX);
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                script.async = true;

                const timeout = setTimeout(() => {
                    reject(new Error('SheetJS load timeout'));
                }, 10000);

                script.onload = () => {
                    clearTimeout(timeout);
                    resolve(window.XLSX);
                };

                script.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('Failed to load SheetJS'));
                };

                document.head.appendChild(script);
            });
        }

        // Initialize Supabase client
        async function initSupabase() {
            updateLoadStatus('Connecting to database...');
            
            try {
                const { createClient } = window.supabase;
                supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                
                // Test connection
                const { error } = await supabase.from('loads').select('id').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = table doesn't exist (ok for first run)
                    console.warn('Database connection warning:', error.message);
                }
                
                return true;
            } catch (err) {
                console.error('Supabase init error:', err);
                return false;
            }
        }

        // Get GPS coordinates
        async function getGPSData() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ error: 'Geolocation not supported' });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude.toFixed(6),
                            longitude: position.coords.longitude.toFixed(6),
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        });
                    },
                    (error) => {
                        resolve({ error: error.message });
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            });
        }

        // Get IP data (simplified - would use actual API in production)
        async function getIPData() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return { ip: data.ip, timestamp: new Date().toISOString() };
            } catch {
                return { ip: 'unavailable', timestamp: new Date().toISOString() };
            }
        }

        // Main initialization
        async function initialize() {
            try {
                // Load Supabase
                await loadSupabase();
                
                // Initialize client
                const connected = await initSupabase();
                
                updateLoadStatus('Loading application...');
                
                // Start loading other dependencies in parallel
                loadSheetJS().catch(console.warn);
                
                // Get verification data in background
                Promise.all([getGPSData(), getIPData()]).then(([gps, ip]) => {
                    gpsData = gps;
                    ipData = ip;
                    updateCaptureInfo();
                });

                // Initialize app
                await initializeApp(connected);
                
                // Show app
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app').classList.add('loaded');
                
                // Update connection status
                updateConnectionStatus(connected);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                showLoadError(`Failed to initialize: ${error.message}. Please check your internet connection and try again.`);
            }
        }

        // Initialize app UI and data
        async function initializeApp(isConnected) {
            // Set up tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                });
            });

            // Set default date
            document.getElementById('load-date').valueAsDate = new Date();

            // Load data
            await loadMaterialsData();
            
            if (isConnected) {
                await loadLoadsData();
                await loadProjectsData();
            } else {
                loadOfflineData();
            }

            updateStats();
            populateNewsLinks();
        }

        // Materials data with GWP coefficients
        const MATERIALS = [
            { name: 'Concrete', category: 'Aggregate', density: 4050, gwp: 0.107, tier: 'Standard' },
            { name: 'Asphalt', category: 'Aggregate', density: 3960, gwp: 0.094, tier: 'Standard' },
            { name: 'Wood - Clean', category: 'Wood', density: 600, gwp: 0.912, tier: 'Tier 1' },
            { name: 'Wood - Treated', category: 'Wood', density: 650, gwp: 0.312, tier: 'Standard' },
            { name: 'Metal - Ferrous', category: 'Metal', density: 1600, gwp: 1.831, tier: 'Standard' },
            { name: 'Metal - Non-Ferrous', category: 'Metal', density: 1200, gwp: 4.876, tier: 'Standard' },
            { name: 'Drywall/Gypsum', category: 'Drywall', density: 800, gwp: 0.184, tier: 'Standard' },
            { name: 'Cardboard/OCC', category: 'Paper', density: 200, gwp: 3.112, tier: 'Standard' },
            { name: 'Plastic - Mixed', category: 'Plastic', density: 400, gwp: 1.423, tier: 'Standard' },
            { name: 'Roofing Materials', category: 'Mixed', density: 1100, gwp: 0.156, tier: 'Standard' },
            { name: 'Brick/Masonry', category: 'Aggregate', density: 3200, gwp: 0.089, tier: 'Standard' },
            { name: 'Glass', category: 'Glass', density: 2500, gwp: 0.423, tier: 'Standard' },
            { name: 'Carpet', category: 'Mixed', density: 350, gwp: 2.156, tier: 'Standard' },
            { name: 'Insulation', category: 'Mixed', density: 150, gwp: 0.534, tier: 'Standard' },
            { name: 'Mixed C&D', category: 'Mixed', density: 1500, gwp: 0.267, tier: 'Standard' },
            { name: 'Land Clearing Debris', category: 'Organic', density: 500, gwp: 0.756, tier: 'Tier 1' },
            { name: 'Fixtures - Reuse', category: 'Reuse', density: 800, gwp: 2.5, tier: 'Tier 1' },
            { name: 'Appliances - Reuse', category: 'Reuse', density: 700, gwp: 3.2, tier: 'Tier 1' }
        ];

        // Sample projects
        const SAMPLE_PROJECTS = [
            { id: 'proj-001', name: "Children's Hospital Phase 2", client: 'Children\'s Medical Center', address: 'Dallas, TX' },
            { id: 'proj-002', name: 'DFW Airport Terminal C', client: 'DFW Airport', address: 'Irving, TX' },
            { id: 'proj-003', name: 'Frisco Town Center', client: 'City of Frisco', address: 'Frisco, TX' }
        ];

        // Load materials table
        function loadMaterialsData() {
            const tbody = document.getElementById('materials-table');
            tbody.innerHTML = MATERIALS.map(m => `
                <tr>
                    <td>${m.name}</td>
                    <td>${m.category}</td>
                    <td>${m.density.toLocaleString()}</td>
                    <td>${m.gwp.toFixed(3)}</td>
                    <td><span class="badge ${m.tier === 'Tier 1' ? 'badge-success' : 'badge-info'}">${m.tier}</span></td>
                </tr>
            `).join('');

            // Populate material select
            const select = document.getElementById('load-material');
            select.innerHTML = '<option value="">Select Material</option>' + 
                MATERIALS.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
        }

        // Load projects
        async function loadProjectsData() {
            // Try to load from Supabase first
            let projects = SAMPLE_PROJECTS;
            
            if (supabase) {
                try {
                    const { data, error } = await supabase.from('projects').select('*');
                    if (!error && data && data.length > 0) {
                        projects = data;
                    }
                } catch (e) {
                    console.warn('Could not load projects from database');
                }
            }

            // Update project select
            const select = document.getElementById('load-project');
            const reportSelect = document.getElementById('report-project');
            
            const options = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            select.innerHTML = options;
            reportSelect.innerHTML = '<option value="">All Projects</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            // Update projects list
            const listEl = document.getElementById('projects-list');
            listEl.innerHTML = projects.map(p => `
                <div style="padding:1rem;border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;">
                    <div style="font-weight:600;">${p.name}</div>
                    <div style="color:var(--text-muted);font-size:0.875rem;">${p.client || ''} â€¢ ${p.address || ''}</div>
                </div>
            `).join('');

            window.projectsData = projects;
        }

        // Load loads data
        async function loadLoadsData() {
            const tbody = document.getElementById('loads-table');
            
            if (!supabase) {
                loadOfflineData();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('loads')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                if (data && data.length > 0) {
                    window.loadsData = data;
                    renderLoadsTable(data);
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem;">
                                No loads recorded yet. Click "New Load" to add your first entry.
                            </td>
                        </tr>
                    `;
                    window.loadsData = [];
                }
            } catch (err) {
                console.error('Error loading loads:', err);
                loadOfflineData();
            }
        }

        // Render loads table
        function renderLoadsTable(loads) {
            const tbody = document.getElementById('loads-table');
            
            if (!loads || loads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center;color:var(--text-muted);">
                            No loads recorded yet.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = loads.map(load => {
                const project = window.projectsData?.find(p => p.id === load.project_id);
                const isVerified = load.gps_latitude && load.ip_address;
                const isDiverted = ['recycling', 'reuse', 'composting'].includes(load.destination_type);
                
                return `
                    <tr>
                        <td>${new Date(load.load_date || load.created_at).toLocaleDateString()}</td>
                        <td>${project?.name || load.project_id || '-'}</td>
                        <td>${load.material || '-'}</td>
                        <td>${parseFloat(load.weight_tons || 0).toFixed(2)}</td>
                        <td>${load.facility_name || load.destination_type || '-'}</td>
                        <td>
                            <span class="badge ${isDiverted ? 'badge-success' : 'badge-warning'}">
                                ${isDiverted ? 'Diverted' : 'Disposed'}
                            </span>
                        </td>
                        <td>
                            ${isVerified ? 
                                '<span class="badge badge-success">âœ“ Verified</span>' : 
                                '<span class="badge badge-warning">Pending</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="padding:0.25rem 0.5rem;font-size:0.75rem;" 
                                onclick="viewLoad('${load.id}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Load offline/demo data
        function loadOfflineData() {
            const demoLoads = [
                { id: '1', load_date: '2026-01-24', project_id: 'proj-001', material: 'Concrete', weight_tons: 45.5, destination_type: 'recycling', facility_name: 'DFW Concrete Recycling', gps_latitude: '32.8998', ip_address: '192.168.1.1' },
                { id: '2', load_date: '2026-01-23', project_id: 'proj-001', material: 'Metal - Ferrous', weight_tons: 12.3, destination_type: 'recycling', facility_name: 'Texas Metal Recyclers', gps_latitude: '32.8998', ip_address: '192.168.1.1' },
                { id: '3', load_date: '2026-01-22', project_id: 'proj-002', material: 'Mixed C&D', weight_tons: 28.7, destination_type: 'landfill', facility_name: 'DFW Landfill', gps_latitude: null, ip_address: null }
            ];
            
            window.loadsData = demoLoads;
            renderLoadsTable(demoLoads);
        }

        // Update stats
        function updateStats() {
            const loads = window.loadsData || [];
            
            const totalLoads = loads.length;
            const totalTonnage = loads.reduce((sum, l) => sum + parseFloat(l.weight_tons || 0), 0);
            const divertedTonnage = loads
                .filter(l => ['recycling', 'reuse', 'composting'].includes(l.destination_type))
                .reduce((sum, l) => sum + parseFloat(l.weight_tons || 0), 0);
            const diversionRate = totalTonnage > 0 ? (divertedTonnage / totalTonnage * 100) : 0;
            
            // Calculate carbon avoided
            let carbonAvoided = 0;
            loads.forEach(load => {
                if (['recycling', 'reuse', 'composting'].includes(load.destination_type)) {
                    const material = MATERIALS.find(m => m.name === load.material);
                    if (material) {
                        carbonAvoided += parseFloat(load.weight_tons || 0) * material.gwp;
                    }
                }
            });

            document.getElementById('stat-loads').textContent = totalLoads;
            document.getElementById('stat-tonnage').textContent = totalTonnage.toFixed(1);
            document.getElementById('stat-diversion').textContent = diversionRate.toFixed(1) + '%';
            document.getElementById('stat-carbon').textContent = carbonAvoided.toFixed(2);
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Connected';
            } else if (navigator.onLine) {
                dot.classList.remove('connected');
                dot.classList.add('offline');
                text.textContent = 'Limited Connection';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Offline Mode';
            }
        }

        // Update capture info display
        function updateCaptureInfo() {
            const el = document.getElementById('capture-info');
            if (!el) return;

            let info = [];
            if (gpsData && !gpsData.error) {
                info.push(`GPS: ${gpsData.latitude}, ${gpsData.longitude}`);
            } else {
                info.push('GPS: Unavailable');
            }
            if (ipData && ipData.ip !== 'unavailable') {
                info.push(`IP: ${ipData.ip}`);
            }
            info.push(`Time: ${new Date().toLocaleString()}`);
            
            el.textContent = info.join(' | ');
        }

        // Modal functions
        function openNewLoadModal() {
            document.getElementById('new-load-modal').classList.add('active');
            document.getElementById('load-date').valueAsDate = new Date();
            updateCaptureInfo();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Save load
        async function saveLoad() {
            const form = document.getElementById('new-load-form');
            
            const loadData = {
                project_id: document.getElementById('load-project').value,
                load_date: document.getElementById('load-date').value,
                material: document.getElementById('load-material').value,
                weight_tons: parseFloat(document.getElementById('load-weight').value),
                destination_type: document.getElementById('load-destination-type').value,
                facility_name: document.getElementById('load-facility').value,
                hauler: document.getElementById('load-hauler').value,
                ticket_number: document.getElementById('load-ticket').value,
                notes: document.getElementById('load-notes').value,
                gps_latitude: gpsData?.latitude || null,
                gps_longitude: gpsData?.longitude || null,
                gps_accuracy: gpsData?.accuracy || null,
                ip_address: ipData?.ip || null,
                capture_timestamp: new Date().toISOString(),
                created_at: new Date().toISOString()
            };

            // Validate
            if (!loadData.project_id || !loadData.material || !loadData.weight_tons || !loadData.destination_type) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                if (supabase) {
                    const { data, error } = await supabase.from('loads').insert([loadData]).select();
                    if (error) throw error;
                    
                    showToast('Load saved successfully!', 'success');
                    closeModal('new-load-modal');
                    form.reset();
                    await loadLoadsData();
                    updateStats();
                } else {
                    // Offline mode - save to local array
                    loadData.id = 'local-' + Date.now();
                    window.loadsData = window.loadsData || [];
                    window.loadsData.unshift(loadData);
                    renderLoadsTable(window.loadsData);
                    updateStats();
                    showToast('Load saved locally (offline mode)', 'info');
                    closeModal('new-load-modal');
                    form.reset();
                }
            } catch (err) {
                console.error('Save error:', err);
                showToast('Error saving load: ' + err.message, 'error');
            }
        }

        // View load details
        function viewLoad(id) {
            const load = window.loadsData?.find(l => l.id === id);
            if (load) {
                alert(JSON.stringify(load, null, 2));
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // Export to Excel (Dalmex 24-column format)
        async function exportExcel() {
            showToast('Generating Excel report...', 'info');
            
            try {
                // Ensure SheetJS is loaded
                if (!window.XLSX) {
                    await loadSheetJS();
                }
                
                const loads = window.loadsData || [];
                const projects = window.projectsData || SAMPLE_PROJECTS;
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // ===== SUMMARY SHEET =====
                const summaryData = [
                    ['DivertScan Â© 2026 - Waste Diversion Report'],
                    ['The Carbon Truth in Every Load'],
                    ['Powered by Dalmex Recycling LLC'],
                    [''],
                    ['Report Generated:', new Date().toLocaleString()],
                    ['Total Loads:', loads.length],
                    [''],
                    ['SUMMARY STATISTICS'],
                    ['Total Tonnage:', loads.reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0).toFixed(2)],
                    ['Diverted Tonnage:', loads.filter(l => ['recycling', 'reuse', 'composting'].includes(l.destination_type)).reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0).toFixed(2)],
                    ['Diversion Rate:', ((loads.filter(l => ['recycling', 'reuse', 'composting'].includes(l.destination_type)).reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0) / Math.max(loads.reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0), 1)) * 100).toFixed(1) + '%']
                ];
                const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWS, 'Summary');
                
                // ===== LOADS DETAIL SHEET (24 columns) =====
                const loadsHeaders = [
                    'Record ID', 'Load Date', 'Project ID', 'Project Name', 'Client',
                    'Material Category', 'Material Type', 'Weight (tons)', 'Weight (lbs)',
                    'Destination Type', 'Facility Name', 'Facility Address', 'Hauler',
                    'Ticket Number', 'Diverted', 'GWP Factor', 'CO2e Avoided (MT)',
                    'GPS Latitude', 'GPS Longitude', 'IP Address', 'Capture Timestamp',
                    'LEED Tier', 'Verification Status', 'Notes'
                ];
                
                const loadsRows = loads.map(load => {
                    const project = projects.find(p => p.id === load.project_id) || {};
                    const material = MATERIALS.find(m => m.name === load.material) || {};
                    const isDiverted = ['recycling', 'reuse', 'composting'].includes(load.destination_type);
                    const co2Avoided = isDiverted ? (parseFloat(load.weight_tons || 0) * (material.gwp || 0)) : 0;
                    const isVerified = load.gps_latitude && load.ip_address;
                    
                    return [
                        load.id,
                        load.load_date,
                        load.project_id,
                        project.name || '',
                        project.client || '',
                        material.category || '',
                        load.material,
                        parseFloat(load.weight_tons || 0).toFixed(2),
                        (parseFloat(load.weight_tons || 0) * 2000).toFixed(0),
                        load.destination_type,
                        load.facility_name || '',
                        '',
                        load.hauler || '',
                        load.ticket_number || '',
                        isDiverted ? 'Yes' : 'No',
                        material.gwp || 0,
                        co2Avoided.toFixed(3),
                        load.gps_latitude || '',
                        load.gps_longitude || '',
                        load.ip_address || '',
                        load.capture_timestamp || '',
                        material.tier || 'Standard',
                        isVerified ? 'Verified' : 'Pending',
                        load.notes || ''
                    ];
                });
                
                const loadsWS = XLSX.utils.aoa_to_sheet([loadsHeaders, ...loadsRows]);
                XLSX.utils.book_append_sheet(wb, loadsWS, 'Loads Detail');
                
                // ===== MATERIALS REFERENCE SHEET =====
                const materialsHeaders = ['Material', 'Category', 'Default Density (lb/ydÂ³)', 'GWP (MT CO2e/ton)', 'LEED v5 Tier'];
                const materialsRows = MATERIALS.map(m => [m.name, m.category, m.density, m.gwp, m.tier]);
                const materialsWS = XLSX.utils.aoa_to_sheet([materialsHeaders, ...materialsRows]);
                XLSX.utils.book_append_sheet(wb, materialsWS, 'Materials Reference');
                
                // ===== INDUSTRY WATCHTOWER SHEET =====
                const watchtowerData = [
                    ['DivertScan Â© 2026 - Industry Watchtower'],
                    [''],
                    ['LEED v5 KEY UPDATES'],
                    ['â€¢ Tier 1 Circularity credits provide enhanced weighted multipliers for reuse materials'],
                    ['â€¢ Global Warming Potential (GWP) coefficients required for carbon tracking'],
                    ['â€¢ Stricter chain-of-custody documentation requirements'],
                    ['â€¢ Point-of-capture verification becoming industry standard'],
                    [''],
                    ['OFFICIAL RESOURCES'],
                    ['USGBC LEED Official', 'https://www.usgbc.org/leed'],
                    ['EPA WARM Calculator', 'https://www.epa.gov/warm'],
                    ['MR Credit: Construction Waste Management', 'https://www.usgbc.org/credits/new-construction-core-and-shell-schools-new-construction-retail-new-construction-data-702'],
                    [''],
                    ['REGULATORY CONTACTS'],
                    ['Texas Commission on Environmental Quality (TCEQ)', 'https://www.tceq.texas.gov'],
                    ['EPA Region 6 (Dallas)', 'https://www.epa.gov/aboutepa/epa-region-6-south-central']
                ];
                const watchtowerWS = XLSX.utils.aoa_to_sheet(watchtowerData);
                XLSX.utils.book_append_sheet(wb, watchtowerWS, 'Industry Watchtower');
                
                // Generate and download
                const filename = `DivertScan_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showToast('Excel report downloaded!', 'success');
            } catch (err) {
                console.error('Export error:', err);
                showToast('Export failed: ' + err.message, 'error');
            }
        }

        // Export LEED Report (without hardcoded certification levels)
        async function exportLEEDReport() {
            showToast('Generating LEED report...', 'info');
            
            try {
                if (!window.XLSX) {
                    await loadSheetJS();
                }
                
                const loads = window.loadsData || [];
                const projects = window.projectsData || SAMPLE_PROJECTS;
                
                // Calculate metrics
                const totalTonnage = loads.reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0);
                const divertedLoads = loads.filter(l => ['recycling', 'reuse', 'composting'].includes(l.destination_type));
                const divertedTonnage = divertedLoads.reduce((s, l) => s + parseFloat(l.weight_tons || 0), 0);
                const diversionRate = totalTonnage > 0 ? (divertedTonnage / totalTonnage * 100) : 0;
                
                // Calculate by material
                const materialSummary = {};
                loads.forEach(load => {
                    const mat = load.material || 'Unknown';
                    if (!materialSummary[mat]) {
                        materialSummary[mat] = { total: 0, diverted: 0, tier1: 0 };
                    }
                    const weight = parseFloat(load.weight_tons || 0);
                    materialSummary[mat].total += weight;
                    if (['recycling', 'reuse', 'composting'].includes(load.destination_type)) {
                        materialSummary[mat].diverted += weight;
                        const matDef = MATERIALS.find(m => m.name === mat);
                        if (matDef?.tier === 'Tier 1') {
                            materialSummary[mat].tier1 += weight;
                        }
                    }
                });
                
                const wb = XLSX.utils.book_new();
                
                // LEED Summary Sheet
                const leedData = [
                    ['LEED v5 Construction Waste Management Report'],
                    ['DivertScan Â© 2026 - Point-of-Capture Verified'],
                    [''],
                    ['Report Date:', new Date().toLocaleString()],
                    ['Reporting Period:', 'All Available Data'],
                    [''],
                    ['DIVERSION SUMMARY'],
                    ['Total Waste Generated (tons):', totalTonnage.toFixed(2)],
                    ['Total Waste Diverted (tons):', divertedTonnage.toFixed(2)],
                    ['Total Waste to Landfill (tons):', (totalTonnage - divertedTonnage).toFixed(2)],
                    ['Overall Diversion Rate:', diversionRate.toFixed(1) + '%'],
                    [''],
                    ['LEED v5 COMPLIANCE NOTES'],
                    ['â€¢ Diversion rate calculated per MR Credit requirements'],
                    ['â€¢ Point-of-capture verification provides chain-of-custody documentation'],
                    ['â€¢ Tier 1 Circularity materials tracked separately for enhanced credits'],
                    ['â€¢ Actual certification level to be determined by LEED reviewer based on project scope'],
                    [''],
                    ['VERIFICATION METHOD'],
                    ['All entries captured with GPS coordinates and IP address verification'],
                    ['Timestamps recorded at moment of data entry']
                ];
                const leedWS = XLSX.utils.aoa_to_sheet(leedData);
                XLSX.utils.book_append_sheet(wb, leedWS, 'LEED Summary');
                
                // Material Breakdown Sheet
                const matHeaders = ['Material', 'Total (tons)', 'Diverted (tons)', 'Tier 1 (tons)', 'Diversion %'];
                const matRows = Object.entries(materialSummary).map(([mat, data]) => [
                    mat,
                    data.total.toFixed(2),
                    data.diverted.toFixed(2),
                    data.tier1.toFixed(2),
                    data.total > 0 ? ((data.diverted / data.total) * 100).toFixed(1) + '%' : '0%'
                ]);
                const matWS = XLSX.utils.aoa_to_sheet([matHeaders, ...matRows]);
                XLSX.utils.book_append_sheet(wb, matWS, 'Material Breakdown');
                
                // Verification Audit Sheet
                const auditHeaders = ['Date', 'Material', 'Weight', 'Destination', 'GPS', 'IP', 'Timestamp'];
                const auditRows = loads.map(l => [
                    l.load_date,
                    l.material,
                    parseFloat(l.weight_tons || 0).toFixed(2),
                    l.destination_type,
                    l.gps_latitude ? `${l.gps_latitude}, ${l.gps_longitude}` : 'N/A',
                    l.ip_address || 'N/A',
                    l.capture_timestamp || ''
                ]);
                const auditWS = XLSX.utils.aoa_to_sheet([auditHeaders, ...auditRows]);
                XLSX.utils.book_append_sheet(wb, auditWS, 'Verification Audit');
                
                const filename = `LEED_Compliance_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showToast('LEED report downloaded!', 'success');
            } catch (err) {
                console.error('LEED export error:', err);
                showToast('LEED export failed: ' + err.message, 'error');
            }
        }

        // Export Audit Log
        function exportAuditLog() {
            showToast('Audit log export coming soon', 'info');
        }

        // Populate news links
        function populateNewsLinks() {
            const container = document.getElementById('news-links');
            const links = [
                { title: 'USGBC Announces LEED v5 Updates for 2025', url: '#', date: '2025-12' },
                { title: 'EPA Updates WARM Model to Version 16', url: '#', date: '2025-11' },
                { title: 'Texas TCEQ Construction Waste Guidelines Revised', url: '#', date: '2025-10' }
            ];
            
            container.innerHTML = links.map(l => `
                <div style="padding:0.75rem;border-left:3px solid var(--primary);margin-bottom:0.5rem;background:var(--bg-input);border-radius:0 4px 4px 0;">
                    <a href="${l.url}" target="_blank" style="color:var(--text-primary);text-decoration:none;font-weight:500;">${l.title}</a>
                    <div style="color:var(--text-muted);font-size:0.75rem;margin-top:0.25rem;">${l.date}</div>
                </div>
            `).join('');
        }

        // Network status listeners
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus(true);
            showToast('Connection restored', 'success');
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus(false);
            showToast('You are offline - data will be saved locally', 'info');
        });

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
