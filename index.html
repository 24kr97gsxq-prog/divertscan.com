<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>DivertScan‚Ñ¢</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--blue-500:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',system-ui,sans-serif;background:var(--slate-900);color:var(--slate-200);min-height:100vh;padding-bottom:80px;-webkit-tap-highlight-color:transparent}
.header{background:var(--slate-800);padding:16px 20px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--slate-700)}
.logo{font-size:20px;font-weight:700;color:var(--emerald-400)}
.logo span{color:var(--slate-400);font-weight:400;font-size:12px;margin-left:8px}
main{padding:20px;max-width:800px;margin:0 auto}
.card{background:var(--slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--slate-700)}
.btn{padding:14px 20px;border-radius:8px;font-weight:600;font-size:14px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:48px;transition:all 0.2s}
.btn-primary{background:var(--emerald-500);color:white}
.btn-primary:active{background:var(--emerald-400);transform:scale(0.98)}
.btn-secondary{background:var(--slate-700);color:var(--slate-200)}
.btn-lg{width:100%;padding:18px;font-size:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-input{width:100%;padding:14px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;color:var(--slate-200);font-size:16px;min-height:48px}
.form-input:focus{outline:none;border-color:var(--emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:40px}
.modal-content{background:var(--slate-800);border-radius:16px;width:100%;max-width:700px;max-height:calc(100vh - 80px);display:flex;flex-direction:column;border:1px solid var(--slate-700)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(--slate-700);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.modal-title{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(--slate-700);border:none;color:var(--slate-400);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{padding:16px 20px;border-top:1px solid var(--slate-700);display:flex;gap:12px;flex-shrink:0}

/* Steps */
.steps{display:flex;justify-content:center;align-items:center;margin-bottom:24px;gap:8px}
.step{width:36px;height:36px;border-radius:50%;background:var(--slate-700);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:var(--slate-400)}
.step.active{background:var(--emerald-500);color:white}
.step.complete{background:var(--emerald-500);color:white}
.step-line{width:40px;height:3px;background:var(--slate-700)}
.step-line.complete{background:var(--emerald-500)}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.photo-slot{aspect-ratio:1;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;color:var(--slate-500);cursor:pointer;position:relative;overflow:hidden}
.photo-slot img{width:100%;height:100%;object-fit:cover}
.photo-slot.filled{border:2px solid var(--emerald-500)}
.photo-slot .remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(--red-500);border-radius:50%;border:none;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Container Select */
.container-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.container-option{background:var(--slate-700);border:2px solid var(--slate-600);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(--emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:18px;font-weight:700}
.container-option small{font-size:11px;color:var(--slate-400)}

/* Verification Box - CRITICAL */
.verification-box{background:var(--slate-700);border:3px solid var(--amber-500);border-radius:12px;padding:20px;margin:20px 0}
.verification-box.verified{border-color:var(--emerald-500);background:rgba(16,185,129,0.15)}
.verification-box label{display:flex;align-items:flex-start;gap:16px;cursor:pointer}
.verification-box input[type="checkbox"]{width:32px;height:32px;min-width:32px;accent-color:var(--emerald-500);cursor:pointer;margin-top:4px}
.verification-box .verify-text{font-weight:700;color:var(--amber-400);font-size:16px}
.verification-box.verified .verify-text{color:var(--emerald-400)}
.verification-box .verify-desc{font-size:13px;color:var(--slate-300);margin-top:6px}

/* Materials */
.material-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--slate-700)}
.material-item:last-child{border-bottom:none}
.material-name{font-size:13px}
.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:60px;padding:8px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:4px;color:white;text-align:center;font-size:14px}

/* Progress */
.progress-bar{height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--emerald-500);transition:width 0.3s}
.diversion-badge{font-size:28px;font-weight:700;color:var(--emerald-400)}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--slate-700);color:white;padding:14px 24px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s;font-size:14px;max-width:90%;text-align:center}
.toast.show{opacity:1}
.toast.error{background:var(--red-500)}
.toast.success{background:var(--emerald-500)}

/* Image Preview */
.image-preview{width:100%;aspect-ratio:16/10;background:var(--slate-700);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden;color:var(--slate-500);font-size:14px}
.image-preview.filled{border:2px solid var(--emerald-500)}
.image-preview img{width:100%;height:100%;object-fit:contain}

/* Button Row */
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Signature */
.signature-pad{width:100%;height:150px;background:white;border-radius:8px;touch-action:none}

/* Loading */
.loading{text-align:center;padding:20px}
.spinner{width:40px;height:40px;border:3px solid var(--slate-600);border-top-color:var(--emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;display:none;align-items:center;justify-content:center;flex-direction:column}
.loading-overlay.active{display:flex}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--slate-800);border-top:1px solid var(--slate-700);display:flex;justify-content:space-around;padding:8px 0;z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(--slate-500);font-size:10px;padding:8px 12px;cursor:pointer}
.nav-item.active{color:var(--emerald-400)}
.nav-item svg{width:24px;height:24px}

/* Hide class */
.hidden{display:none !important}
</style>
</head>
<body>

<div class="header">
<div class="logo">DivertScan‚Ñ¢ <span>v5.8</span></div>
<button class="modal-close" onclick="showTab('settings')" style="background:transparent;border:none">‚öôÔ∏è</button>
</div>

<main id="mainContent">
<div id="dashboardTab">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400);text-transform:uppercase">Current Project</div>
<div style="font-size:18px;font-weight:600;margin-top:4px" id="currentProjectName">No Project Selected</div>
<div style="font-size:12px;color:var(--slate-400)" id="currentProjectHauler"></div>
</div>
<button class="btn btn-secondary" onclick="showProjectPicker()" style="padding:8px 12px;font-size:12px">Change</button>
</div>
</div>

<button class="btn btn-primary btn-lg" onclick="startNewTicket()">‚ûï New Ticket</button>

<div class="card" style="margin-top:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">Recent Tickets</div>
<button class="btn btn-secondary" onclick="loadRecentTickets()" style="padding:6px 10px;font-size:11px">Refresh</button>
</div>
<div id="recentTickets" style="color:var(--slate-400);font-size:13px">Loading...</div>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">üìä Project Stats</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div style="text-align:center;padding:12px;background:var(--slate-700);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--emerald-400)" id="statTotalTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">Total Tons</div>
</div>
<div style="text-align:center;padding:12px;background:var(--slate-700);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--emerald-400)" id="statDiversionRate">0%</div>
<div style="font-size:11px;color:var(--slate-400)">Diversion Rate</div>
</div>
</div>
</div>
</div>

<div id="projectsTab" class="hidden">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:18px;font-weight:600">Projects</h2>
<button class="btn btn-primary" onclick="showNewProjectModal()" style="padding:10px 16px">‚ûï New Project</button>
</div>
<div id="projectsList">Loading projects...</div>
</div>

<div id="reportsTab" class="hidden">
<h2 style="font-size:18px;font-weight:600;margin-bottom:16px">üìä LEED MRc5 Reports</h2>

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">Generate Waste Diversion Report</div>
<p style="font-size:12px;color:var(--slate-400);margin-bottom:16px">LEED v4.1 Construction & Demolition Waste Management compliant report</p>
<button class="btn btn-primary btn-lg" onclick="generateReport()" style="margin-bottom:12px">üìÑ Generate Report</button>
<div class="btn-row" id="reportDownloadBtns" style="display:none">
<button class="btn btn-secondary" onclick="downloadReportPDF()" style="flex:1">üìë Download PDF</button>
<button class="btn btn-secondary" onclick="downloadReportCSV()" style="flex:1">üìä Download CSV</button>
</div>
</div>

<div id="reportOutput" class="hidden" style="margin-top:20px">

<!-- Project Header -->
<div class="card" id="reportHeader">
<div style="text-align:center;margin-bottom:16px">
<div style="font-size:20px;font-weight:700">Construction & Demolition Waste Management Report</div>
<div style="font-size:12px;color:var(--slate-400)">LEED v4.1 MRc5 Documentation</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;font-size:13px">
<div>
<div style="color:var(--slate-400);font-size:11px">PROJECT NAME</div>
<div style="font-weight:600" id="reportProjectName">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">REPORT DATE</div>
<div style="font-weight:600" id="reportDate">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">PROJECT ADDRESS</div>
<div id="reportProjectAddress">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">GENERAL CONTRACTOR</div>
<div id="reportProjectGC">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">WASTE HAULER</div>
<div id="reportProjectHauler">-</div>
</div>
<div>
<div style="color:var(--slate-400);font-size:11px">REPORTING PERIOD</div>
<div id="reportPeriod">-</div>
</div>
</div>
</div>

<!-- Diversion Summary -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:16px">üìà Diversion Summary</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700;color:var(--emerald-400)" id="reportDiversionRate">0%</div>
<div style="font-size:11px;color:var(--slate-400)">DIVERSION RATE</div>
</div>
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700" id="reportTotalTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">TOTAL TONS</div>
</div>
<div style="background:var(--slate-700);padding:16px;border-radius:8px">
<div style="font-size:28px;font-weight:700;color:var(--emerald-400)" id="reportDivertedTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">DIVERTED TONS</div>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;margin-top:12px">
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600;color:var(--red-500)" id="reportLandfillTons">0.00</div>
<div style="font-size:11px;color:var(--slate-400)">LANDFILL TONS</div>
</div>
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600" id="reportTicketCount">0</div>
<div style="font-size:11px;color:var(--slate-400)">TOTAL LOADS</div>
</div>
<div style="background:var(--slate-700);padding:12px;border-radius:8px">
<div style="font-size:18px;font-weight:600" id="reportLeedStatus">-</div>
<div style="font-size:11px;color:var(--slate-400)">LEED STATUS</div>
</div>
</div>
</div>

<!-- Material Breakdown -->
<div class="card" style="margin-top:16px">
<div style="font-size:14px;font-weight:600;margin-bottom:16px">‚ôªÔ∏è Material Breakdown by Weight</div>
<div id="reportMaterialBreakdown"></div>
<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--slate-700)">
<div style="display:flex;justify-content:space-between;font-weight:600">
<span>TOTAL DIVERTED</span>
<span style="color:var(--emerald-400)" id="reportTotalDiverted">0.00 T</span>
</div>
<div style="display:flex;justify-content:space-between;font-weight:600;margin-top:8px">
<span>TOTAL LANDFILL</span>
<span style="color:var(--red-500)" id="reportTotalLandfill">0.00 T</span>
</div>
</div>
</div>

<!-- Load Details -->
<div class="card" style="margin-top:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<div style="font-size:14px;font-weight:600">üöõ Load Details</div>
<span style="font-size:11px;color:var(--slate-400)" id="reportLoadCount">0 loads</span>
</div>
<div id="reportContent" style="overflow-x:auto"></div>
</div>

<!-- Certification -->
<div class="card" style="margin-top:16px;border:2px solid var(--emerald-500)">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">‚úÖ Certification Statement</div>
<p style="font-size:12px;color:var(--slate-300);line-height:1.6">
I certify that the information contained in this report is accurate and complete to the best of my knowledge. 
All waste materials have been tracked from point of generation to final destination. 
Material percentages are based on AI-assisted visual analysis with human verification for each load.
Photographic documentation and GPS coordinates are stored for audit purposes.
</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;font-size:12px">
<div>
<div style="color:var(--slate-400)">Prepared By</div>
<div style="font-weight:600">DivertScan‚Ñ¢ Automated System</div>
</div>
<div>
<div style="color:var(--slate-400)">Report Generated</div>
<div style="font-weight:600" id="reportGeneratedDate">-</div>
</div>
</div>
</div>

</div>
</div>

<div id="settingsTab" class="hidden">
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üîë OpenAI API Key</div>
<input type="password" id="apiKeyInput" class="form-input" placeholder="sk-..." style="margin-bottom:12px">
<button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
</div>

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">üóÑÔ∏è Supabase Connection</div>
<div class="form-group">
<label class="form-label">Project URL</label>
<input type="text" id="supabaseUrl" class="form-input" placeholder="https://xxxxx.supabase.co">
</div>
<div class="form-group">
<label class="form-label">Anon Key</label>
<input type="password" id="supabaseKey" class="form-input" placeholder="eyJ...">
</div>
<button class="btn btn-primary" onclick="saveSupabaseConfig()">Save & Connect</button>
<div id="supabaseStatus" style="margin-top:12px;font-size:12px;color:var(--slate-400)"></div>
</div>
</div>
</main>

<nav class="nav">
<div class="nav-item active" onclick="showTab('dashboard')">üè†<span>Home</span></div>
<div class="nav-item" onclick="showTab('projects')">üìÅ<span>Projects</span></div>
<div class="nav-item" onclick="showTab('reports')">üìä<span>Reports</span></div>
<div class="nav-item" onclick="showTab('settings')">‚öôÔ∏è<span>Settings</span></div>
</nav>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
<div class="spinner"></div>
<p id="loadingText" style="color:white">Processing...</p>
</div>

<!-- New Ticket Modal -->
<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">New Ticket</div>
<button class="modal-close" onclick="closeTicketModal()">√ó</button>
</div>
<div class="modal-body">

<!-- Step Indicators -->
<div class="steps">
<div class="step active" id="stepIndicator1">1</div>
<div class="step-line" id="stepLine1"></div>
<div class="step" id="stepIndicator2">2</div>
<div class="step-line" id="stepLine2"></div>
<div class="step" id="stepIndicator3">3</div>
<div class="step-line" id="stepLine3"></div>
<div class="step" id="stepIndicator4">4</div>
</div>

<!-- STEP 1: Scale Ticket -->
<div id="ticketStep1">
<h3 style="text-align:center;margin-bottom:16px">üìÑ Step 1: Scale Ticket</h3>

<div class="form-group">
<label class="form-label">Project</label>
<select id="ticketProject" class="form-input">
<option value="">Select Project...</option>
<option value="demo">Demo Project</option>
</select>
</div>

<div class="image-preview" id="ticketImagePreview">
<span>Upload scale ticket photo</span>
</div>

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('ticketCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('ticketFileInput').click()">üìÅ Upload</button>
</div>
<input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleTicketPhoto(event)">
<input type="file" id="ticketFileInput" accept="image/*" style="display:none" onchange="handleTicketPhoto(event)">

<div class="form-group">
<label class="form-label">Service Date</label>
<input type="date" id="serviceDate" class="form-input">
</div>

<div class="form-group">
<label class="form-label">Ticket #</label>
<input type="text" id="ticketNumber" class="form-input" placeholder="84600">
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Gross (lbs)</label>
<input type="number" id="grossLbs" class="form-input" placeholder="40000" oninput="updateNetWeight()">
</div>
<div class="form-group">
<label class="form-label">Tare (lbs)</label>
<input type="number" id="tareLbs" class="form-input" placeholder="15000" oninput="updateNetWeight()">
</div>
</div>

<div class="form-group">
<label class="form-label">Net Weight</label>
<div id="netWeightDisplay" style="font-size:28px;font-weight:700;color:var(--emerald-400)">0.00 tons</div>
</div>

<div class="form-group">
<label class="form-label">Hauler</label>
<input type="text" id="haulerName" class="form-input" placeholder="Hauler name">
</div>
</div>

<!-- STEP 2: Debris Photos -->
<div id="ticketStep2" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">üì∏ Step 2: Debris Photos</h3>

<div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between">
<span>Ticket: <strong id="step2TicketNum">--</strong></span>
<span>Net: <strong id="step2NetWeight" style="color:var(--emerald-400)">-- T</strong></span>
</div>

<p style="color:var(--amber-400);text-align:center;margin-bottom:16px;font-size:13px">‚ö†Ô∏è Upload at least 1 photo of debris</p>

<div class="form-group">
<label class="form-label">Container Size</label>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yd</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(0)"><span>?</span><small>other</small></div>
</div>
</div>

<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" id="photoSlot0" onclick="triggerPhotoUpload(0)">‚ûï</div>
<div class="photo-slot" id="photoSlot1" onclick="triggerPhotoUpload(1)">‚ûï</div>
<div class="photo-slot" id="photoSlot2" onclick="triggerPhotoUpload(2)">‚ûï</div>
</div>

<input type="file" id="debrisPhotoInput" accept="image/*" style="display:none" onchange="handleDebrisPhoto(event)">
<input type="file" id="debrisMultiInput" accept="image/*" multiple style="display:none" onchange="handleMultiplePhotos(event)">
<input type="file" id="debrisCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleDebrisPhoto(event)">

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('debrisCameraInput').click()">üì∑ Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('debrisMultiInput').click()">üìÅ Upload Multiple</button>
</div>

<p style="text-align:center;color:var(--slate-400);margin-bottom:16px">Photos: <span id="photoCount">0</span>/3</p>

<button class="btn btn-primary btn-lg" id="analyzeBtn" onclick="analyzeDebris()">ü§ñ Analyze Materials</button>

<div id="analysisResult" class="hidden" style="margin-top:16px;padding:16px;background:var(--slate-700);border-radius:8px">
<div style="text-align:center">
<div style="font-size:14px;color:var(--slate-400)">Diversion Rate</div>
<div id="analysisRate" style="font-size:36px;font-weight:700;color:var(--emerald-400)">0%</div>
</div>
</div>
</div>

<!-- STEP 3: Review & Verify - WITH CHECKBOX -->
<div id="ticketStep3" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úÖ Step 3: Review & Verify</h3>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400)">Diversion Rate</div>
<div class="diversion-badge" id="reviewDiversionRate">0%</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--slate-400)">LEED Target</div>
<div style="font-size:20px;font-weight:600">75%</div>
</div>
</div>
<div class="progress-bar" style="margin-top:12px">
<div class="progress-fill" id="reviewProgressBar" style="width:0%"></div>
</div>
</div>

<!-- ‚≠ê HUMAN VERIFICATION CHECKBOX ‚≠ê -->
<div class="verification-box" id="verificationBox">
<label>
<input type="checkbox" id="humanVerifyCheckbox" onchange="onVerificationChange()">
<div>
<div class="verify-text">‚ö†Ô∏è REQUIRED: Human Verification</div>
<div class="verify-desc">I have reviewed the photos and confirm the material percentages are accurate or have been corrected.</div>
</div>
</label>
</div>

<div style="font-size:12px;color:var(--slate-400);margin-bottom:8px">MATERIALS (adjust if needed)</div>
<div id="materialsList"></div>

<div style="margin-top:12px;font-size:14px">
Total: <span id="materialsTotal" style="color:var(--emerald-400);font-weight:700">100%</span>
</div>
</div>

<!-- STEP 4: Signature -->
<div id="ticketStep4" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">‚úçÔ∏è Step 4: Sign & Submit</h3>

<div class="card">
<p style="font-size:12px;color:var(--slate-400);margin-bottom:12px">Sign below to certify accuracy</p>
<canvas id="signaturePad" class="signature-pad"></canvas>
<button class="btn btn-secondary" style="margin-top:12px" onclick="clearSignature()">Clear Signature</button>
</div>

<p style="font-size:11px;color:var(--slate-400);margin-top:16px;line-height:1.6">
By signing, I certify that the weights and material percentages are accurate to the best of my knowledge.
</p>
</div>

</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="backBtn" onclick="goBack()" style="flex:1">Back</button>
<button class="btn btn-primary" id="nextBtn" onclick="goNext()" style="flex:1">Next</button>
</div>
</div>
</div>

<!-- New Project Modal -->
<div id="projectModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">New Project</div>
<button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">Project Name *</label>
<input type="text" id="projectName" class="form-input" placeholder="e.g., Children's Hospital Phase 2">
</div>
<div class="form-group">
<label class="form-label">Project Address</label>
<input type="text" id="projectAddress" class="form-input" placeholder="123 Main St, Dallas, TX">
</div>
<div class="form-group">
<label class="form-label">Waste Hauler</label>
<input type="text" id="projectHauler" class="form-input" placeholder="e.g., B&B Waste Management">
</div>
<div class="form-group">
<label class="form-label">LEED Target (%)</label>
<input type="number" id="projectLeedTarget" class="form-input" value="75" min="50" max="100">
</div>
<div class="form-group">
<label class="form-label">General Contractor</label>
<input type="text" id="projectGC" class="form-input" placeholder="e.g., JE Dunn Construction">
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex:1">Cancel</button>
<button class="btn btn-primary" onclick="saveProject()" style="flex:1">Save Project</button>
</div>
</div>
</div>

<!-- Project Picker Modal -->
<div id="projectPickerModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">Select Project</div>
<button class="modal-close" onclick="closeModal('projectPickerModal')">√ó</button>
</div>
<div class="modal-body">
<div id="projectPickerList">Loading...</div>
<button class="btn btn-secondary btn-lg" onclick="closeModal('projectPickerModal');showNewProjectModal()" style="margin-top:16px">‚ûï Create New Project</button>
</div>
</div>
</div>

<script>
// ========== SUPABASE CONFIG ==========
const SUPABASE_URL = localStorage.getItem('divertscan_sb_url') || '';
const SUPABASE_KEY = localStorage.getItem('divertscan_sb_key') || '';
let sb = null;

// Initialize Supabase if configured
if (SUPABASE_URL && SUPABASE_KEY && typeof supabase !== 'undefined') {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// ========== GLOBAL STATE ==========
let currentStep = 1;
let projects = [];
let currentProject = null;
let tickets = [];
let ticketData = {
    projectId: '',
    ticketNumber: '',
    serviceDate: '',
    grossLbs: 0,
    tareLbs: 0,
    netTons: 0,
    hauler: '',
    containerSize: 30,
    photos: [],
    materials: {},
    diversionRate: 0,
    humanVerified: false,
    signature: null
};
let debrisPhotos = [null, null, null];
let currentPhotoSlot = 0;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DivertScan v5.0 initialized');
    
    // Set today's date
    document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
    
    // Load API key
    const savedKey = localStorage.getItem('divertscan_openai');
    if (savedKey) {
        document.getElementById('apiKeyInput').value = savedKey;
    }
    
    // Load Supabase config
    const sbUrl = localStorage.getItem('divertscan_sb_url');
    const sbKey = localStorage.getItem('divertscan_sb_key');
    if (sbUrl) document.getElementById('supabaseUrl').value = sbUrl;
    if (sbKey) document.getElementById('supabaseKey').value = sbKey;
    
    // Initialize data
    initializeApp();
});

async function initializeApp() {
    if (sb) {
        document.getElementById('supabaseStatus').innerHTML = '<span style="color:var(--emerald-400)">‚úÖ Connected</span>';
        await loadProjects();
        await loadRecentTickets();
        updateStats();
    } else {
        document.getElementById('supabaseStatus').innerHTML = '<span style="color:var(--amber-400)">‚ö†Ô∏è Not configured - go to Settings</span>';
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--amber-400)">Configure Supabase in Settings to save tickets</p>';
    }
}

// ========== TABS ==========
function showTab(tab) {
    document.getElementById('dashboardTab').classList.add('hidden');
    document.getElementById('projectsTab').classList.add('hidden');
    document.getElementById('reportsTab').classList.add('hidden');
    document.getElementById('settingsTab').classList.add('hidden');
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardTab').classList.remove('hidden');
        loadRecentTickets();
        updateStats();
    } else if (tab === 'projects') {
        document.getElementById('projectsTab').classList.remove('hidden');
        renderProjectsList();
    } else if (tab === 'reports') {
        document.getElementById('reportsTab').classList.remove('hidden');
    } else if (tab === 'settings') {
        document.getElementById('settingsTab').classList.remove('hidden');
    }
    
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.remove('active');
        if ((tab === 'dashboard' && i === 0) || (tab === 'projects' && i === 1) || (tab === 'reports' && i === 2) || (tab === 'settings' && i === 3)) {
            item.classList.add('active');
        }
    });
}

// ========== API KEY ==========
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (key) {
        localStorage.setItem('divertscan_openai', key);
        toast('API key saved!', 'success');
    }
}

// ========== SUPABASE CONFIG ==========
function saveSupabaseConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    
    if (!url || !key) {
        toast('Please enter both URL and Key', 'error');
        return;
    }
    
    localStorage.setItem('divertscan_sb_url', url);
    localStorage.setItem('divertscan_sb_key', key);
    
    // Reinitialize Supabase
    if (typeof supabase !== 'undefined') {
        sb = supabase.createClient(url, key);
        document.getElementById('supabaseStatus').innerHTML = '<span style="color:var(--emerald-400)">‚úÖ Connected</span>';
        toast('Supabase connected!', 'success');
        initializeApp();
    }
}

// ========== PROJECTS ==========
async function loadProjects() {
    if (!sb) return;
    
    try {
        const { data, error } = await sb.from('projects').select('*').order('created_at', { ascending: false });
        if (error) throw error;
        
        projects = data || [];
        
        // Load current project from localStorage
        const savedProjectId = localStorage.getItem('divertscan_current_project');
        if (savedProjectId) {
            currentProject = projects.find(p => p.id === savedProjectId);
        }
        if (!currentProject && projects.length > 0) {
            currentProject = projects[0];
            localStorage.setItem('divertscan_current_project', currentProject.id);
        }
        
        updateProjectDisplay();
        populateProjectDropdown();
    } catch (err) {
        console.error('Error loading projects:', err);
    }
}

function updateProjectDisplay() {
    if (currentProject) {
        document.getElementById('currentProjectName').textContent = currentProject.name;
        document.getElementById('currentProjectHauler').textContent = currentProject.waste_hauler || '';
    } else {
        document.getElementById('currentProjectName').textContent = 'No Project Selected';
        document.getElementById('currentProjectHauler').textContent = 'Create a project to get started';
    }
}

function populateProjectDropdown() {
    const select = document.getElementById('ticketProject');
    select.innerHTML = '<option value="">Select Project...</option>';
    
    projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        if (currentProject && p.id === currentProject.id) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function renderProjectsList() {
    const container = document.getElementById('projectsList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet. Create your first project!</p>';
        return;
    }
    
    container.innerHTML = projects.map(p => `
        <div class="card" style="cursor:pointer" onclick="selectProject('${p.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <div style="font-weight:600">${p.name}</div>
                    <div style="font-size:12px;color:var(--slate-400)">${p.waste_hauler || 'No hauler set'}</div>
                </div>
                ${currentProject && currentProject.id === p.id ? '<span style="color:var(--emerald-400)">‚úì Active</span>' : ''}
            </div>
        </div>
    `).join('');
}

function selectProject(projectId) {
    currentProject = projects.find(p => p.id === projectId);
    localStorage.setItem('divertscan_current_project', projectId);
    updateProjectDisplay();
    renderProjectsList();
    loadRecentTickets();
    updateStats();
    toast('Project selected: ' + currentProject.name, 'success');
}

function showProjectPicker() {
    const container = document.getElementById('projectPickerList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet.</p>';
    } else {
        container.innerHTML = projects.map(p => `
            <div class="card" style="cursor:pointer;margin-bottom:8px" onclick="selectProject('${p.id}');closeModal('projectPickerModal')">
                <div style="font-weight:600">${p.name}</div>
                <div style="font-size:12px;color:var(--slate-400)">${p.waste_hauler || ''}</div>
            </div>
        `).join('');
    }
    
    openModal('projectPickerModal');
}

function showNewProjectModal() {
    document.getElementById('projectName').value = '';
    document.getElementById('projectAddress').value = '';
    document.getElementById('projectHauler').value = '';
    document.getElementById('projectLeedTarget').value = '75';
    document.getElementById('projectGC').value = '';
    openModal('projectModal');
}

async function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) {
        toast('Project name is required', 'error');
        return;
    }
    
    if (!sb) {
        toast('Configure Supabase in Settings first', 'error');
        return;
    }
    
    const projectData = {
        name: name,
        address: document.getElementById('projectAddress').value.trim(),
        waste_hauler: document.getElementById('projectHauler').value.trim(),
        leed_target: parseInt(document.getElementById('projectLeedTarget').value) || 75,
        general_contractor: document.getElementById('projectGC').value.trim(),
        created_at: new Date().toISOString()
    };
    
    try {
        showLoading('Saving project...');
        const { data, error } = await sb.from('projects').insert([projectData]).select();
        hideLoading();
        
        if (error) throw error;
        
        closeModal('projectModal');
        toast('Project created!', 'success');
        
        await loadProjects();
        
        // Auto-select the new project
        if (data && data[0]) {
            selectProject(data[0].id);
        }
    } catch (err) {
        hideLoading();
        console.error('Error saving project:', err);
        toast('Error: ' + err.message, 'error');
    }
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ========== TICKETS ==========
async function loadRecentTickets() {
    if (!sb || !currentProject) {
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">Select a project to see tickets</p>';
        return;
    }
    
    try {
        const { data, error } = await sb
            .from('tickets')
            .select('*')
            .eq('project_id', currentProject.id)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) throw error;
        
        tickets = data || [];
        renderRecentTickets();
    } catch (err) {
        console.error('Error loading tickets:', err);
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--red-500)">Error loading tickets</p>';
    }
}

function renderRecentTickets() {
    const container = document.getElementById('recentTickets');
    
    if (tickets.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No tickets yet for this project</p>';
        return;
    }
    
    container.innerHTML = tickets.map(t => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--slate-700)">
            <div>
                <div style="font-weight:600">#${t.ticket_number || 'N/A'}</div>
                <div style="font-size:11px;color:var(--slate-400)">${formatDate(t.service_date)}</div>
            </div>
            <div style="text-align:right">
                <div style="color:var(--emerald-400);font-weight:600">${t.diversion_pct || 0}%</div>
                <div style="font-size:11px;color:var(--slate-400)">${(t.net_tons || 0).toFixed(2)} T</div>
            </div>
        </div>
    `).join('');
}

async function updateStats() {
    if (!sb || !currentProject) {
        document.getElementById('statTotalTons').textContent = '0.00';
        document.getElementById('statDiversionRate').textContent = '0%';
        return;
    }
    
    try {
        const { data, error } = await sb
            .from('tickets')
            .select('net_tons, diversion_pct, landfill_tons')
            .eq('project_id', currentProject.id);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
            const totalTons = data.reduce((sum, t) => sum + (t.net_tons || 0), 0);
            const totalLandfill = data.reduce((sum, t) => sum + (t.landfill_tons || 0), 0);
            const diversionRate = totalTons > 0 ? Math.round(((totalTons - totalLandfill) / totalTons) * 100) : 0;
            
            document.getElementById('statTotalTons').textContent = totalTons.toFixed(2);
            document.getElementById('statDiversionRate').textContent = diversionRate + '%';
        }
    } catch (err) {
        console.error('Error updating stats:', err);
    }
}

function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ========== GPS CAPTURE FOR AUDIT TRAIL ==========
function captureGPS() {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                ticketData.gpsLatitude = position.coords.latitude;
                ticketData.gpsLongitude = position.coords.longitude;
                ticketData.gpsAccuracy = position.coords.accuracy;
                console.log('GPS captured:', ticketData.gpsLatitude, ticketData.gpsLongitude, '¬±' + ticketData.gpsAccuracy + 'm');
            },
            (error) => {
                console.log('GPS not available:', error.message);
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }
}

// ========== TICKET MODAL ==========
function startNewTicket() {
    if (!currentProject) {
        toast('Please select a project first', 'error');
        showProjectPicker();
        return;
    }
    
    console.log('Starting new ticket');
    currentStep = 1;
    ticketData = {
        projectId: currentProject.id,
        ticketNumber: '',
        serviceDate: new Date().toISOString().split('T')[0],
        grossLbs: 0,
        tareLbs: 0,
        netTons: 0,
        hauler: currentProject.waste_hauler || '',
        containerSize: 30,
        photos: [],
        materials: { wood: 20, concrete: 15, metal: 10, cardboard: 20, plastic: 5, drywall: 10, landfill: 20 },
        diversionRate: 0,
        humanVerified: false,
        signature: null,
        scaleTicketPhoto: null,
        gpsLatitude: null,
        gpsLongitude: null,
        gpsAccuracy: null,
        captureTimestamp: new Date().toISOString(),
        signedBy: ''
    };
    debrisPhotos = [null, null, null];
    
    // Capture GPS location for audit trail
    captureGPS();
    
    // Reset form
    populateProjectDropdown();
    document.getElementById('ticketProject').value = currentProject.id;
    document.getElementById('serviceDate').value = ticketData.serviceDate;
    document.getElementById('ticketNumber').value = '';
    document.getElementById('grossLbs').value = '';
    document.getElementById('tareLbs').value = '';
    document.getElementById('netWeightDisplay').textContent = '0.00 tons';
    document.getElementById('haulerName').value = ticketData.hauler;
    document.getElementById('ticketImagePreview').innerHTML = '<span>Upload scale ticket photo</span>';
    document.getElementById('ticketImagePreview').classList.remove('filled');
    
    // Reset photos
    resetPhotoSlots();
    
    // Reset verification
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) checkbox.checked = false;
    const verifyBox = document.getElementById('verificationBox');
    if (verifyBox) verifyBox.classList.remove('verified');
    
    // Show step 1
    showStep(1);
    
    // Open modal
    document.getElementById('ticketModal').classList.add('active');
}

function closeTicketModal() {
    document.getElementById('ticketModal').classList.remove('active');
}

// ========== STEP NAVIGATION - CRITICAL ==========
function showStep(step) {
    console.log('===== SHOW STEP ' + step + ' =====');
    currentStep = step;
    
    // Hide ALL steps first
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('ticketStep' + i);
        if (stepEl) {
            stepEl.classList.add('hidden');
            stepEl.style.display = 'none';
            console.log('Hidden step ' + i);
        }
    }
    
    // Show current step
    const currentEl = document.getElementById('ticketStep' + step);
    if (currentEl) {
        currentEl.classList.remove('hidden');
        currentEl.style.display = 'block';
        console.log('Showing step ' + step);
    }
    
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById('stepIndicator' + i);
        if (indicator) {
            indicator.classList.remove('active', 'complete');
            if (i < step) indicator.classList.add('complete');
            else if (i === step) indicator.classList.add('active');
        }
        
        if (i < 4) {
            const line = document.getElementById('stepLine' + i);
            if (line) {
                line.classList.toggle('complete', i < step);
            }
        }
    }
    
    // Update buttons
    document.getElementById('backBtn').style.visibility = step === 1 ? 'hidden' : 'visible';
    document.getElementById('nextBtn').textContent = step === 4 ? '‚úÖ Submit' : 'Next';
    
    // Step-specific setup
    if (step === 2) {
        document.getElementById('step2TicketNum').textContent = ticketData.ticketNumber || '--';
        document.getElementById('step2NetWeight').textContent = ticketData.netTons.toFixed(2) + ' T';
    }
    
    if (step === 3) {
        populateReviewStep();
    }
    
    if (step === 4) {
        setupSignaturePad();
    }
    
    // Scroll to top of modal
    const modalBody = document.querySelector('#ticketModal .modal-body');
    if (modalBody) modalBody.scrollTop = 0;
}

function goBack() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function goNext() {
    console.log('goNext called, currentStep:', currentStep);
    
    // STEP 1 VALIDATION
    if (currentStep === 1) {
        const project = document.getElementById('ticketProject').value;
        const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
        const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
        
        if (!project) {
            toast('Please select a project', 'error');
            return;
        }
        if (!gross || !tare) {
            toast('Please enter gross and tare weights', 'error');
            return;
        }
        
        ticketData.projectId = project;
        ticketData.ticketNumber = document.getElementById('ticketNumber').value;
        ticketData.serviceDate = document.getElementById('serviceDate').value;
        ticketData.grossLbs = gross;
        ticketData.tareLbs = tare;
        ticketData.netTons = (gross - tare) / 2000;
        ticketData.hauler = document.getElementById('haulerName').value;
        
        showStep(2);
        return;
    }
    
    // STEP 2 VALIDATION
    if (currentStep === 2) {
        if (ticketData.diversionRate === 0) {
            if (debrisPhotos.some(p => p)) {
                toast('Click "Analyze Materials" first', 'error');
            } else {
                toast('Upload photos and analyze', 'error');
            }
            return;
        }
        
        showStep(3);
        return;
    }
    
    // STEP 3 VALIDATION - CHECK HUMAN VERIFICATION
    if (currentStep === 3) {
        const checkbox = document.getElementById('humanVerifyCheckbox');
        console.log('Checkbox element:', checkbox);
        console.log('Checkbox checked:', checkbox ? checkbox.checked : 'NOT FOUND');
        
        if (!checkbox || !checkbox.checked) {
            toast('Please check the verification box', 'error');
            return;
        }
        
        // Save materials from inputs BEFORE leaving Step 3
        const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
        let total = 0;
        
        keys.forEach(key => {
            const input = document.getElementById('mat_' + key);
            if (input) {
                ticketData.materials[key] = parseInt(input.value) || 0;
                total += ticketData.materials[key];
            }
        });
        
        console.log('Materials saved:', ticketData.materials, 'Total:', total);
        
        // Validate total
        if (total < 99 || total > 101) {
            toast('Materials must total 100% (currently ' + total + '%)', 'error');
            return;
        }
        
        // Recalculate diversion
        ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);
        ticketData.humanVerified = true;
        
        showStep(4);
        return;
    }
    
    // STEP 4 - SUBMIT
    if (currentStep === 4) {
        submitTicket();
        return;
    }
}

// ========== STEP 1: SCALE TICKET ==========
function handleTicketPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = e.target.result;
        document.getElementById('ticketImagePreview').innerHTML = '<img src="' + img + '">';
        document.getElementById('ticketImagePreview').classList.add('filled');
        
        // Store for audit trail
        ticketData.scaleTicketPhoto = img;
        ticketData.captureTimestamp = new Date().toISOString();
        
        // Run OCR
        analyzeScaleTicket(img);
    };
    reader.readAsDataURL(file);
}

async function analyzeScaleTicket(imageData) {
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add OpenAI API key in Settings', 'error');
        return;
    }
    
    showLoading('Reading scale ticket...');
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'text', text: 'Extract from this scale ticket. Return ONLY JSON: {"ticket_number":"string","date":"MM/DD/YYYY","gross_lbs":number,"tare_lbs":number,"hauler":"string"}' },
                        { type: 'image_url', image_url: { url: imageData } }
                    ]
                }],
                max_tokens: 500
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            toast('API Error: ' + data.error.message, 'error');
            return;
        }
        
        const text = data.choices[0].message.content;
        const match = text.match(/\{[\s\S]*\}/);
        
        if (match) {
            const result = JSON.parse(match[0]);
            
            document.getElementById('ticketNumber').value = result.ticket_number || '';
            document.getElementById('grossLbs').value = result.gross_lbs || '';
            document.getElementById('tareLbs').value = result.tare_lbs || '';
            document.getElementById('haulerName').value = result.hauler || '';
            
            if (result.date) {
                // Try to parse date
                const d = new Date(result.date);
                if (!isNaN(d)) {
                    document.getElementById('serviceDate').value = d.toISOString().split('T')[0];
                }
            }
            
            updateNetWeight();
            toast('‚úÖ Ticket read! Click Next to continue', 'success');
        }
    } catch (err) {
        hideLoading();
        console.error('OCR Error:', err);
        toast('Error reading ticket: ' + err.message, 'error');
    }
}

function updateNetWeight() {
    const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
    const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
    const netLbs = Math.max(0, gross - tare);
    const netTons = netLbs / 2000;
    
    ticketData.grossLbs = gross;
    ticketData.tareLbs = tare;
    ticketData.netTons = netTons;
    
    document.getElementById('netWeightDisplay').textContent = netTons.toFixed(2) + ' tons';
}

// ========== STEP 2: DEBRIS PHOTOS ==========
function selectContainer(size) {
    ticketData.containerSize = size;
    document.querySelectorAll('.container-option').forEach(el => {
        el.classList.toggle('selected', el.querySelector('span').textContent == (size || '?'));
    });
}

function resetPhotoSlots() {
    for (let i = 0; i < 3; i++) {
        const slot = document.getElementById('photoSlot' + i);
        if (slot) {
            slot.innerHTML = '‚ûï';
            slot.classList.remove('filled');
        }
    }
    document.getElementById('photoCount').textContent = '0';
    document.getElementById('analysisResult').classList.add('hidden');
}

function triggerPhotoUpload(slot) {
    currentPhotoSlot = slot;
    document.getElementById('debrisPhotoInput').click();
}

function triggerDebrisCamera() {
    // Find first empty slot
    for (let i = 0; i < 3; i++) {
        if (!debrisPhotos[i]) {
            currentPhotoSlot = i;
            break;
        }
    }
    document.getElementById('debrisPhotoInput').click();
}

function handleDebrisPhoto(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = e.target.result;
        debrisPhotos[currentPhotoSlot] = img;
        
        const slot = document.getElementById('photoSlot' + currentPhotoSlot);
        slot.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + currentPhotoSlot + ', event)">√ó</button>';
        slot.classList.add('filled');
        
        updatePhotoCount();
    };
    reader.readAsDataURL(file);
    
    event.target.value = '';
}

function handleMultiplePhotos(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    let slotIndex = 0;
    
    files.forEach((file, i) => {
        // Find next empty slot
        while (slotIndex < 3 && debrisPhotos[slotIndex]) {
            slotIndex++;
        }
        if (slotIndex >= 3) return; // No more slots
        
        const reader = new FileReader();
        const slot = slotIndex;
        
        reader.onload = function(e) {
            const img = e.target.result;
            debrisPhotos[slot] = img;
            
            const slotEl = document.getElementById('photoSlot' + slot);
            slotEl.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + slot + ', event)">√ó</button>';
            slotEl.classList.add('filled');
            
            updatePhotoCount();
        };
        reader.readAsDataURL(file);
        slotIndex++;
    });
    
    event.target.value = '';
}

function removePhoto(index, event) {
    event.stopPropagation();
    debrisPhotos[index] = null;
    
    const slot = document.getElementById('photoSlot' + index);
    slot.innerHTML = '‚ûï';
    slot.classList.remove('filled');
    
    updatePhotoCount();
}

function updatePhotoCount() {
    const count = debrisPhotos.filter(p => p).length;
    document.getElementById('photoCount').textContent = count;
}

async function analyzeDebris() {
    const photos = debrisPhotos.filter(p => p);
    if (photos.length === 0) {
        toast('Upload at least 1 photo', 'error');
        return;
    }
    
    const apiKey = localStorage.getItem('divertscan_openai');
    if (!apiKey) {
        toast('Add OpenAI API key in Settings', 'error');
        return;
    }
    
    showLoading('Analyzing materials...');
    
    try {
        const content = [
            { type: 'text', text: `You are an expert C&D waste auditor. Analyze these debris photos for LEED MRc5 reporting.

MATERIAL IDENTIFICATION:
- WOOD: lumber, plywood, pallets, OSB, framing - tan/brown with grain
- CONCRETE/BRICK/MASONRY: gray concrete chunks, cinder blocks, brick, stone
- METAL: steel studs, rebar, pipes, ductwork, wire - metallic/shiny
- OCC/CARDBOARD: brown corrugated boxes, shipping cartons
- PLASTIC: shrink wrap, buckets, PVC pipe, bottles
- DRYWALL: white/cream gypsum board sheets
- TRASH/LANDFILL: mixed bags, furniture, carpet, food waste, unidentifiable debris

REALISTIC PATTERNS FROM ACTUAL RECYCLING FACILITIES:
- ONE material typically dominates (40-60% of load)
- Landfill/Trash is typically 20-30% for mixed loads
- Some materials will be 0% if not visible
- Construction framing debris: Wood 50-60%, Landfill 20-25%, rest split
- Demolition debris: Concrete 40-50%, Metal 15-20%, Landfill 20-25%
- Commercial cleanout: Cardboard 30-40%, Landfill 30-40%

DO NOT give flat distributions like 15-20% for everything.
If you see mostly wood, give wood 50%+ and others less.
If a material is NOT visible, give it 0%.

Return ONLY JSON:
{"wood":X,"concrete":X,"metal":X,"cardboard":X,"plastic":X,"drywall":X,"landfill":X}

Must total exactly 100.` }
        ];
{"wood":X,"concrete":X,"metal":X,"cardboard":X,"plastic":X,"drywall":X,"landfill":X}

Total must equal 100.` }
        ];
        
        photos.forEach(p => {
            content.push({ type: 'image_url', image_url: { url: p } });
        });
        
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: content }],
                max_tokens: 500
            })
        });
        
        const data = await response.json();
        hideLoading();
        
        if (data.error) {
            toast('API Error: ' + data.error.message, 'error');
            return;
        }
        
        let text = data.choices[0].message.content;
        text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
        
        const match = text.match(/\{[\s\S]*\}/);
        if (match) {
            const result = JSON.parse(match[0]);
            
            // Normalize to 100% if needed
            const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
            let total = 0;
            keys.forEach(k => { total += (result[k] || 0); });
            
            console.log('AI raw response:', result, 'Total:', total);
            
            if (total > 0 && total !== 100) {
                // Normalize
                const factor = 100 / total;
                keys.forEach(k => {
                    result[k] = Math.round((result[k] || 0) * factor);
                });
                // Adjust to exactly 100
                let newTotal = 0;
                keys.forEach(k => { newTotal += result[k]; });
                if (newTotal !== 100) {
                    result.landfill += (100 - newTotal);
                }
            }
            
            // VALIDATION: Ensure realistic patterns
            let warnings = [];
            
            // Minimum 20% landfill for mixed loads (based on HD Waste real data: 23%)
            if (result.landfill < 20) {
                const deficit = 20 - result.landfill;
                result.landfill = 20;
                // Take from highest category
                const maxKey = keys.filter(k => k !== 'landfill').reduce((a, b) => result[a] > result[b] ? a : b);
                result[maxKey] = Math.max(0, result[maxKey] - deficit);
                warnings.push('Landfill adjusted to realistic minimum (20%)');
            }
            
            // Cap diversion at 80% (based on real facility data)
            if ((100 - result.landfill) > 80) {
                const excess = (100 - result.landfill) - 80;
                result.landfill += excess;
                const maxKey = keys.filter(k => k !== 'landfill').reduce((a, b) => result[a] > result[b] ? a : b);
                result[maxKey] = Math.max(0, result[maxKey] - excess);
            }
            
            // Warning: Concrete high without visible concrete
            if (result.concrete > 25) {
                warnings.push('High concrete (' + result.concrete + '%) - verify this is actual concrete, not furniture');
            }
            
            // Log warnings
            if (warnings.length > 0) {
                console.log('AI Analysis Warnings:', warnings);
            }
            
            ticketData.materials = result;
            
            // Calculate diversion (everything except landfill)
            const landfill = result.landfill || 0;
            ticketData.diversionRate = 100 - landfill;
            
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = ticketData.diversionRate + '%';
            
            // Show color based on realistic range
            const rateEl = document.getElementById('analysisRate');
            if (ticketData.diversionRate > 90) {
                rateEl.style.color = 'var(--amber-400)'; // Suspicious - too high
            } else if (ticketData.diversionRate >= 75) {
                rateEl.style.color = 'var(--emerald-400)'; // Good - meets LEED
            } else if (ticketData.diversionRate >= 50) {
                rateEl.style.color = 'var(--amber-400)'; // Below target
            } else {
                rateEl.style.color = 'var(--red-500)'; // Poor
            }
            
            console.log('Final materials:', ticketData.materials, 'Diversion:', ticketData.diversionRate + '%');
            
            // Show appropriate message
            if (warnings.length > 0) {
                toast('‚ö†Ô∏è ' + ticketData.diversionRate + '% - Review materials in Step 3', 'warning');
            } else {
                toast('‚úÖ ' + ticketData.diversionRate + '% diversion - Click Next', 'success');
            }
        } else {
            // Fallback
            ticketData.materials = { wood: 25, concrete: 20, metal: 10, cardboard: 15, plastic: 5, drywall: 5, landfill: 20 };
            ticketData.diversionRate = 80;
            
            document.getElementById('analysisResult').classList.remove('hidden');
            document.getElementById('analysisRate').textContent = '80%';
            
            toast('‚ö†Ô∏è Using estimates - adjust in Step 3', 'success');
        }
        
    } catch (err) {
        hideLoading();
        console.error('Analysis error:', err);
        toast('Analysis failed: ' + err.message, 'error');
    }
}

// ========== STEP 3: REVIEW ==========
function populateReviewStep() {
    console.log('Populating review step');
    
    // Update diversion display
    document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
    document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
    
    // Build materials list
    const materials = ticketData.materials;
    const names = {
        wood: 'ü™µ Wood',
        concrete: 'üß± Concrete',
        metal: 'üî© Metal',
        cardboard: 'üì¶ Cardboard',
        plastic: '‚ôªÔ∏è Plastic',
        drywall: 'üèóÔ∏è Drywall',
        landfill: 'üóëÔ∏è Landfill'
    };
    
    const container = document.getElementById('materialsList');
    container.innerHTML = '';
    
    Object.entries(materials).forEach(([key, value]) => {
        const div = document.createElement('div');
        div.className = 'material-item';
        div.innerHTML = '<span class="material-name">' + (names[key] || key) + '</span>' +
            '<div class="material-input">' +
            '<input type="number" id="mat_' + key + '" value="' + (value || 0) + '" min="0" max="100">' +
            '<span>%</span></div>';
        
        // Add event listener properly
        const input = div.querySelector('input');
        input.addEventListener('input', function() {
            updateMaterial(key);
        });
        
        container.appendChild(div);
    });
    
    updateMaterialsTotal();
    
    // Reset verification checkbox
    const checkbox = document.getElementById('humanVerifyCheckbox');
    if (checkbox) {
        checkbox.checked = ticketData.humanVerified;
        onVerificationChange();
    }
}

function updateMaterial(key) {
    const input = document.getElementById('mat_' + key);
    if (input) {
        const newValue = parseInt(input.value) || 0;
        ticketData.materials[key] = newValue;
        
        // Recalculate diversion (100 - landfill%)
        const landfill = ticketData.materials.landfill || 0;
        ticketData.diversionRate = 100 - landfill;
        document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
        document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
        
        // Update color based on LEED target
        const badge = document.getElementById('reviewDiversionRate');
        if (ticketData.diversionRate >= 75) {
            badge.style.color = 'var(--emerald-400)';
        } else if (ticketData.diversionRate >= 50) {
            badge.style.color = 'var(--amber-400)';
        } else {
            badge.style.color = 'var(--red-500)';
        }
        
        updateMaterialsTotal();
    }
}

function updateMaterialsTotal() {
    // Read directly from inputs to ensure accuracy
    let total = 0;
    const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
    
    keys.forEach(key => {
        const input = document.getElementById('mat_' + key);
        if (input) {
            const val = parseInt(input.value) || 0;
            ticketData.materials[key] = val;
            total += val;
        }
    });
    
    const totalEl = document.getElementById('materialsTotal');
    totalEl.textContent = total + '%';
    totalEl.style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
}

function onVerificationChange() {
    const checkbox = document.getElementById('humanVerifyCheckbox');
    const box = document.getElementById('verificationBox');
    
    if (checkbox && box) {
        if (checkbox.checked) {
            box.classList.add('verified');
            ticketData.humanVerified = true;
        } else {
            box.classList.remove('verified');
            ticketData.humanVerified = false;
        }
    }
}

// ========== STEP 4: SIGNATURE ==========
function setupSignaturePad() {
    const canvas = document.getElementById('signaturePad');
    if (!canvas) return;
    
    signatureCanvas = canvas;
    signatureCtx = canvas.getContext('2d');
    
    // Set size
    canvas.width = canvas.offsetWidth;
    canvas.height = 150;
    
    // Clear
    signatureCtx.fillStyle = 'white';
    signatureCtx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Events
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    draw(e);
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    signatureCtx.lineWidth = 2;
    signatureCtx.lineCap = 'round';
    signatureCtx.strokeStyle = 'black';
    
    signatureCtx.lineTo(x, y);
    signatureCtx.stroke();
    signatureCtx.beginPath();
    signatureCtx.moveTo(x, y);
}

function stopDrawing() {
    isDrawing = false;
    signatureCtx.beginPath();
}

function handleTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    startDrawing(mouseEvent);
}

function handleTouchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    draw(mouseEvent);
}

function clearSignature() {
    if (signatureCtx && signatureCanvas) {
        signatureCtx.fillStyle = 'white';
        signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    }
}

// ========== SUBMIT ==========
async function submitTicket() {
    console.log('submitTicket called');
    
    // Check signature
    if (signatureCanvas) {
        const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
        let hasSignature = false;
        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i] < 250) { // Not pure white
                hasSignature = true;
                break;
            }
        }
        if (!hasSignature) {
            toast('Please sign to submit', 'error');
            return;
        }
        ticketData.signature = signatureCanvas.toDataURL();
    }
    
    // Read materials fresh from inputs
    const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
    let total = 0;
    let foundInputs = 0;
    
    keys.forEach(key => {
        const input = document.getElementById('mat_' + key);
        if (input) {
            foundInputs++;
            ticketData.materials[key] = parseInt(input.value) || 0;
            total += ticketData.materials[key];
        } else {
            // Fallback to ticketData if input not found
            total += ticketData.materials[key] || 0;
        }
    });
    
    console.log('Materials check - Inputs found:', foundInputs, 'Total:', total, ticketData.materials);
    
    // Allow some tolerance (98-102%)
    if (total < 98 || total > 102) {
        toast('Materials must total 100% (currently ' + total + '%). Go back to Step 3 to adjust.', 'error');
        return;
    }
    
    // Recalculate diversion rate
    ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);
    
    // Calculate material tons
    const m = ticketData.materials;
    const netTons = ticketData.netTons || 0;
    
    // Build database record with ONLY columns that exist
    const dbRecord = {
        project_id: ticketData.projectId,
        ticket_number: ticketData.ticketNumber || '',
        service_date: ticketData.serviceDate || new Date().toISOString().split('T')[0],
        hauler: ticketData.hauler || '',
        container_size: ticketData.containerSize || 30,
        gross_lbs: ticketData.grossLbs || 0,
        tare_lbs: ticketData.tareLbs || 0,
        net_lbs: (ticketData.grossLbs || 0) - (ticketData.tareLbs || 0),
        net_tons: netTons,
        wood_pct: m.wood || 0,
        concrete_pct: m.concrete || 0,
        metal_pct: m.metal || 0,
        cardboard_pct: m.cardboard || 0,
        plastic_pct: m.plastic || 0,
        drywall_pct: m.drywall || 0,
        landfill_pct: m.landfill || 0,
        wood_tons: ((m.wood || 0) / 100) * netTons,
        concrete_tons: ((m.concrete || 0) / 100) * netTons,
        metal_tons: ((m.metal || 0) / 100) * netTons,
        cardboard_tons: ((m.cardboard || 0) / 100) * netTons,
        plastic_tons: ((m.plastic || 0) / 100) * netTons,
        drywall_tons: ((m.drywall || 0) / 100) * netTons,
        landfill_tons: ((m.landfill || 0) / 100) * netTons,
        diversion_pct: ticketData.diversionRate,
        diverted_tons: netTons * (ticketData.diversionRate / 100),
        human_verified: ticketData.humanVerified || false,
        photo_count: debrisPhotos.filter(p => p).length,
        signature: ticketData.signature || null,
        signed_at: new Date().toISOString(),
        is_closed: true,
        created_at: new Date().toISOString()
    };
    
    // Only add optional columns if they have values (to avoid column not found errors)
    if (ticketData.scaleTicketPhoto) dbRecord.scale_ticket_photo = ticketData.scaleTicketPhoto;
    if (debrisPhotos[0]) dbRecord.debris_photo_1 = debrisPhotos[0];
    if (debrisPhotos[1]) dbRecord.debris_photo_2 = debrisPhotos[1];
    if (debrisPhotos[2]) dbRecord.debris_photo_3 = debrisPhotos[2];
    if (ticketData.gpsLatitude) dbRecord.gps_latitude = ticketData.gpsLatitude;
    if (ticketData.gpsLongitude) dbRecord.gps_longitude = ticketData.gpsLongitude;
    if (ticketData.gpsAccuracy) dbRecord.gps_accuracy = ticketData.gpsAccuracy;
    if (ticketData.captureTimestamp) dbRecord.capture_timestamp = ticketData.captureTimestamp;
    if (ticketData.signedBy) dbRecord.signed_by = ticketData.signedBy;
    
    console.log('dbRecord to save:', Object.keys(dbRecord));
    
    if (sb) {
        try {
            showLoading('Saving ticket...');
            const { data, error } = await sb.from('tickets').insert([dbRecord]);
            hideLoading();
            
            if (error) {
                console.error('Database error:', error);
                // Show specific error to help debug
                if (error.message.includes('column')) {
                    toast('Database column error: ' + error.message + '. Run schema update SQL.', 'error');
                } else if (error.message.includes('violates')) {
                    toast('Database constraint error: ' + error.message, 'error');
                } else {
                    toast('Save error: ' + error.message, 'error');
                }
                return;
            }
            
            closeTicketModal();
            toast('‚úÖ Ticket #' + ticketData.ticketNumber + ' saved!', 'success');
            loadRecentTickets();
            updateStats();
        } catch (err) {
            hideLoading();
            console.error('Submit error:', err);
            toast('Error: ' + err.message, 'error');
        }
    } else {
        // No Supabase - just show success
        console.log('Ticket data (not saved - no DB):', dbRecord);
        closeTicketModal();
        toast('‚úÖ Ticket recorded (configure Supabase to save)', 'success');
    }
}

// ========== UTILITIES ==========
function showLoading(text) {
    document.getElementById('loadingText').textContent = text || 'Processing...';
    document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}

function toast(message, type) {
    const t = document.getElementById('toast');
    t.textContent = message;
    t.className = 'toast show ' + (type || '');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// ========== REPORTS ==========
let reportData = [];

async function generateReport() {
    console.log('generateReport called');
    console.log('sb:', sb);
    console.log('currentProject:', currentProject);
    
    if (!sb) {
        toast('Configure Supabase in Settings first', 'error');
        return;
    }
    
    if (!currentProject) {
        toast('Select a project first', 'error');
        return;
    }
    
    showLoading('Generating report...');
    
    try {
        console.log('Fetching tickets for project:', currentProject.id);
        
        const { data, error } = await sb
            .from('tickets')
            .select('*')
            .eq('project_id', currentProject.id)
            .order('service_date', { ascending: true });
        
        if (error) {
            console.error('Database error:', error);
            throw error;
        }
        
        reportData = data || [];
        console.log('Tickets found:', reportData.length);
        hideLoading();
        
        if (reportData.length === 0) {
            toast('No tickets found for this project. Submit some tickets first!', 'error');
            return;
        }
        
        // Show download buttons
        document.getElementById('reportDownloadBtns').style.display = 'grid';
        
        // Project Header
        document.getElementById('reportProjectName').textContent = currentProject.name || '-';
        document.getElementById('reportProjectAddress').textContent = currentProject.address || '-';
        document.getElementById('reportProjectGC').textContent = currentProject.general_contractor || '-';
        document.getElementById('reportProjectHauler').textContent = currentProject.waste_hauler || '-';
        document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('reportGeneratedDate').textContent = new Date().toLocaleString();
        
        // Calculate date range
        const dates = reportData.map(t => new Date(t.service_date)).filter(d => !isNaN(d));
        if (dates.length > 0) {
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));
            document.getElementById('reportPeriod').textContent = 
                minDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' - ' +
                maxDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Calculate totals
        let totalTons = 0, landfillTons = 0;
        let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0;
        let plasticTons = 0, drywallTons = 0;
        
        reportData.forEach(t => {
            totalTons += t.net_tons || 0;
            landfillTons += t.landfill_tons || 0;
            woodTons += t.wood_tons || 0;
            concreteTons += t.concrete_tons || 0;
            metalTons += t.metal_tons || 0;
            cardboardTons += t.cardboard_tons || 0;
            plasticTons += t.plastic_tons || 0;
            drywallTons += t.drywall_tons || 0;
        });
        
        const divertedTons = totalTons - landfillTons;
        const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
        
        // Update summary
        document.getElementById('reportTicketCount').textContent = reportData.length;
        document.getElementById('reportLoadCount').textContent = reportData.length + ' loads';
        document.getElementById('reportTotalTons').textContent = totalTons.toFixed(2);
        document.getElementById('reportDivertedTons').textContent = divertedTons.toFixed(2);
        document.getElementById('reportLandfillTons').textContent = landfillTons.toFixed(2);
        document.getElementById('reportTotalDiverted').textContent = divertedTons.toFixed(2) + ' T';
        document.getElementById('reportTotalLandfill').textContent = landfillTons.toFixed(2) + ' T';
        
        // Diversion rate with color
        const rateEl = document.getElementById('reportDiversionRate');
        rateEl.textContent = diversionRate + '%';
        rateEl.style.color = diversionRate >= 75 ? 'var(--emerald-400)' : diversionRate >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
        
        // LEED Status
        const statusEl = document.getElementById('reportLeedStatus');
        if (diversionRate >= 75) {
            statusEl.textContent = '‚úÖ PASS';
            statusEl.style.color = 'var(--emerald-400)';
        } else if (diversionRate >= 50) {
            statusEl.textContent = '‚ö†Ô∏è PARTIAL';
            statusEl.style.color = 'var(--amber-400)';
        } else {
            statusEl.textContent = '‚ùå BELOW';
            statusEl.style.color = 'var(--red-500)';
        }
        
        // Material breakdown with progress bars
        const materials = [
            { name: 'Wood', icon: 'ü™µ', tons: woodTons, diverted: true },
            { name: 'Concrete/Masonry', icon: 'üß±', tons: concreteTons, diverted: true },
            { name: 'Metal', icon: 'üî©', tons: metalTons, diverted: true },
            { name: 'Cardboard/Paper', icon: 'üì¶', tons: cardboardTons, diverted: true },
            { name: 'Plastic', icon: '‚ôªÔ∏è', tons: plasticTons, diverted: true },
            { name: 'Drywall', icon: 'üèóÔ∏è', tons: drywallTons, diverted: true },
            { name: 'Landfill', icon: 'üóëÔ∏è', tons: landfillTons, diverted: false }
        ];
        
        document.getElementById('reportMaterialBreakdown').innerHTML = materials.map(m => {
            const pct = totalTons > 0 ? (m.tons / totalTons) * 100 : 0;
            const barColor = m.diverted ? 'var(--emerald-500)' : 'var(--red-500)';
            return `
                <div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                        <span>${m.icon} ${m.name}</span>
                        <span style="font-weight:600">${m.tons.toFixed(2)} T (${pct.toFixed(1)}%)</span>
                    </div>
                    <div style="height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden">
                        <div style="height:100%;width:${Math.min(pct, 100)}%;background:${barColor}"></div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Detailed ticket table
        document.getElementById('reportContent').innerHTML = `
            <table style="width:100%;font-size:11px;border-collapse:collapse">
                <thead>
                    <tr style="border-bottom:2px solid var(--slate-600);text-align:left">
                        <th style="padding:8px">Date</th>
                        <th style="padding:8px">Ticket #</th>
                        <th style="padding:8px">Hauler</th>
                        <th style="padding:8px;text-align:right">Gross</th>
                        <th style="padding:8px;text-align:right">Tare</th>
                        <th style="padding:8px;text-align:right">Net (T)</th>
                        <th style="padding:8px;text-align:right">Diversion</th>
                        <th style="padding:8px;text-align:center">Verified</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(t => `
                        <tr style="border-bottom:1px solid var(--slate-700)">
                            <td style="padding:8px">${formatDate(t.service_date)}</td>
                            <td style="padding:8px">${t.ticket_number || '-'}</td>
                            <td style="padding:8px">${t.hauler || '-'}</td>
                            <td style="padding:8px;text-align:right">${(t.gross_lbs || 0).toLocaleString()}</td>
                            <td style="padding:8px;text-align:right">${(t.tare_lbs || 0).toLocaleString()}</td>
                            <td style="padding:8px;text-align:right;font-weight:600">${(t.net_tons || 0).toFixed(2)}</td>
                            <td style="padding:8px;text-align:right;color:${(t.diversion_pct || 0) >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'}">${t.diversion_pct || 0}%</td>
                            <td style="padding:8px;text-align:center">${t.human_verified ? '‚úÖ' : '‚ùå'}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr style="border-top:2px solid var(--slate-600);font-weight:600">
                        <td style="padding:8px" colspan="5">TOTALS</td>
                        <td style="padding:8px;text-align:right">${totalTons.toFixed(2)}</td>
                        <td style="padding:8px;text-align:right;color:${diversionRate >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'}">${diversionRate}%</td>
                        <td style="padding:8px;text-align:center">${reportData.filter(t => t.human_verified).length}/${reportData.length}</td>
                    </tr>
                </tfoot>
            </table>
        `;
        
        document.getElementById('reportOutput').classList.remove('hidden');
        toast('Report generated!', 'success');
        
    } catch (err) {
        hideLoading();
        console.error('Report error:', err);
        toast('Error generating report: ' + err.message, 'error');
    }
}

function downloadReportCSV() {
    if (reportData.length === 0) {
        toast('Generate a report first', 'error');
        return;
    }
    
    // Create comprehensive CSV
    const projectInfo = [
        ['LEED MRc5 WASTE DIVERSION REPORT'],
        [''],
        ['Project Name', currentProject.name || ''],
        ['Project Address', currentProject.address || ''],
        ['General Contractor', currentProject.general_contractor || ''],
        ['Waste Hauler', currentProject.waste_hauler || ''],
        ['Report Date', new Date().toLocaleDateString()],
        [''],
        ['SUMMARY'],
        ['Total Loads', reportData.length],
        ['Total Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0).toFixed(2)],
        ['Diverted Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0).toFixed(2)],
        ['Landfill Tons', reportData.reduce((sum, t) => sum + (t.landfill_tons || 0), 0).toFixed(2)],
        ['Diversion Rate', (reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0) > 0 ? 
            Math.round((reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0) / 
            reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0)) * 100) : 0) + '%'],
        [''],
        ['LOAD DETAILS'],
        ['Date', 'Ticket #', 'Hauler', 'Container', 'Gross Lbs', 'Tare Lbs', 'Net Tons', 
         'Wood %', 'Concrete %', 'Metal %', 'Cardboard %', 'Plastic %', 'Drywall %', 'Landfill %',
         'Wood Tons', 'Concrete Tons', 'Metal Tons', 'Cardboard Tons', 'Plastic Tons', 'Drywall Tons', 'Landfill Tons',
         'Diversion %', 'Human Verified', 'GPS Lat', 'GPS Long', 'Photos']
    ];
    
    const rows = reportData.map(t => [
        t.service_date,
        t.ticket_number || '',
        t.hauler || '',
        t.container_size || '',
        t.gross_lbs || 0,
        t.tare_lbs || 0,
        (t.net_tons || 0).toFixed(2),
        t.wood_pct || 0,
        t.concrete_pct || 0,
        t.metal_pct || 0,
        t.cardboard_pct || 0,
        t.plastic_pct || 0,
        t.drywall_pct || 0,
        t.landfill_pct || 0,
        (t.wood_tons || 0).toFixed(2),
        (t.concrete_tons || 0).toFixed(2),
        (t.metal_tons || 0).toFixed(2),
        (t.cardboard_tons || 0).toFixed(2),
        (t.plastic_tons || 0).toFixed(2),
        (t.drywall_tons || 0).toFixed(2),
        (t.landfill_tons || 0).toFixed(2),
        t.diversion_pct || 0,
        t.human_verified ? 'Yes' : 'No',
        t.gps_latitude || '',
        t.gps_longitude || '',
        t.photo_count || 0
    ]);
    
    const allRows = [...projectInfo, ...rows];
    const csv = allRows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `LEED_MRc5_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    toast('CSV downloaded!', 'success');
}

function downloadReportPDF() {
    if (reportData.length === 0) {
        toast('Generate a report first', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    // Calculate totals
    let totalTons = 0, landfillTons = 0;
    let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0, plasticTons = 0, drywallTons = 0;
    
    reportData.forEach(t => {
        totalTons += t.net_tons || 0;
        landfillTons += t.landfill_tons || 0;
        woodTons += t.wood_tons || 0;
        concreteTons += t.concrete_tons || 0;
        metalTons += t.metal_tons || 0;
        cardboardTons += t.cardboard_tons || 0;
        plasticTons += t.plastic_tons || 0;
        drywallTons += t.drywall_tons || 0;
    });
    
    const divertedTons = totalTons - landfillTons;
    const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
    
    let y = 15;
    
    // Header - Right aligned company info
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text('Jaguar Waste Management', 280, y, { align: 'right' });
    y += 6;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('214-487-3457', 280, y, { align: 'right' });
    
    // Left side - Recipient
    y = 15;
    doc.setFontSize(9);
    doc.text('ATTN: ' + (currentProject.general_contractor || 'Project Manager'), 14, y);
    y += 5;
    doc.text('RE: ' + (currentProject.name || 'Construction Project'), 14, y);
    y += 8;
    doc.text('Date: ' + new Date().toLocaleDateString(), 14, y);
    y += 10;
    
    // Letter body
    doc.text('Dear Client,', 14, y);
    y += 6;
    const reportMonth = reportData.length > 0 && reportData[0].service_date ? 
        new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 
        'Current Period';
    doc.text('Below are the tonnage reports for ' + reportMonth + '. The report lists all the information needed for each haul.', 14, y);
    y += 12;
    
    // Project Site Address Box
    doc.setFillColor(240, 240, 240);
    doc.rect(14, y, 100, 10, 'F');
    doc.setFontSize(11);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(34, 139, 34); // Green color like HD Waste
    doc.text(currentProject.address || currentProject.name || 'Project Site', 18, y + 7);
    doc.setTextColor(0, 0, 0);
    y += 18;
    
    // Table Header
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.setFillColor(255, 255, 255);
    
    const colX = [14, 34, 64, 94, 124, 154, 179, 204, 229, 254];
    const colW = [20, 30, 30, 30, 30, 25, 25, 25, 25, 25];
    const headers = ['Month', 'Date', 'W/O & TKT #', 'Total Ton', 'BRK/BLCK/CON', 'Metal/Alum', 'OCC', 'Plastic', 'Wood', 'Trash'];
    
    // Draw header row
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    headers.forEach((h, i) => {
        doc.rect(colX[i], y, colW[i], 8);
        doc.text(h, colX[i] + 2, y + 5.5);
    });
    y += 8;
    
    // Get month name for first column
    const monthName = reportData.length > 0 && reportData[0].service_date ? 
        new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long' }) : '';
    
    // Data rows
    doc.setFont('helvetica', 'normal');
    let firstRow = true;
    
    reportData.forEach((t, idx) => {
        if (y > 180) {
            doc.addPage('landscape');
            y = 20;
            // Redraw header on new page
            doc.setFont('helvetica', 'bold');
            headers.forEach((h, i) => {
                doc.rect(colX[i], y, colW[i], 8);
                doc.text(h, colX[i] + 2, y + 5.5);
            });
            y += 8;
            doc.setFont('helvetica', 'normal');
            firstRow = true;
        }
        
        const rowData = [
            firstRow ? monthName : '',
            t.service_date ? new Date(t.service_date).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'numeric'}) : '',
            t.ticket_number || '',
            (t.net_tons || 0).toFixed(2),
            (t.concrete_tons || 0) > 0 ? (t.concrete_tons || 0).toFixed(2) : '',
            (t.metal_tons || 0) > 0 ? (t.metal_tons || 0).toFixed(2) : '',
            (t.cardboard_tons || 0) > 0 ? (t.cardboard_tons || 0).toFixed(2) : '',
            (t.plastic_tons || 0) > 0 ? (t.plastic_tons || 0).toFixed(2) : '',
            (t.wood_tons || 0) > 0 ? (t.wood_tons || 0).toFixed(2) : '',
            (t.landfill_tons || 0) > 0 ? (t.landfill_tons || 0).toFixed(2) : ''
        ];
        
        rowData.forEach((d, i) => {
            doc.rect(colX[i], y, colW[i], 6);
            doc.text(String(d), colX[i] + 2, y + 4);
        });
        
        y += 6;
        firstRow = false;
    });
    
    // Totals row
    y += 2;
    doc.setFont('helvetica', 'bold');
    const totalsData = [
        '', 'Total:', '', 
        totalTons.toFixed(2),
        concreteTons.toFixed(2),
        metalTons.toFixed(2),
        cardboardTons.toFixed(2),
        plasticTons.toFixed(2),
        woodTons.toFixed(2),
        landfillTons.toFixed(2)
    ];
    
    totalsData.forEach((d, i) => {
        doc.rect(colX[i], y, colW[i], 6);
        doc.text(String(d), colX[i] + 2, y + 4);
    });
    y += 6;
    
    // Percentage row
    const pctData = [
        '', 'Percentage:', '',
        '',
        totalTons > 0 ? Math.round((concreteTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((metalTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((cardboardTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((plasticTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((woodTons/totalTons)*100) + '%' : '0%',
        totalTons > 0 ? Math.round((landfillTons/totalTons)*100) + '%' : '0%'
    ];
    
    pctData.forEach((d, i) => {
        doc.rect(colX[i], y, colW[i], 6);
        doc.text(String(d), colX[i] + 2, y + 4);
    });
    y += 12;
    
    // Diversion Summary
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('DIVERSION SUMMARY', 14, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('Total Diverted: ' + divertedTons.toFixed(2) + ' tons (' + diversionRate + '%)', 14, y);
    y += 5;
    doc.text('Total Landfill: ' + landfillTons.toFixed(2) + ' tons (' + (100-diversionRate) + '%)', 14, y);
    y += 5;
    doc.setFont('helvetica', 'bold');
    doc.text('LEED MRc5 Status: ' + (diversionRate >= 75 ? 'COMPLIANT (>=75%)' : 'NON-COMPLIANT (<75%)'), 14, y);
    
    // Footer
    const pageHeight = doc.internal.pageSize.height;
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    doc.text('Generated by DivertScan‚Ñ¢ | ' + new Date().toLocaleString(), 14, pageHeight - 10);
    doc.text(currentProject.waste_hauler || 'Jaguar Waste Management', 280, pageHeight - 10, { align: 'right' });
    
    // Save
    doc.save(`Tonnage_Report_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
    
    toast('PDF downloaded!', 'success');
}
</script>

</body>
</html>
