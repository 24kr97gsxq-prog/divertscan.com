<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">
<title>DivertScanâ„¢ v7.7 Enterprise Edition</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ========== COLOR THEME SYSTEM ========== */
:root{
/* Default Theme: Dark Slate (Original) */
--bg-primary:#0f172a;
--bg-secondary:#1e293b;
--bg-tertiary:#334155;
--bg-hover:#475569;
--text-primary:#e2e8f0;
--text-secondary:#94a3b8;
--text-muted:#64748b;
--accent-primary:#10b981;
--accent-secondary:#34d399;
--accent-warning:#f59e0b;
--accent-danger:#ef4444;
--accent-info:#3b82f6;
--border-color:#334155;
--card-bg:#1e293b;
--input-bg:#1e293b;
--nav-bg:rgba(15,23,42,0.95);
--dalmex-green:#2d5a27;
/* Legacy variables for compatibility */
--slate-900:#0f172a;--slate-800:#1e293b;--slate-700:#334155;--slate-600:#475569;--slate-500:#64748b;--slate-400:#94a3b8;--slate-300:#cbd5e1;--slate-200:#e2e8f0;--emerald-500:#10b981;--emerald-400:#34d399;--amber-500:#f59e0b;--amber-400:#fbbf24;--red-500:#ef4444;--blue-500:#3b82f6
}

/* Theme: DalMex Green */
[data-theme=â€œdalmexâ€]{
â€“bg-primary:#1a2e1a;
â€“bg-secondary:#243524;
â€“bg-tertiary:#2d5a27;
â€“bg-hover:#3d6d35;
â€“text-primary:#e8f5e9;
â€“text-secondary:#a5d6a7;
â€“text-muted:#81c784;
â€“accent-primary:#4caf50;
â€“accent-secondary:#81c784;
â€“accent-warning:#ffb74d;
â€“accent-danger:#ef5350;
â€“accent-info:#64b5f6;
â€“border-color:#2d5a27;
â€“card-bg:#243524;
â€“input-bg:#1a2e1a;
â€“nav-bg:rgba(26,46,26,0.95);
â€“slate-900:#1a2e1a;â€“slate-800:#243524;â€“slate-700:#2d5a27;â€“emerald-500:#4caf50;â€“emerald-400:#81c784
}

/* Theme: Ocean Blue */
[data-theme=â€œoceanâ€]{
â€“bg-primary:#0a1929;
â€“bg-secondary:#132f4c;
â€“bg-tertiary:#1e4976;
â€“bg-hover:#265d97;
â€“text-primary:#e3f2fd;
â€“text-secondary:#90caf9;
â€“text-muted:#64b5f6;
â€“accent-primary:#2196f3;
â€“accent-secondary:#64b5f6;
â€“accent-warning:#ffa726;
â€“accent-danger:#f44336;
â€“accent-info:#29b6f6;
â€“border-color:#1e4976;
â€“card-bg:#132f4c;
â€“input-bg:#0a1929;
â€“nav-bg:rgba(10,25,41,0.95);
â€“slate-900:#0a1929;â€“slate-800:#132f4c;â€“slate-700:#1e4976;â€“emerald-500:#2196f3;â€“emerald-400:#64b5f6
}

/* Theme: Sunset Orange */
[data-theme=â€œsunsetâ€]{
â€“bg-primary:#1a1a2e;
â€“bg-secondary:#2d2d44;
â€“bg-tertiary:#4a3f55;
â€“bg-hover:#5d4e66;
â€“text-primary:#ffecd2;
â€“text-secondary:#ffb88c;
â€“text-muted:#de6262;
â€“accent-primary:#ff6b6b;
â€“accent-secondary:#ffa502;
â€“accent-warning:#ffd93d;
â€“accent-danger:#ff4757;
â€“accent-info:#70a1ff;
â€“border-color:#4a3f55;
â€“card-bg:#2d2d44;
â€“input-bg:#1a1a2e;
â€“nav-bg:rgba(26,26,46,0.95);
â€“slate-900:#1a1a2e;â€“slate-800:#2d2d44;â€“slate-700:#4a3f55;â€“emerald-500:#ff6b6b;â€“emerald-400:#ffa502
}

/* Theme: Light Mode */
[data-theme=â€œlightâ€]{
â€“bg-primary:#f8fafc;
â€“bg-secondary:#ffffff;
â€“bg-tertiary:#e2e8f0;
â€“bg-hover:#cbd5e1;
â€“text-primary:#1e293b;
â€“text-secondary:#475569;
â€“text-muted:#64748b;
â€“accent-primary:#059669;
â€“accent-secondary:#10b981;
â€“accent-warning:#d97706;
â€“accent-danger:#dc2626;
â€“accent-info:#2563eb;
â€“border-color:#e2e8f0;
â€“card-bg:#ffffff;
â€“input-bg:#ffffff;
â€“nav-bg:rgba(248,250,252,0.95);
â€“slate-900:#f8fafc;â€“slate-800:#ffffff;â€“slate-700:#e2e8f0;â€“slate-400:#475569;â€“slate-200:#1e293b;â€“emerald-500:#059669;â€“emerald-400:#10b981
}

/* Theme: High Contrast */
[data-theme=â€œcontrastâ€]{
â€“bg-primary:#000000;
â€“bg-secondary:#121212;
â€“bg-tertiary:#1e1e1e;
â€“bg-hover:#2d2d2d;
â€“text-primary:#ffffff;
â€“text-secondary:#e0e0e0;
â€“text-muted:#bdbdbd;
â€“accent-primary:#00ff88;
â€“accent-secondary:#00cc6a;
â€“accent-warning:#ffff00;
â€“accent-danger:#ff0000;
â€“accent-info:#00bfff;
â€“border-color:#333333;
â€“card-bg:#121212;
â€“input-bg:#000000;
â€“nav-bg:rgba(0,0,0,0.98);
â€“slate-900:#000000;â€“slate-800:#121212;â€“slate-700:#1e1e1e;â€“emerald-500:#00ff88;â€“emerald-400:#00cc6a
}

/* Theme: Purple Haze */
[data-theme=â€œpurpleâ€]{
â€“bg-primary:#1a1a2e;
â€“bg-secondary:#25274d;
â€“bg-tertiary:#3d3d6b;
â€“bg-hover:#5c5c8a;
â€“text-primary:#e8e8ff;
â€“text-secondary:#b8b8d1;
â€“text-muted:#8888aa;
â€“accent-primary:#9d4edd;
â€“accent-secondary:#c77dff;
â€“accent-warning:#ffbe0b;
â€“accent-danger:#ff5a5f;
â€“accent-info:#4cc9f0;
â€“border-color:#3d3d6b;
â€“card-bg:#25274d;
â€“input-bg:#1a1a2e;
â€“nav-bg:rgba(26,26,46,0.95);
â€“slate-900:#1a1a2e;â€“slate-800:#25274d;â€“slate-700:#3d3d6b;â€“emerald-500:#9d4edd;â€“emerald-400:#c77dff
}

*{margin:0;padding:0;box-sizing:border-box}
body{font-family:â€˜Interâ€™,system-ui,sans-serif;background:var(â€“bg-primary);color:var(â€“text-primary);min-height:100vh;-webkit-tap-highlight-color:transparent;transition:background 0.3s, color 0.3s}
body.logged-in{padding-bottom:80px}

/* Sync/Offline Status Bar */
.status-bar{position:fixed;top:0;left:0;right:0;height:28px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;z-index:500;transition:all 0.3s}
.status-bar.online{background:var(â€“accent-primary);color:white}
.status-bar.offline{background:var(â€“accent-danger);color:white}
.status-bar.syncing{background:var(â€“accent-warning);color:black}
.status-bar.hidden{transform:translateY(-100%)}
body.has-status-bar{padding-top:28px}
body.has-status-bar .header{top:28px}
body.has-status-bar .login-screen{padding-top:48px}

/* Draft indicator */
.draft-badge{background:var(â€“accent-warning);color:black;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;margin-left:8px}
.autosave-indicator{font-size:10px;color:var(â€“text-muted);display:flex;align-items:center;gap:4px}
.autosave-indicator.saving{color:var(â€“accent-warning)}
.autosave-indicator.saved{color:var(â€“accent-primary)}

/* LEED Compliance Badge */
.leed-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:600}
.leed-badge.compliant{background:var(â€“accent-primary);color:white}
.leed-badge.warning{background:var(â€“accent-warning);color:black}
.leed-badge.fail{background:var(â€“accent-danger);color:white}

/* Validation errors */
.field-error{border-color:var(â€“accent-danger)!important}
.error-message{color:var(â€“accent-danger);font-size:11px;margin-top:4px}

/* Backup panel */
.backup-panel{background:var(â€“bg-tertiary);border-radius:8px;padding:16px;margin-top:16px}
.backup-info{font-size:11px;color:var(â€“text-muted);margin-bottom:12px}
.backup-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.backup-stat{background:var(â€“bg-secondary);padding:8px;border-radius:6px;text-align:center}

/* Report Data Cards */
.report-data-card{background:var(â€“bg-secondary);border-left:3px solid #2ecc71;border-radius:0 8px 8px 0;padding:14px 16px;margin-bottom:10px;transition:box-shadow 0.2s}
.report-data-card:hover{box-shadow:0 2px 8px rgba(46,204,113,0.15)}
.report-data-card .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.report-data-card .card-title{font-size:13px;font-weight:600;color:var(â€“text-primary)}
.report-data-card .card-badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
.report-data-card .weights-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.report-data-card .weight-cell{background:var(â€“bg-tertiary);padding:8px;border-radius:6px;text-align:center}
.report-data-card .weight-cell .val{font-size:14px;font-weight:700;color:var(â€“text-primary)}
.report-data-card .weight-cell .lbl{font-size:9px;color:var(â€“text-muted);margin-top:2px}
.report-data-card .materials-row{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.report-data-card .mat-chip{background:var(â€“bg-tertiary);padding:3px 8px;border-radius:12px;font-size:10px;color:var(â€“text-secondary)}
.report-data-card .mat-chip.diverted{border:1px solid #2ecc71;color:#2ecc71}
.report-data-card .mat-chip.landfill{border:1px solid var(â€“accent-danger);color:var(â€“accent-danger)}

/* Report table hardened headers */
.report-table{width:100%;font-size:11px;border-collapse:collapse}
.report-table thead{background:var(â€“bg-tertiary)}
.report-table thead th{padding:10px 8px;text-align:left;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:0.3px;color:var(â€“text-muted);border-bottom:2px solid #2ecc71;position:sticky;top:0;background:var(â€“bg-tertiary);z-index:1}
.report-table thead th.right{text-align:right}
.report-table thead th.center{text-align:center}
.report-table tbody td{padding:8px;border-bottom:1px solid var(â€“border-color)}
.report-table tbody tr:hover{background:var(â€“bg-hover)}
.report-table tfoot td{padding:10px 8px;font-weight:700;border-top:2px solid #2ecc71}

/* Report signature pad */
.report-sig-pad-wrap{background:var(â€“bg-tertiary);border-radius:8px;padding:16px;margin-top:16px}
.report-sig-pad-wrap canvas{border:1px solid var(â€“border-color);border-radius:6px;background:white;width:100%;height:100px;touch-action:none}

/* Report project picker */
.report-project-bar{background:linear-gradient(135deg,var(â€“bg-tertiary),var(â€“bg-secondary));border:1px solid var(â€“border-color);border-radius:8px;padding:12px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.report-project-bar select{flex:1}
.report-project-bar .project-indicator{width:8px;height:8px;border-radius:50%;background:var(â€“accent-danger)}
.report-project-bar .project-indicator.active{background:#2ecc71}

/* Theme Selector */
.theme-selector{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.theme-option{width:100%;aspect-ratio:1;border-radius:8px;border:3px solid transparent;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.theme-option:hover{transform:scale(1.05)}
.theme-option.active{border-color:var(â€“accent-primary);box-shadow:0 0 12px var(â€“accent-primary)}
.theme-option::after{content:attr(data-name);position:absolute;bottom:2px;left:0;right:0;text-align:center;font-size:8px;color:white;text-shadow:0 1px 2px black}
.theme-dark{background:linear-gradient(135deg,#0f172a,#1e293b)}
.theme-dalmex{background:linear-gradient(135deg,#1a2e1a,#2d5a27)}
.theme-ocean{background:linear-gradient(135deg,#0a1929,#1e4976)}
.theme-sunset{background:linear-gradient(135deg,#1a1a2e,#ff6b6b)}
.theme-light{background:linear-gradient(135deg,#f8fafc,#e2e8f0)}
.theme-contrast{background:linear-gradient(135deg,#000000,#00ff88)}
.theme-purple{background:linear-gradient(135deg,#1a1a2e,#9d4edd)}

/* Reduced Motion */
body.reduced-motion *{animation:none!important;transition:none!important}

/* Larger Text */
body.larger-text{font-size:18px}
body.larger-text .form-label{font-size:14px}
body.larger-text .form-input{font-size:16px;padding:14px}
body.larger-text .btn{font-size:15px;padding:14px 20px}
body.larger-text .card{padding:20px}

/* Compact Mode */
body.compact-mode .card{padding:12px;margin-bottom:12px}
body.compact-mode .form-group{margin-bottom:10px}
body.compact-mode .btn{padding:8px 14px}
body.compact-mode main{padding:12px}
.backup-stat-value{font-size:16px;font-weight:700;color:var(â€“emerald-400)}
.backup-stat-label{font-size:9px;color:var(â€“slate-400)}

/* Login Screen */
.login-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(â€“slate-900) 0%,var(â€“slate-800) 100%)}
.login-screen.hidden{display:none}
.login-logo{text-align:center;margin-bottom:32px}
.login-logo h1{font-size:28px;font-weight:700;color:var(â€“emerald-400)}
.login-logo p{color:var(â€“slate-400);font-size:13px;margin-top:8px}
.login-box{background:var(â€“slate-800);border-radius:16px;padding:28px;width:100%;max-width:380px;box-shadow:0 20px 40px rgba(0,0,0,0.3);border:1px solid var(â€“slate-700)}
.login-tabs{display:flex;margin-bottom:20px;background:var(â€“slate-700);border-radius:8px;padding:4px}
.login-tab{flex:1;padding:10px;text-align:center;border-radius:6px;cursor:pointer;font-size:13px;font-weight:500;transition:all 0.2s}
.login-tab.active{background:var(â€“emerald-500);color:white}
.company-badge{display:flex;align-items:center;gap:12px;padding:14px;background:var(â€“slate-700);border-radius:8px;margin-bottom:20px}
.company-badge-logo{width:48px;height:48px;background:var(â€“dalmex-green);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:16px}
.company-badge-info{flex:1}
.company-badge-name{font-weight:600;font-size:14px}
.company-badge-address{font-size:10px;color:var(â€“slate-400);line-height:1.4}
.company-badge-address a{color:inherit !important;text-decoration:none}
.login-error{color:var(â€“red-500);font-size:12px;margin-top:8px;text-align:center}
.user-badge{display:flex;align-items:center;gap:8px;font-size:12px}
.user-role{background:var(â€“emerald-500);color:white;padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600}
.user-role.customer{background:var(â€“blue-500)}
.logout-btn{background:none;border:none;color:var(â€“slate-400);cursor:pointer;font-size:11px;margin-left:8px}
.portal-banner{background:linear-gradient(135deg,var(â€“blue-500),#6366f1);padding:14px 20px;color:white}
.portal-banner h2{font-size:15px;font-weight:600}
.portal-banner p{font-size:11px;opacity:0.9;margin-top:2px}
.app-container{display:none}
.app-container.active{display:block}
.header{background:var(â€“slate-800);padding:16px 20px;position:sticky;top:0;z-index:100;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(â€“slate-700)}
.logo{font-size:20px;font-weight:700;color:var(â€“emerald-400)}
.logo span{color:var(â€“slate-400);font-weight:400;font-size:12px;margin-left:8px}
main{padding:20px;max-width:800px;margin:0 auto}
.card{background:var(â€“slate-800);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(â€“slate-700)}
.btn{padding:14px 20px;border-radius:8px;font-weight:600;font-size:14px;border:none;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-height:48px;transition:all 0.2s}
.btn-primary{background:var(â€“emerald-500);color:white}
.btn-primary:active{background:var(â€“emerald-400);transform:scale(0.98)}
.btn-secondary{background:var(â€“slate-700);color:var(â€“slate-200)}
.btn-lg{width:100%;padding:18px;font-size:16px}
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;font-weight:600;color:var(â€“slate-400);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-input{width:100%;padding:14px;background:var(â€“slate-700);border:1px solid var(â€“slate-600);border-radius:8px;color:var(â€“slate-200);font-size:16px;min-height:48px}
.form-input:focus{outline:none;border-color:var(â€“emerald-500)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Modal */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;padding:20px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:40px}
.modal-content{background:var(â€“slate-800);border-radius:16px;width:100%;max-width:700px;max-height:calc(100vh - 80px);display:flex;flex-direction:column;border:1px solid var(â€“slate-700)}
.modal-header{padding:16px 20px;border-bottom:1px solid var(â€“slate-700);display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.modal-title{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;background:var(â€“slate-700);border:none;color:var(â€“slate-400);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px;overflow-y:auto;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{padding:16px 20px;border-top:1px solid var(â€“slate-700);display:flex;gap:12px;flex-shrink:0}

/* Steps */
.steps{display:flex;justify-content:center;align-items:center;margin-bottom:24px;gap:8px}
.step{width:36px;height:36px;border-radius:50%;background:var(â€“slate-700);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;color:var(â€“slate-400)}
.step.active{background:var(â€“emerald-500);color:white}
.step.complete{background:var(â€“emerald-500);color:white}
.step-line{width:40px;height:3px;background:var(â€“slate-700)}
.step-line.complete{background:var(â€“emerald-500)}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.photo-slot{aspect-ratio:1;background:var(â€“slate-700);border:2px dashed var(â€“slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;color:var(â€“slate-500);cursor:pointer;position:relative;overflow:hidden}
.photo-slot img{width:100%;height:100%;object-fit:cover}
.photo-slot.filled{border:2px solid var(â€“emerald-500)}
.photo-slot .remove-btn{position:absolute;top:4px;right:4px;width:24px;height:24px;background:var(â€“red-500);border-radius:50%;border:none;color:white;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Container Select */
.container-select{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.container-option{background:var(â€“slate-700);border:2px solid var(â€“slate-600);border-radius:8px;padding:12px 8px;text-align:center;cursor:pointer}
.container-option.selected{border-color:var(â€“emerald-500);background:rgba(16,185,129,0.1)}
.container-option span{display:block;font-size:18px;font-weight:700}
.container-option small{font-size:11px;color:var(â€“slate-400)}

/* Verification Box - CRITICAL */
.verification-box{background:var(â€“slate-700);border:3px solid var(â€“amber-500);border-radius:12px;padding:20px;margin:20px 0}
.verification-box.verified{border-color:var(â€“emerald-500);background:rgba(16,185,129,0.15)}
.verification-box label{display:flex;align-items:flex-start;gap:16px;cursor:pointer}
.verification-box input[type=â€œcheckboxâ€]{width:32px;height:32px;min-width:32px;accent-color:var(â€“emerald-500);cursor:pointer;margin-top:4px}
.verification-box .verify-text{font-weight:700;color:var(â€“amber-400);font-size:16px}
.verification-box.verified .verify-text{color:var(â€“emerald-400)}
.verification-box .verify-desc{font-size:13px;color:var(â€“slate-300);margin-top:6px}

/* Materials */
.material-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(â€“slate-700)}
.material-item:last-child{border-bottom:none}
.material-name{font-size:13px}
.material-input{display:flex;align-items:center;gap:4px}
.material-input input{width:60px;padding:8px;background:var(â€“slate-700);border:1px solid var(â€“slate-600);border-radius:4px;color:white;text-align:center;font-size:14px}

/* Progress */
.progress-bar{height:8px;background:var(â€“slate-700);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(â€“emerald-500);transition:width 0.3s}
.diversion-badge{font-size:28px;font-weight:700;color:var(â€“emerald-400)}

/* Toast */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(â€“slate-700);color:white;padding:14px 24px;border-radius:8px;z-index:1000;opacity:0;transition:opacity 0.3s;font-size:14px;max-width:90%;text-align:center}
.toast.show{opacity:1}
.toast.error{background:var(â€“red-500)}
.toast.success{background:var(â€“emerald-500)}

/* Image Preview */
.image-preview{width:100%;aspect-ratio:16/10;background:var(â€“slate-700);border:2px dashed var(â€“slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;overflow:hidden;color:var(â€“slate-500);font-size:14px}
.image-preview.filled{border:2px solid var(â€“emerald-500)}
.image-preview img{width:100%;height:100%;object-fit:contain}

/* Button Row */
.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Signature */
.signature-pad{width:100%;height:150px;background:white;border-radius:8px;touch-action:none}

/* Loading */
.loading{text-align:center;padding:20px}
.spinner{width:40px;height:40px;border:3px solid var(â€“slate-600);border-top-color:var(â€“emerald-500);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:300;display:none;align-items:center;justify-content:center;flex-direction:column}
.loading-overlay.active{display:flex}

/* Nav */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(â€“nav-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-top:1px solid var(â€“border-color);display:flex;justify-content:space-around;padding:8px 0;z-index:9999}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;color:var(â€“slate-500);font-size:10px;padding:8px 12px;cursor:pointer}
.nav-item.active{color:var(â€“emerald-400)}
.nav-item svg{width:24px;height:24px}

/* Hide class */
.hidden{display:none !important}

/* Voice Input */
.voice-btn{background:var(â€“blue-500);color:white;border:none;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.2s}
.voice-btn.listening{background:var(â€“red-500);animation:pulse 1s infinite}
.voice-btn:disabled{background:var(â€“slate-600);cursor:not-allowed}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.voice-status{font-size:11px;color:var(â€“slate-400);margin-top:4px;text-align:center}

/* Charts */
.chart-container{background:var(â€“slate-800);border-radius:12px;padding:16px;margin-bottom:16px}
.chart-title{font-size:14px;font-weight:600;margin-bottom:12px}
.chart-wrapper{position:relative;height:200px}

/* Prediction Card */
.prediction-card{background:linear-gradient(135deg,var(â€“slate-800),var(â€“slate-700));border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid var(â€“slate-600)}
.prediction-title{font-size:12px;color:var(â€“slate-400);text-transform:uppercase;margin-bottom:8px}
.prediction-value{font-size:32px;font-weight:700;color:var(â€“emerald-400)}
.prediction-label{font-size:12px;color:var(â€“slate-300);margin-top:4px}
.prediction-progress{height:8px;background:var(â€“slate-600);border-radius:4px;margin-top:12px;overflow:hidden}
.prediction-progress-fill{height:100%;border-radius:4px;transition:width 0.5s}

/* Stats Row */
.stats-row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px}
.stat-box{background:var(â€“slate-800);border-radius:8px;padding:12px;text-align:center}
.stat-box-value{font-size:20px;font-weight:700;color:var(â€“emerald-400)}
.stat-box-label{font-size:10px;color:var(â€“slate-400);margin-top:2px}
</style>

</head>
<body>

<!-- SYNC/OFFLINE STATUS BAR -->

<div class="status-bar online hidden" id="statusBar">
<span id="statusBarText">âœ“ Online - All data synced</span>
</div>

<!-- LOGIN SCREEN -->

<div class="login-screen" id="loginScreen">
<div class="login-logo">
<h1>ğŸ”„ DivertScanâ„¢</h1>
<p>Enterprise Waste Diversion Tracking</p>
<p style="font-size:10px;color:var(--emerald-400);margin-top:4px">v7.7 Build 021026</p>
</div>

<div class="login-box">
<div class="company-badge">
<div class="company-badge-logo">DM</div>
<div class="company-badge-info">
<div class="company-badge-name">DalMex Recycling LLC</div>
<div class="company-badge-address">2828 Nagel St., Dallas, TX 75220<br><span style="color:inherit">(214) 352-2000</span></div>
</div>
</div>

<div class="login-tabs">
<div class="login-tab active" onclick="switchLoginTab('admin')">Admin</div>
<div class="login-tab" onclick="switchLoginTab('portal')">Portal</div>
</div>

<!-- Admin Login -->

<div id="adminLoginForm">
<div class="form-group">
<label class="form-label">Username</label>
<input type="text" class="form-input" id="adminUsername" placeholder="Enter username">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" class="form-input" id="adminPassword" placeholder="Enter password">
</div>
<button class="btn btn-primary btn-lg" onclick="doAdminLogin()">ğŸ” Login</button>
<div id="adminLoginError" class="login-error"></div>
</div>

<!-- Portal Login (handles both customer + operator via smart code routing) -->

<div id="portalLoginForm" class="hidden">
<div class="form-group">
<label class="form-label">Access Code</label>
<input type="text" class="form-input" id="portalCode" placeholder="Enter your access code" style="text-transform:uppercase;text-align:center;font-size:16px;letter-spacing:2px">
</div>
<p style="font-size:10px;color:var(--slate-400);margin-bottom:16px">
Access codes are provided by DalMex Recycling.
</p>
<button class="btn btn-primary btn-lg" onclick="doPortalLogin()">ğŸ”“ Access Portal</button>
<div id="portalLoginError" class="login-error"></div>
</div>
</div>

<p style="margin-top:20px;color:var(--slate-500);font-size:10px">
DivertScanâ„¢ v7.7 Enterprise â€¢ Powered by Claude AI
</p>
</div>

<!-- MAIN APP CONTAINER -->

<div class="app-container" id="appContainer">

<div class="header" id="adminHeader">
<div class="logo">DivertScanâ„¢ <span>v7.7</span></div>
<div style="display:flex;align-items:center;gap:6px">
<button onclick="startNewTicket()" style="background:var(--emerald-500);border:none;color:white;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap" class="admin-only">â• Ticket</button>
<button onclick="showNewProjectModal()" style="background:var(--accent-info);border:none;color:white;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap" class="admin-only">ğŸ“ Project</button>
<div class="user-badge">
<span id="currentUserName">Admin</span>
<span class="user-role" id="currentUserRole">ADMIN</span>
<button class="logout-btn" onclick="doLogout()">Logout</button>
</div>
</div>
</div>

<!-- Customer Portal Header (hidden by default) -->

<div class="header hidden" id="customerHeader">
<div class="logo">DivertScanâ„¢ <span>PORTAL</span></div>
<div class="user-badge">
<span id="portalProjectName" onclick="showCustomerProjectSwitcher()" style="cursor:pointer">Project</span>
<span class="user-role customer" id="portalProjectSwitchHint" style="display:none;cursor:pointer" onclick="showCustomerProjectSwitcher()">â–¼</span>
<span class="user-role customer" id="portalViewBadge">VIEW ONLY</span>
<button class="logout-btn" onclick="doLogout()">Exit</button>
</div>
</div>

<!-- Operator Header (hidden by default) -->

<div class="header hidden" id="operatorHeader">
<div class="logo">DivertScanâ„¢ <span>CREW</span></div>
<div class="user-badge">
<span id="operatorName">Operator</span>
<span class="user-role" style="background:var(--accent-info)">CREW</span>
<button class="logout-btn" onclick="doLogout()">Exit</button>
</div>
</div>

<!-- Portal Banner -->

<div class="portal-banner hidden" id="portalBanner">
<h2>ğŸ“Š Customer Report Portal</h2>
<p>View-only access to your project's waste diversion data</p>
</div>

<main id="mainContent">
<div id="dashboardTab">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400);text-transform:uppercase">Current Project</div>
<div style="font-size:18px;font-weight:600;margin-top:4px" id="currentProjectName">No Project Selected</div>
<div style="font-size:12px;color:var(--slate-400)" id="currentProjectHauler"></div>
</div>
<button class="btn btn-secondary admin-only" onclick="showProjectPicker()" style="padding:8px 12px;font-size:12px">Change</button>
</div>
</div>

<!-- Quick Actions â€” Admin Only -->

<div class="card admin-only" style="background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary))">
<div style="font-size:12px;font-weight:600;margin-bottom:12px;color:var(--text-secondary)">âš¡ Quick Actions</div>
<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
<button class="btn btn-primary" onclick="startNewTicket()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">â•</span>
<span>New Ticket</span>
</button>
<button class="btn btn-secondary" onclick="triggerExcelImport()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">ğŸ“—</span>
<span>Import Excel</span>
</button>
<button class="btn btn-secondary" onclick="showTab('reports');generateReport()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">ğŸ“„</span>
<span>Report</span>
</button>
<button class="btn btn-secondary" onclick="createFullBackup()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">ğŸ’¾</span>
<span>Backup</span>
</button>
<button class="btn btn-secondary" onclick="forceSyncNow()" style="padding:12px 8px;font-size:10px;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:18px">ğŸ”„</span>
<span>Sync</span>
</button>
</div>
</div>

<!-- MAIN Excel Import Input (hidden) -->

<input type="file" id="mainExcelImport" accept=".xlsx,.xls" style="display:none" onchange="importExcelTickets(event)">

<!-- Import Excel Card - Admin Only -->

<div class="card admin-only" style="margin-top:16px;border:2px solid var(--accent-primary);background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary))">
<div style="display:flex;align-items:center;gap:12px">
<span style="font-size:32px">ğŸ“—</span>
<div style="flex:1">
<div style="font-size:15px;font-weight:700;color:var(--accent-primary)">Import Excel Data</div>
<div style="font-size:11px;color:var(--text-muted);margin-top:2px">Import tickets from DalMex Excel reports (.xlsx)</div>
</div>
<button class="btn btn-primary" onclick="triggerExcelImport()" style="padding:12px 20px;font-size:13px;font-weight:600">
ğŸ“— Import .xlsx
</button>
</div>
</div>

<div class="card" style="margin-top:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<div style="font-size:14px;font-weight:600">ğŸ“‹ Ticket Data <span id="ticketCountBadge" style="font-size:11px;background:var(--accent-primary);color:#000;padding:2px 8px;border-radius:10px;margin-left:6px">0</span></div>
<div style="display:flex;gap:6px">
<button class="btn btn-primary" onclick="loadAllTicketsForProject()" style="padding:8px 14px;font-size:11px">ğŸ”„ Refresh</button>
</div>
</div>
<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" style="display:none;background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(245,158,11,0.1));border:1px solid var(--red-500);border-radius:8px;padding:10px;margin-bottom:10px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="font-size:12px;color:var(--slate-300)"><span id="selectedCount">0</span> selected</div>
<div style="display:flex;gap:6px">
<button class="btn btn-secondary" onclick="selectAllTickets()" style="padding:4px 10px;font-size:10px" id="selectAllBtn">Select All</button>
<button class="btn" onclick="deleteSelectedTickets()" style="background:var(--red-500);color:white;padding:4px 10px;font-size:10px">ğŸ—‘ï¸ Delete Selected</button>
</div>
</div>
</div>
<!-- Filter Bar -->
<div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
<input type="text" id="ticketSearchFilter" class="form-input" placeholder="Search ticket #, date..." style="flex:1;min-width:120px;padding:6px 10px;font-size:11px" oninput="filterTicketList()">
<select id="ticketSortOrder" class="form-input" style="width:auto;padding:6px 8px;font-size:11px" onchange="sortTicketList()">
<option value="date-desc">Newest First</option>
<option value="date-asc">Oldest First</option>
<option value="ticket-asc">Ticket # â†‘</option>
<option value="tons-desc">Tonnage â†“</option>
<option value="diversion-desc">Diversion % â†“</option>
</select>
</div>
<div id="recentTickets" style="color:var(--text-secondary);font-size:13px;max-height:600px;overflow-y:auto">Loading...</div>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">ğŸ“Š Project Stats</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div style="text-align:center;padding:12px;background:var(--bg-tertiary);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--accent-primary)" id="statTotalTons">0.00</div>
<div style="font-size:11px;color:var(--text-muted)">Total Tons</div>
</div>
<div style="text-align:center;padding:12px;background:var(--bg-tertiary);border-radius:8px">
<div style="font-size:24px;font-weight:700;color:var(--accent-primary)" id="statDiversionRate">0%</div>
<div style="font-size:11px;color:var(--text-muted)">Diversion Rate</div>
</div>
</div>
</div>

<!-- LEED Compliance Predictor -->

<!-- Material Trend Chart -->

<div class="chart-container">
<div class="chart-title">ğŸ“ˆ Material Trends (Last 10 Loads)</div>
<div class="chart-wrapper">
<canvas id="materialTrendChart"></canvas>
</div>
</div>

<!-- Diversion Rate Chart -->

<div class="chart-container">
<div class="chart-title">ğŸ“Š Diversion Rate Over Time</div>
<div class="chart-wrapper">
<canvas id="diversionChart"></canvas>
</div>
</div>

</div>

<div id="projectsTab" class="hidden">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:18px;font-weight:600">Projects</h2>
<button class="btn btn-primary" onclick="showNewProjectModal()" style="padding:10px 16px">â• New Project</button>
</div>
<div id="projectsList">Loading projects...</div>

<!-- Import/Export Section -->

<div class="card" style="margin-top:20px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“¥ Import / Export</div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Import tickets from Excel or export your data</p>

<div style="font-size:12px;font-weight:500;margin-bottom:8px">Import Data</div>
<div class="btn-row" style="margin-bottom:12px">
<button class="btn btn-primary" onclick="triggerExcelImport()" style="flex:1">ğŸ“— Import Excel</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()" style="flex:1">ğŸ“„ Import JSON</button>
</div>
<input type="file" id="importFile" accept=".json,.csv" style="display:none" onchange="importProjects(event)">

<div style="font-size:12px;font-weight:500;margin-bottom:8px;margin-top:16px">Export Data</div>
<div class="btn-row">
<button class="btn btn-secondary" onclick="exportAllProjects()" style="flex:1">ğŸ“¤ JSON</button>
<button class="btn btn-secondary" onclick="exportProjectsCSV()" style="flex:1">ğŸ“Š CSV</button>
<button class="btn btn-primary" onclick="exportProjectsExcel()" style="flex:1">ğŸ“— Excel</button>
</div>

<div style="background:var(--bg-tertiary);border-radius:8px;padding:12px;margin-top:12px;font-size:11px">
<div style="font-weight:600;margin-bottom:4px">Excel Import Format:</div>
<div style="color:var(--text-muted)">
Supports DalMex format with columns:<br>
Date, Ticket No, GWT (lbs), Tare (lbs), Net (lbs), Tons, Wood %, Metal %, OCC %, Plastic %, Concrete %, etc.
</div>
</div>
</div>
</div>

<div id="reportsTab" class="hidden">
<h2 style="font-size:18px;font-weight:600;margin-bottom:16px">ğŸ“Š Waste Diversion Reports</h2>

<!-- Report Project Picker -->

<div class="report-project-bar">
<div class="project-indicator" id="reportProjectIndicator"></div>
<select id="reportProjectSelect" class="form-input" onchange="onReportProjectChange()" style="margin-bottom:0">
<option value="">â€” Select Project â€”</option>
</select>
</div>

<!-- Report Output (auto-populates on project select) -->

<div id="reportOutput" class="hidden" style="margin-top:16px">

<!-- TOP EXPORT BAR â€” always visible when report is shown -->

<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;padding:12px;background:var(--bg-secondary);border-radius:10px;border:1px solid var(--border-color);position:sticky;top:60px;z-index:10">
<button class="btn btn-secondary" onclick="generateReport()" style="padding:10px;font-size:11px;min-width:60px">ğŸ”„</button>
<button class="btn btn-primary" onclick="generateLEEDAuditReport()" style="flex:1;padding:10px;font-size:11px;min-width:80px">ğŸ“„ PDF</button>
<button class="btn btn-primary" onclick="shareLEEDPDF()" style="flex:1;padding:10px;font-size:11px;min-width:80px;background:linear-gradient(135deg,#3b82f6,#1d4ed8)">ğŸ“¤ Share</button>
<button class="btn btn-primary" onclick="downloadReportExcel()" style="flex:1;padding:10px;font-size:11px;min-width:80px;background:linear-gradient(135deg,#059669,#047857)">ğŸ“Š Excel</button>
<button class="btn btn-secondary" onclick="downloadReportCSV()" style="flex:1;padding:10px;font-size:11px;min-width:80px">ğŸ“‹ CSV</button>
<button class="btn btn-secondary admin-only" onclick="generateAISummary()" style="flex:1;padding:10px;font-size:11px;min-width:80px">ğŸ¤– AI</button>
</div>

<!-- Project Header -->

<div class="card" id="reportHeader">
<div style="text-align:center;margin-bottom:16px">
<div style="font-size:20px;font-weight:700">Construction &amp; Demolition Waste Management Report</div>
<div style="font-size:12px;color:var(--slate-400)">LEED v4.1/v5 MRc5 â€” All Materials Processed by Dalmex Recycling LLC</div>
<div style="font-size:10px;color:var(--slate-500);margin-top:4px">Credit: Materials &amp; Resources â€” Construction and Demolition Waste Management (MRc5)</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px;margin-bottom:16px">
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">Project Name</div><div style="font-weight:600" id="reportProjectName">-</div></div>
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">Report Date</div><div style="font-weight:600" id="reportDate">-</div></div>
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">Address</div><div id="reportProjectAddress">-</div></div>
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">Waste Hauler</div><div id="reportProjectHauler">-</div></div>
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">General Contractor</div><div id="reportProjectGC">-</div></div>
<div><div style="color:var(--slate-400);font-size:10px;text-transform:uppercase">Reporting Period</div><div id="reportPeriod">-</div></div>
</div>
<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">
<div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700" id="reportDiversionRate">0%</div><div style="font-size:9px;color:var(--slate-400);text-transform:uppercase">Diversion Rate</div></div>
<div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700" id="reportTotalTons">0</div><div style="font-size:9px;color:var(--slate-400);text-transform:uppercase">Total Tons</div></div>
<div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--emerald-400)" id="reportDivertedTons">0</div><div style="font-size:9px;color:var(--slate-400);text-transform:uppercase">Diverted</div></div>
<div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center"><div style="font-size:24px;font-weight:700;color:var(--red-500)" id="reportLandfillTons">0</div><div style="font-size:9px;color:var(--slate-400);text-transform:uppercase">Landfill</div></div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--slate-400);margin-bottom:8px">
<span><span id="reportTicketCount">0</span> tickets &bull; <span id="reportLoadCount">0</span></span>
<span id="reportLeedStatus">-</span>
</div>
</div>

<!-- Material Breakdown -->

<div class="card" style="margin-top:12px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">Material Breakdown</div>
<div id="reportMaterialBreakdown"></div>
<div style="display:flex;justify-content:space-between;margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color)">
<div><strong style="color:var(--emerald-400)" id="reportTotalDiverted">0 T</strong> <span style="font-size:11px;color:var(--slate-400)">Diverted</span></div>
<div><strong style="color:var(--red-500)" id="reportTotalLandfill">0 T</strong> <span style="font-size:11px;color:var(--slate-400)">Landfill</span></div>
</div>
</div>

<!-- Load Details -->

<div class="card" style="margin-top:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">ğŸš› Load Details</div>
<select id="reportType" class="form-input" style="width:auto;margin:0;font-size:11px" onchange="generateReport()">
<option value="summary">Summary Table</option>
<option value="detailed">Detailed Cards</option>
</select>
</div>
<div id="reportContent" style="overflow-x:auto"></div>
</div>

<!-- Certification -->

<div class="card" style="margin-top:12px;border:2px solid var(--emerald-500)">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">âœ… Facility Attestation â€” LEED MRc5 Compliance</div>
<p style="font-size:12px;color:var(--slate-300);line-height:1.6">This report was generated from verified scale ticket data processed through the DivertScanâ„¢ waste tracking system. All materials were received, sorted, and routed to documented end markets by Dalmex Recycling LLC. Diversion calculations are based on actual weighed tonnage with chain-of-custody documentation maintained for each load.</p>

<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-top:12px;font-size:11px">
<div style="font-weight:600;color:var(--emerald-400);margin-bottom:6px">MRc5 Documentation Compliance:</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;color:var(--slate-300)">
<div>âœ… Waste tracked by material stream</div>
<div>âœ… Scale ticket weights documented</div>
<div>âœ… End market destinations verified</div>
<div>âœ… Chain-of-custody maintained</div>
<div>âœ… Diversion rate calculated by weight</div>
<div>âœ… Human-verified material percentages</div>
</div>
</div>

<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-top:8px;font-size:11px">
<div style="font-weight:600;color:var(--blue-400);margin-bottom:6px">Verified End Markets:</div>
<div style="color:var(--slate-300);line-height:1.8">
ğŸ“¦ OCC/Fiber â†’ Georgia Pacific Â· Smurfit Westrock Â· Greenside Â· Intl Paper<br>
ğŸªµ Wood/Pallets â†’ Dalmex Pallets (In-House Reuse)<br>
ğŸ”© Metal/Scrap â†’ CMC Â· Cyclone Metal Recycling<br>
â™»ï¸ Plastic â†’ Recycle USA<br>
ğŸ§± Concrete â†’ Big City Concrete<br>
ğŸ—ï¸ Drywall â†’ USA Gypsum
</div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;font-size:12px">
<div><div style="color:var(--slate-400)">Prepared By</div><div style="font-weight:600">Dalmex Recycling LLC</div><div style="font-size:10px;color:var(--slate-400)">2828 Nagle St., Dallas, TX 75220</div><div style="font-size:10px;color:var(--slate-400)">(214) 352-2000</div></div>
<div><div style="color:var(--slate-400)">Report Generated</div><div style="font-weight:600" id="reportGeneratedDate">-</div><div style="font-size:10px;color:var(--slate-400);margin-top:4px">DivertScanâ„¢ v7.7 Enterprise</div></div>
</div>
</div>

</div>

<!-- Export Actions (shown after report generates) -->

<div id="reportDownloadBtns" style="display:none;margin-top:16px">
<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“¥ Export Report</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<button class="btn btn-primary" onclick="generateLEEDAuditReport()" style="font-size:12px">ğŸ“‹ Download LEED PDF</button>
<button class="btn btn-primary" onclick="shareLEEDPDF()" style="font-size:12px;background:linear-gradient(135deg,#3b82f6,#1d4ed8)">ğŸ“¤ Share PDF</button>
<button class="btn btn-primary" onclick="downloadReportExcel()" style="font-size:12px;background:linear-gradient(135deg,#059669,#047857)">ğŸ“— Export Excel</button>
<button class="btn btn-secondary" onclick="downloadReportCSV()" style="font-size:11px">ğŸ“Š CSV Export</button>
</div>
</div>

<!-- AI Summary â€” Admin Only -->

<div class="card admin-only" style="margin-top:12px;background:linear-gradient(135deg,var(--slate-800),var(--slate-700));border:1px solid var(--emerald-500)">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:24px">ğŸ¤–</span>
<div><div style="font-size:14px;font-weight:600">AI Executive Summary</div><div style="font-size:11px;color:var(--slate-400)">Claude AI writes a professional narrative for your LEED submission</div></div>
</div>
<button class="btn btn-primary" onclick="generateAISummary()" style="width:100%">âœ¨ Generate AI Summary</button>
<div id="aiSummaryResult" class="hidden" style="margin-top:12px;padding:12px;background:var(--slate-800);border-radius:8px;font-size:12px;line-height:1.6;color:var(--slate-200)"></div>
<div id="aiSummaryActions" class="hidden" style="margin-top:8px">
<button class="btn btn-primary" onclick="downloadAISummaryPDF()" style="width:100%">ğŸ“¥ Download AI Summary as PDF</button>
</div>
</div>

<!-- Certificate of Destruction (collapsed) â€” Admin Only -->

<div class="card admin-only" style="margin-top:12px">
<div style="font-size:14px;font-weight:600;cursor:pointer" onclick="toggleSection('codSection')">ğŸ”’ Certificate of Destruction <span id="codSectionArrow">â–¼</span></div>
<div id="codSectionContent" class="hidden" style="margin-top:12px">
<p style="font-size:11px;color:var(--slate-400);margin-bottom:10px">Official certificate verifying materials were securely destroyed/recycled at Dalmex Recycling.</p>
<div class="form-group" style="margin-bottom:8px"><label class="form-label" style="font-size:11px">Customer / Company Name *</label><input type="text" id="codCustomerName" class="form-input" placeholder="e.g., Junk Luggers" style="font-size:13px"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="form-group" style="margin-bottom:0"><label class="form-label" style="font-size:11px">Ticket # *</label><input type="text" id="codTicketNumber" class="form-input" placeholder="e.g., 83337" style="font-size:13px"></div><div class="form-group" style="margin-bottom:0"><label class="form-label" style="font-size:11px">Date of Service</label><input type="date" id="codServiceDate" class="form-input" style="font-size:13px"></div></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px"><div class="form-group" style="margin-bottom:0"><label class="form-label" style="font-size:11px">Material Type *</label><select id="codMaterialType" class="form-input" style="font-size:13px"><option value="Sorted Office Paper (SOP)">Sorted Office Paper (SOP)</option><option value="Mixed Paper">Mixed Paper</option><option value="Cardboard/OCC">Cardboard/OCC</option><option value="Confidential Documents">Confidential Documents</option><option value="Hard Drives / Electronics">Hard Drives / Electronics</option><option value="Mixed C&amp;D Debris">Mixed C&amp;D Debris</option><option value="Other">Other</option></select></div><div class="form-group" style="margin-bottom:0"><label class="form-label" style="font-size:11px">Net Weight (lbs) *</label><input type="number" id="codNetWeight" class="form-input" placeholder="e.g., 5100" style="font-size:13px"></div></div>
<div class="form-group" style="margin-bottom:8px"><label class="form-label" style="font-size:11px">Destruction Method</label><select id="codMethod" class="form-input" style="font-size:13px"><option value="Baled and shipped to certified paper mill for pulping and recycling">Baled &amp; Recycled (Paper Mill)</option><option value="Shredded on-site and baled for recycling">Shredded &amp; Recycled</option><option value="Processed and recycled through certified downstream facility">Processed &amp; Recycled</option><option value="Sorted, processed, and diverted from landfill for recycling">Sorted &amp; Diverted</option></select></div>
<div class="form-group" style="margin-bottom:10px"><label class="form-label" style="font-size:11px">Notes (optional)</label><input type="text" id="codNotes" class="form-input" placeholder="e.g., COD payment received" style="font-size:13px"></div>
<button class="btn btn-primary" onclick="generateCertificateOfDestruction()" style="width:100%;background:linear-gradient(135deg,#d97706,#b45309)">ğŸ”’ Generate Certificate of Destruction (PDF)</button>
</div>
</div>
</div>

</div>

<!-- ==================== CUSTOMER UPLOAD TAB ==================== -->

<div id="customerUploadTab" class="hidden">

<!-- Upload Header -->

<div style="text-align:center;margin-bottom:20px">
<div style="font-size:24px;margin-bottom:4px">ğŸ“¤</div>
<h2 style="font-size:18px;font-weight:700;margin-bottom:4px">Upload Scale Tickets</h2>
<p style="font-size:12px;color:var(--slate-400)">Upload your scale tickets and load photos for Dalmex to process</p>
</div>

<!-- Upload Status Banner -->

<div id="customerUploadStatus" class="hidden" style="margin-bottom:16px;padding:12px;border-radius:10px;background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.1));border:1px solid var(--emerald-500)">
<div style="font-size:13px;font-weight:600;color:var(--emerald-400)" id="uploadStatusText">âœ… Upload submitted!</div>
<div style="font-size:11px;color:var(--slate-400);margin-top:4px" id="uploadStatusDetail"></div>
</div>

<!-- Upload Form Card -->

<div class="card" style="border:1px solid var(--slate-600)">
<div style="font-size:14px;font-weight:600;margin-bottom:16px;color:var(--emerald-400)">ğŸ“„ Scale Ticket Photo <span style="color:var(--red-400);font-size:11px">* Required</span></div>

<div id="custTicketPreview" style="width:100%;min-height:120px;background:var(--slate-800);border:2px dashed var(--slate-600);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative" onclick="customerUploadTicketPhoto()">
<div id="custTicketPlaceholder" style="text-align:center;padding:20px">
<div style="font-size:32px;margin-bottom:8px">ğŸ“·</div>
<div style="font-size:12px;color:var(--slate-400)">Tap to photograph or upload scale ticket</div>
<div style="font-size:10px;color:var(--slate-500);margin-top:4px">Supports any hauler's ticket format</div>
</div>
</div>

<div class="btn-row" style="margin-top:10px;margin-bottom:20px">
<button class="btn btn-secondary" onclick="customerCaptureTicket()" style="flex:1;padding:10px;font-size:12px">ğŸ“· Camera</button>
<button class="btn btn-primary" onclick="customerUploadTicketPhoto()" style="flex:1;padding:10px;font-size:12px">ğŸ“ Choose File</button>
</div>

<!-- Debris / Load Photos -->

<div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--blue-400)">ğŸ“¸ Load / Debris Photos <span style="font-size:11px;color:var(--slate-400);font-weight:400">(Optional but recommended)</span></div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Photos of the load help Dalmex accurately classify materials and calculate your diversion rate.</p>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
<div class="photo-slot" id="custPhotoSlot0" onclick="customerUploadDebrisPhoto(0)" style="aspect-ratio:1;background:var(--slate-800);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;overflow:hidden;position:relative">â•</div>
<div class="photo-slot" id="custPhotoSlot1" onclick="customerUploadDebrisPhoto(1)" style="aspect-ratio:1;background:var(--slate-800);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;overflow:hidden;position:relative">â•</div>
<div class="photo-slot" id="custPhotoSlot2" onclick="customerUploadDebrisPhoto(2)" style="aspect-ratio:1;background:var(--slate-800);border:2px dashed var(--slate-600);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:24px;overflow:hidden;position:relative">â•</div>
</div>

<div class="btn-row" style="margin-bottom:20px">
<button class="btn btn-secondary" onclick="customerCaptureDebris()" style="flex:1;padding:10px;font-size:12px">ğŸ“· Camera</button>
<button class="btn btn-primary" onclick="customerUploadMultiDebris()" style="flex:1;padding:10px;font-size:12px">ğŸ“ Upload Photos</button>
</div>

<!-- Quick Note (optional) -->

<div style="border-top:1px solid var(--slate-700);padding-top:12px">
<div class="form-group" style="margin-bottom:0">
<label class="form-label">Quick Note <span style="font-size:10px;color:var(--slate-500)">(Optional)</span></label>
<input type="text" id="custNotes" class="form-input" placeholder="e.g., Building 3 demo, heavy wood load...">
</div>
<div style="font-size:10px;color:var(--slate-500);margin-top:4px">Dalmex reads the ticket details from the photo â€” no need to type them in.</div>
</div>
<!-- Hidden fields for backward compatibility -->
<input type="hidden" id="custHauler" value="">
<input type="hidden" id="custServiceDate" value="">
<input type="hidden" id="custTicketNum" value="">
</div>

<!-- Submit Button -->

<button class="btn btn-primary btn-lg" onclick="submitCustomerUpload()" style="width:100%;margin-top:16px;padding:16px;font-size:15px;background:linear-gradient(135deg,var(--emerald-500),#047857)">
ğŸ“¤ Submit for Review
</button>
<p style="text-align:center;font-size:10px;color:var(--slate-500);margin-top:8px">Dalmex will review your upload, process materials, and update your project report.</p>

<!-- Previous Uploads -->

<div class="card" style="margin-top:20px">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“‹ Your Submissions</div>
<div id="customerUploadHistory" style="font-size:12px;color:var(--slate-400)">Loading...</div>
</div>

</div>
<!-- ==================== END CUSTOMER UPLOAD TAB ==================== -->

<!-- ==================== OPERATOR SCAN TAB ==================== -->

<div id="operatorScanTab" class="hidden">
<div class="card" style="text-align:center;padding:24px">
<div style="font-size:48px;margin-bottom:8px">ğŸ“¸</div>
<div style="font-size:18px;font-weight:700;margin-bottom:4px">Quick Scan</div>
<div style="font-size:12px;color:var(--slate-400);margin-bottom:20px">Snap the scale ticket & debris photos as trucks come in</div>

<!-- Project Picker for Operator -->

<div class="form-group" style="text-align:left;margin-bottom:20px">
<label class="form-label">Select Project</label>
<select id="opProjectPicker" class="form-input" style="font-size:14px;padding:12px" onchange="opSelectProject()">
<option value="">â€” Pick a project â€”</option>
</select>
</div>

<div id="opSelectedProject" class="hidden" style="text-align:left">
<!-- Step 1: Scale Ticket -->
<div style="background:var(--slate-800);border-radius:10px;padding:16px;margin-bottom:12px">
<div style="font-size:13px;font-weight:600;margin-bottom:10px">ğŸ“„ Step 1: Scale Ticket Photo <span style="color:var(--red-400)">*</span></div>
<div id="opTicketPreview" style="position:relative;margin-bottom:10px;min-height:60px;background:var(--slate-700);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--slate-500);font-size:12px">No photo yet</div>
<div style="display:flex;gap:8px">
<button class="btn btn-primary" onclick="opCaptureTicket()" style="flex:1;padding:12px">ğŸ“· Camera</button>
<button class="btn btn-secondary" onclick="opUploadTicket()" style="flex:1;padding:12px">ğŸ“ File</button>
</div>
</div>

<!-- Step 2: Debris Photos -->

<div style="background:var(--slate-800);border-radius:10px;padding:16px;margin-bottom:12px">
<div style="font-size:13px;font-weight:600;margin-bottom:10px">ğŸ“¸ Step 2: Debris Photos (up to 3)</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px">
<div>
<div id="opPhotoSlot0" style="aspect-ratio:1;background:var(--slate-700);border-radius:8px;border:2px dashed var(--slate-600);display:flex;align-items:center;justify-content:center;position:relative"><span style="font-size:24px">ğŸ“·</span></div>
<div style="display:flex;gap:4px;margin-top:4px">
<button onclick="opCaptureDebris(0)" class="btn btn-primary" style="flex:1;padding:6px;font-size:10px">ğŸ“·</button>
<button onclick="opUploadDebris(0)" class="btn btn-secondary" style="flex:1;padding:6px;font-size:10px">ğŸ“</button>
</div>
</div>
<div>
<div id="opPhotoSlot1" style="aspect-ratio:1;background:var(--slate-700);border-radius:8px;border:2px dashed var(--slate-600);display:flex;align-items:center;justify-content:center;position:relative"><span style="font-size:24px">+</span></div>
<div style="display:flex;gap:4px;margin-top:4px">
<button onclick="opCaptureDebris(1)" class="btn btn-primary" style="flex:1;padding:6px;font-size:10px">ğŸ“·</button>
<button onclick="opUploadDebris(1)" class="btn btn-secondary" style="flex:1;padding:6px;font-size:10px">ğŸ“</button>
</div>
</div>
<div>
<div id="opPhotoSlot2" style="aspect-ratio:1;background:var(--slate-700);border-radius:8px;border:2px dashed var(--slate-600);display:flex;align-items:center;justify-content:center;position:relative"><span style="font-size:24px">+</span></div>
<div style="display:flex;gap:4px;margin-top:4px">
<button onclick="opCaptureDebris(2)" class="btn btn-primary" style="flex:1;padding:6px;font-size:10px">ğŸ“·</button>
<button onclick="opUploadDebris(2)" class="btn btn-secondary" style="flex:1;padding:6px;font-size:10px">ğŸ“</button>
</div>
</div>
</div>
</div>

<!-- Notes -->

<div class="form-group">
<label class="form-label">Quick Notes (optional)</label>
<input type="text" id="opNotes" class="form-input" placeholder="e.g., Heavy wood load, driver James">
</div>

<!-- Submit -->

<button class="btn btn-primary" onclick="opSubmitScan()" style="width:100%;padding:14px;font-size:16px;font-weight:700;margin-bottom:12px">âœ… Submit & Next Truck</button>

</div>
</div>

<!-- Operator's Recent Scans -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“‹ My Recent Scans</div>
<div id="opRecentScans" style="font-size:12px;color:var(--slate-400)">Loading...</div>
</div>
</div>
<!-- ==================== END OPERATOR SCAN TAB ==================== -->

<!-- ==================== ADMIN PENDING TAB ==================== -->

<div id="pendingTab" class="hidden">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div>
<div style="font-size:16px;font-weight:700">â³ Pending Review</div>
<div style="font-size:11px;color:var(--slate-400)">Tickets from customers & crew awaiting your review</div>
</div>
<button class="btn btn-secondary" onclick="loadPendingReviewTab()" style="padding:6px 12px;font-size:11px">ğŸ”„ Refresh</button>
</div>
<div id="pendingReviewList" style="font-size:12px;color:var(--slate-400)">Loading...</div>
</div>
</div>
<!-- ==================== END ADMIN PENDING TAB ==================== -->

<div id="settingsTab" class="hidden">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:14px;font-weight:600">ğŸ”‘ Anthropic API Key</div>
    <div id="apiKeyStatus" style="font-size:11px">--</div>
</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Required for scale ticket OCR and debris photo analysis. Get your key from console.anthropic.com</p>
<div style="display:flex;gap:8px;align-items:center">
    <input type="password" id="apiKeyInput" class="form-input" placeholder="sk-ant-..." style="margin-bottom:0;flex:1">
    <button class="btn btn-secondary" onclick="toggleKeyVisibility('apiKeyInput')" style="padding:8px 12px;white-space:nowrap;font-size:11px">ğŸ‘ï¸</button>
</div>
<button class="btn btn-primary" onclick="saveApiKey()" style="margin-top:12px;width:100%">Save Key</button>
</div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div style="font-size:14px;font-weight:600">ğŸ—„ï¸ Supabase Connection</div>
    <div id="supabaseStatus" style="font-size:11px">--</div>
</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Required for cloud sync. App works offline without this.</p>
<div class="form-group">
<label class="form-label">Project URL</label>
<input type="text" id="supabaseUrl" class="form-input" placeholder="https://xxxxx.supabase.co">
</div>
<div class="form-group">
<label class="form-label">Anon Key</label>
<div style="display:flex;gap:8px;align-items:center">
    <input type="password" id="supabaseKey" class="form-input" placeholder="eyJ..." style="margin-bottom:0;flex:1">
    <button class="btn btn-secondary" onclick="toggleKeyVisibility('supabaseKey')" style="padding:8px 12px;white-space:nowrap;font-size:11px">ğŸ‘ï¸</button>
</div>
</div>
<button class="btn btn-primary" onclick="saveSupabaseConfig()" style="width:100%">Save & Connect</button>
</div>

<!-- Pitch Deck / Marketing â€” Admin Only -->

<div class="card admin-only" style="border:1px solid var(--emerald-500);background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary))">
<div style="font-size:14px;font-weight:600;margin-bottom:8px">ğŸ“Š DivertScan Pitch Deck</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Share the DivertScan platform overview with prospects, GCs, and hauling companies. Generated as a professional PDF with material flow diagrams, sample reports, and LEED v5 compliance details.</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<button class="btn btn-primary" onclick="generateAndSharePitchDeck()" style="font-size:12px;padding:12px">ğŸ“¤ Share Pitch Deck</button>
<button class="btn btn-secondary" onclick="downloadPitchDeck()" style="font-size:12px;padding:12px">ğŸ“¥ Download PDF</button>
</div>
</div>

<!-- Key Persistence â€” Admin Only -->

<div class="card admin-only">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ”— Save Keys to Bookmark</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:8px">Generate a URL with your keys embedded in the hash fragment. Bookmark it for instant access on any device â€” keys are never sent to the server.</p>
<button class="btn btn-secondary" onclick="generateKeyBookmark()" style="width:100%">ğŸ“‹ Copy Key Bookmark URL</button>
<div id="keyBookmarkResult" style="margin-top:8px;display:none;padding:8px;background:var(--slate-800);border-radius:6px;word-break:break-all;font-size:10px;color:var(--emerald-400);font-family:monospace"></div>
</div>
<div class="card admin-only">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“‹ LEED Rules Engine</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Configure LEED MRc5 compliance validation</p>
<div class="form-group">
<label class="form-label">LEED Version</label>
<select id="leedVersion" class="form-input" onchange="updateLeedRules()">
<option value="v4.1">LEED v4.1 (Current)</option>
<option value="v5">LEED v5 (2024+)</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Default Diversion Target</label>
<select id="defaultDiversionTarget" class="form-input">
<option value="50">50% (1 point)</option>
<option value="75" selected>75% (2 points - Recommended)</option>
</select>
</div>
<div style="background:var(--slate-700);border-radius:8px;padding:12px;font-size:11px">
<div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">Current LEED Rules:</div>
<div id="leedRulesDisplay">
â€¢ MRc5: C&D Waste Management<br>
â€¢ Option 1: Diversion (50% = 1pt, 75% = 2pts)<br>
â€¢ Requires: Tracking by material stream<br>
â€¢ Requires: Facility documentation<br>
â€¢ Photo verification recommended
</div>
</div>
<button class="btn btn-secondary" onclick="saveLeedSettings()" style="margin-top:12px;width:100%">ğŸ’¾ Save LEED Settings</button>
</div>

<!-- LEED Industry News & Reference Links -->

<div class="card admin-only">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:14px;font-weight:600">ğŸ“° LEED Industry News & Regulations</div>
<button class="btn btn-secondary" onclick="refreshLeedNews()" style="padding:6px 12px;font-size:10px">ğŸ”„ Refresh</button>
</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Live news and regulatory updates â€” auto-refreshes daily when API key is configured</p>
<div id="leedNewsList" style="margin-bottom:16px">
<div style="padding:12px 0;color:var(--slate-400)">Loading news...</div>
</div>

<div style="border-top:1px solid var(--slate-600);padding-top:12px;margin-top:8px">
<div style="font-size:12px;font-weight:600;margin-bottom:10px;color:var(--emerald-400)">ğŸ“Œ Official LEED Reference Links</div>
<div style="display:flex;flex-direction:column;gap:8px;font-size:11px">
<a href="https://www.usgbc.org/leed/v5" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ›ï¸ USGBC â€” LEED v5 Rating System</span><span>â†—</span></a>
<a href="https://www.usgbc.org/credits/new-construction-core-and-shell-schools-new-construction-retail-new-construction-healthcare/v4" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ“‹ USGBC â€” MRc5 Credit Requirements (v4.1)</span><span>â†—</span></a>
<a href="https://www.usgbc.org/leed/v41" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ“˜ USGBC â€” LEED v4.1 Full Reference Guide</span><span>â†—</span></a>
<a href="https://www.epa.gov/smm/sustainable-management-construction-and-demolition-materials" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ—ï¸ EPA â€” C&D Waste Management Guidelines</span><span>â†—</span></a>
<a href="https://www.tceq.texas.gov/permitting/waste_permits/msw_permits/msw-cd-facilities" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ­ TCEQ â€” Texas C&D Recycling Facilities</span><span>â†—</span></a>
<a href="https://www.usgbc.org/resources/leed-v41-bdc-guide" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸ“„ USGBC â€” LEED BD+C Documentation Guide</span><span>â†—</span></a>
<a href="https://worldgbc.org/circularity" target="_blank" rel="noopener" style="color:var(--blue-400);text-decoration:none;display:flex;justify-content:space-between;align-items:center;padding:8px;background:var(--slate-700);border-radius:6px">
<span>ğŸŒ World GBC â€” Circular Economy in Construction</span><span>â†—</span></a>
</div>
</div>
</div>

<!-- Backup & Restore -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ’¾ Backup & Restore</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Export all data or restore from backup</p>

<div class="backup-panel">
<div class="backup-stats">
<div class="backup-stat">
<div class="backup-stat-value" id="backupProjectCount">0</div>
<div class="backup-stat-label">Projects</div>
</div>
<div class="backup-stat">
<div class="backup-stat-value" id="backupTicketCount">0</div>
<div class="backup-stat-label">Tickets</div>
</div>
<div class="backup-stat">
<div class="backup-stat-value" id="backupLastDate">Never</div>
<div class="backup-stat-label">Last Backup</div>
</div>
</div>

<div class="btn-row" style="margin-bottom:12px">
<button class="btn btn-primary" onclick="createFullBackup()" style="flex:1">ğŸ“¤ Export Backup</button>
<button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()" style="flex:1">ğŸ“¥ Restore</button>
<input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreFromBackup(event)">
</div>

<div class="btn-row">
<button class="btn btn-secondary" onclick="exportToCloud()" style="flex:1">â˜ï¸ Cloud Backup</button>
<button class="btn btn-secondary" onclick="clearLocalData()" style="flex:1;color:var(--red-500)">ğŸ—‘ï¸ Clear Local</button>
<button class="btn btn-secondary" onclick="runDiagnostic()" style="flex:1">ğŸ” Diagnose</button>
</div>
<div id="diagnosticOutput" class="hidden" style="margin-top:8px;padding:10px;background:var(--slate-800);border-radius:6px;font-size:10px;font-family:monospace;color:var(--emerald-400);max-height:300px;overflow-y:auto;white-space:pre-wrap"></div>
</div>
</div>

<!-- Offline Mode Settings -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ“´ Offline Mode</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Data saved locally when offline, syncs when back online</p>

<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="enableOfflineMode" checked onchange="toggleOfflineMode()">
Enable offline data storage
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="autoSync" checked>
Auto-sync when online
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="autosaveDrafts" checked>
Auto-save ticket drafts
</label>
</div>

<div style="background:var(--slate-700);border-radius:8px;padding:12px;margin-top:12px">
<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
<span>Local Storage Used:</span>
<span id="localStorageUsed">0 KB</span>
</div>
<div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:4px">
<span>Pending Sync Items:</span>
<span id="pendingSyncCount">0</span>
</div>
<div style="display:flex;justify-content:space-between;font-size:11px">
<span>Last Sync:</span>
<span id="lastSyncTime">Never</span>
</div>
</div>

<button class="btn btn-secondary" onclick="forceSyncNow()" style="margin-top:12px;width:100%">ğŸ”„ Force Sync Now</button>

</div>

<!-- Data Validation Settings -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">âœ… Data Validation</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Prevent invalid data from being saved</p>

<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="validateWeights" checked>
Validate weight entries (gross > tare)
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="validatePercentages" checked>
Validate percentages total 100%
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="requirePhotos" checked>
Require at least 1 debris photo
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="requireVerification" checked>
Require human verification checkbox
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="flagAnomalies" checked>
Flag anomalies (>90% or <30% diversion)
</label>
</div>
</div>

<!-- Color Theme Selector -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ¨ Color Theme</div>
<p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Choose your preferred color scheme</p>

<div class="theme-selector">
<div class="theme-option theme-dark active" data-theme="default" data-name="Dark" onclick="setTheme('default')"></div>
<div class="theme-option theme-dalmex" data-theme="dalmex" data-name="DalMex" onclick="setTheme('dalmex')"></div>
<div class="theme-option theme-ocean" data-theme="ocean" data-name="Ocean" onclick="setTheme('ocean')"></div>
<div class="theme-option theme-sunset" data-theme="sunset" data-name="Sunset" onclick="setTheme('sunset')"></div>
<div class="theme-option theme-light" data-theme="light" data-name="Light" onclick="setTheme('light')"></div>
<div class="theme-option theme-contrast" data-theme="contrast" data-name="Hi-Con" onclick="setTheme('contrast')"></div>
<div class="theme-option theme-purple" data-theme="purple" data-name="Purple" onclick="setTheme('purple')"></div>
</div>

<div style="margin-top:16px">
<div style="font-size:12px;font-weight:500;margin-bottom:8px">Quick Adjustments</div>
<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="reducedMotion" onchange="toggleReducedMotion()">
Reduce animations
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="largerText" onchange="toggleLargerText()">
Larger text (accessibility)
</label>
<label style="display:flex;align-items:center;gap:8px;font-size:12px">
<input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
Compact mode (more content)
</label>
</div>
</div>
</div>

<!-- Company Branding -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ¢ Company Branding</div>
<div class="form-group">
<label class="form-label">Company Name</label>
<input type="text" id="companyNameInput" class="form-input" value="DalMex Recycling LLC">
</div>
<div class="form-group">
<label class="form-label">Address</label>
<input type="text" id="companyAddressInput" class="form-input" value="2828 Nagel St., Dallas, TX 75220">
</div>
<div class="form-group">
<label class="form-label">Phone</label>
<input type="text" id="companyPhoneInput" class="form-input" value="(214) 352-2000">
</div>
<button class="btn btn-primary" onclick="saveCompanyBranding()">Save Branding</button>
</div>

<!-- Hauler Manager â€” Tie Projects to Haulers -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:4px">ğŸš› Hauler Manager</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Create haulers and assign projects to them. One hauler can have multiple projects.</p>

<div id="haulerManagerList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
<!-- Rendered dynamically -->
</div>

<div style="display:flex;gap:8px">
<input type="text" id="newHaulerName" class="form-input" placeholder="New hauler name (e.g., Jaguar Waste Management)" style="flex:1;margin:0">
<button class="btn btn-primary" onclick="addHauler()" style="white-space:nowrap;padding:8px 14px">â• Add</button>
</div>
</div>

<!-- Customer Account Manager â€” Assign Projects to Customer Codes -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:4px">ğŸ‘¤ Customer Accounts</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Create customer login codes and assign projects they can access. Customers log in via the Portal tab.</p>

<div id="customerAccountList" style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px">
<!-- Rendered dynamically by renderCustomerAccounts() -->
</div>

<div style="display:flex;gap:8px">
<input type="text" id="newCustomerCode" class="form-input" placeholder="New access code (e.g., JAGUAR)" style="flex:1;margin:0;text-transform:uppercase;font-family:monospace;letter-spacing:2px">
<button class="btn btn-primary" onclick="addCustomerAccount()" style="white-space:nowrap;padding:8px 14px">â• Add</button>
</div>
<div style="font-size:10px;color:var(--slate-500);margin-top:6px">Code must be unique. Customer will type this code in the Portal login.</div>
</div>

<!-- Verified Facility Network -->

<div class="card">
<div style="font-size:14px;font-weight:600;margin-bottom:12px">ğŸ­ Verified Facility Network</div>
<p style="font-size:11px;color:var(--slate-400);margin-bottom:12px">Your recycling partners - materials auto-route to these facilities</p>

<div id="facilityNetworkList" style="display:flex;flex-direction:column;gap:8px">
<!-- All facilities render dynamically from renderAllFacilities() -->
</div>

<button class="btn btn-secondary" onclick="showAddFacilityModal()" style="margin-top:12px;width:100%">â• Add New Facility</button>

</div>

</div>
</main>

<!-- Toast -->

<div id="toast" class="toast"></div>

<!-- Loading Overlay -->

<div id="loadingOverlay" class="loading-overlay">
<div class="spinner"></div>
<p id="loadingText" style="color:white">Processing...</p>
</div>

<!-- New Ticket Modal -->

<div id="ticketModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<div class="modal-title">New Ticket</div>
<button class="modal-close" onclick="closeTicketModal()">Ã—</button>
</div>
<div class="modal-body">

<!-- Step Indicators -->

<div class="steps">
<div class="step active" id="stepIndicator1">1</div>
<div class="step-line" id="stepLine1"></div>
<div class="step" id="stepIndicator2">2</div>
<div class="step-line" id="stepLine2"></div>
<div class="step" id="stepIndicator3">3</div>
<div class="step-line" id="stepLine3"></div>
<div class="step" id="stepIndicator4">4</div>
</div>

<!-- STEP 1: Scale Ticket -->

<div id="ticketStep1">
<h3 style="text-align:center;margin-bottom:16px">ğŸ“„ Step 1: Scale Ticket</h3>

<div class="form-group">
<label class="form-label">Project</label>
<select id="ticketProject" class="form-input">
<option value="">Select Project...</option>
<option value="demo">Demo Project</option>
</select>
</div>

<div class="image-preview" id="ticketImagePreview">
<span>Upload scale ticket photo</span>
</div>

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('ticketCameraInput').click()">ğŸ“· Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('ticketFileInput').click()">ğŸ“ Upload</button>
</div>
<input type="file" id="ticketCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleTicketPhoto(event)">
<input type="file" id="ticketFileInput" accept="image/*" style="display:none" onchange="handleTicketPhoto(event)">

<div class="form-group">
<label class="form-label">Service Date</label>
<input type="date" id="serviceDate" class="form-input">
</div>

<div class="form-group">
<label class="form-label">Ticket #</label>
<input type="text" id="ticketNumber" class="form-input" placeholder="84600">
</div>

<div class="form-row">
<div class="form-group">
<label class="form-label">Gross (lbs)</label>
<input type="number" id="grossLbs" class="form-input" placeholder="40000" oninput="updateNetWeight()">
</div>
<div class="form-group">
<label class="form-label">Tare (lbs)</label>
<input type="number" id="tareLbs" class="form-input" placeholder="15000" oninput="updateNetWeight()">
</div>
</div>

<div class="form-group">
<label class="form-label">Net Weight</label>
<div id="netWeightDisplay" style="font-size:28px;font-weight:700;color:var(--emerald-400)">0.00 tons</div>
</div>

<div class="form-group">
<label class="form-label">Hauler</label>
<input type="text" id="haulerName" class="form-input" placeholder="Hauler name">
</div>

<div class="form-group">
<label style="display:flex;align-items:center;gap:8px;font-size:12px;cursor:pointer;padding:8px 12px;background:var(--slate-700);border-radius:8px;border:1px solid var(--border-color)">
<input type="checkbox" id="directToEndMarket" onchange="toggleDirectEndMarket()">
<span>ğŸ¤ <strong>Direct to End Market</strong> â€” Load went straight to partner facility (not through Dalmex yard)</span>
</label>
<div id="directEndMarketOptions" class="hidden" style="margin-top:8px;padding:8px 12px;background:var(--slate-800);border-radius:8px;border:1px solid var(--blue-500)">
<label class="form-label" style="font-size:11px;color:var(--blue-500)">Partner Facility</label>
<select id="directFacilitySelect" class="form-input" style="font-size:13px">
<option value="big_city_concrete">ğŸ§± Big City Concrete (Concrete/Block)</option>
<option value="usa_gypsum">ğŸ—ï¸ USA Gypsum (Drywall)</option>
<option value="ewaste_recycler">ğŸ–¥ï¸ E-Waste Recycler (Electronics)</option>
<option value="asphalt_recycler">ğŸª¨ DFW Asphalt (Shingles/Roofing)</option>
<option value="soil_recycler">ğŸŒ DFW Soil Recycling (Clean Fill)</option>
</select>
<div style="font-size:10px;color:var(--slate-400);margin-top:4px">Enter the partner's scale ticket # and weight above</div>
</div>
</div>
</div>

<!-- STEP 2: Debris Photos -->

<div id="ticketStep2" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">ğŸ“¸ Step 2: Debris Photos</h3>

<div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;display:flex;justify-content:space-between">
<span>Ticket: <strong id="step2TicketNum">--</strong></span>
<span>Net: <strong id="step2NetWeight" style="color:var(--emerald-400)">-- T</strong></span>
</div>

<p style="color:var(--amber-400);text-align:center;margin-bottom:16px;font-size:13px">âš ï¸ Upload at least 1 photo of debris</p>

<div class="form-group">
<label class="form-label">Container Size</label>
<div class="container-select">
<div class="container-option" onclick="selectContainer(20)"><span>20</span><small>yd</small></div>
<div class="container-option selected" onclick="selectContainer(30)"><span>30</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(40)"><span>40</span><small>yd</small></div>
<div class="container-option" onclick="selectContainer(0)"><span>?</span><small>other</small></div>
</div>
</div>

<div class="photo-grid" id="debrisPhotoGrid">
<div class="photo-slot" id="photoSlot0" onclick="triggerPhotoUpload(0)">â•</div>
<div class="photo-slot" id="photoSlot1" onclick="triggerPhotoUpload(1)">â•</div>
<div class="photo-slot" id="photoSlot2" onclick="triggerPhotoUpload(2)">â•</div>
</div>

<input type="file" id="debrisPhotoInput" accept="image/*" style="display:none" onchange="handleDebrisPhoto(event)">
<input type="file" id="debrisMultiInput" accept="image/*" multiple style="display:none" onchange="handleMultiplePhotos(event)">
<input type="file" id="debrisCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleDebrisPhoto(event)">

<div class="btn-row" style="margin-bottom:16px">
<button class="btn btn-secondary" onclick="document.getElementById('debrisCameraInput').click()">ğŸ“· Camera</button>
<button class="btn btn-primary" onclick="document.getElementById('debrisMultiInput').click()">ğŸ“ Upload Multiple</button>
</div>

<p style="text-align:center;color:var(--slate-400);margin-bottom:16px">Photos: <span id="photoCount">0</span>/3</p>

<button class="btn btn-primary btn-lg" id="analyzeBtn" onclick="analyzeDebris()">ğŸ¤– Analyze Materials</button>

<div id="analysisResult" class="hidden" style="margin-top:16px;padding:16px;background:var(--slate-700);border-radius:8px">
<div style="text-align:center">
<div style="font-size:14px;color:var(--slate-400)">Diversion Rate</div>
<div id="analysisRate" style="font-size:36px;font-weight:700;color:var(--emerald-400)">0%</div>
</div>
</div>
</div>

<!-- STEP 3: Review & Verify - WITH CHECKBOX -->

<div id="ticketStep3" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">âœ… Step 3: Review & Verify</h3>

<!-- AI Reasoning Section -->

<div id="aiReasoningSection" class="hidden"></div>

<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="font-size:11px;color:var(--slate-400)">Diversion Rate</div>
<div class="diversion-badge" id="reviewDiversionRate">0%</div>
</div>
<div style="text-align:right">
<div style="font-size:11px;color:var(--slate-400)">LEED Target</div>
<div style="font-size:20px;font-weight:600">75%</div>
</div>
</div>
<div class="progress-bar" style="margin-top:12px">
<div class="progress-fill" id="reviewProgressBar" style="width:0%"></div>
</div>
</div>

<!-- â­ HUMAN VERIFICATION CHECKBOX â­ -->

<div class="verification-box" id="verificationBox">
<label>
<input type="checkbox" id="humanVerifyCheckbox" onchange="onVerificationChange()">
<div>
<div class="verify-text">âš ï¸ REQUIRED: Human Verification</div>
<div class="verify-desc">I have reviewed the photos and confirm the material percentages are accurate or have been corrected.</div>
</div>
</label>
</div>

<div style="font-size:12px;color:var(--slate-400);margin-bottom:8px">MATERIALS (adjust if needed)</div>
<div id="materialsList"></div>

<div style="margin-top:12px;font-size:14px">
Total: <span id="materialsTotal" style="color:var(--emerald-400);font-weight:700">100%</span>
</div>
</div>

<!-- STEP 4: Submit (signature optional) -->

<div id="ticketStep4" class="hidden">
<h3 style="text-align:center;margin-bottom:16px">âœ… Step 4: Review & Submit</h3>

<div class="card" style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Ticket</span>
    <span style="font-weight:600" id="step4TicketNum">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Date</span>
    <span style="font-weight:600" id="step4Date">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:12px;color:var(--slate-400)">Net Weight</span>
    <span style="font-weight:600" id="step4Weight">--</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
    <span style="font-size:12px;color:var(--slate-400)">Diversion Rate</span>
    <span style="font-weight:600;color:var(--emerald-400)" id="step4Diversion">--</span>
</div>
</div>

<details style="margin-bottom:12px">
<summary style="font-size:12px;color:var(--slate-400);cursor:pointer;padding:8px 0">âœï¸ Optional: Add Signature</summary>
<div class="card" style="margin-top:8px">
<canvas id="signaturePad" class="signature-pad"></canvas>
<button class="btn btn-secondary" style="margin-top:8px;font-size:11px" onclick="clearSignature()">Clear Signature</button>
</div>
</details>

<p style="font-size:11px;color:var(--slate-400);line-height:1.6;text-align:center">
Ticket will be saved with today's date and current material percentages.
</p>
</div>

</div>
<div class="modal-footer">
<button class="btn btn-secondary" id="backBtn" onclick="goBack()" style="flex:1">Back</button>
<button class="btn btn-primary" id="nextBtn" onclick="goNext()" style="flex:1">Next</button>
</div>
</div>
</div>

<!-- New Project Modal -->

<div id="projectModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">New Project</div>
<button class="modal-close" onclick="closeModal('projectModal')">Ã—</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">Project Name *</label>
<input type="text" id="projectName" class="form-input" placeholder="e.g., Children's Hospital Phase 2">
</div>
<div class="form-group">
<label class="form-label">Project Address</label>
<input type="text" id="projectAddress" class="form-input" placeholder="123 Main St, Dallas, TX">
</div>
<div class="form-group">
<label class="form-label">Waste Hauler</label>
<input type="text" id="projectHauler" class="form-input" placeholder="e.g., B&B Waste Management">
</div>
<div class="form-group">
<label class="form-label">LEED Target (%)</label>
<input type="number" id="projectLeedTarget" class="form-input" value="75" min="50" max="100">
</div>
<div class="form-group">
<label class="form-label">General Contractor</label>
<input type="text" id="projectGC" class="form-input" placeholder="e.g., JE Dunn Construction">
</div>
<div class="form-group">
<label class="form-label">Customer Access Code</label>
<input type="text" id="projectAccessCode" class="form-input" placeholder="Auto-generated" style="text-transform:uppercase">
<p style="font-size:10px;color:var(--slate-400);margin-top:4px">Share this code with your customer for portal access</p>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeModal('projectModal')" style="flex:1">Cancel</button>
<button class="btn btn-primary" onclick="saveProject()" style="flex:1">Save Project</button>
</div>
</div>
</div>

<!-- Project Picker Modal -->

<div id="projectPickerModal" class="modal">
<div class="modal-content" style="max-width:500px">
<div class="modal-header">
<div class="modal-title">Select Project</div>
<button class="modal-close" onclick="closeModal('projectPickerModal')">Ã—</button>
</div>
<div class="modal-body">
<div id="projectPickerList">Loading...</div>
<button class="btn btn-secondary btn-lg" onclick="closeModal('projectPickerModal');showNewProjectModal()" style="margin-top:16px">â• Create New Project</button>
</div>
</div>
</div>

<!-- Photo Crop/Edit Modal -->

<div id="photoCropModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;background:rgba(0,0,0,0.95);flex-direction:column">
<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--slate-800);border-bottom:1px solid var(--slate-600)">
<button onclick="cancelCrop()" style="background:none;border:none;color:var(--slate-300);font-size:16px;padding:8px 12px;cursor:pointer">âœ• Cancel</button>
<div style="color:white;font-size:14px;font-weight:600" id="cropTitle">Crop Photo</div>
<div style="display:flex;gap:8px">
<button onclick="skipCrop()" style="background:var(--slate-700);border:1px solid var(--slate-500);color:white;padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer">Skip</button>
<button onclick="rotateCropImage()" style="background:var(--slate-700);border:1px solid var(--slate-500);color:white;padding:8px 12px;border-radius:8px;font-size:14px;cursor:pointer">ğŸ”„</button>
<button onclick="applyCrop()" style="background:var(--emerald-500);border:none;color:white;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer">âœ“ Use</button>
</div>
</div>

<div style="flex:1;position:relative;overflow:hidden;touch-action:none;background:#000" id="cropContainer">
<canvas id="cropCanvas" style="position:absolute;top:0;left:0;transform-origin:0 0"></canvas>
<!-- Fixed crop frame overlay -->
<div id="cropOverlay" style="position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none">
<div id="cropFrame" style="position:absolute;border:2px solid var(--emerald-400);box-shadow:0 0 0 9999px rgba(0,0,0,0.6);border-radius:4px">
<!-- Corner brackets -->
<div style="position:absolute;top:-2px;left:-2px;width:24px;height:24px;border-top:3px solid white;border-left:3px solid white;border-radius:2px 0 0 0"></div>
<div style="position:absolute;top:-2px;right:-2px;width:24px;height:24px;border-top:3px solid white;border-right:3px solid white;border-radius:0 2px 0 0"></div>
<div style="position:absolute;bottom:-2px;left:-2px;width:24px;height:24px;border-bottom:3px solid white;border-left:3px solid white;border-radius:0 0 0 2px"></div>
<div style="position:absolute;bottom:-2px;right:-2px;width:24px;height:24px;border-bottom:3px solid white;border-right:3px solid white;border-radius:0 0 2px 0"></div>
<!-- Grid lines -->
<div style="position:absolute;top:33%;left:0;right:0;height:1px;background:rgba(255,255,255,0.15)"></div>
<div style="position:absolute;top:66%;left:0;right:0;height:1px;background:rgba(255,255,255,0.15)"></div>
<div style="position:absolute;left:33%;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.15)"></div>
<div style="position:absolute;left:66%;top:0;bottom:0;width:1px;background:rgba(255,255,255,0.15)"></div>
</div>
</div>
</div>

<div style="padding:12px 16px;background:var(--slate-800);border-top:1px solid var(--slate-600);text-align:center">
<div style="color:var(--slate-400);font-size:11px">Drag to move â€¢ Pinch to zoom â€¢ Tap Skip to use full photo</div>
</div>
</div>

<script>
// ========== DEFAULT KEYS (hardcoded â€” ensures customer portal always works) ==========
// These are embedded so customer portal login works on any device without setup
const DEFAULT_KEYS = {
    anthropic: '',
    sbUrl: 'https://cyvvlngtojagfoaitoog.supabase.co',
    sbKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5dnZsbmd0b2phZ2ZvYWl0b29nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyODk4OTAsImV4cCI6MjA4NDg2NTg5MH0.CltpTET2wFfl5kaHFOGmUS8tR8bRFCjbtWDdVrC5r0g'
};

// ========== URL HASH KEY LOADING ==========
// Keys can be passed via URL hash: #ak=ANTHROPIC_KEY&su=SUPABASE_URL&sk=SUPABASE_ANON_KEY
// Hash fragments are NEVER sent to the server, so they're safe for keys
(function loadKeysFromHash() {
    try {
        var hash = window.location.hash.substring(1);
        if (!hash) return;
        var params = {};
        hash.split('&').forEach(function(p) {
            var kv = p.split('=');
            if (kv.length === 2) params[kv[0]] = decodeURIComponent(kv[1]);
        });
        if (params.ak) localStorage.setItem('divertscan_openai', params.ak);
        if (params.su) localStorage.setItem('divertscan_sb_url', params.su);
        if (params.sk) localStorage.setItem('divertscan_sb_key', params.sk);
        // Strip hash from URL after loading (so keys don't stay in address bar)
        if (params.ak || params.su || params.sk) {
            history.replaceState(null, '', window.location.pathname);
        }
    } catch(e) { console.log('Hash key load:', e.message); }
})();

// Always ensure Supabase keys are populated â€” overwrite if empty or missing
// This guarantees customer portal works on first visit and after cache clears
if (DEFAULT_KEYS.sbUrl) {
    if (!localStorage.getItem('divertscan_sb_url') || localStorage.getItem('divertscan_sb_url').length < 10) {
        localStorage.setItem('divertscan_sb_url', DEFAULT_KEYS.sbUrl);
    }
}
if (DEFAULT_KEYS.sbKey) {
    if (!localStorage.getItem('divertscan_sb_key') || localStorage.getItem('divertscan_sb_key').length < 10) {
        localStorage.setItem('divertscan_sb_key', DEFAULT_KEYS.sbKey);
    }
}
if (DEFAULT_KEYS.anthropic) {
    if (!localStorage.getItem('divertscan_openai') || localStorage.getItem('divertscan_openai').length < 10) {
        localStorage.setItem('divertscan_openai', DEFAULT_KEYS.anthropic);
    }
}

// ========== SUPABASE CONFIG ==========
const SUPABASE_URL = localStorage.getItem('divertscan_sb_url') || DEFAULT_KEYS.sbUrl || '';
const SUPABASE_KEY = localStorage.getItem('divertscan_sb_key') || DEFAULT_KEYS.sbKey || '';
let sb = null;

// Initialize Supabase if configured
if (SUPABASE_URL && SUPABASE_KEY && typeof supabase !== 'undefined') {
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}

// ========== GLOBAL STATE ==========
let currentStep = 1;
let projects = [];
let currentProject = null;
let tickets = [];
let ticketData = {
    projectId: '',
    ticketNumber: '',
    serviceDate: '',
    grossLbs: 0,
    tareLbs: 0,
    netTons: 0,
    hauler: '',
    containerSize: 30,
    photos: [],
    materials: {},
    diversionRate: 0,
    humanVerified: false,
    signature: null
};
let debrisPhotos = [null, null, null];
let currentPhotoSlot = 0;
let signatureCanvas = null;
let signatureCtx = null;
let isDrawing = false;

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('DivertScan v7.6 initialized');
    
    // Set today's date
    const dateInput = document.getElementById('serviceDate');
    if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
    
    // Restore keys from IndexedDB backup if localStorage was cleared
    // Do NOT call initializeApp() here â€” window.onload handles login flow
    restoreAllKeys().then(() => {
        console.log('Keys restored, waiting for login check...');
    });
});

async function restoreAllKeys() {
    // 1. Load from localStorage
    let apiKey = localStorage.getItem('divertscan_openai');
    let sbUrl = localStorage.getItem('divertscan_sb_url');
    let sbKey = localStorage.getItem('divertscan_sb_key');
    
    // 2. If localStorage is empty, try IndexedDB backup
    if (!apiKey || !sbUrl || !sbKey) {
        try {
            await initIndexedDB();
            if (!apiKey) {
                const saved = await getFromLocal('settings', 'anthropic_key');
                if (saved && saved.value) {
                    apiKey = saved.value;
                    localStorage.setItem('divertscan_openai', apiKey);
                    console.log('Restored Anthropic key from IndexedDB backup');
                }
            }
            if (!sbUrl) {
                const saved = await getFromLocal('settings', 'supabase_url');
                if (saved && saved.value) {
                    sbUrl = saved.value;
                    localStorage.setItem('divertscan_sb_url', sbUrl);
                    console.log('Restored Supabase URL from IndexedDB backup');
                }
            }
            if (!sbKey) {
                const saved = await getFromLocal('settings', 'supabase_key');
                if (saved && saved.value) {
                    sbKey = saved.value;
                    localStorage.setItem('divertscan_sb_key', sbKey);
                    console.log('Restored Supabase key from IndexedDB backup');
                }
            }
        } catch (e) {
            console.log('IndexedDB key restore skipped:', e.message);
        }
    }
    
    // 3. Final fallback: hardcoded defaults
    if (!apiKey && DEFAULT_KEYS.anthropic) {
        apiKey = DEFAULT_KEYS.anthropic;
        localStorage.setItem('divertscan_openai', apiKey);
        console.log('Loaded Anthropic key from hardcoded defaults');
    }
    if (!sbUrl && DEFAULT_KEYS.sbUrl) {
        sbUrl = DEFAULT_KEYS.sbUrl;
        localStorage.setItem('divertscan_sb_url', sbUrl);
        console.log('Loaded Supabase URL from hardcoded defaults');
    }
    if (!sbKey && DEFAULT_KEYS.sbKey) {
        sbKey = DEFAULT_KEYS.sbKey;
        localStorage.setItem('divertscan_sb_key', sbKey);
        console.log('Loaded Supabase key from hardcoded defaults');
    }
    
    // 4. Populate input fields if they exist
    var apiInput = document.getElementById('apiKeyInput');
    var sbUrlInput = document.getElementById('supabaseUrl');
    var sbKeyInput = document.getElementById('supabaseKey');
    if (apiKey && apiInput) apiInput.value = apiKey;
    if (sbUrl && sbUrlInput) sbUrlInput.value = sbUrl;
    if (sbKey && sbKeyInput) sbKeyInput.value = sbKey;
    
    // 5. Always try to init/re-init Supabase if we have keys
    if (sbUrl && sbKey && typeof supabase !== 'undefined') {
        try {
            sb = supabase.createClient(sbUrl, sbKey);
            console.log('Supabase client initialized from restored keys');
        } catch (e) {
            console.log('Supabase init failed:', e.message);
        }
    }
    
    // 6. Update status indicators
    updateKeyStatusIndicators();
    
    console.log('Keys restored - API:' + (apiKey ? 'yes' : 'no') + ' SB:' + (sbUrl ? 'yes' : 'no') + '/' + (sbKey ? 'yes' : 'no') + ' client:' + (sb ? 'yes' : 'no'));
}

// ===== DIAGNOSTIC: Run from console with runDiagnostic() =====
async function runDiagnostic() {
    var diagLog = [];
    var _log = function() { var msg = Array.from(arguments).join(' '); console.log(msg); diagLog.push(msg); };
    _log('===== DivertScan Diagnostic =====');
    _log('sb client: ' + (sb ? 'YES' : 'NULL'));
    _log('currentProject: ' + (currentProject ? currentProject.name + ' (id: ' + currentProject.id + ')' : 'NULL'));
    _log('projects array: ' + projects.length + ' projects loaded');
    _log('tickets array: ' + tickets.length + ' tickets loaded');
    
    if (sb) {
        try {
            var r = await sb.from('projects').select('id, name').limit(10);
            if (r.error) {
                _log('ERROR: Supabase projects query FAILED: ' + r.error.message);
            } else {
                _log('Supabase projects: ' + r.data.length + ' found');
                r.data.forEach(function(p){ _log('  - ' + p.name + ' (id: ' + p.id + ')'); });
            }
        } catch(e) { _log('ERROR: Supabase connection: ' + e.message); }
        
        try {
            var t = await sb.from('tickets').select('project_id, ticket_number').limit(50);
            if (t.error) {
                _log('ERROR: Supabase tickets query FAILED: ' + t.error.message);
            } else {
                _log('Supabase tickets (first 50): ' + t.data.length);
                var byProject = {};
                t.data.forEach(function(tk){ byProject[tk.project_id] = (byProject[tk.project_id]||0) + 1; });
                Object.keys(byProject).forEach(function(pid){ _log('  project_id: ' + pid + ' -> ' + byProject[pid] + ' tickets'); });
            }
        } catch(e) { _log('ERROR: Supabase tickets: ' + e.message); }
    } else {
        _log('WARNING: sb is NULL â€” Supabase not connected!');
    }
    
    try {
        var allLocal = await getAllFromLocal('tickets') || [];
        _log('IndexedDB tickets: ' + allLocal.length);
        if (allLocal.length > 0) {
            var byPid = {};
            allLocal.forEach(function(t){ byPid[t.project_id] = (byPid[t.project_id]||0) + 1; });
            Object.keys(byPid).forEach(function(pid){ _log('  project_id: ' + pid + ' -> ' + byPid[pid] + ' tickets'); });
        }
    } catch(e) { _log('IndexedDB error: ' + e.message); }
    
    _log('===== End Diagnostic =====');
    
    var outEl = document.getElementById('diagnosticOutput');
    if (outEl) {
        outEl.classList.remove('hidden');
        outEl.textContent = diagLog.join(String.fromCharCode(10));
    }
    toast('Diagnostic complete', 'info');
}
window.runDiagnostic = runDiagnostic;

function updateKeyStatusIndicators() {
    const apiKey = localStorage.getItem('divertscan_openai');
    const sbUrl = localStorage.getItem('divertscan_sb_url');
    const sbKey = localStorage.getItem('divertscan_sb_key');
    
    // API Key status
    const apiStatus = document.getElementById('apiKeyStatus');
    if (apiStatus) {
        if (apiKey) {
            const masked = apiKey.substring(0, 10) + '...' + apiKey.slice(-4);
            apiStatus.innerHTML = `<span style="color:var(--emerald-400)">âœ… ${masked}</span>`;
        } else {
            apiStatus.innerHTML = `<span style="color:var(--red-500)">âŒ Not set</span>`;
        }
    }
    
    // Supabase status
    const sbStatus = document.getElementById('supabaseStatus');
    if (sbStatus) {
        if (sb && sbUrl && sbKey) {
            sbStatus.innerHTML = `<span style="color:var(--emerald-400)">âœ… Connected</span>`;
        } else if (sbUrl || sbKey) {
            sbStatus.innerHTML = `<span style="color:var(--amber-400)">âš ï¸ Incomplete</span>`;
        } else {
            sbStatus.innerHTML = `<span style="color:var(--slate-400)">Not configured (offline mode)</span>`;
        }
    }
    
    // Dashboard warning banner
    updateDashboardKeyWarning(apiKey, sbUrl, sbKey);
}

function updateDashboardKeyWarning(apiKey, sbUrl, sbKey) {
    let banner = document.getElementById('keyWarningBanner');
    
    // Only show for admin â€” customers and operators don't need API keys
    if (userRole !== 'admin') {
        if (banner) banner.remove();
        return;
    }
    
    const missing = [];
    if (!apiKey) missing.push('Anthropic API Key');
    if (!sbUrl || !sbKey) missing.push('Supabase');
    
    if (missing.length === 0) {
        if (banner) banner.remove();
        return;
    }
    
    if (!banner) {
        banner = document.createElement('div');
        banner.id = 'keyWarningBanner';
        banner.style.cssText = 'background:linear-gradient(135deg,#92400e,#78350f);border:1px solid #b45309;border-radius:8px;padding:12px 16px;margin-bottom:12px;font-size:12px;color:#fef3c7;cursor:pointer;';
        banner.onclick = () => showTab('settings');
        
        const dashTab = document.getElementById('dashboardTab');
        if (dashTab) dashTab.prepend(banner);
    }
    
    banner.innerHTML = `<strong>âš ï¸ Missing: ${missing.join(' & ')}</strong><br><span style="font-size:11px;opacity:0.8">Tap here to go to Settings and configure</span>`;
}

function toggleKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
    }
}

// Helper to read a single record from IndexedDB
async function getFromLocal(storeName, key) {
    if (!db) await initIndexedDB();
    return new Promise((resolve, reject) => {
        try {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);
            request.onsuccess = () => resolve(request.result || null);
            request.onerror = () => resolve(null);
        } catch (e) {
            resolve(null);
        }
    });
}

async function initializeApp() {
    updateKeyStatusIndicators();
    renderAllFacilities();
    
    // Always load projects first (from Supabase + IndexedDB)
    await loadProjects();
    
    // Migrate haulers from existing project data if first time
    migrateHaulersFromProjects();
    renderHaulerManager();
    renderCustomerAccounts();
    
    // Then load tickets for the active project
    if (currentProject) {
        await loadAllTicketsForProject();
    } else {
        // No project â€” try loading recent tickets anyway
        try {
            await loadRecentTickets();
        } catch(e) {
            document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">No tickets yet. Scan a scale ticket to get started.</p>';
        }
    }
    updateStats();
}

// ========== TABS ==========
function showTab(tab) {
    // Hide all tabs
    document.getElementById('dashboardTab').classList.add('hidden');
    document.getElementById('projectsTab').classList.add('hidden');
    document.getElementById('reportsTab').classList.add('hidden');
    document.getElementById('settingsTab').classList.add('hidden');
    var custUploadTab = document.getElementById('customerUploadTab');
    if (custUploadTab) custUploadTab.classList.add('hidden');
    var opScanTab = document.getElementById('operatorScanTab');
    if (opScanTab) opScanTab.classList.add('hidden');
    var pendingTabEl = document.getElementById('pendingTab');
    if (pendingTabEl) pendingTabEl.classList.add('hidden');
    
    if (tab === 'dashboard') {
        document.getElementById('dashboardTab').classList.remove('hidden');
        if (currentProject) {
            loadAllTicketsForProject();
        } else {
            loadProjects().then(function() {
                if (currentProject) loadAllTicketsForProject();
            });
        }
    } else if (tab === 'pending') {
        if (pendingTabEl) {
            pendingTabEl.classList.remove('hidden');
            loadPendingReviewTab();
        }
    } else if (tab === 'projects') {
        document.getElementById('projectsTab').classList.remove('hidden');
        loadProjects();
    } else if (tab === 'reports') {
        document.getElementById('reportsTab').classList.remove('hidden');
        populateReportProjectDropdown();
        setTimeout(initReportSignaturePad, 100);
        if (currentProject) {
            const sel = document.getElementById('reportProjectSelect');
            if (sel && !sel.value) sel.value = currentProject.id;
            generateReport();
        }
    } else if (tab === 'customerUpload') {
        if (custUploadTab) {
            custUploadTab.classList.remove('hidden');
            loadCustomerUploadHistory();
        }
    } else if (tab === 'operatorScan') {
        if (opScanTab) {
            opScanTab.classList.remove('hidden');
            populateOpProjectPicker();
            loadOpRecentScans();
        }
    } else if (tab === 'operatorHistory') {
        // Show scan tab but scroll to history
        if (opScanTab) {
            opScanTab.classList.remove('hidden');
            loadOpRecentScans();
            var historyEl = document.getElementById('opRecentScans');
            if (historyEl) historyEl.scrollIntoView({ behavior: 'smooth' });
        }
    } else if (tab === 'settings') {
        document.getElementById('settingsTab').classList.remove('hidden');
        var ak = localStorage.getItem('divertscan_openai');
        var su = localStorage.getItem('divertscan_sb_url');
        var sk = localStorage.getItem('divertscan_sb_key');
        if (ak) document.getElementById('apiKeyInput').value = ak;
        if (su) document.getElementById('supabaseUrl').value = su;
        if (sk) document.getElementById('supabaseKey').value = sk;
        updateKeyStatusIndicators();
        renderAllFacilities();
        renderHaulerManager();
        renderCustomerAccounts();
    }
    
    // Update nav active states
    document.querySelectorAll('.nav-item').forEach(function(item) { item.classList.remove('active'); });
    var navId = userRole === 'admin' ? 'adminNav' : userRole === 'operator' ? 'operatorNav' : 'customerNav';
    var navItems = document.getElementById(navId).querySelectorAll('.nav-item');
    var tabMap;
    if (userRole === 'admin') {
        tabMap = { 'dashboard': 0, 'pending': 1, 'projects': 2, 'reports': 3, 'settings': 4 };
    } else if (userRole === 'operator') {
        tabMap = { 'operatorScan': 0, 'operatorHistory': 1 };
    } else {
        tabMap = { 'dashboard': 0, 'customerUpload': 1, 'reports': 2 };
    }
    if (tabMap[tab] !== undefined && navItems[tabMap[tab]]) {
        navItems[tabMap[tab]].classList.add('active');
    }
}

// ========== API KEY ==========
function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (!key) {
        toast('Please enter an API key', 'error');
        return;
    }
    
    // Validate it looks like an Anthropic key
    if (key.startsWith('sk-') && !key.startsWith('sk-ant-')) {
        toast('âš ï¸ This looks like an OpenAI key. You need an Anthropic key (starts with sk-ant-)', 'error');
        return;
    }
    
    // Save to localStorage (primary)
    localStorage.setItem('divertscan_openai', key);
    
    // Backup to IndexedDB (survives localStorage clears)
    saveToLocal('settings', { key: 'anthropic_key', value: key }).catch(() => {});
    
    updateKeyStatusIndicators();
    toast('âœ… Anthropic API key saved!', 'success');
    
    // Quick validation test
    testApiKey(key);
}

async function testApiKey(key) {
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': key,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-haiku-4-5-20251001',
                max_tokens: 10,
                messages: [{ role: 'user', content: 'hi' }]
            })
        });
        
        if (response.ok) {
            toast('âœ… API key verified - connection working!', 'success');
        } else {
            const err = await response.json();
            if (err.error?.type === 'authentication_error') {
                toast('âŒ Invalid API key - check console.anthropic.com', 'error');
                localStorage.removeItem('divertscan_openai');
            } else if (err.error?.type === 'permission_error') {
                toast('âŒ Key lacks permissions - check API settings', 'error');
            } else {
                toast('âš ï¸ Key saved but test returned: ' + (err.error?.message || response.status), 'warning');
            }
        }
    } catch (e) {
        toast('âš ï¸ Key saved but could not verify (network issue)', 'warning');
    }
}

// ========== SUPABASE CONFIG ==========
function saveSupabaseConfig() {
    const url = document.getElementById('supabaseUrl').value.trim();
    const key = document.getElementById('supabaseKey').value.trim();
    
    if (!url || !key) {
        toast('Please enter both URL and Key', 'error');
        return;
    }
    
    // Save to localStorage (primary)
    localStorage.setItem('divertscan_sb_url', url);
    localStorage.setItem('divertscan_sb_key', key);
    
    // Backup to IndexedDB (survives localStorage clears)
    saveToLocal('settings', { key: 'supabase_url', value: url }).catch(() => {});
    saveToLocal('settings', { key: 'supabase_key', value: key }).catch(() => {});
    
    // Reinitialize Supabase
    if (typeof supabase !== 'undefined') {
        sb = supabase.createClient(url, key);
        toast('Supabase connected!', 'success');
        updateKeyStatusIndicators();
        initializeApp();
    }
}

// ========== PITCH DECK PDF ==========
async function generateAndSharePitchDeck() {
    var pdfBlob = buildPitchDeckPDF();
    if (!pdfBlob) return;
    
    var file = new File([pdfBlob], 'DivertScan_Pitch_Deck.pdf', { type: 'application/pdf' });
    
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({ files: [file] });
            toast('Shared!', 'success');
        } catch(e) {
            if (e.name !== 'AbortError') downloadPitchDeck();
        }
    } else {
        downloadPitchDeck();
    }
}

function downloadPitchDeck() {
    var pdfBlob = buildPitchDeckPDF();
    if (!pdfBlob) return;
    var url = URL.createObjectURL(pdfBlob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'DivertScan_Pitch_Deck.pdf';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(function(){ URL.revokeObjectURL(url); }, 5000);
    toast('Pitch deck downloaded!', 'success');
}

function buildPitchDeckPDF() {
    try {
        if (typeof window.jspdf === 'undefined' && typeof jspdf === 'undefined') {
            toast('Loading PDF library...', 'info');
            return null;
        }
        var JsPDF = (window.jspdf && window.jspdf.jsPDF) || jspdf.jsPDF;
        var doc = new JsPDF({ orientation: 'landscape', unit: 'in', format: [10, 5.625] });
        
        var darkBg = [15, 27, 45];
        var green = [27, 94, 32];
        var accent = [0, 200, 83];
        var white = [255, 255, 255];
        var slate = [96, 125, 139];
        var lightBg = [245, 247, 244];
        
        // PAGE 1: TITLE
        doc.setFillColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.rect(0, 0, 10, 5.625, 'F');
        doc.setFillColor(accent[0], accent[1], accent[2]);
        doc.rect(0, 0, 10, 0.06, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(14);
        doc.setTextColor(white[0], white[1], white[2]);
        doc.text('DivertScan', 0.6, 0.8);
        doc.setFontSize(32);
        doc.text('AI-Powered LEED', 0.6, 1.8);
        doc.text('Waste Tracking Platform', 0.6, 2.4);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(11);
        doc.setTextColor(slate[0], slate[1], slate[2]);
        doc.text('Automated material identification, OCR scale ticket processing,', 0.6, 3.2);
        doc.text('and real-time LEED v4.1/v5 MRc5 compliance reporting', 0.6, 3.5);
        doc.setFillColor(accent[0], accent[1], accent[2]);
        doc.rect(0.6, 4.0, 2.0, 0.4, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.text('LEED v5 Ready', 1.15, 4.27);
        doc.setFontSize(8);
        doc.setTextColor(slate[0], slate[1], slate[2]);
        doc.text('Dalmex Recycling LLC  |  2828 Nagle St., Dallas, TX 75220  |  (214) 352-2000', 0.6, 5.3);
        // Stats
        var stats = [{ v: '75%+', l: 'LEED Target' }, { v: '200%', l: 'v5 Salvage' }, { v: '<2s', l: 'OCR Speed' }];
        stats.forEach(function(s, i) {
            var yy = 1.0 + i * 1.2;
            doc.setFillColor(26, 42, 64);
            doc.rect(7.3, yy, 2.2, 0.9, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor(accent[0], accent[1], accent[2]);
            doc.text(s.v, 8.4, yy + 0.45, { align: 'center' });
            doc.setFontSize(8);
            doc.setTextColor(slate[0], slate[1], slate[2]);
            doc.text(s.l, 8.4, yy + 0.7, { align: 'center' });
        });
        
        // PAGE 2: FEATURES
        doc.addPage();
        doc.setFillColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.rect(0, 0, 10, 5.625, 'F');
        doc.setFillColor(accent[0], accent[1], accent[2]);
        doc.rect(0, 0, 10, 0.06, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        doc.setTextColor(white[0], white[1], white[2]);
        doc.text('DivertScan Apex â€” Key Features', 0.6, 0.65);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(accent[0], accent[1], accent[2]);
        doc.text('From scale ticket to LEED report in under 60 seconds', 0.6, 1.0);
        var feats = [
            { t: 'AI OCR', d: 'Snap any scale ticket. AI reads ticket #, gross, tare, net weight â€” even bad handwriting.' },
            { t: 'Material Identification', d: 'CNN-based debris analysis identifies wood, concrete, metal, OCC, plastic, drywall.' },
            { t: 'LEED MRc5 Reports', d: 'One-tap PDF, Excel, CSV with full documentation and facility attestation.' },
            { t: 'Chain of Custody', d: 'Scale ticket > material ID > verified end market > LEED credit. Full audit trail.' },
            { t: 'Partner Network', d: 'Direct-to-end-market loads auto-verified. Pre-configured partners.' },
            { t: 'Cloud + Offline', d: 'Works on iPad offline. Syncs to cloud when connected. Never lose a ticket.' },
        ];
        feats.forEach(function(f, i) {
            var col = i % 2, row = Math.floor(i / 2);
            var xx = 0.6 + col * 4.6, yy = 1.4 + row * 1.3;
            doc.setFillColor(26, 42, 64);
            doc.rect(xx, yy, 4.2, 1.0, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.setTextColor(white[0], white[1], white[2]);
            doc.text(f.t, xx + 0.15, yy + 0.3);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            doc.setTextColor(slate[0], slate[1], slate[2]);
            doc.text(f.d, xx + 0.15, yy + 0.6, { maxWidth: 3.9 });
        });
        
        // PAGE 3: MATERIAL FLOW
        doc.addPage();
        doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
        doc.rect(0, 0, 10, 5.625, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(24);
        doc.setTextColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.text('Closed-Loop Material Flow', 0.6, 0.65);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(slate[0], slate[1], slate[2]);
        doc.text('Every material stream tracked from demolition site to verified end market', 0.6, 1.0);
        // Center circle
        doc.setFillColor(green[0], green[1], green[2]);
        doc.circle(5.0, 3.1, 0.9, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(white[0], white[1], white[2]);
        doc.text('DALMEX', 5.0, 3.0, { align: 'center' });
        doc.setFontSize(8);
        doc.text('RECYCLING', 5.0, 3.3, { align: 'center' });
        // Material boxes
        var mats = [
            { t: 'OCC / Fiber', d: 'Georgia Pacific, Smurfit,\nGreenside, Intl Paper', x: 0.3, y: 1.3, c: [255, 224, 130] },
            { t: 'Wood / Pallets', d: 'Dalmex Pallets\n(In-House Reuse)', x: 7.5, y: 1.3, c: [121, 85, 72] },
            { t: 'Metal / Scrap', d: 'CMC, Cyclone Metal', x: 7.5, y: 2.7, c: [69, 90, 100] },
            { t: 'Concrete', d: 'Big City Concrete', x: 7.5, y: 4.0, c: [120, 144, 156] },
            { t: 'Plastic', d: 'Recycle USA', x: 0.3, y: 4.0, c: [66, 165, 245] },
            { t: 'Drywall', d: 'USA Gypsum', x: 0.3, y: 2.7, c: [188, 170, 164] },
        ];
        mats.forEach(function(m) {
            doc.setFillColor(m.c[0], m.c[1], m.c[2]);
            doc.rect(m.x, m.y, 2.2, 1.0, 'F');
            var isDark = (m.c[0] + m.c[1] + m.c[2]) / 3 < 150;
            doc.setTextColor(isDark ? 255 : 30, isDark ? 255 : 30, isDark ? 255 : 30);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(9);
            doc.text(m.t, m.x + 0.15, m.y + 0.3);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(7);
            doc.text(m.d, m.x + 0.15, m.y + 0.55, { maxWidth: 1.9 });
        });
        
        // PAGE 4: SAMPLE REPORT
        doc.addPage();
        doc.setFillColor(lightBg[0], lightBg[1], lightBg[2]);
        doc.rect(0, 0, 10, 5.625, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(22);
        doc.setTextColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.text('Sample LEED MRc5 Report', 0.6, 0.6);
        doc.setFillColor(255, 255, 255);
        doc.rect(0.5, 0.9, 9.0, 4.4, 'F');
        doc.setFillColor(green[0], green[1], green[2]);
        doc.rect(0.5, 0.9, 9.0, 0.35, 'F');
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.text('C&D Waste Management Report â€” LEED v4.1/v5 MRc5', 0.7, 1.15);
        doc.setFontSize(8);
        doc.setTextColor(darkBg[0], darkBg[1], darkBg[2]);
        doc.text('Project: DFW Airport Terminal Renovation  |  GC: JE Dunn  |  Hauler: B&B Waste', 0.7, 1.55);
        // Stats
        var rStats = [{ v: '73%', l: 'Diversion' }, { v: '9.86T', l: 'Total' }, { v: '7.21T', l: 'Diverted' }, { v: '2.64T', l: 'Landfill' }];
        rStats.forEach(function(s, i) {
            var xx = 0.7 + i * 2.15;
            doc.setFillColor(232, 245, 233);
            doc.rect(xx, 1.75, 1.9, 0.7, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.setTextColor(i === 3 ? 229 : 0, i === 3 ? 57 : i === 0 ? 200 : 100, i === 3 ? 53 : i === 0 ? 83 : 50);
            doc.text(s.v, xx + 0.95, 2.15, { align: 'center' });
            doc.setFontSize(7);
            doc.setTextColor(slate[0], slate[1], slate[2]);
            doc.text(s.l, xx + 0.95, 2.35, { align: 'center' });
        });
        // Table
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        var cols = ['Date', 'Ticket #', 'Hauler', 'Gross', 'Tare', 'Net(T)', 'Div%', 'Verified'];
        var colX = [0.7, 1.8, 2.8, 3.6, 4.6, 5.6, 6.5, 7.4];
        doc.setFillColor(green[0], green[1], green[2]);
        doc.rect(0.7, 2.6, 7.5, 0.25, 'F');
        doc.setTextColor(255, 255, 255);
        cols.forEach(function(c, i) { doc.text(c, colX[i], 2.78); });
        var rows = [['Feb 4, 2026', '83434', 'B&B', '38,880', '33,140', '2.87', '50%', 'Yes'],['Sep 28, 2025', '885227', 'B&B', '40,720', '34,360', '3.18', '80%', 'Yes'],['Dec 29, 2025', '84731', '7610', '39,940', '32,330', '3.81', '85%', 'Yes']];
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(darkBg[0], darkBg[1], darkBg[2]);
        rows.forEach(function(r, ri) {
            var ry = 3.05 + ri * 0.22;
            r.forEach(function(c, ci) { doc.text(c, colX[ci], ry); });
        });
        doc.setFont('helvetica', 'bold');
        doc.text('TOTALS', 0.7, 3.75);
        doc.setTextColor(0, 200, 83);
        doc.text('9.86', 5.6, 3.75);
        doc.text('73%', 6.5, 3.75);
        // Attestation
        doc.setFillColor(232, 245, 233);
        doc.rect(0.7, 4.0, 8.6, 0.6, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8);
        doc.setTextColor(green[0], green[1], green[2]);
        doc.text('Facility Attestation', 0.85, 4.2);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(7);
        doc.setTextColor(slate[0], slate[1], slate[2]);
        doc.text('Verified scale ticket data with chain-of-custody. Materials routed to documented end markets by Dalmex Recycling LLC.', 0.85, 4.4);
        doc.text('End Markets: Georgia Pacific | Smurfit | CMC | Cyclone | Big City Concrete | USA Gypsum | Dalmex Pallets | Recycle USA', 0.85, 4.55);
        // Footer
        doc.setFontSize(7);
        doc.setTextColor(slate[0], slate[1], slate[2]);
        doc.text('DivertScan Apex v7.7 Enterprise  |  divertscan.com  |  Dalmex Recycling LLC  |  IP & Trademark Pending', 0.6, 5.5);
        
        return doc.output('blob');
    } catch(e) {
        console.error('Pitch deck PDF error:', e);
        toast('Error generating PDF â€” check console', 'error');
        return null;
    }
}

function generateKeyBookmark() {
    var ak = localStorage.getItem('divertscan_openai') || '';
    var su = localStorage.getItem('divertscan_sb_url') || '';
    var sk = localStorage.getItem('divertscan_sb_key') || '';
    
    if (!ak && !su && !sk) {
        toast('No keys saved â€” enter your keys first', 'error');
        return;
    }
    
    var parts = [];
    if (ak) parts.push('ak=' + encodeURIComponent(ak));
    if (su) parts.push('su=' + encodeURIComponent(su));
    if (sk) parts.push('sk=' + encodeURIComponent(sk));
    
    var baseUrl = window.location.origin + window.location.pathname;
    var bookmarkUrl = baseUrl + '#' + parts.join('&');
    
    // Copy to clipboard
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(bookmarkUrl).then(function() {
            toast('Bookmark URL copied! Save it as a bookmark for instant access.', 'success');
        }).catch(function() {
            showBookmarkFallback(bookmarkUrl);
        });
    } else {
        showBookmarkFallback(bookmarkUrl);
    }
    
    var resultEl = document.getElementById('keyBookmarkResult');
    if (resultEl) {
        resultEl.style.display = 'block';
        resultEl.textContent = bookmarkUrl;
    }
}

function showBookmarkFallback(url) {
    prompt('Copy this URL and save it as a bookmark:', url);
    toast('Copy the URL and save as a bookmark', 'info');
}

// ========== PROJECTS ==========
async function loadProjects() {
    try {
        let remoteProjects = [];
        let localProjects = [];
        
        // Fetch Supabase + IndexedDB IN PARALLEL
        var fetches = [];
        
        if (sb) {
            fetches.push(
                Promise.race([
                    sb.from('projects').select('*').order('created_at', {ascending:false}),
                    new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},8000)})
                ]).then(function(result) {
                    if (result && !result.error && result.data) remoteProjects = result.data;
                }).catch(function(e) { console.log('Supabase projects fetch skipped:', e.message); })
            );
        }
        
        fetches.push(
            (async function() {
                try { localProjects = await getAllFromLocal('projects') || []; }
                catch(e) { console.log('Local projects fetch error:', e.message); }
            })()
        );
        
        await Promise.all(fetches);
        
        // Merge and dedupe by project name (prefer remote)
        const projectMap = new Map();
        localProjects.forEach(p => projectMap.set(p.id || p.name, p));
        remoteProjects.forEach(p => projectMap.set(p.id || p.name, p));
        
        projects = Array.from(projectMap.values());
        projects.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
        
        // Load current project from localStorage
        const savedProject = localStorage.getItem('divertscan_current_project');
        if (savedProject) {
            try {
                const parsed = JSON.parse(savedProject);
                currentProject = projects.find(p => p.id === (parsed.id || parsed));
            } catch (e) {
                currentProject = projects.find(p => p.id === savedProject);
            }
        }
        if (!currentProject && projects.length > 0) {
            currentProject = projects[0];
            localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
        }
        
        updateProjectDisplay();
        populateProjectDropdown();
        renderProjectsList();
        
        // Store for report dropdown access
        window._allProjectsList = projects;
        populateReportProjectDropdown();
    } catch (err) {
        console.error('Error loading projects:', err);
    }
}

function updateProjectDisplay() {
    if (currentProject) {
        document.getElementById('currentProjectName').textContent = currentProject.name;
        document.getElementById('currentProjectHauler').textContent = currentProject.waste_hauler || '';
    } else {
        document.getElementById('currentProjectName').textContent = 'No Project Selected';
        document.getElementById('currentProjectHauler').textContent = 'Create a project to get started';
    }
}

function populateProjectDropdown() {
    const select = document.getElementById('ticketProject');
    select.innerHTML = '<option value="">Select Project...</option>';
    
    projects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        if (currentProject && p.id === currentProject.id) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

function renderProjectsList() {
    const container = document.getElementById('projectsList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet. Create your first project!</p>';
        return;
    }
    
    container.innerHTML = projects.map(p => `
        <div class="card" style="margin-bottom:12px;cursor:pointer" id="project-card-${p.id}" onclick="expandProjectView('${p.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="flex:1">
                    <div style="font-weight:600;display:flex;align-items:center;gap:8px">
                        <span id="project-arrow-${p.id}" style="font-size:10px;color:var(--slate-400)">â–¶</span>
                        ${p.name}
                        ${currentProject && currentProject.id === p.id ? '<span style="background:var(--emerald-500);color:white;padding:2px 8px;border-radius:10px;font-size:10px">ACTIVE</span>' : ''}
                    </div>
                    <div style="font-size:12px;color:var(--slate-400);margin-left:20px">${p.address || 'No address'}${p.waste_hauler ? ' Â· ' + p.waste_hauler : ''}</div>
                </div>
                <div style="text-align:right;flex-shrink:0">
                    <div id="project-stat-tons-${p.id}" style="font-size:14px;font-weight:700;color:var(--accent-primary)">â€”</div>
                    <div style="font-size:9px;color:var(--slate-400)">tons</div>
                </div>
            </div>
            <!-- Expanded content loads dynamically -->
            <div id="project-expand-${p.id}" class="hidden" onclick="event.stopPropagation()"></div>
        </div>
    `).join('');
}

async function expandProjectView(projectId) {
    var expandEl = document.getElementById('project-expand-' + projectId);
    var arrowEl = document.getElementById('project-arrow-' + projectId);
    if (!expandEl) return;
    
    // Toggle off if already open
    if (!expandEl.classList.contains('hidden')) {
        expandEl.classList.add('hidden');
        if (arrowEl) arrowEl.textContent = 'â–¶';
        return;
    }
    
    // Close all others
    projects.forEach(function(p) {
        var el = document.getElementById('project-expand-' + p.id);
        var ar = document.getElementById('project-arrow-' + p.id);
        if (el) el.classList.add('hidden');
        if (ar) ar.textContent = 'â–¶';
    });
    
    expandEl.classList.remove('hidden');
    if (arrowEl) arrowEl.textContent = 'â–¼';
    
    // Set as active project
    var proj = projects.find(function(p) { return p.id === projectId; });
    if (proj) {
        currentProject = proj;
        localStorage.setItem('divertscan_current_project', JSON.stringify(proj));
        updateProjectDisplay();
    }
    
    // Show loading
    expandEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--slate-400)">Loading project data...</div>';
    
    // Fetch tickets for this project
    var projTickets = [];
    if (sb) {
        try {
            var result = await Promise.race([
                sb.from('tickets').select('*').eq('project_id', projectId).order('created_at', {ascending:false}),
                new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},5000)})
            ]);
            if (result && !result.error && result.data) projTickets = result.data;
        } catch(e) {}
    }
    // Merge local
    try {
        var allLocal = await getAllFromLocal('tickets') || [];
        var localFiltered = allLocal.filter(function(t){return t.project_id === projectId});
        var tMap = new Map();
        localFiltered.forEach(function(t){tMap.set(t.ticket_number||t.id, t)});
        projTickets.forEach(function(t){tMap.set(t.ticket_number||t.id, t)});
        projTickets = Array.from(tMap.values());
        projTickets.sort(function(a,b){return new Date(b.created_at||b.service_date) - new Date(a.created_at||a.service_date)});
    } catch(e) {}
    
    // Calculate stats
    var totalTons = projTickets.reduce(function(s,t){return s+(t.net_tons||0)},0);
    var landfillTons = projTickets.reduce(function(s,t){return s+(t.landfill_tons||0)},0);
    var divRate = totalTons > 0 ? Math.round(((totalTons-landfillTons)/totalTons)*100) : 0;
    
    // Update the mini stat on the card header
    var statEl = document.getElementById('project-stat-tons-' + projectId);
    if (statEl) statEl.textContent = totalTons.toFixed(2);
    
    // Build the expanded view
    var html = '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--slate-700)">';
    
    // Project info bar
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px;font-size:11px">';
    html += '<div><span style="color:var(--slate-400)">Address:</span> ' + (proj.address||'â€”') + '</div>';
    html += '<div><span style="color:var(--slate-400)">Hauler:</span> ' + (proj.waste_hauler||'â€”') + '</div>';
    html += '<div><span style="color:var(--slate-400)">GC:</span> ' + (proj.general_contractor||'â€”') + '</div>';
    html += '<div><span style="color:var(--slate-400)">LEED Target:</span> ' + (proj.leed_target||75) + '%</div>';
    html += '<div style="grid-column:span 2"><span style="color:var(--slate-400)">ğŸ”‘ Customer Access Code:</span> <span style="font-weight:700;color:var(--emerald-400);font-family:monospace;font-size:13px;letter-spacing:2px">' + (proj.access_code||'Not Set') + '</span></div>';
    html += '</div>';
    
    // Stats row
    var statColor = divRate >= 75 ? 'var(--emerald-400)' : divRate >= 50 ? 'var(--amber-400)' : 'var(--red-400)';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;margin-bottom:16px">';
    html += '<div style="text-align:center;padding:10px;background:var(--bg-tertiary);border-radius:8px"><div style="font-size:18px;font-weight:700;color:var(--accent-primary)">' + totalTons.toFixed(2) + '</div><div style="font-size:9px;color:var(--slate-400)">Total Tons</div></div>';
    html += '<div style="text-align:center;padding:10px;background:var(--bg-tertiary);border-radius:8px"><div style="font-size:18px;font-weight:700;color:' + statColor + '">' + divRate + '%</div><div style="font-size:9px;color:var(--slate-400)">Diversion</div></div>';
    html += '<div style="text-align:center;padding:10px;background:var(--bg-tertiary);border-radius:8px"><div style="font-size:18px;font-weight:700;color:var(--emerald-400)">' + (totalTons-landfillTons).toFixed(2) + '</div><div style="font-size:9px;color:var(--slate-400)">Diverted</div></div>';
    html += '<div style="text-align:center;padding:10px;background:var(--bg-tertiary);border-radius:8px"><div style="font-size:18px;font-weight:700;color:var(--red-400)">' + landfillTons.toFixed(2) + '</div><div style="font-size:9px;color:var(--slate-400)">Landfill</div></div>';
    html += '</div>';
    
    // Export buttons
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">';
    html += '<button class="btn btn-primary" onclick="event.stopPropagation();generateLEEDAuditReport()" style="flex:1;padding:8px;font-size:11px">ğŸ“„ PDF Report</button>';
    html += '<button class="btn btn-secondary" onclick="event.stopPropagation();downloadReportExcel()" style="flex:1;padding:8px;font-size:11px">ğŸ“Š Excel</button>';
    html += '<button class="btn btn-secondary" onclick="event.stopPropagation();shareLEEDPDF()" style="flex:1;padding:8px;font-size:11px">ğŸ“¤ Share</button>';
    html += '<button class="btn btn-secondary" onclick="event.stopPropagation();toggleProjectEditFields(\'' + projectId + '\')" style="padding:8px;font-size:11px">âœï¸ Edit</button>';
    html += '<button class="btn" onclick="event.stopPropagation();confirmDeleteProject(\'' + projectId + '\')" style="background:var(--red-500);color:white;padding:8px;font-size:11px">ğŸ—‘ï¸</button>';
    html += '</div>';
    
    // Collapsible edit fields
    html += '<div id="project-edit-fields-' + projectId + '" class="hidden" style="margin-bottom:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px">';
    html += '<div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" id="edit-name-' + projectId + '" value="' + (proj.name||'').replace(/"/g,'&quot;') + '"></div>';
    html += '<div class="form-group"><label class="form-label">Address</label><input type="text" class="form-input" id="edit-address-' + projectId + '" value="' + (proj.address||'').replace(/"/g,'&quot;') + '"></div>';
    html += '<div class="form-group"><label class="form-label">Waste Hauler</label><input type="text" class="form-input" id="edit-hauler-' + projectId + '" value="' + (proj.waste_hauler||'').replace(/"/g,'&quot;') + '"></div>';
    html += '<div class="form-group"><label class="form-label">General Contractor</label><input type="text" class="form-input" id="edit-gc-' + projectId + '" value="' + (proj.general_contractor||'').replace(/"/g,'&quot;') + '"></div>';
    html += '<div class="form-group"><label class="form-label">LEED Target %</label><input type="number" class="form-input" id="edit-target-' + projectId + '" value="' + (proj.leed_target||75) + '" min="50" max="100"></div>';
    html += '<div class="form-group"><label class="form-label">ğŸ”‘ Customer Access Code</label><input type="text" class="form-input" id="edit-code-' + projectId + '" value="' + (proj.access_code||'') + '" style="text-transform:uppercase;font-family:monospace;font-size:14px;letter-spacing:2px" placeholder="e.g. CHILD2025"><div style="font-size:10px;color:var(--slate-400);margin-top:4px">Customers use this code to log in and view their project reports</div></div>';
    html += '<button class="btn btn-primary" onclick="event.stopPropagation();saveProjectEdit(\'' + projectId + '\')" style="width:100%;margin-top:8px">ğŸ’¾ Save Changes</button>';
    html += '</div>';
    
    // Tickets table
    html += '<div style="font-size:12px;font-weight:600;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">';
    html += '<span>ğŸ“‹ Tickets (' + projTickets.length + ')</span>';
    html += '</div>';
    
    if (projTickets.length === 0) {
        html += '<div style="padding:16px;text-align:center;color:var(--slate-400);font-size:12px">No tickets yet for this project. Scan a scale ticket to get started.</div>';
    } else {
        html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:10px">';
        html += '<thead><tr style="background:var(--bg-tertiary)">';
        html += '<th style="padding:6px 4px;text-align:left;color:var(--emerald-400);font-size:9px">Date</th>';
        html += '<th style="padding:6px 4px;text-align:left;color:var(--emerald-400);font-size:9px">Ticket #</th>';
        html += '<th style="padding:6px 4px;text-align:left;color:var(--emerald-400);font-size:9px">Hauler</th>';
        html += '<th style="padding:6px 4px;text-align:right;color:var(--emerald-400);font-size:9px">Gross</th>';
        html += '<th style="padding:6px 4px;text-align:right;color:var(--emerald-400);font-size:9px">Tare</th>';
        html += '<th style="padding:6px 4px;text-align:right;color:var(--emerald-400);font-size:9px">Net(T)</th>';
        html += '<th style="padding:6px 4px;text-align:right;color:var(--emerald-400);font-size:9px">Div%</th>';
        html += '<th style="padding:6px 4px;text-align:center;color:var(--emerald-400);font-size:9px">Actions</th>';
        html += '</tr></thead><tbody>';
        
        projTickets.forEach(function(t) {
            var divP = t.diversion_pct || 0;
            var dColor = divP >= 75 ? 'var(--emerald-400)' : divP >= 50 ? 'var(--amber-400)' : 'var(--red-400)';
            html += '<tr style="border-bottom:1px solid var(--slate-700)">';
            html += '<td style="padding:6px 4px;white-space:nowrap">' + formatDate(t.service_date) + '</td>';
            html += '<td style="padding:6px 4px;font-weight:600">' + (t.ticket_number||'â€”') + '</td>';
            html += '<td style="padding:6px 4px;color:var(--slate-400)">' + (t.hauler||'â€”') + '</td>';
            html += '<td style="padding:6px 4px;text-align:right;color:var(--slate-400)">' + (t.gross_lbs||0).toLocaleString() + '</td>';
            html += '<td style="padding:6px 4px;text-align:right;color:var(--slate-400)">' + (t.tare_lbs||0).toLocaleString() + '</td>';
            html += '<td style="padding:6px 4px;text-align:right;font-weight:600">' + (t.net_tons||0).toFixed(2) + '</td>';
            html += '<td style="padding:6px 4px;text-align:right;color:' + dColor + ';font-weight:600">' + divP + '%</td>';
            html += '<td style="padding:6px 4px;text-align:center;white-space:nowrap">';
            html += '<button onclick="event.stopPropagation();editTicket(\'' + t.id + '\')" style="background:var(--accent-info);border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="Edit">âœï¸</button>';
            html += '<button onclick="event.stopPropagation();generateTicketCOD(\'' + t.id + '\')" style="background:#7c3aed;border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="COD">ğŸ“œ</button>';
            html += '<button onclick="event.stopPropagation();confirmDeleteTicket(\'' + t.id + '\')" style="background:var(--accent-danger);border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="Delete">ğŸ—‘ï¸</button>';
            html += '</td>';
            html += '</tr>';
        });
        
        // Totals row
        html += '<tr style="border-top:2px solid var(--emerald-500);font-weight:700">';
        html += '<td colspan="5" style="padding:6px 4px">TOTALS</td>';
        html += '<td style="padding:6px 4px;text-align:right">' + totalTons.toFixed(2) + '</td>';
        html += '<td style="padding:6px 4px;text-align:right;color:' + statColor + '">' + divRate + '%</td>';
        html += '<td></td></tr>';
        html += '</tbody></table></div>';
    }
    
    html += '</div>';
    expandEl.innerHTML = html;
    
    // Store these tickets in the global array so export functions work
    tickets = projTickets;
}

function toggleProjectEditFields(projectId) {
    var el = document.getElementById('project-edit-fields-' + projectId);
    if (el) el.classList.toggle('hidden');
}

async function saveProjectEdit(projectId) {
    const updates = {
        name: document.getElementById('edit-name-' + projectId)?.value || '',
        address: document.getElementById('edit-address-' + projectId)?.value || '',
        waste_hauler: document.getElementById('edit-hauler-' + projectId)?.value || '',
        general_contractor: document.getElementById('edit-gc-' + projectId)?.value || '',
        leed_target: parseInt(document.getElementById('edit-target-' + projectId)?.value) || 75,
        access_code: (document.getElementById('edit-code-' + projectId)?.value || '').trim().toUpperCase()
    };
    
    try {
        showLoading('Saving...');
        
        // Try Supabase if available
        if (sb) {
            try {
                const { error } = await sb.from('projects').update(updates).eq('id', projectId);
                if (error) {
                    console.error('Supabase project update error:', error);
                    toast('Cloud save error: ' + error.message + ' â€” saved locally', 'warning');
                } else {
                    console.log('Project saved to Supabase OK');
                }
            } catch (e) {
                console.log('Supabase project save skipped:', e.message);
                toast('Cloud save failed â€” saved locally only', 'warning');
            }
        }
        
        // Always update local
        const idx = projects.findIndex(p => p.id === projectId);
        if (idx >= 0) projects[idx] = { ...projects[idx], ...updates };
        if (currentProject && currentProject.id === projectId) {
            currentProject = { ...currentProject, ...updates };
            localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
        }
        
        // Update IndexedDB
        try {
            const localProject = await getFromLocal('projects', projectId);
            if (localProject) {
                Object.assign(localProject, updates);
                await saveToLocal('projects', localProject);
            }
        } catch (e) {}
        
        hideLoading();
        updateProjectDisplay();
        renderProjectsList();
        window._allProjectsList = projects;
        populateReportProjectDropdown();
        toast('Project updated!', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

function confirmDeleteProject(projectId) {
    var project = projects.find(function(p) { return p.id === projectId; });
    // Delay for iPad Safari touch event bubbling
    setTimeout(function() {
        if (confirm('Delete project "' + (project ? project.name : '') + '"? This cannot be undone.')) {
            deleteProject(projectId);
        }
    }, 100);
}

async function deleteProject(projectId) {
    try {
        showLoading('Deleting...');
        
        // Try Supabase if available
        if (sb) {
            try {
                await sb.from('projects').delete().eq('id', projectId);
            } catch (e) { console.log('Supabase project delete skipped:', e.message); }
        }
        
        // Delete from IndexedDB
        try {
            await deleteFromLocal('projects', projectId);
        } catch (e) {}
        
        hideLoading();
        
        projects = projects.filter(p => p.id !== projectId);
        if (currentProject && currentProject.id === projectId) {
            currentProject = projects[0] || null;
            if (currentProject) {
                localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
            } else {
                localStorage.removeItem('divertscan_current_project');
            }
        }
        
        window._allProjectsList = projects;
        updateProjectDisplay();
        renderProjectsList();
        populateReportProjectDropdown();
        toast('Project deleted', 'success');
    } catch (err) {
        hideLoading();
        toast('Error: ' + err.message, 'error');
    }
}

async function viewProjectTickets(projectId) {
    // Switch to this project and go to home to see tickets
    await selectProject(projectId);
    showTab('dashboard');
}

function showProjectPicker() {
    const container = document.getElementById('projectPickerList');
    
    if (projects.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No projects yet.</p>';
    } else {
        container.innerHTML = projects.map(p => `
            <div class="card" style="cursor:pointer;margin-bottom:8px" onclick="selectProject('${p.id}');closeModal('projectPickerModal')">
                <div style="font-weight:600">${p.name}</div>
                <div style="font-size:12px;color:var(--slate-400)">${p.waste_hauler || ''}</div>
            </div>
        `).join('');
    }
    
    openModal('projectPickerModal');
}

function generateAccessCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function showNewProjectModal() {
    document.getElementById('projectName').value = '';
    document.getElementById('projectAddress').value = '';
    document.getElementById('projectHauler').value = '';
    document.getElementById('projectLeedTarget').value = '75';
    document.getElementById('projectGC').value = '';
    document.getElementById('projectAccessCode').value = generateAccessCode();
    openModal('projectModal');
}

async function saveProject() {
    const name = document.getElementById('projectName').value.trim();
    if (!name) {
        toast('Project name is required', 'error');
        return;
    }
    
    const projectData = {
        id: 'proj_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6),
        name: name,
        address: document.getElementById('projectAddress').value.trim(),
        waste_hauler: document.getElementById('projectHauler').value.trim(),
        leed_target: parseInt(document.getElementById('projectLeedTarget').value) || 75,
        general_contractor: document.getElementById('projectGC').value.trim(),
        access_code: document.getElementById('projectAccessCode').value.trim().toUpperCase(),
        created_at: new Date().toISOString()
    };
    
    // Close modal IMMEDIATELY - no spinner, no waiting
    closeModal('projectModal');
    
    // === LAYER 1: Always save to localStorage (instant, synchronous, never fails) ===
    try {
        let lsProjects = [];
        try { lsProjects = JSON.parse(localStorage.getItem('divertscan_projects_local') || '[]'); } catch(e) {}
        lsProjects.push(projectData);
        localStorage.setItem('divertscan_projects_local', JSON.stringify(lsProjects));
        console.log('Layer 1 OK: Project saved to localStorage:', projectData.id);
    } catch (e) {
        console.error('localStorage save failed:', e);
    }
    
    // === LAYER 2: Try IndexedDB (async, non-blocking) ===
    try {
        if (!db) { try { await initIndexedDB(); } catch(e) { console.log('IndexedDB init failed:', e); } }
        if (db) {
            await saveToLocal('projects', projectData);
            console.log('Layer 2 OK: Project saved to IndexedDB');
        }
    } catch (e) {
        console.log('IndexedDB save failed (localStorage is fine):', e);
    }
    
    // === LAYER 3: Try Supabase with 3s timeout (fire-and-forget) ===
    if (sb) {
        try {
            const sbData = { ...projectData };
            delete sbData.id;
            const result = await Promise.race([
                sb.from('projects').insert([sbData]).select(),
                new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 8000))
            ]);
            if (result && result.data && result.data[0]) {
                console.log('Layer 3 OK: Project also saved to Supabase');
            }
        } catch (e) {
            console.log('Supabase save skipped:', e.message);
        }
    }
    
    // === Update UI immediately - no async calls needed ===
    if (!Array.isArray(projects)) projects = [];
    projects.push(projectData);
    currentProject = projectData;
    localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
    
    try { updateProjectDisplay(); } catch(e) {}
    try { renderProjectsList(); } catch(e) {}
    try { loadRecentTickets(); } catch(e) {}
    try { updateStats(); } catch(e) {}
    
    toast('Project created: ' + projectData.name, 'success');
}

function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// ========== TICKETS ==========
async function loadRecentTickets() {
    if (!currentProject) {
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--slate-400)">Select a project to see tickets</p>';
        return;
    }
    
    try {
        let remoteTickets = [];
        let localTickets = [];
        
        // Fetch Supabase + IndexedDB IN PARALLEL
        var fetches = [];
        
        if (sb) {
            fetches.push(
                Promise.race([
                    sb.from('tickets').select('*').eq('project_id', currentProject.id).order('created_at', {ascending:false}).limit(50),
                    new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},8000)})
                ]).then(function(result) {
                    if (result && !result.error && result.data) remoteTickets = result.data;
                }).catch(function(e) { console.log('Supabase tickets fetch skipped:', e.message); })
            );
        }
        
        fetches.push(
            (async function() {
                try {
                    var allLocal = await getAllFromLocal('tickets') || [];
                    localTickets = allLocal.filter(function(t){return t.project_id === currentProject.id});
                } catch(e) { console.log('Local tickets fetch error:', e.message); }
            })()
        );
        
        await Promise.all(fetches);
        
        // Merge and dedupe
        const ticketMap = new Map();
        localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
        
        tickets = Array.from(ticketMap.values());
        tickets.sort((a, b) => new Date(b.created_at || b.service_date) - new Date(a.created_at || a.service_date));
        
        renderRecentTickets();
        updateTicketCount();
        updateStats();
        updateLeedPredictor();
    } catch (err) {
        console.error('Error loading tickets:', err);
        document.getElementById('recentTickets').innerHTML = '<p style="color:var(--red-500)">Error loading tickets</p>';
    }
}

function renderRecentTickets() {
    const container = document.getElementById('recentTickets');
    
    if (tickets.length === 0) {
        container.innerHTML = '<p style="color:var(--slate-400)">No tickets yet for this project</p>';
        updateTicketCount();
        return;
    }
    
    updateTicketCount();
    
    container.innerHTML = tickets.map(t => `
        <div class="ticket-card ticket-card-row" style="border-bottom:1px solid var(--slate-700);padding:10px 0" id="ticket-card-${t.id}" data-searchtext="${(t.ticket_number||'').toLowerCase()} ${(t.service_date||'').toLowerCase()} ${(t.hauler||'').toLowerCase()} ${formatDate(t.service_date).toLowerCase()}">
            <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="cb-${t.id}" onclick="toggleTicketSelect('${t.id}', event)" ${selectedTicketIds.has(t.id) ? 'checked' : ''} style="width:16px;height:16px;cursor:pointer;flex-shrink:0" class="admin-only">
                <div style="flex:1;display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleTicketExpand('${t.id}')">
                    <div>
                        <div style="font-weight:600;display:flex;align-items:center;gap:8px">
                            <span id="ticket-arrow-${t.id}" style="font-size:10px">â–¶</span>
                            #${t.ticket_number || 'N/A'}
                            ${t.human_verified ? '<span style="color:var(--emerald-400);font-size:10px">âœ“ Verified</span>' : ''}
                            ${t.imported ? '<span style="color:var(--blue-400);font-size:9px;background:rgba(59,130,246,0.15);padding:1px 6px;border-radius:4px">Imported</span>' : ''}
                        </div>
                        <div style="font-size:11px;color:var(--slate-400);margin-left:20px">${formatDate(t.service_date)} â€¢ ${(t.net_tons || 0).toFixed(2)} T â€¢ ${t.hauler || 'Unknown hauler'}</div>
                    </div>
                    <div style="text-align:right">
                        <div style="color:${(t.diversion_pct || 0) >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'};font-weight:600">${t.diversion_pct || 0}%</div>
                        <div style="font-size:10px;color:var(--slate-500)">${(t.gross_lbs||0).toLocaleString()} lbs gross</div>
                    </div>
                </div>
                <button onclick="event.stopPropagation();confirmDeleteTicket('${t.id}')" style="background:none;border:none;color:var(--red-500);font-size:16px;cursor:pointer;padding:4px 8px;flex-shrink:0;opacity:0.6" title="Delete ticket" class="admin-only">âœ•</button>
            </div>
            <div id="ticket-expand-${t.id}" class="hidden" style="margin-top:12px;padding:12px;background:var(--slate-800);border-radius:8px;margin-left:24px">
                <!-- Weight Details -->
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;font-size:11px;margin-bottom:12px">
                    <div><span style="color:var(--slate-400)">Gross:</span> ${(t.gross_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Tare:</span> ${(t.tare_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Net:</span> ${(t.net_lbs || 0).toLocaleString()} lbs</div>
                    <div><span style="color:var(--slate-400)">Tons:</span> ${(t.net_tons || 0).toFixed(2)}</div>
                </div>
                
                <!-- Material Breakdown -->
                <div style="font-size:11px;font-weight:600;margin-bottom:6px;color:var(--slate-300)">MATERIALS</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:4px;font-size:11px;margin-bottom:12px">
                    <div>ğŸªµ Wood ${t.wood_pct || 0}%</div>
                    <div>ğŸ§± Concrete ${t.concrete_pct || 0}%</div>
                    <div>ğŸ”© Metal ${t.metal_pct || 0}%</div>
                    <div>ğŸ“¦ OCC ${t.cardboard_pct || 0}%</div>
                    <div>â™»ï¸ Plastic ${t.plastic_pct || 0}%</div>
                    <div>ğŸ—ï¸ Gypsum ${t.drywall_pct || 0}%</div>
                    <div>ğŸ—‘ï¸ Landfill ${t.landfill_pct || 0}%</div>
                    <div style="color:${(t.diversion_pct||0) >= 75 ? 'var(--emerald-400)' : 'var(--amber-400)'}">âœ… Diverted ${t.diversion_pct || 0}%</div>
                </div>
                ${t.import_source ? `<div style="font-size:10px;color:var(--slate-500);margin-bottom:8px">ğŸ“ Imported from: ${t.import_source}</div>` : ''}
                
                <!-- Scale Ticket Photo -->
                ${t.scale_ticket_photo ? `
                <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--accent-info)">ğŸ“„ SCALE TICKET</div>
                <div style="margin-bottom:12px">
                    <img src="${t.scale_ticket_photo}" style="width:100%;max-width:280px;border-radius:6px;cursor:pointer;border:2px solid var(--accent-info)" onclick="viewTicketPhoto('${t.id}', 'st')">
                </div>
                ` : ''}
                
                <!-- Debris Photos -->
                ${(t.debris_photo_1 || t.debris_photo_2 || t.debris_photo_3) ? `
                <div style="font-size:11px;font-weight:600;margin-bottom:8px;color:var(--slate-300)">ğŸ“¸ DEBRIS PHOTOS (${t.photo_count || 0})</div>
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    ${t.debris_photo_1 ? `<img src="${t.debris_photo_1}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="viewTicketPhoto('${t.id}', 1)">` : ''}
                    ${t.debris_photo_2 ? `<img src="${t.debris_photo_2}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="viewTicketPhoto('${t.id}', 2)">` : ''}
                    ${t.debris_photo_3 ? `<img src="${t.debris_photo_3}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="viewTicketPhoto('${t.id}', 3)">` : ''}
                </div>
                ` : ''}
                
                <!-- GPS Info -->
                ${t.gps_latitude ? `
                <div style="font-size:11px;color:var(--slate-400);margin-bottom:12px">
                    ğŸ“ ${t.gps_latitude.toFixed(6)}, ${t.gps_longitude.toFixed(6)}
                </div>
                ` : ''}
                
                <!-- Actions â€” Admin gets full controls, Customer gets View only -->
                <div class="btn-row" style="flex-wrap:wrap">
                    <button class="btn btn-secondary admin-only" onclick="editTicket('${t.id}')" style="flex:1;padding:8px;font-size:11px">âœï¸ Edit</button>
                    <button class="btn btn-secondary" onclick="viewTicketDetails('${t.id}')" style="flex:1;padding:8px;font-size:11px">ğŸ‘ï¸ Full View</button>
                    <button class="btn btn-secondary admin-only" onclick="generateTicketCOD('${t.id}')" style="flex:1;padding:8px;font-size:11px;background:linear-gradient(135deg,#7c3aed,#5b21b6);color:white">ğŸ“œ COD</button>
                    <button class="btn admin-only" onclick="confirmDeleteTicket('${t.id}')" style="background:var(--red-500);color:white;padding:8px;font-size:11px">ğŸ—‘ï¸ Delete</button>
                </div>
            </div>
        </div>
    `).join('');
    
    // Re-apply role visibility for dynamically created admin-only elements
    if (typeof applyRoleVisibility === 'function') applyRoleVisibility();
}

function toggleTicketExpand(ticketId) {
    const content = document.getElementById('ticket-expand-' + ticketId);
    const arrow = document.getElementById('ticket-arrow-' + ticketId);
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        arrow.textContent = 'â–¼';
    } else {
        content.classList.add('hidden');
        arrow.textContent = 'â–¶';
    }
}

function viewTicketPhoto(ticketId, photoNum) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    const photoKey = 'debris_photo_' + photoNum;
    const photoData = ticket[photoKey];
    
    if (photoData) {
        // Open in new window/modal
        const win = window.open('', '_blank', 'width=800,height=600');
        win.document.write(`
            <html>
            <head><title>Ticket #${ticket.ticket_number} - Photo ${photoNum}</title></head>
            <body style="margin:0;background:#000;display:flex;align-items:center;justify-content:center;min-height:100vh">
                <img src="${photoData}" style="max-width:100%;max-height:100vh">
            </body>
            </html>
        `);
    }
}

function viewTicketDetails(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) {
        toast('Ticket not found', 'error');
        return;
    }
    
    // Build photo gallery HTML
    let photosHtml = '<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px">No photos available</div>';
    const hasPhotos = ticket.debris_photo_1 || ticket.debris_photo_2 || ticket.debris_photo_3 || ticket.scale_ticket_photo;
    
    if (hasPhotos) {
        // Store photos in reference map for safe viewer access
        _photoViewerData = {};
        
        photosHtml = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">';
        
        if (ticket.scale_ticket_photo) {
            _photoViewerData['st_' + ticketId] = ticket.scale_ticket_photo;
            photosHtml += `
                <div style="grid-column:span 2">
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">ğŸ“‹ Scale Ticket</div>
                    <img src="${ticket.scale_ticket_photo}" style="width:100%;border-radius:8px;cursor:pointer;border:2px solid var(--accent-info)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Scale Ticket', 'st_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_1) {
            _photoViewerData['dp1_' + ticketId] = ticket.debris_photo_1;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">ğŸ“¸ Debris Photo 1</div>
                    <img src="${ticket.debris_photo_1}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 1', 'dp1_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_2) {
            _photoViewerData['dp2_' + ticketId] = ticket.debris_photo_2;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">ğŸ“¸ Debris Photo 2</div>
                    <img src="${ticket.debris_photo_2}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 2', 'dp2_${ticketId}')">
                </div>
            `;
        }
        
        if (ticket.debris_photo_3) {
            _photoViewerData['dp3_' + ticketId] = ticket.debris_photo_3;
            photosHtml += `
                <div>
                    <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px">ğŸ“¸ Debris Photo 3</div>
                    <img src="${ticket.debris_photo_3}" style="width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer('${ticket.ticket_number}', 'Debris Photo 3', 'dp3_${ticketId}')">
                </div>
            `;
        }
        
        photosHtml += '</div>';
    }
    
    // Build material breakdown
    const materials = [
        { name: 'Wood', pct: ticket.wood_pct || 0, tons: ticket.wood_tons || 0, color: '#8B4513' },
        { name: 'Metal', pct: ticket.metal_pct || 0, tons: ticket.metal_tons || 0, color: '#708090' },
        { name: 'Cardboard', pct: ticket.cardboard_pct || 0, tons: ticket.cardboard_tons || 0, color: '#DEB887' },
        { name: 'Concrete', pct: ticket.concrete_pct || 0, tons: ticket.concrete_tons || 0, color: '#A9A9A9' },
        { name: 'Plastic', pct: ticket.plastic_pct || 0, tons: ticket.plastic_tons || 0, color: '#4169E1' },
        { name: 'Drywall', pct: ticket.drywall_pct || 0, tons: ticket.drywall_tons || 0, color: '#F5F5DC' },
        { name: 'Landfill', pct: ticket.landfill_pct || 0, tons: ticket.landfill_tons || 0, color: '#2F4F4F' }
    ].filter(m => m.pct > 0);
    
    let materialsHtml = materials.map(m => `
        <div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border-color)">
            <div style="width:12px;height:12px;border-radius:2px;background:${m.color}"></div>
            <div style="flex:1;font-size:12px">${m.name}</div>
            <div style="font-size:12px;font-weight:600">${m.pct}%</div>
            <div style="font-size:11px;color:var(--text-muted);width:60px;text-align:right">${m.tons.toFixed(2)} tons</div>
        </div>
    `).join('');
    
    // Diversion status
    const diversionPct = ticket.diversion_pct || 0;
    var diversionColor, diversionStatus;
    
    // Unprocessed customer uploads should NOT show "Needs Improvement"
    if (ticket.submitted_by === 'customer' && !ticket.human_verified && ticket.net_tons === 0) {
        diversionColor = 'var(--amber-400)';
        diversionStatus = 'â³ Awaiting Dalmex Review';
    } else if (diversionPct >= 75) {
        diversionColor = 'var(--accent-primary)';
        diversionStatus = 'âœ… LEED Compliant';
    } else if (diversionPct >= 50) {
        diversionColor = 'var(--accent-warning)';
        diversionStatus = 'âš ï¸ Below Target';
    } else {
        diversionColor = 'var(--accent-danger)';
        diversionStatus = 'âŒ Needs Improvement';
    }
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'ticketDetailModal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
    
    modal.innerHTML = `
        <div style="background:var(--bg-secondary);border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;position:relative">
            <!-- Header -->
            <div style="background:linear-gradient(135deg, var(--accent-primary), var(--accent-info));padding:20px;border-radius:16px 16px 0 0;position:sticky;top:0;z-index:1">
                <button onclick="document.getElementById('ticketDetailModal').remove()" style="position:absolute;top:12px;right:12px;background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">Ã—</button>
                <div style="font-size:12px;color:rgba(255,255,255,0.8)">SCALE TICKET</div>
                <div style="font-size:24px;font-weight:700;color:white">#${ticket.ticket_number}</div>
                <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:4px">${new Date(ticket.service_date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
            </div>
            
            <!-- Content -->
            <div style="padding:20px">
                <!-- Quick Stats -->
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:var(--text-primary)">${(ticket.net_tons || 0).toFixed(2)}</div>
                        <div style="font-size:10px;color:var(--text-muted)">NET TONS</div>
                    </div>
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:${diversionColor}">${diversionPct}%</div>
                        <div style="font-size:10px;color:var(--text-muted)">DIVERTED</div>
                    </div>
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;text-align:center">
                        <div style="font-size:20px;font-weight:700;color:var(--accent-primary)">${((ticket.diverted_tons || 0)).toFixed(2)}</div>
                        <div style="font-size:10px;color:var(--text-muted)">DIVERTED TONS</div>
                    </div>
                </div>
                
                <!-- Status Banner -->
                <div style="background:${diversionColor}20;border:1px solid ${diversionColor};border-radius:8px;padding:12px;margin-bottom:20px;text-align:center">
                    <span style="font-size:14px;font-weight:600;color:${diversionColor}">${diversionStatus}</span>
                </div>
                
                <!-- Details Grid -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">HAULER</div>
                        <div style="font-size:13px;font-weight:500">${ticket.hauler || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">IMPORT SOURCE</div>
                        <div style="font-size:13px;font-weight:500">${ticket.import_source || 'Manual Entry'}</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">GROSS WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.gross_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">TARE WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.tare_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">NET WEIGHT</div>
                        <div style="font-size:13px;font-weight:500">${(ticket.net_lbs || 0).toLocaleString()} lbs</div>
                    </div>
                    <div>
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">VERIFIED</div>
                        <div style="font-size:13px;font-weight:500">${ticket.human_verified ? 'âœ… Yes' : 'âŒ No'}</div>
                    </div>
                </div>
                
                <!-- GPS if available -->
                ${ticket.gps_latitude && ticket.gps_longitude ? `
                    <div style="background:var(--bg-tertiary);padding:12px;border-radius:8px;margin-bottom:20px">
                        <div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">ğŸ“ GPS COORDINATES</div>
                        <div style="font-size:12px;font-family:monospace">${ticket.gps_latitude}, ${ticket.gps_longitude}</div>
                        <a href="https://maps.google.com/?q=${ticket.gps_latitude},${ticket.gps_longitude}" target="_blank" style="font-size:11px;color:var(--accent-info)">View on Google Maps â†’</a>
                    </div>
                ` : ''}
                
                <!-- Material Breakdown -->
                <div style="margin-bottom:20px">
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">MATERIAL BREAKDOWN</div>
                    ${materialsHtml || '<div style="color:var(--text-muted);font-size:12px">No material data available</div>'}
                </div>
                
                <!-- Photos Section -->
                <div>
                    <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">ğŸ“· DOCUMENTATION</div>
                    ${photosHtml}
                </div>
                
                ${ticket.customer_notes ? '<div style="margin-top:16px;padding:12px;background:var(--bg-tertiary);border-radius:8px"><div style="font-size:10px;color:var(--text-muted);margin-bottom:4px">ğŸ“ CUSTOMER NOTES</div><div style="font-size:12px;color:var(--text-primary)">' + ticket.customer_notes + '</div></div>' : ''}
            </div>
            
            <!-- Footer -->
            <div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px" id="ticketDetailFooter">
                <button class="btn btn-secondary" onclick="document.getElementById('ticketDetailModal').remove()" style="flex:1">Close</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add edit/print buttons based on role
    var footer = document.getElementById('ticketDetailFooter');
    if (userRole === 'admin') {
        footer.insertAdjacentHTML('beforeend', '<button class="btn btn-secondary" onclick="editTicket(\'' + ticketId + '\')" style="flex:1">âœï¸ Edit</button>');
        footer.insertAdjacentHTML('beforeend', '<button class="btn btn-primary" onclick="printTicketDetail(\'' + ticketId + '\')" style="flex:1">ğŸ–¨ï¸ Print</button>');
    } else if (!ticket.human_verified && (ticket.submitted_by === 'customer' || ticket.submitted_by === 'operator')) {
        footer.insertAdjacentHTML('beforeend', '<button class="btn btn-secondary" onclick="customerEditUpload(\'' + ticketId + '\')" style="flex:1">âœï¸ Edit Upload</button>');
    }
}

// Global photo reference for viewer (avoids base64 in onclick attributes)
let _photoViewerData = {};

function openPhotoViewer(ticketNum, photoName, photoKey) {
    const photoData = _photoViewerData[photoKey] || photoKey;
    
    const viewer = document.createElement('div');
    viewer.id = 'photoViewerModal';
    viewer.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:10001;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px';
    viewer.onclick = (e) => { if (e.target === viewer) viewer.remove(); };
    
    const title = document.createElement('div');
    title.style.cssText = 'color:white;font-size:14px;margin-bottom:12px';
    title.textContent = `Ticket #${ticketNum} - ${photoName}`;
    
    const img = document.createElement('img');
    img.src = photoData;
    img.style.cssText = 'max-width:90%;max-height:80vh;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5)';
    
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.style.cssText = 'margin-top:16px;background:white;color:black;border:none;padding:10px 24px;border-radius:8px;font-size:14px;cursor:pointer';
    closeBtn.onclick = () => viewer.remove();
    
    viewer.appendChild(title);
    viewer.appendChild(img);
    viewer.appendChild(closeBtn);
    
    document.body.appendChild(viewer);
}

function printTicketDetail(ticketId) {
    const ticket = tickets.find(t => t.id === ticketId);
    if (!ticket) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Ticket #${ticket.ticket_number}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { color: #059669; }
                .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                .label { color: #666; font-size: 12px; }
                .value { font-weight: bold; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background: #f5f5f5; }
            </style>

```
    </head>
    <body>
        <h1>Scale Ticket #${ticket.ticket_number}</h1>
        <p><strong>Date:</strong> ${ticket.service_date}</p>
        <p><strong>Hauler:</strong> ${ticket.hauler || 'N/A'}</p>
        <p><strong>Net Tons:</strong> ${(ticket.net_tons || 0).toFixed(2)}</p>
        <p><strong>Diversion Rate:</strong> ${ticket.diversion_pct || 0}%</p>
        <p><strong>Human Verified:</strong> ${ticket.human_verified ? 'Yes' : 'No'}</p>
        <hr>
        <p style="font-size:11px;color:#666">Generated by DivertScanâ„¢ - ${new Date().toLocaleString()}</p>
    </body>
    </html>
`);
printWindow.document.close();
printWindow.print();
```

}

function editTicket(ticketId) {
const ticket = tickets.find(t => t.id === ticketId);
if (!ticket) {
toast(â€˜Ticket not foundâ€™, â€˜errorâ€™);
return;
}

```
// Close detail modal if open
const detailModal = document.getElementById('ticketDetailModal');
if (detailModal) detailModal.remove();

// Build photo section
var photoHtml = '';
if (ticket.scale_ticket_photo || ticket.debris_photo_1 || ticket.debris_photo_2 || ticket.debris_photo_3) {
    photoHtml = '<div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">UPLOADED PHOTOS</div><div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;overflow-x:auto">';
    if (ticket.scale_ticket_photo) {
        _photoViewerData['edit_st_' + ticketId] = ticket.scale_ticket_photo;
        photoHtml += '<div style="text-align:center;flex-shrink:0"><img src="' + ticket.scale_ticket_photo + '" style="width:100px;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-info)" onclick="openPhotoViewer(\'' + (ticket.ticket_number || '') + '\', \'Scale Ticket\', \'edit_st_' + ticketId + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Scale Ticket</div></div>';
    }
    if (ticket.debris_photo_1) {
        _photoViewerData['edit_dp1_' + ticketId] = ticket.debris_photo_1;
        photoHtml += '<div style="text-align:center;flex-shrink:0"><img src="' + ticket.debris_photo_1 + '" style="width:70px;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (ticket.ticket_number || '') + '\', \'Debris 1\', \'edit_dp1_' + ticketId + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 1</div></div>';
    }
    if (ticket.debris_photo_2) {
        _photoViewerData['edit_dp2_' + ticketId] = ticket.debris_photo_2;
        photoHtml += '<div style="text-align:center;flex-shrink:0"><img src="' + ticket.debris_photo_2 + '" style="width:70px;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (ticket.ticket_number || '') + '\', \'Debris 2\', \'edit_dp2_' + ticketId + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 2</div></div>';
    }
    if (ticket.debris_photo_3) {
        _photoViewerData['edit_dp3_' + ticketId] = ticket.debris_photo_3;
        photoHtml += '<div style="text-align:center;flex-shrink:0"><img src="' + ticket.debris_photo_3 + '" style="width:70px;height:70px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (ticket.ticket_number || '') + '\', \'Debris 3\', \'edit_dp3_' + ticketId + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 3</div></div>';
    }
    photoHtml += '</div>';
}

// Customer upload banner
var customerBanner = '';
if (ticket.submitted_by === 'customer') {
    customerBanner = '<div style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.1));border:1px solid var(--amber-400);border-radius:8px;padding:10px;margin-bottom:16px">' +
        '<div style="font-size:12px;font-weight:600;color:var(--amber-400)">â³ Customer Upload â€” Pending Review</div>' +
        (ticket.customer_notes ? '<div style="font-size:11px;color:var(--slate-300);margin-top:6px;padding:6px;background:var(--slate-800);border-radius:4px">ğŸ“ Customer notes: ' + ticket.customer_notes + '</div>' : '') +
        '</div>';
}

// AI button â€” show if there are any photos to analyze
var aiButtonHtml = '';
if (ticket.scale_ticket_photo || ticket.debris_photo_1 || ticket.debris_photo_2 || ticket.debris_photo_3) {
    aiButtonHtml = '<button class="btn btn-primary" onclick="runAIonEditTicket(\'' + ticketId + '\')" style="width:100%;margin-bottom:16px;padding:12px;background:linear-gradient(135deg,#7c3aed,#5b21b6)">ğŸ¤– Run AI â€” OCR Scale Ticket + Analyze Debris</button>';
}

const modal = document.createElement('div');
modal.id = 'editTicketModal';
modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

modal.innerHTML = `
    <div style="background:var(--bg-secondary);border-radius:16px;max-width:550px;width:100%;max-height:90vh;overflow-y:auto">
        <div style="background:linear-gradient(135deg, var(--accent-warning), #b45309);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">
            <div>
                <div style="font-size:11px;color:rgba(255,255,255,0.7)">${ticket.submitted_by === 'customer' ? 'CUSTOMER UPLOAD â€” REVIEW' : 'EDIT TICKET'}</div>
                <div style="font-size:20px;font-weight:700;color:white">#${ticket.ticket_number}</div>
            </div>
            <button onclick="document.getElementById('editTicketModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">Ã—</button>
        </div>
        
        <div style="padding:20px">
            ${customerBanner}
            ${photoHtml}
            ${aiButtonHtml}
            <div id="editAIResult" class="hidden" style="margin-bottom:16px;padding:12px;background:var(--slate-800);border-radius:8px;border:1px solid var(--emerald-500)"></div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Ticket #</label>
                    <input type="text" id="editTicketNum" class="form-input" value="${ticket.ticket_number || ''}">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Service Date</label>
                    <input type="date" id="editServiceDate" class="form-input" value="${ticket.service_date || ''}">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Hauler</label>
                    <input type="text" id="editHauler" class="form-input" value="${ticket.hauler || ''}">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Container Size</label>
                    <select id="editContainerSize" class="form-input">
                        <option value="20" ${ticket.container_size == 20 ? 'selected' : ''}>20 yd</option>
                        <option value="30" ${ticket.container_size == 30 ? 'selected' : ''}>30 yd</option>
                        <option value="40" ${ticket.container_size == 40 ? 'selected' : ''}>40 yd</option>
                    </select>
                </div>
            </div>
            
            <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">WEIGHTS (lbs)</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Gross</label>
                    <input type="number" id="editGrossLbs" class="form-input" value="${ticket.gross_lbs || 0}">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label">Tare</label>
                    <input type="number" id="editTareLbs" class="form-input" value="${ticket.tare_lbs || 0}">
                </div>
            </div>
            
            <div style="font-size:12px;font-weight:600;margin-bottom:8px;color:var(--text-secondary)">MATERIAL PERCENTAGES (must total 100%)</div>
            <div id="editMaterialsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">ğŸªµ Wood %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="wood" value="${ticket.wood_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">ğŸª¨ Concrete %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="concrete" value="${ticket.concrete_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">ğŸ”© Metal %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="metal" value="${ticket.metal_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">ğŸ“¦ Cardboard %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="cardboard" value="${ticket.cardboard_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">â™»ï¸ Plastic %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="plastic" value="${ticket.plastic_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0">
                    <label class="form-label" style="font-size:10px">ğŸ—ï¸ Drywall %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="drywall" value="${ticket.drywall_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
                <div class="form-group" style="margin-bottom:0;grid-column:span 2">
                    <label class="form-label" style="font-size:10px">ğŸ—‘ï¸ Landfill %</label>
                    <input type="number" class="form-input edit-mat-input" data-mat="landfill" value="${ticket.landfill_pct || 0}" min="0" max="100" onchange="updateEditTotal()">
                </div>
            </div>
            <div style="text-align:center;margin-bottom:16px">
                <span style="font-size:13px">Total: </span>
                <span id="editMaterialsTotal" style="font-size:14px;font-weight:700;color:var(--emerald-400)">100%</span>
            </div>
        </div>
        
        <div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="document.getElementById('editTicketModal').remove()" style="flex:1">Cancel</button>
            <button class="btn btn-primary" onclick="saveEditedTicket('${ticketId}')" style="flex:1">ğŸ’¾ Save Changes</button>
        </div>
    </div>
`;

document.body.appendChild(modal);
updateEditTotal();
```

}

function updateEditTotal() {
const inputs = document.querySelectorAll(â€™.edit-mat-inputâ€™);
let total = 0;
inputs.forEach(inp => total += parseInt(inp.value) || 0);
const el = document.getElementById(â€˜editMaterialsTotalâ€™);
if (el) {
el.textContent = total + â€˜%â€™;
el.style.color = total === 100 ? â€˜var(â€“emerald-400)â€™ : â€˜var(â€“red-500)â€™;
}
}

// Run AI analysis on photos from within the edit ticket modal
async function runAIonEditTicket(ticketId) {
var ticket = tickets.find(function(t) { return t.id === ticketId; });
if (!ticket) { toast(â€˜Ticket not foundâ€™, â€˜errorâ€™); return; }

```
var apiKey = localStorage.getItem('divertscan_openai');
if (!apiKey || apiKey.length < 10) {
    toast('Add Anthropic API key in Settings first', 'error');
    return;
}

var resultDiv = document.getElementById('editAIResult');
resultDiv.classList.remove('hidden');

// Step 1: OCR the scale ticket if available
if (ticket.scale_ticket_photo) {
    resultDiv.innerHTML = '<div style="text-align:center;color:var(--slate-400)">ğŸ“„ Reading scale ticket with Claude AI...</div>';
    
    try {
        var stMediaType = ticket.scale_ticket_photo.split(';')[0].split(':')[1] || 'image/jpeg';
        var stBase64 = ticket.scale_ticket_photo.split(',')[1];
        
        var ocrResponse = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-haiku-4-5-20251001',
                max_tokens: 768,
                messages: [{
                    role: 'user',
                    content: [
                        { type: 'image', source: { type: 'base64', media_type: stMediaType, data: stBase64 } },
                        { type: 'text', text: 'You are reading a construction/demolition scale ticket. Read EVERY field carefully.\n\nReturn ONLY JSON:\n{"ticket_number":"string","date":"MM/DD/YYYY","gross_lbs":number,"tare_lbs":number,"net_lbs":number,"hauler":"string","vehicle_id":"string or null"}\n\nRULES:\n- Read actual numbers â€” do NOT estimate or round\n- Net = Gross minus Tare. If not printed, calculate it\n- Use null for truly unreadable fields' }
                    ]
                }]
            })
        });
        
        var ocrData = await ocrResponse.json();
        if (ocrData.content && ocrData.content[0]) {
            var ocrText = ocrData.content[0].text.replace(/```json/gi, '').replace(/```/g, '').trim();
            var ocrMatch = ocrText.match(/\{[\s\S]*\}/);
            if (ocrMatch) {
                var ocrResult = JSON.parse(ocrMatch[0]);
                
                // Auto-fill the edit form with OCR data
                if (ocrResult.ticket_number) document.getElementById('editTicketNum').value = ocrResult.ticket_number;
                if (ocrResult.hauler) document.getElementById('editHauler').value = ocrResult.hauler;
                if (ocrResult.gross_lbs) document.getElementById('editGrossLbs').value = ocrResult.gross_lbs;
                if (ocrResult.tare_lbs) document.getElementById('editTareLbs').value = ocrResult.tare_lbs;
                if (ocrResult.date) {
                    var d = new Date(ocrResult.date);
                    if (!isNaN(d)) document.getElementById('editServiceDate').value = d.toISOString().split('T')[0];
                }
                
                resultDiv.innerHTML = '<div style="color:var(--emerald-400);font-weight:600;margin-bottom:4px">ğŸ“„ Scale Ticket OCR Complete</div>' +
                    '<div style="font-size:11px;color:var(--slate-300)">Ticket #' + (ocrResult.ticket_number || '?') + ' â€¢ Gross: ' + (ocrResult.gross_lbs || 0).toLocaleString() + ' lbs â€¢ Tare: ' + (ocrResult.tare_lbs || 0).toLocaleString() + ' lbs â€¢ Net: ' + (ocrResult.net_lbs || 0).toLocaleString() + ' lbs</div>';
                
                toast('âœ… Scale ticket read â€” weights auto-filled', 'success');
            }
        }
    } catch(err) {
        console.error('OCR error:', err);
        resultDiv.innerHTML = '<div style="color:var(--amber-400)">âš ï¸ Could not read scale ticket: ' + err.message + '</div>';
    }
}

// Step 2: Analyze debris photos for material percentages
var photos = [];
if (ticket.debris_photo_1) photos.push(ticket.debris_photo_1);
if (ticket.debris_photo_2) photos.push(ticket.debris_photo_2);
if (ticket.debris_photo_3) photos.push(ticket.debris_photo_3);

if (photos.length > 0) {
    var prevHtml = resultDiv.innerHTML;
    resultDiv.innerHTML = prevHtml + '<div style="text-align:center;color:var(--slate-400);margin-top:8px">ğŸ¤– Analyzing ' + photos.length + ' debris photo(s)...</div>';
    
    try {
        var content = [];
        photos.forEach(function(photo) {
            var mediaType = photo.split(';')[0].split(':')[1] || 'image/jpeg';
            var base64 = photo.split(',')[1];
            content.push({ type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } });
        });
        content.push({
            type: 'text',
            text: 'C&D waste auditor at Dalmex Recycling, Dallas TX. Estimate material composition percentages from these debris photos.\n\nRULES: Only count CLEAN SORTABLE materials as recyclable. Broken/contaminated wood = landfill. Mixed tangled debris = landfill. Landfill usually 25%+. Total must equal 100. Err toward MORE landfill.\n\nIMPORTANT: Return ONLY a flat JSON object with these exact keys, nothing else:\n{"wood":0,"concrete":0,"metal":0,"cardboard":0,"plastic":0,"drywall":0,"landfill":0}\n\nDo NOT nest inside another object. Do NOT add extra keys. Just the 7 material numbers that total 100.'
        });
        
        var response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-haiku-4-5-20251001',
                max_tokens: 512,
                messages: [{ role: 'user', content: content }]
            })
        });
        
        var data = await response.json();
        
        // Check for API errors first
        if (data.error) {
            console.error('Debris API error:', data.error);
            resultDiv.innerHTML += '<div style="color:var(--red-400);margin-top:4px">âŒ API error: ' + (data.error.message || JSON.stringify(data.error)) + '</div>';
            return;
        }
        
        var text = '';
        if (data.content && data.content.length > 0) {
            for (var ci = 0; ci < data.content.length; ci++) {
                if (data.content[ci].text) text += data.content[ci].text;
            }
        }
        text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
        console.log('Debris AI raw response:', text.substring(0, 500));
        console.log('Debris AI full data:', JSON.stringify(data).substring(0, 500));
        
        if (!text) {
            // No text response â€” show what we got
            var stopReason = data.stop_reason || (data.content && data.content[0] && data.content[0].stop_reason) || 'unknown';
            resultDiv.innerHTML += '<div style="color:var(--amber-400);margin-top:4px">âš ï¸ AI returned no text. Stop: ' + stopReason + '. Model: ' + (data.model || '?') + '</div>';
            if (data.error) resultDiv.innerHTML += '<div style="color:var(--red-400);font-size:10px">' + JSON.stringify(data.error) + '</div>';
            return;
        }
        
        // Parse JSON â€” handle both flat and nested responses
        var pcts = null;
        try {
            var parsed = JSON.parse(text.match(/\{[\s\S]*\}/)[0]);
            // If it has a materials sub-object, use that
            if (parsed.materials && typeof parsed.materials === 'object') {
                pcts = parsed.materials;
            } else if (parsed.wood !== undefined || parsed.landfill !== undefined) {
                pcts = parsed;
            }
        } catch(pe) {
            // Try to extract just the material numbers with individual regex
            var woodM = text.match(/"wood"\s*:\s*(\d+)/);
            var concreteM = text.match(/"concrete"\s*:\s*(\d+)/);
            var metalM = text.match(/"metal"\s*:\s*(\d+)/);
            var cardboardM = text.match(/"cardboard"\s*:\s*(\d+)/);
            var plasticM = text.match(/"plastic"\s*:\s*(\d+)/);
            var drywallM = text.match(/"drywall"\s*:\s*(\d+)/);
            var landfillM = text.match(/"landfill"\s*:\s*(\d+)/);
            if (landfillM) {
                pcts = {
                    wood: woodM ? parseInt(woodM[1]) : 0,
                    concrete: concreteM ? parseInt(concreteM[1]) : 0,
                    metal: metalM ? parseInt(metalM[1]) : 0,
                    cardboard: cardboardM ? parseInt(cardboardM[1]) : 0,
                    plastic: plasticM ? parseInt(plasticM[1]) : 0,
                    drywall: drywallM ? parseInt(drywallM[1]) : 0,
                    landfill: parseInt(landfillM[1])
                };
            }
        }
        
        if (pcts) {
            
            document.querySelectorAll('.edit-mat-input').forEach(function(inp) {
                var mat = inp.getAttribute('data-mat');
                if (pcts[mat] !== undefined) inp.value = pcts[mat];
            });
            updateEditTotal();
            
            resultDiv.innerHTML = '<div style="color:var(--emerald-400);font-weight:600;margin-bottom:4px">ğŸ¤– Full AI Analysis Complete</div>' +
                '<div style="font-size:11px;color:var(--slate-300)">Scale ticket OCR + debris material percentages auto-filled. Review and adjust, then Save.</div>';
            
            toast('âœ… AI analysis complete â€” review all fields', 'success');
        } else {
            resultDiv.innerHTML += '<div style="color:var(--amber-400);margin-top:4px">âš ï¸ Could not parse debris analysis. Raw: ' + (text || '(empty)').substring(0, 200) + '</div>';
        }
    } catch(err) {
        resultDiv.innerHTML += '<div style="color:var(--red-400);margin-top:4px">âŒ Debris analysis error: ' + err.message + '</div>';
    }
} else if (!ticket.scale_ticket_photo) {
    resultDiv.innerHTML = '<div style="color:var(--red-400)">No photos available to analyze</div>';
}
```

}

// Filter ticket list to show only pending customer uploads
function filterPendingReviews() {
var pendingTickets = tickets.filter(function(t) { return t.submitted_by === â€˜customerâ€™ && !t.human_verified; });
if (pendingTickets.length === 0) {
toast(â€˜No pending uploadsâ€™, â€˜infoâ€™);
return;
}
// Open the first pending ticket directly into review mode
quickReviewTicket(pendingTickets[0].id);
}

// One-tap review: opens edit modal and auto-runs AI
function quickReviewTicket(ticketId) {
editTicket(ticketId);
// Auto-trigger AI after a short delay to let the modal render
setTimeout(function() {
runAIonEditTicket(ticketId);
}, 500);
}

async function saveEditedTicket(ticketId) {
// Validate materials total
const inputs = document.querySelectorAll(â€™.edit-mat-inputâ€™);
let matTotal = 0;
const mats = {};
inputs.forEach(inp => {
const val = parseInt(inp.value) || 0;
mats[inp.dataset.mat] = val;
matTotal += val;
});

```
if (matTotal < 99 || matTotal > 101) {
    toast('Materials must total 100% (currently ' + matTotal + '%)', 'error');
    return;
}

const grossLbs = parseFloat(document.getElementById('editGrossLbs').value) || 0;
const tareLbs = parseFloat(document.getElementById('editTareLbs').value) || 0;
const netLbs = grossLbs - tareLbs;
const netTons = netLbs / 2000;

if (grossLbs <= tareLbs) {
    toast('Gross weight must be greater than tare weight', 'error');
    return;
}

const updates = {
    ticket_number: document.getElementById('editTicketNum').value.trim(),
    service_date: document.getElementById('editServiceDate').value,
    hauler: document.getElementById('editHauler').value.trim(),
    container_size: parseInt(document.getElementById('editContainerSize').value) || 30,
    gross_lbs: grossLbs,
    tare_lbs: tareLbs,
    net_lbs: netLbs,
    net_tons: netTons,
    wood_pct: mats.wood || 0,
    concrete_pct: mats.concrete || 0,
    metal_pct: mats.metal || 0,
    cardboard_pct: mats.cardboard || 0,
    plastic_pct: mats.plastic || 0,
    drywall_pct: mats.drywall || 0,
    landfill_pct: mats.landfill || 0,
    wood_tons: ((mats.wood || 0) / 100) * netTons,
    concrete_tons: ((mats.concrete || 0) / 100) * netTons,
    metal_tons: ((mats.metal || 0) / 100) * netTons,
    cardboard_tons: ((mats.cardboard || 0) / 100) * netTons,
    plastic_tons: ((mats.plastic || 0) / 100) * netTons,
    drywall_tons: ((mats.drywall || 0) / 100) * netTons,
    landfill_tons: ((mats.landfill || 0) / 100) * netTons,
    diversion_pct: 100 - (mats.landfill || 0),
    diverted_tons: netTons * ((100 - (mats.landfill || 0)) / 100),
    human_verified: true,
    is_closed: true,
    updated_at: new Date().toISOString()
};

showLoading('Saving changes...');

try {
    // Update in Supabase
    if (sb) {
        try {
            const { error } = await sb.from('tickets').update(updates).eq('id', ticketId);
            if (error) throw error;
        } catch (e) {
            console.log('Supabase update skipped:', e.message);
        }
    }
    
    // Update local
    const ticketIdx = tickets.findIndex(t => t.id === ticketId);
    if (ticketIdx >= 0) {
        Object.assign(tickets[ticketIdx], updates);
    }
    
    // Update IndexedDB
    try {
        const localTicket = await getFromLocal('tickets', ticketId);
        if (localTicket) {
            Object.assign(localTicket, updates);
            await saveToLocal('tickets', localTicket);
        }
    } catch (e) {}
    
    hideLoading();
    document.getElementById('editTicketModal').remove();
    renderRecentTickets();
    updateStats();
    toast('âœ… Ticket updated!', 'success');
} catch (err) {
    hideLoading();
    toast('Error: ' + err.message, 'error');
}
```

}

function confirmDeleteTicket(ticketId) {
const ticket = tickets.find(t => t.id === ticketId);
if (confirm(`Delete ticket #${ticket?.ticket_number}? This cannot be undone.`)) {
deleteTicket(ticketId);
}
}

async function deleteTicket(ticketId) {
try {
showLoading(â€˜Deletingâ€¦â€™);
// Delete from Supabase if connected
if (sb) {
try {
await sb.from(â€˜ticketsâ€™).delete().eq(â€˜idâ€™, ticketId);
} catch (e) { console.log(â€˜Supabase delete skipped:â€™, e.message); }
}
// Also delete from local IndexedDB
try {
await deleteFromLocal(â€˜ticketsâ€™, ticketId);
} catch (e) { console.log(â€˜Local delete skipped:â€™, e.message); }

```
    hideLoading();
    
    tickets = tickets.filter(t => t.id !== ticketId);
    selectedTicketIds.delete(ticketId);
    renderRecentTickets();
    updateStats();
    updateTicketCount();
    updateBulkActionsBar();
    toast('Ticket deleted', 'success');
} catch (err) {
    hideLoading();
    toast('Error: ' + err.message, 'error');
}
```

}

async function updateStats() {
if (!currentProject) {
document.getElementById(â€˜statTotalTonsâ€™).textContent = â€˜0.00â€™;
document.getElementById(â€˜statDiversionRateâ€™).textContent = â€˜0%â€™;
return;
}

```
try {
    // USE the global tickets array (same data source as the ticket list)
    // This ensures stats ALWAYS match what the user sees in Ticket Data
    var data = tickets.filter(function(t) { return t.project_id === currentProject.id; });
    
    if (data.length > 0) {
        const totalTons = data.reduce((sum, t) => sum + (t.net_tons || 0), 0);
        const totalLandfill = data.reduce((sum, t) => sum + (t.landfill_tons || 0), 0);
        const diversionRate = totalTons > 0 ? Math.round(((totalTons - totalLandfill) / totalTons) * 100) : 0;
        
        document.getElementById('statTotalTons').textContent = totalTons.toFixed(2);
        document.getElementById('statDiversionRate').textContent = diversionRate + '%';
    } else {
        // No tickets for this project â€” reset to zero
        document.getElementById('statTotalTons').textContent = '0.00';
        document.getElementById('statDiversionRate').textContent = '0%';
    }
    
    // Update charts and predictor
    updateCharts();
    updateLeedPredictor();
    
    // Check for pending customer uploads (admin only)
    if (userRole === 'admin' && sb && currentProject) {
        try {
            var pending = data.filter(function(t) { return t.submitted_by === 'customer' && !t.human_verified; });
            var badge = document.getElementById('pendingReviewBadge');
            if (pending.length > 0) {
                if (!badge) {
                    var container = document.getElementById('recentTickets');
                    if (container) {
                        var alertHtml = '<div id="pendingReviewBadge" style="margin-bottom:12px;padding:14px;border-radius:10px;background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.1));border:1px solid var(--amber-400);cursor:pointer" onclick="filterPendingReviews()">' +
                            '<div style="display:flex;align-items:center;gap:10px">' +
                            '<span style="font-size:24px">ğŸ¤–</span>' +
                            '<div style="flex:1"><div style="font-weight:600;color:var(--amber-400);font-size:14px">' + pending.length + ' Customer Upload' + (pending.length > 1 ? 's' : '') + ' Ready for Review</div>' +
                            '<div style="font-size:11px;color:var(--slate-400)">Tap to auto-scan with AI â€” reads scale ticket + analyzes debris</div></div>' +
                            '<div style="background:var(--emerald-500);color:white;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;white-space:nowrap">Review â†’</div>' +
                            '</div></div>';
                        container.insertAdjacentHTML('beforebegin', alertHtml);
                    }
                } else {
                    badge.querySelector('div div div').textContent = pending.length + ' Customer Upload' + (pending.length > 1 ? 's' : '') + ' Pending Review';
                }
            } else if (badge) {
                badge.remove();
            }
        } catch(e) { console.log('Pending check:', e.message); }
    }
    
} catch (err) {
    console.error('Error updating stats:', err);
}
```

}

function formatDate(dateStr) {
if (!dateStr) return â€˜N/Aâ€™;
const d = new Date(dateStr);
return d.toLocaleDateString(â€˜en-USâ€™, { month: â€˜longâ€™, day: â€˜numericâ€™, year: â€˜numericâ€™ });
}

// ========== GPS CAPTURE FOR AUDIT TRAIL ==========
function captureGPS() {
if (â€˜geolocationâ€™ in navigator) {
navigator.geolocation.getCurrentPosition(
(position) => {
ticketData.gpsLatitude = position.coords.latitude;
ticketData.gpsLongitude = position.coords.longitude;
ticketData.gpsAccuracy = position.coords.accuracy;
console.log(â€˜GPS captured:â€™, ticketData.gpsLatitude, ticketData.gpsLongitude, â€˜Â±â€™ + ticketData.gpsAccuracy + â€˜mâ€™);
},
(error) => {
console.log(â€˜GPS not available:â€™, error.message);
},
{ enableHighAccuracy: true, timeout: 10000 }
);
}
}

// ========== TICKET MODAL ==========
function startNewTicket() {
if (!currentProject) {
toast(â€˜Please select a project firstâ€™, â€˜errorâ€™);
showProjectPicker();
return;
}

```
console.log('Starting new ticket');
currentStep = 1;
ticketData = {
    projectId: currentProject.id,
    ticketNumber: '',
    serviceDate: new Date().toISOString().split('T')[0],
    grossLbs: 0,
    tareLbs: 0,
    netTons: 0,
    hauler: currentProject.waste_hauler || '',
    containerSize: 30,
    photos: [],
    materials: { wood: 20, concrete: 15, metal: 10, cardboard: 20, plastic: 5, drywall: 10, landfill: 20 },
    diversionRate: 0,
    humanVerified: false,
    signature: null,
    scaleTicketPhoto: null,
    gpsLatitude: null,
    gpsLongitude: null,
    gpsAccuracy: null,
    captureTimestamp: new Date().toISOString(),
    signedBy: ''
};
debrisPhotos = [null, null, null];

// Capture GPS location for audit trail
captureGPS();

// Reset form
populateProjectDropdown();
document.getElementById('ticketProject').value = currentProject.id;
document.getElementById('serviceDate').value = ticketData.serviceDate;
document.getElementById('ticketNumber').value = '';
document.getElementById('grossLbs').value = '';
document.getElementById('tareLbs').value = '';
document.getElementById('netWeightDisplay').textContent = '0.00 tons';
document.getElementById('haulerName').value = ticketData.hauler;
document.getElementById('directToEndMarket').checked = false;
document.getElementById('directEndMarketOptions').classList.add('hidden');
document.getElementById('ticketImagePreview').innerHTML = '<span>Upload scale ticket photo</span>';
document.getElementById('ticketImagePreview').classList.remove('filled');

// Reset photos
resetPhotoSlots();

// Reset verification
const checkbox = document.getElementById('humanVerifyCheckbox');
if (checkbox) checkbox.checked = false;
const verifyBox = document.getElementById('verificationBox');
if (verifyBox) verifyBox.classList.remove('verified');

// Show step 1
showStep(1);

// Open modal
document.getElementById('ticketModal').classList.add('active');
```

}

function closeTicketModal() {
document.getElementById(â€˜ticketModalâ€™).classList.remove(â€˜activeâ€™);
}

// ========== STEP NAVIGATION - CRITICAL ==========
function showStep(step) {
console.log(â€™===== SHOW STEP â€™ + step + â€™ =====â€™);
currentStep = step;

```
// Hide ALL steps first
for (let i = 1; i <= 4; i++) {
    const stepEl = document.getElementById('ticketStep' + i);
    if (stepEl) {
        stepEl.classList.add('hidden');
        stepEl.style.display = 'none';
        console.log('Hidden step ' + i);
    }
}

// Show current step
const currentEl = document.getElementById('ticketStep' + step);
if (currentEl) {
    currentEl.classList.remove('hidden');
    currentEl.style.display = 'block';
    console.log('Showing step ' + step);
}

// Update step indicators
for (let i = 1; i <= 4; i++) {
    const indicator = document.getElementById('stepIndicator' + i);
    if (indicator) {
        indicator.classList.remove('active', 'complete');
        if (i < step) indicator.classList.add('complete');
        else if (i === step) indicator.classList.add('active');
    }
    
    if (i < 4) {
        const line = document.getElementById('stepLine' + i);
        if (line) {
            line.classList.toggle('complete', i < step);
        }
    }
}

// Update buttons
document.getElementById('backBtn').style.visibility = step === 1 ? 'hidden' : 'visible';
document.getElementById('nextBtn').textContent = step === 4 ? 'âœ… Submit' : 'Next';

// Step-specific setup
if (step === 2) {
    document.getElementById('step2TicketNum').textContent = ticketData.ticketNumber || '--';
    document.getElementById('step2NetWeight').textContent = ticketData.netTons.toFixed(2) + ' T';
    
    // Show photos-optional message for partner tickets
    var photoWarning = document.querySelector('#ticketStep2 p[style*="amber"]');
    if (photoWarning) {
        if (ticketData.directToEndMarket) {
            photoWarning.innerHTML = 'ğŸ“· Photos are <strong>optional</strong> for partner facility loads. Tap Next to skip.';
            photoWarning.style.color = 'var(--slate-400)';
        } else {
            photoWarning.innerHTML = 'âš ï¸ Upload at least 1 photo of debris';
            photoWarning.style.color = 'var(--amber-400)';
        }
    }
}

if (step === 3) {
    populateReviewStep();
    
    // Adjust verification text for partner/direct-to-end-market tickets
    var verifyText = document.querySelector('#verificationBox .verify-text');
    var verifyDesc = document.querySelector('#verificationBox .verify-desc');
    if (ticketData.directToEndMarket) {
        if (verifyText) verifyText.textContent = 'âœ… Partner Facility Verification';
        if (verifyDesc) verifyDesc.textContent = 'I confirm this load was delivered to the partner facility and the scale ticket weight is correct. Photos not required for direct-to-end-market loads.';
        // Auto-check for partner tickets
        var cb = document.getElementById('humanVerifyCheckbox');
        if (cb) cb.checked = true;
        // Mark step 2 indicator as skipped
        var step2Ind = document.getElementById('stepIndicator2');
        if (step2Ind) { step2Ind.classList.add('complete'); step2Ind.textContent = 'â€”'; step2Ind.title = 'Photos skipped â€” partner facility'; }
    } else {
        if (verifyText) verifyText.textContent = 'âš ï¸ REQUIRED: Human Verification';
        if (verifyDesc) verifyDesc.textContent = 'I have reviewed the photos and confirm the material percentages are accurate or have been corrected.';
        var step2Ind2 = document.getElementById('stepIndicator2');
        if (step2Ind2) step2Ind2.textContent = '2';
    }
}

if (step === 4) {
    // Auto-set date if not already set
    if (!ticketData.serviceDate) {
        ticketData.serviceDate = new Date().toISOString().split('T')[0];
    }
    
    // Populate summary
    const s4Ticket = document.getElementById('step4TicketNum');
    const s4Date = document.getElementById('step4Date');
    const s4Weight = document.getElementById('step4Weight');
    const s4Diversion = document.getElementById('step4Diversion');
    
    if (s4Ticket) s4Ticket.textContent = ticketData.ticketNumber || '--';
    if (s4Date) s4Date.textContent = ticketData.serviceDate || new Date().toISOString().split('T')[0];
    if (s4Weight) s4Weight.textContent = (ticketData.netTons || 0).toFixed(2) + ' T';
    if (s4Diversion) {
        const rate = ticketData.diversionRate || 0;
        s4Diversion.textContent = rate + '%';
        s4Diversion.style.color = rate >= 75 ? 'var(--emerald-400)' : rate >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
    }
    
    setupSignaturePad();
}

// Scroll to top of modal
const modalBody = document.querySelector('#ticketModal .modal-body');
if (modalBody) modalBody.scrollTop = 0;
```

}

function goBack() {
if (currentStep > 1) {
// Skip step 2 for direct-to-end-market tickets
if (currentStep === 3 && ticketData.directToEndMarket) {
showStep(1);
} else {
showStep(currentStep - 1);
}
}
}

function goNext() {
console.log(â€˜goNext called, currentStep:â€™, currentStep);

```
// STEP 1 VALIDATION
if (currentStep === 1) {
    const project = document.getElementById('ticketProject').value;
    const gross = parseFloat(document.getElementById('grossLbs').value) || 0;
    const tare = parseFloat(document.getElementById('tareLbs').value) || 0;
    
    if (!project) {
        toast('Please select a project', 'error');
        return;
    }
    if (!gross || !tare) {
        toast('Please enter gross and tare weights', 'error');
        return;
    }
    
    ticketData.projectId = project;
    ticketData.ticketNumber = document.getElementById('ticketNumber').value;
    ticketData.serviceDate = document.getElementById('serviceDate').value;
    ticketData.grossLbs = gross;
    ticketData.tareLbs = tare;
    ticketData.netTons = (gross - tare) / 2000;
    ticketData.hauler = document.getElementById('haulerName').value;
    ticketData.directToEndMarket = document.getElementById('directToEndMarket').checked;
    ticketData.partnerFacility = ticketData.directToEndMarket ? document.getElementById('directFacilitySelect').value : null;
    
    // Direct to End Market: skip photo/AI step, auto-set materials
    if (ticketData.directToEndMarket && ticketData.partnerFacility) {
        var partnerMaterialMap = {
            'big_city_concrete': { concrete: 100 },
            'usa_gypsum': { drywall: 100 },
            'ewaste_recycler': { plastic: 100 },  // e-waste counts as diverted
            'asphalt_recycler': { concrete: 100 }, // asphalt grouped with concrete/masonry
            'soil_recycler': { concrete: 100 }     // soil/fill grouped as inert
        };
        var partnerMats = partnerMaterialMap[ticketData.partnerFacility] || { concrete: 100 };
        ticketData.materials = { wood: 0, concrete: 0, metal: 0, cardboard: 0, plastic: 0, drywall: 0, landfill: 0 };
        Object.keys(partnerMats).forEach(function(k) { ticketData.materials[k] = partnerMats[k]; });
        ticketData.diversionRate = 100; // 100% diverted â€” no landfill
        ticketData.humanVerified = true;
        var facilityName = VERIFIED_FACILITIES[ticketData.partnerFacility] ? VERIFIED_FACILITIES[ticketData.partnerFacility].name : ticketData.partnerFacility;
        ticketData.hauler = ticketData.hauler || facilityName;
        console.log('Direct to End Market: skipping photos, materials auto-set for', facilityName);
        showStep(3); // Skip step 2 (photos), go straight to review
        return;
    }
    
    showStep(2);
    return;
}

// STEP 2 VALIDATION
if (currentStep === 2) {
    // Partner tickets can skip photos entirely
    if (ticketData.directToEndMarket && ticketData.partnerFacility) {
        // Auto-set materials from partner map if not already done
        if (ticketData.diversionRate === 0) {
            var partnerMaterialMap2 = {
                'big_city_concrete': { concrete: 100 },
                'usa_gypsum': { drywall: 100 },
                'ewaste_recycler': { plastic: 100 },
                'asphalt_recycler': { concrete: 100 },
                'soil_recycler': { concrete: 100 }
            };
            var pm = partnerMaterialMap2[ticketData.partnerFacility] || { concrete: 100 };
            ticketData.materials = { wood: 0, concrete: 0, metal: 0, cardboard: 0, plastic: 0, drywall: 0, landfill: 0 };
            Object.keys(pm).forEach(function(k) { ticketData.materials[k] = pm[k]; });
            ticketData.diversionRate = 100;
            ticketData.humanVerified = true;
        }
        showStep(3);
        return;
    }
    
    if (ticketData.diversionRate === 0) {
        if (debrisPhotos.some(p => p)) {
            toast('Click "Analyze Materials" first', 'error');
        } else {
            toast('Upload photos and analyze', 'error');
        }
        return;
    }
    
    showStep(3);
    return;
}

// STEP 3 VALIDATION - CHECK HUMAN VERIFICATION
if (currentStep === 3) {
    const checkbox = document.getElementById('humanVerifyCheckbox');
    console.log('Checkbox element:', checkbox);
    console.log('Checkbox checked:', checkbox ? checkbox.checked : 'NOT FOUND');
    
    if (!checkbox || !checkbox.checked) {
        toast('Please check the verification box', 'error');
        return;
    }
    
    // Save materials from inputs BEFORE leaving Step 3
    const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
    let total = 0;
    
    keys.forEach(key => {
        const input = document.getElementById('mat_' + key);
        if (input) {
            ticketData.materials[key] = parseInt(input.value) || 0;
            total += ticketData.materials[key];
        }
    });
    
    console.log('Materials saved:', ticketData.materials, 'Total:', total);
    
    // Validate total
    if (total < 99 || total > 101) {
        toast('Materials must total 100% (currently ' + total + '%)', 'error');
        return;
    }
    
    // Recalculate diversion
    ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);
    ticketData.humanVerified = true;
    
    showStep(4);
    return;
}

// STEP 4 - SUBMIT
if (currentStep === 4) {
    submitTicket();
    return;
}
```

}

// ========== STEP 1: SCALE TICKET ==========
function handleTicketPhoto(event) {
const file = event.target.files[0];
if (!file) return;

```
const reader = new FileReader();
reader.onload = function(e) {
    var rawImage = e.target.result;
    // Open crop tool â€” user frames just the ticket
    openPhotoCrop(rawImage, function(croppedImage) {
        document.getElementById('ticketImagePreview').innerHTML = '<img src="' + croppedImage + '">';
        document.getElementById('ticketImagePreview').classList.add('filled');
        
        // Store for audit trail
        ticketData.scaleTicketPhoto = croppedImage;
        ticketData.captureTimestamp = new Date().toISOString();
        
        // Run OCR on cropped image
        analyzeScaleTicket(croppedImage);
    }, 'ticket');
};
reader.readAsDataURL(file);
```

}

async function analyzeScaleTicket(imageData) {
const apiKey = localStorage.getItem(â€˜divertscan_openaiâ€™);
if (!apiKey) {
toast(â€˜Add Anthropic API key in Settingsâ€™, â€˜errorâ€™);
return;
}

```
// Check if old OpenAI key is stored
if (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-ant-')) {
    toast('âš ï¸ Old OpenAI key detected - please update to Anthropic key in Settings', 'error');
    return;
}

showLoading('Reading scale ticket with Claude AI...');

try {
    // Extract base64 and media type from data URL
    const mediaType = imageData.split(';')[0].split(':')[1] || 'image/jpeg';
    const base64Data = imageData.split(',')[1];
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'x-api-key': apiKey,
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',
            max_tokens: 768,
            messages: [{
                role: 'user',
                content: [
                    {
                        type: 'image',
                        source: {
                            type: 'base64',
                            media_type: mediaType,
                            data: base64Data
                        }
                    },
                    { 
                        type: 'text', 
                        text: `You are reading a construction/demolition scale ticket. These are often handwritten, carbon-copy, or thermal printed. Read EVERY field carefully â€” look for faded ink, overlapping text, and poor handwriting.
```

Return ONLY JSON:
{â€œticket_numberâ€:â€œstringâ€,â€œdateâ€:â€œMM/DD/YYYYâ€,â€œgross_lbsâ€:number,â€œtare_lbsâ€:number,â€œnet_lbsâ€:number,â€œhaulerâ€:â€œstringâ€,â€œvehicle_idâ€:â€œstring or nullâ€,â€œmaterial_typeâ€:â€œstring or nullâ€,â€œcustomerâ€:â€œstring or nullâ€}

RULES:

- Read actual numbers â€” do NOT estimate or round weights
- If handwriting is ambiguous (e.g. 3 vs 8, 1 vs 7), note the most likely reading
- Net = Gross minus Tare. If net_lbs is not printed, calculate it
- Use null for truly unreadable fields, not empty strings
- Dates may be in various formats â€” normalize to MM/DD/YYYY`
  }
  ]
  }]
  })
  });
  
  ```
    const data = await response.json();
    hideLoading();
    
    if (data.error) {
        console.error('Claude API Error:', data.error);
        var _em = data.error.message || JSON.stringify(data.error); toast(_em.indexOf('api-key') > -1 ? 'API key invalid â€” check Settings' : 'API Error: ' + _em, 'error');
        return;
    }
    
    let text = data.content[0].text;
    text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
    
    const match = text.match(/\{[\s\S]*\}/);
    
    if (match) {
        const result = JSON.parse(match[0]);
        
        document.getElementById('ticketNumber').value = result.ticket_number || '';
        document.getElementById('grossLbs').value = result.gross_lbs || '';
        document.getElementById('tareLbs').value = result.tare_lbs || '';
        document.getElementById('haulerName').value = result.hauler || '';
        
        if (result.date) {
            const d = new Date(result.date);
            if (!isNaN(d)) {
                document.getElementById('serviceDate').value = d.toISOString().split('T')[0];
            }
        }
        
        updateNetWeight();
        toast('âœ… Ticket read! Click Next to continue', 'success');
    } else {
        toast('Could not parse ticket data - try a clearer photo', 'warning');
    }
  ```
  
  } catch (err) {
  hideLoading();
  console.error(â€˜OCR Error:â€™, err);
  toast(â€™Error reading ticket: â€™ + err.message, â€˜errorâ€™);
  }
  }

function updateNetWeight() {
const gross = parseFloat(document.getElementById(â€˜grossLbsâ€™).value) || 0;
const tare = parseFloat(document.getElementById(â€˜tareLbsâ€™).value) || 0;
const netLbs = Math.max(0, gross - tare);
const netTons = netLbs / 2000;

```
ticketData.grossLbs = gross;
ticketData.tareLbs = tare;
ticketData.netTons = netTons;

document.getElementById('netWeightDisplay').textContent = netTons.toFixed(2) + ' tons';
```

}

// ========== STEP 2: DEBRIS PHOTOS ==========
function toggleDirectEndMarket() {
var checked = document.getElementById(â€˜directToEndMarketâ€™).checked;
var opts = document.getElementById(â€˜directEndMarketOptionsâ€™);
if (checked) {
opts.classList.remove(â€˜hiddenâ€™);
} else {
opts.classList.add(â€˜hiddenâ€™);
}
}

function selectContainer(size) {
ticketData.containerSize = size;
document.querySelectorAll(â€™.container-optionâ€™).forEach(el => {
el.classList.toggle(â€˜selectedâ€™, el.querySelector(â€˜spanâ€™).textContent == (size || â€˜?â€™));
});
}

function resetPhotoSlots() {
for (let i = 0; i < 3; i++) {
const slot = document.getElementById(â€˜photoSlotâ€™ + i);
if (slot) {
slot.innerHTML = â€˜â•â€™;
slot.classList.remove(â€˜filledâ€™);
}
}
document.getElementById(â€˜photoCountâ€™).textContent = â€˜0â€™;
document.getElementById(â€˜analysisResultâ€™).classList.add(â€˜hiddenâ€™);
}

function triggerPhotoUpload(slot) {
currentPhotoSlot = slot;
document.getElementById(â€˜debrisPhotoInputâ€™).click();
}

function triggerDebrisCamera() {
// Find first empty slot
for (let i = 0; i < 3; i++) {
if (!debrisPhotos[i]) {
currentPhotoSlot = i;
break;
}
}
document.getElementById(â€˜debrisPhotoInputâ€™).click();
}

// Compress image to stay under Claude API 5MB limit
function compressImageForAPI(dataUrl, maxSizeBytes = 4500000) {
return new Promise((resolve) => {
// If already small enough, return as-is
const currentSize = Math.round((dataUrl.length - dataUrl.indexOf(â€™,â€™) - 1) * 0.75);
if (currentSize <= maxSizeBytes) {
resolve(dataUrl);
return;
}

```
    const img = new Image();
    img.onload = function() {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Scale down â€” 1600px balances OCR accuracy on handwriting with upload speed
        const maxDim = 1600;
        if (width > maxDim || height > maxDim) {
            const ratio = Math.min(maxDim / width, maxDim / height);
            width = Math.round(width * ratio);
            height = Math.round(height * ratio);
        }
        
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Single-pass compression at 0.65 quality â€” fast, small enough for API
        let result = canvas.toDataURL('image/jpeg', 0.65);
        let resultSize = Math.round((result.length - result.indexOf(',') - 1) * 0.75);
        
        // Only retry if still over limit
        if (resultSize > maxSizeBytes) {
            canvas.width = Math.round(width * 0.5);
            canvas.height = Math.round(height * 0.5);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            result = canvas.toDataURL('image/jpeg', 0.6);
        }
        
        console.log(`Image compressed: ${(currentSize/1024/1024).toFixed(1)}MB â†’ ${(Math.round((result.length - result.indexOf(',') - 1) * 0.75)/1024/1024).toFixed(1)}MB (${width}x${height})`);
        resolve(result);
    };
    img.src = dataUrl;
});
```

}

// ========== PHOTO CROP/EDIT TOOL â€” Pinch-Zoom-Pan ==========
var cropState = {
img: null,
rotation: 0,
callback: null,
mode: â€˜debrisâ€™,
// Pan/zoom state
panX: 0,
panY: 0,
zoom: 1,
minZoom: 0.5,
maxZoom: 5,
// Frame position (fixed in container)
frame: { x: 0, y: 0, w: 0, h: 0 },
// Touch tracking
pointers: {},
lastPinchDist: 0,
lastPanX: 0,
lastPanY: 0,
isPanning: false,
// Container/image sizing
containerW: 0,
containerH: 0,
imgDisplayW: 0,
imgDisplayH: 0
};

function openPhotoCrop(dataUrl, callback, mode) {
cropState.callback = callback;
cropState.rotation = 0;
cropState.mode = mode || â€˜debrisâ€™;
cropState.zoom = 1;
cropState.panX = 0;
cropState.panY = 0;
cropState.pointers = {};

```
var modal = document.getElementById('photoCropModal');
modal.style.display = 'flex';

var title = document.getElementById('cropTitle');
title.textContent = mode === 'ticket' ? 'Crop Scale Ticket' : 'Crop Load Photo';

var img = new Image();
img.onload = function() {
    cropState.img = img;
    initCropView();
    setupCropTouch();
};
img.src = dataUrl;
```

}

function initCropView() {
var container = document.getElementById(â€˜cropContainerâ€™);
var canvas = document.getElementById(â€˜cropCanvasâ€™);
var ctx = canvas.getContext(â€˜2dâ€™);
var img = cropState.img;

```
var cw = container.clientWidth;
var ch = container.clientHeight;
cropState.containerW = cw;
cropState.containerH = ch;

// Account for rotation
var isRotated = (cropState.rotation % 180 !== 0);
var imgW = isRotated ? img.height : img.width;
var imgH = isRotated ? img.width : img.height;

// Draw full image on canvas at original resolution
canvas.width = cw * 2;
canvas.height = ch * 2;
canvas.style.width = cw + 'px';
canvas.style.height = ch + 'px';

// Calculate base scale to fit image in container
var baseScale = Math.min(cw / imgW, ch / imgH);
cropState.imgDisplayW = imgW * baseScale;
cropState.imgDisplayH = imgH * baseScale;

// Set crop frame â€” 85% of container, centered
var framePad = 0.075;
var frameW = Math.min(cw * (1 - 2 * framePad), cropState.imgDisplayW);
var frameH = Math.min(ch * (1 - 2 * framePad), cropState.imgDisplayH);
cropState.frame = {
    x: Math.round((cw - frameW) / 2),
    y: Math.round((ch - frameH) / 2),
    w: Math.round(frameW),
    h: Math.round(frameH)
};

// Position frame overlay
var frameEl = document.getElementById('cropFrame');
frameEl.style.left = cropState.frame.x + 'px';
frameEl.style.top = cropState.frame.y + 'px';
frameEl.style.width = cropState.frame.w + 'px';
frameEl.style.height = cropState.frame.h + 'px';

// Center image behind frame
cropState.panX = (cw - cropState.imgDisplayW) / 2;
cropState.panY = (ch - cropState.imgDisplayH) / 2;
cropState.zoom = 1;
cropState.minZoom = Math.max(cropState.frame.w / cropState.imgDisplayW, cropState.frame.h / cropState.imgDisplayH, 0.5);

drawCropCanvas();
```

}

function drawCropCanvas() {
var canvas = document.getElementById(â€˜cropCanvasâ€™);
var ctx = canvas.getContext(â€˜2dâ€™);
var img = cropState.img;
var cw = cropState.containerW;
var ch = cropState.containerH;

```
ctx.setTransform(2, 0, 0, 2, 0, 0); // retina
ctx.clearRect(0, 0, cw, ch);

var isRotated = (cropState.rotation % 180 !== 0);
var drawW = cropState.imgDisplayW * cropState.zoom;
var drawH = cropState.imgDisplayH * cropState.zoom;

ctx.save();
ctx.translate(cropState.panX + drawW / 2, cropState.panY + drawH / 2);
ctx.rotate(cropState.rotation * Math.PI / 180);

if (isRotated) {
    ctx.drawImage(img, -drawH / 2, -drawW / 2, drawH, drawW);
} else {
    ctx.drawImage(img, -drawW / 2, -drawH / 2, drawW, drawH);
}
ctx.restore();
```

}

function setupCropTouch() {
var container = document.getElementById(â€˜cropContainerâ€™);

```
// Remove old listeners
container.removeEventListener('pointerdown', cropTouchStart);
container.removeEventListener('pointermove', cropTouchMove);
container.removeEventListener('pointerup', cropTouchEnd);
container.removeEventListener('pointercancel', cropTouchEnd);
container.removeEventListener('wheel', cropWheel);

container.addEventListener('pointerdown', cropTouchStart, { passive: false });
container.addEventListener('pointermove', cropTouchMove, { passive: false });
container.addEventListener('pointerup', cropTouchEnd);
container.addEventListener('pointercancel', cropTouchEnd);
container.addEventListener('wheel', cropWheel, { passive: false });
```

}

function cropTouchStart(e) {
e.preventDefault();
cropState.pointers[e.pointerId] = { x: e.clientX, y: e.clientY };

```
var ids = Object.keys(cropState.pointers);
if (ids.length === 1) {
    cropState.lastPanX = cropState.panX;
    cropState.lastPanY = cropState.panY;
    cropState.isPanning = true;
} else if (ids.length === 2) {
    var p1 = cropState.pointers[ids[0]];
    var p2 = cropState.pointers[ids[1]];
    cropState.lastPinchDist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
    cropState.lastPanX = cropState.panX;
    cropState.lastPanY = cropState.panY;
    cropState.pinchStartZoom = cropState.zoom;
    cropState.pinchMidX = (p1.x + p2.x) / 2;
    cropState.pinchMidY = (p1.y + p2.y) / 2;
}
```

}

function cropTouchMove(e) {
e.preventDefault();
if (!cropState.pointers[e.pointerId]) return;
cropState.pointers[e.pointerId] = { x: e.clientX, y: e.clientY };

```
var ids = Object.keys(cropState.pointers);

if (ids.length === 2) {
    // Pinch zoom
    var p1 = cropState.pointers[ids[0]];
    var p2 = cropState.pointers[ids[1]];
    var dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
    var scale = dist / cropState.lastPinchDist;
    var newZoom = Math.max(cropState.minZoom, Math.min(cropState.maxZoom, cropState.pinchStartZoom * scale));
    
    // Zoom centered on pinch midpoint
    var midX = (p1.x + p2.x) / 2;
    var midY = (p1.y + p2.y) / 2;
    var container = document.getElementById('cropContainer');
    var rect = container.getBoundingClientRect();
    var cx = midX - rect.left;
    var cy = midY - rect.top;
    
    var zoomRatio = newZoom / cropState.zoom;
    cropState.panX = cx - (cx - cropState.panX) * zoomRatio;
    cropState.panY = cy - (cy - cropState.panY) * zoomRatio;
    cropState.zoom = newZoom;
    
    // Also pan with the midpoint movement
    var dMidX = midX - cropState.pinchMidX;
    var dMidY = midY - cropState.pinchMidY;
    cropState.panX += dMidX;
    cropState.panY += dMidY;
    cropState.pinchMidX = midX;
    cropState.pinchMidY = midY;
    
    constrainPan();
    drawCropCanvas();
} else if (ids.length === 1 && cropState.isPanning) {
    // Single finger pan
    var p = cropState.pointers[ids[0]];
    var startP = null;
    // Get delta from start
    cropState.panX = cropState.lastPanX + (p.x - Object.values(cropState.pointers)[0].x);
    
    // Simpler: track delta from initial position
    var dx = e.clientX - (cropState._panStartClientX || e.clientX);
    var dy = e.clientY - (cropState._panStartClientY || e.clientY);
    if (!cropState._panStartClientX) {
        cropState._panStartClientX = e.clientX;
        cropState._panStartClientY = e.clientY;
    }
    cropState.panX = cropState.lastPanX + dx;
    cropState.panY = cropState.lastPanY + dy;
    
    constrainPan();
    drawCropCanvas();
}
```

}

function cropTouchEnd(e) {
delete cropState.pointers[e.pointerId];
cropState._panStartClientX = null;
cropState._panStartClientY = null;

```
if (Object.keys(cropState.pointers).length === 0) {
    cropState.isPanning = false;
}
```

}

function cropWheel(e) {
e.preventDefault();
var container = document.getElementById(â€˜cropContainerâ€™);
var rect = container.getBoundingClientRect();
var cx = e.clientX - rect.left;
var cy = e.clientY - rect.top;

```
var delta = e.deltaY > 0 ? 0.9 : 1.1;
var newZoom = Math.max(cropState.minZoom, Math.min(cropState.maxZoom, cropState.zoom * delta));
var zoomRatio = newZoom / cropState.zoom;

cropState.panX = cx - (cx - cropState.panX) * zoomRatio;
cropState.panY = cy - (cy - cropState.panY) * zoomRatio;
cropState.zoom = newZoom;

constrainPan();
drawCropCanvas();
```

}

function constrainPan() {
// Keep image covering the crop frame
var f = cropState.frame;
var drawW = cropState.imgDisplayW * cropState.zoom;
var drawH = cropState.imgDisplayH * cropState.zoom;

```
// Image right edge must be >= frame right edge
if (cropState.panX + drawW < f.x + f.w) cropState.panX = f.x + f.w - drawW;
// Image left edge must be <= frame left edge
if (cropState.panX > f.x) cropState.panX = f.x;
// Same for Y
if (cropState.panY + drawH < f.y + f.h) cropState.panY = f.y + f.h - drawH;
if (cropState.panY > f.y) cropState.panY = f.y;
```

}

function rotateCropImage() {
cropState.rotation = (cropState.rotation + 90) % 360;
initCropView();
}

function applyCrop() {
var img = cropState.img;
var f = cropState.frame;
var zoom = cropState.zoom;

```
var isRotated = (cropState.rotation % 180 !== 0);
var imgW = isRotated ? img.height : img.width;
var imgH = isRotated ? img.width : img.height;

// Convert frame coords to image coords
var baseScale = Math.min(cropState.containerW / imgW, cropState.containerH / imgH);
var totalScale = baseScale * zoom;

var cropX = (f.x - cropState.panX) / totalScale;
var cropY = (f.y - cropState.panY) / totalScale;
var cropW = f.w / totalScale;
var cropH = f.h / totalScale;

// Clamp
cropX = Math.max(0, Math.min(imgW, cropX));
cropY = Math.max(0, Math.min(imgH, cropY));
cropW = Math.min(imgW - cropX, cropW);
cropH = Math.min(imgH - cropY, cropH);

// Output canvas
var outW = Math.round(cropW);
var outH = Math.round(cropH);
if (outW < 10 || outH < 10) { outW = imgW; outH = imgH; cropX = 0; cropY = 0; cropW = imgW; cropH = imgH; }

var outCanvas = document.createElement('canvas');
outCanvas.width = outW;
outCanvas.height = outH;
var outCtx = outCanvas.getContext('2d');

outCtx.save();
outCtx.translate(outW / 2, outH / 2);

if (cropState.rotation === 0) {
    outCtx.drawImage(img, -cropX - cropW / 2, -cropY - cropH / 2);
} else if (cropState.rotation === 90) {
    outCtx.rotate(Math.PI / 2);
    outCtx.drawImage(img, -cropY - cropH / 2, cropX - imgW + cropW / 2);
} else if (cropState.rotation === 180) {
    outCtx.rotate(Math.PI);
    outCtx.drawImage(img, cropX - imgW + cropW / 2, cropY - imgH + cropH / 2);
} else if (cropState.rotation === 270) {
    outCtx.rotate(3 * Math.PI / 2);
    outCtx.drawImage(img, cropY - imgH + cropH / 2, -cropX - cropW / 2);
}
outCtx.restore();

var result = outCanvas.toDataURL('image/jpeg', 0.85);

closeCropModal();

if (cropState.callback) {
    cropState.callback(result);
}
```

}

function cancelCrop() {
closeCropModal();
}

function skipCrop() {
var img = cropState.img;
var canvas = document.createElement(â€˜canvasâ€™);

```
var isRotated = (cropState.rotation % 180 !== 0);
canvas.width = isRotated ? img.height : img.width;
canvas.height = isRotated ? img.width : img.height;
var ctx = canvas.getContext('2d');

ctx.save();
ctx.translate(canvas.width / 2, canvas.height / 2);
ctx.rotate(cropState.rotation * Math.PI / 180);
ctx.drawImage(img, -img.width / 2, -img.height / 2);
ctx.restore();

var result = canvas.toDataURL('image/jpeg', 0.85);
closeCropModal();

if (cropState.callback) {
    cropState.callback(result);
}
```

}

function closeCropModal() {
document.getElementById(â€˜photoCropModalâ€™).style.display = â€˜noneâ€™;
var container = document.getElementById(â€˜cropContainerâ€™);
container.removeEventListener(â€˜pointerdownâ€™, cropTouchStart);
container.removeEventListener(â€˜pointermoveâ€™, cropTouchMove);
container.removeEventListener(â€˜pointerupâ€™, cropTouchEnd);
container.removeEventListener(â€˜pointercancelâ€™, cropTouchEnd);
container.removeEventListener(â€˜wheelâ€™, cropWheel);
cropState.pointers = {};
cropState.isPanning = false;
}

function handleDebrisPhoto(event) {
const file = event.target.files[0];
if (!file) return;

```
const reader = new FileReader();
reader.onload = function(e) {
    var rawImage = e.target.result;
    // Open crop tool â€” user frames just the load
    openPhotoCrop(rawImage, async function(croppedImage) {
        const img = await compressImageForAPI(croppedImage);
        debrisPhotos[currentPhotoSlot] = img;
        
        const slot = document.getElementById('photoSlot' + currentPhotoSlot);
        slot.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + currentPhotoSlot + ', event)">Ã—</button>';
        slot.classList.add('filled');
        
        updatePhotoCount();
    }, 'debris');
};
reader.readAsDataURL(file);

event.target.value = '';
```

}

function handleMultiplePhotos(event) {
const files = Array.from(event.target.files);
if (files.length === 0) return;

```
var fileQueue = [];
var slotIndex = 0;

// Build queue of files with their target slots
files.forEach(function(file) {
    while (slotIndex < 3 && debrisPhotos[slotIndex]) {
        slotIndex++;
    }
    if (slotIndex >= 3) return;
    fileQueue.push({ file: file, slot: slotIndex });
    slotIndex++;
});

// Process one at a time through the crop tool
function processNext(idx) {
    if (idx >= fileQueue.length) return;
    var item = fileQueue[idx];
    
    var reader = new FileReader();
    reader.onload = function(e) {
        openPhotoCrop(e.target.result, async function(croppedImage) {
            var img = await compressImageForAPI(croppedImage);
            debrisPhotos[item.slot] = img;
            
            var slotEl = document.getElementById('photoSlot' + item.slot);
            slotEl.innerHTML = '<img src="' + img + '"><button class="remove-btn" onclick="removePhoto(' + item.slot + ', event)">Ã—</button>';
            slotEl.classList.add('filled');
            updatePhotoCount();
            
            // Process next photo
            processNext(idx + 1);
        }, 'debris');
    };
    reader.readAsDataURL(item.file);
}

processNext(0);
event.target.value = '';
```

}

function removePhoto(index, event) {
event.stopPropagation();
debrisPhotos[index] = null;

```
const slot = document.getElementById('photoSlot' + index);
slot.innerHTML = 'â•';
slot.classList.remove('filled');

updatePhotoCount();
```

}

function updatePhotoCount() {
const count = debrisPhotos.filter(p => p).length;
document.getElementById(â€˜photoCountâ€™).textContent = count;
}

async function analyzeDebris() {
const photos = debrisPhotos.filter(p => p);
if (photos.length === 0) {
toast(â€˜Upload at least 1 photoâ€™, â€˜errorâ€™);
return;
}

```
const apiKey = localStorage.getItem('divertscan_openai');
if (!apiKey) {
    toast('Add Anthropic API key in Settings', 'error');
    return;
}

if (apiKey.startsWith('sk-') && !apiKey.startsWith('sk-ant-')) {
    toast('âš ï¸ Old OpenAI key detected - please update to Anthropic key in Settings', 'error');
    return;
}

showLoading('Checking photo quality...');

try {
    // Compress any oversized photos before sending to API
    showLoading('Preparing photos...');
    for (let i = 0; i < photos.length; i++) {
        photos[i] = await compressImageForAPI(photos[i]);
    }
    
    // Build image content for Claude
    const imageContent = photos.map(p => ({
        type: 'image',
        source: {
            type: 'base64',
            media_type: p.split(';')[0].split(':')[1] || 'image/jpeg',
            data: p.split(',')[1]
        }
    }));
    
    // Optimized prompt â€” shorter = faster first-token response
    const prompt = `C&D waste auditor at Dalmex Recycling, Dallas TX. Estimate material composition percentages from these debris photos.
```

RULES: Only count CLEAN SORTABLE materials as recyclable. Broken/contaminated/painted wood = landfill. Mixed tangled debris = landfill. Landfill usually 25%+ for mixed loads. Max 3-4 non-zero categories. Total must equal 100. Err toward MORE landfill.

BENCHMARKS: Clean wood loads: Wood 45-55%, Landfill 25-35%. Mixed demo: Wood 25-35%, Concrete 10-20%, Landfill 30-40%. Loads above 80% diversion are rare (<10%).

Return ONLY JSON:
{â€œqualityâ€:{â€œratingâ€:â€œgood|fair|poorâ€,â€œissuesâ€:[]},â€œfill_levelâ€:{â€œpercentageâ€:75,â€œdescriptionâ€:â€œbriefâ€},â€œcontaminationâ€:{â€œdetectedâ€:false,â€œtypesâ€:[],â€œimpactâ€:â€â€},â€œmaterialsâ€:{â€œwoodâ€:0,â€œconcreteâ€:0,â€œmetalâ€:0,â€œcardboardâ€:0,â€œplasticâ€:0,â€œdrywallâ€:0,â€œlandfillâ€:0},â€œreasoningâ€:â€œ2 sentencesâ€,â€œdominant_materialâ€:â€œnameâ€,â€œconfidenceâ€:â€œhigh|medium|lowâ€}`;

```
    showLoading('Analyzing materials with Claude AI...');
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'x-api-key': apiKey,
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',
            max_tokens: 1024,
            messages: [{
                role: 'user',
                content: [
                    ...imageContent,
                    { type: 'text', text: prompt }
                ]
            }]
        })
    });
    
    const data = await response.json();
    hideLoading();
    
    if (data.error) {
        console.error('Claude API Error:', data.error);
        var _em = data.error.message || JSON.stringify(data.error); toast(_em.indexOf('api-key') > -1 ? 'API key invalid â€” check Settings' : 'API Error: ' + _em, 'error');
        return;
    }
    
    let text = data.content[0].text;
    text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
    
    const match = text.match(/\{[\s\S]*\}/);
    if (match) {
        const analysis = JSON.parse(match[0]);
        
        // Store full analysis
        ticketData.aiAnalysis = analysis;
        
        // PHOTO QUALITY CHECK
        if (analysis.quality) {
            if (analysis.quality.rating === 'poor') {
                toast('âš ï¸ Photo quality is poor - consider retaking photos', 'error');
                // Show quality warning
                showQualityWarning(analysis.quality.issues);
            } else if (analysis.quality.rating === 'fair') {
                toast('ğŸ“· Photo quality is fair - results may vary', 'warning');
            }
        }
        
        // CONTAMINATION DETECTION
        if (analysis.contamination && analysis.contamination.detected) {
            ticketData.contaminationDetected = true;
            ticketData.contaminationTypes = analysis.contamination.types;
            showContaminationWarning(analysis.contamination);
        }
        
        // MATERIAL PROCESSING
        const result = analysis.materials || analysis;
        const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
        
        // Normalize to 100% if needed
        let total = 0;
        keys.forEach(k => { total += (result[k] || 0); });
        
        if (total > 0 && total !== 100) {
            const factor = 100 / total;
            keys.forEach(k => {
                result[k] = Math.round((result[k] || 0) * factor);
            });
            let newTotal = keys.reduce((s, k) => s + result[k], 0);
            if (newTotal !== 100) result.landfill += (100 - newTotal);
        }
        
        // POST-PROCESSING GUARDRAILS
        let anomalies = [];
        const recyclableKeys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall'];
        
        // Guard 1: Enforce minimum 25% landfill for mixed loads (multiple materials)
        const nonZeroRecyclables = recyclableKeys.filter(k => (result[k] || 0) > 0);
        const minLandfill = nonZeroRecyclables.length >= 3 ? 25 : 20;
        
        if (result.landfill < minLandfill) {
            const deficit = minLandfill - result.landfill;
            anomalies.push(`âš ï¸ Landfill adjusted from ${result.landfill}% to ${minLandfill}% (mixed loads rarely below ${minLandfill}%)`);
            result.landfill = minLandfill;
            
            // Steal from the largest recyclable category to compensate
            const largestKey = recyclableKeys.reduce((a, b) => (result[a] || 0) > (result[b] || 0) ? a : b);
            result[largestKey] = Math.max(0, (result[largestKey] || 0) - deficit);
        }
        
        // Guard 2: Cap diversion at 75% unless only 1-2 clean materials dominate
        const diversionRate = 100 - result.landfill;
        if (diversionRate > 75 && nonZeroRecyclables.length >= 3) {
            const excess = diversionRate - 72; // Pull back to 72%
            anomalies.push(`âš ï¸ Diversion ${diversionRate}% exceeds typical range - adjusted to 72%`);
            result.landfill += excess;
            
            // Reduce the smallest non-zero recyclables first
            let remaining = excess;
            const sorted = [...recyclableKeys].sort((a, b) => (result[a] || 0) - (result[b] || 0));
            for (const k of sorted) {
                if (remaining <= 0) break;
                if ((result[k] || 0) > 0) {
                    const reduction = Math.min(result[k], remaining);
                    result[k] -= reduction;
                    remaining -= reduction;
                }
            }
        }
        
        // Guard 3: Zero out tiny percentages (< 3%) - they look like guesses
        recyclableKeys.forEach(k => {
            if (result[k] > 0 && result[k] < 3) {
                result.landfill += result[k];
                result[k] = 0;
            }
        });
        
        // Guard 4: Catch suspiciously uniform distributions
        const nonZeroValues = keys.map(k => result[k]).filter(v => v > 0);
        const avg = nonZeroValues.reduce((a, b) => a + b, 0) / nonZeroValues.length;
        const variance = nonZeroValues.reduce((s, v) => s + Math.pow(v - avg, 2), 0) / nonZeroValues.length;
        if (variance < 80 && nonZeroValues.length > 3) {
            anomalies.push('âš ï¸ Distribution appears too flat/uniform - verify visually');
        }
        
        // Guard 5: Dominant material should actually dominate
        if (analysis.dominant_material) {
            const domKey = analysis.dominant_material.toLowerCase();
            const domValue = result[domKey] || 0;
            if (domValue < 30 && domValue > 0) {
                anomalies.push(`âš ï¸ "${analysis.dominant_material}" identified as dominant but only ${domValue}%`);
            }
        }
        
        // Final re-normalize to exactly 100
        let finalTotal = keys.reduce((s, k) => s + (result[k] || 0), 0);
        if (finalTotal !== 100) {
            result.landfill += (100 - finalTotal);
        }
        
        // Store results
        ticketData.materials = result;
        ticketData.diversionRate = 100 - (result.landfill || 0);
        ticketData.aiReasoning = analysis.reasoning || '';
        ticketData.aiConfidence = analysis.confidence || 'medium';
        ticketData.anomalies = anomalies;
        
        // UPDATE UI
        document.getElementById('analysisResult').classList.remove('hidden');
        document.getElementById('analysisRate').textContent = ticketData.diversionRate + '%';
        
        // Color code the rate
        const rateEl = document.getElementById('analysisRate');
        if (ticketData.diversionRate > 85) {
            rateEl.style.color = 'var(--amber-400)'; // Suspicious - too high
        } else if (ticketData.diversionRate >= 75) {
            rateEl.style.color = 'var(--emerald-400)'; // Good - meets LEED
        } else if (ticketData.diversionRate >= 50) {
            rateEl.style.color = 'var(--amber-400)'; // Below target
        } else {
            rateEl.style.color = 'var(--red-500)'; // Poor
        }
        
        // Show AI reasoning
        if (analysis.reasoning) {
            showAIReasoning(analysis.reasoning, analysis.confidence, anomalies);
        }
        
        // Show anomaly alerts
        if (anomalies.length > 0) {
            toast('âš ï¸ ' + anomalies.length + ' potential issue(s) detected - review carefully', 'warning');
        } else {
            toast('âœ… ' + ticketData.diversionRate + '% diversion estimated', 'success');
        }
        
        console.log('Final analysis:', {
            materials: ticketData.materials,
            diversion: ticketData.diversionRate,
            confidence: ticketData.aiConfidence,
            anomalies: anomalies
        });
        
    } else {
        // Fallback to safe defaults
        ticketData.materials = { wood: 20, concrete: 15, metal: 10, cardboard: 10, plastic: 10, drywall: 5, landfill: 30 };
        ticketData.diversionRate = 70;
        
        document.getElementById('analysisResult').classList.remove('hidden');
        document.getElementById('analysisRate').textContent = '70%';
        
        toast('âš ï¸ Could not parse AI response - using estimates', 'warning');
    }
    
} catch (err) {
    hideLoading();
    console.error('Analysis error:', err);
    toast('Analysis failed: ' + err.message, 'error');
}
```

}

// Show photo quality warning
function showQualityWarning(issues) {
const issueList = issues && issues.length > 0 ? issues.join(â€™, â€™) : â€˜Poor lighting or focusâ€™;
const html = `<div style="background:var(--amber-500);color:black;padding:12px;border-radius:8px;margin-bottom:12px"> <strong>ğŸ“· Photo Quality Issue</strong><br> <span style="font-size:12px">${issueList}</span><br> <span style="font-size:11px;opacity:0.8">Consider retaking photos for more accurate analysis</span> </div>`;
const container = document.getElementById(â€˜analysisResultâ€™);
container.insertAdjacentHTML(â€˜afterbeginâ€™, html);
}

// Show contamination warning
function showContaminationWarning(contamination) {
const types = contamination.types ? contamination.types.join(â€™, â€™) : â€˜Unknownâ€™;
const html = `<div style="background:var(--red-500);color:white;padding:12px;border-radius:8px;margin-bottom:12px"> <strong>âš ï¸ Contamination Detected</strong><br> <span style="font-size:12px">${types}</span><br> <span style="font-size:11px;opacity:0.9">${contamination.impact || 'May reduce recyclability of materials'}</span> </div>`;
const container = document.getElementById(â€˜analysisResultâ€™);
container.insertAdjacentHTML(â€˜afterbeginâ€™, html);
}

// Show AI reasoning
function showAIReasoning(reasoning, confidence, anomalies) {
const confidenceColor = confidence === â€˜highâ€™ ? â€˜var(â€“emerald-400)â€™ :
confidence === â€˜mediumâ€™ ? â€˜var(â€“amber-400)â€™ : â€˜var(â€“red-500)â€™;

```
let anomalyHtml = '';
if (anomalies && anomalies.length > 0) {
    anomalyHtml = `
        <div style="background:var(--amber-500);color:black;padding:8px;border-radius:6px;margin-top:8px;font-size:11px">
            <strong>Anomalies:</strong><br>
            ${anomalies.map(a => 'â€¢ ' + a).join('<br>')}
        </div>
    `;
}

const html = `
    <div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-top:12px;font-size:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>ğŸ¤– AI Analysis</strong>
            <span style="color:${confidenceColor};font-size:11px">Confidence: ${confidence || 'medium'}</span>
        </div>
        <p style="color:var(--slate-300);line-height:1.5">${reasoning}</p>
        ${anomalyHtml}
    </div>
`;

const container = document.getElementById('analysisResult');
container.insertAdjacentHTML('beforeend', html);
```

}

// ========== STEP 3: REVIEW ==========
function populateReviewStep() {
console.log(â€˜Populating review stepâ€™);

```
// Update diversion display
document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';

// Show Direct to End Market partner banner if applicable
const reasoningContainer = document.getElementById('aiReasoningSection');
if (reasoningContainer) {
    if (ticketData.directToEndMarket && ticketData.partnerFacility) {
        var facility = VERIFIED_FACILITIES[ticketData.partnerFacility];
        var fName = facility ? facility.name : ticketData.partnerFacility;
        var fType = facility ? facility.type : 'Partner Facility';
        reasoningContainer.innerHTML = `
            <div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px;border:1px solid var(--blue-500)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <strong style="font-size:12px">ğŸ¤ Direct to End Market</strong>
                    <span class="leed-badge compliant" style="font-size:9px;background:var(--blue-500)">PARTNER</span>
                </div>
                <p style="font-size:12px;color:var(--slate-200);margin-bottom:4px"><strong>${fName}</strong></p>
                <p style="font-size:11px;color:var(--slate-400)">${fType}</p>
                <p style="font-size:10px;color:var(--blue-500);margin-top:6px">âš¡ Materials auto-set â€” load went directly to partner facility, not through Dalmex yard. Scale ticket from partner facility serves as LEED documentation.</p>
            </div>
        `;
        reasoningContainer.classList.remove('hidden');
    } else if (ticketData.aiReasoning) {
        let html = `
            <div style="background:var(--slate-700);padding:12px;border-radius:8px;margin-bottom:16px">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <strong style="font-size:12px">ğŸ¤– AI Analysis</strong>
                    <span style="font-size:10px;color:${ticketData.aiConfidence === 'high' ? 'var(--emerald-400)' : 'var(--amber-400)'}">
                        ${ticketData.aiConfidence || 'medium'} confidence
                    </span>
                </div>
                <p style="font-size:11px;color:var(--slate-300);margin-bottom:8px">${ticketData.aiReasoning}</p>
        `;
        
        // Show anomalies if any
        if (ticketData.anomalies && ticketData.anomalies.length > 0) {
            html += `
                <div style="background:var(--amber-500);color:black;padding:8px;border-radius:6px;font-size:10px">
                    <strong>âš ï¸ Review Items:</strong><br>
                    ${ticketData.anomalies.map(a => 'â€¢ ' + a.replace('âš ï¸ ', '')).join('<br>')}
                </div>
            `;
        }
        
        // Show contamination warning if detected
        if (ticketData.contaminationDetected) {
            html += `
                <div style="background:var(--red-500);color:white;padding:8px;border-radius:6px;font-size:10px;margin-top:8px">
                    <strong>â˜£ï¸ Contamination:</strong> ${ticketData.contaminationTypes ? ticketData.contaminationTypes.join(', ') : 'Detected'}
                </div>
            `;
        }
        
        html += '</div>';
        reasoningContainer.innerHTML = html;
        reasoningContainer.classList.remove('hidden');
    } else {
        reasoningContainer.classList.add('hidden');
    }
}

// Build materials list
const materials = ticketData.materials;
const names = {
    wood: 'ğŸªµ Wood',
    concrete: 'ğŸ§± Concrete',
    metal: 'ğŸ”© Metal',
    cardboard: 'ğŸ“¦ Cardboard',
    plastic: 'â™»ï¸ Plastic',
    drywall: 'ğŸ—ï¸ Drywall',
    landfill: 'ğŸ—‘ï¸ Landfill'
};

const container = document.getElementById('materialsList');
container.innerHTML = '';

Object.entries(materials).forEach(([key, value]) => {
    const div = document.createElement('div');
    div.className = 'material-item';
    div.innerHTML = '<span class="material-name">' + (names[key] || key) + '</span>' +
        '<div class="material-input">' +
        '<input type="number" id="mat_' + key + '" value="' + (value || 0) + '" min="0" max="100">' +
        '<span>%</span></div>';
    
    // Add event listener properly
    const input = div.querySelector('input');
    input.addEventListener('input', function() {
        updateMaterial(key);
    });
    
    container.appendChild(div);
});

updateMaterialsTotal();

// Reset verification checkbox
const checkbox = document.getElementById('humanVerifyCheckbox');
if (checkbox) {
    checkbox.checked = ticketData.humanVerified;
    onVerificationChange();
}
```

}

function updateMaterial(key) {
const input = document.getElementById(â€˜mat_â€™ + key);
if (input) {
const newValue = parseInt(input.value) || 0;
ticketData.materials[key] = newValue;

```
    // Recalculate diversion (100 - landfill%)
    const landfill = ticketData.materials.landfill || 0;
    ticketData.diversionRate = 100 - landfill;
    document.getElementById('reviewDiversionRate').textContent = ticketData.diversionRate + '%';
    document.getElementById('reviewProgressBar').style.width = Math.min(ticketData.diversionRate, 100) + '%';
    
    // Update color based on LEED target
    const badge = document.getElementById('reviewDiversionRate');
    if (ticketData.diversionRate >= 75) {
        badge.style.color = 'var(--emerald-400)';
    } else if (ticketData.diversionRate >= 50) {
        badge.style.color = 'var(--amber-400)';
    } else {
        badge.style.color = 'var(--red-500)';
    }
    
    updateMaterialsTotal();
}
```

}

function updateMaterialsTotal() {
// Read directly from inputs to ensure accuracy
let total = 0;
const keys = [â€˜woodâ€™, â€˜concreteâ€™, â€˜metalâ€™, â€˜cardboardâ€™, â€˜plasticâ€™, â€˜drywallâ€™, â€˜landfillâ€™];

```
keys.forEach(key => {
    const input = document.getElementById('mat_' + key);
    if (input) {
        const val = parseInt(input.value) || 0;
        ticketData.materials[key] = val;
        total += val;
    }
});

const totalEl = document.getElementById('materialsTotal');
totalEl.textContent = total + '%';
totalEl.style.color = total === 100 ? 'var(--emerald-400)' : 'var(--red-500)';
```

}

function onVerificationChange() {
const checkbox = document.getElementById(â€˜humanVerifyCheckboxâ€™);
const box = document.getElementById(â€˜verificationBoxâ€™);

```
if (checkbox && box) {
    if (checkbox.checked) {
        box.classList.add('verified');
        ticketData.humanVerified = true;
    } else {
        box.classList.remove('verified');
        ticketData.humanVerified = false;
    }
}
```

}

// ========== STEP 4: SIGNATURE ==========
function setupSignaturePad() {
const canvas = document.getElementById(â€˜signaturePadâ€™);
if (!canvas) return;

```
signatureCanvas = canvas;
signatureCtx = canvas.getContext('2d');

// Set size
canvas.width = canvas.offsetWidth;
canvas.height = 150;

// Clear
signatureCtx.fillStyle = 'white';
signatureCtx.fillRect(0, 0, canvas.width, canvas.height);

// Events
canvas.addEventListener('mousedown', startDrawing);
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', stopDrawing);
canvas.addEventListener('touchstart', handleTouchStart);
canvas.addEventListener('touchmove', handleTouchMove);
canvas.addEventListener('touchend', stopDrawing);
```

}

function startDrawing(e) {
isDrawing = true;
draw(e);
}

function draw(e) {
if (!isDrawing) return;

```
const rect = signatureCanvas.getBoundingClientRect();
const x = e.clientX - rect.left;
const y = e.clientY - rect.top;

signatureCtx.lineWidth = 2;
signatureCtx.lineCap = 'round';
signatureCtx.strokeStyle = 'black';

signatureCtx.lineTo(x, y);
signatureCtx.stroke();
signatureCtx.beginPath();
signatureCtx.moveTo(x, y);
```

}

function stopDrawing() {
isDrawing = false;
signatureCtx.beginPath();
}

function handleTouchStart(e) {
e.preventDefault();
const touch = e.touches[0];
const mouseEvent = new MouseEvent(â€˜mousedownâ€™, {
clientX: touch.clientX,
clientY: touch.clientY
});
startDrawing(mouseEvent);
}

function handleTouchMove(e) {
e.preventDefault();
const touch = e.touches[0];
const mouseEvent = new MouseEvent(â€˜mousemoveâ€™, {
clientX: touch.clientX,
clientY: touch.clientY
});
draw(mouseEvent);
}

function clearSignature() {
if (signatureCtx && signatureCanvas) {
signatureCtx.fillStyle = â€˜whiteâ€™;
signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
}
}

// ========== SUBMIT ==========
async function submitTicket() {
console.log(â€˜submitTicket calledâ€™);

```
// Auto-set date if missing
if (!ticketData.serviceDate) {
    ticketData.serviceDate = new Date().toISOString().split('T')[0];
}

// Capture signature if provided (optional)
if (signatureCanvas) {
    try {
        const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
        let hasSignature = false;
        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i] < 250) {
                hasSignature = true;
                break;
            }
        }
        if (hasSignature) {
            ticketData.signature = signatureCanvas.toDataURL();
        }
    } catch (e) {
        // Signature pad may not be initialized if details was never opened - that's fine
        console.log('Signature pad not available:', e.message);
    }
}

// Read materials fresh from inputs
const keys = ['wood', 'concrete', 'metal', 'cardboard', 'plastic', 'drywall', 'landfill'];
let total = 0;
let foundInputs = 0;

keys.forEach(key => {
    const input = document.getElementById('mat_' + key);
    if (input) {
        foundInputs++;
        ticketData.materials[key] = parseInt(input.value) || 0;
        total += ticketData.materials[key];
    } else {
        // Fallback to ticketData if input not found
        total += ticketData.materials[key] || 0;
    }
});

console.log('Materials check - Inputs found:', foundInputs, 'Total:', total, ticketData.materials);

// Allow some tolerance (98-102%)
if (total < 98 || total > 102) {
    toast('Materials must total 100% (currently ' + total + '%). Go back to Step 3 to adjust.', 'error');
    return;
}

// Recalculate diversion rate
ticketData.diversionRate = 100 - (ticketData.materials.landfill || 0);

// Calculate material tons
const m = ticketData.materials;
const netTons = ticketData.netTons || 0;

// Build database record with ONLY columns that exist
const dbRecord = {
    project_id: ticketData.projectId,
    ticket_number: ticketData.ticketNumber || '',
    service_date: ticketData.serviceDate || new Date().toISOString().split('T')[0],
    hauler: ticketData.hauler || currentProject?.waste_hauler || '',
    container_size: ticketData.containerSize || 30,
    gross_lbs: ticketData.grossLbs || 0,
    tare_lbs: ticketData.tareLbs || 0,
    net_lbs: (ticketData.grossLbs || 0) - (ticketData.tareLbs || 0),
    net_tons: netTons,
    wood_pct: m.wood || 0,
    concrete_pct: m.concrete || 0,
    metal_pct: m.metal || 0,
    cardboard_pct: m.cardboard || 0,
    plastic_pct: m.plastic || 0,
    drywall_pct: m.drywall || 0,
    landfill_pct: m.landfill || 0,
    wood_tons: ((m.wood || 0) / 100) * netTons,
    concrete_tons: ((m.concrete || 0) / 100) * netTons,
    metal_tons: ((m.metal || 0) / 100) * netTons,
    cardboard_tons: ((m.cardboard || 0) / 100) * netTons,
    plastic_tons: ((m.plastic || 0) / 100) * netTons,
    drywall_tons: ((m.drywall || 0) / 100) * netTons,
    landfill_tons: ((m.landfill || 0) / 100) * netTons,
    diversion_pct: ticketData.diversionRate,
    diverted_tons: netTons * (ticketData.diversionRate / 100),
    human_verified: ticketData.humanVerified || false,
    photo_count: debrisPhotos.filter(p => p).length,
    is_closed: true,
    created_at: new Date().toISOString()
};

// Only add signature fields if a signature was actually captured (prevents schema mismatch)
if (ticketData.signature) {
    dbRecord.signature = ticketData.signature;
    dbRecord.signed_at = new Date().toISOString();
}

// Only add optional columns if they have values (to avoid column not found errors)
if (ticketData.scaleTicketPhoto) dbRecord.scale_ticket_photo = ticketData.scaleTicketPhoto;
if (debrisPhotos[0]) dbRecord.debris_photo_1 = debrisPhotos[0];
if (debrisPhotos[1]) dbRecord.debris_photo_2 = debrisPhotos[1];
if (debrisPhotos[2]) dbRecord.debris_photo_3 = debrisPhotos[2];
if (ticketData.gpsLatitude) dbRecord.gps_latitude = ticketData.gpsLatitude;
if (ticketData.gpsLongitude) dbRecord.gps_longitude = ticketData.gpsLongitude;
if (ticketData.gpsAccuracy) dbRecord.gps_accuracy = ticketData.gpsAccuracy;
if (ticketData.captureTimestamp) dbRecord.capture_timestamp = ticketData.captureTimestamp;
if (ticketData.directToEndMarket) {
    dbRecord.direct_to_end_market = true;
    dbRecord.partner_facility = ticketData.partnerFacility || '';
}

console.log('dbRecord to save:', Object.keys(dbRecord));

if (sb) {
    try {
        showLoading('Saving ticket...');
        
        // Use bulletproof save with offline support
        const success = await saveTicketWithOfflineSupport(dbRecord);
        
        hideLoading();
        
        if (success) {
            // Clear draft on successful save
            await clearDraft();
            
            closeTicketModal();
            toast('âœ… Ticket #' + ticketData.ticketNumber + ' saved!', 'success');
            loadRecentTickets();
            updateStats();
            
            // Check LEED compliance
            const leedResult = validateLeedCompliance(ticketData.diversionRate, netTons);
            if (leedResult.warnings.length > 0) {
                setTimeout(() => {
                    toast('âš ï¸ ' + leedResult.warnings[0], 'warning');
                }, 2000);
            }
        }
    } catch (err) {
        hideLoading();
        console.error('Submit error:', err);
        toast('Error: ' + err.message, 'error');
    }
} else {
    // No Supabase - save locally only
    try {
        dbRecord.id = 'local_' + Date.now();
        await saveToLocal('tickets', dbRecord);
        await addToSyncQueue('insert', 'tickets', dbRecord);
        await clearDraft();
        
        closeTicketModal();
        toast('âœ… Ticket saved locally (connect Supabase to sync)', 'success');
    } catch (err) {
        toast('Local save failed: ' + err.message, 'error');
    }
}
```

}

// ========== UTILITIES ==========
function showLoading(text) {
document.getElementById(â€˜loadingTextâ€™).textContent = text || â€˜Processingâ€¦â€™;
document.getElementById(â€˜loadingOverlayâ€™).classList.add(â€˜activeâ€™);
}

function hideLoading() {
document.getElementById(â€˜loadingOverlayâ€™).classList.remove(â€˜activeâ€™);
}

function toast(message, type) {
const t = document.getElementById(â€˜toastâ€™);
t.textContent = message;
t.className = â€™toast show â€™ + (type || â€˜â€™);
setTimeout(() => t.classList.remove(â€˜showâ€™), 3000);
}

// ========== REPORTS ==========
let reportData = [];

async function generateReport() {

```
// BUG FIX: Sync currentProject from report dropdown if available
var reportSel = document.getElementById('reportProjectSelect');
if (reportSel && reportSel.value) {
    var selId = reportSel.value;
    if (!currentProject || currentProject.id !== selId) {
        var found = (window._allProjectsList || []).find(function(p) { return p.id === selId; });
        if (found) {
            currentProject = found;
            localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));
        }
    }
}

if (!currentProject) {
    toast('Select a project first', 'error');
    return;
}

var projectIdForQuery = currentProject.id;

showLoading('Generating report...');

try {
    
    // FAST PATH: Use global tickets array if it has data for this project
    var projectTickets = tickets.filter(function(t){return t.project_id === projectIdForQuery});
    
    if (projectTickets.length > 0) {
        reportData = projectTickets.slice();
        reportData.sort(function(a,b){return new Date(a.service_date)-new Date(b.service_date)});
    } else {
        // Fetch from Supabase + IndexedDB in parallel
        let remoteData = [];
        let localData = [];
        var fetchPromises = [];
    
    if (sb) {
        fetchPromises.push(
            Promise.race([
                sb.from('tickets').select('*').eq('project_id', projectIdForQuery).order('service_date', {ascending:true}),
                new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},8000)})
            ]).then(function(result) {
                if (result && !result.error && result.data) remoteData = result.data;
            }).catch(function(e) { console.log('Supabase fetch skipped:', e.message); })
        );
    }
    
    fetchPromises.push(
        (async function() {
            try {
                var allLocal = await getAllFromLocal('tickets') || [];
                localData = allLocal.filter(function(t){return t.project_id === projectIdForQuery});
            } catch(e) { console.log('Local fetch error:', e.message); }
        })()
    );
    
    await Promise.all(fetchPromises);
    
    // Merge and dedupe by ticket_number (prefer remote if exists in both)
    const ticketMap = new Map();
    
    // Add local tickets first
    localData.forEach(t => {
        const key = t.ticket_number || t.id;
        ticketMap.set(key, t);
    });
    
    // Remote tickets override local (synced data takes precedence)
    remoteData.forEach(t => {
        const key = t.ticket_number || t.id;
        ticketMap.set(key, t);
    });
    
    reportData = Array.from(ticketMap.values());
    
    // Sort by service_date
    reportData.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));
    } // end else (fetch path)
    
    hideLoading();
    
    if (reportData.length === 0) {
        toast('No tickets found for this project. Import or submit some tickets first!', 'error');
        return;
    }
    
    // Show download buttons
    document.getElementById('reportDownloadBtns').style.display = 'grid';
    
    // Project Header
    document.getElementById('reportProjectName').textContent = currentProject.name || '-';
    document.getElementById('reportProjectAddress').textContent = currentProject.address || '-';
    document.getElementById('reportProjectGC').textContent = currentProject.general_contractor || currentProject.contractor || '-';
    document.getElementById('reportProjectHauler').textContent = currentProject.waste_hauler || '-';
    document.getElementById('reportDate').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('reportGeneratedDate').textContent = new Date().toLocaleString();
    
    // Calculate date range
    const dates = reportData.map(t => new Date(t.service_date)).filter(d => !isNaN(d));
    if (dates.length > 0) {
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        document.getElementById('reportPeriod').textContent = 
            minDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) + ' - ' +
            maxDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
    
    // Calculate totals
    let totalTons = 0, landfillTons = 0;
    let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0;
    let plasticTons = 0, drywallTons = 0;
    
    reportData.forEach(t => {
        totalTons += t.net_tons || 0;
        landfillTons += t.landfill_tons || 0;
        woodTons += t.wood_tons || 0;
        concreteTons += t.concrete_tons || 0;
        metalTons += t.metal_tons || 0;
        cardboardTons += t.cardboard_tons || 0;
        plasticTons += t.plastic_tons || 0;
        drywallTons += t.drywall_tons || 0;
    });
    
    const divertedTons = totalTons - landfillTons;
    const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
    
    // Update summary
    document.getElementById('reportTicketCount').textContent = reportData.length;
    document.getElementById('reportLoadCount').textContent = reportData.length + ' loads';
    document.getElementById('reportTotalTons').textContent = totalTons.toFixed(2);
    document.getElementById('reportDivertedTons').textContent = divertedTons.toFixed(2);
    document.getElementById('reportLandfillTons').textContent = landfillTons.toFixed(2);
    document.getElementById('reportTotalDiverted').textContent = divertedTons.toFixed(2) + ' T';
    document.getElementById('reportTotalLandfill').textContent = landfillTons.toFixed(2) + ' T';
    
    // Diversion rate with color
    const rateEl = document.getElementById('reportDiversionRate');
    rateEl.textContent = diversionRate + '%';
    rateEl.style.color = diversionRate >= 75 ? 'var(--emerald-400)' : diversionRate >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
    
    // LEED Status
    const statusEl = document.getElementById('reportLeedStatus');
    if (diversionRate >= 75) {
        statusEl.textContent = 'âœ… PASS';
        statusEl.style.color = 'var(--emerald-400)';
    } else if (diversionRate >= 50) {
        statusEl.textContent = 'âš ï¸ PARTIAL';
        statusEl.style.color = 'var(--amber-400)';
    } else {
        statusEl.textContent = 'âŒ BELOW';
        statusEl.style.color = 'var(--red-500)';
    }
    
    // Material breakdown with progress bars â€” 5 core + partner streams when present
    const materials = [
        { name: 'OCC / Paper', icon: 'ğŸ“¦', tons: cardboardTons, diverted: true },
        { name: 'Wood / Pallets', icon: 'ğŸªµ', tons: woodTons, diverted: true },
        { name: 'Metal / Scrap', icon: 'ğŸ”©', tons: metalTons, diverted: true },
        { name: 'Plastic', icon: 'â™»ï¸', tons: plasticTons, diverted: true },
        { name: 'Concrete / Block', icon: 'ğŸ§±', tons: concreteTons, diverted: true },
        { name: 'Drywall / Gypsum', icon: 'ğŸ—ï¸', tons: drywallTons, diverted: true },
        { name: 'Landfill', icon: 'ğŸ—‘ï¸', tons: landfillTons, diverted: false }
    ].filter(m => m.tons > 0);
    
    document.getElementById('reportMaterialBreakdown').innerHTML = materials.map(m => {
        const pct = totalTons > 0 ? (m.tons / totalTons) * 100 : 0;
        const barColor = m.diverted ? 'var(--emerald-500)' : 'var(--red-500)';
        return `
            <div style="margin-bottom:12px">
                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                    <span>${m.icon} ${m.name}</span>
                    <span style="font-weight:600">${m.tons.toFixed(2)} T (${pct.toFixed(1)}%)</span>
                </div>
                <div style="height:8px;background:var(--slate-700);border-radius:4px;overflow:hidden">
                    <div style="height:100%;width:${Math.min(pct, 100)}%;background:${barColor}"></div>
                </div>
            </div>
        `;
    }).join('');
    
    // Detailed ticket table with data cards + hardened header
    const reportType = document.getElementById('reportType')?.value || 'summary';
    
    let detailHtml = '';
    
    if (reportType === 'detailed') {
        // Card-based view for detailed reports with photos
        detailHtml = reportData.map((t, idx) => {
            const divPct = t.diversion_pct || 0;
            const badgeColor = divPct >= 75 ? '#2ecc71' : divPct >= 50 ? 'var(--amber-400)' : 'var(--red-500)';
            const matChips = [
                { name: 'OCC/Paper', pct: t.cardboard_pct, diverted: true },
                { name: 'Wood', pct: t.wood_pct, diverted: true },
                { name: 'Metal', pct: t.metal_pct, diverted: true },
                { name: 'Plastic', pct: t.plastic_pct, diverted: true },
                { name: 'Landfill', pct: t.landfill_pct, diverted: false }
            ].filter(m => m.pct > 0);
            
            // Build photo thumbnails
            var photoHtml = '';
            var hasAnyPhoto = t.scale_ticket_photo || t.debris_photo_1 || t.debris_photo_2 || t.debris_photo_3;
            if (hasAnyPhoto) {
                var tid = t.id || t.ticket_number || idx;
                photoHtml = '<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">';
                if (t.scale_ticket_photo) {
                    _photoViewerData['rpt_st_' + tid] = t.scale_ticket_photo;
                    photoHtml += '<div style="text-align:center"><img src="' + t.scale_ticket_photo + '" style="width:70px;height:50px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid var(--accent-info)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Scale Ticket\', \'rpt_st_' + tid + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Scale Ticket</div></div>';
                }
                if (t.debris_photo_1) {
                    _photoViewerData['rpt_dp1_' + tid] = t.debris_photo_1;
                    photoHtml += '<div style="text-align:center"><img src="' + t.debris_photo_1 + '" style="width:70px;height:50px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Debris Photo 1\', \'rpt_dp1_' + tid + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 1</div></div>';
                }
                if (t.debris_photo_2) {
                    _photoViewerData['rpt_dp2_' + tid] = t.debris_photo_2;
                    photoHtml += '<div style="text-align:center"><img src="' + t.debris_photo_2 + '" style="width:70px;height:50px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Debris Photo 2\', \'rpt_dp2_' + tid + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 2</div></div>';
                }
                if (t.debris_photo_3) {
                    _photoViewerData['rpt_dp3_' + tid] = t.debris_photo_3;
                    photoHtml += '<div style="text-align:center"><img src="' + t.debris_photo_3 + '" style="width:70px;height:50px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Debris Photo 3\', \'rpt_dp3_' + tid + '\')"><div style="font-size:9px;color:var(--text-muted);margin-top:2px">Debris 3</div></div>';
                }
                photoHtml += '</div>';
            }
            
            return '<div class="report-data-card">' +
                '<div class="card-header">' +
                    '<div class="card-title">#' + (t.ticket_number || 'N/A') + ' â€” ' + formatDate(t.service_date) + '</div>' +
                    '<div class="card-badge" style="background:' + badgeColor + '20;color:' + badgeColor + '">' + divPct + '% Diverted</div>' +
                '</div>' +
                '<div style="font-size:11px;color:var(--text-muted);margin-bottom:8px">' + (t.hauler || 'No hauler') + ' ' + (t.human_verified ? 'âœ… Verified' : 'âŒ Unverified') + (t.direct_to_end_market ? ' <span style="background:#3b82f6;color:white;padding:1px 6px;border-radius:3px;font-size:9px">ğŸ¤ Partner</span>' : '') + '</div>' +
                '<div class="weights-grid">' +
                    '<div class="weight-cell"><div class="val">' + (t.gross_lbs || 0).toLocaleString() + '</div><div class="lbl">GROSS LBS</div></div>' +
                    '<div class="weight-cell"><div class="val">' + (t.tare_lbs || 0).toLocaleString() + '</div><div class="lbl">TARE LBS</div></div>' +
                    '<div class="weight-cell"><div class="val" style="color:#2ecc71">' + (t.net_tons || 0).toFixed(2) + '</div><div class="lbl">NET TONS</div></div>' +
                '</div>' +
                '<div class="materials-row">' +
                    matChips.map(function(m) { return '<span class="mat-chip ' + (m.diverted ? 'diverted' : 'landfill') + '">' + m.name + ' ' + m.pct + '%</span>'; }).join('') +
                '</div>' +
                photoHtml +
            '</div>';
        }).join('');
    } else {
        // Standard table view with materials and photos
        detailHtml = '<table class="report-table"><thead><tr style="background:var(--bg-tertiary)">' +
            '<th style="color:var(--emerald-400)">Date</th><th style="color:var(--emerald-400)">Ticket #</th><th style="color:var(--emerald-400)">Hauler</th>' +
            '<th class="right" style="color:var(--emerald-400)">Gross (lbs)</th><th class="right" style="color:var(--emerald-400)">Tare (lbs)</th>' +
            '<th class="right" style="color:var(--emerald-400)">Net (T)</th>' +
            '<th style="color:var(--emerald-400)">Materials</th><th class="right" style="color:var(--emerald-400)">Diversion</th><th class="center" style="color:var(--emerald-400)">Photos</th><th class="center" style="color:var(--emerald-400)">Verified</th><th class="center admin-only" style="color:var(--emerald-400)">Actions</th>' +
            '</tr></thead><tbody>';
        
        reportData.forEach(function(t, idx) {
            var tid = t.id || t.ticket_number || idx;
            var divColor = (t.diversion_pct || 0) >= 75 ? '#2ecc71' : 'var(--amber-400)';
            
            // Material chips inline
            var mats = [
                { n: 'OCC', p: t.cardboard_pct },
                { n: 'Wood', p: t.wood_pct },
                { n: 'Metal', p: t.metal_pct },
                { n: 'Plastic', p: t.plastic_pct },
                { n: 'Concrete', p: t.concrete_pct },
                { n: 'Drywall', p: t.drywall_pct },
                { n: 'Landfill', p: t.landfill_pct }
            ].filter(function(m) { return m.p > 0; });
            var matStr = mats.map(function(m) {
                var cls = m.n === 'Landfill' ? 'landfill' : 'diverted';
                return '<span class="mat-chip ' + cls + '" style="font-size:9px;padding:1px 5px">' + m.n + ' ' + m.p + '%</span>';
            }).join(' ');
            
            // Photo icons
            var photoStr = '';
            var photoCount = 0;
            if (t.scale_ticket_photo) {
                _photoViewerData['rts_' + tid] = t.scale_ticket_photo;
                photoStr += '<img src="' + t.scale_ticket_photo + '" style="width:28px;height:28px;object-fit:cover;border-radius:3px;cursor:pointer;border:1px solid var(--accent-info)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Scale Ticket\', \'rts_' + tid + '\')" title="Scale Ticket"> ';
                photoCount++;
            }
            if (t.debris_photo_1) {
                _photoViewerData['rtd1_' + tid] = t.debris_photo_1;
                photoStr += '<img src="' + t.debris_photo_1 + '" style="width:28px;height:28px;object-fit:cover;border-radius:3px;cursor:pointer;border:1px solid var(--accent-primary)" onclick="openPhotoViewer(\'' + (t.ticket_number || '') + '\', \'Debris 1\', \'rtd1_' + tid + '\')" title="Debris Photo"> ';
                photoCount++;
            }
            if (!photoStr) photoStr = '<span style="color:var(--text-muted);font-size:10px">â€”</span>';
            
            detailHtml += '<tr>' +
                '<td>' + formatDate(t.service_date) + '</td>' +
                '<td>' + (t.ticket_number || '-') + (t.direct_to_end_market ? ' <span style="background:#3b82f6;color:white;padding:0 4px;border-radius:2px;font-size:8px">ğŸ¤</span>' : '') + '</td>' +
                '<td>' + (t.hauler || '-') + '</td>' +
                '<td style="text-align:right;font-size:10px;color:var(--slate-400)">' + (t.gross_lbs || 0).toLocaleString() + '</td>' +
                '<td style="text-align:right;font-size:10px;color:var(--slate-400)">' + (t.tare_lbs || 0).toLocaleString() + '</td>' +
                '<td style="text-align:right;font-weight:600">' + (t.net_tons || 0).toFixed(2) + '</td>' +
                '<td><div style="display:flex;flex-wrap:wrap;gap:2px">' + matStr + '</div></td>' +
                '<td style="text-align:right;color:' + divColor + '">' + (t.diversion_pct || 0) + '%</td>' +
                '<td style="text-align:center">' + photoStr + '</td>' +
                '<td style="text-align:center">' + (t.human_verified ? 'âœ…' : 'âŒ') + '</td>' +
                '<td class="admin-only" style="text-align:center;white-space:nowrap"><button onclick="editTicket(\'' + t.id + '\')" style="background:var(--accent-info);border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="Edit">âœï¸</button><button onclick="generateTicketCOD(\'' + t.id + '\')" style="background:#7c3aed;border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="COD">ğŸ“œ</button><button onclick="confirmDeleteTicket(\'' + t.id + '\')" style="background:var(--accent-danger);border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer;margin:1px" title="Delete">ğŸ—‘ï¸</button></td>' +
            '</tr>';
        });
        
        detailHtml += '</tbody><tfoot><tr>' +
            '<td colspan="5" style="font-weight:700">TOTALS</td>' +
            '<td style="text-align:right;font-weight:700">' + totalTons.toFixed(2) + '</td>' +
            '<td></td>' +
            '<td style="text-align:right;color:' + (diversionRate >= 75 ? '#2ecc71' : 'var(--amber-400)') + ';font-weight:700">' + diversionRate + '%</td>' +
            '<td></td>' +
            '<td style="text-align:center">' + reportData.filter(function(t){return t.human_verified}).length + '/' + reportData.length + '</td>' +
            '<td class="admin-only"></td>' +
            '</tr></tfoot></table>';
    }
    
    document.getElementById('reportContent').innerHTML = detailHtml;
    
    // Re-apply role visibility for dynamically rendered admin-only elements
    if (typeof applyRoleVisibility === 'function') applyRoleVisibility();
    
    document.getElementById('reportOutput').classList.remove('hidden');
    
    // Scroll to the report output so user sees it immediately
    setTimeout(function() {
        document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
    
    toast('Report generated!', 'success');
    
} catch (err) {
    hideLoading();
    console.error('Report error:', err);
    toast('Error generating report: ' + err.message, 'error');
}
```

}

function downloadReportCSV() {
// Use reportData if available, fall back to global tickets for current project
if (reportData.length === 0 && tickets.length > 0 && currentProject) {
reportData = tickets.filter(function(t){return t.project_id === currentProject.id});
}
if (reportData.length === 0) {
toast(â€˜No tickets found â€” select a project with ticketsâ€™, â€˜errorâ€™);
return;
}

```
// Create comprehensive CSV
const projectInfo = [
    ['LEED MRc5 WASTE DIVERSION REPORT'],
    [''],
    ['Project Name', currentProject.name || ''],
    ['Project Address', currentProject.address || ''],
    ['General Contractor', currentProject.general_contractor || ''],
    ['Waste Hauler', currentProject.waste_hauler || ''],
    ['Report Date', new Date().toLocaleDateString()],
    [''],
    ['SUMMARY'],
    ['Total Loads', reportData.length],
    ['Total Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0).toFixed(2)],
    ['Diverted Tons', reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0).toFixed(2)],
    ['Landfill Tons', reportData.reduce((sum, t) => sum + (t.landfill_tons || 0), 0).toFixed(2)],
    ['Diversion Rate', (reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0) > 0 ? 
        Math.round((reportData.reduce((sum, t) => sum + (t.net_tons || 0) - (t.landfill_tons || 0), 0) / 
        reportData.reduce((sum, t) => sum + (t.net_tons || 0), 0)) * 100) : 0) + '%'],
    [''],
    ['LOAD DETAILS'],
    ['Date', 'Ticket #', 'Hauler', 'Container', 'Gross Lbs', 'Tare Lbs', 'Net Tons', 
     'Wood %', 'Concrete %', 'Metal %', 'Cardboard %', 'Plastic %', 'Drywall %', 'Landfill %',
     'Wood Tons', 'Concrete Tons', 'Metal Tons', 'Cardboard Tons', 'Plastic Tons', 'Drywall Tons', 'Landfill Tons',
     'Diversion %', 'Human Verified', 'GPS Lat', 'GPS Long', 'Photos']
];

const rows = reportData.map(t => [
    t.service_date,
    t.ticket_number || '',
    t.hauler || '',
    t.container_size || '',
    t.gross_lbs || 0,
    t.tare_lbs || 0,
    (t.net_tons || 0).toFixed(2),
    t.wood_pct || 0,
    t.concrete_pct || 0,
    t.metal_pct || 0,
    t.cardboard_pct || 0,
    t.plastic_pct || 0,
    t.drywall_pct || 0,
    t.landfill_pct || 0,
    (t.wood_tons || 0).toFixed(2),
    (t.concrete_tons || 0).toFixed(2),
    (t.metal_tons || 0).toFixed(2),
    (t.cardboard_tons || 0).toFixed(2),
    (t.plastic_tons || 0).toFixed(2),
    (t.drywall_tons || 0).toFixed(2),
    (t.landfill_tons || 0).toFixed(2),
    t.diversion_pct || 0,
    t.human_verified ? 'Yes' : 'No',
    t.gps_latitude || '',
    t.gps_longitude || '',
    t.photo_count || 0
]);

const allRows = [...projectInfo, ...rows];
const csv = allRows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');

// Download
const blob = new Blob([csv], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `LEED_MRc5_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
a.click();
URL.revokeObjectURL(url);

toast('CSV downloaded!', 'success');
```

}

function downloadReportPDF() {
if (reportData.length === 0) {
toast(â€˜Generate a report firstâ€™, â€˜errorâ€™);
return;
}

```
const { jsPDF } = window.jspdf;
const doc = new jsPDF('landscape');

// Calculate totals
let totalTons = 0, landfillTons = 0;
let woodTons = 0, concreteTons = 0, metalTons = 0, cardboardTons = 0, plasticTons = 0, drywallTons = 0;

reportData.forEach(t => {
    totalTons += t.net_tons || 0;
    landfillTons += t.landfill_tons || 0;
    woodTons += t.wood_tons || 0;
    concreteTons += t.concrete_tons || 0;
    metalTons += t.metal_tons || 0;
    cardboardTons += t.cardboard_tons || 0;
    plasticTons += t.plastic_tons || 0;
    drywallTons += t.drywall_tons || 0;
});

const divertedTons = totalTons - landfillTons;
const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;

let y = 15;

// Header - Right aligned company info
doc.setFontSize(12);
doc.setFont('helvetica', 'bold');
doc.text('Jaguar Waste Management', 280, y, { align: 'right' });
y += 6;
doc.setFontSize(9);
doc.setFont('helvetica', 'normal');
doc.text('214-487-3457', 280, y, { align: 'right' });

// Left side - Recipient
y = 15;
doc.setFontSize(9);
doc.text('ATTN: ' + (currentProject.general_contractor || 'Project Manager'), 14, y);
y += 5;
doc.text('RE: ' + (currentProject.name || 'Construction Project'), 14, y);
y += 8;
doc.text('Date: ' + new Date().toLocaleDateString(), 14, y);
y += 10;

// Letter body
doc.text('Dear Client,', 14, y);
y += 6;
const reportMonth = reportData.length > 0 && reportData[0].service_date ? 
    new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) : 
    'Current Period';
doc.text('Below are the tonnage reports for ' + reportMonth + '. The report lists all the information needed for each haul.', 14, y);
y += 12;

// Project Site Address Box
doc.setFillColor(240, 240, 240);
doc.rect(14, y, 100, 10, 'F');
doc.setFontSize(11);
doc.setFont('helvetica', 'bold');
doc.setTextColor(34, 139, 34); // Dalmex green
doc.text(currentProject.address || currentProject.name || 'Project Site', 18, y + 7);
doc.setTextColor(0, 0, 0);
y += 18;

// Table Header
doc.setFontSize(8);
doc.setFont('helvetica', 'bold');
doc.setFillColor(255, 255, 255);

const colX = [14, 34, 64, 94, 124, 154, 179, 204, 229, 254];
const colW = [20, 30, 30, 30, 30, 25, 25, 25, 25, 25];
const headers = ['Month', 'Date', 'W/O & TKT #', 'Total Ton', 'BRK/BLCK/CON', 'Metal/Alum', 'OCC', 'Plastic', 'Wood', 'Trash'];

// Draw header row
doc.setDrawColor(0);
doc.setLineWidth(0.5);
headers.forEach((h, i) => {
    doc.rect(colX[i], y, colW[i], 8);
    doc.text(h, colX[i] + 2, y + 5.5);
});
y += 8;

// Get month name for first column
const monthName = reportData.length > 0 && reportData[0].service_date ? 
    new Date(reportData[0].service_date).toLocaleDateString('en-US', { month: 'long' }) : '';

// Data rows
doc.setFont('helvetica', 'normal');
let firstRow = true;

reportData.forEach((t, idx) => {
    if (y > 180) {
        doc.addPage('landscape');
        y = 20;
        // Redraw header on new page
        doc.setFont('helvetica', 'bold');
        headers.forEach((h, i) => {
            doc.rect(colX[i], y, colW[i], 8);
            doc.text(h, colX[i] + 2, y + 5.5);
        });
        y += 8;
        doc.setFont('helvetica', 'normal');
        firstRow = true;
    }
    
    const rowData = [
        firstRow ? monthName : '',
        t.service_date ? new Date(t.service_date).toLocaleDateString('en-US', {month:'numeric', day:'numeric', year:'numeric'}) : '',
        t.ticket_number || '',
        (t.net_tons || 0).toFixed(2),
        (t.concrete_tons || 0) > 0 ? (t.concrete_tons || 0).toFixed(2) : '',
        (t.metal_tons || 0) > 0 ? (t.metal_tons || 0).toFixed(2) : '',
        (t.cardboard_tons || 0) > 0 ? (t.cardboard_tons || 0).toFixed(2) : '',
        (t.plastic_tons || 0) > 0 ? (t.plastic_tons || 0).toFixed(2) : '',
        (t.wood_tons || 0) > 0 ? (t.wood_tons || 0).toFixed(2) : '',
        (t.landfill_tons || 0) > 0 ? (t.landfill_tons || 0).toFixed(2) : ''
    ];
    
    rowData.forEach((d, i) => {
        doc.rect(colX[i], y, colW[i], 6);
        doc.text(String(d), colX[i] + 2, y + 4);
    });
    
    y += 6;
    firstRow = false;
});

// Totals row
y += 2;
doc.setFont('helvetica', 'bold');
const totalsData = [
    '', 'Total:', '', 
    totalTons.toFixed(2),
    concreteTons.toFixed(2),
    metalTons.toFixed(2),
    cardboardTons.toFixed(2),
    plasticTons.toFixed(2),
    woodTons.toFixed(2),
    landfillTons.toFixed(2)
];

totalsData.forEach((d, i) => {
    doc.rect(colX[i], y, colW[i], 6);
    doc.text(String(d), colX[i] + 2, y + 4);
});
y += 6;

// Percentage row
const pctData = [
    '', 'Percentage:', '',
    '',
    totalTons > 0 ? Math.round((concreteTons/totalTons)*100) + '%' : '0%',
    totalTons > 0 ? Math.round((metalTons/totalTons)*100) + '%' : '0%',
    totalTons > 0 ? Math.round((cardboardTons/totalTons)*100) + '%' : '0%',
    totalTons > 0 ? Math.round((plasticTons/totalTons)*100) + '%' : '0%',
    totalTons > 0 ? Math.round((woodTons/totalTons)*100) + '%' : '0%',
    totalTons > 0 ? Math.round((landfillTons/totalTons)*100) + '%' : '0%'
];

pctData.forEach((d, i) => {
    doc.rect(colX[i], y, colW[i], 6);
    doc.text(String(d), colX[i] + 2, y + 4);
});
y += 12;

// Diversion Summary
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.text('DIVERSION SUMMARY', 14, y);
y += 6;
doc.setFont('helvetica', 'normal');
doc.setFontSize(9);
doc.text('Total Diverted: ' + divertedTons.toFixed(2) + ' tons (' + diversionRate + '%)', 14, y);
y += 5;
doc.text('Total Landfill: ' + landfillTons.toFixed(2) + ' tons (' + (100-diversionRate) + '%)', 14, y);
y += 5;
doc.setFont('helvetica', 'bold');
doc.text('LEED MRc5 Status: ' + (diversionRate >= 75 ? 'COMPLIANT (>=75%)' : 'NON-COMPLIANT (<75%)'), 14, y);

// Footer
const pageHeight = doc.internal.pageSize.height;
doc.setFontSize(8);
doc.setFont('helvetica', 'normal');
doc.text('Generated by DivertScanâ„¢ | ' + new Date().toLocaleString(), 14, pageHeight - 10);
doc.text(currentProject.waste_hauler || 'Jaguar Waste Management', 280, pageHeight - 10, { align: 'right' });

// Save
doc.save(`Tonnage_Report_${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);

toast('PDF downloaded!', 'success');
```

}

// ========== LEED AUDIT REPORT ==========
async function generateLEEDAuditReport() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}

```
showLoading('Generating LEED Audit Report...');

try {
    // Use global tickets array first (already populated by Projects/Dashboard)
    var allTickets = tickets.filter(function(t) { return t.project_id === currentProject.id; });
    
    // If global array is empty, fetch fresh
    if (allTickets.length === 0) {
        var localT = []; var remoteT = [];
        var fetches = [];
        fetches.push((async function() { try { var a = await getAllFromLocal('tickets') || []; localT = a.filter(function(t){return t.project_id === currentProject.id}); } catch(e){} })());
        if (sb) {
            fetches.push(Promise.race([
                sb.from('tickets').select('*').eq('project_id', currentProject.id).order('service_date',{ascending:true}),
                new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},8000)})
            ]).then(function(res){ if(res&&res.data) remoteT=res.data; }).catch(function(){}));
        }
        await Promise.all(fetches);
        var map = new Map();
        localT.forEach(function(t){map.set(t.ticket_number||t.id, t)});
        remoteT.forEach(function(t){map.set(t.ticket_number||t.id, t)});
        allTickets = Array.from(map.values());
        allTickets.sort(function(a,b){return new Date(a.service_date)-new Date(b.service_date)});
    }
    
    if (allTickets.length === 0) {
        hideLoading();
        toast('No tickets found for this project', 'error');
        return;
    }
    
    // Use shared PDF builder for consistent styling
    var pdfBlob = await buildLEEDPDFBlob(allTickets);
    var filename = 'LEED_Audit_Report_' + (currentProject.name || 'Project').replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
    
    // Download
    var url = URL.createObjectURL(pdfBlob);
    var a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display = 'none';
    document.body.appendChild(a); a.click();
    setTimeout(function() { if (a.parentNode) document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
    
    hideLoading();
    toast('LEED Report downloaded! (' + allTickets.length + ' loads)', 'success');
    
} catch (err) {
    hideLoading();
    console.error('Audit report error:', err);
    toast('Error: ' + err.message, 'error');
}
```

}

// Preview LEED Audit PDF in browser (opens in new tab for viewing)
async function previewLEEDAuditPDF() {
if (!currentProject) { toast(â€˜Select a project firstâ€™, â€˜errorâ€™); return; }
var data = (reportData && reportData.length > 0) ? reportData : tickets;
if (!data || data.length === 0) { toast(â€˜No ticket data availableâ€™, â€˜errorâ€™); return; }
try {
showLoading(â€˜Building PDFâ€¦â€™);
var pdfBlob = await buildLEEDPDFBlob(data);
var filename = â€˜LEED_Report_â€™ + (currentProject.name || â€˜Projectâ€™).replace(/[^a-z0-9]/gi, â€˜*â€™) + â€™*â€™ + new Date().toISOString().split(â€˜Tâ€™)[0] + â€˜.pdfâ€™;
var url = URL.createObjectURL(pdfBlob);
var a = document.createElement(â€˜aâ€™);
a.href = url; a.download = filename; a.style.display = â€˜noneâ€™;
document.body.appendChild(a); a.click();
setTimeout(function() { if (a.parentNode) document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
hideLoading();
toast(â€˜PDF downloaded!â€™, â€˜successâ€™);
} catch(err) { hideLoading(); toast(â€™PDF error: â€™+err.message, â€˜errorâ€™); }
}

// ===== SHARE PDF via Web Share API (iPad Safari) =====
async function shareLEEDPDF() {
if (!currentProject) { toast(â€˜Select a project firstâ€™, â€˜errorâ€™); return; }

```
var data = (reportData && reportData.length > 0) ? reportData : tickets;
if (!data || data.length === 0) { toast('No ticket data â€” generate report first', 'error'); return; }

showLoading('Building PDF for sharing...');

try {
    var pdfBlob = await buildLEEDPDFBlob(data);
    var filename = 'LEED_Report_' + (currentProject.name || 'Project').replace(/[^a-z0-9]/gi, '_') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
    var pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });
    
    hideLoading();
    
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
        await navigator.share({
            files: [pdfFile]
        });
        toast('PDF shared!', 'success');
    } else {
        var url = URL.createObjectURL(pdfBlob);
        var a = document.createElement('a');
        a.href = url; a.download = filename; a.style.display = 'none';
        document.body.appendChild(a); a.click();
        setTimeout(function() { if (a.parentNode) document.body.removeChild(a); URL.revokeObjectURL(url); }, 2000);
        toast('PDF downloaded (sharing not supported on this device)', 'success');
    }
} catch (err) {
    hideLoading();
    if (err.name === 'AbortError') { toast('Share cancelled', 'info'); }
    else { toast('Share error: ' + err.message, 'error'); }
}
```

}

// Build LEED PDF as Blob â€” mirrors the Excel report layout exactly
async function buildLEEDPDFBlob(data) {
var totalTons = data.reduce(function(s,t){return s+(t.net_tons||0)},0);
var landfillTons = data.reduce(function(s,t){return s+(t.landfill_tons||0)},0);
var divertedTons = totalTons - landfillTons;
var divRate = totalTons > 0 ? Math.round((divertedTons/totalTons)*100) : 0;
var woodTons = data.reduce(function(s,t){return s+(t.wood_tons||0)},0);
var metalTons = data.reduce(function(s,t){return s+(t.metal_tons||0)},0);
var cardboardTons = data.reduce(function(s,t){return s+(t.cardboard_tons||0)},0);
var concreteTons = data.reduce(function(s,t){return s+(t.concrete_tons||0)},0);
var plasticTons = data.reduce(function(s,t){return s+(t.plastic_tons||0)},0);
var drywallTons = data.reduce(function(s,t){return s+(t.drywall_tons||0)},0);
var verifiedCount = data.filter(function(t){return t.human_verified}).length;

```
var jsPDFLib = window.jspdf;
var doc = new jsPDFLib.jsPDF('portrait');
var pw = doc.internal.pageSize.width;
var ph = doc.internal.pageSize.height;
var y = 10;
var pageNum = 1;
var lm = 10;
var tw = pw - 20;

// Color palette
var DG = [27,67,50];
var MG = [64,145,108];
var LG = [216,243,220];
var ALT = [240,255,244];
var WHT = [255,255,255];
var BDR = [153,153,153];
var totBg = [183,228,199];

function cell(x,w,h,txt,opts) {
    opts = opts || {};
    var bg = opts.bg || WHT;
    var tc = opts.tc || [0,0,0];
    var fs = opts.fs || 9;
    var fb = opts.bold ? 'bold' : 'normal';
    var al = opts.align || 'left';
    doc.setFillColor(bg[0],bg[1],bg[2]);
    doc.setDrawColor(BDR[0],BDR[1],BDR[2]);
    doc.setLineWidth(0.3);
    doc.rect(x,y,w,h,'FD');
    doc.setTextColor(tc[0],tc[1],tc[2]);
    doc.setFontSize(fs);
    doc.setFont('helvetica',fb);
    var tx = al === 'right' ? x+w-2 : al === 'center' ? x+w/2 : x+2;
    var talign = al === 'right' ? {align:'right'} : al === 'center' ? {align:'center'} : {};
    doc.text(String(txt), tx, y+h*0.65, talign);
}

function addFtr() {
    doc.setFontSize(7); doc.setFont('helvetica','normal'); doc.setTextColor(100,100,100);
    doc.text('Report generated by DivertScanâ„¢ v7.7 Enterprise | Dalmex Recycling LLC | ' + new Date().toLocaleString(), lm, ph-6);
    doc.text('Page ' + pageNum, pw-lm, ph-6, {align:'right'}); doc.setTextColor(0,0,0);
}
function chkPg(needed) {
    if (y + needed > ph - 15) { addFtr(); doc.addPage(); pageNum++; y = 10; }
}

// ===== TITLE BAR =====
cell(lm, tw, 10, 'LEED MRc5 WASTE DIVERSION REPORT', {bg:DG, tc:[255,255,255], fs:14, bold:true, align:'center'});
y += 10;
cell(lm, tw, 7, 'All Materials Processed by Dalmex Recycling LLC, Dallas TX', {bg:LG, tc:DG, fs:9, bold:true});
y += 9;

// ===== PROJECT INFORMATION =====
cell(lm, tw, 7, 'PROJECT INFORMATION', {bg:LG, tc:DG, fs:10, bold:true});
y += 7;

var hw = 30;
var vw = tw/2 - hw;

cell(lm, hw, 7, 'Project', {bg:[248,248,248], bold:true, fs:8});
cell(lm+hw, vw, 7, currentProject.name || '', {fs:9});
cell(lm+tw/2, hw, 7, 'Report Date', {bg:[248,248,248], bold:true, fs:8});
cell(lm+tw/2+hw, vw, 7, new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}), {fs:9});
y += 7;

cell(lm, hw, 7, 'Address', {bg:[248,248,248], bold:true, fs:8});
cell(lm+hw, vw, 7, currentProject.address || '', {fs:9});
cell(lm+tw/2, hw, 7, 'Hauler', {bg:[248,248,248], bold:true, fs:8});
cell(lm+tw/2+hw, vw, 7, currentProject.waste_hauler || '', {fs:9});
y += 7;

cell(lm, hw, 7, 'General Contractor', {bg:[248,248,248], bold:true, fs:7});
cell(lm+hw, vw, 7, currentProject.general_contractor || '', {fs:9});
cell(lm+tw/2, hw, 7, 'LEED Target', {bg:[248,248,248], bold:true, fs:8});
cell(lm+tw/2+hw, vw, 7, (currentProject.leed_target || 75) + '%', {fs:9});
y += 9;

// ===== DIVERSION SUMMARY =====
cell(lm, tw, 7, 'DIVERSION SUMMARY', {bg:LG, tc:DG, fs:10, bold:true});
y += 7;

var sc = tw / 5;
['Total Loads','Total Tonnage','Diverted','Landfill','Diversion Rate'].forEach(function(h,i) {
    cell(lm+sc*i, sc, 7, h, {bg:MG, tc:[255,255,255], fs:8, bold:true, align:'center'});
});
y += 7;

var compliant = divRate >= (currentProject.leed_target || 75);
var statusBg = compliant ? [212,237,218] : [248,215,218];
var statusTc = compliant ? [21,87,36] : [114,28,36];

cell(lm, sc, 8, data.length.toString(), {fs:10, align:'center'});
cell(lm+sc, sc, 8, totalTons.toFixed(2) + ' T', {fs:10, align:'center'});
cell(lm+sc*2, sc, 8, divertedTons.toFixed(2) + ' T', {fs:10, align:'center', tc:[27,122,61]});
cell(lm+sc*3, sc, 8, landfillTons.toFixed(2) + ' T', {fs:10, align:'center', tc:[180,83,9]});
cell(lm+sc*4, sc, 8, divRate + '%', {fs:12, bold:true, align:'center', bg:statusBg, tc:statusTc});
y += 10;

// ===== MATERIAL BREAKDOWN =====
cell(lm, tw, 7, 'MATERIAL BREAKDOWN & END MARKETS', {bg:LG, tc:DG, fs:10, bold:true});
y += 7;

var mc = [30, 18, 16, tw-30-18-16-28, 28];
['Material Stream','Tons','% of Total','End Market Destination','Status'].forEach(function(h,i) {
    var cx = lm; for(var j=0;j<i;j++) cx+=mc[j];
    var fz = (i===2) ? 7 : 8;
    cell(cx, mc[i], 7, h, {bg:MG, tc:[255,255,255], fs:fz, bold:true, align: i>=1&&i<=2?'center':'left'});
});
y += 7;

var mats = [
    ['OCC / Paper / Fiber', cardboardTons, 'Georgia Pacific Â· Smurfit Westrock Â· Greenside Â· Intl Paper Â· American Fiber'],
    ['Wood / Pallets', woodTons, 'Dalmex Pallets (In-House Reuse)'],
    ['Metal / Scrap', metalTons, 'CMC (Commercial Metals) Â· Cyclone Metal Recycling'],
    ['Plastic', plasticTons, 'Recycle USA'],
    ['Concrete / Block', concreteTons, 'Big City Concrete (Partner)'],
    ['Drywall / Gypsum', drywallTons, 'USA Gypsum (Partner)']
];

mats.forEach(function(m, i) {
    var bg = i % 2 === 0 ? WHT : ALT;
    var pct = totalTons > 0 ? Math.round(m[1]/totalTons*100) : 0;
    var cx = lm;
    cell(cx, mc[0], 6, m[0], {bg:bg, fs:8, bold:true}); cx+=mc[0];
    cell(cx, mc[1], 6, m[1].toFixed(2), {bg:bg, fs:8, align:'right'}); cx+=mc[1];
    cell(cx, mc[2], 6, pct+'%', {bg:bg, fs:8, align:'right'}); cx+=mc[2];
    cell(cx, mc[3], 6, m[2], {bg:[235,245,251], fs:7}); cx+=mc[3];
    cell(cx, mc[4], 6, 'âœ“ Verified', {bg:bg, fs:7, tc:[27,122,61], align:'center'});
    y += 6;
});

// Landfill row
var cx = lm;
cell(cx, mc[0], 6, 'Landfill', {fs:8}); cx+=mc[0];
cell(cx, mc[1], 6, landfillTons.toFixed(2), {fs:8, align:'right'}); cx+=mc[1];
cell(cx, mc[2], 6, (totalTons>0?Math.round(landfillTons/totalTons*100):0)+'%', {fs:8, align:'right'}); cx+=mc[2];
cell(cx, mc[3], 6, 'Municipal Landfill', {fs:7}); cx+=mc[3];
cell(cx, mc[4], 6, 'N/A', {fs:7, tc:[180,83,9], bold:true, align:'center'});
y += 6;

// Totals row
cx = lm;
cell(cx, mc[0], 7, 'TOTAL', {bg:totBg, fs:9, bold:true, tc:DG}); cx+=mc[0];
cell(cx, mc[1], 7, totalTons.toFixed(2), {bg:totBg, fs:9, bold:true, align:'right', tc:DG}); cx+=mc[1];
cell(cx, mc[2], 7, '100%', {bg:totBg, fs:9, bold:true, align:'right', tc:DG}); cx+=mc[2];
cell(cx, mc[3], 7, '', {bg:totBg}); cx+=mc[3];
cell(cx, mc[4], 7, divRate+'% Diverted', {bg:totBg, fs:7, bold:true, tc:DG, align:'center'});
y += 9;

// ===== LOAD DETAILS =====
chkPg(30);
cell(lm, tw, 7, 'LOAD DETAILS', {bg:LG, tc:DG, fs:10, bold:true});
y += 7;

var lc = [20, 16, 18, 20, 20, 18, 14, 14, 13, 13, 13, 13];
var lcSum = lc.reduce(function(a,b){return a+b},0);
var lcS = tw / lcSum;
lc = lc.map(function(w) { return w * lcS; });

var lHeaders = ['Date','Ticket #','Hauler','Gross (lbs)','Tare (lbs)','Net (lbs)','Tons','OCC %','Wood %','Metal %','Plastic %','Diversion %'];

function drawLoadHeader() {
    var lx = lm;
    lHeaders.forEach(function(h,i) {
        cell(lx, lc[i], 7, h, {bg:MG, tc:[255,255,255], fs:7, bold:true, align:'center'});
        lx += lc[i];
    });
    y += 7;
}
drawLoadHeader();

data.forEach(function(t, idx) {
    chkPg(7);
    if (y === 10) drawLoadHeader(); // redraw header on new page
    var bg = idx % 2 === 0 ? WHT : ALT;
    var dp = t.diversion_pct || 0;
    var dpTc = dp >= 75 ? [27,122,61] : [180,83,9];
    var lx = lm;
    var vals = [
        t.service_date || '',
        t.ticket_number || '',
        (t.hauler||'').substring(0,12),
        (t.gross_lbs||0).toLocaleString(),
        (t.tare_lbs||0).toLocaleString(),
        (t.net_lbs||0).toLocaleString(),
        (t.net_tons||0).toFixed(2),
        (t.cardboard_pct||0)+'%',
        (t.wood_pct||0)+'%',
        (t.metal_pct||0)+'%',
        (t.plastic_pct||0)+'%',
        dp+'%'
    ];
    vals.forEach(function(v,i) {
        var colTc = (i === vals.length-1) ? dpTc : [0,0,0];
        var colBold = (i === vals.length-1);
        cell(lx, lc[i], 6, v, {bg:bg, fs:7, align: i>=3?'right':'left', tc:colTc, bold:colBold});
        lx += lc[i];
    });
    y += 6;
});

// Totals row
chkPg(8);
var tGross = data.reduce(function(s,t){return s+(t.gross_lbs||0)},0);
var tTare = data.reduce(function(s,t){return s+(t.tare_lbs||0)},0);
var tNet = data.reduce(function(s,t){return s+(t.net_lbs||0)},0);
var lx = lm;
['TOTALS','','',tGross.toLocaleString(),tTare.toLocaleString(),tNet.toLocaleString(),totalTons.toFixed(2),'','','','',divRate+'%'].forEach(function(v,i) {
    cell(lx, lc[i], 7, v, {bg:totBg, fs:7, bold:true, align: i>=3?'right':'left', tc:DG});
    lx += lc[i];
});
y += 10;

// ===== FACILITY ATTESTATION =====
chkPg(35);
cell(lm, tw, 7, 'FACILITY ATTESTATION', {bg:LG, tc:DG, fs:10, bold:true});
y += 9;

doc.setFontSize(8); doc.setFont('helvetica','normal'); doc.setTextColor(0,0,0);
doc.text('This report was generated from verified scale ticket data processed through the DivertScanâ„¢ waste tracking system.', lm+2, y);
y += 4;
doc.text('All materials were received, sorted, and routed to documented end markets by Dalmex Recycling LLC.', lm+2, y);
y += 4;
doc.text('Diversion calculations are based on actual weighed tonnage with chain-of-custody documentation maintained for each load.', lm+2, y);
y += 8;

doc.text('Processing Facility:', lm+2, y);
doc.setFont('helvetica','bold');
doc.text('Dalmex Recycling LLC', lm+2, y+5);
doc.setFont('helvetica','normal'); doc.setFontSize(7);
doc.text('2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', lm+2, y+10);
doc.text('Report Generated: ' + new Date().toLocaleString(), pw/2+10, y+5);

addFtr();

return doc.output('blob');
```

}

// ========== CERTIFICATE OF DESTRUCTION ==========
// Generate Certificate of Destruction directly from a ticket
function generateTicketCOD(ticketId) {
var t = tickets.find(function(tk) { return tk.id === ticketId; });
if (!t) { toast(â€˜Ticket not foundâ€™, â€˜errorâ€™); return; }

```
try {
    var jsPDFLib = window.jspdf;
    var doc = new jsPDFLib.jsPDF('portrait');
    var pw = doc.internal.pageSize.width;
    var ph = doc.internal.pageSize.height;
    var certNum = 'COD-' + (t.ticket_number||'0000') + '-' + Date.now().toString(36).toUpperCase().slice(-4);
    var dateStr = t.service_date ? new Date(t.service_date + 'T12:00:00').toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : new Date().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'});
    var netLbs = t.net_lbs || ((t.gross_lbs||0) - (t.tare_lbs||0));
    var netTons = (t.net_tons || (netLbs/2000)).toFixed(3);
    
    // Determine primary material
    var matPcts = [
        {name:'Wood/Pallets', pct:t.wood_pct||0},
        {name:'OCC/Paper/Fiber', pct:t.cardboard_pct||0},
        {name:'Metal/Scrap', pct:t.metal_pct||0},
        {name:'Plastic', pct:t.plastic_pct||0},
        {name:'Concrete', pct:t.concrete_pct||0},
        {name:'Drywall', pct:t.drywall_pct||0}
    ];
    matPcts.sort(function(a,b){return b.pct-a.pct});
    var primaryMat = matPcts[0].pct > 0 ? matPcts[0].name : 'Mixed C&D';
    var matBreakdown = matPcts.filter(function(m){return m.pct>0}).map(function(m){return m.name+': '+m.pct+'%'}).join(', ');
    if (t.landfill_pct && t.landfill_pct > 0) matBreakdown += ', Landfill: '+t.landfill_pct+'%';
    
    // Border
    doc.setDrawColor(45,90,39); doc.setLineWidth(2);
    doc.rect(8,8,pw-16,ph-16);
    doc.setLineWidth(0.5);
    doc.rect(11,11,pw-22,ph-22);
    
    var y = 28;
    
    // Header
    doc.setFillColor(45,90,39);
    doc.rect(14,y-8,pw-28,22,'F');
    doc.setTextColor(255); doc.setFontSize(18); doc.setFont('helvetica','bold');
    doc.text('CERTIFICATE OF DESTRUCTION', pw/2, y+2, {align:'center'});
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', pw/2, y+10, {align:'center'});
    doc.setTextColor(0);
    y += 24;
    
    // Certificate number
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('Certificate No: ' + certNum, 20, y);
    doc.text('Date Issued: ' + new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}), pw-20, y, {align:'right'});
    y += 12;
    
    // Details grid
    doc.setFillColor(248,250,252);
    doc.roundedRect(14,y,pw-28,65,3,3,'F');
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    var dy = y + 10;
    function addRow(label, val) {
        doc.setFont('helvetica','bold'); doc.text(label, 20, dy);
        doc.setFont('helvetica','normal'); doc.text(String(val||'N/A'), 75, dy);
        dy += 7;
    }
    addRow('Customer:', currentProject ? currentProject.name : 'N/A');
    addRow('Ticket #:', t.ticket_number || 'N/A');
    addRow('Service Date:', dateStr);
    addRow('Hauler:', t.hauler || 'N/A');
    addRow('Gross Weight:', (t.gross_lbs||0).toLocaleString() + ' lbs');
    addRow('Tare Weight:', (t.tare_lbs||0).toLocaleString() + ' lbs');
    addRow('Net Weight:', netLbs.toLocaleString() + ' lbs (' + netTons + ' tons)');
    addRow('Primary Material:', primaryMat);
    y += 72;
    
    // Material breakdown
    if (matBreakdown) {
        doc.setFontSize(10); doc.setFont('helvetica','bold');
        doc.text('Material Composition:', 20, y); y += 7;
        doc.setFontSize(9); doc.setFont('helvetica','normal');
        doc.text(matBreakdown, 20, y); y += 10;
    }
    
    // Method
    doc.setFontSize(10); doc.setFont('helvetica','bold');
    doc.text('Destruction / Processing Method:', 20, y); y += 7;
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('Material has been processed through Dalmex Recycling LLC sorting and recycling facility.', 20, y); y += 5;
    doc.text('Recyclable materials separated and routed to verified end markets. Residual waste disposed at licensed landfill.', 20, y);
    y += 14;
    
    // Diversion
    var divPct = t.diversion_pct || 0;
    doc.setFillColor(divPct >= 75 ? 220 : 255, divPct >= 75 ? 252 : 243, divPct >= 75 ? 231 : 243);
    doc.roundedRect(14,y,pw-28,16,3,3,'F');
    doc.setFontSize(11); doc.setFont('helvetica','bold');
    doc.setTextColor(divPct >= 75 ? 21 : 180, divPct >= 75 ? 87 : 83, divPct >= 75 ? 36 : 9);
    doc.text('Diversion Rate: ' + divPct + '% â€” ' + (divPct>=75?'LEED Compliant':'Below LEED Target'), pw/2, y+11, {align:'center'});
    doc.setTextColor(0);
    y += 24;
    
    // Attestation statement
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.text('The above-described materials have been received and processed by Dalmex Recycling LLC in accordance', 20, y); y += 5;
    doc.text('with all applicable federal, state, and local environmental regulations. Recyclable materials were', 20, y); y += 5;
    doc.text('separated and routed to verified end markets. Chain-of-custody documentation maintained for this load.', 20, y);
    y += 12;
    
    // Facility info block
    doc.setFillColor(248,250,252);
    doc.roundedRect(14,y,pw-28,20,3,3,'F');
    doc.setFontSize(8); doc.setFont('helvetica','bold');
    doc.text('Processing Facility: Dalmex Recycling LLC', 20, y+7);
    doc.setFont('helvetica','normal');
    doc.text('2828 Nagle St., Dallas, TX 75220 | (214) 352-2000 | Report Generated: ' + new Date().toLocaleString(), 20, y+14);
    
    // Footer
    doc.setFontSize(7); doc.setTextColor(128);
    doc.text('Dalmex Recycling LLC | TCEQ Permit | Generated by DivertScanâ„¢ v7.7', pw/2, ph-14, {align:'center'});
    doc.text(certNum, pw/2, ph-10, {align:'center'});
    
    // Save
    var filename = 'COD_Ticket_' + (t.ticket_number||'0000') + '_' + new Date().toISOString().split('T')[0] + '.pdf';
    doc.save(filename);
    toast('Certificate of Destruction generated for Ticket #' + (t.ticket_number||'N/A'), 'success');
} catch(err) {
    toast('COD error: ' + err.message, 'error');
}
```

}

function generateCertificateOfDestruction() {
const customer = document.getElementById(â€˜codCustomerNameâ€™).value.trim();
const ticketNum = document.getElementById(â€˜codTicketNumberâ€™).value.trim();
const serviceDate = document.getElementById(â€˜codServiceDateâ€™).value;
const materialType = document.getElementById(â€˜codMaterialTypeâ€™).value;
const netWeight = parseFloat(document.getElementById(â€˜codNetWeightâ€™).value) || 0;
const grossWeight = parseFloat(document.getElementById(â€˜codGrossWeightâ€™).value) || 0;
const tareWeight = parseFloat(document.getElementById(â€˜codTareWeightâ€™).value) || 0;
const method = document.getElementById(â€˜codMethodâ€™).value;
const notes = document.getElementById(â€˜codNotesâ€™).value.trim();

```
if (!customer) { toast('Customer name is required', 'error'); return; }
if (!ticketNum) { toast('Ticket number is required', 'error'); return; }
if (!netWeight) { toast('Net weight is required', 'error'); return; }

const { jsPDF } = window.jspdf;
const doc = new jsPDF('portrait');
const pw = doc.internal.pageSize.width;
const ph = doc.internal.pageSize.height;
const certNum = 'COD-' + ticketNum + '-' + Date.now().toString(36).toUpperCase().slice(-4);
const dateStr = serviceDate ? new Date(serviceDate + 'T12:00:00').toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }) : new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' });
const netTons = (netWeight / 2000).toFixed(3);

// === DECORATIVE BORDER ===
doc.setDrawColor(45, 90, 39); // DalMex green
doc.setLineWidth(2);
doc.rect(8, 8, pw - 16, ph - 16);
doc.setLineWidth(0.5);
doc.rect(11, 11, pw - 22, ph - 22);

let y = 28;

// === HEADER ===
doc.setFillColor(45, 90, 39);
doc.rect(14, y - 8, pw - 28, 22, 'F');
doc.setTextColor(255);
doc.setFontSize(18);
doc.setFont('helvetica', 'bold');
doc.text('CERTIFICATE OF DESTRUCTION', pw / 2, y + 2, { align: 'center' });
doc.setFontSize(9);
doc.setFont('helvetica', 'normal');
doc.text('Secure Material Destruction & Recycling Verification', pw / 2, y + 10, { align: 'center' });
doc.setTextColor(0);
y += 24;

// === CERTIFICATE NUMBER & DATE ===
doc.setFillColor(248, 250, 252);
doc.roundedRect(14, y, pw - 28, 14, 2, 2, 'F');
doc.setFontSize(9);
doc.setFont('helvetica', 'bold');
doc.text('Certificate No: ' + certNum, 20, y + 6);
doc.text('Date Issued: ' + new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }), 20, y + 11);
doc.text('Scale Ticket #: ' + ticketNum, pw - 20, y + 6, { align: 'right' });
doc.text('Date of Service: ' + dateStr, pw - 20, y + 11, { align: 'right' });
y += 22;

// === FACILITY INFO ===
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.setTextColor(45, 90, 39);
doc.text('PROCESSING FACILITY', 14, y);
doc.setTextColor(0);
y += 6;
doc.setFontSize(9);
doc.setFont('helvetica', 'normal');
doc.text('DalMex Recycling LLC', 14, y); y += 5;
doc.text('2828 Nagle St., Dallas, TX 75220', 14, y); y += 5;
doc.text('Phone: (214) 352-2000  |  Fax: (214) 352-2002', 14, y); y += 5;
doc.text('Facility Type: Construction & Demolition Waste Processing / Recycling Center', 14, y);
y += 12;

// === CUSTOMER INFO ===
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.setTextColor(45, 90, 39);
doc.text('CUSTOMER', 14, y);
doc.setTextColor(0);
y += 6;
doc.setFontSize(11);
doc.setFont('helvetica', 'bold');
doc.text(customer, 14, y);
y += 12;

// === MATERIAL DETAILS TABLE ===
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.setTextColor(45, 90, 39);
doc.text('MATERIAL DETAILS', 14, y);
doc.setTextColor(0);
y += 8;

// Table
const rows = [
    ['Material Type', materialType],
    ['Gross Weight', grossWeight > 0 ? grossWeight.toLocaleString() + ' lbs' : 'N/A'],
    ['Tare Weight', tareWeight > 0 ? tareWeight.toLocaleString() + ' lbs' : 'N/A'],
    ['Net Weight', netWeight.toLocaleString() + ' lbs (' + netTons + ' tons)'],
    ['Destruction Method', method]
];

if (notes) rows.push(['Remarks', notes]);

const labelW = 55;
const valueW = pw - 28 - labelW;

rows.forEach((row, i) => {
    const bg = i % 2 === 0 ? [248, 250, 252] : [255, 255, 255];
    doc.setFillColor(bg[0], bg[1], bg[2]);
    doc.rect(14, y, labelW, 8, 'F');
    doc.rect(14 + labelW, y, valueW, 8, 'F');
    doc.setDrawColor(200);
    doc.rect(14, y, labelW, 8);
    doc.rect(14 + labelW, y, valueW, 8);
    
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text(row[0], 17, y + 5.5);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text(row[1], 17 + labelW, y + 5.5);
    y += 8;
});

y += 10;

// === ATTESTATION STATEMENT ===
doc.setFontSize(10);
doc.setFont('helvetica', 'bold');
doc.setTextColor(45, 90, 39);
doc.text('FACILITY ATTESTATION', 14, y);
doc.setTextColor(0);
y += 8;

doc.setFontSize(9);
doc.setFont('helvetica', 'normal');
const certText = [
    'The materials described above, received from ' + customer + ' on',
    dateStr + ' (Scale Ticket #' + ticketNum + '), have been processed at Dalmex Recycling LLC',
    'in accordance with applicable federal, state, and local regulations.',
    '',
    'Processing method: ' + method + '.',
    '',
    'Recyclable materials were separated and routed to verified end markets.',
    'Chain-of-custody documentation is maintained for this load.',
    '',
    'Diversion calculations are based on actual weighed tonnage.',
    'This document is generated from the DivertScanâ„¢ waste tracking system.'
];

certText.forEach(line => {
    doc.text(line, 14, y);
    y += line === '' ? 3 : 5;
});

y += 8;

// === DOWNSTREAM FACILITY (for paper) ===
if (materialType.includes('Paper') || materialType.includes('SOP') || materialType.includes('OCC') || materialType.includes('Cardboard') || materialType.includes('Confidential')) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(45, 90, 39);
    doc.text('END MARKET DESTINATION', 14, y);
    doc.setTextColor(0);
    y += 6;
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('Material processed at Dalmex Recycling LLC and shipped to verified domestic end markets', 14, y); y += 5;
    doc.text('including Georgia Pacific, Smurfit Westrock, Greenside, International Paper, and', 14, y); y += 5;
    doc.text('American Fiber for final pulping and recycling. Chain of custody documentation maintained.', 14, y);
    y += 12;
}

// === FACILITY BLOCK ===
doc.setFillColor(248,250,252);
doc.roundedRect(14, y, pw-28, 18, 3, 3, 'F');
doc.setFontSize(8); doc.setFont('helvetica','bold');
doc.text('Processing Facility: Dalmex Recycling LLC', 18, y+7);
doc.setFont('helvetica','normal');
doc.text('2828 Nagle St., Dallas, TX 75220 | (214) 352-2000 | Report Generated: ' + new Date().toLocaleString(), 18, y+13);

// === FOOTER ===
doc.setFontSize(7);
doc.setTextColor(128);
doc.text('This certificate was generated by DivertScanâ„¢ Waste Tracking System | ' + new Date().toLocaleString(), pw / 2, ph - 14, { align: 'center' });
doc.text('DalMex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', pw / 2, ph - 10, { align: 'center' });

// === SAVE ===
const filename = 'Certificate_of_Destruction_' + customer.replace(/[^a-z0-9]/gi, '_') + '_' + ticketNum + '_' + (serviceDate || new Date().toISOString().split('T')[0]) + '.pdf';
doc.save(filename);

toast('Certificate of Destruction generated for ' + customer, 'success');
```

}

// ========== TOGGLE SECTIONS ==========
function toggleSection(sectionId) {
const content = document.getElementById(sectionId + â€˜Contentâ€™);
const arrow = document.getElementById(sectionId + â€˜Arrowâ€™);

```
if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    arrow.textContent = 'â–²';
} else {
    content.classList.add('hidden');
    arrow.textContent = 'â–¼';
}
```

}

// ========== PROJECT SELECT (moved here) ==========
function selectProject(projectId) {
currentProject = projects.find(p => p.id === projectId);
if (currentProject) {
localStorage.setItem(â€˜divertscan_current_projectâ€™, JSON.stringify(currentProject));
}
// Clear stale report data when switching projects
resetReportState();
updateProjectDisplay();
renderProjectsList();
// Load ALL tickets for this project (not limited to 50)
loadAllTicketsForProject();
toast(â€™Project: â€™ + (currentProject?.name || â€˜Unknownâ€™), â€˜successâ€™);
}

// Load all tickets for the current project â€” no limit, updates everything
async function loadAllTicketsForProject() {
if (!currentProject) { console.warn(â€˜loadAllTicketsForProject: no currentProjectâ€™); return; }

```
console.log('Loading tickets for:', currentProject.name, 'ID:', currentProject.id);

try {
    var remoteT = [];
    var localT = [];
    var fetches = [];
    
    if (sb) {
        fetches.push(
            Promise.race([
                sb.from('tickets').select('*').eq('project_id', currentProject.id).order('created_at', {ascending:false}),
                new Promise(function(_,r){setTimeout(function(){r(new Error('Supabase timeout after 10s'))},10000)})
            ]).then(function(res){ 
                if(res && !res.error && res.data) {
                    remoteT = res.data;
                    console.log('Supabase returned ' + res.data.length + ' tickets for project_id=' + currentProject.id);
                } else if (res && res.error) {
                    console.error('Supabase ticket error:', res.error.message);
                }
            })
            .catch(function(e){ console.warn('Ticket fetch failed:', e.message); })
        );
    } else {
        console.warn('Supabase client (sb) is NULL â€” tickets will only come from IndexedDB');
    }
    
    fetches.push((async function(){
        try {
            var all = await getAllFromLocal('tickets') || [];
            localT = all.filter(function(t){return t.project_id === currentProject.id});
            console.log('IndexedDB: ' + localT.length + ' matching tickets (of ' + all.length + ' total local)');
        } catch(e){ console.warn('IndexedDB tickets error:', e); }
    })());
    
    await Promise.all(fetches);
    
    // Merge and dedupe
    var map = new Map();
    localT.forEach(function(t){map.set(t.ticket_number||t.id, t)});
    remoteT.forEach(function(t){map.set(t.ticket_number||t.id, t)});
    tickets = Array.from(map.values());
    tickets.sort(function(a,b){return new Date(b.created_at||b.service_date)-new Date(a.created_at||a.service_date)});
    
    console.log('Total merged tickets for ' + currentProject.name + ': ' + tickets.length);
    
    renderRecentTickets();
    updateTicketCount();
    updateStats();
    updateLeedPredictor();
} catch(e) {
    console.error('Error loading tickets:', e);
}
```

}

// Reset all report containers to prevent ghosting between projects
function resetReportState() {
reportData = [];

```
// Clear report header fields
var rFields = ['reportProjectName','reportProjectAddress','reportProjectGC','reportProjectHauler','reportDate','reportGeneratedDate','reportPeriod','reportTicketCount','reportLoadCount','reportTotalTons','reportDivertedTons','reportLandfillTons','reportTotalDiverted','reportTotalLandfill'];
rFields.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.textContent = '-';
});

// Clear diversion rate
var rateEl = document.getElementById('reportDiversionRate');
if (rateEl) { rateEl.textContent = '-'; rateEl.style.color = 'var(--text-muted)'; }

// Clear LEED status
var statusEl = document.getElementById('reportLeedStatus');
if (statusEl) { statusEl.textContent = '-'; statusEl.style.color = 'var(--text-muted)'; }

// Clear material breakdown
var matEl = document.getElementById('reportMaterialBreakdown');
if (matEl) matEl.innerHTML = '<p style="color:var(--slate-500);font-size:12px">Select a project and generate report</p>';

// Clear load details
var contentEl = document.getElementById('reportContent');
if (contentEl) contentEl.innerHTML = '';

// Clear AI Summary
var aiResult = document.getElementById('aiSummaryResult');
var aiActions = document.getElementById('aiSummaryActions');
if (aiResult) { aiResult.innerHTML = ''; aiResult.classList.add('hidden'); }
if (aiActions) aiActions.classList.add('hidden');

// Hide download buttons until new report is generated
var dlBtns = document.getElementById('reportDownloadBtns');
if (dlBtns) dlBtns.style.display = 'none';

// Sync report project dropdown
var reportSel = document.getElementById('reportProjectSelect');
if (reportSel && currentProject) reportSel.value = currentProject.id;
```

}

// ========== IMPORT / EXPORT ==========
async function exportAllProjects() {
showLoading(â€˜Exportingâ€¦â€™);

```
try {
    let projectsData = [];
    let ticketsData = [];
    
    // Get from local first
    try {
        projectsData = await getAllFromLocal('projects') || [];
        ticketsData = await getAllFromLocal('tickets') || [];
    } catch (e) { console.log('Local export error:', e); }
    
    // Try Supabase with timeout for additional data
    if (sb) {
        try {
            const tp = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
            const pRes = await Promise.race([sb.from('projects').select('*'), tp]);
            const tRes = await Promise.race([sb.from('tickets').select('*'), tp]);
            if (pRes?.data) {
                pRes.data.forEach(p => { if (!projectsData.find(lp => lp.id === p.id)) projectsData.push(p); });
            }
            if (tRes?.data) {
                tRes.data.forEach(t => { if (!ticketsData.find(lt => lt.ticket_number === t.ticket_number)) ticketsData.push(t); });
            }
        } catch (e) { console.log('Supabase export skipped:', e.message); }
    }
    
    const exportData = {
        exported_at: new Date().toISOString(),
        version: '7.4',
        projects: projectsData,
        tickets: ticketsData
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DivertScan_Export_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    hideLoading();
    toast(`Export complete! ${projectsData.length} projects, ${ticketsData.length} tickets`, 'success');
} catch (err) {
    hideLoading();
    toast('Export error: ' + err.message, 'error');
}
```

}

async function importProjects(event) {
const file = event.target.files[0];
if (!file) return;

```
showLoading('Importing...');

try {
    const text = await file.text();
    const data = JSON.parse(text);
    
    if (data.projects && Array.isArray(data.projects)) {
        for (const p of data.projects) {
            delete p.id; // Let Supabase assign new IDs
            await sb.from('projects').insert([p]);
        }
    }
    
    hideLoading();
    toast('Import complete! Refresh to see changes.', 'success');
    loadProjects();
} catch (err) {
    hideLoading();
    toast('Import error: ' + err.message, 'error');
}

event.target.value = ''; // Reset file input
```

}

async function exportAllTickets() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}

```
showLoading('Exporting tickets...');

try {
    const { data } = await sb.from('tickets').select('*').eq('project_id', currentProject.id);
    
    // Create CSV
    const headers = ['Date', 'Ticket #', 'Hauler', 'Container', 'Gross Lbs', 'Tare Lbs', 'Net Tons',
                    'Wood %', 'Concrete %', 'Metal %', 'Cardboard %', 'Plastic %', 'Drywall %', 'Landfill %',
                    'Diversion %', 'Human Verified', 'GPS Lat', 'GPS Long'];
    
    const rows = (data || []).map(t => [
        t.service_date, t.ticket_number, t.hauler, t.container_size,
        t.gross_lbs, t.tare_lbs, t.net_tons,
        t.wood_pct, t.concrete_pct, t.metal_pct, t.cardboard_pct, t.plastic_pct, t.drywall_pct, t.landfill_pct,
        t.diversion_pct, t.human_verified ? 'Yes' : 'No', t.gps_latitude, t.gps_longitude
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentProject.name.replace(/[^a-z0-9]/gi, '_')}_Tickets_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    hideLoading();
    toast('Tickets exported!', 'success');
} catch (err) {
    hideLoading();
    toast('Export error: ' + err.message, 'error');
}
```

}

async function exportAuditPackage() {
toast(â€˜Audit package export - Coming soon! For now, use PDF + CSV exports.â€™, â€˜infoâ€™);
}

function downloadReportExcel() {
if ((!reportData || reportData.length === 0) && tickets.length > 0 && currentProject) {
reportData = tickets.filter(function(t){return t.project_id === currentProject.id});
}
if (!reportData || reportData.length === 0) {
toast(â€˜No tickets found â€” select a project with ticketsâ€™, â€˜errorâ€™);
return;
}
if (typeof ExcelJS === â€˜undefinedâ€™) {
toast(â€˜Excel library not loaded â€” refresh and try againâ€™, â€˜errorâ€™);
return;
}

```
try {
    var wb = new ExcelJS.Workbook();
    wb.creator = 'DivertScanâ„¢';
    wb.created = new Date();
    
    // Group tickets by month
    var monthGroups = {};
    reportData.forEach(function(t) {
        if (!t.service_date) return;
        var d = new Date(t.service_date + 'T12:00:00');
        var key = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        if (!monthGroups[key]) monthGroups[key] = [];
        monthGroups[key].push(t);
    });
    
    var monthKeys = Object.keys(monthGroups).sort(function(a, b) {
        return new Date('1 ' + a) - new Date('1 ' + b);
    });
    
    if (monthKeys.length === 0) {
        monthKeys = ['Report'];
        monthGroups['Report'] = reportData;
    }
    
    // Style constants
    var blueFill = { type:'pattern', pattern:'solid', fgColor:{argb:'FF4472C4'} };
    var lightBlueFill = { type:'pattern', pattern:'solid', fgColor:{argb:'FFD9E2F3'} };
    var whiteFont = { name:'Arial', size:10, bold:true, color:{argb:'FFFFFFFF'} };
    var titleFont = { name:'Arial', size:14, bold:true };
    var infoFont = { name:'Arial', size:10 };
    var dataFont = { name:'Arial', size:10 };
    var boldFont = { name:'Arial', size:10, bold:true };
    var thinBorder = {
        top:{style:'thin',color:{argb:'FFB4B4B4'}},
        bottom:{style:'thin',color:{argb:'FFB4B4B4'}},
        left:{style:'thin',color:{argb:'FFB4B4B4'}},
        right:{style:'thin',color:{argb:'FFB4B4B4'}}
    };
    var colWidths = [12,10,12,10,12,10,12,8,10,10,10,10,10,10,8,10,10,10,10,10,8,10,14,12];
    
    // Headers for row 15
    var headerLabels = [
        'Date','Ticket No','GWT (lbs)','GWT (NT)','Tare (lbs)','Tare (NT)',
        'Net (lbs)','Tons','Wood %','Wood','Gypsum %','Gypsum',
        'Plastic %','Plastic','OCC %','OCC','Metal %','Metal',
        'Concrete %','Concrete','Block %','Block','Total Diverted','Diverted %'
    ];
    
    monthKeys.forEach(function(monthName) {
        var mTickets = monthGroups[monthName];
        if (!mTickets || mTickets.length === 0) return;
        mTickets.sort(function(a, b) { return new Date(a.service_date) - new Date(b.service_date); });
        
        var sheetName = monthName.length > 31 ? monthName.substring(0,31) : monthName;
        var ws = wb.addWorksheet(sheetName);
        
        // Column widths
        ws.columns = colWidths.map(function(w) { return { width: w }; });
        
        // Rows 1-6: Empty (logo area)
        for (var i = 1; i <= 6; i++) ws.addRow([]);
        
        // Row 7: Title (merged A7:H7)
        var titleRow = ws.addRow(['Waste Diversion Report for ' + monthName]);
        ws.mergeCells('A7:H7');
        titleRow.getCell(1).font = titleFont;
        titleRow.height = 22;
        
        // Rows 8-13: Company info
        var infoData = [
            'Hauler: ' + (currentProject.waste_hauler || 'N/A'),
            'Location: ' + (currentProject.address || 'N/A'),
            'Project: ' + (currentProject.name || 'N/A'),
            'Report by: Dalmex Recycling',
            'Contact: Robert Vandling',
            'Email: robert@dalmexrecycling.com'
        ];
        infoData.forEach(function(text) {
            var r = ws.addRow([text]);
            r.getCell(1).font = infoFont;
        });
        
        // Row 14: Empty
        ws.addRow([]);
        
        // Row 15: Column headers â€” blue fill, white bold text
        var headerRow = ws.addRow(headerLabels);
        headerRow.height = 18;
        headerRow.eachCell(function(cell) {
            cell.fill = blueFill;
            cell.font = whiteFont;
            cell.alignment = { horizontal:'center', vertical:'middle', wrapText:true };
            cell.border = thinBorder;
        });
        
        // Data rows (row 16+)
        mTickets.forEach(function(t) {
            var netTons = (t.net_tons || 0);
            var grossTons = (t.gross_lbs || 0) / 2000;
            var tareTons = (t.tare_lbs || 0) / 2000;
            var woodPct = (t.wood_pct || 0) / 100;
            var gypsumPct = (t.drywall_pct || 0) / 100;
            var plasticPct = (t.plastic_pct || 0) / 100;
            var occPct = (t.cardboard_pct || 0) / 100;
            var metalPct = (t.metal_pct || 0) / 100;
            var concretePct = (t.concrete_pct || 0) / 100;
            var blockPct = 0;
            var totalDiv = netTons * (woodPct + gypsumPct + plasticPct + occPct + metalPct + concretePct);
            var divPct = netTons > 0 ? totalDiv / netTons : 0;
            
            var dateVal = t.service_date ? new Date(t.service_date + 'T12:00:00') : null;
            
            var r = ws.addRow([
                dateVal, t.ticket_number || '', t.gross_lbs || 0, grossTons,
                t.tare_lbs || 0, tareTons, t.net_lbs || 0, netTons,
                woodPct, netTons * woodPct, gypsumPct, netTons * gypsumPct,
                plasticPct, netTons * plasticPct, occPct, netTons * occPct,
                metalPct, netTons * metalPct, concretePct, netTons * concretePct,
                blockPct, 0, totalDiv, divPct
            ]);
            
            r.eachCell(function(cell, colNumber) {
                cell.font = dataFont;
                cell.border = thinBorder;
                cell.alignment = { horizontal:'center' };
                
                // Number formats
                if (colNumber === 1 && dateVal) cell.numFmt = 'm/d/yyyy';
                else if (colNumber === 3 || colNumber === 5 || colNumber === 7) cell.numFmt = '#,##0';
                else if (colNumber === 4 || colNumber === 6 || colNumber === 8 || colNumber === 10 || colNumber === 12 || colNumber === 14 || colNumber === 16 || colNumber === 18 || colNumber === 20 || colNumber === 22 || colNumber === 23) cell.numFmt = '0.00';
                else if (colNumber === 9 || colNumber === 11 || colNumber === 13 || colNumber === 15 || colNumber === 17 || colNumber === 19 || colNumber === 21 || colNumber === 24) cell.numFmt = '0%';
            });
        });
        
        // 2 empty rows
        ws.addRow([]);
        ws.addRow([]);
        
        // Totals row â€” bold, light blue fill
        var tGross = mTickets.reduce(function(s,t){return s+(t.gross_lbs||0)},0);
        var tTare = mTickets.reduce(function(s,t){return s+(t.tare_lbs||0)},0);
        var tNet = mTickets.reduce(function(s,t){return s+(t.net_lbs||0)},0);
        var tNetTons = mTickets.reduce(function(s,t){return s+(t.net_tons||0)},0);
        var tWood = 0, tGypsum = 0, tPlastic = 0, tOCC = 0, tMetal = 0, tConcrete = 0;
        mTickets.forEach(function(t) {
            var nt = t.net_tons || 0;
            tWood += nt * (t.wood_pct||0)/100;
            tGypsum += nt * (t.drywall_pct||0)/100;
            tPlastic += nt * (t.plastic_pct||0)/100;
            tOCC += nt * (t.cardboard_pct||0)/100;
            tMetal += nt * (t.metal_pct||0)/100;
            tConcrete += nt * (t.concrete_pct||0)/100;
        });
        var tDiverted = tWood + tGypsum + tPlastic + tOCC + tMetal + tConcrete;
        var tDivPct = tNetTons > 0 ? tDiverted / tNetTons : 0;
        
        var totRow = ws.addRow([
            'Totals', '', tGross, tGross/2000, tTare, tTare/2000, tNet, tNetTons,
            tNetTons > 0 ? tWood/tNetTons : 0, tWood,
            tNetTons > 0 ? tGypsum/tNetTons : 0, tGypsum,
            tNetTons > 0 ? tPlastic/tNetTons : 0, tPlastic,
            tNetTons > 0 ? tOCC/tNetTons : 0, tOCC,
            tNetTons > 0 ? tMetal/tNetTons : 0, tMetal,
            tNetTons > 0 ? tConcrete/tNetTons : 0, tConcrete,
            0, 0, tDiverted, tDivPct
        ]);
        
        totRow.eachCell(function(cell, colNumber) {
            cell.fill = lightBlueFill;
            cell.font = boldFont;
            cell.border = thinBorder;
            cell.alignment = { horizontal:'center' };
            
            if (colNumber === 3 || colNumber === 5 || colNumber === 7) cell.numFmt = '#,##0';
            else if (colNumber === 4 || colNumber === 6 || colNumber === 8 || colNumber === 10 || colNumber === 12 || colNumber === 14 || colNumber === 16 || colNumber === 18 || colNumber === 20 || colNumber === 22 || colNumber === 23) cell.numFmt = '0.00';
            else if (colNumber === 9 || colNumber === 11 || colNumber === 13 || colNumber === 15 || colNumber === 17 || colNumber === 19 || colNumber === 21 || colNumber === 24) cell.numFmt = '0.00%';
        });
        
        // Summary section
        ws.addRow([]);
        var s1 = ws.addRow(['Total  Tonnage', tNetTons]);
        s1.getCell(1).font = boldFont;
        s1.getCell(2).font = boldFont;
        s1.getCell(2).numFmt = '0.00';
        
        var s2 = ws.addRow(['Diverted from landfill', tDiverted]);
        s2.getCell(1).font = boldFont;
        s2.getCell(2).font = boldFont;
        s2.getCell(2).numFmt = '0.00';
        
        var s3 = ws.addRow(['Recycled Material %', tDivPct]);
        s3.getCell(1).font = boldFont;
        s3.getCell(2).font = boldFont;
        s3.getCell(2).numFmt = '0%';
    });
    
    // Write and download
    var filename = (currentProject.name || 'Project').replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().getFullYear() + '.xlsx';
    
    wb.xlsx.writeBuffer().then(function(buffer) {
        var blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        toast('Excel report downloaded! (' + monthKeys.length + ' month sheet' + (monthKeys.length > 1 ? 's' : '') + ')', 'success');
    }).catch(function(err) {
        console.error('Excel write error:', err);
        toast('Excel export failed: ' + err.message, 'error');
    });
    
} catch (err) {
    console.error('Excel export error:', err);
    toast('Excel export failed: ' + err.message, 'error');
}
```

}

// ========== BOX TRACKER EXCEL REPORT ==========
function downloadBoxTrackerExcel() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}
if (typeof XLSX === â€˜undefinedâ€™) {
toast(â€˜Excel library not loaded - refresh pageâ€™, â€˜errorâ€™);
return;
}

```
var data = (reportData && reportData.length > 0) ? reportData : tickets;
if (!data || data.length === 0) {
    toast('No ticket data available', 'error');
    return;
}

try {
    data.sort(function(a, b) { return new Date(a.service_date) - new Date(b.service_date); });
    
    var wb = XLSX.utils.book_new();
    var rows = [];

    // Header section
    rows.push(['DivertScanâ„¢ LEED Diversion Report â€” ' + (currentProject.name || 'Project')]);
    rows.push(['Processing Facility: Dalmex Recycling LLC, 2828 Nagle St., Dallas, TX 75220']);
    rows.push(['Hauler: ' + (currentProject.waste_hauler || '')]);
    rows.push(['Location: ' + (currentProject.address || '')]);
    rows.push(['General Contractor: ' + (currentProject.general_contractor || '')]);
    rows.push(['Generated: ' + new Date().toLocaleString()]);
    rows.push([]);

    // Column headers
    var headers = ['Date','Ticket No','GWT (lbs)','GWT (NT)','Tare (lbs)','Tare (NT)',
        'Net (lbs)','Tons','OCC %','OCC Tons','Wood %','Wood Tons',
        'Metal %','Metal Tons','Plastic %','Plastic Tons',
        'Total Diverted','Diverted %','Landfill Tons','Landfill %'];
    rows.push(headers);

    // Data rows
    var tGross=0,tTare=0,tNet=0,tTons=0,tOCC=0,tWood=0,tMet=0,tPlas=0,tDiv=0,tLF=0;
    data.forEach(function(t) {
        var gross = t.gross_lbs || 0;
        var tare = t.tare_lbs || 0;
        var net = t.net_lbs || (gross - tare);
        var tons = t.net_tons || (net / 2000);
        var occP = (t.cardboard_pct || 0) / 100;
        var woodP = (t.wood_pct || 0) / 100;
        var metalP = (t.metal_pct || 0) / 100;
        var plasticP = (t.plastic_pct || 0) / 100;
        var occT = tons * occP;
        var woodT = tons * woodP;
        var metalT = tons * metalP;
        var plasticT = tons * plasticP;
        var totalDiv = occT + woodT + metalT + plasticT;
        var divPct = tons > 0 ? totalDiv / tons : 0;
        var lfTons = t.landfill_tons || (tons - totalDiv);
        var lfPct = tons > 0 ? lfTons / tons : 0;

        tGross += gross; tTare += tare; tNet += net; tTons += tons;
        tOCC += occT; tWood += woodT; tMet += metalT; tPlas += plasticT;
        tDiv += totalDiv; tLF += lfTons;

        rows.push([
            t.service_date ? new Date(t.service_date) : '',
            parseInt(t.ticket_number) || t.ticket_number || '',
            gross, gross / 2000,
            tare, tare / 2000,
            net, tons,
            occP, occT,
            woodP, woodT,
            metalP, metalT,
            plasticP, plasticT,
            totalDiv, divPct,
            lfTons, lfPct
        ]);
    });

    // Blank row then Totals
    rows.push([]);
    rows.push([
        'TOTALS', '',
        tGross, tGross/2000, tTare, tTare/2000, tNet, tTons,
        tTons > 0 ? tOCC/tTons : 0, tOCC,
        tTons > 0 ? tWood/tTons : 0, tWood,
        tTons > 0 ? tMet/tTons : 0, tMet,
        tTons > 0 ? tPlas/tTons : 0, tPlas,
        tDiv, tTons > 0 ? tDiv/tTons : 0,
        tLF, tTons > 0 ? tLF/tTons : 0
    ]);

    // Summary
    rows.push([]);
    rows.push(['Total Tonnage', tTons.toFixed(2)]);
    rows.push(['Diverted from Landfill', tDiv.toFixed(2)]);
    rows.push(['Diversion Rate', tTons > 0 ? (tDiv/tTons*100).toFixed(1) + '%' : '0%']);
    rows.push(['LEED Target', (currentProject.leed_target || 75) + '%']);
    rows.push(['Status', (tTons > 0 && tDiv/tTons*100 >= (currentProject.leed_target || 75)) ? 'COMPLIANT' : 'BELOW TARGET']);
    rows.push([]);
    rows.push(['End Markets:']);
    rows.push(['OCC/Paper', 'Georgia Pacific Â· Smurfit Westrock Â· Greenside Â· Intl Paper Â· American Fiber']);
    rows.push(['Wood', 'Dalmex Pallets (In-House Reuse)']);
    rows.push(['Metal', 'CMC (Commercial Metals) Â· Cyclone Metal Recycling']);
    rows.push(['Plastic', 'Recycle USA']);

    var ws = XLSX.utils.aoa_to_sheet(rows);

    // Apply number formats
    var range = XLSX.utils.decode_range(ws['!ref']);
    for (var R = 8; R <= range.e.r; R++) {
        for (var C = 0; C <= 19; C++) {
            var addr = XLSX.utils.encode_cell({r: R, c: C});
            if (!ws[addr]) continue;
            if (C === 0 && ws[addr].v instanceof Date) ws[addr].z = 'm/d/yyyy';
            else if (C === 2 || C === 4 || C === 6) ws[addr].z = '#,##0';
            else if (C === 3 || C === 5 || C === 7) ws[addr].z = '0.00';
            else if (C === 8 || C === 10 || C === 12 || C === 14 || C === 17 || C === 19) ws[addr].z = '0%';
            else if (C === 9 || C === 11 || C === 13 || C === 15 || C === 16 || C === 18) ws[addr].z = '0.00';
        }
    }

    ws['!cols'] = [
        {wch:12},{wch:10},{wch:12},{wch:10},{wch:12},{wch:10},{wch:12},{wch:8},
        {wch:8},{wch:10},{wch:8},{wch:10},{wch:8},{wch:10},{wch:10},{wch:10},
        {wch:14},{wch:12},{wch:12},{wch:10}
    ];

    XLSX.utils.book_append_sheet(wb, ws, 'Waste Diversion Report');

    var filename = 'DivertScan_LEED_Report_' + (currentProject.name || 'Project').replace(/[^a-zA-Z0-9]/g, '_') + '_' + new Date().toISOString().split('T')[0] + '.xlsx';
    XLSX.writeFile(wb, filename);
    toast('DivertScanâ„¢ report downloaded (single tab, ' + data.length + ' loads)', 'success');
} catch (err) {
    console.error('DivertScanâ„¢ export error:', err);
    toast('DivertScanâ„¢ export failed: ' + err.message, 'error');
}
```

}

// ========== DATA MANAGEMENT - BULK OPERATIONS ==========
let selectedTicketIds = new Set();
let allTicketsLoaded = false;

async function loadAllTickets() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}
showLoading(â€˜Loading all ticketsâ€¦â€™);
try {
let remoteTickets = [];
let localTickets = [];

```
    if (sb) {
        try {
            const sbPromise = sb.from('tickets').select('*')
                .eq('project_id', currentProject.id)
                .order('service_date', { ascending: false })
                .limit(1000);
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 10000));
            const result = await Promise.race([sbPromise, timeoutPromise]);
            if (result && !result.error && result.data) remoteTickets = result.data;
        } catch (e) { console.log('Supabase load all skipped:', e.message); }
    }

    try {
        const allLocal = await getAllFromLocal('tickets') || [];
        localTickets = allLocal.filter(t => t.project_id === currentProject.id);
    } catch (e) { console.log('Local fetch error:', e.message); }

    const ticketMap = new Map();
    localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
    remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));

    tickets = Array.from(ticketMap.values());
    tickets.sort((a, b) => new Date(b.service_date || b.created_at) - new Date(a.service_date || a.created_at));
    allTicketsLoaded = true;
    selectedTicketIds.clear();

    hideLoading();
    renderRecentTickets();
    updateTicketCount();
    toast(`Loaded ${tickets.length} total tickets`, 'success');
} catch (err) {
    hideLoading();
    toast('Error loading tickets: ' + err.message, 'error');
}
```

}

function updateTicketCount() {
const badge = document.getElementById(â€˜ticketCountBadgeâ€™);
if (badge) badge.textContent = tickets.length;
}

function toggleTicketSelect(ticketId, event) {
if (event) event.stopPropagation();
if (selectedTicketIds.has(ticketId)) {
selectedTicketIds.delete(ticketId);
} else {
selectedTicketIds.add(ticketId);
}
updateBulkActionsBar();
// Update checkbox visual
const cb = document.getElementById(â€˜cb-â€™ + ticketId);
if (cb) cb.checked = selectedTicketIds.has(ticketId);
}

function selectAllTickets() {
if (selectedTicketIds.size === tickets.length) {
// Deselect all
selectedTicketIds.clear();
document.getElementById(â€˜selectAllBtnâ€™).textContent = â€˜Select Allâ€™;
} else {
tickets.forEach(t => selectedTicketIds.add(t.id));
document.getElementById(â€˜selectAllBtnâ€™).textContent = â€˜Deselect Allâ€™;
}
updateBulkActionsBar();
// Update all checkboxes
tickets.forEach(t => {
const cb = document.getElementById(â€˜cb-â€™ + t.id);
if (cb) cb.checked = selectedTicketIds.has(t.id);
});
}

function updateBulkActionsBar() {
const bar = document.getElementById(â€˜bulkActionsBarâ€™);
const count = selectedTicketIds.size;
document.getElementById(â€˜selectedCountâ€™).textContent = count;
bar.style.display = count > 0 ? â€˜blockâ€™ : â€˜noneâ€™;
}

async function deleteSelectedTickets() {
const count = selectedTicketIds.size;
if (count === 0) return;
if (!confirm(`Delete ${count} selected ticket${count > 1 ? 's' : ''}? This cannot be undone.`)) return;

```
showLoading(`Deleting ${count} tickets...`);
let deleted = 0;
let failed = 0;

for (const ticketId of selectedTicketIds) {
    try {
        // Delete from Supabase
        if (sb) {
            try {
                await sb.from('tickets').delete().eq('id', ticketId);
            } catch (e) { /* may not exist remotely */ }
        }
        // Delete from local
        try {
            await deleteFromLocal('tickets', ticketId);
        } catch (e) { /* may not exist locally */ }
        deleted++;
    } catch (err) {
        console.error('Delete error:', ticketId, err);
        failed++;
    }
}

tickets = tickets.filter(t => !selectedTicketIds.has(t.id));
selectedTicketIds.clear();

hideLoading();
renderRecentTickets();
updateStats();
updateTicketCount();
updateBulkActionsBar();
toast(`Deleted ${deleted} ticket${deleted !== 1 ? 's' : ''}${failed > 0 ? `, ${failed} failed` : ''}`, deleted > 0 ? 'success' : 'error');
```

}

async function confirmDeleteAllTickets() {
if (!currentProject) return;
const count = tickets.length;
if (count === 0) {
toast(â€˜No tickets to deleteâ€™, â€˜infoâ€™);
return;
}
const projName = currentProject.name || â€˜this projectâ€™;
if (!confirm(`âš ï¸ DELETE ALL ${count} TICKETS for "${projName}"?\n\nThis will permanently remove all ticket data for this project. This cannot be undone.`)) return;
if (!confirm(`Are you absolutely sure? Type-to-confirm: This will delete ${count} tickets.`)) return;

```
showLoading(`Deleting all ${count} tickets...`);
let deleted = 0;

for (const t of tickets) {
    try {
        if (sb) {
            try { await sb.from('tickets').delete().eq('id', t.id); } catch(e) {}
        }
        try { await deleteFromLocal('tickets', t.id); } catch(e) {}
        deleted++;
    } catch (err) {
        console.error('Bulk delete error:', err);
    }
}

tickets = [];
selectedTicketIds.clear();

hideLoading();
renderRecentTickets();
updateStats();
updateTicketCount();
updateBulkActionsBar();
toast(`Deleted ${deleted} tickets from "${projName}"`, 'success');
```

}

function filterTicketList() {
const query = (document.getElementById(â€˜ticketSearchFilterâ€™)?.value || â€˜â€™).toLowerCase();
document.querySelectorAll(â€™.ticket-card-rowâ€™).forEach(el => {
const text = el.dataset.searchtext || â€˜â€™;
el.style.display = text.includes(query) ? â€˜â€™ : â€˜noneâ€™;
});
}

function sortTicketList() {
const order = document.getElementById(â€˜ticketSortOrderâ€™)?.value || â€˜date-descâ€™;
switch(order) {
case â€˜date-descâ€™: tickets.sort((a,b) => new Date(b.service_date||b.created_at) - new Date(a.service_date||a.created_at)); break;
case â€˜date-ascâ€™: tickets.sort((a,b) => new Date(a.service_date||a.created_at) - new Date(b.service_date||b.created_at)); break;
case â€˜ticket-ascâ€™: tickets.sort((a,b) => String(a.ticket_number||â€™â€™).localeCompare(String(b.ticket_number||â€™â€™), undefined, {numeric:true})); break;
case â€˜tons-descâ€™: tickets.sort((a,b) => (b.net_tons||0) - (a.net_tons||0)); break;
case â€˜diversion-descâ€™: tickets.sort((a,b) => (b.diversion_pct||0) - (a.diversion_pct||0)); break;
}
renderRecentTickets();
}

// ========== EXCEL IMPORT ==========
let pendingExcelWorkbook = null;
let pendingExcelFile = null;

function triggerExcelImport() {
// Check if project is selected first
if (!currentProject || !currentProject.id) {
toast(â€˜Please select a project first from the Dashboardâ€™, â€˜warningâ€™);
if (typeof showProjectPicker === â€˜functionâ€™) {
setTimeout(() => showProjectPicker(), 500);
}
return;
}

```
// Check if XLSX library loaded
if (typeof XLSX === 'undefined') {
    toast('Excel library still loading... please wait', 'warning');
    return;
}

// Create a fresh file input every time (fixes iPad Safari file picker)
var input = document.createElement('input');
input.type = 'file';
input.accept = '.xlsx,.xls';
input.style.position = 'fixed';
input.style.left = '-9999px';
document.body.appendChild(input);

input.onchange = function(e) {
    importExcelTickets(e);
    // Clean up
    setTimeout(function() { if (input.parentNode) document.body.removeChild(input); }, 1000);
};

// Small delay for iPad Safari to register the element
setTimeout(function() { input.click(); }, 100);
```

}

async function importExcelTickets(event) {
const file = event.target.files[0];
if (!file) return;

```
console.log('Import started for file:', file.name);

if (!currentProject || !currentProject.id) {
    toast('Select a project first', 'error');
    event.target.value = '';
    return;
}

if (typeof XLSX === 'undefined') {
    toast('Excel library not loaded - refresh page', 'error');
    event.target.value = '';
    return;
}

showLoading('Reading Excel file...');

try {
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
    
    // Check if multiple sheets
    if (workbook.SheetNames.length > 1) {
        hideLoading();
        pendingExcelWorkbook = workbook;
        pendingExcelFile = file;
        showSheetSelector(workbook.SheetNames);
        event.target.value = '';
        return;
    }
    
    // Single sheet - import directly
    await processExcelSheet(workbook, workbook.SheetNames[0], file.name);
    
} catch (err) {
    hideLoading();
    console.error('Excel import error:', err);
    toast('Import failed: ' + err.message, 'error');
}

event.target.value = '';
```

}

function showSheetSelector(sheetNames) {
// Create modal for sheet selection
let modal = document.getElementById(â€˜sheetSelectorModalâ€™);
if (!modal) {
modal = document.createElement(â€˜divâ€™);
modal.id = â€˜sheetSelectorModalâ€™;
modal.className = â€˜modalâ€™;
modal.innerHTML = `<div class="modal-content" style="max-width:400px"> <div class="modal-header"> <div class="modal-title">ğŸ“— Select Tab to Import</div> <button class="modal-close" onclick="closeSheetSelector()">Ã—</button> </div> <div class="modal-body" id="sheetSelectorBody"> </div> </div>`;
document.body.appendChild(modal);
}

```
const body = document.getElementById('sheetSelectorBody');
body.innerHTML = `
    <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px">
        This Excel file has multiple tabs. Select which one to import:
    </p>
    <div style="display:flex;flex-direction:column;gap:8px">
        ${sheetNames.map((name, i) => `
            <button class="btn btn-secondary" onclick="importSelectedSheet(${i})" style="text-align:left;padding:12px 16px">
                <div style="font-weight:600">ğŸ“„ ${name}</div>
                <div style="font-size:11px;color:var(--text-muted)">Tab ${i + 1} of ${sheetNames.length}</div>
            </button>
        `).join('')}
    </div>
    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-color)">
        <button class="btn btn-primary" onclick="importAllSheets()" style="width:100%">
            ğŸ“¥ Import ALL Tabs (${sheetNames.length} total)
        </button>
    </div>
`;

modal.classList.add('active');
```

}

function closeSheetSelector() {
const modal = document.getElementById(â€˜sheetSelectorModalâ€™);
if (modal) modal.classList.remove(â€˜activeâ€™);
pendingExcelWorkbook = null;
pendingExcelFile = null;
}

async function importSelectedSheet(index) {
if (!pendingExcelWorkbook) return;

```
closeSheetSelector();
showLoading('Importing selected tab...');

try {
    const sheetName = pendingExcelWorkbook.SheetNames[index];
    await processExcelSheet(pendingExcelWorkbook, sheetName, pendingExcelFile?.name || 'excel');
} catch(err) {
    console.error('Import error:', err);
    toast('Import failed: ' + err.message, 'error');
}

hideLoading();
pendingExcelWorkbook = null;
pendingExcelFile = null;
```

}

async function importAllSheets() {
if (!pendingExcelWorkbook) return;

```
closeSheetSelector();

const workbook = pendingExcelWorkbook;
const filename = pendingExcelFile?.name || 'excel';
let totalImported = 0;
let totalFailed = 0;

try {
    for (let i = 0; i < workbook.SheetNames.length; i++) {
        showLoading(`Importing tab ${i + 1} of ${workbook.SheetNames.length}...`);
        const result = await processExcelSheet(workbook, workbook.SheetNames[i], filename, true);
        totalImported += result.imported;
        totalFailed += result.failed;
    }
} catch(err) {
    console.error('Import all error:', err);
    toast('Import failed: ' + err.message, 'error');
}

hideLoading();

if (totalFailed > 0) {
    toast(`Imported ${totalImported} tickets total, ${totalFailed} failed`, 'warning');
} else if (totalImported > 0) {
    toast(`Successfully imported ${totalImported} tickets from all tabs!`, 'success');
}

loadRecentTickets();
updateStats();

pendingExcelWorkbook = null;
pendingExcelFile = null;
```

}

async function processExcelSheet(workbook, sheetName, filename, silent = false) {
const sheet = workbook.Sheets[sheetName];
const importLog = [];
const logMsg = (msg) => { importLog.push(msg); console.log(msg); };

```
// Convert to array of arrays
const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: null });

logMsg(`ğŸ“‹ Sheet "${sheetName}": ${rows.length} rows`);

// Log first 20 rows for debug
for (let i = 0; i < Math.min(20, rows.length); i++) {
    const r = rows[i];
    if (r && r.some(c => c !== null)) {
        const preview = r.slice(0, 10).map((c,j) => c !== null ? `[${j}]=${String(c).substring(0,15)}` : '').filter(Boolean).join(' ');
        logMsg(`  Row ${i}: ${preview}`);
    }
}

// Find header row â€” search first 30 rows for row with 3+ columns containing known header words
let headerRowIndex = -1;
let headers = [];
const headerKeywords = ['date', 'ticket', 'gwt', 'gross', 'tare', 'net', 'tons', 'wood', 'metal', 'plastic', 'occ', 'gypsum', 'concrete', 'diverted'];

for (let i = 0; i < Math.min(30, rows.length); i++) {
    const row = rows[i];
    if (!row || row.length < 3) continue;
    
    const cellStrings = row.map(c => String(c || '').toLowerCase().trim());
    const matchCount = cellStrings.filter(s => headerKeywords.some(kw => s.includes(kw))).length;
    
    if (matchCount >= 3) {
        headerRowIndex = i;
        headers = cellStrings;
        logMsg(`âœ… Header row found at index ${i} (${matchCount} keyword matches)`);
        break;
    }
}

if (headerRowIndex === -1) {
    logMsg(`âŒ No header row found â€” need 3+ matches from: ${headerKeywords.join(', ')}`);
    showImportDebugLog(importLog, sheetName);
    if (!silent) { hideLoading(); toast(`No header row found in "${sheetName}"`, 'error'); }
    return { imported: 0, failed: 0 };
}

logMsg(`ğŸ“‘ Headers: [${headers.filter(Boolean).join(', ')}]`);

// Map columns with multiple pattern attempts
const findCol = (patterns) => {
    for (const pattern of patterns) {
        const idx = headers.findIndex(h => typeof pattern === 'string' ? h.includes(pattern) : pattern.test(h));
        if (idx >= 0) return idx;
    }
    return -1;
};

const colMap = {
    date: findCol(['date']),
    ticket: findCol(['ticket']),
    gross: findCol([/gwt.*lbs/, /gross.*lbs/, 'gwt (lbs)', 'gwt']),
    grossTons: findCol([/gwt.*nt/, 'gwt (nt)']),
    tare: findCol([/tare.*lbs/, 'tare (lbs)', 'tare']),
    tareTons: findCol([/tare.*nt/, 'tare (nt)']),
    netLbs: findCol([/net.*lbs/, 'net (lbs)']),
    tons: findCol([/^tons$/, 'tons']),
    woodPct: findCol(['wood %']),
    gypsumPct: findCol(['gypsum %', 'drywall %']),
    plasticPct: findCol(['plastic %']),
    occPct: findCol(['occ %', 'cardboard %']),
    metalPct: findCol(['metal %']),
    concretePct: findCol(['concrete %']),
    blockPct: findCol(['block %']),
    divertedPct: findCol(['diverted %'])
};

// Fallback for Dalmex template format: position-based (A=Date,B=Ticket,C=GWT lbs, etc.)
if (colMap.date === -1) colMap.date = 0;
if (colMap.ticket === -1) colMap.ticket = 1;
if (colMap.gross === -1) colMap.gross = 2;
if (colMap.grossTons === -1) colMap.grossTons = 3;
if (colMap.tare === -1) colMap.tare = 4;
if (colMap.tareTons === -1) colMap.tareTons = 5;
if (colMap.netLbs === -1) colMap.netLbs = 6;
if (colMap.tons === -1) colMap.tons = 7;
if (colMap.woodPct === -1) colMap.woodPct = 8;
if (colMap.gypsumPct === -1) colMap.gypsumPct = 10;
if (colMap.plasticPct === -1) colMap.plasticPct = 12;
if (colMap.occPct === -1) colMap.occPct = 14;
if (colMap.metalPct === -1) colMap.metalPct = 16;
if (colMap.concretePct === -1) colMap.concretePct = 18;
if (colMap.blockPct === -1) colMap.blockPct = 20;
if (colMap.divertedPct === -1) colMap.divertedPct = 23;

logMsg(`ğŸ—ºï¸ Column map: ${Object.entries(colMap).map(([k,v])=>k+'='+v).join(', ')}`);

// Detect percentage format from first few data rows
let pctFormat = 'decimal';
for (let di = 1; di <= 3; di++) {
    const dataRow = rows[headerRowIndex + di];
    if (!dataRow) continue;
    const pctCols = [colMap.woodPct, colMap.gypsumPct, colMap.plasticPct, colMap.occPct, colMap.metalPct, colMap.concretePct, colMap.blockPct];
    const pctVals = pctCols.map(c => c >= 0 ? parseFloat(dataRow[c]) : NaN).filter(v => !isNaN(v) && v > 0);
    if (pctVals.length > 0) {
        if (pctVals.some(v => v > 1.0)) { pctFormat = 'whole'; }
        logMsg(`ğŸ“ Pct format: ${pctFormat} (row ${headerRowIndex+di} samples: ${pctVals.map(v=>v.toFixed(4)).join(', ')})`);
        break;
    }
}

const parsePct = (val) => {
    if (val === null || val === undefined || val === '') return 0;
    const n = parseFloat(val);
    if (isNaN(n)) return 0;
    return pctFormat === 'decimal' ? Math.round(n * 100) : Math.round(n);
};

// Parse data rows
const parsedTickets = [];
let skipped = 0;

for (let i = headerRowIndex + 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || row.length === 0) continue;
    
    // Skip summary/totals rows
    const first = String(row[0] || '').toLowerCase().trim();
    if (first.includes('total') || first.includes('diverted') || first.includes('recycled') || first.includes('summary') || first.includes('report') || first.includes('company') || first.includes('contact')) {
        skipped++;
        continue;
    }
    
    const dateVal = colMap.date >= 0 ? row[colMap.date] : null;
    const ticketNum = colMap.ticket >= 0 ? row[colMap.ticket] : null;
    
    // Must have date or ticket number to be a valid row
    if (!dateVal && !ticketNum) { skipped++; continue; }
    
    // Parse date
    let serviceDate = '';
    if (dateVal) {
        if (dateVal instanceof Date) {
            serviceDate = dateVal.toISOString().split('T')[0];
        } else if (typeof dateVal === 'number' && dateVal > 40000 && dateVal < 60000) {
            // Excel serial date
            const excelEpoch = new Date(1899, 11, 30);
            let dayOffset = dateVal > 59 ? dateVal - 1 : dateVal;
            const jsDate = new Date(excelEpoch.getTime() + dayOffset * 86400000);
            serviceDate = jsDate.toISOString().split('T')[0];
        } else if (typeof dateVal === 'string') {
            const parsed = new Date(dateVal);
            if (!isNaN(parsed)) serviceDate = parsed.toISOString().split('T')[0];
        }
    }
    
    // Parse weights
    const grossLbs = parseFloat(row[colMap.gross]) || 0;
    const tareLbs = parseFloat(row[colMap.tare]) || 0;
    const netLbs = parseFloat(row[colMap.netLbs]) || (grossLbs - tareLbs);
    const netTons = parseFloat(row[colMap.tons]) || (netLbs / 2000);
    
    if (netTons <= 0 && grossLbs <= 0) { skipped++; continue; }
    
    // Parse material percentages
    const woodPct = parsePct(row[colMap.woodPct]);
    const gypsumPct = parsePct(row[colMap.gypsumPct]);
    const plasticPct = parsePct(row[colMap.plasticPct]);
    const occPct = parsePct(row[colMap.occPct]);
    const metalPct = parsePct(row[colMap.metalPct]);
    const concretePct = parsePct(row[colMap.concretePct]);
    const blockPct = parsePct(row[colMap.blockPct]);
    
    const totalRecycled = woodPct + gypsumPct + plasticPct + occPct + metalPct + concretePct + blockPct;
    const landfillPct = Math.max(0, 100 - totalRecycled);
    const diversionPct = Math.min(100, totalRecycled);
    
    if (parsedTickets.length === 0) {
        logMsg(`ğŸ« First ticket: #${ticketNum}, ${serviceDate}, ${netTons.toFixed(2)}T, Wood:${woodPct}% Gypsum:${gypsumPct}% Plastic:${plasticPct}% OCC:${occPct}% Metal:${metalPct}% Concrete:${concretePct}% Block:${blockPct}%`);
        logMsg(`   Diversion: ${diversionPct}%, Landfill: ${landfillPct}%`);
    }
    
    parsedTickets.push({
        project_id: currentProject.id,
        ticket_number: String(ticketNum || ''),
        service_date: serviceDate || new Date().toISOString().split('T')[0],
        hauler: currentProject.waste_hauler || 'Imported',
        gross_lbs: grossLbs,
        tare_lbs: tareLbs,
        net_lbs: netLbs,
        net_tons: netTons,
        wood_pct: woodPct,
        concrete_pct: concretePct + blockPct,
        metal_pct: metalPct,
        cardboard_pct: occPct,
        plastic_pct: plasticPct,
        drywall_pct: gypsumPct,
        landfill_pct: landfillPct,
        wood_tons: (woodPct / 100) * netTons,
        concrete_tons: ((concretePct + blockPct) / 100) * netTons,
        metal_tons: (metalPct / 100) * netTons,
        cardboard_tons: (occPct / 100) * netTons,
        plastic_tons: (plasticPct / 100) * netTons,
        drywall_tons: (gypsumPct / 100) * netTons,
        landfill_tons: (landfillPct / 100) * netTons,
        diversion_pct: diversionPct,
        diverted_tons: (diversionPct / 100) * netTons,
        human_verified: true,
        imported: true,
        import_source: filename + ' [' + sheetName + ']',
        created_at: new Date().toISOString()
    });
}

logMsg(`âœ… Parsed ${parsedTickets.length} tickets (${skipped} rows skipped)`);

if (parsedTickets.length === 0) {
    logMsg(`âŒ No ticket data found`);
    showImportDebugLog(importLog, sheetName);
    if (!silent) { hideLoading(); toast(`No tickets found in "${sheetName}"`, 'warning'); }
    return { imported: 0, failed: 0 };
}

// Confirm (non-batch mode)
if (!silent) {
    hideLoading();
    if (!confirm(`Found ${parsedTickets.length} tickets in "${sheetName}".\n\nFirst: #${parsedTickets[0].ticket_number} ${parsedTickets[0].service_date}\nLast: #${parsedTickets[parsedTickets.length-1].ticket_number} ${parsedTickets[parsedTickets.length-1].service_date}\n\nProject: ${currentProject.name}\n\nImport?`)) {
        return { imported: 0, failed: 0 };
    }
    showLoading(`Importing ${parsedTickets.length} tickets...`);
}

// Save to Supabase
let imported = 0;
let failed = 0;

if (sb) {
    try {
        logMsg(`â˜ï¸ Batch inserting ${parsedTickets.length} tickets...`);
        const { data: insertedData, error } = await sb.from('tickets').insert(parsedTickets).select('id');
        
        if (error) {
            logMsg(`âŒ Batch error: ${error.message} (code: ${error.code}, details: ${error.details})`);
            logMsg(`âš ï¸ Trying one-by-one...`);
            
            for (const ticket of parsedTickets) {
                try {
                    const { error: e2 } = await sb.from('tickets').insert([ticket]);
                    if (e2) { logMsg(`âŒ #${ticket.ticket_number}: ${e2.message}`); failed++; }
                    else { imported++; }
                } catch (e3) { logMsg(`âŒ #${ticket.ticket_number}: ${e3.message}`); failed++; }
            }
        } else {
            imported = parsedTickets.length;
            logMsg(`âœ… Batch insert OK: ${imported} tickets`);
        }
    } catch (sbErr) {
        logMsg(`âŒ Supabase fatal: ${sbErr.message}`);
        failed = parsedTickets.length;
    }
} else {
    // Offline â€” IndexedDB only
    for (const ticket of parsedTickets) {
        try {
            const tid = { ...ticket, id: 'imp_' + Date.now() + '_' + Math.random().toString(36).substr(2,6), synced: false };
            await saveToLocal('tickets', tid);
            imported++;
        } catch (err) { failed++; }
    }
}

logMsg(`ğŸ’¾ Result: ${imported} imported, ${failed} failed`);
showImportDebugLog(importLog, sheetName);

if (!silent) {
    hideLoading();
    if (failed > 0) toast(`Imported ${imported}, ${failed} failed`, 'warning');
    else toast(`âœ… Imported ${imported} tickets from "${sheetName}"!`, 'success');
    loadRecentTickets();
    updateStats();
}

return { imported, failed };
```

}

// On-screen debug panel for import troubleshooting
function showImportDebugLog(logMessages, sheetName) {
let panel = document.getElementById(â€˜importDebugPanelâ€™);
if (!panel) {
panel = document.createElement(â€˜divâ€™);
panel.id = â€˜importDebugPanelâ€™;
panel.style.cssText = â€˜position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#1a1a2e;border-top:2px solid #00d4ff;z-index:99999;font-family:monospace;font-size:11px;padding:12px;color:#e0e0e0;â€™;
document.body.appendChild(panel);
}

```
const timestamp = new Date().toLocaleTimeString();
const header = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid #333">
    <strong style="color:#00d4ff">ğŸ“Š Import Log - "${sheetName}" @ ${timestamp}</strong>
    <button onclick="this.parentElement.parentElement.remove()" style="background:#ff4444;color:white;border:none;border-radius:4px;padding:4px 12px;cursor:pointer;font-size:11px">âœ• Close</button>
</div>`;

const lines = logMessages.map(msg => {
    let color = '#e0e0e0';
    if (msg.startsWith('âœ…')) color = '#4ade80';
    else if (msg.startsWith('âŒ')) color = '#f87171';
    else if (msg.startsWith('âš ï¸')) color = '#fbbf24';
    else if (msg.startsWith('ğŸ“‹') || msg.startsWith('ğŸ—ºï¸') || msg.startsWith('ğŸ“')) color = '#60a5fa';
    else if (msg.startsWith('ğŸ«')) color = '#c084fc';
    else if (msg.startsWith('ğŸ’¾')) color = '#34d399';
    return `<div style="color:${color};padding:2px 0;white-space:pre-wrap">${msg}</div>`;
}).join('');

panel.innerHTML = header + lines;
panel.scrollTop = panel.scrollHeight;
```

}

// Export all projects to Excel
function exportProjectsExcel() {
if (typeof XLSX === â€˜undefinedâ€™) {
toast(â€˜Excel library not loadedâ€™, â€˜errorâ€™);
return;
}

```
if (!projects || projects.length === 0) {
    toast('No projects to export', 'error');
    return;
}

try {
    const wb = XLSX.utils.book_new();
    
    // Projects sheet
    const projectData = [
        ['Project Name', 'Address', 'General Contractor', 'Waste Hauler', 'LEED Target', 'Access Code', 'Created']
    ];
    
    projects.forEach(p => {
        projectData.push([
            p.name || '',
            p.address || '',
            p.general_contractor || '',
            p.waste_hauler || '',
            (p.leed_target || 75) + '%',
            p.access_code || '',
            p.created_at || ''
        ]);
    });
    
    const wsProjects = XLSX.utils.aoa_to_sheet(projectData);
    wsProjects['!cols'] = [{ wch: 30 }, { wch: 35 }, { wch: 25 }, { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 20 }];
    XLSX.utils.book_append_sheet(wb, wsProjects, 'Projects');
    
    // Download
    XLSX.writeFile(wb, `DivertScan_Projects_${new Date().toISOString().split('T')[0]}.xlsx`);
    toast('Projects exported to Excel!', 'success');
    
} catch (err) {
    console.error('Export error:', err);
    toast('Export failed: ' + err.message, 'error');
}
```

}

// Export projects to CSV
function exportProjectsCSV() {
if (!projects || projects.length === 0) {
toast(â€˜No projects to exportâ€™, â€˜errorâ€™);
return;
}

```
const headers = ['Project Name', 'Address', 'General Contractor', 'Waste Hauler', 'LEED Target', 'Access Code'];
const rows = projects.map(p => [
    p.name || '',
    p.address || '',
    p.general_contractor || '',
    p.waste_hauler || '',
    (p.leed_target || 75) + '%',
    p.access_code || ''
]);

const csv = [headers, ...rows].map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')).join('\n');

const blob = new Blob([csv], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `DivertScan_Projects_${new Date().toISOString().split('T')[0]}.csv`;
a.click();
URL.revokeObjectURL(url);

toast('Projects exported to CSV!', 'success');
```

}

// ========== LEED NEWS FEED ==========
async function refreshLeedNews() {
const container = document.getElementById(â€˜leedNewsListâ€™);
container.innerHTML = â€˜<div style="padding:12px 0;color:var(--slate-400)">ğŸ”„ Fetching latest LEED & C&D industry newsâ€¦</div>â€™;

```
const apiKey = localStorage.getItem('divertscan_openai');

if (apiKey && apiKey.startsWith('sk-ant-')) {
    // Use Claude API with web search for live news
    try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
                'x-api-key': apiKey,
                'Content-Type': 'application/json',
                'anthropic-version': '2023-06-01',
                'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
                model: 'claude-haiku-4-5-20251001',
                max_tokens: 1024,
                tools: [{type:'web_search_20250305', name:'web_search'}],
                messages: [{
                    role: 'user',
                    content: 'Search for the 5 most recent and important news items about: LEED v5 construction waste management, C&D recycling regulations, USGBC MRc5 updates, EPA construction demolition waste rules, green building waste diversion standards. Return ONLY JSON array: [{"title":"string","source":"string","date":"string","summary":"one sentence","url":"string"}]. Focus on 2025-2026 developments.'
                }]
            })
        });
        
        const data = await response.json();
        if (data.content) {
            var text = data.content.map(function(b){return b.text||''}).join('');
            text = text.replace(/```json/gi,'').replace(/```/g,'').trim();
            var match = text.match(/\[[\s\S]*\]/);
            if (match) {
                var newsItems = JSON.parse(match[0]);
                renderNewsItems(container, newsItems);
                // Cache with timestamp
                localStorage.setItem('divertscan_news_cache', JSON.stringify({items:newsItems, ts:Date.now()}));
                return;
            }
        }
    } catch(e) {
        console.log('Live news fetch failed, using cache/fallback:', e.message);
    }
}

// Try cache first (valid for 24 hours)
try {
    var cached = JSON.parse(localStorage.getItem('divertscan_news_cache') || '{}');
    if (cached.items && cached.ts && (Date.now() - cached.ts) < 86400000) {
        renderNewsItems(container, cached.items);
        container.innerHTML += '<div style="font-size:9px;color:var(--slate-500);padding:4px 0">Cached Â· Last updated ' + new Date(cached.ts).toLocaleString() + '</div>';
        return;
    }
} catch(e) {}

// Fallback to curated static sources
var newsItems = [
    {title:'LEED v5 â€” Mandatory After June 30, 2026',source:'USGBC',date:'2025',summary:'All new project registrations must use LEED v5 after June 30, 2026. Key change: 200% salvage multiplier for reused materials.',url:'https://www.usgbc.org/leed/v5'},
    {title:'EPA C&D Waste Management Guidelines',source:'EPA',date:'2025',summary:'Updated guidelines for sustainable management of construction and demolition materials.',url:'https://www.epa.gov/smm/sustainable-management-construction-and-demolition-materials'},
    {title:'TCEQ C&D Recycling Facilities (Texas)',source:'TCEQ',date:'2025',summary:'Authorized C&D recycling and processing facilities in Texas â€” verify your end markets.',url:'https://www.tceq.texas.gov/permitting/waste_permits/msw_permits/msw-cd-facilities'},
    {title:'MRc5 Documentation Requirements',source:'USGBC',date:'2025',summary:'Scale tickets, material breakdowns, end market verification, and chain-of-custody required.',url:'https://www.usgbc.org/credits/new-construction-core-and-shell-schools-new-construction-retail-new-construction-healthcare/v4'},
    {title:'Circular Economy in Construction',source:'World GBC',date:'2025',summary:'Global trends driving material reuse and waste reduction in the building sector.',url:'https://worldgbc.org/circularity'}
];
renderNewsItems(container, newsItems);
container.innerHTML += '<div style="font-size:9px;color:var(--slate-500);padding:4px 0">Static sources Â· Add API key for live news</div>';
```

}

function renderNewsItems(container, items) {
container.innerHTML = items.map(function(item) {
return â€˜<div style="padding:10px 0;border-bottom:1px solid var(--slate-700)">â€™ +
â€˜<a href="' + (item.url||'#') + '" target="_blank" rel="noopener" style="color:var(--emerald-400);font-weight:600;text-decoration:none;font-size:12px">â€™ + item.title + â€™ â†—</a>â€™ +
â€˜<div style="color:var(--slate-400);font-size:10px;margin-top:2px">â€™ + (item.source||â€™â€™) + (item.date ? â€™ Â· â€™ + item.date : â€˜â€™) + â€˜</div>â€™ +
â€˜<div style="color:var(--slate-300);font-size:11px;margin-top:3px">â€™ + (item.summary||â€™â€™) + â€˜</div>â€™ +
â€˜</div>â€™;
}).join(â€™â€™);
}

// ========== AI EXECUTIVE SUMMARY ==========
let aiSummaryText = â€˜â€™;

async function generateAISummary() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}

```
const apiKey = localStorage.getItem('divertscan_openai');
if (!apiKey) {
    toast('Add Anthropic API key in Settings', 'error');
    return;
}

showLoading('Generating AI Executive Summary...');

try {
    // Get project data
    const { data: tickets } = await sb
        .from('tickets')
        .select('*')
        .eq('project_id', currentProject.id)
        .order('service_date', { ascending: true });
    
    if (!tickets || tickets.length === 0) {
        hideLoading();
        toast('No tickets found for this project', 'error');
        return;
    }
    
    // Calculate stats
    const totalTons = tickets.reduce((s, t) => s + (t.net_tons || 0), 0);
    const landfillTons = tickets.reduce((s, t) => s + (t.landfill_tons || 0), 0);
    const divertedTons = totalTons - landfillTons;
    const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;
    
    // Material breakdown
    const woodTons = tickets.reduce((s, t) => s + (t.wood_tons || 0), 0);
    const concreteTons = tickets.reduce((s, t) => s + (t.concrete_tons || 0), 0);
    const metalTons = tickets.reduce((s, t) => s + (t.metal_tons || 0), 0);
    const cardboardTons = tickets.reduce((s, t) => s + (t.cardboard_tons || 0), 0);
    
    const prompt = `You are a professional environmental consultant writing an executive summary for a LEED MRc5 Construction & Demolition Waste Management report.
```

PROJECT DATA:

- Project: ${currentProject.name}
- Location: ${currentProject.address || â€˜Not specifiedâ€™}
- General Contractor: ${currentProject.general_contractor || â€˜Not specifiedâ€™}
- Waste Hauler: ${currentProject.waste_hauler || â€˜Not specifiedâ€™}
- Total Loads: ${tickets.length}
- Date Range: ${tickets[0]?.service_date || â€˜N/Aâ€™} to ${tickets[tickets.length-1]?.service_date || â€˜N/Aâ€™}

WASTE SUMMARY:

- Total Waste Generated: ${totalTons.toFixed(2)} tons
- Diverted from Landfill: ${divertedTons.toFixed(2)} tons (${diversionRate}%)
- Sent to Landfill: ${landfillTons.toFixed(2)} tons

MATERIAL BREAKDOWN:

- Wood/Lumber: ${woodTons.toFixed(2)} tons
- Concrete/Masonry: ${concreteTons.toFixed(2)} tons
- Metals: ${metalTons.toFixed(2)} tons
- Cardboard: ${cardboardTons.toFixed(2)} tons

LEED TARGET: ${currentProject.leed_target || 75}%
STATUS: ${diversionRate >= (currentProject.leed_target || 75) ? â€˜COMPLIANTâ€™ : â€˜BELOW TARGETâ€™}

Write a professional 2-3 paragraph executive summary suitable for LEED certification submission. Include:

1. Overview of waste management achievement
1. Key materials diverted and recycling partners utilized
1. Environmental impact statement (CO2 equivalent saved)
1. Compliance statement

Use professional, formal language. Be specific with numbers. Do not use bullet points.`;

```
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'x-api-key': apiKey,
            'Content-Type': 'application/json',
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
            model: 'claude-haiku-4-5-20251001',
            max_tokens: 1024,
            messages: [{ role: 'user', content: prompt }]
        })
    });
    
    const data = await response.json();
    hideLoading();
    
    if (data.error) {
        toast('API Error: ' + data.error.message, 'error');
        return;
    }
    
    aiSummaryText = data.content[0].text;
    
    // Display the summary
    const container = document.getElementById('aiSummaryResult');
    container.innerHTML = `
        <div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">âœ¨ Executive Summary</div>
        <div style="white-space:pre-wrap">${aiSummaryText}</div>
        <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="copyAISummary()" style="flex:1;padding:8px">ğŸ“‹ Copy</button>
            <button class="btn btn-secondary" onclick="editAISummary()" style="flex:1;padding:8px">âœï¸ Edit</button>
        </div>
    `;
    container.classList.remove('hidden');
    document.getElementById('aiSummaryActions').classList.remove('hidden');
    
    toast('AI Summary generated!', 'success');
    
} catch (err) {
    hideLoading();
    toast('Error: ' + err.message, 'error');
}
```

}

function copyAISummary() {
navigator.clipboard.writeText(aiSummaryText).then(() => {
toast(â€˜Summary copied to clipboard!â€™, â€˜successâ€™);
});
}

function editAISummary() {
const container = document.getElementById(â€˜aiSummaryResultâ€™);
container.innerHTML = `<div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">âœï¸ Edit Summary</div> <textarea id="aiSummaryEdit" style="width:100%;height:200px;background:var(--slate-700);border:1px solid var(--slate-600);border-radius:8px;padding:12px;color:var(--slate-200);font-size:12px;line-height:1.6">${aiSummaryText}</textarea> <div style="margin-top:12px;display:flex;gap:8px"> <button class="btn btn-primary" onclick="saveAISummary()" style="flex:1;padding:8px">ğŸ’¾ Save</button> <button class="btn btn-secondary" onclick="generateAISummary()" style="flex:1;padding:8px">ğŸ”„ Regenerate</button> </div>`;
}

function saveAISummary() {
aiSummaryText = document.getElementById(â€˜aiSummaryEditâ€™).value;
const container = document.getElementById(â€˜aiSummaryResultâ€™);
container.innerHTML = `<div style="font-weight:600;margin-bottom:8px;color:var(--emerald-400)">âœ¨ Executive Summary</div> <div style="white-space:pre-wrap">${aiSummaryText}</div> <div style="margin-top:12px;display:flex;gap:8px"> <button class="btn btn-secondary" onclick="copyAISummary()" style="flex:1;padding:8px">ğŸ“‹ Copy</button> <button class="btn btn-secondary" onclick="editAISummary()" style="flex:1;padding:8px">âœï¸ Edit</button> </div>`;
toast(â€˜Summary saved!â€™, â€˜successâ€™);
}

// ========== ENHANCED REPORT PREVIEW ==========

// Report Project Picker â€” syncs report tab with a project even when navigating directly
function onReportProjectChange() {
const sel = document.getElementById(â€˜reportProjectSelectâ€™);
const indicator = document.getElementById(â€˜reportProjectIndicatorâ€™);
const pid = sel.value;

```
if (!pid) {
    if (indicator) indicator.classList.remove('active');
    currentProject = null;
    resetReportState();
    return;
}

// Find project from local list or tickets' projects
const allOpts = Array.from(sel.options);
const match = allOpts.find(o => o.value === pid);

// Set currentProject from existing projects array or build minimal object
const existing = (window._allProjectsList || []).find(p => p.id === pid);
if (existing) {
    currentProject = existing;
} else {
    currentProject = { id: pid, name: match?.textContent || 'Unknown' };
}

if (indicator) indicator.classList.add('active');
localStorage.setItem('divertscan_current_project', JSON.stringify(currentProject));

// Clear stale data before generating new report
resetReportState();

// Auto-generate report when project is selected
generateReport();
```

}

// Populate report project dropdown (called from loadProjects and showTab)
function populateReportProjectDropdown() {
const sel = document.getElementById(â€˜reportProjectSelectâ€™);
if (!sel) return;

```
const currentVal = sel.value || currentProject?.id || '';
sel.innerHTML = '<option value="">â€” Select Project â€”</option>';

const projectList = window._allProjectsList || [];
projectList.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.name || 'Unnamed Project';
    if (p.id === currentVal) opt.selected = true;
    sel.appendChild(opt);
});

// Auto-select current project
if (currentProject?.id && !sel.value) {
    sel.value = currentProject.id;
}

const indicator = document.getElementById('reportProjectIndicator');
if (indicator) {
    indicator.classList.toggle('active', !!sel.value);
}
```

}

// AI Summary PDF Download
function downloadAISummaryPDF() {
if (!aiSummaryText) {
toast(â€˜Generate a summary firstâ€™, â€˜errorâ€™);
return;
}

```
const { jsPDF } = window.jspdf;
const doc = new jsPDF('portrait');
const pw = doc.internal.pageSize.width;
const ph = doc.internal.pageSize.height;
let y = 15;

// Header bar
doc.setFillColor(45, 90, 39);
doc.rect(0, 0, pw, 28, 'F');
doc.setTextColor(255);
doc.setFontSize(16);
doc.setFont('helvetica', 'bold');
doc.text('LEED MRc5 Executive Summary', pw / 2, 12, { align: 'center' });
doc.setFontSize(9);
doc.setFont('helvetica', 'normal');
doc.text('Generated by DivertScanâ„¢ â€” Dalmex Recycling LLC', pw / 2, 20, { align: 'center' });
doc.setTextColor(0);
y = 38;

// Project info
if (currentProject) {
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    doc.text('Project: ' + (currentProject.name || ''), 14, y);
    y += 6;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    doc.text('Date: ' + new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), 14, y);
    y += 12;
}

// Body text - word wrap
doc.setFontSize(10);
doc.setFont('helvetica', 'normal');
const lines = doc.splitTextToSize(aiSummaryText, pw - 28);

lines.forEach(line => {
    if (y > ph - 30) {
        doc.addPage();
        y = 15;
    }
    doc.text(line, 14, y);
    y += 5;
});

// Footer
y += 10;
doc.setDrawColor(45, 90, 39);
doc.setLineWidth(0.5);
doc.line(14, y, pw - 14, y);
y += 6;
doc.setFontSize(8);
doc.setTextColor(100);
doc.text('This report was generated from verified scale ticket data via the DivertScanâ„¢ waste tracking system.', 14, y);
y += 5;
doc.text('Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000', 14, y);

doc.save('DivertScan_AI_Executive_Summary_' + new Date().toISOString().split('T')[0] + '.pdf');
toast('AI Summary PDF downloaded!', 'success');
```

}

// Report Signature Pad
let reportSigCanvas = null;
let reportSigCtx = null;
let reportSigDrawing = false;

function initReportSignaturePad() {
reportSigCanvas = document.getElementById(â€˜reportSignatureCanvasâ€™);
if (!reportSigCanvas) return;

```
reportSigCtx = reportSigCanvas.getContext('2d');
reportSigCtx.fillStyle = 'white';
reportSigCtx.fillRect(0, 0, reportSigCanvas.width, reportSigCanvas.height);

// Touch events for iPad
reportSigCanvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    reportSigDrawing = true;
    const r = reportSigCanvas.getBoundingClientRect();
    const t = e.touches[0];
    const x = (t.clientX - r.left) * (reportSigCanvas.width / r.width);
    const y = (t.clientY - r.top) * (reportSigCanvas.height / r.height);
    reportSigCtx.beginPath();
    reportSigCtx.moveTo(x, y);
}, { passive: false });

reportSigCanvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!reportSigDrawing) return;
    const r = reportSigCanvas.getBoundingClientRect();
    const t = e.touches[0];
    const x = (t.clientX - r.left) * (reportSigCanvas.width / r.width);
    const y = (t.clientY - r.top) * (reportSigCanvas.height / r.height);
    reportSigCtx.lineWidth = 2;
    reportSigCtx.lineCap = 'round';
    reportSigCtx.strokeStyle = 'black';
    reportSigCtx.lineTo(x, y);
    reportSigCtx.stroke();
    reportSigCtx.beginPath();
    reportSigCtx.moveTo(x, y);
}, { passive: false });

reportSigCanvas.addEventListener('touchend', () => { reportSigDrawing = false; });

// Mouse events for desktop testing
reportSigCanvas.addEventListener('mousedown', (e) => {
    reportSigDrawing = true;
    const r = reportSigCanvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (reportSigCanvas.width / r.width);
    const y = (e.clientY - r.top) * (reportSigCanvas.height / r.height);
    reportSigCtx.beginPath();
    reportSigCtx.moveTo(x, y);
});
reportSigCanvas.addEventListener('mousemove', (e) => {
    if (!reportSigDrawing) return;
    const r = reportSigCanvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (reportSigCanvas.width / r.width);
    const y = (e.clientY - r.top) * (reportSigCanvas.height / r.height);
    reportSigCtx.lineWidth = 2;
    reportSigCtx.lineCap = 'round';
    reportSigCtx.strokeStyle = 'black';
    reportSigCtx.lineTo(x, y);
    reportSigCtx.stroke();
    reportSigCtx.beginPath();
    reportSigCtx.moveTo(x, y);
});
reportSigCanvas.addEventListener('mouseup', () => { reportSigDrawing = false; });
```

}

function clearReportSignature() {
if (reportSigCanvas && reportSigCtx) {
reportSigCtx.fillStyle = â€˜whiteâ€™;
reportSigCtx.fillRect(0, 0, reportSigCanvas.width, reportSigCanvas.height);
}
}

function saveReportSignature() {
if (!reportSigCanvas) { toast(â€˜Signature pad not readyâ€™, â€˜errorâ€™); return; }
var imgd = reportSigCtx.getImageData(0, 0, reportSigCanvas.width, reportSigCanvas.height);
var hasSig = false;
for (var i = 0; i < imgd.data.length; i += 4) { if (imgd.data[i] < 250) { hasSig = true; break; } }
if (!hasSig) { toast(â€˜Please sign before savingâ€™, â€˜errorâ€™); return; }
localStorage.setItem(â€˜divertscan_report_signatureâ€™, reportSigCanvas.toDataURL(â€˜image/pngâ€™));
localStorage.setItem(â€˜divertscan_report_sig_dateâ€™, new Date().toISOString());
toast(â€˜Signature saved!â€™, â€˜successâ€™);
}

function printSignedReport() {
if (!reportData || reportData.length === 0) { toast(â€˜Generate a report firstâ€™, â€˜errorâ€™); return; }
var sigImg = â€˜â€™;
if (reportSigCanvas && reportSigCtx) {
var id2 = reportSigCtx.getImageData(0, 0, reportSigCanvas.width, reportSigCanvas.height);
for (var j = 0; j < id2.data.length; j += 4) { if (id2.data[j] < 250) { sigImg = reportSigCanvas.toDataURL(â€˜image/pngâ€™); break; } }
}
if (!sigImg) sigImg = localStorage.getItem(â€˜divertscan_report_signatureâ€™) || â€˜â€™;
var totalT = 0, lfT = 0;
reportData.forEach(function(t) { totalT += t.net_tons || 0; lfT += t.landfill_tons || 0; });
var divT = totalT - lfT;
var divR = totalT > 0 ? Math.round((divT / totalT) * 100) : 0;
var rows = reportData.map(function(t) {
return â€˜<tr><td>â€™ + formatDate(t.service_date) + â€˜</td><td>â€™ + (t.ticket_number || â€˜-â€™) + â€˜</td><td>â€™ + (t.hauler || â€˜-â€™) + â€˜</td><td style="text-align:right">â€™ + (t.gross_lbs || 0).toLocaleString() + â€˜</td><td style="text-align:right">â€™ + (t.tare_lbs || 0).toLocaleString() + â€˜</td><td style="text-align:right;font-weight:700">â€™ + (t.net_tons || 0).toFixed(2) + â€˜</td><td style="text-align:right;color:' + ((t.diversion_pct || 0) >= 75 ? '#2ecc71' : '#e67e22') + '">â€™ + (t.diversion_pct || 0) + â€˜%</td><td style="text-align:center">â€™ + (t.human_verified ? â€˜âœ…â€™ : â€˜âŒâ€™) + â€˜</td></tr>â€™;
}).join(â€™â€™);
var sigHtml = â€˜<div style="margin-top:12px;padding:8px;background:#f8f8f8;border-radius:4px;font-size:10px;color:#666"><strong>Processing Facility:</strong> Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000</div>â€™;
var w = window.open(â€™â€™, â€˜_blankâ€™);
w.document.write(â€™<!DOCTYPE html><html><head><title>DivertScan Report</title><style>body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:20px;color:#1a1a1a;font-size:12px}.hdr{background:#2d5a27;color:white;padding:16px;text-align:center;border-radius:4px}.hdr h1{margin:0;font-size:18px}.hdr p{margin:2px 0 0;opacity:0.8;font-size:11px}table{width:100%;border-collapse:collapse;margin:16px 0}th{background:#f0f0f0;padding:6px 8px;text-align:left;font-size:10px;text-transform:uppercase;border-bottom:2px solid #2d5a27}td{padding:6px 8px;border-bottom:1px solid #ddd}tfoot td{font-weight:700;border-top:2px solid #2d5a27}.stats{display:flex;gap:16px;margin:16px 0}.stat{flex:1;background:#f8f8f8;padding:12px;text-align:center;border-radius:4px;border-left:3px solid #2d5a27}.stat .v{font-size:22px;font-weight:700}.stat .l{font-size:9px;color:#666;text-transform:uppercase}.cert{border:2px solid #2d5a27;padding:16px;border-radius:4px;margin-top:20px}@media print{body{padding:10px}.hdr{-webkit-print-color-adjust:exact;print-color-adjust:exact}}</style></head><body><div class="hdr"><h1>Construction & Demolition Waste Management Report</h1><p>LEED v4.1/v5 MRc5 Documentation â€” DivertScanâ„¢ by Dalmex Recycling LLC</p></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:16px 0;font-size:12px"><div><strong>Project:</strong> â€™ + (currentProject ? currentProject.name : â€˜-â€™) + â€™</div><div><strong>Report Date:</strong> â€™ + new Date().toLocaleDateString() + â€™</div><div><strong>Address:</strong> â€™ + (currentProject ? (currentProject.address || â€˜-â€™) : â€˜-â€™) + â€™</div><div><strong>Hauler:</strong> â€™ + (currentProject ? (currentProject.waste_hauler || â€˜-â€™) : â€˜-â€™) + â€˜</div></div><div class="stats"><div class="stat"><div class="v" style="color:#2d5a27">â€™ + divR + â€˜%</div><div class="l">Diversion Rate</div></div><div class="stat"><div class="v">â€™ + totalT.toFixed(2) + â€˜</div><div class="l">Total Tons</div></div><div class="stat"><div class="v" style="color:#2d5a27">â€™ + divT.toFixed(2) + â€˜</div><div class="l">Diverted</div></div><div class="stat"><div class="v" style="color:#c0392b">â€™ + lfT.toFixed(2) + â€˜</div><div class="l">Landfill</div></div></div><table><thead><tr><th>Date</th><th>Ticket #</th><th>Hauler</th><th style="text-align:right">Gross</th><th style="text-align:right">Tare</th><th style="text-align:right">Net (T)</th><th style="text-align:right">Diversion</th><th style="text-align:center">Verified</th></tr></thead><tbody>â€™ + rows + â€˜</tbody><tfoot><tr><td colspan="5">TOTALS</td><td style="text-align:right">â€™ + totalT.toFixed(2) + â€˜</td><td style="text-align:right;color:#2d5a27">â€™ + divR + â€˜%</td><td style="text-align:center">â€™ + reportData.filter(function(t){return t.human_verified}).length + â€˜/â€™ + reportData.length + â€˜</td></tr></tfoot></table><div class="cert"><strong>âœ… Facility Attestation</strong><p>This report was generated from verified scale ticket data processed through the DivertScanâ„¢ waste tracking system. All materials were received, sorted, and routed to documented end markets by Dalmex Recycling LLC. Diversion calculations are based on actual weighed tonnage with chain-of-custody documentation maintained for each load.</p>â€™ + sigHtml + â€™<p style="font-size:10px;color:#666;margin-top:12px">Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000</p><p style="font-size:10px;color:#666">Generated: â€™ + new Date().toLocaleString() + â€˜</p></div></body></html>â€™);
w.document.close();
setTimeout(function() { w.print(); }, 600);
}

// Add New Facility Modal (was missing â€” button existed but function didnâ€™t)
function showAddFacilityModal() {
const modal = document.createElement(â€˜divâ€™);
modal.id = â€˜addFacilityModalâ€™;
modal.style.cssText = â€˜position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20pxâ€™;
modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

```
modal.innerHTML = '<div style="background:var(--bg-secondary);border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto">' +
    '<div style="background:linear-gradient(135deg,#2d5a27,#1a3d15);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<div style="font-size:16px;font-weight:700;color:white">â• Add New Facility</div>' +
        '<button onclick="document.getElementById(\'addFacilityModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">Ã—</button>' +
    '</div>' +
    '<div style="padding:20px">' +
        '<div class="form-group">' +
            '<label class="form-label">Facility Name *</label>' +
            '<input type="text" id="newFacilityName" class="form-input" placeholder="e.g., ABC Concrete Recycling">' +
        '</div>' +
        '<div class="form-group">' +
            '<label class="form-label">Material Type</label>' +
            '<select id="newFacilityMaterial" class="form-input">' +
                '<option value="concrete">ğŸ§± Concrete / Masonry</option>' +
                '<option value="metal">ğŸ”© Metal / Scrap</option>' +
                '<option value="wood">ğŸªµ Wood / Pallets</option>' +
                '<option value="cardboard">ğŸ“¦ Cardboard / Paper</option>' +
                '<option value="drywall">ğŸ—ï¸ Drywall / Gypsum</option>' +
                '<option value="plastic">â™»ï¸ Plastic</option>' +
                '<option value="mixed">ğŸ”„ Mixed C&amp;D</option>' +
            '</select>' +
        '</div>' +
        '<div class="form-group">' +
            '<label class="form-label">Address</label>' +
            '<input type="text" id="newFacilityAddress" class="form-input" placeholder="Street, City, State ZIP">' +
        '</div>' +
        '<div class="form-group">' +
            '<label class="form-label">Contact / Phone</label>' +
            '<input type="text" id="newFacilityContact" class="form-input" placeholder="(xxx) xxx-xxxx">' +
        '</div>' +
        '<div class="form-group">' +
            '<label class="form-label">Notes</label>' +
            '<textarea id="newFacilityNotes" class="form-input" rows="2" placeholder="RCI certified, accepts loads Mon-Sat, etc."></textarea>' +
        '</div>' +
    '</div>' +
    '<div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'addFacilityModal\').remove()" style="flex:1">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveNewFacility()" style="flex:1">ğŸ’¾ Save Facility</button>' +
    '</div>' +
'</div>';

document.body.appendChild(modal);
```

}

function saveNewFacility() {
const name = document.getElementById(â€˜newFacilityNameâ€™)?.value?.trim();
if (!name) {
toast(â€˜Facility name is requiredâ€™, â€˜errorâ€™);
return;
}

```
const facility = {
    id: 'facility_' + Date.now(),
    name: name,
    material: document.getElementById('newFacilityMaterial')?.value || 'mixed',
    address: document.getElementById('newFacilityAddress')?.value?.trim() || '',
    contact: document.getElementById('newFacilityContact')?.value?.trim() || '',
    notes: document.getElementById('newFacilityNotes')?.value?.trim() || '',
    type: 'custom',
    icon: '',
    created_at: new Date().toISOString()
};

// Save to local storage
const facilities = getAllFacilities();
facilities.push(facility);
localStorage.setItem('divertscan_facilities', JSON.stringify(facilities));

// Also save to Supabase if available
if (sb) {
    try { sb.from('facilities').insert([facility]).then(function(){}); } catch(e) {}
}

document.getElementById('addFacilityModal').remove();
renderAllFacilities();
toast('Facility "' + name + '" added!', 'success');
```

}

// ===== FACILITY EDIT / DELETE CRUD =====
function deleteFacility(facilityId) {
setTimeout(function() {
if (!confirm(â€˜Delete this facility?â€™)) return;

```
    var facilities = getAllFacilities();
    facilities = facilities.filter(function(f) { return f.id !== facilityId; });
    localStorage.setItem('divertscan_facilities', JSON.stringify(facilities));
    
    if (sb) {
        try { sb.from('facilities').delete().eq('id', facilityId).then(function(){}); } catch(e) {}
    }
    
    renderAllFacilities();
    toast('Facility deleted', 'success');
}, 100);
```

}

function editFacility(facilityId) {
var facilities = getAllFacilities();
var fac = facilities.find(function(f) { return f.id === facilityId; });
if (!fac) { toast(â€˜Facility not foundâ€™, â€˜errorâ€™); return; }

```
var modal = document.createElement('div');
modal.id = 'editFacilityModal';
modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

var matOptions = ['concrete','metal','wood','cardboard','drywall','plastic','mixed','ewaste','asphalt','soil'].map(function(m) {
    return '<option value="'+m+'"'+(fac.material===m?' selected':'')+'>'+m.charAt(0).toUpperCase()+m.slice(1)+'</option>';
}).join('');

modal.innerHTML = '<div style="background:var(--bg-secondary);border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto">' +
    '<div style="background:linear-gradient(135deg,#2d5a27,#1a3d15);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<div style="font-size:16px;font-weight:700;color:white">âœï¸ Edit Facility</div>' +
        '<button onclick="document.getElementById(\'editFacilityModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">Ã—</button>' +
    '</div>' +
    '<div style="padding:20px">' +
        '<div class="form-group"><label class="form-label">Facility Name *</label><input type="text" id="editFacName" class="form-input" value="'+((fac.name||'').replace(/"/g,'&quot;'))+'"></div>' +
        '<div class="form-group"><label class="form-label">Material Type</label><select id="editFacMaterial" class="form-input">'+matOptions+'</select></div>' +
        '<div class="form-group"><label class="form-label">Address</label><input type="text" id="editFacAddress" class="form-input" value="'+((fac.address||'').replace(/"/g,'&quot;'))+'"></div>' +
        '<div class="form-group"><label class="form-label">Contact / Phone</label><input type="text" id="editFacContact" class="form-input" value="'+((fac.contact||'').replace(/"/g,'&quot;'))+'"></div>' +
        '<div class="form-group"><label class="form-label">Notes</label><textarea id="editFacNotes" class="form-input" rows="2">'+((fac.notes||''))+'</textarea></div>' +
    '</div>' +
    '<div style="padding:16px 20px;border-top:1px solid var(--border-color);display:flex;gap:8px">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'editFacilityModal\').remove()" style="flex:1">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveEditFacility(\''+facilityId+'\')" style="flex:1">ğŸ’¾ Save Changes</button>' +
    '</div>' +
'</div>';

document.body.appendChild(modal);
```

}

function saveEditFacility(facilityId) {
var name = document.getElementById(â€˜editFacNameâ€™)?.value?.trim();
if (!name) { toast(â€˜Name is requiredâ€™, â€˜errorâ€™); return; }

```
var facilities = getAllFacilities();
var idx = facilities.findIndex(function(f) { return f.id === facilityId; });
if (idx === -1) { toast('Facility not found', 'error'); return; }

facilities[idx].name = name;
facilities[idx].material = document.getElementById('editFacMaterial')?.value || 'mixed';
facilities[idx].address = document.getElementById('editFacAddress')?.value?.trim() || '';
facilities[idx].contact = document.getElementById('editFacContact')?.value?.trim() || '';
facilities[idx].notes = document.getElementById('editFacNotes')?.value?.trim() || '';
facilities[idx].updated_at = new Date().toISOString();

localStorage.setItem('divertscan_facilities', JSON.stringify(facilities));

// Supabase update
if (sb) {
    try { sb.from('facilities').update(facilities[idx]).eq('id', facilityId).then(function(){}); } catch(e) {}
}

document.getElementById('editFacilityModal').remove();
renderAllFacilities();
toast('Facility updated!', 'success');
```

}

// renderCustomFacilities redirects to the unified renderer
function renderCustomFacilities() { renderAllFacilities(); }

// ===== FULL FACILITY RENDERING â€” all from localStorage with CRUD =====
function getDefaultFacilities() {
return [
{id:â€˜fac_occâ€™, name:â€˜OCC / Paper / Fiberâ€™, material:â€˜cardboardâ€™, address:â€˜Georgia Pacific Â· Smurfit Westrock Â· Greenside Â· International Paper Â· American Fiberâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜verifiedâ€™, icon:â€˜ğŸ“¦â€™},
{id:â€˜fac_woodâ€™, name:â€˜Wood / Palletsâ€™, material:â€˜woodâ€™, address:â€˜Dalmex Pallets (In-House Reuse)â€™, contact:â€™â€™, notes:â€™â€™, type:â€˜ownedâ€™, icon:â€˜ğŸªµâ€™},
{id:â€˜fac_metalâ€™, name:â€˜Metal / Scrapâ€™, material:â€˜metalâ€™, address:â€˜CMC (Commercial Metals) Â· Cyclone Metal Recyclingâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜verifiedâ€™, icon:â€˜ğŸ”©â€™},
{id:â€˜fac_plasticâ€™, name:â€˜Plasticâ€™, material:â€˜plasticâ€™, address:â€˜Recycle USAâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜verifiedâ€™, icon:â€˜â™»ï¸â€™},
{id:â€˜fac_landfillâ€™, name:â€˜Landfillâ€™, material:â€˜landfillâ€™, address:â€˜Municipal Landfillâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜landfillâ€™, icon:â€˜ğŸ—‘ï¸â€™},
{id:â€˜fac_concreteâ€™, name:â€˜Concrete / Blockâ€™, material:â€˜concreteâ€™, address:â€˜Big City Concrete, Dallas TXâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜partnerâ€™, icon:â€˜ğŸ§±â€™},
{id:â€˜fac_drywallâ€™, name:â€˜Drywall / Gypsumâ€™, material:â€˜drywallâ€™, address:â€˜USA Gypsum, DFWâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜partnerâ€™, icon:â€˜ğŸ—ï¸â€™},
{id:â€˜fac_ewasteâ€™, name:â€˜E-Waste / Electronicsâ€™, material:â€˜ewasteâ€™, address:â€˜R2 Certified E-Waste Recyclerâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜partnerâ€™, icon:â€˜ğŸ–¥ï¸â€™},
{id:â€˜fac_asphaltâ€™, name:â€˜Asphalt / Shinglesâ€™, material:â€˜asphaltâ€™, address:â€˜DFW Asphalt Recyclingâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜partnerâ€™, icon:â€˜ğŸª¨â€™},
{id:â€˜fac_soilâ€™, name:â€˜Clean Soil / Fillâ€™, material:â€˜soilâ€™, address:â€˜DFW Soil Recyclingâ€™, contact:â€™â€™, notes:â€™â€™, type:â€˜partnerâ€™, icon:â€˜ğŸŒâ€™}
];
}

function initFacilities() {
var stored = localStorage.getItem(â€˜divertscan_facilitiesâ€™);
if (!stored) {
localStorage.setItem(â€˜divertscan_facilitiesâ€™, JSON.stringify(getDefaultFacilities()));
}
}

function getAllFacilities() {
initFacilities();
return JSON.parse(localStorage.getItem(â€˜divertscan_facilitiesâ€™) || â€˜[]â€™);
}

function renderAllFacilities() {
var container = document.getElementById(â€˜facilityNetworkListâ€™);
if (!container) return;

```
var facilities = getAllFacilities();

if (facilities.length === 0) {
    container.innerHTML = '<div style="color:var(--slate-500);font-size:12px;font-style:italic;padding:8px">No facilities configured.</div>';
    return;
}

var matIcons = {cardboard:'ğŸ“¦',wood:'ğŸªµ',metal:'ğŸ”©',plastic:'â™»ï¸',landfill:'ğŸ—‘ï¸',concrete:'ğŸ§±',drywall:'ğŸ—ï¸',ewaste:'ğŸ–¥ï¸',asphalt:'ğŸª¨',soil:'ğŸŒ',mixed:'ğŸ”„'};

// Group by type
var verified = facilities.filter(function(f){return f.type==='verified'||f.type==='owned'});
var landfill = facilities.filter(function(f){return f.type==='landfill'});
var partners = facilities.filter(function(f){return f.type==='partner'});
var custom = facilities.filter(function(f){return !f.type||f.type==='custom'});

function renderCard(f) {
    var icon = f.icon || matIcons[f.material] || 'ğŸ“‹';
    var borderColor = f.type==='landfill' ? 'var(--red-500)' : f.type==='partner' ? 'var(--blue-500)' : 'var(--emerald-500)';
    var badgeText = f.type==='owned' ? 'âœ“ OWNED' : f.type==='landfill' ? 'NON-DIVERT' : f.type==='partner' ? 'PARTNER' : f.type==='verified' ? 'âœ“ VERIFIED' : 'CUSTOM';
    var badgeBg = f.type==='landfill' ? 'background:var(--amber-600)' : f.type==='partner' ? 'background:var(--blue-500)' : f.type==='custom'||!f.type ? 'background:var(--slate-500)' : '';
    var subtitleColor = f.type==='landfill' ? 'var(--slate-400)' : f.type==='partner' ? 'var(--blue-500)' : 'var(--emerald-400)';
    
    return '<div style="background:var(--slate-700);border-radius:8px;padding:10px 12px;border-left:3px solid '+borderColor+';margin-bottom:6px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
            '<div style="flex:1;min-width:0">' +
                '<div style="font-size:12px;font-weight:600">'+icon+' '+f.name+'</div>' +
                '<div style="font-size:11px;color:'+subtitleColor+';overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+(f.address||f.material||'')+'</div>' +
                (f.contact ? '<div style="font-size:10px;color:var(--slate-400)">'+f.contact+'</div>' : '') +
                (f.notes ? '<div style="font-size:9px;color:var(--slate-500);margin-top:2px">'+f.notes+'</div>' : '') +
            '</div>' +
            '<div style="display:flex;align-items:center;gap:4px;flex-shrink:0;margin-left:8px">' +
                '<span class="leed-badge compliant" style="font-size:9px;'+badgeBg+'">'+badgeText+'</span>' +
                '<button onclick="editFacility(\''+f.id+'\')" style="background:var(--accent-info);border:none;color:white;width:26px;height:26px;border-radius:6px;font-size:11px;cursor:pointer" title="Edit">âœï¸</button>' +
                '<button onclick="deleteFacility(\''+f.id+'\')" style="background:var(--accent-danger);border:none;color:white;width:26px;height:26px;border-radius:6px;font-size:11px;cursor:pointer" title="Delete">ğŸ—‘ï¸</button>' +
            '</div>' +
        '</div>' +
    '</div>';
}

var html = '';

// Verified / Owned
if (verified.length > 0) {
    html += '<div style="font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:4px">âœ… VERIFIED END MARKETS</div>';
    html += verified.map(renderCard).join('');
}

// Landfill
if (landfill.length > 0) {
    html += landfill.map(renderCard).join('');
}

// Partners
if (partners.length > 0) {
    html += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border-color)">';
    html += '<div style="font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:4px">ğŸ¤ PARTNER FACILITIES (Direct to End Market)</div>';
    html += partners.map(renderCard).join('');
    html += '<div style="font-size:10px;color:var(--slate-400);margin-top:4px;font-style:italic">Partner loads go direct â€” scale ticket from partner facility counts for LEED credit</div>';
    html += '</div>';
}

// Custom
if (custom.length > 0) {
    html += '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border-color)">';
    html += '<div style="font-size:11px;font-weight:600;color:var(--slate-400);margin-bottom:4px">ğŸ“‹ CUSTOM FACILITIES</div>';
    html += custom.map(renderCard).join('');
    html += '</div>';
}

container.innerHTML = html;
```

}

function previewReportPDF() {
// Open report in new window for preview
const reportHtml = generateReportHTML();
const win = window.open(â€™â€™, â€˜_blankâ€™);
win.document.write(reportHtml);
win.document.close();
}

function generateReportHTML() {
if (!currentProject || !reportData || reportData.length === 0) {
return â€˜<html><body><h1>No data to display</h1></body></html>â€™;
}

```
// Calculate totals
const totalTons = reportData.reduce((s, t) => s + (t.net_tons || 0), 0);
const landfillTons = reportData.reduce((s, t) => s + (t.landfill_tons || 0), 0);
const divertedTons = totalTons - landfillTons;
const diversionRate = totalTons > 0 ? Math.round((divertedTons / totalTons) * 100) : 0;

const woodTons = reportData.reduce((s, t) => s + (t.wood_tons || 0), 0);
const concreteTons = reportData.reduce((s, t) => s + (t.concrete_tons || 0), 0);
const metalTons = reportData.reduce((s, t) => s + (t.metal_tons || 0), 0);
const cardboardTons = reportData.reduce((s, t) => s + (t.cardboard_tons || 0), 0);
const plasticTons = reportData.reduce((s, t) => s + (t.plastic_tons || 0), 0);
const drywallTons = reportData.reduce((s, t) => s + (t.drywall_tons || 0), 0);

const includeBranding = document.getElementById('includeDalMexBranding')?.checked !== false;
const includeCert = document.getElementById('includeCertification')?.checked !== false;
const includeAI = document.getElementById('includeAISummary')?.checked !== false;

return `
```

<!DOCTYPE html>

<html>
<head>
<title>LEED MRc5 Report - ${currentProject.name}</title>
<style>
body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #333; }
.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #2d5a27; padding-bottom: 20px; margin-bottom: 30px; }
.company { color: #2d5a27; }
.company h1 { font-size: 24px; margin: 0; }
.company p { font-size: 12px; margin: 5px 0 0; color: #666; }
.report-title { text-align: right; }
.report-title h2 { font-size: 18px; margin: 0; color: #333; }
.report-title p { font-size: 11px; color: #666; margin: 5px 0 0; }
h3 { color: #2d5a27; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-top: 30px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 12px; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
th { background: #f5f5f5; font-weight: 600; }
.highlight { background: #e8f5e9; }
.summary-box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
.summary-box h4 { margin: 0 0 10px; color: #2d5a27; }
.big-number { font-size: 36px; font-weight: bold; color: #2d5a27; }
.certification { border: 2px solid #2d5a27; padding: 20px; margin-top: 30px; }
.certification h4 { color: #2d5a27; margin: 0 0 10px; }
.signature-line { border-top: 1px solid #333; width: 250px; margin-top: 40px; padding-top: 5px; font-size: 11px; }
.ai-summary { background: #f0fdf4; border-left: 4px solid #2d5a27; padding: 15px; margin: 20px 0; font-size: 12px; line-height: 1.6; }
.footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 10px; color: #666; text-align: center; }
@media print { body { padding: 20px; } }
</style>
</head>
<body>

${includeBranding ? `

<div class="header">
<div class="company">
<h1>${companyInfo.name}</h1>
<p>${companyInfo.address}<br>${companyInfo.phone}</p>
</div>
<div class="report-title">
<h2>C&D Waste Diversion Report</h2>
<p>LEED MRc5 Documentation<br>Generated: ${new Date().toLocaleDateString()}</p>
</div>
</div>
` : ''}

<h3>Project Information</h3>
<table>
<tr><td width="30%"><strong>Project Name</strong></td><td>${currentProject.name}</td></tr>
<tr><td><strong>Address</strong></td><td>${currentProject.address || 'N/A'}</td></tr>
<tr><td><strong>General Contractor</strong></td><td>${currentProject.general_contractor || 'N/A'}</td></tr>
<tr><td><strong>Waste Hauler</strong></td><td>${currentProject.waste_hauler || 'N/A'}</td></tr>
<tr><td><strong>Report Period</strong></td><td>${reportData[0]?.service_date || 'N/A'} to ${reportData[reportData.length-1]?.service_date || 'N/A'}</td></tr>
</table>

<div class="summary-box">
<h4>Diversion Summary</h4>
<div style="display:flex;justify-content:space-around;text-align:center">
<div><div class="big-number">${totalTons.toFixed(1)}</div><div>Total Tons</div></div>
<div><div class="big-number" style="color:${diversionRate >= 75 ? '#2d5a27' : '#f59e0b'}">${diversionRate}%</div><div>Diversion Rate</div></div>
<div><div class="big-number">${reportData.length}</div><div>Total Loads</div></div>
</div>
</div>

${includeAI && aiSummaryText ? `

<h3>Executive Summary</h3>
<div class="ai-summary">${aiSummaryText}</div>
` : ''}

<h3>Material Breakdown & Verified End Markets</h3>
<p style="font-size:11px;color:#666;margin-bottom:8px">All materials processed by Dalmex Recycling LLC, Dallas TX â€” routed to verified downstream buyers</p>
<table>
<tr><th>Material Stream</th><th>Tons</th><th>%</th><th>End Market Destination</th><th>Verification</th></tr>
<tr><td>OCC / Paper / Fiber</td><td>${cardboardTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(cardboardTons/totalTons*100) : 0}%</td><td>Georgia Pacific Â· Smurfit Westrock Â· Greenside Â· Intl Paper Â· American Fiber</td><td style="color:#2d5a27">âœ“ Verified</td></tr>
<tr><td>Wood / Pallets</td><td>${woodTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(woodTons/totalTons*100) : 0}%</td><td>Dalmex Pallets (In-House Reuse)</td><td style="color:#2d5a27">âœ“ Owned</td></tr>
<tr><td>Metal / Scrap</td><td>${metalTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(metalTons/totalTons*100) : 0}%</td><td>CMC (Commercial Metals) Â· Cyclone Metal Recycling</td><td style="color:#2d5a27">âœ“ Verified</td></tr>
<tr><td>Plastic</td><td>${plasticTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(plasticTons/totalTons*100) : 0}%</td><td>Recycle USA</td><td style="color:#2d5a27">âœ“ Verified</td></tr>
<tr class="highlight"><td><strong>Total Diverted</strong></td><td><strong>${divertedTons.toFixed(2)}</strong></td><td><strong>${diversionRate}%</strong></td><td colspan="2"><strong>All end markets verified â€” closed-loop documentation</strong></td></tr>
<tr style="background:#fff5f5"><td>Landfill</td><td>${landfillTons.toFixed(2)}</td><td>${totalTons > 0 ? Math.round(landfillTons/totalTons*100) : 0}%</td><td>Municipal Landfill</td><td>N/A</td></tr>
</table>

<h3>End Market Facility Certifications</h3>
<table>
<tr><th>End Market</th><th>Type</th><th>Materials Accepted</th><th>License Status</th></tr>
<tr><td>Georgia-Pacific Recycling</td><td>Paper Mill</td><td>OCC, Paper, Fiber</td><td style="color:#2d5a27">âœ“ Active - National</td></tr>
<tr><td>Smurfit Westrock</td><td>Paper Mill</td><td>OCC, Paper, Fiber</td><td style="color:#2d5a27">âœ“ Active - National</td></tr>
<tr><td>Greenside Recycling</td><td>OCC Recycler</td><td>OCC, Paper</td><td style="color:#2d5a27">âœ“ Active - TX Licensed</td></tr>
<tr><td>International Paper</td><td>Paper Mill</td><td>OCC, Paper, Fiber</td><td style="color:#2d5a27">âœ“ Active - National</td></tr>
<tr><td>American Fiber</td><td>Fiber Recycler</td><td>OCC, Paper</td><td style="color:#2d5a27">âœ“ Active - DFW</td></tr>
<tr><td>Dalmex Pallets</td><td>Wood Reuse / Pallet Mfg</td><td>Wood, Lumber, Pallets</td><td style="color:#2d5a27">âœ“ Owned - TX Licensed</td></tr>
<tr><td>CMC (Commercial Metals)</td><td>Scrap Metal Recycler</td><td>Steel, Aluminum, Copper</td><td style="color:#2d5a27">âœ“ Active - National</td></tr>
<tr><td>Cyclone Metal Recycling</td><td>Scrap Metal Recycler</td><td>Steel, Aluminum, Rebar</td><td style="color:#2d5a27">âœ“ Active - TX Licensed</td></tr>
<tr><td>Recycle USA</td><td>Plastics Recycler</td><td>HDPE, LDPE, PVC, Mixed</td><td style="color:#2d5a27">âœ“ Active - AR Licensed</td></tr>
</table>

<h3>Load Details</h3>
<table>
<tr><th>Date</th><th>Ticket #</th><th>Hauler</th><th>Net Tons</th><th>Diversion</th><th>Verified</th></tr>
${reportData.map(t => `
<tr>
<td>${t.service_date || 'N/A'}</td>
<td>${t.ticket_number || 'N/A'}</td>
<td>${t.hauler || 'N/A'}</td>
<td>${(t.net_tons || 0).toFixed(2)}</td>
<td>${t.diversion_pct || 0}%</td>
<td>${t.human_verified ? 'âœ“' : '-'}</td>
</tr>
`).join('')}
</table>

${includeCert ? `

<div class="certification">
<h4>Facility Attestation</h4>
<p>This report was generated from verified scale ticket data processed through the DivertScanâ„¢ waste tracking system. All materials were received, sorted, and routed to documented end markets by Dalmex Recycling LLC. Diversion calculations are based on actual weighed tonnage with chain-of-custody documentation maintained for each load.</p>
<div style="margin-top:12px;padding:8px;background:#f5f5f5;border-radius:4px;font-size:10px;color:#666"><strong>Processing Facility:</strong> Dalmex Recycling LLC | 2828 Nagle St., Dallas, TX 75220 | (214) 352-2000</div>
</div>
` : ''}

<div class="footer">
Generated by DivertScanâ„¢ Enterprise | ${companyInfo.name} | ${new Date().toLocaleString()}
</div>

</body>
</html>
`;
}

// ========== AUDIT PACKAGE ==========
async function generateAuditPackage() {
if (!currentProject) {
toast(â€˜Select a project firstâ€™, â€˜errorâ€™);
return;
}

```
showLoading('Generating LEED Audit Package...');
document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">â³ Preparing documentation...</span>';

try {
    // Get tickets from both Supabase AND local storage
    let remoteTickets = [];
    let localTickets = [];
    
    // Try Supabase if configured (with 5s timeout)
    if (sb) {
        try {
            const sbPromise = sb
                .from('tickets')
                .select('*')
                .eq('project_id', currentProject.id)
                .order('service_date', { ascending: true });
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('timeout')), 5000)
            );
            const result = await Promise.race([sbPromise, timeoutPromise]);
            if (result && !result.error && result.data) remoteTickets = result.data;
        } catch (e) {
            console.log('Supabase fetch skipped:', e.message);
        }
    }
    
    // Always get local tickets (Excel imports stored here)
    try {
        const allLocal = await getAllFromLocal('tickets') || [];
        localTickets = allLocal.filter(t => t.project_id === currentProject.id);
    } catch (e) {
        console.log('Local fetch error:', e.message);
    }
    
    // Merge and dedupe
    const ticketMap = new Map();
    localTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
    remoteTickets.forEach(t => ticketMap.set(t.ticket_number || t.id, t));
    
    const allTickets = Array.from(ticketMap.values());
    allTickets.sort((a, b) => new Date(a.service_date) - new Date(b.service_date));
    
    if (allTickets.length === 0) {
        hideLoading();
        toast('No tickets found', 'error');
        return;
    }
    
    // Store for report generation
    reportData = allTickets;
    
    // Generate AI summary if not already done
    if (!aiSummaryText) {
        document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">â³ Generating AI summary...</span>';
        await generateAISummary();
    }
    
    // Generate report HTML
    document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">â³ Creating PDF report...</span>';
    
    // Download the main PDF
    await downloadReportPDF();
    
    // Download CSV data
    document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">â³ Exporting data spreadsheet...</span>';
    downloadReportCSV();
    
    // Download Excel if available
    if (typeof XLSX !== 'undefined') {
        document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--amber-400)">â³ Creating Excel workbook...</span>';
        downloadReportExcel();
    }
    
    hideLoading();
    document.getElementById('auditPackageStatus').innerHTML = `
        <span style="color:var(--emerald-400)">âœ… Audit Package Generated!</span><br>
        <span style="font-size:10px">â€¢ PDF Report downloaded<br>â€¢ CSV Data downloaded<br>â€¢ Excel workbook downloaded<br>â€¢ ${allTickets.length} tickets included</span>
    `;
    
    toast('Audit Package complete!', 'success');
    
} catch (err) {
    hideLoading();
    document.getElementById('auditPackageStatus').innerHTML = '<span style="color:var(--red-500)">âŒ Error: ' + err.message + '</span>';
    toast('Error generating package', 'error');
}
```

}

// ========== PROJECT COMPARISON ==========
let comparisonChart = null;

async function loadProjectComparison() {
showLoading(â€˜Loading project comparisonâ€¦â€™);

```
try {
    // Get all projects from local + remote
    let allProjects = [];
    
    try { allProjects = await getAllFromLocal('projects') || []; } catch(e) {}
    
    if (sb) {
        try {
            const tp = new Promise((_, r) => setTimeout(() => r(new Error('timeout')), 5000));
            const res = await Promise.race([sb.from('projects').select('id, name'), tp]);
            if (res?.data) {
                res.data.forEach(p => { if (!allProjects.find(lp => lp.id === p.id)) allProjects.push(p); });
            }
        } catch(e) { console.log('Supabase comparison skipped:', e.message); }
    }
    
    if (allProjects.length === 0) {
        hideLoading();
        toast('No projects found', 'error');
        return;
    }
    
    // Get stats for each project
    const allTickets = await getAllFromLocal('tickets') || [];
    const projectStats = [];
    
    for (const proj of allProjects) {
        const projTickets = allTickets.filter(t => t.project_id === proj.id);
        
        if (projTickets.length > 0) {
            const totalTons = projTickets.reduce((s, t) => s + (t.net_tons || 0), 0);
            const landfillTons = projTickets.reduce((s, t) => s + (t.landfill_tons || 0), 0);
            const rate = totalTons > 0 ? Math.round(((totalTons - landfillTons) / totalTons) * 100) : 0;
            
            projectStats.push({
                name: proj.name.substring(0, 20),
                rate: rate,
                tons: totalTons,
                loads: projTickets.length
            });
        }
    }
    
    hideLoading();
    
    if (projectStats.length === 0) {
        toast('No ticket data found', 'error');
        return;
    }
    
    // Create chart
    const ctx = document.getElementById('comparisonChart');
    if (comparisonChart) comparisonChart.destroy();
    
    comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: projectStats.map(p => p.name),
            datasets: [{
                label: 'Diversion Rate %',
                data: projectStats.map(p => p.rate),
                backgroundColor: projectStats.map(p => p.rate >= 75 ? '#10b981' : p.rate >= 50 ? '#f59e0b' : '#ef4444'),
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: { 
                    beginAtZero: true, 
                    max: 100,
                    ticks: { color: '#94a3b8' },
                    grid: { color: '#334155' }
                },
                y: { 
                    ticks: { color: '#94a3b8', font: { size: 10 } },
                    grid: { display: false }
                }
            }
        }
    });
    
    toast('Comparison loaded!', 'success');
    
} catch (err) {
    hideLoading();
    toast('Error: ' + err.message, 'error');
}
```

}

// ========== EMAIL REPORT ==========
function emailReport() {
if (!currentProject) {
toast(â€˜Generate report firstâ€™, â€˜errorâ€™);
return;
}

```
const subject = encodeURIComponent(`LEED MRc5 Report - ${currentProject.name}`);
const body = encodeURIComponent(`Please find attached the LEED MRc5 Waste Diversion Report for ${currentProject.name}.\n\n${aiSummaryText ? 'Summary:\n' + aiSummaryText : ''}\n\nGenerated by DivertScanâ„¢ Enterprise`);

window.open(`mailto:?subject=${subject}&body=${body}`);
toast('Opening email client...', 'success');
```

}

// ========== VOICE INPUT ==========
let recognition = null;
let isListening = false;

function initVoiceRecognition() {
if (â€˜webkitSpeechRecognitionâ€™ in window || â€˜SpeechRecognitionâ€™ in window) {
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
recognition = new SpeechRecognition();
recognition.continuous = false;
recognition.interimResults = true;
recognition.lang = â€˜en-USâ€™;

```
    recognition.onstart = function() {
        isListening = true;
        document.getElementById('voiceInputBtn').classList.add('listening');
        document.getElementById('voiceStatus').textContent = 'Listening...';
        document.getElementById('voiceTranscript').classList.remove('hidden');
    };
    
    recognition.onresult = function(event) {
        let transcript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            transcript += event.results[i][0].transcript;
        }
        document.getElementById('voiceTranscript').textContent = transcript;
        
        // If final result, parse it
        if (event.results[event.results.length - 1].isFinal) {
            parseVoiceInput(transcript);
        }
    };
    
    recognition.onerror = function(event) {
        console.error('Voice recognition error:', event.error);
        document.getElementById('voiceStatus').textContent = 'Error: ' + event.error;
        stopVoiceInput();
    };
    
    recognition.onend = function() {
        stopVoiceInput();
    };
    
    return true;
}
return false;
```

}

function toggleVoiceInput() {
if (!recognition) {
if (!initVoiceRecognition()) {
toast(â€˜Voice input not supported in this browserâ€™, â€˜errorâ€™);
return;
}
}

```
if (isListening) {
    recognition.stop();
} else {
    try {
        recognition.start();
    } catch (e) {
        console.error('Voice start error:', e);
        toast('Could not start voice input', 'error');
    }
}
```

}

function stopVoiceInput() {
isListening = false;
document.getElementById(â€˜voiceInputBtnâ€™).classList.remove(â€˜listeningâ€™);
document.getElementById(â€˜voiceStatusâ€™).textContent = â€˜Tap to speak ticket infoâ€™;
}

function parseVoiceInput(transcript) {
console.log(â€˜Parsing voice input:â€™, transcript);
const lower = transcript.toLowerCase();

```
// Parse ticket number
const ticketMatch = lower.match(/ticket\s*(?:number|#|num)?\s*(\d+)/i);
if (ticketMatch) {
    document.getElementById('ticketNumber').value = ticketMatch[1];
    toast('Ticket #: ' + ticketMatch[1], 'success');
}

// Parse gross weight
const grossMatch = lower.match(/gross\s*(?:weight|is)?\s*(\d+[\d,]*)/i);
if (grossMatch) {
    const gross = parseInt(grossMatch[1].replace(/,/g, ''));
    document.getElementById('grossLbs').value = gross;
    updateNetWeight();
    toast('Gross: ' + gross.toLocaleString() + ' lbs', 'success');
}

// Parse tare weight
const tareMatch = lower.match(/tare\s*(?:weight|is)?\s*(\d+[\d,]*)/i);
if (tareMatch) {
    const tare = parseInt(tareMatch[1].replace(/,/g, ''));
    document.getElementById('tareLbs').value = tare;
    updateNetWeight();
    toast('Tare: ' + tare.toLocaleString() + ' lbs', 'success');
}

// Parse weight without prefix (assume gross if only one number)
const weightMatch = lower.match(/(\d{4,})\s*(?:pounds|lbs)?/);
if (weightMatch && !grossMatch && !tareMatch) {
    const weight = parseInt(weightMatch[1].replace(/,/g, ''));
    if (!document.getElementById('grossLbs').value) {
        document.getElementById('grossLbs').value = weight;
        updateNetWeight();
        toast('Gross: ' + weight.toLocaleString() + ' lbs', 'success');
    }
}

// Parse hauler name
const haulerMatch = lower.match(/hauler\s*(?:is|name)?\s*(.+?)(?:\s*ticket|\s*gross|\s*$)/i);
if (haulerMatch) {
    document.getElementById('haulerName').value = haulerMatch[1].trim();
    toast('Hauler: ' + haulerMatch[1].trim(), 'success');
}
```

}

// ========== CHARTS ==========
let materialTrendChart = null;
let diversionChart = null;

async function updateCharts() {
if (!currentProject) return;

```
try {
    // Use local tickets array first (matches what user sees)
    var data = tickets.filter(function(t) { return t.project_id === currentProject.id; });
    
    // If no local data, try Supabase
    if (data.length === 0 && sb) {
        try {
            var result = await Promise.race([
                sb.from('tickets').select('*').eq('project_id', currentProject.id).order('created_at', {ascending:true}).limit(20),
                new Promise(function(_,r){setTimeout(function(){r(new Error('timeout'))},5000)})
            ]);
            if (result && !result.error && result.data) data = result.data;
        } catch(e) {}
    }
    
    if (!data || data.length === 0) {
        // Clear charts when no data
        if (materialTrendChart) { materialTrendChart.destroy(); materialTrendChart = null; }
        if (diversionChart) { diversionChart.destroy(); diversionChart = null; }
        return;
    }
    
    data.sort(function(a,b) { return new Date(a.created_at||a.service_date) - new Date(b.created_at||b.service_date); });
    
    // Material Trend Chart
    const labels = data.map((t, i) => '#' + (t.ticket_number || (i + 1)));
    const woodData = data.map(t => t.wood_pct || 0);
    const concreteData = data.map(t => t.concrete_pct || 0);
    const metalData = data.map(t => t.metal_pct || 0);
    const landfillData = data.map(t => t.landfill_pct || 0);
    
    const ctx1 = document.getElementById('materialTrendChart');
    if (ctx1) {
        if (materialTrendChart) materialTrendChart.destroy();
        
        materialTrendChart = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels.slice(-10),
                datasets: [
                    { label: 'Wood', data: woodData.slice(-10), borderColor: '#a78b5b', backgroundColor: 'rgba(167,139,91,0.1)', tension: 0.3 },
                    { label: 'Concrete', data: concreteData.slice(-10), borderColor: '#6b7280', backgroundColor: 'rgba(107,114,128,0.1)', tension: 0.3 },
                    { label: 'Metal', data: metalData.slice(-10), borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', tension: 0.3 },
                    { label: 'Landfill', data: landfillData.slice(-10), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.3 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 }, color: '#94a3b8' } }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { display: false } }
                }
            }
        });
    }
    
    // Diversion Rate Chart
    const diversionData = data.map(t => t.diversion_pct || 0);
    
    const ctx2 = document.getElementById('diversionChart');
    if (ctx2) {
        if (diversionChart) diversionChart.destroy();
        
        diversionChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labels.slice(-10),
                datasets: [{
                    label: 'Diversion %',
                    data: diversionData.slice(-10),
                    backgroundColor: diversionData.slice(-10).map(d => d >= 75 ? '#10b981' : d >= 50 ? '#f59e0b' : '#ef4444'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: { type: 'line', yMin: 75, yMax: 75, borderColor: '#10b981', borderWidth: 2, borderDash: [5, 5] }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { color: '#334155' } },
                    x: { ticks: { color: '#94a3b8', font: { size: 9 } }, grid: { display: false } }
                }
            }
        });
    }
    
} catch (err) {
    console.error('Chart update error:', err);
}
```

}

// ========== LEED PREDICTOR ==========
async function updateLeedPredictor() {
// Widget removed â€” safe no-op
}

// Load news on page load
document.addEventListener(â€˜DOMContentLoadedâ€™, function() {
setTimeout(refreshLeedNews, 2000);
});

// ========== LOGIN / AUTH SYSTEM ==========
const ADMIN_CREDENTIALS = { username: â€˜adminâ€™, password: â€˜dalmex2024â€™ };
let userRole = null; // â€˜adminâ€™ or â€˜customerâ€™

// Company Info (DalMex defaults)
let companyInfo = {
name: â€˜DalMex Recycling LLCâ€™,
address: â€˜2828 Nagel St., Dallas, TX 75220â€™,
phone: â€˜(214) 352-2000â€™
};

function switchLoginTab(tab) {
document.querySelectorAll(â€™.login-tabâ€™).forEach(t => t.classList.remove(â€˜activeâ€™));
event.target.classList.add(â€˜activeâ€™);

```
document.getElementById('adminLoginForm').classList.add('hidden');
document.getElementById('portalLoginForm').classList.add('hidden');

if (tab === 'admin') {
    document.getElementById('adminLoginForm').classList.remove('hidden');
} else {
    document.getElementById('portalLoginForm').classList.remove('hidden');
}
```

}

// Unified portal login â€” smart routing: crew codes â†’ operator, project codes â†’ customer
async function doPortalLogin() {
var code = (document.getElementById(â€˜portalCodeâ€™).value || â€˜â€™).trim().toUpperCase();
if (!code) {
document.getElementById(â€˜portalLoginErrorâ€™).textContent = â€˜Please enter an access codeâ€™;
return;
}

```
// Check if it's a crew/operator code
if (code === 'DALMEX' || code === 'DALMEX2025' || code === 'CREW') {
    userRole = 'operator';
    localStorage.setItem('divertscan_session', JSON.stringify({ role: 'operator', time: Date.now() }));
    showMainApp();
    return;
}

// Otherwise try customer project code
if (!sb) {
    var url = localStorage.getItem('divertscan_sb_url') || DEFAULT_KEYS.sbUrl;
    var key = localStorage.getItem('divertscan_sb_key') || DEFAULT_KEYS.sbKey;
    if (url && key) {
        sb = supabase.createClient(url, key);
    } else {
        document.getElementById('portalLoginError').textContent = 'System not configured. Contact DalMex at (214) 352-2000.';
        return;
    }
}

try {
    // First try exact access_code match
    var result = await sb.from('projects').select('*').eq('access_code', code);
    
    if (result.error || !result.data || result.data.length === 0) {
        document.getElementById('portalLoginError').textContent = 'Invalid access code';
        return;
    }
    
    userRole = 'customer';
    
    if (result.data.length === 1) {
        // Single project â€” direct login
        currentProject = result.data[0];
        window._customerProjects = result.data;
    } else {
        // Multiple projects share this code â€” store all, default to first
        window._customerProjects = result.data;
        currentProject = result.data[0];
    }
    
    localStorage.setItem('divertscan_session', JSON.stringify({ 
        role: 'customer', 
        accessCode: code,
        projectId: currentProject.id, 
        time: Date.now() 
    }));
    showMainApp();
} catch(err) {
    document.getElementById('portalLoginError').textContent = 'Error: ' + err.message;
}
```

}

function doAdminLogin() {
const username = document.getElementById(â€˜adminUsernameâ€™).value.trim();
const password = document.getElementById(â€˜adminPasswordâ€™).value;

```
if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
    userRole = 'admin';
    localStorage.setItem('divertscan_session', JSON.stringify({ role: 'admin', time: Date.now() }));
    showMainApp();
} else {
    document.getElementById('adminLoginError').textContent = 'Invalid username or password';
}
```

}

// Legacy login functions removed â€” unified into doPortalLogin()

function showCustomerProjectSwitcher() {
var custProjects = window._customerProjects || [];
if (custProjects.length <= 1) return;

```
var existing = document.getElementById('custProjectSwitchModal');
if (existing) existing.remove();

var modal = document.createElement('div');
modal.id = 'custProjectSwitchModal';
modal.className = 'modal active';
modal.innerHTML = '<div class="modal-content" style="max-width:400px">' +
    '<div class="modal-header">' +
        '<div class="modal-title">ğŸ“ Switch Project</div>' +
        '<button class="modal-close" onclick="document.getElementById(\'custProjectSwitchModal\').remove()">Ã—</button>' +
    '</div>' +
    '<div class="modal-body">' +
        '<div style="font-size:12px;color:var(--slate-400);margin-bottom:12px">Select a project to view:</div>' +
        custProjects.map(function(p) {
            var isActive = currentProject && currentProject.id === p.id;
            return '<div onclick="switchCustomerProject(\'' + p.id + '\')" style="padding:14px 16px;background:' + (isActive ? 'var(--emerald-500)' : 'var(--slate-800)') + ';border-radius:8px;margin-bottom:8px;cursor:pointer;border:1px solid ' + (isActive ? 'var(--emerald-400)' : 'var(--slate-700)') + '">' +
                '<div style="font-size:14px;font-weight:600;color:' + (isActive ? 'white' : 'var(--slate-200)') + '">' + (p.name || 'Unnamed') + '</div>' +
                '<div style="font-size:11px;color:' + (isActive ? 'rgba(255,255,255,0.8)' : 'var(--slate-400)') + ';margin-top:2px">' + (p.address || '') + '</div>' +
                (isActive ? '<div style="font-size:10px;color:rgba(255,255,255,0.9);margin-top:4px">âœ… Currently viewing</div>' : '') +
            '</div>';
        }).join('') +
    '</div>' +
'</div>';
document.body.appendChild(modal);
```

}

async function switchCustomerProject(projectId) {
var custProjects = window._customerProjects || [];
var proj = custProjects.find(function(p) { return p.id === projectId; });
if (!proj) return;

```
currentProject = proj;
document.getElementById('portalProjectName').textContent = proj.name;

// Update session
var session = JSON.parse(localStorage.getItem('divertscan_session') || '{}');
session.projectId = proj.id;
localStorage.setItem('divertscan_session', JSON.stringify(session));

// Close modal
var modal = document.getElementById('custProjectSwitchModal');
if (modal) modal.remove();

// Reload data for new project
await loadAllTicketsForProject();
await updateStats();
loadCustomerUploadHistory();

// Re-generate report if on reports tab
var reportSel = document.getElementById('reportProjectSelect');
if (reportSel) {
    reportSel.value = proj.id;
    generateReport();
}

toast('Switched to ' + proj.name, 'success');
```

}

function showMainApp() {
document.getElementById(â€˜loginScreenâ€™).classList.add(â€˜hiddenâ€™);
document.getElementById(â€˜appContainerâ€™).classList.add(â€˜activeâ€™);
document.body.classList.add(â€˜logged-inâ€™);

```
// Hide all headers and navs first
document.getElementById('adminHeader').classList.add('hidden');
document.getElementById('customerHeader').classList.add('hidden');
document.getElementById('operatorHeader').classList.add('hidden');
document.getElementById('portalBanner').classList.add('hidden');
document.getElementById('adminNav').classList.add('hidden');
document.getElementById('customerNav').classList.add('hidden');
document.getElementById('operatorNav').classList.add('hidden');

if (userRole === 'admin') {
    document.getElementById('adminHeader').classList.remove('hidden');
    document.getElementById('adminNav').classList.remove('hidden');
    applyRoleVisibility();
    initializeApp();
} else if (userRole === 'operator') {
    document.getElementById('operatorHeader').classList.remove('hidden');
    document.getElementById('operatorNav').classList.remove('hidden');
    applyRoleVisibility();
    initOperatorMode();
} else {
    document.getElementById('customerHeader').classList.remove('hidden');
    document.getElementById('portalBanner').classList.remove('hidden');
    document.getElementById('customerNav').classList.remove('hidden');
    applyRoleVisibility();
    document.getElementById('portalProjectName').textContent = currentProject.name;
    initCustomerPortal();
}
```

}

// Apply role-based visibility â€” call after any dynamic render
function applyRoleVisibility() {
if (userRole === â€˜adminâ€™) {
document.querySelectorAll(â€™.admin-onlyâ€™).forEach(el => el.style.display = â€˜â€™);
} else {
document.querySelectorAll(â€™.admin-onlyâ€™).forEach(el => el.style.display = â€˜noneâ€™);
}
}

// ========== OPERATOR MODE ==========
var opData = {
scaleTicketPhoto: null,
debrisPhotos: [null, null, null],
selectedProjectId: null
};

async function initOperatorMode() {
// Connect to Supabase
var url = localStorage.getItem(â€˜divertscan_sb_urlâ€™) || DEFAULT_KEYS.sbUrl;
var key = localStorage.getItem(â€˜divertscan_sb_keyâ€™) || DEFAULT_KEYS.sbKey;
if (url && key && !sb) {
sb = supabase.createClient(url, key);
}

```
// Load projects for picker â€” wait for completion
try {
    if (sb) {
        var result = await sb.from('projects').select('*').order('name');
        if (result.data && result.data.length > 0) {
            window._allProjectsList = result.data;
        }
    }
} catch(e) {
    console.error('Operator project load:', e);
}

showTab('operatorScan');

// If only one project, auto-select it
var allProjects = window._allProjectsList || [];
if (allProjects.length === 1) {
    var picker = document.getElementById('opProjectPicker');
    if (picker) {
        picker.value = allProjects[0].id;
        opSelectProject();
    }
}
```

}

function populateOpProjectPicker() {
var picker = document.getElementById(â€˜opProjectPickerâ€™);
if (!picker) return;
var allProjects = window._allProjectsList || [];
picker.innerHTML = â€˜<option value="">â€” Pick a project â€”</option>â€™;
allProjects.forEach(function(p) {
picker.innerHTML += â€˜<option value="' + p.id + '">â€™ + (p.name || â€˜Unnamedâ€™) + â€˜</option>â€™;
});
}

function opSelectProject() {
var picker = document.getElementById(â€˜opProjectPickerâ€™);
opData.selectedProjectId = picker.value || null;
var section = document.getElementById(â€˜opSelectedProjectâ€™);
if (opData.selectedProjectId) {
section.classList.remove(â€˜hiddenâ€™);
} else {
section.classList.add(â€˜hiddenâ€™);
}
}

function opCaptureTicket() {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™; input.accept = â€˜image/*â€™; input.capture = â€˜environmentâ€™;
input.style.cssText = â€˜position:fixed;left:-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0]; if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
opData.scaleTicketPhoto = cropped;
document.getElementById(â€˜opTicketPreviewâ€™).innerHTML = â€˜<img src="' + cropped + '" style="width:100%;border-radius:8px"><div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 10px;border-radius:6px;font-size:10px">âœ… Captured</div>â€™;
}, â€˜ticketâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function opUploadTicket() {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™; input.accept = â€˜image/*â€™;
input.style.cssText = â€˜position:fixed;left:-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0]; if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
opData.scaleTicketPhoto = cropped;
document.getElementById(â€˜opTicketPreviewâ€™).innerHTML = â€˜<img src="' + cropped + '" style="width:100%;border-radius:8px"><div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 10px;border-radius:6px;font-size:10px">âœ… Captured</div>â€™;
}, â€˜ticketâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function opCaptureDebris(slot) {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™; input.accept = â€˜image/*â€™; input.capture = â€˜environmentâ€™;
input.style.cssText = â€˜position:fixed;left:-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0]; if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
opData.debrisPhotos[slot] = cropped;
var slotEl = document.getElementById(â€˜opPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜<img src="' + cropped + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px">â€™ +
â€˜<div onclick="event.stopPropagation();opRemovePhoto(' + slot + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>â€™;
}, â€˜debrisâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function opUploadDebris(slot) {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™; input.accept = â€˜image/*â€™;
input.style.cssText = â€˜position:fixed;left:-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0]; if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
opData.debrisPhotos[slot] = cropped;
var slotEl = document.getElementById(â€˜opPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜<img src="' + cropped + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px">â€™ +
â€˜<div onclick="event.stopPropagation();opRemovePhoto(' + slot + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>â€™;
}, â€˜debrisâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function opRemovePhoto(slot) {
opData.debrisPhotos[slot] = null;
var slotEl = document.getElementById(â€˜opPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜<span style="font-size:24px">â€™ + (slot === 0 ? â€˜ğŸ“·â€™ : â€˜+â€™) + â€˜</span>â€™;
}

async function opSubmitScan() {
if (!opData.selectedProjectId) { toast(â€˜Select a project firstâ€™, â€˜errorâ€™); return; }
if (!opData.scaleTicketPhoto) { toast(â€˜Take a scale ticket photo firstâ€™, â€˜errorâ€™); return; }

```
var notes = (document.getElementById('opNotes').value || '').trim();
var photoCount = opData.debrisPhotos.filter(function(p) { return p; }).length;
var ticketNum = 'OP-' + Date.now().toString(36).toUpperCase();

var record = {
    project_id: opData.selectedProjectId,
    ticket_number: ticketNum,
    service_date: new Date().toISOString().split('T')[0],
    hauler: 'Dalmex Floor',
    submitted_by: 'operator',
    customer_notes: notes,
    human_verified: false,
    is_closed: false,
    import_source: 'Operator Scan',
    scale_ticket_photo: opData.scaleTicketPhoto,
    wood_pct: 0, concrete_pct: 0, metal_pct: 0, cardboard_pct: 0,
    plastic_pct: 0, drywall_pct: 0, landfill_pct: 100,
    gross_lbs: 0, tare_lbs: 0, net_lbs: 0, net_tons: 0,
    diversion_pct: 0, diverted_tons: 0,
    created_at: new Date().toISOString()
};

if (opData.debrisPhotos[0]) record.debris_photo_1 = opData.debrisPhotos[0];
if (opData.debrisPhotos[1]) record.debris_photo_2 = opData.debrisPhotos[1];
if (opData.debrisPhotos[2]) record.debris_photo_3 = opData.debrisPhotos[2];

showLoading('Submitting scan...');

try {
    if (sb) {
        var result = await Promise.race([
            sb.from('tickets').insert([record]).select(),
            new Promise(function(_, r) { setTimeout(function() { r(new Error('Upload timed out')); }, 15000); })
        ]);
        if (result.error) throw new Error(result.error.message);
    }
    
    hideLoading();
    toast('âœ… Scan submitted! Ready for next truck.', 'success');
    
    // Reset for next truck
    opData.scaleTicketPhoto = null;
    opData.debrisPhotos = [null, null, null];
    document.getElementById('opTicketPreview').innerHTML = 'No photo yet';
    document.getElementById('opNotes').value = '';
    for (var i = 0; i < 3; i++) {
        document.getElementById('opPhotoSlot' + i).innerHTML = '<span style="font-size:24px">' + (i === 0 ? 'ğŸ“·' : '+') + '</span>';
    }
    
    loadOpRecentScans();
} catch(err) {
    hideLoading();
    toast('Error: ' + err.message, 'error');
}
```

}

async function loadOpRecentScans() {
var container = document.getElementById(â€˜opRecentScansâ€™);
if (!container) return;

```
if (!sb) {
    container.innerHTML = '<div style="color:var(--slate-500)">Not connected</div>';
    return;
}

try {
    var { data, error } = await sb.from('tickets')
        .select('id, ticket_number, service_date, project_id, human_verified, scale_ticket_photo, created_at')
        .eq('submitted_by', 'operator')
        .order('created_at', { ascending: false })
        .limit(20);
    
    if (error || !data || data.length === 0) {
        container.innerHTML = '<div style="color:var(--slate-500);padding:8px">No scans yet today. Start scanning!</div>';
        return;
    }
    
    var allProjects = window._allProjectsList || [];
    container.innerHTML = data.map(function(t) {
        var proj = allProjects.find(function(p) { return p.id === t.project_id; });
        var projName = proj ? proj.name : 'Unknown';
        var status = t.human_verified ? '<span style="color:var(--emerald-400)">âœ… Verified</span>' : '<span style="color:var(--amber-400)">â³ Pending</span>';
        
        return '<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--slate-700)">' +
            (t.scale_ticket_photo ? '<img src="' + t.scale_ticket_photo + '" style="width:40px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0">' : '<div style="width:40px;height:40px;background:var(--slate-700);border-radius:6px;flex-shrink:0"></div>') +
            '<div style="flex:1;min-width:0">' +
                '<div style="font-size:12px;font-weight:600">' + t.ticket_number + '</div>' +
                '<div style="font-size:10px;color:var(--slate-400)">' + projName + ' â€¢ ' + formatDate(t.service_date) + '</div>' +
            '</div>' +
            '<div>' + status + '</div>' +
            (!t.human_verified ? '<button onclick="opEditScan(\'' + t.id + '\')" style="background:var(--slate-700);border:1px solid var(--slate-600);color:white;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer">âœï¸</button>' : '') +
        '</div>';
    }).join('');
} catch(err) {
    container.innerHTML = '<div style="color:var(--red-400)">Error: ' + err.message + '</div>';
}
```

}

function opEditScan(ticketId) {
// Load the ticket and open edit modal (reuse customer edit flow)
var ticket = tickets.find(function(t) { return t.id === ticketId; });
if (ticket) {
viewTicketDetails(ticketId);
} else {
// Ticket not in local array â€” fetch it
if (sb) {
sb.from(â€˜ticketsâ€™).select(â€™*â€™).eq(â€˜idâ€™, ticketId).single().then(function(result) {
if (result.data) {
tickets.push(result.data);
viewTicketDetails(ticketId);
} else {
toast(â€˜Could not load ticketâ€™, â€˜errorâ€™);
}
});
}
}
}

// ========== ADMIN PENDING REVIEW TAB ==========
async function loadPendingReviewTab() {
var container = document.getElementById(â€˜pendingReviewListâ€™);
if (!container) return;

```
if (!sb) {
    container.innerHTML = '<div style="color:var(--slate-500)">Not connected to database</div>';
    return;
}

container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--slate-400)">Loading pending items...</div>';

try {
    var { data, error } = await sb.from('tickets')
        .select('*')
        .eq('human_verified', false)
        .order('created_at', { ascending: false })
        .limit(50);
    
    if (error) throw new Error(error.message);
    
    // Filter to only customer/operator submissions
    var pending = (data || []).filter(function(t) {
        return t.submitted_by === 'customer' || t.submitted_by === 'operator';
    });
    
    if (pending.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:30px"><div style="font-size:48px;margin-bottom:8px">âœ…</div><div style="font-size:14px;font-weight:600;color:var(--emerald-400)">All caught up!</div><div style="font-size:12px;color:var(--slate-400)">No pending reviews right now.</div></div>';
        return;
    }
    
    // Make sure tickets array has these
    pending.forEach(function(t) {
        if (!tickets.find(function(existing) { return existing.id === t.id; })) {
            tickets.push(t);
        }
    });
    
    var allProjects = window._allProjectsList || [];
    
    container.innerHTML = '<div style="margin-bottom:12px;font-size:13px;color:var(--amber-400);font-weight:600">' + pending.length + ' item' + (pending.length > 1 ? 's' : '') + ' pending review</div>' +
        pending.map(function(t) {
            var proj = allProjects.find(function(p) { return p.id === t.project_id; });
            var projName = proj ? proj.name : 'Unknown Project';
            var source = t.submitted_by === 'operator' ? 'ğŸš› Crew' : 'ğŸ‘¤ Customer';
            var photoCount = [t.debris_photo_1, t.debris_photo_2, t.debris_photo_3].filter(function(p) { return p; }).length;
            
            return '<div style="background:var(--slate-800);border-radius:10px;padding:12px;margin-bottom:8px;border:1px solid var(--slate-700)">' +
                '<div style="display:flex;gap:10px;align-items:start">' +
                    (t.scale_ticket_photo ? '<img src="' + t.scale_ticket_photo + '" style="width:60px;height:45px;object-fit:cover;border-radius:6px;flex-shrink:0;border:2px solid var(--accent-info)">' : '') +
                    '<div style="flex:1;min-width:0">' +
                        '<div style="display:flex;justify-content:space-between;align-items:start">' +
                            '<div><div style="font-size:13px;font-weight:600">' + t.ticket_number + '</div>' +
                            '<div style="font-size:11px;color:var(--slate-400)">' + projName + '</div></div>' +
                            '<div style="font-size:10px;padding:3px 8px;border-radius:4px;background:' + (t.submitted_by === 'operator' ? 'var(--accent-info)' : 'var(--amber-400)') + ';color:white;font-weight:600">' + source + '</div>' +
                        '</div>' +
                        '<div style="font-size:10px;color:var(--slate-400);margin-top:4px">' + formatDate(t.service_date) + ' â€¢ ' + (photoCount + 1) + ' photo(s)' + (t.customer_notes ? ' â€¢ "' + t.customer_notes.substring(0, 40) + '"' : '') + '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="display:flex;gap:6px;margin-top:10px">' +
                    '<button onclick="editTicket(\'' + t.id + '\')" class="btn btn-primary" style="flex:1;padding:8px;font-size:12px">ğŸ¤– Review & Process</button>' +
                    '<button onclick="viewTicketDetails(\'' + t.id + '\')" class="btn btn-secondary" style="padding:8px 12px;font-size:12px">ğŸ‘ï¸</button>' +
                '</div>' +
            '</div>';
        }).join('');
    
} catch(err) {
    container.innerHTML = '<div style="color:var(--red-400);padding:8px">Error: ' + err.message + '</div>';
}
```

}

// ========== CUSTOMER UPLOAD FUNCTIONS ==========
var custUploadData = {
scaleTicketPhoto: null,
debrisPhotos: [null, null, null],
currentSlot: 0
};

function customerUploadTicketPhoto() {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™;
input.accept = â€˜image/*â€™;
input.style.position = â€˜fixedâ€™;
input.style.left = â€˜-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0];
if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
custUploadData.scaleTicketPhoto = cropped;
var preview = document.getElementById(â€˜custTicketPreviewâ€™);
preview.innerHTML = â€˜<img src="' + cropped + '" style="width:100%;border-radius:8px"><div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 10px;border-radius:6px;font-size:10px">âœ… Scale Ticket</div>â€™;
}, â€˜ticketâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function customerCaptureTicket() {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™;
input.accept = â€˜image/*â€™;
input.capture = â€˜environmentâ€™;
input.style.position = â€˜fixedâ€™;
input.style.left = â€˜-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0];
if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, function(cropped) {
custUploadData.scaleTicketPhoto = cropped;
var preview = document.getElementById(â€˜custTicketPreviewâ€™);
preview.innerHTML = â€˜<img src="' + cropped + '" style="width:100%;border-radius:8px"><div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 10px;border-radius:6px;font-size:10px">âœ… Scale Ticket</div>â€™;
}, â€˜ticketâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function customerUploadDebrisPhoto(slot) {
custUploadData.currentSlot = slot;
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™;
input.accept = â€˜image/*â€™;
input.style.position = â€˜fixedâ€™;
input.style.left = â€˜-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0];
if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, async function(cropped) {
var img = await compressImageForAPI(cropped);
custUploadData.debrisPhotos[slot] = img;
var slotEl = document.getElementById(â€˜custPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜<img src="' + img + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px"><div onclick="event.stopPropagation();removeCustPhoto(' + slot + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>â€™;
}, â€˜debrisâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function customerCaptureDebris() {
// Find first empty slot
var slot = custUploadData.debrisPhotos.findIndex(function(p) { return !p; });
if (slot === -1) { toast(â€˜All 3 photo slots are fullâ€™, â€˜warningâ€™); return; }
custUploadData.currentSlot = slot;
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™;
input.accept = â€˜image/*â€™;
input.capture = â€˜environmentâ€™;
input.style.position = â€˜fixedâ€™;
input.style.left = â€˜-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var file = e.target.files[0];
if (!file) return;
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, async function(cropped) {
var img = await compressImageForAPI(cropped);
custUploadData.debrisPhotos[slot] = img;
var slotEl = document.getElementById(â€˜custPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜<img src="' + img + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px"><div onclick="event.stopPropagation();removeCustPhoto(' + slot + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>â€™;
}, â€˜debrisâ€™);
};
reader.readAsDataURL(file);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function customerUploadMultiDebris() {
var input = document.createElement(â€˜inputâ€™);
input.type = â€˜fileâ€™;
input.accept = â€˜image/*â€™;
input.multiple = true;
input.style.position = â€˜fixedâ€™;
input.style.left = â€˜-9999pxâ€™;
document.body.appendChild(input);
input.onchange = function(e) {
var files = Array.from(e.target.files);
if (!files.length) return;
var queue = [];
var slotIdx = 0;
files.forEach(function(file) {
while (slotIdx < 3 && custUploadData.debrisPhotos[slotIdx]) slotIdx++;
if (slotIdx >= 3) return;
queue.push({ file: file, slot: slotIdx });
slotIdx++;
});
function processNext(i) {
if (i >= queue.length) return;
var item = queue[i];
var reader = new FileReader();
reader.onload = function(ev) {
openPhotoCrop(ev.target.result, async function(cropped) {
var img = await compressImageForAPI(cropped);
custUploadData.debrisPhotos[item.slot] = img;
var slotEl = document.getElementById(â€˜custPhotoSlotâ€™ + item.slot);
slotEl.innerHTML = â€˜<img src="' + img + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px"><div onclick="event.stopPropagation();removeCustPhoto(' + item.slot + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>â€™;
processNext(i + 1);
}, â€˜debrisâ€™);
};
reader.readAsDataURL(item.file);
}
processNext(0);
setTimeout(function() { document.body.removeChild(input); }, 1000);
};
setTimeout(function() { input.click(); }, 100);
}

function removeCustPhoto(slot) {
custUploadData.debrisPhotos[slot] = null;
var slotEl = document.getElementById(â€˜custPhotoSlotâ€™ + slot);
slotEl.innerHTML = â€˜â•â€™;
}

async function submitCustomerUpload() {
if (!custUploadData.scaleTicketPhoto) {
toast(â€˜Please upload a scale ticket photoâ€™, â€˜errorâ€™);
return;
}
if (!currentProject) {
toast(â€˜No project selectedâ€™, â€˜errorâ€™);
return;
}

```
var hauler = (document.getElementById('custHauler').value || '').trim();
var serviceDate = document.getElementById('custServiceDate').value || new Date().toISOString().split('T')[0];
var ticketNum = (document.getElementById('custTicketNum').value || '').trim();
var notes = (document.getElementById('custNotes').value || '').trim();
var photoCount = custUploadData.debrisPhotos.filter(function(p) { return p; }).length;

// Build the ticket record â€” marked as pending review
var record = {
    project_id: currentProject.id,
    ticket_number: ticketNum || ('CUST-' + Date.now().toString(36).toUpperCase()),
    service_date: serviceDate,
    hauler: hauler || 'Customer Upload',
    container_size: 0,
    gross_lbs: 0,
    tare_lbs: 0,
    net_lbs: 0,
    net_tons: 0,
    wood_pct: 0, concrete_pct: 0, metal_pct: 0, cardboard_pct: 0,
    plastic_pct: 0, drywall_pct: 0, landfill_pct: 100,
    wood_tons: 0, concrete_tons: 0, metal_tons: 0, cardboard_tons: 0,
    plastic_tons: 0, drywall_tons: 0, landfill_tons: 0,
    diversion_pct: 0,
    diverted_tons: 0,
    human_verified: false,
    photo_count: photoCount + 1,
    is_closed: false,
    submitted_by: 'customer',
    customer_notes: notes,
    created_at: new Date().toISOString(),
    scale_ticket_photo: custUploadData.scaleTicketPhoto
};

if (custUploadData.debrisPhotos[0]) record.debris_photo_1 = custUploadData.debrisPhotos[0];
if (custUploadData.debrisPhotos[1]) record.debris_photo_2 = custUploadData.debrisPhotos[1];
if (custUploadData.debrisPhotos[2]) record.debris_photo_3 = custUploadData.debrisPhotos[2];

showLoading('Uploading to Dalmex...');

try {
    if (sb) {
        var result;
        var isEdit = custUploadData.editingTicketId;
        
        if (isEdit) {
            // UPDATE existing ticket
            delete record.created_at; // Don't overwrite creation date
            record.updated_at = new Date().toISOString();
            result = await Promise.race([
                sb.from('tickets').update(record).eq('id', isEdit).select(),
                new Promise(function(_, r) { setTimeout(function() { r(new Error('Upload timed out')); }, 15000); })
            ]);
        } else {
            // INSERT new ticket
            result = await Promise.race([
                sb.from('tickets').insert([record]).select(),
                new Promise(function(_, r) { setTimeout(function() { r(new Error('Upload timed out')); }, 15000); })
            ]);
        }
        
        if (result.error) throw new Error(result.error.message);
        
        hideLoading();
        
        // Show success
        var statusBanner = document.getElementById('customerUploadStatus');
        statusBanner.classList.remove('hidden');
        document.getElementById('uploadStatusText').textContent = isEdit ? 'âœ… Upload updated successfully!' : 'âœ… Upload submitted successfully!';
        document.getElementById('uploadStatusDetail').textContent = 
            'Ticket ' + record.ticket_number + ' â€¢ ' + (photoCount + 1) + ' photo(s) â€¢ Dalmex will review and process your materials.';
        
        toast(isEdit ? 'âœ… Upload updated!' : 'âœ… Upload sent to Dalmex for review!', 'success');
        
        // Reset form
        resetCustomerUploadForm();
        
        // Refresh data
        await loadAllTicketsForProject();
        loadCustomerUploadHistory();
        
    } else {
        throw new Error('Not connected to database');
    }
} catch(err) {
    hideLoading();
    console.error('Customer upload error:', err);
    toast('Upload error: ' + err.message, 'error');
}
```

}

function resetCustomerUploadForm() {
custUploadData.scaleTicketPhoto = null;
custUploadData.debrisPhotos = [null, null, null];
custUploadData.editingTicketId = null;

```
var preview = document.getElementById('custTicketPreview');
preview.innerHTML = '<div id="custTicketPlaceholder" style="text-align:center;padding:20px"><div style="font-size:32px;margin-bottom:8px">ğŸ“·</div><div style="font-size:12px;color:var(--slate-400)">Tap to photograph or upload scale ticket</div><div style="font-size:10px;color:var(--slate-500);margin-top:4px">Supports any hauler\'s ticket format</div></div>';

for (var i = 0; i < 3; i++) {
    document.getElementById('custPhotoSlot' + i).innerHTML = 'â•';
}

document.getElementById('custHauler').value = '';
document.getElementById('custTicketNum').value = '';
document.getElementById('custNotes').value = '';
document.getElementById('custServiceDate').value = new Date().toISOString().split('T')[0];
```

}

// Customer can edit their own pending uploads (before admin verifies)
function customerEditUpload(ticketId) {
var ticket = tickets.find(function(t) { return t.id === ticketId; });
if (!ticket) { toast(â€˜Ticket not foundâ€™, â€˜errorâ€™); return; }
if (ticket.human_verified) { toast(â€˜This ticket has been verified and cannot be editedâ€™, â€˜infoâ€™); return; }

```
// Close detail modal
var detailModal = document.getElementById('ticketDetailModal');
if (detailModal) detailModal.remove();

// Pre-populate the upload form with existing data
showTab('customerUpload');

// Fill in existing data
document.getElementById('custHauler').value = ticket.hauler || '';
document.getElementById('custServiceDate').value = ticket.service_date || '';
document.getElementById('custTicketNum').value = ticket.ticket_number || '';
document.getElementById('custNotes').value = ticket.customer_notes || '';

// Show existing photos
if (ticket.scale_ticket_photo) {
    custUploadData.scaleTicketPhoto = ticket.scale_ticket_photo;
    var preview = document.getElementById('custTicketPreview');
    preview.innerHTML = '<img src="' + ticket.scale_ticket_photo + '" style="width:100%;border-radius:8px"><div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:white;padding:4px 10px;border-radius:6px;font-size:10px">âœ… Scale Ticket</div>';
}
for (var i = 0; i < 3; i++) {
    var photoKey = 'debris_photo_' + (i + 1);
    if (ticket[photoKey]) {
        custUploadData.debrisPhotos[i] = ticket[photoKey];
        var slotEl = document.getElementById('custPhotoSlot' + i);
        slotEl.innerHTML = '<img src="' + ticket[photoKey] + '" style="width:100%;height:100%;object-fit:cover;border-radius:6px"><div onclick="event.stopPropagation();removeCustPhoto(' + i + ')" style="position:absolute;top:4px;right:4px;background:rgba(239,68,68,0.9);color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer">Ã—</div>';
    }
}

// Store the ticket ID so submit knows to UPDATE instead of INSERT
custUploadData.editingTicketId = ticketId;

toast('Edit your upload â€” tap Submit when done', 'info');
```

}

// ========== HAULER MANAGER ==========
// Haulers stored in localStorage and synced to Supabase if table exists
function getHaulers() {
try {
return JSON.parse(localStorage.getItem(â€˜divertscan_haulersâ€™) || â€˜[]â€™);
} catch(e) { return []; }
}

function saveHaulers(haulers) {
localStorage.setItem(â€˜divertscan_haulersâ€™, JSON.stringify(haulers));
}

function addHauler() {
var name = (document.getElementById(â€˜newHaulerNameâ€™).value || â€˜â€™).trim();
if (!name) { toast(â€˜Enter a hauler nameâ€™, â€˜errorâ€™); return; }

```
var haulers = getHaulers();
if (haulers.find(function(h) { return h.name.toLowerCase() === name.toLowerCase(); })) {
    toast('Hauler already exists', 'warning');
    return;
}

haulers.push({
    id: 'hauler_' + Date.now(),
    name: name,
    projects: [] // Array of project IDs
});

saveHaulers(haulers);
document.getElementById('newHaulerName').value = '';
renderHaulerManager();
toast('âœ… Hauler added: ' + name, 'success');
```

}

function removeHauler(haulerId) {
if (!confirm(â€˜Remove this hauler?â€™)) return;
var haulers = getHaulers().filter(function(h) { return h.id !== haulerId; });
saveHaulers(haulers);
renderHaulerManager();
toast(â€˜Hauler removedâ€™, â€˜infoâ€™);
}

function toggleHaulerProject(haulerId, projectId) {
var haulers = getHaulers();
var hauler = haulers.find(function(h) { return h.id === haulerId; });
if (!hauler) return;

```
var idx = hauler.projects.indexOf(projectId);
if (idx >= 0) {
    hauler.projects.splice(idx, 1);
} else {
    hauler.projects.push(projectId);
}

saveHaulers(haulers);

// Also update the project's waste_hauler field
var proj = (window._allProjectsList || []).find(function(p) { return p.id === projectId; });
if (proj && idx < 0) {
    // Assigning this project to this hauler
    proj.waste_hauler = hauler.name;
    if (sb) {
        sb.from('projects').update({ waste_hauler: hauler.name }).eq('id', projectId).then(function() {});
    }
}

renderHaulerManager();
```

}

function renderHaulerManager() {
var container = document.getElementById(â€˜haulerManagerListâ€™);
if (!container) return;

```
var haulers = getHaulers();
var allProjects = window._allProjectsList || [];

if (haulers.length === 0) {
    container.innerHTML = '<div style="color:var(--slate-500);font-size:12px;padding:8px">No haulers yet. Add one below.</div>';
    return;
}

container.innerHTML = haulers.map(function(h) {
    var projHtml = allProjects.map(function(p) {
        var isAssigned = h.projects.indexOf(p.id) >= 0;
        return '<label style="display:flex;align-items:center;gap:6px;font-size:11px;padding:3px 0;cursor:pointer">' +
            '<input type="checkbox" ' + (isAssigned ? 'checked' : '') + ' onchange="toggleHaulerProject(\'' + h.id + '\', \'' + p.id + '\')">' +
            '<span style="color:' + (isAssigned ? 'var(--emerald-400)' : 'var(--slate-400)') + '">' + (p.name || 'Unnamed') + '</span>' +
        '</label>';
    }).join('');
    
    var assignedCount = h.projects.filter(function(pid) {
        return allProjects.find(function(p) { return p.id === pid; });
    }).length;
    
    return '<div style="background:var(--slate-800);border-radius:8px;padding:12px;border:1px solid var(--slate-700)">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
            '<div><span style="font-weight:600;font-size:13px">ğŸš› ' + h.name + '</span> <span style="font-size:10px;color:var(--slate-400)">' + assignedCount + ' project' + (assignedCount !== 1 ? 's' : '') + '</span></div>' +
            '<button onclick="removeHauler(\'' + h.id + '\')" style="background:var(--red-500);border:none;color:white;width:24px;height:24px;border-radius:4px;font-size:10px;cursor:pointer">âœ•</button>' +
        '</div>' +
        '<div style="font-size:10px;color:var(--slate-400);margin-bottom:6px">ASSIGNED PROJECTS:</div>' +
        '<div style="display:flex;flex-direction:column;gap:2px;max-height:150px;overflow-y:auto">' + projHtml + '</div>' +
    '</div>';
}).join('');
```

}

// Populate hauler dropdown when creating/editing projects
function getHaulerDropdownOptions(selectedValue) {
var haulers = getHaulers();
var options = â€˜<option value="">â€” Select Hauler â€”</option>â€™;
haulers.forEach(function(h) {
options += â€˜<option value=â€â€™ + h.name + â€˜â€â€™ + (selectedValue === h.name ? â€™ selectedâ€™ : â€˜â€™) + â€˜>â€™ + h.name + â€˜</option>â€™;
});
options += â€˜<option value="__custom__">+ Enter customâ€¦</option>â€™;
return options;
}

// Auto-populate haulers from existing project data (first-time migration)
function migrateHaulersFromProjects() {
var haulers = getHaulers();
if (haulers.length > 0) return; // Already have haulers

```
var allProjects = window._allProjectsList || [];
var seen = {};

allProjects.forEach(function(p) {
    var name = (p.waste_hauler || '').trim();
    if (name && !seen[name.toLowerCase()]) {
        seen[name.toLowerCase()] = true;
        var h = {
            id: 'hauler_' + Date.now() + '_' + Math.random().toString(36).substring(7),
            name: name,
            projects: [p.id]
        };
        haulers.push(h);
    } else if (name && seen[name.toLowerCase()]) {
        // Add project to existing hauler
        var existing = haulers.find(function(hh) { return hh.name.toLowerCase() === name.toLowerCase(); });
        if (existing) existing.projects.push(p.id);
    }
});

if (haulers.length > 0) {
    saveHaulers(haulers);
    console.log('Migrated ' + haulers.length + ' haulers from projects');
}
```

}

// ========== CUSTOMER ACCOUNT MANAGER ==========
// Uses the project.access_code field â€” assigns same code to multiple projects

function renderCustomerAccounts() {
var container = document.getElementById(â€˜customerAccountListâ€™);
if (!container) return;

```
var allProjects = window._allProjectsList || [];
if (allProjects.length === 0) {
    container.innerHTML = '<div style="color:var(--slate-500);font-size:12px">No projects yet. Create projects first.</div>';
    return;
}

// Group projects by access_code
var codeMap = {};
allProjects.forEach(function(p) {
    var code = (p.access_code || '').trim().toUpperCase();
    if (code) {
        if (!codeMap[code]) codeMap[code] = [];
        codeMap[code].push(p);
    }
});

// Also find unassigned projects
var unassigned = allProjects.filter(function(p) { return !p.access_code || !p.access_code.trim(); });

var codes = Object.keys(codeMap).sort();

if (codes.length === 0) {
    container.innerHTML = '<div style="color:var(--slate-500);font-size:12px;padding:8px 0">No customer accounts yet. Add a code below to get started.</div>';
    return;
}

container.innerHTML = codes.map(function(code) {
    var projects = codeMap[code];
    var projectNames = projects.map(function(p) { return p.name || 'Unnamed'; }).join(', ');
    
    return '<div style="background:var(--slate-800);border-radius:10px;padding:14px;border:1px solid var(--slate-700)">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">' +
            '<div>' +
                '<div style="font-weight:700;font-size:14px;font-family:monospace;letter-spacing:2px;color:var(--emerald-400)">' + code + '</div>' +
                '<div style="font-size:10px;color:var(--slate-400);margin-top:2px">' + projects.length + ' project' + (projects.length > 1 ? 's' : '') + ' assigned</div>' +
            '</div>' +
            '<div style="display:flex;gap:6px">' +
                '<button onclick="editCustomerAccount(\'' + code + '\')" class="btn btn-secondary" style="padding:4px 10px;font-size:10px">âœï¸ Manage</button>' +
                '<button onclick="removeCustomerAccount(\'' + code + '\')" class="btn" style="background:var(--red-500);color:white;padding:4px 10px;font-size:10px">ğŸ—‘ï¸</button>' +
            '</div>' +
        '</div>' +
        '<div style="display:flex;flex-wrap:wrap;gap:4px">' +
            projects.map(function(p) {
                return '<span style="background:var(--slate-700);color:var(--slate-300);padding:3px 8px;border-radius:6px;font-size:10px">ğŸ“ ' + (p.name || 'Unnamed') + '</span>';
            }).join('') +
        '</div>' +
    '</div>';
}).join('');
```

}

function addCustomerAccount() {
var input = document.getElementById(â€˜newCustomerCodeâ€™);
var code = (input.value || â€˜â€™).trim().toUpperCase();
if (!code) { toast(â€˜Enter an access codeâ€™, â€˜errorâ€™); return; }
if (code === â€˜DALMEXâ€™ || code === â€˜DALMEX2025â€™ || code === â€˜CREWâ€™) {
toast(â€˜That code is reserved for Dalmex crewâ€™, â€˜errorâ€™); return;
}

```
// Check if code already exists
var allProjects = window._allProjectsList || [];
var existing = allProjects.some(function(p) { return (p.access_code || '').toUpperCase() === code; });
if (existing) {
    toast('Code "' + code + '" already exists â€” tap Manage to edit', 'info');
    input.value = '';
    return;
}

input.value = '';
// Open the assignment modal for this new code
editCustomerAccount(code);
```

}

function editCustomerAccount(code) {
var allProjects = window._allProjectsList || [];

```
var existing = document.getElementById('custAccountModal');
if (existing) existing.remove();

var modal = document.createElement('div');
modal.id = 'custAccountModal';
modal.className = 'modal active';

var projectCheckboxes = allProjects.map(function(p) {
    var isAssigned = (p.access_code || '').toUpperCase() === code;
    return '<label style="display:flex;align-items:center;gap:10px;padding:12px;background:var(--slate-800);border-radius:8px;cursor:pointer;border:1px solid ' + (isAssigned ? 'var(--emerald-500)' : 'var(--slate-700)') + '" onclick="this.style.borderColor=this.querySelector(\'input\').checked?\'var(--emerald-500)\':\'var(--slate-700)\'">' +
        '<input type="checkbox" id="custAcct_' + p.id + '" ' + (isAssigned ? 'checked' : '') + ' onchange="this.parentElement.style.borderColor=this.checked?\'var(--emerald-500)\':\'var(--slate-700)\'" style="width:20px;height:20px;accent-color:var(--emerald-500);flex-shrink:0">' +
        '<div style="flex:1">' +
            '<div style="font-size:13px;font-weight:600">' + (p.name || 'Unnamed') + '</div>' +
            '<div style="font-size:10px;color:var(--slate-400)">' + (p.address || 'No address') + '</div>' +
            (p.access_code && p.access_code.toUpperCase() !== code ? '<div style="font-size:10px;color:var(--amber-400);margin-top:2px">âš ï¸ Currently assigned to: ' + p.access_code + '</div>' : '') +
        '</div>' +
    '</label>';
}).join('');

modal.innerHTML = '<div class="modal-content" style="max-width:450px">' +
    '<div class="modal-header">' +
        '<div class="modal-title">ğŸ‘¤ Customer: ' + code + '</div>' +
        '<button class="modal-close" onclick="document.getElementById(\'custAccountModal\').remove()">Ã—</button>' +
    '</div>' +
    '<div class="modal-body">' +
        '<div style="font-size:12px;color:var(--slate-400);margin-bottom:12px">Check the projects this customer can access when they log in with code <strong style="color:var(--emerald-400);font-family:monospace">' + code + '</strong>:</div>' +
        '<div style="display:flex;flex-direction:column;gap:6px;max-height:50vh;overflow-y:auto">' +
            projectCheckboxes +
        '</div>' +
    '</div>' +
    '<div class="modal-footer">' +
        '<button class="btn btn-secondary" onclick="document.getElementById(\'custAccountModal\').remove()" style="flex:1">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveCustomerAccount(\'' + code + '\')" style="flex:1">ğŸ’¾ Save</button>' +
    '</div>' +
'</div>';

document.body.appendChild(modal);
```

}

async function saveCustomerAccount(code) {
var allProjects = window._allProjectsList || [];
var updates = [];

```
allProjects.forEach(function(p) {
    var checkbox = document.getElementById('custAcct_' + p.id);
    if (!checkbox) return;
    
    var currentCode = (p.access_code || '').toUpperCase();
    var shouldAssign = checkbox.checked;
    
    if (shouldAssign && currentCode !== code) {
        // Assign this project to the code
        updates.push({ id: p.id, access_code: code });
        p.access_code = code;
    } else if (!shouldAssign && currentCode === code) {
        // Remove this project from the code
        updates.push({ id: p.id, access_code: '' });
        p.access_code = '';
    }
});

if (updates.length === 0) {
    document.getElementById('custAccountModal').remove();
    toast('No changes made', 'info');
    return;
}

// Save to Supabase
if (sb) {
    showLoading('Saving assignments...');
    var errors = 0;
    for (var i = 0; i < updates.length; i++) {
        var u = updates[i];
        var result = await sb.from('projects').update({ access_code: u.access_code }).eq('id', u.id);
        if (result.error) {
            console.error('Update error:', result.error);
            errors++;
        }
    }
    hideLoading();
    if (errors > 0) {
        toast(errors + ' update(s) failed â€” check console', 'error');
    }
}

document.getElementById('custAccountModal').remove();
renderCustomerAccounts();
toast('Customer "' + code + '" updated â€” ' + updates.length + ' project(s) changed', 'success');
```

}

async function removeCustomerAccount(code) {
if (!confirm(â€˜Remove customer code â€œâ€™ + code + â€˜â€?\n\nThis will unassign all projects from this code. Projects will NOT be deleted.â€™)) return;

```
var allProjects = window._allProjectsList || [];
var toUpdate = allProjects.filter(function(p) { return (p.access_code || '').toUpperCase() === code; });

if (sb) {
    showLoading('Removing customer code...');
    for (var i = 0; i < toUpdate.length; i++) {
        await sb.from('projects').update({ access_code: '' }).eq('id', toUpdate[i].id);
        toUpdate[i].access_code = '';
    }
    hideLoading();
}

renderCustomerAccounts();
toast('Customer code "' + code + '" removed', 'success');
```

}

async function loadCustomerUploadHistory() {
var container = document.getElementById(â€˜customerUploadHistoryâ€™);
if (!container || !sb) {
if (container) container.innerHTML = â€˜<div style="color:var(--slate-500)">No uploads yet</div>â€™;
return;
}

```
// Get all project IDs this customer can access
var custProjects = window._customerProjects || [];
var projectIds = custProjects.map(function(p) { return p.id; });
if (projectIds.length === 0 && currentProject) projectIds = [currentProject.id];
if (projectIds.length === 0) {
    container.innerHTML = '<div style="color:var(--slate-500)">No uploads yet</div>';
    return;
}

try {
    var result = await sb.from('tickets')
        .select('id,ticket_number,service_date,hauler,human_verified,submitted_by,created_at,scale_ticket_photo,debris_photo_1,debris_photo_2,debris_photo_3,customer_notes,diversion_pct,net_tons,net_lbs,gross_lbs,tare_lbs,is_closed,wood_pct,metal_pct,cardboard_pct,plastic_pct,concrete_pct,drywall_pct,landfill_pct,import_source,project_id')
        .in('project_id', projectIds)
        .eq('submitted_by', 'customer')
        .order('created_at', { ascending: false })
        .limit(20);
    
    if (result.error || !result.data || result.data.length === 0) {
        container.innerHTML = '<div style="color:var(--slate-500);padding:8px 0">No uploads yet. Use the form above to submit your first scale ticket.</div>';
        return;
    }
    
    // Push to local tickets array so viewTicketDetails can find them
    result.data.forEach(function(t) {
        if (!tickets.find(function(ex) { return ex.id === t.id; })) {
            tickets.push(t);
        }
    });
    
    // Build project name lookup
    var projNameMap = {};
    custProjects.forEach(function(p) { projNameMap[p.id] = p.name || 'Project'; });
    var showProjectName = custProjects.length > 1;
    
    container.innerHTML = result.data.map(function(t) {
        var statusColor, statusText, statusIcon;
        if (t.human_verified) {
            statusColor = 'var(--emerald-400)';
            statusText = 'Verified';
            statusIcon = 'âœ…';
        } else if (t.is_closed) {
            statusColor = 'var(--blue-400)';
            statusText = 'Processed';
            statusIcon = 'ğŸ“‹';
        } else {
            statusColor = 'var(--amber-400)';
            statusText = 'Pending Review';
            statusIcon = 'â³';
        }
        
        var photoCount = [t.scale_ticket_photo, t.debris_photo_1, t.debris_photo_2, t.debris_photo_3].filter(function(p) { return p; }).length;
        
        var photoThumb = t.scale_ticket_photo ? 
            '<img src="' + t.scale_ticket_photo + '" style="width:50px;height:38px;object-fit:cover;border-radius:6px;border:2px solid var(--accent-info);flex-shrink:0">' :
            '<div style="width:50px;height:38px;background:var(--slate-700);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0">ğŸ“„</div>';
        
        return '<div onclick="viewTicketDetails(\'' + t.id + '\')" style="display:flex;align-items:center;gap:10px;padding:12px 8px;border-bottom:1px solid var(--slate-700);cursor:pointer;border-radius:8px;transition:background 0.15s" onmouseenter="this.style.background=\'var(--slate-800)\'" onmouseleave="this.style.background=\'transparent\'">' +
            photoThumb +
            '<div style="flex:1;min-width:0">' +
                '<div style="font-weight:600;font-size:12px">#' + (t.ticket_number || 'â€”') + '</div>' +
                '<div style="font-size:10px;color:var(--slate-400)">' + formatDate(t.service_date) + ' â€¢ ' + (t.hauler || 'â€”') + ' â€¢ ' + photoCount + ' photo(s)</div>' +
                (showProjectName ? '<div style="font-size:9px;color:var(--blue-400);margin-top:1px">ğŸ“ ' + (projNameMap[t.project_id] || 'Unknown') + '</div>' : '') +
                (t.customer_notes ? '<div style="font-size:10px;color:var(--slate-500);margin-top:2px">ğŸ“ ' + t.customer_notes.substring(0, 50) + '</div>' : '') +
            '</div>' +
            '<div style="text-align:right;flex-shrink:0">' +
                '<div style="font-size:11px;font-weight:600;color:' + statusColor + '">' + statusIcon + ' ' + statusText + '</div>' +
                (t.human_verified ? '<div style="font-size:10px;color:var(--emerald-400)">' + (t.diversion_pct || 0) + '% â€¢ ' + (t.net_tons || 0).toFixed(2) + ' T</div>' : '') +
            '</div>' +
            '<div style="color:var(--slate-500);font-size:16px;flex-shrink:0">â€º</div>' +
        '</div>';
    }).join('');
    
} catch(err) {
    console.error('Load upload history:', err);
    container.innerHTML = '<div style="color:var(--slate-500)">Could not load history</div>';
}
```

}

async function initCustomerPortal() {
const url = localStorage.getItem(â€˜divertscan_sb_urlâ€™) || DEFAULT_KEYS.sbUrl;
const key = localStorage.getItem(â€˜divertscan_sb_keyâ€™) || DEFAULT_KEYS.sbKey;

```
if (url && key && !sb) {
    sb = supabase.createClient(url, key);
}

// Show project switcher hint if multiple projects
var custProjects = window._customerProjects || [];
if (custProjects.length > 1) {
    var hint = document.getElementById('portalProjectSwitchHint');
    if (hint) hint.style.display = '';
}

if (sb && currentProject) {
    updateProjectDisplay();
    // Load tickets for the customer's project
    await loadAllTicketsForProject();
    await updateStats();
    
    // Pre-generate the report in Detailed Cards view (shows photos like a PDF)
    try {
        var reportTypeSel = document.getElementById('reportType');
        if (reportTypeSel) reportTypeSel.value = 'detailed';
        
        // Hide the report type selector for customers â€” they just see the full report
        if (reportTypeSel) reportTypeSel.closest('.card').querySelector('select').style.display = 'none';
        
        // Hide the project picker in Reports tab â€” customers have only one project
        var reportBar = document.querySelector('.report-project-bar');
        if (reportBar) reportBar.style.display = 'none';
        
        // Pre-select the customer's project in the report dropdown
        var reportSel = document.getElementById('reportProjectSelect');
        if (reportSel) {
            // Add the customer's project to the dropdown
            var opt = document.createElement('option');
            opt.value = currentProject.id;
            opt.textContent = currentProject.name;
            opt.selected = true;
            reportSel.appendChild(opt);
        }
        
        // Auto-generate the report
        await generateReport();
    } catch(e) {
        console.log('Customer report pre-generation:', e.message);
    }
}

// Customer goes straight to Dashboard with their project visible
showTab('dashboard');
```

}

function doLogout() {
localStorage.removeItem(â€˜divertscan_sessionâ€™);
userRole = null;
currentProject = null;

```
document.getElementById('loginScreen').classList.remove('hidden');
document.getElementById('appContainer').classList.remove('active');
document.body.classList.remove('logged-in');

// Clear form fields
document.getElementById('adminUsername').value = '';
document.getElementById('adminPassword').value = '';
document.getElementById('customerCode').value = '';
document.getElementById('adminLoginError').textContent = '';
document.getElementById('customerLoginError').textContent = '';
```

}

// Check session on page load
function checkExistingSession() {
const session = localStorage.getItem(â€˜divertscan_sessionâ€™);

```
if (session) {
    const s = JSON.parse(session);
    // Session expires after 24 hours
    if (Date.now() - s.time < 24 * 60 * 60 * 1000) {
        if (s.role === 'admin') {
            userRole = 'admin';
            showMainApp();
            return true;
        } else if (s.role === 'customer' && s.projectId) {
            userRole = 'customer';
            const url = localStorage.getItem('divertscan_sb_url') || DEFAULT_KEYS.sbUrl;
            const key = localStorage.getItem('divertscan_sb_key') || DEFAULT_KEYS.sbKey;
            if (url && key) {
                sb = supabase.createClient(url, key);
                
                // If we have an access code, load all projects with that code
                if (s.accessCode) {
                    sb.from('projects').select('*').eq('access_code', s.accessCode).then(function(res) {
                        if (res.data && res.data.length > 0) {
                            window._customerProjects = res.data;
                            currentProject = res.data.find(function(p) { return p.id === s.projectId; }) || res.data[0];
                            showMainApp();
                        }
                    });
                } else {
                    sb.from('projects').select('*').eq('id', s.projectId).single().then(function(res) {
                        if (res.data) {
                            currentProject = res.data;
                            window._customerProjects = [res.data];
                            showMainApp();
                        }
                    });
                }
                return true;
            }
        } else if (s.role === 'operator') {
            userRole = 'operator';
            showMainApp();
            return true;
        }
    }
}
return false;
```

}

// ========== KEYBOARD SHORTCUTS ==========
document.addEventListener(â€˜keydownâ€™, function(e) {
// Only work when logged in and not in an input field
if (!userRole) return;
if (e.target.tagName === â€˜INPUTâ€™ || e.target.tagName === â€˜TEXTAREAâ€™ || e.target.tagName === â€˜SELECTâ€™) return;

```
// Ctrl/Cmd + key shortcuts
if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
        case 'n': // New ticket
            e.preventDefault();
            startNewTicket();
            break;
        case 's': // Sync
            e.preventDefault();
            forceSyncNow();
            break;
        case 'b': // Backup
            e.preventDefault();
            createFullBackup();
            break;
        case 'r': // Refresh
            e.preventDefault();
            loadRecentTickets();
            updateStats();
            break;
    }
}

// Number keys for navigation (1-4)
if (!e.ctrlKey && !e.metaKey && !e.altKey) {
    switch(e.key) {
        case '1':
            showTab('dashboard');
            break;
        case '2':
            showTab('projects');
            break;
        case '3':
            showTab('reports');
            break;
        case '4':
            if (userRole === 'admin') showTab('settings');
            break;
        case '?': // Show shortcuts help
            showKeyboardShortcuts();
            break;
    }
}

// Escape to close modals
if (e.key === 'Escape') {
    closeTicketModal();
    closeProjectModal();
}
```

});

function showKeyboardShortcuts() {
const shortcuts = `
âŒ¨ï¸ KEYBOARD SHORTCUTS

Navigation:
1 - Dashboard
2 - Projects  
3 - Reports
4 - Settings (admin)

Actions:
Ctrl+N - New Ticket
Ctrl+S - Sync Now
Ctrl+B - Backup
Ctrl+R - Refresh
Esc - Close Modal
? - Show this help
`;
alert(shortcuts);
}

// ========== COLOR THEME SYSTEM ==========
let currentTheme = â€˜defaultâ€™;

function setTheme(theme) {
currentTheme = theme;

```
// Remove theme attribute for default, set for others
if (theme === 'default') {
    document.documentElement.removeAttribute('data-theme');
} else {
    document.documentElement.setAttribute('data-theme', theme);
}

// Update active state on theme buttons
document.querySelectorAll('.theme-option').forEach(opt => {
    opt.classList.remove('active');
    if (opt.dataset.theme === theme) {
        opt.classList.add('active');
    }
});

// Save preference
localStorage.setItem('divertscan_theme', theme);

// Update charts if they exist (they need color updates)
if (typeof updateCharts === 'function') {
    setTimeout(updateCharts, 100);
}

toast('Theme changed to ' + getThemeName(theme), 'success');
```

}

function getThemeName(theme) {
const names = {
â€˜defaultâ€™: â€˜Dark Slateâ€™,
â€˜dalmexâ€™: â€˜DalMex Greenâ€™,
â€˜oceanâ€™: â€˜Ocean Blueâ€™,
â€˜sunsetâ€™: â€˜Sunset Orangeâ€™,
â€˜lightâ€™: â€˜Light Modeâ€™,
â€˜contrastâ€™: â€˜High Contrastâ€™,
â€˜purpleâ€™: â€˜Purple Hazeâ€™
};
return names[theme] || theme;
}

function loadSavedTheme() {
const saved = localStorage.getItem(â€˜divertscan_themeâ€™);
if (saved) {
setTheme(saved);
}

```
// Load other display preferences
if (localStorage.getItem('divertscan_reduced_motion') === 'true') {
    document.getElementById('reducedMotion').checked = true;
    document.body.classList.add('reduced-motion');
}
if (localStorage.getItem('divertscan_larger_text') === 'true') {
    document.getElementById('largerText').checked = true;
    document.body.classList.add('larger-text');
}
if (localStorage.getItem('divertscan_compact_mode') === 'true') {
    document.getElementById('compactMode').checked = true;
    document.body.classList.add('compact-mode');
}
```

}

function toggleReducedMotion() {
const enabled = document.getElementById(â€˜reducedMotionâ€™).checked;
document.body.classList.toggle(â€˜reduced-motionâ€™, enabled);
localStorage.setItem(â€˜divertscan_reduced_motionâ€™, enabled);
}

function toggleLargerText() {
const enabled = document.getElementById(â€˜largerTextâ€™).checked;
document.body.classList.toggle(â€˜larger-textâ€™, enabled);
localStorage.setItem(â€˜divertscan_larger_textâ€™, enabled);
}

function toggleCompactMode() {
const enabled = document.getElementById(â€˜compactModeâ€™).checked;
document.body.classList.toggle(â€˜compact-modeâ€™, enabled);
localStorage.setItem(â€˜divertscan_compact_modeâ€™, enabled);
}

// ========== VERIFIED FACILITY DATABASE ==========
// All materials processed by Dalmex Recycling LLC â†’ routed to verified end markets
const VERIFIED_FACILITIES = {
// Metal Recyclers
â€˜cmc_metalsâ€™: {
id: â€˜cmc_metalsâ€™,
name: â€˜CMC (Commercial Metals Company)â€™,
shortName: â€˜CMCâ€™,
type: â€˜Scrap Metal Recyclerâ€™,
materials: [â€˜metalâ€™, â€˜steelâ€™, â€˜aluminumâ€™, â€˜copperâ€™, â€˜rebarâ€™],
address: â€˜Dallas, TXâ€™,
phone: â€˜â€™,
license: â€˜TX-SWR-2024-ACTIVEâ€™,
licenseExpires: â€˜2026-12-31â€™,
verified: true,
status: â€˜activeâ€™
},
â€˜cyclone_metalâ€™: {
id: â€˜cyclone_metalâ€™,
name: â€˜Cyclone Metal Recyclingâ€™,
shortName: â€˜Cycloneâ€™,
type: â€˜Scrap Metal Recyclerâ€™,
materials: [â€˜metalâ€™, â€˜steelâ€™, â€˜aluminumâ€™, â€˜copperâ€™, â€˜rebarâ€™],
address: â€˜Dallas-Fort Worth, TXâ€™,
phone: â€˜â€™,
license: â€˜TX-SWR-2024-ACTIVEâ€™,
licenseExpires: â€˜2026-12-31â€™,
verified: true,
status: â€˜activeâ€™
},

```
// OCC / Paper (fiber) â€” all go to same stream
'georgia_pacific': {
    id: 'georgia_pacific',
    name: 'Georgia-Pacific Recycling',
    shortName: 'Georgia Pacific',
    type: 'Paper Mill',
    materials: ['cardboard', 'occ', 'paper', 'fiber'],
    address: 'Multiple Locations',
    phone: '',
    license: 'NATIONAL-VERIFIED',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},
'smurfit_westrock': {
    id: 'smurfit_westrock',
    name: 'Smurfit Westrock',
    shortName: 'Smurfit Westrock',
    type: 'Paper Mill',
    materials: ['cardboard', 'occ', 'paper', 'fiber'],
    address: 'Multiple Locations',
    phone: '',
    license: 'NATIONAL-VERIFIED',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},
'greenside': {
    id: 'greenside',
    name: 'Greenside Recycling',
    shortName: 'Greenside',
    type: 'OCC Recycler',
    materials: ['cardboard', 'occ', 'paper', 'fiber'],
    address: 'Dallas-Fort Worth, TX',
    phone: '',
    license: 'TX-RCY-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},
'international_paper': {
    id: 'international_paper',
    name: 'International Paper',
    shortName: 'International Paper',
    type: 'Paper Mill',
    materials: ['cardboard', 'occ', 'paper', 'fiber'],
    address: 'Multiple Locations',
    phone: '',
    license: 'NATIONAL-VERIFIED',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},
'american_fiber': {
    id: 'american_fiber',
    name: 'American Fiber',
    shortName: 'American Fiber',
    type: 'Fiber Recycler',
    materials: ['cardboard', 'occ', 'paper', 'fiber'],
    address: 'Dallas-Fort Worth, TX',
    phone: '',
    license: 'TX-RCY-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},

// Plastic Recyclers
'american_recycling_ar': {
    id: 'american_recycling_ar',
    name: 'Recycle USA',
    shortName: 'Recycle USA',
    type: 'Plastics Recycler',
    materials: ['plastic', 'hdpe', 'ldpe', 'pvc'],
    address: 'Arkansas',
    phone: '',
    license: 'AR-VERIFIED-2024',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active'
},

// Wood â€” Dalmex owned
'dalmex_pallet': {
    id: 'dalmex_pallet',
    name: 'Dalmex Pallets',
    shortName: 'Dalmex Pallets',
    type: 'Wood Reuse / Pallet Manufacturing',
    materials: ['wood', 'lumber', 'pallets', 'plywood'],
    address: '2828 Nagel St., Dallas, TX 75220',
    phone: '(214) 352-2000',
    license: 'TX-WOOD-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isOwned: true
},

// Landfill
'landfill': {
    id: 'landfill',
    name: 'Municipal Landfill',
    shortName: 'Landfill',
    type: 'Landfill',
    materials: ['landfill', 'trash', 'mixed waste'],
    address: 'Various',
    phone: '',
    license: 'N/A',
    licenseExpires: null,
    verified: true,
    status: 'active',
    isLandfill: true
},

// Concrete/Block â€” Partner Facility (Direct to End Market)
'big_city_concrete': {
    id: 'big_city_concrete',
    name: 'Big City Concrete',
    shortName: 'Big City Concrete',
    type: 'Concrete Recycler / Aggregate',
    materials: ['concrete', 'brick', 'block', 'masonry', 'rebar'],
    address: 'Dallas, TX',
    phone: '',
    license: 'TX-AGG-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isPartner: true
},

// Drywall â€” Partner Facility (Direct to End Market)
'usa_gypsum': {
    id: 'usa_gypsum',
    name: 'USA Gypsum',
    shortName: 'USA Gypsum',
    type: 'Gypsum Recycler',
    materials: ['drywall', 'gypsum', 'sheetrock'],
    address: 'DFW Area, TX',
    phone: '',
    license: 'TX-RCY-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isPartner: true
},

// E-Waste â€” Partner Facility (Direct to End Market)
'ewaste_recycler': {
    id: 'ewaste_recycler',
    name: 'Certified E-Waste Recycler',
    shortName: 'E-Waste Partner',
    type: 'Electronics Recycler (R2 Certified)',
    materials: ['electronics', 'e-waste', 'computers', 'monitors'],
    address: 'DFW Area, TX',
    phone: '',
    license: 'R2-CERTIFIED',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isPartner: true
},

// Soil/Land Clearing â€” Partner Facility
'soil_recycler': {
    id: 'soil_recycler',
    name: 'DFW Soil Recycling',
    shortName: 'DFW Soil',
    type: 'Clean Fill / Soil Processing',
    materials: ['soil', 'dirt', 'clean fill', 'land clearing'],
    address: 'DFW Area, TX',
    phone: '',
    license: 'TX-FILL-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isPartner: true
},

// Asphalt/Roofing â€” Partner Facility
'asphalt_recycler': {
    id: 'asphalt_recycler',
    name: 'DFW Asphalt Recycling',
    shortName: 'DFW Asphalt',
    type: 'Asphalt / Shingle Recycler',
    materials: ['asphalt', 'roofing', 'shingles'],
    address: 'DFW Area, TX',
    phone: '',
    license: 'TX-AGG-2024-ACTIVE',
    licenseExpires: '2026-12-31',
    verified: true,
    status: 'active',
    isPartner: true
}
```

};

// Material to Facility Routing â€” all processed by Dalmex, routed to end markets
const MATERIAL_ROUTING = {
â€˜metalâ€™: [â€˜cmc_metalsâ€™, â€˜cyclone_metalâ€™],
â€˜cardboardâ€™: [â€˜georgia_pacificâ€™, â€˜smurfit_westrockâ€™, â€˜greensideâ€™, â€˜international_paperâ€™, â€˜american_fiberâ€™],
â€˜occâ€™: [â€˜georgia_pacificâ€™, â€˜smurfit_westrockâ€™, â€˜greensideâ€™, â€˜international_paperâ€™, â€˜american_fiberâ€™],
â€˜paperâ€™: [â€˜georgia_pacificâ€™, â€˜smurfit_westrockâ€™, â€˜greensideâ€™, â€˜international_paperâ€™, â€˜american_fiberâ€™],
â€˜plasticâ€™: [â€˜american_recycling_arâ€™],
â€˜woodâ€™: [â€˜dalmex_palletâ€™],
â€˜concreteâ€™: [â€˜big_city_concreteâ€™],
â€˜drywallâ€™: [â€˜usa_gypsumâ€™],
â€˜electronicsâ€™: [â€˜ewaste_recyclerâ€™],
â€˜soilâ€™: [â€˜soil_recyclerâ€™],
â€˜asphaltâ€™: [â€˜asphalt_recyclerâ€™],
â€˜landfillâ€™: [â€˜landfillâ€™]
};

// Get facilities for a material type
function getFacilitiesForMaterial(material) {
const facilityIds = MATERIAL_ROUTING[material.toLowerCase()] || [];
return facilityIds.map(id => VERIFIED_FACILITIES[id]).filter(f => f);
}

// Get all active facilities
function getAllFacilities() {
return Object.values(VERIFIED_FACILITIES).filter(f => f.status === â€˜activeâ€™);
}

// Verify a facility
function verifyFacility(facilityId) {
const facility = VERIFIED_FACILITIES[facilityId];
if (!facility) {
return { valid: false, status: â€˜not_foundâ€™, message: â€˜Facility not in databaseâ€™ };
}

```
// Check license expiration
if (facility.licenseExpires) {
    const expDate = new Date(facility.licenseExpires);
    if (expDate < new Date()) {
        return { 
            valid: false, 
            status: 'expired', 
            message: `License expired ${facility.licenseExpires}`,
            facility 
        };
    }
}

if (!facility.verified) {
    return { 
        valid: false, 
        status: 'unverified', 
        message: 'Facility requires verification',
        facility 
    };
}

return { 
    valid: true, 
    status: 'verified', 
    message: `Verified - License valid through ${facility.licenseExpires || 'N/A'}`,
    facility 
};
```

}

// Get verification badge HTML
function getFacilityBadge(facilityId) {
const result = verifyFacility(facilityId);

```
if (result.status === 'verified') {
    return `<span class="leed-badge compliant">âœ“ Verified Facility</span>`;
} else if (result.status === 'unverified') {
    return `<span class="leed-badge warning">âš  Needs Verification</span>`;
} else if (result.status === 'expired') {
    return `<span class="leed-badge fail">âœ— License Expired</span>`;
} else {
    return `<span class="leed-badge fail">âœ— Unknown Facility</span>`;
}
```

}

// ========== MATERIAL DESTINATION TRACKING ==========
let materialDestinations = {};

function initMaterialDestinations() {
// Default destinations â€” all processed by Dalmex Recycling
materialDestinations = {
wood: â€˜dalmex_palletâ€™,
metal: â€˜cmc_metalsâ€™,
cardboard: â€˜georgia_pacificâ€™,
occ: â€˜georgia_pacificâ€™,
paper: â€˜georgia_pacificâ€™,
plastic: â€˜american_recycling_arâ€™,
landfill: â€˜landfillâ€™
};

```
// Load saved preferences
const saved = localStorage.getItem('divertscan_material_destinations');
if (saved) {
    materialDestinations = { ...materialDestinations, ...JSON.parse(saved) };
}
```

}

function saveMaterialDestination(material, facilityId) {
materialDestinations[material] = facilityId;
localStorage.setItem(â€˜divertscan_material_destinationsâ€™, JSON.stringify(materialDestinations));
}

// Generate facility destination summary for reports
function generateDestinationSummary(ticketMaterials) {
const summary = [];
const materialNames = {
wood: â€˜Wood/Lumberâ€™,
metal: â€˜Metalsâ€™,
cardboard: â€˜Cardboard/OCCâ€™,
plastic: â€˜Plasticsâ€™,
concrete: â€˜Concrete/Masonryâ€™,
drywall: â€˜Drywall/Gypsumâ€™,
landfill: â€˜Landfillâ€™
};

```
for (const [material, percentage] of Object.entries(ticketMaterials)) {
    if (percentage > 0 && material !== 'landfill') {
        const facilityId = materialDestinations[material];
        const facility = VERIFIED_FACILITIES[facilityId];
        const verification = verifyFacility(facilityId);
        
        summary.push({
            material: materialNames[material] || material,
            percentage,
            facility: facility ? facility.name : 'Not specified',
            facilityType: facility ? facility.type : 'Unknown',
            verified: verification.valid,
            license: facility ? facility.license : 'N/A'
        });
    }
}

// Add landfill if present
if (ticketMaterials.landfill > 0) {
    summary.push({
        material: 'Landfill/Non-Recyclable',
        percentage: ticketMaterials.landfill,
        facility: 'Municipal Landfill',
        facilityType: 'Landfill',
        verified: true,
        license: 'N/A'
    });
}

return summary;
```

}

// Initialize on load
initMaterialDestinations();
const DB_NAME = â€˜DivertScanDBâ€™;
const DB_VERSION = 2; // Bumped to ensure weâ€™re >= any previous version
let db = null;

async function initIndexedDB() {
return new Promise((resolve, reject) => {
const request = indexedDB.open(DB_NAME, DB_VERSION);

```
    request.onerror = (event) => {
        console.error('IndexedDB error:', request.error);
        
        // If version conflict, try to recover by opening without a version (uses current)
        if (request.error && request.error.name === 'VersionError') {
            console.log('Version conflict detected - attempting recovery...');
            const recoveryRequest = indexedDB.open(DB_NAME);
            recoveryRequest.onsuccess = () => {
                db = recoveryRequest.result;
                console.log('IndexedDB recovered at version', db.version);
                resolve(db);
            };
            recoveryRequest.onerror = () => {
                console.error('Recovery failed - deleting and recreating DB');
                indexedDB.deleteDatabase(DB_NAME);
                // Retry with our version
                const retryRequest = indexedDB.open(DB_NAME, DB_VERSION);
                retryRequest.onupgradeneeded = createStores;
                retryRequest.onsuccess = () => { db = retryRequest.result; resolve(db); };
                retryRequest.onerror = () => reject(retryRequest.error);
            };
        } else {
            reject(request.error);
        }
    };
    
    request.onsuccess = () => {
        db = request.result;
        console.log('IndexedDB initialized v' + db.version);
        resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
        createStores(event);
    };
});
```

}

function createStores(event) {
const database = event.target.result;

```
// Projects store
if (!database.objectStoreNames.contains('projects')) {
    const projectStore = database.createObjectStore('projects', { keyPath: 'id' });
    projectStore.createIndex('synced', 'synced', { unique: false });
}

// Tickets store
if (!database.objectStoreNames.contains('tickets')) {
    const ticketStore = database.createObjectStore('tickets', { keyPath: 'id' });
    ticketStore.createIndex('project_id', 'project_id', { unique: false });
    ticketStore.createIndex('synced', 'synced', { unique: false });
}

// Drafts store (auto-saved in-progress tickets)
if (!database.objectStoreNames.contains('drafts')) {
    database.createObjectStore('drafts', { keyPath: 'id' });
}

// Sync queue
if (!database.objectStoreNames.contains('syncQueue')) {
    database.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
}

// Settings store
if (!database.objectStoreNames.contains('settings')) {
    database.createObjectStore('settings', { keyPath: 'key' });
}
```

}

// Save to IndexedDB
async function saveToLocal(storeName, data) {
if (!db) await initIndexedDB();

```
return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.put(data);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
});
```

}

// Get from IndexedDB
async function getFromLocal(storeName, key) {
if (!db) await initIndexedDB();

```
return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readonly');
    const store = transaction.objectStore(storeName);
    const request = store.get(key);
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
});
```

}

// Get all from IndexedDB
async function getAllFromLocal(storeName) {
if (!db) await initIndexedDB();

```
return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readonly');
    const store = transaction.objectStore(storeName);
    const request = store.getAll();
    
    request.onsuccess = () => resolve(request.result);
    request.onerror = () => reject(request.error);
});
```

}

// Delete from IndexedDB
async function deleteFromLocal(storeName, key) {
if (!db) await initIndexedDB();

```
return new Promise((resolve, reject) => {
    const transaction = db.transaction([storeName], 'readwrite');
    const store = transaction.objectStore(storeName);
    const request = store.delete(key);
    
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
});
```

}

// ========== ONLINE/OFFLINE DETECTION ==========
let isOnline = navigator.onLine;
let pendingSyncItems = [];

function updateOnlineStatus() {
isOnline = navigator.onLine;
const statusBar = document.getElementById(â€˜statusBarâ€™);
const statusText = document.getElementById(â€˜statusBarTextâ€™);

```
if (isOnline) {
    statusBar.className = 'status-bar online';
    statusText.textContent = 'âœ“ Online - All data synced';
    
    // Auto-sync if enabled
    if (document.getElementById('autoSync')?.checked) {
        syncPendingData();
    }
} else {
    statusBar.className = 'status-bar offline';
    statusText.textContent = 'âš  Offline - Data saved locally';
}

statusBar.classList.remove('hidden');
document.body.classList.add('has-status-bar');

// Hide status bar after 3 seconds if online
if (isOnline) {
    setTimeout(() => {
        if (pendingSyncItems.length === 0) {
            statusBar.classList.add('hidden');
            document.body.classList.remove('has-status-bar');
        }
    }, 3000);
}
```

}

window.addEventListener(â€˜onlineâ€™, updateOnlineStatus);
window.addEventListener(â€˜offlineâ€™, updateOnlineStatus);

// ========== SYNC ENGINE ==========
async function addToSyncQueue(action, table, data) {
const item = {
id: Date.now() + Math.random(),
action, // â€˜insertâ€™, â€˜updateâ€™, â€˜deleteâ€™
table,
data,
timestamp: new Date().toISOString(),
retries: 0
};

```
await saveToLocal('syncQueue', item);
pendingSyncItems.push(item);
updateSyncStatus();
```

}

async function syncPendingData() {
if (!isOnline || !sb) return;

```
const queue = await getAllFromLocal('syncQueue');
if (queue.length === 0) return;

const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusBarText');
statusBar.className = 'status-bar syncing';
statusText.textContent = `ğŸ”„ Syncing ${queue.length} items...`;

let synced = 0;
let failed = 0;

for (const item of queue) {
    try {
        if (item.action === 'insert') {
            const { error } = await sb.from(item.table).insert([item.data]);
            if (error) throw error;
        } else if (item.action === 'update') {
            const { error } = await sb.from(item.table).update(item.data).eq('id', item.data.id);
            if (error) throw error;
        } else if (item.action === 'delete') {
            const { error } = await sb.from(item.table).delete().eq('id', item.data.id);
            if (error) throw error;
        }
        
        // Remove from queue on success
        await deleteFromLocal('syncQueue', item.id);
        synced++;
    } catch (err) {
        console.error('Sync failed for item:', item, err);
        item.retries++;
        if (item.retries < 5) {
            await saveToLocal('syncQueue', item);
        }
        failed++;
    }
}

// Update status
pendingSyncItems = await getAllFromLocal('syncQueue');
updateSyncStatus();

if (failed === 0) {
    statusBar.className = 'status-bar online';
    statusText.textContent = `âœ“ Synced ${synced} items successfully`;
    localStorage.setItem('divertscan_last_sync', new Date().toISOString());
} else {
    statusBar.className = 'status-bar offline';
    statusText.textContent = `âš  ${failed} items failed to sync`;
}

// Refresh data
await loadProjects();
await loadRecentTickets();
```

}

function updateSyncStatus() {
const countEl = document.getElementById(â€˜pendingSyncCountâ€™);
const timeEl = document.getElementById(â€˜lastSyncTimeâ€™);

```
if (countEl) countEl.textContent = pendingSyncItems.length;
if (timeEl) {
    const lastSync = localStorage.getItem('divertscan_last_sync');
    timeEl.textContent = lastSync ? new Date(lastSync).toLocaleString() : 'Never';
}
```

}

function forceSyncNow() {
if (!isOnline) {
toast(â€˜Cannot sync while offlineâ€™, â€˜errorâ€™);
return;
}
if (!sb) {
toast(â€˜Supabase not configured â€” nothing to syncâ€™, â€˜errorâ€™);
return;
}

```
// Show sync status modal
showSyncStatusModal();
```

}

function showSyncStatusModal() {
// Remove existing
var old = document.getElementById(â€˜syncStatusModalâ€™);
if (old) old.remove();

```
var modal = document.createElement('div');
modal.id = 'syncStatusModal';
modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px';
modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

modal.innerHTML = '<div style="background:var(--bg-secondary);border-radius:16px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto">' +
    '<div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);padding:16px 20px;border-radius:16px 16px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<div style="font-size:16px;font-weight:700;color:white">ğŸ”„ Sync Status</div>' +
        '<button onclick="document.getElementById(\'syncStatusModal\').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:18px;cursor:pointer">Ã—</button>' +
    '</div>' +
    '<div id="syncStatusContent" style="padding:20px">' +
        '<div style="text-align:center;padding:20px"><div style="font-size:24px">ğŸ”„</div><div style="color:var(--text-secondary);margin-top:8px">Checking sync queue...</div></div>' +
    '</div>' +
'</div>';

document.body.appendChild(modal);

// Run sync with detailed status
runDetailedSync();
```

}

async function runDetailedSync() {
var content = document.getElementById(â€˜syncStatusContentâ€™);
if (!content) return;

```
try {
    var queue = await getAllFromLocal('syncQueue');
    
    if (queue.length === 0) {
        var lastSync = localStorage.getItem('divertscan_last_sync');
        content.innerHTML = '<div style="text-align:center;padding:20px">' +
            '<div style="font-size:48px;margin-bottom:12px">âœ…</div>' +
            '<div style="font-size:16px;font-weight:600;color:var(--emerald-400)">All Synced!</div>' +
            '<div style="font-size:12px;color:var(--text-secondary);margin-top:8px">No pending items in sync queue.</div>' +
            (lastSync ? '<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Last sync: '+new Date(lastSync).toLocaleString()+'</div>' : '') +
        '</div>';
        toast('âœ… Everything is synced!', 'success');
        return;
    }
    
    // Show items being synced
    content.innerHTML = '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px">Syncing '+queue.length+' item(s)...</div>' +
        '<div id="syncItemList"></div>';
    
    var itemList = document.getElementById('syncItemList');
    var synced = 0;
    var failed = 0;
    var failedItems = [];
    
    for (var i = 0; i < queue.length; i++) {
        var item = queue[i];
        var label = (item.table||'unknown') + ' â€” ' + (item.action||'?');
        if (item.data && item.data.ticket_number) label = 'Ticket #' + item.data.ticket_number + ' â€” ' + (item.action||'?');
        else if (item.data && item.data.name) label = item.data.name + ' â€” ' + (item.action||'?');
        
        // Show progress
        itemList.innerHTML += '<div id="sync-item-'+i+'" style="display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;margin-bottom:4px;background:var(--slate-700)">' +
            '<span id="sync-icon-'+i+'" style="font-size:14px">â³</span>' +
            '<div style="flex:1;font-size:12px">'+label+'</div>' +
            '<span id="sync-status-'+i+'" style="font-size:10px;color:var(--text-muted)">syncing...</span>' +
        '</div>';
        
        try {
            if (item.action === 'insert') {
                var r = await sb.from(item.table).insert([item.data]);
                if (r.error) throw r.error;
            } else if (item.action === 'update') {
                var r2 = await sb.from(item.table).update(item.data).eq('id', item.data.id);
                if (r2.error) throw r2.error;
            } else if (item.action === 'delete') {
                var r3 = await sb.from(item.table).delete().eq('id', item.data.id);
                if (r3.error) throw r3.error;
            }
            
            await deleteFromLocal('syncQueue', item.id);
            synced++;
            
            var iconEl = document.getElementById('sync-icon-'+i);
            var statusEl = document.getElementById('sync-status-'+i);
            if (iconEl) iconEl.textContent = 'âœ…';
            if (statusEl) { statusEl.textContent = 'done'; statusEl.style.color = 'var(--emerald-400)'; }
            
        } catch (err) {
            failed++;
            var errMsg = err.message || err.details || 'Unknown error';
            // Handle common errors
            if (errMsg.includes('storage') || errMsg.includes('bucket') || errMsg.includes('photo')) {
                errMsg = 'Photo upload failed â€” Supabase storage bucket not configured';
            } else if (errMsg.includes('timeout') || errMsg.includes('TIMEOUT')) {
                errMsg = 'Request timed out â€” will retry';
            } else if (errMsg.includes('duplicate') || errMsg.includes('already exists') || errMsg.includes('23505')) {
                errMsg = 'Record already exists in database';
                // Remove duplicate from queue since it's already synced
                await deleteFromLocal('syncQueue', item.id);
            }
            
            failedItems.push({label: label, error: errMsg});
            
            var iconEl2 = document.getElementById('sync-icon-'+i);
            var statusEl2 = document.getElementById('sync-status-'+i);
            var rowEl = document.getElementById('sync-item-'+i);
            if (iconEl2) iconEl2.textContent = 'âŒ';
            if (statusEl2) { statusEl2.textContent = errMsg; statusEl2.style.color = 'var(--red-500)'; }
            if (rowEl) rowEl.style.background = 'rgba(239,68,68,0.1)';
            
            // Increment retries (don't remove - let user retry)
            item.retries = (item.retries || 0) + 1;
            if (item.retries < 5) {
                await saveToLocal('syncQueue', item);
            } else {
                await deleteFromLocal('syncQueue', item.id);
            }
        }
    }
    
    // Summary
    var summaryHtml = '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-color);text-align:center">';
    if (failed === 0) {
        summaryHtml += '<div style="font-size:14px;font-weight:600;color:var(--emerald-400)">âœ… All '+synced+' item(s) synced successfully!</div>';
        localStorage.setItem('divertscan_last_sync', new Date().toISOString());
    } else {
        summaryHtml += '<div style="font-size:14px;font-weight:600;color:var(--amber-400)">âš  '+synced+' synced, '+failed+' failed</div>';
        summaryHtml += '<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Failed items will auto-retry on next sync</div>';
    }
    summaryHtml += '</div>';
    content.innerHTML += summaryHtml;
    
    // Update global status
    pendingSyncItems = await getAllFromLocal('syncQueue');
    updateSyncStatus();
    
    if (failed === 0) toast('âœ… Sync complete!', 'success');
    else toast('âš  '+failed+' item(s) failed to sync', 'error');
    
    await loadProjects();
    await loadRecentTickets();
    
} catch (err) {
    content.innerHTML = '<div style="text-align:center;padding:20px">' +
        '<div style="font-size:48px;margin-bottom:12px">âš ï¸</div>' +
        '<div style="font-size:14px;color:var(--red-500)">Sync Error</div>' +
        '<div style="font-size:12px;color:var(--text-secondary);margin-top:8px">'+err.message+'</div>' +
    '</div>';
}
```

}

// ========== AUTO-SAVE DRAFTS ==========
let autosaveInterval = null;
let currentDraft = null;

function startAutosave() {
if (autosaveInterval) clearInterval(autosaveInterval);

```
autosaveInterval = setInterval(async () => {
    if (!document.getElementById('autosaveDrafts')?.checked) return;
    
    // Save current ticket form state
    if (document.getElementById('ticketModal')?.classList.contains('active')) {
        await saveDraft();
    }
}, 10000); // Every 10 seconds
```

}

async function saveDraft() {
const draft = {
id: â€˜current_draftâ€™,
projectId: document.getElementById(â€˜ticketProjectâ€™)?.value,
ticketNumber: document.getElementById(â€˜ticketNumberâ€™)?.value,
serviceDate: document.getElementById(â€˜serviceDateâ€™)?.value,
grossLbs: document.getElementById(â€˜grossLbsâ€™)?.value,
tareLbs: document.getElementById(â€˜tareLbsâ€™)?.value,
haulerName: document.getElementById(â€˜haulerNameâ€™)?.value,
materials: ticketData.materials,
diversionRate: ticketData.diversionRate,
photos: debrisPhotos,
step: currentStep,
savedAt: new Date().toISOString()
};

```
await saveToLocal('drafts', draft);
currentDraft = draft;

// Update autosave indicator
const indicator = document.querySelector('.autosave-indicator');
if (indicator) {
    indicator.className = 'autosave-indicator saved';
    indicator.innerHTML = 'âœ“ Draft saved ' + new Date().toLocaleTimeString();
}

console.log('Draft auto-saved');
```

}

async function checkForDraft() {
// Only check once per browser session (survives reload, clears when tab closes)
if (sessionStorage.getItem(â€˜ds_draft_checkedâ€™)) return false;
sessionStorage.setItem(â€˜ds_draft_checkedâ€™, â€˜1â€™);

```
try {
    const draft = await getFromLocal('drafts', 'current_draft');
    
    if (draft && draft.savedAt) {
        const savedTime = new Date(draft.savedAt);
        const age = Date.now() - savedTime.getTime();
        
        // Auto-clear drafts older than 1 hour
        if (age > 60 * 60 * 1000) {
            await clearDraft();
            return false;
        }
        
        // Only restore if draft has meaningful data
        if (!draft.ticketNumber && !draft.grossLbs) {
            await clearDraft();
            return false;
        }
        
        if (confirm('Found unsaved ticket from ' + savedTime.toLocaleString() + '. Restore it?')) {
            restoreDraft(draft);
            return true;
        } else {
            // User declined â€” clear the draft permanently
            await clearDraft();
        }
    }
} catch (err) {
    // No draft or error â€” silent
}
return false;
```

}

function restoreDraft(draft) {
if (document.getElementById(â€˜ticketProjectâ€™)) document.getElementById(â€˜ticketProjectâ€™).value = draft.projectId || â€˜â€™;
if (document.getElementById(â€˜ticketNumberâ€™)) document.getElementById(â€˜ticketNumberâ€™).value = draft.ticketNumber || â€˜â€™;
if (document.getElementById(â€˜serviceDateâ€™)) document.getElementById(â€˜serviceDateâ€™).value = draft.serviceDate || â€˜â€™;
if (document.getElementById(â€˜grossLbsâ€™)) document.getElementById(â€˜grossLbsâ€™).value = draft.grossLbs || â€˜â€™;
if (document.getElementById(â€˜tareLbsâ€™)) document.getElementById(â€˜tareLbsâ€™).value = draft.tareLbs || â€˜â€™;
if (document.getElementById(â€˜haulerNameâ€™)) document.getElementById(â€˜haulerNameâ€™).value = draft.haulerName || â€˜â€™;

```
if (draft.materials) ticketData.materials = draft.materials;
if (draft.diversionRate) ticketData.diversionRate = draft.diversionRate;
if (draft.photos) debrisPhotos = draft.photos;

updateNetWeight();
openModal('ticketModal');

if (draft.step && draft.step > 1) {
    showStep(draft.step);
}

toast('Draft restored!', 'success');
```

}

async function clearDraft() {
await deleteFromLocal(â€˜draftsâ€™, â€˜current_draftâ€™);
currentDraft = null;
}

// ========== LEED RULES ENGINE ==========
const LEED_RULES = {
â€˜v4.1â€™: {
name: â€˜LEED v4.1â€™,
mandatory_until: â€˜2026-06-30â€™,
mrc5: {
name: â€˜MRc5: Construction and Demolition Waste Managementâ€™,
credit_category: â€˜Materials and Resourcesâ€™,
intent: â€˜Reduce construction and demolition waste disposed of in landfills and incineration facilities by recovering, reusing, and recycling materials.â€™,
options: {
diversion: {
description: â€˜Option 1: Diversionâ€™,
method: â€˜weightâ€™,
thresholds: [
{ percent: 50, points: 1, label: â€˜50% diversion = 1 pointâ€™ },
{ percent: 75, points: 2, label: â€˜75% diversion = 2 pointsâ€™ }
]
},
reduction: {
description: â€˜Option 2: Reduction of Total Wasteâ€™,
thresholds: [
{ lbs_per_sqft: 2.5, points: 2, label: â€˜â‰¤2.5 lbs/sf total waste = 2 pointsâ€™ }
]
}
},
requirements: [
â€˜Track waste by material stream (at minimum 4 streams)â€™,
â€˜Document final destination for each material streamâ€™,
â€˜Obtain recycling facility documentation/receiptsâ€™,
â€˜Calculate diversion rate using weight (preferred) or volumeâ€™,
â€˜Maintain chain-of-custody documentationâ€™,
â€˜Separate or commingled collection acceptable if documentedâ€™,
â€˜Alternative daily cover (ADC) does NOT count as diversionâ€™,
â€˜Waste-to-energy does NOT count as diversionâ€™,
â€˜Land-clearing debris tracked separately from building wasteâ€™
],
excluded_materials: [
â€˜Hazardous waste (RCRA regulated)â€™,
â€˜Soil and land clearing debris (tracked separately, may earn separate credit)â€™,
â€˜Alternative daily cover (ADC) â€” counted as landfillâ€™,
â€˜Waste-to-energy incineration outputâ€™
],
minimum_streams: 4,
documentation: [
â€˜Scale tickets with weights for each loadâ€™,
â€˜Material breakdown by percentage or weightâ€™,
â€˜Recycling facility receipts with material typesâ€™,
â€˜Waste Management Plan (WMP)â€™,
â€˜Monthly or per-load tracking logsâ€™,
â€˜Photo documentation (recommended but not required)â€™,
â€˜Final summary report showing total diversion calculationâ€™
]
}
},
â€˜v5â€™: {
name: â€˜LEED v5 (Mandatory for new registrations after June 30, 2026)â€™,
mandatory_after: â€˜2026-06-30â€™,
mrc5: {
name: â€˜MRc5: Construction and Demolition Waste Managementâ€™,
credit_category: â€˜Materials and Resourcesâ€™,
intent: â€˜Reduce waste and promote circular economy through material reuse, recycling, and waste reduction.â€™,
options: {
diversion: {
description: â€˜Option 1: Diversionâ€™,
method: â€˜weightâ€™,
thresholds: [
{ percent: 50, points: 1, label: â€˜50% diversion = 1 pointâ€™ },
{ percent: 75, points: 2, label: â€˜75% diversion = 2 pointsâ€™ }
]
},
circularity: {
description: â€˜Tier 1 Circularity Creditâ€™,
multiplier: 2.0,
eligibleMaterials: [â€˜reused materialsâ€™, â€˜deconstructed materialsâ€™, â€˜salvaged materialsâ€™],
label: â€˜Salvaged/reused materials count at 200% (2x multiplier)â€™,
note: â€˜Materials must be documented as reused on-site or salvaged for reuse, not just recycledâ€™
},
reduction: {
description: â€˜Option 2: Reduction of Total Wasteâ€™,
thresholds: [
{ lbs_per_sqft: 2.5, points: 2, label: â€˜â‰¤2.5 lbs/sf total waste = 2 pointsâ€™ }
]
}
},
requirements: [
â€˜Track waste by material stream (minimum 5 streams for v5)â€™,
â€˜Document final destination for each material streamâ€™,
â€˜Obtain recycling facility certification/receiptsâ€™,
â€˜Calculate diversion rate using weight ONLY (volume not accepted in v5)â€™,
â€˜Photo documentation recommended for audit defenseâ€™,
â€˜GPS verification for load tracking recommendedâ€™,
â€˜Circular economy documentation for 200% multiplier claimsâ€™,
â€˜Digital tracking system recommended (paper logs accepted)â€™,
â€˜ADC does NOT count as diversionâ€™,
â€˜Waste-to-energy does NOT count as diversionâ€™,
â€˜Maintain chain-of-custody for each material streamâ€™
],
excluded_materials: [
â€˜Hazardous waste (RCRA regulated)â€™,
â€˜Alternative daily cover (ADC) â€” counted as landfillâ€™,
â€˜Waste-to-energy incineration outputâ€™,
â€˜Contaminated soil (tracked under separate prerequisite)â€™
],
minimum_streams: 5,
documentation: [
â€˜Scale tickets with weights for each load (REQUIRED)â€™,
â€˜Material breakdown by weight percentageâ€™,
â€˜End market verification letters or contractsâ€™,
â€˜Recycling facility permits/certificationsâ€™,
â€˜Waste Management Plan (WMP) â€” more detailed than v4.1â€™,
â€˜Monthly diversion tracking logâ€™,
â€˜Photo documentation of loads (strongly recommended)â€™,
â€˜Digital chain-of-custody recordsâ€™,
â€˜Salvage/reuse documentation for 200% multiplierâ€™,
â€˜Final LEED MRc5 summary report with calculation methodologyâ€™
]
}
}
};

let currentLeedVersion = â€˜v4.1â€™;

function updateLeedRules() {
currentLeedVersion = document.getElementById(â€˜leedVersionâ€™)?.value || â€˜v4.1â€™;
const rules = LEED_RULES[currentLeedVersion];

```
const display = document.getElementById('leedRulesDisplay');
if (display && rules) {
    const mrc5 = rules.mrc5;
    var html = '<strong>' + mrc5.name + '</strong><br>';
    html += '<span style="color:var(--emerald-400);font-size:10px">' + mrc5.intent + '</span><br><br>';
    
    // Scoring
    html += '<strong>Scoring:</strong><br>';
    html += mrc5.options.diversion.thresholds.map(function(t){return 'â€¢ ' + t.label}).join('<br>');
    if (mrc5.options.circularity) {
        html += '<br>â€¢ <span style="color:var(--amber-400)">' + mrc5.options.circularity.label + '</span>';
    }
    
    // Requirements
    html += '<br><br><strong>Requirements (' + currentLeedVersion + '):</strong><br>';
    html += mrc5.requirements.slice(0,6).map(function(r){return 'â€¢ ' + r}).join('<br>');
    
    // Excluded
    html += '<br><br><strong>Excluded Materials:</strong><br>';
    html += mrc5.excluded_materials.slice(0,4).map(function(r){return 'â€¢ <span style="color:var(--red-400)">' + r + '</span>'}).join('<br>');
    
    // Documentation
    html += '<br><br><strong>Required Documentation:</strong><br>';
    html += mrc5.documentation.slice(0,5).map(function(r){return 'â€¢ ' + r}).join('<br>');
    
    // v5 transition warning
    if (currentLeedVersion === 'v4.1') {
        html += '<br><br><span style="color:var(--amber-400);font-weight:600">âš ï¸ LEED v5 becomes mandatory for new registrations after June 30, 2026</span>';
    }
    
    display.innerHTML = html;
}

localStorage.setItem('divertscan_leed_version', currentLeedVersion);
```

}

function validateLeedCompliance(diversionRate, totalTons) {
const rules = LEED_RULES[currentLeedVersion];
const thresholds = rules.mrc5.options.diversion.thresholds;

```
let result = {
    compliant: false,
    points: 0,
    status: 'fail',
    message: '',
    warnings: []
};

// Check thresholds
for (const threshold of thresholds.slice().reverse()) {
    if (diversionRate >= threshold.percent) {
        result.compliant = true;
        result.points = threshold.points;
        result.status = 'compliant';
        result.message = `âœ“ LEED Compliant: ${threshold.label}`;
        break;
    }
}

if (!result.compliant) {
    const needed = thresholds[0].percent - diversionRate;
    result.message = `âœ— ${needed}% below minimum threshold`;
    result.status = 'fail';
}

// Add warnings
if (diversionRate > 95) {
    result.warnings.push('Unusually high diversion rate - verify data accuracy');
    result.status = 'warning';
}

if (totalTons < 1) {
    result.warnings.push('Low total tonnage - may not meet LEED minimum');
}

return result;
```

}

function saveLeedSettings() {
const version = document.getElementById(â€˜leedVersionâ€™)?.value;
const target = document.getElementById(â€˜defaultDiversionTargetâ€™)?.value;

```
localStorage.setItem('divertscan_leed_version', version);
localStorage.setItem('divertscan_default_target', target);

toast('LEED settings saved!', 'success');
```

}

// ========== DATA VALIDATION ==========
function validateTicketData(data) {
const errors = [];
const warnings = [];

```
// Detect partner/direct-to-end-market ticket
const isPartnerTicket = data.directToEndMarket || data.direct_to_end_market || data.partnerFacility || data.partner_facility;

// Support both camelCase (ticketData) and snake_case (dbRecord) field names
const projectId = data.projectId || data.project_id;
const serviceDate = data.serviceDate || data.service_date;
const grossLbs = data.grossLbs || data.gross_lbs;
const tareLbs = data.tareLbs || data.tare_lbs;
const humanVerified = data.humanVerified || data.human_verified;
const diversionRate = data.diversionRate || data.diversion_pct;
const materials = data.materials || {
    wood: data.wood_pct || 0,
    concrete: data.concrete_pct || 0,
    metal: data.metal_pct || 0,
    cardboard: data.cardboard_pct || 0,
    plastic: data.plastic_pct || 0,
    drywall: data.drywall_pct || 0,
    landfill: data.landfill_pct || 0
};

// Required fields
if (!projectId) errors.push('Project is required');
if (!serviceDate) errors.push('Service date is required');

// Weight validation
if (document.getElementById('validateWeights')?.checked) {
    if (!grossLbs || grossLbs <= 0) errors.push('Gross weight is required');
    if (!tareLbs || tareLbs <= 0) errors.push('Tare weight is required');
    if (grossLbs && tareLbs && grossLbs <= tareLbs) {
        errors.push('Gross weight must be greater than tare weight');
    }
    if (grossLbs > 100000) warnings.push('Gross weight seems unusually high');
    if (tareLbs < 5000) warnings.push('Tare weight seems unusually low');
}

// Percentage validation
if (document.getElementById('validatePercentages')?.checked && materials) {
    const total = Object.values(materials).reduce((s, v) => s + (v || 0), 0);
    if (Math.abs(total - 100) > 1) {
        errors.push(`Material percentages must total 100% (currently ${total}%)`);
    }
}

// Photo validation â€” SKIP for partner tickets (they don't have debris photos)
if (!isPartnerTicket && document.getElementById('requirePhotos')?.checked) {
    const photoCount = debrisPhotos.filter(p => p).length;
    if (photoCount === 0) errors.push('At least 1 debris photo is required');
}

// Verification validation â€” SKIP for partner tickets (auto-verified)
if (!isPartnerTicket && document.getElementById('requireVerification')?.checked) {
    if (!humanVerified) errors.push('Human verification is required');
}

// Anomaly detection â€” partner tickets legitimately hit 100% diversion
if (document.getElementById('flagAnomalies')?.checked) {
    if (!isPartnerTicket && diversionRate > 90) warnings.push('Diversion rate >90% is unusual - please verify');
    if (diversionRate < 30) warnings.push('Diversion rate <30% is below typical range');
}

return { valid: errors.length === 0, errors, warnings };
```

}

function showValidationErrors(errors, warnings) {
let message = â€˜â€™;

```
if (errors.length > 0) {
    message += 'âŒ Errors:\n' + errors.map(e => 'â€¢ ' + e).join('\n');
}

if (warnings.length > 0) {
    if (message) message += '\n\n';
    message += 'âš ï¸ Warnings:\n' + warnings.map(w => 'â€¢ ' + w).join('\n');
}

if (errors.length > 0) {
    alert(message);
    return false;
}

if (warnings.length > 0) {
    return confirm(message + '\n\nProceed anyway?');
}

return true;
```

}

// ========== BACKUP & RESTORE ==========
async function createFullBackup() {
showLoading(â€˜Creating backupâ€¦â€™);

```
// Safety net: force hideLoading after 15 seconds no matter what
var backupSafetyTimer = setTimeout(function() { hideLoading(); toast('Backup timed out â€” try again', 'error'); }, 15000);

try {
    const backup = {
        version: '7.7',
        createdAt: new Date().toISOString(),
        app: 'DivertScan Enterprise',
        settings: {
            leedVersion: currentLeedVersion,
            companyInfo: companyInfo
        },
        projects: [],
        tickets: []
    };
    
    // Get all projects with SHORT timeout (3s instead of 5s)
    if (sb) {
        try {
            const pResult = await Promise.race([
                sb.from('projects').select('*'),
                new Promise(function(_, r) { setTimeout(function() { r(new Error('timeout')); }, 8000); })
            ]);
            if (pResult && pResult.data) backup.projects = pResult.data;
        } catch (e) { console.log('Supabase projects skipped:', e.message); }
        
        try {
            const tResult = await Promise.race([
                sb.from('tickets').select('*'),
                new Promise(function(_, r) { setTimeout(function() { r(new Error('timeout')); }, 5000); })
            ]);
            if (tResult && tResult.data) backup.tickets = tResult.data;
        } catch (e) { console.log('Supabase tickets skipped:', e.message); }
    }
    
    // Also include local data
    try {
        backup.localProjects = await getAllFromLocal('projects') || [];
        backup.localTickets = await getAllFromLocal('tickets') || [];
    } catch (e) { console.log('Local data read error:', e.message); }
    
    // Download backup file â€” force download with application/octet-stream
    var jsonStr = JSON.stringify(backup, null, 2);
    var blob = new Blob([jsonStr], { type: 'application/octet-stream' });
    var url = URL.createObjectURL(blob);
    var filename = 'DivertScan_Backup_' + new Date().toISOString().split('T')[0] + '.json';
    
    var a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    
    // Cleanup after delay (iPad Safari needs time)
    setTimeout(function() {
        if (a.parentNode) document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 3000);
    
    // Update backup stats
    try {
        document.getElementById('backupProjectCount').textContent = (backup.projects.length + (backup.localProjects ? backup.localProjects.length : 0));
        document.getElementById('backupTicketCount').textContent = (backup.tickets.length + (backup.localTickets ? backup.localTickets.length : 0));
        document.getElementById('backupLastDate').textContent = new Date().toLocaleDateString();
        localStorage.setItem('divertscan_last_backup', new Date().toISOString());
    } catch (e) {}
    
    clearTimeout(backupSafetyTimer);
    hideLoading();
    toast('Backup created! (' + (backup.projects.length + backup.tickets.length) + ' records)', 'success');
    
} catch (err) {
    clearTimeout(backupSafetyTimer);
    hideLoading();
    toast('Backup failed: ' + err.message, 'error');
}
```

}

async function restoreFromBackup(event) {
const file = event.target.files[0];
if (!file) return;

```
if (!confirm('This will replace all current data. Are you sure?')) {
    event.target.value = '';
    return;
}

showLoading('Restoring backup...');

try {
    const text = await file.text();
    const backup = JSON.parse(text);
    
    if (!backup.version || !backup.projects) {
        throw new Error('Invalid backup file format');
    }
    
    // Restore settings
    if (backup.settings) {
        if (backup.settings.companyInfo) {
            companyInfo = backup.settings.companyInfo;
            localStorage.setItem('divertscan_company', JSON.stringify(companyInfo));
        }
        if (backup.settings.leedVersion) {
            localStorage.setItem('divertscan_leed_version', backup.settings.leedVersion);
        }
    }
    
    // Restore to Supabase if connected
    if (sb) {
        // Delete existing and insert new
        for (const project of backup.projects) {
            await sb.from('projects').upsert([project]);
        }
        for (const ticket of backup.tickets) {
            await sb.from('tickets').upsert([ticket]);
        }
    }
    
    // Also save to IndexedDB
    for (const project of backup.projects) {
        await saveToLocal('projects', { ...project, synced: true });
    }
    for (const ticket of backup.tickets) {
        await saveToLocal('tickets', { ...ticket, synced: true });
    }
    
    hideLoading();
    toast(`Restored ${backup.projects.length} projects and ${backup.tickets.length} tickets!`, 'success');
    
    // Reload data
    await loadProjects();
    await loadRecentTickets();
    await updateStats();
    
} catch (err) {
    hideLoading();
    toast('Restore failed: ' + err.message, 'error');
}

event.target.value = '';
```

}

function exportToCloud() {
toast(â€˜Cloud backup coming soon! Use Export Backup for now.â€™, â€˜infoâ€™);
}

function clearLocalData() {
if (!confirm(â€˜This will clear ALL local data including drafts. Are you sure?â€™)) return;
if (!confirm(â€˜This cannot be undone. Proceed?â€™)) return;

```
// Clear IndexedDB
indexedDB.deleteDatabase(DB_NAME);

// Clear localStorage (except connection info)
const sbUrl = localStorage.getItem('divertscan_sb_url');
const sbKey = localStorage.getItem('divertscan_sb_key');
const apiKey = localStorage.getItem('divertscan_openai');

localStorage.clear();

if (sbUrl) localStorage.setItem('divertscan_sb_url', sbUrl);
if (sbKey) localStorage.setItem('divertscan_sb_key', sbKey);
if (apiKey) localStorage.setItem('divertscan_openai', apiKey);

toast('Local data cleared!', 'success');
location.reload();
```

}

// ========== REAL-TIME SUBSCRIPTIONS ==========
let subscriptions = [];

function setupRealtimeSync() {
if (!sb) return;

```
// Subscribe to projects changes
const projectSub = sb
    .channel('projects-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'projects' }, (payload) => {
        console.log('Project change:', payload);
        loadProjects();
        toast('Projects updated', 'info');
    })
    .subscribe();

// Subscribe to tickets changes
const ticketSub = sb
    .channel('tickets-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'tickets' }, (payload) => {
        console.log('Ticket change:', payload);
        loadRecentTickets();
        updateStats();
        toast('Tickets updated', 'info');
    })
    .subscribe();

subscriptions.push(projectSub, ticketSub);
console.log('Real-time subscriptions active');
```

}

// ========== LOCAL STORAGE STATS ==========
function updateLocalStorageStats() {
let total = 0;
for (let key in localStorage) {
if (localStorage.hasOwnProperty(key)) {
total += localStorage[key].length * 2; // UTF-16
}
}

```
const el = document.getElementById('localStorageUsed');
if (el) {
    el.textContent = (total / 1024).toFixed(1) + ' KB';
}
```

}

// ========== ENHANCED SAVE WITH OFFLINE SUPPORT ==========
async function saveTicketWithOfflineSupport(ticketRecord) {
// Validate first
const validation = validateTicketData(ticketRecord);
if (!showValidationErrors(validation.errors, validation.warnings)) {
return false;
}

```
// Generate local ID if needed
if (!ticketRecord.id) {
    ticketRecord.id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Always save locally first
ticketRecord.synced = false;
await saveToLocal('tickets', ticketRecord);

// Try to save to Supabase if online
if (isOnline && sb) {
    try {
        // Remove local ID prefix if present
        const remoteRecord = { ...ticketRecord };
        if (remoteRecord.id.startsWith('local_')) {
            delete remoteRecord.id;
        }
        delete remoteRecord.synced;
        
        const sbPromise = sb.from('tickets').insert([remoteRecord]).select();
        const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Supabase timeout')), 5000)
        );
        const { data, error } = await Promise.race([sbPromise, timeoutPromise]);
        
        if (error) throw error;
        
        // Update local with real ID
        if (data && data[0]) {
            await deleteFromLocal('tickets', ticketRecord.id);
            ticketRecord.id = data[0].id;
            ticketRecord.synced = true;
            await saveToLocal('tickets', ticketRecord);
        }
        
        return true;
    } catch (err) {
        console.error('Remote save failed, queued for sync:', err);
        await addToSyncQueue('insert', 'tickets', ticketRecord);
        toast('Saved locally - will sync when online', 'warning');
        return true;
    }
} else {
    // Queue for later sync
    await addToSyncQueue('insert', 'tickets', ticketRecord);
    toast('Saved offline - will sync when online', 'warning');
    return true;
}
```

}

// ========== TOGGLE OFFLINE MODE ==========
function toggleOfflineMode() {
const enabled = document.getElementById(â€˜enableOfflineModeâ€™)?.checked;
localStorage.setItem(â€˜divertscan_offline_enabledâ€™, enabled ? â€˜trueâ€™ : â€˜falseâ€™);

```
if (enabled) {
    initIndexedDB();
    toast('Offline mode enabled', 'success');
} else {
    toast('Offline mode disabled - requires internet', 'warning');
}
```

}

// ========== COMPANY BRANDING ==========
function saveCompanyBranding() {
companyInfo = {
name: document.getElementById(â€˜companyNameInputâ€™)?.value || â€˜DalMex Recycling LLCâ€™,
address: document.getElementById(â€˜companyAddressInputâ€™)?.value || â€˜â€™,
phone: document.getElementById(â€˜companyPhoneInputâ€™)?.value || â€˜â€™
};
localStorage.setItem(â€˜divertscan_companyâ€™, JSON.stringify(companyInfo));
toast(â€˜Company branding saved!â€™, â€˜successâ€™);
}

// ========== INITIALIZE BULLETPROOF FEATURES ==========
async function initBulletproof() {
// Load saved theme first (before anything visual)
loadSavedTheme();

```
// Initialize IndexedDB
try {
    await initIndexedDB();
    console.log('IndexedDB ready');
} catch (err) {
    console.error('IndexedDB failed:', err);
}

// Check online status
updateOnlineStatus();

// Start autosave
startAutosave();

// Render custom facilities
renderAllFacilities();

// Update local storage stats
updateLocalStorageStats();

// Load LEED settings
const savedLeedVersion = localStorage.getItem('divertscan_leed_version');
if (savedLeedVersion && document.getElementById('leedVersion')) {
    document.getElementById('leedVersion').value = savedLeedVersion;
    updateLeedRules();
}

// Load backup stats
const lastBackup = localStorage.getItem('divertscan_last_backup');
if (lastBackup) {
    const el = document.getElementById('backupLastDate');
    if (el) el.textContent = new Date(lastBackup).toLocaleDateString();
}

// Update sync status
pendingSyncItems = await getAllFromLocal('syncQueue');
updateSyncStatus();

// Setup real-time sync when connected
if (sb) {
    setupRealtimeSync();
}

// Auto-purge old drafts silently (before check runs)
try {
    var oldDraft = await getFromLocal('drafts', 'current_draft');
    if (oldDraft && oldDraft.savedAt && (Date.now() - new Date(oldDraft.savedAt).getTime() > 60*60*1000)) {
        await clearDraft(); // silently clear drafts older than 1 hour
    }
} catch(e) {}

// Check for draft on startup (only once per browser session)
checkForDraft();

console.log('DivertScan v7.2 Enhanced initialized');
```

}

// Override initial app load to check session first
window.onload = async function() {
// Load company info
const savedCompany = localStorage.getItem(â€˜divertscan_companyâ€™);
if (savedCompany) {
try { companyInfo = JSON.parse(savedCompany); } catch(e) {}
}

```
// Ensure keys are restored before doing anything
await restoreAllKeys();

// Initialize bulletproof features
await initBulletproof();

// Check for existing session â€” if found, skip login screen
if (!checkExistingSession()) {
    // No session â€” stay on login screen, make sure it's visible
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('appContainer').classList.remove('active');
    console.log('No session found â€” showing login screen');
}
```

};
</script>

</div><!-- End app-container -->

<!-- Navigation bars OUTSIDE app-container for reliable position:fixed on iPad Safari -->

<nav class="nav" id="adminNav">
<div class="nav-item active" onclick="showTab('dashboard')">ğŸ <span>Home</span></div>
<div class="nav-item" onclick="showTab('pending')">â³<span>Pending</span></div>
<div class="nav-item" onclick="showTab('projects')">ğŸ“<span>Projects</span></div>
<div class="nav-item" onclick="showTab('reports')">ğŸ“Š<span>Reports</span></div>
<div class="nav-item admin-only" onclick="showTab('settings')">âš™ï¸<span>Settings</span></div>
</nav>

<nav class="nav hidden" id="operatorNav">
<div class="nav-item active" onclick="showTab('operatorScan')">ğŸ“¸<span>Scan</span></div>
<div class="nav-item" onclick="showTab('operatorHistory')">ğŸ“‹<span>My Scans</span></div>
</nav>

<nav class="nav hidden" id="customerNav">
<div class="nav-item active" onclick="showTab('dashboard')">ğŸ <span>Dashboard</span></div>
<div class="nav-item" onclick="showTab('customerUpload')">ğŸ“¤<span>Upload</span></div>
<div class="nav-item" onclick="showTab('reports')">ğŸ“Š<span>Reports</span></div>
</nav>

</body>
</html>