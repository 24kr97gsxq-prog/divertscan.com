<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DivertScan ¬© 2026 | The Carbon Truth in Every Load</title>
    <meta name="description" content="LEED-compliant waste diversion tracking with Point-of-Capture Verification">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        :root {
            --primary: #059669; --primary-dark: #047857; --primary-light: #10b981;
            --accent: #f59e0b; --danger: #dc2626; --success: #16a34a;
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
            --text-primary: #f8fafc; --text-secondary: #94a3b8; --text-muted: #64748b;
            --border: #475569; --radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        
        /* Screens */
        .screen { position: fixed; inset: 0; background: var(--bg-dark); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s; }
        .screen.hidden { opacity: 0; pointer-events: none; }
        .loader-logo, .login-logo { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 1.5rem; }
        .loader-logo span, .login-logo span { color: var(--text-primary); }
        .loader-spinner { width: 48px; height: 48px; border: 4px solid var(--bg-card); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-status { margin-top: 1rem; color: var(--text-secondary); font-size: 0.875rem; }
        .loader-error { color: var(--danger); margin-top: 1rem; text-align: center; max-width: 300px; display: none; }
        .loader-error.show { display: block; }
        .loader-error button { margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 0.5rem; }

        /* Login */
        .login-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; width: 90%; max-width: 400px; }
        .login-title { text-align: center; margin-bottom: 1.5rem; }
        .login-title h2 { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .login-title p { color: var(--text-muted); font-size: 0.875rem; }
        .user-select-grid { display: flex; flex-direction: column; gap: 0.75rem; }
        .user-btn { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-input); border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: left; color: var(--text-primary); }
        .user-btn:hover { border-color: var(--primary); background: rgba(5, 150, 105, 0.1); }
        .user-btn.selected { border-color: var(--primary); background: rgba(5, 150, 105, 0.15); }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; font-weight: 600; flex-shrink: 0; }
        .user-avatar.admin { background: linear-gradient(135deg, #059669, #10b981); color: white; }
        .user-avatar.operator { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; }
        .user-avatar.driver { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
        .user-info h3 { font-size: 1rem; font-weight: 600; }
        .user-info p { font-size: 0.75rem; color: var(--text-muted); }
        .pin-input-group { margin-top: 1.5rem; display: none; }
        .pin-input-group.show { display: block; }
        .pin-input-group label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .pin-input { width: 100%; padding: 0.875rem; font-size: 1.5rem; text-align: center; letter-spacing: 0.5rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); }
        .pin-input:focus { outline: none; border-color: var(--primary); }
        .login-btn { width: 100%; margin-top: 1rem; padding: 0.875rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .login-error { color: var(--danger); font-size: 0.875rem; text-align: center; margin-top: 1rem; display: none; }
        .login-error.show { display: block; }

        /* App */
        #app { display: none; }
        #app.loaded { display: block; }
        
        .header { background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-dark) 100%); border-bottom: 1px solid var(--border); padding: 1rem; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .logo span { color: var(--text-primary); }
        .tagline { font-size: 0.75rem; color: var(--text-muted); display: block; }
        .header-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .current-user { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: var(--bg-input); border-radius: 8px; font-size: 0.875rem; }
        .current-user .avatar { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: white; }
        .current-user .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; margin-left: 0.5rem; }

        .btn { padding: 0.625rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .main { max-width: 1400px; margin: 0 auto; padding: 1.5rem 1rem; }
        
        .tabs { display: flex; gap: 0.25rem; background: var(--bg-card); padding: 0.25rem; border-radius: var(--radius); margin-bottom: 1.5rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { padding: 0.75rem 1rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem; cursor: pointer; background: transparent; color: var(--text-secondary); border: none; white-space: nowrap; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; }
        .tab:hover:not(.active) { background: var(--bg-input); }
        .tab.admin-only { display: none; }
        body.is-admin .tab.admin-only { display: block; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 1.5rem; margin-bottom: 1rem; }
        .card-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; text-align: center; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 0.375rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.625rem 0.875rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 0.875rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }

        .table-container { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-input); font-weight: 600; color: var(--text-secondary); white-space: nowrap; }
        tr:last-child td { border-bottom: none; }

        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.5rem; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; justify-content: flex-end; }

        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--primary); background: rgba(5,150,105,0.05); }
        .upload-zone input { display: none; }
        .upload-preview { max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 1rem; }

        .ocr-result { background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-top: 1rem; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }
        .ocr-loading { display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); }

        .verification-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(5,150,105,0.1); border: 1px solid var(--primary); border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }
        .capture-info { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); background: var(--bg-input); padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; }

        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; min-width: 280px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } }
        .toast-success { border-left: 4px solid var(--success); }
        .toast-error { border-left: 4px solid var(--danger); }
        .toast-info { border-left: 4px solid var(--primary); }

        .footer { text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.75rem; border-top: 1px solid var(--border); margin-top: 2rem; }

        .connection-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--danger); }
        .status-dot.connected { background: var(--success); }

        .news-item { padding: 1rem; border-left: 3px solid var(--primary); background: var(--bg-input); border-radius: 0 8px 8px 0; margin-bottom: 0.75rem; }
        .news-item h4 { font-size: 0.9rem; margin-bottom: 0.25rem; }
        .news-item p { font-size: 0.75rem; color: var(--text-muted); }
        .news-item a { color: var(--primary); text-decoration: none; }

        .resource-link { display: block; padding: 0.75rem 1rem; background: var(--bg-input); border-radius: 8px; margin-bottom: 0.5rem; color: var(--text-primary); text-decoration: none; transition: background 0.2s; }
        .resource-link:hover { background: var(--border); }
        .resource-link span { color: var(--text-muted); font-size: 0.75rem; display: block; }

        .weight-source-btn { transition: all 0.2s; }
        .weight-source-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .weight-source-panel { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 640px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .header-actions { flex-direction: column; }
            .current-user { justify-content: center; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="screen" id="loading-screen">
        <div class="loader-logo">Divert<span>Scan</span></div>
        <div class="loader-spinner" id="loader-spinner"></div>
        <div class="loader-status" id="loader-status">Initializing...</div>
        <div class="loader-error" id="loader-error">
            <p id="error-message">Connection failed</p>
            <button onclick="location.reload()">Retry</button>
            <button onclick="continueOffline()" style="background:var(--bg-input);">Continue Offline</button>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="screen hidden" id="login-screen">
        <div class="login-box">
            <div class="login-title">
                <div class="login-logo">Divert<span>Scan</span></div>
                <h2>Select Your Account</h2>
                <p>Choose who you are to continue</p>
            </div>
            <div class="user-select-grid" id="user-select-grid"></div>
            <div class="pin-input-group" id="pin-group">
                <label>Enter PIN</label>
                <input type="tel" class="pin-input" id="pin-input" maxlength="4" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            </div>
            <button class="login-btn" id="login-btn" disabled>Sign In</button>
            <p class="login-error" id="login-error">Incorrect PIN</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app">
        <header class="header">
            <div class="header-content">
                <div>
                    <div class="logo">Divert<span>Scan</span></div>
                    <span class="tagline">The Carbon Truth in Every Load</span>
                </div>
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="connection-text">Connecting...</span>
                </div>
                <div class="header-actions">
                    <div class="current-user">
                        <div class="avatar admin" id="user-avatar">R</div>
                        <span id="user-name">User</span>
                        <button class="logout-btn" onclick="logout()">‚úï</button>
                    </div>
                    <button class="btn btn-primary" onclick="openNewLoadModal()">+ New Load</button>
                </div>
            </div>
        </header>

        <main class="main">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-loads">0</div><div class="stat-label">Loads</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-tonnage">0</div><div class="stat-label">Tons</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-diversion">0%</div><div class="stat-label">Diverted</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-carbon">0</div><div class="stat-label">CO‚ÇÇe Saved</div></div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="loads">Loads</button>
                <button class="tab" data-tab="projects">Projects</button>
                <button class="tab" data-tab="materials">Materials</button>
                <button class="tab admin-only" data-tab="reports">Reports</button>
                <button class="tab admin-only" data-tab="watchtower">Watchtower</button>
                <button class="tab admin-only" data-tab="settings">Settings</button>
            </div>

            <!-- Loads Tab -->
            <div class="tab-content active" id="tab-loads">
                <div class="card">
                    <div class="card-title">üì¶ Recent Loads</div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Date</th><th>Project</th><th>Material</th><th>Tons</th><th>Destination</th><th>By</th><th>Verified</th></tr></thead>
                            <tbody id="loads-table"><tr><td colspan="7" style="text-align:center;color:var(--text-muted);">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div class="tab-content" id="tab-projects">
                <div class="card">
                    <div class="card-title">üìÅ Active Projects</div>
                    <div id="projects-list"></div>
                </div>
            </div>

            <!-- Materials Tab -->
            <div class="tab-content" id="tab-materials">
                <div class="card">
                    <div class="card-title">üß± Materials & GWP Coefficients</div>
                    <p style="color:var(--text-muted);margin-bottom:1rem;font-size:0.875rem;">Global Warming Potential values from EPA WARM v15. Tier 1 materials receive enhanced LEED v5 credits.</p>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Material</th><th>Category</th><th>GWP (MT CO‚ÇÇe/ton)</th><th>LEED Tier</th></tr></thead>
                            <tbody id="materials-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="tab-reports">
                <div class="card">
                    <div class="card-title">üìä Export Reports</div>
                    <div class="form-grid" style="margin-bottom:1.5rem;">
                        <div class="form-group">
                            <label>Project Filter</label>
                            <select id="report-project"><option value="">All Projects</option></select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <select id="report-range">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="exportExcel()">üì• Dalmex Excel (24-col)</button>
                        <button class="btn btn-secondary" onclick="exportLEEDReport()">üìã LEED Compliance</button>
                        <button class="btn btn-secondary" onclick="exportAuditLog()">üìù Audit Trail</button>
                    </div>
                </div>
            </div>

            <!-- Watchtower Tab -->
            <div class="tab-content" id="tab-watchtower">
                <div class="card">
                    <div class="card-title">üåê Industry Watchtower</div>
                    <p style="color:var(--text-muted);margin-bottom:1.5rem;font-size:0.875rem;">LEED v5 updates, regulatory news, and industry resources</p>
                    
                    <h4 style="color:var(--primary);margin-bottom:1rem;">üì∞ LEED v5 Key Changes (2024-2026)</h4>
                    <div class="news-item">
                        <h4>Tier 1 Circularity Credits Enhanced</h4>
                        <p>Reuse materials now receive 2x weighted multiplier for MR credits. Wood salvage, fixture reuse, and appliance donation qualify.</p>
                    </div>
                    <div class="news-item">
                        <h4>GWP Coefficients Now Required</h4>
                        <p>All diversion reports must include Global Warming Potential calculations. DivertScan uses EPA WARM v15 coefficients.</p>
                    </div>
                    <div class="news-item">
                        <h4>Chain of Custody Documentation</h4>
                        <p>Point-of-capture verification with GPS/IP timestamps becoming standard for LEED auditor acceptance.</p>
                    </div>

                    <h4 style="color:var(--primary);margin:1.5rem 0 1rem;">üîó Official Resources</h4>
                    <a href="https://www.usgbc.org/leed" target="_blank" class="resource-link">
                        USGBC LEED Official
                        <span>usgbc.org/leed</span>
                    </a>
                    <a href="https://www.epa.gov/warm" target="_blank" class="resource-link">
                        EPA WARM Calculator v15
                        <span>epa.gov/warm</span>
                    </a>
                    <a href="https://www.usgbc.org/credits" target="_blank" class="resource-link">
                        LEED Credit Library
                        <span>MR Credit: Construction Waste Management</span>
                    </a>
                    <a href="https://www.tceq.texas.gov" target="_blank" class="resource-link">
                        Texas TCEQ
                        <span>State environmental regulations</span>
                    </a>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <div class="card">
                    <div class="card-title">‚öôÔ∏è Settings</div>
                    
                    <div class="form-group">
                        <label>OpenAI API Key (for AI Analysis & OCR)</label>
                        <div style="display:flex;gap:0.5rem;">
                            <input type="password" id="settings-api-key" placeholder="sk-..." style="flex:1;">
                            <button class="btn btn-primary" onclick="saveApiKey()">Save</button>
                        </div>
                        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem;">
                            Get your key at <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--primary);">platform.openai.com/api-keys</a>
                        </p>
                    </div>

                    <div class="form-group" style="margin-top:1.5rem;">
                        <label>API Key Status</label>
                        <div id="api-key-status" style="padding:0.75rem;background:var(--bg-input);border-radius:8px;">
                            Checking...
                        </div>
                    </div>

                    <hr style="border:none;border-top:1px solid var(--border);margin:1.5rem 0;">

                    <div class="card-title" style="font-size:1rem;">‚öñÔ∏è Scale Connection</div>
                    <p style="color:var(--text-muted);font-size:0.875rem;margin-bottom:1rem;">Connect directly to your Avery Weigh-Tronix scale via USB/Serial</p>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Scale Model</label>
                            <select id="scale-model">
                                <option value="avery-1310">Avery Weigh-Tronix 1310</option>
                                <option value="avery-zm303">Avery Weigh-Tronix ZM303</option>
                                <option value="rice-lake">Rice Lake</option>
                                <option value="other">Other (9600 baud)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Baud Rate</label>
                            <select id="scale-baud">
                                <option value="9600" selected>9600</option>
                                <option value="19200">19200</option>
                                <option value="38400">38400</option>
                            </select>
                        </div>
                    </div>

                    <div style="background:var(--bg-input);padding:1rem;border-radius:8px;margin-bottom:1rem;">
                        <div style="font-weight:600;margin-bottom:0.5rem;">Connection Requirements:</div>
                        <ul style="font-size:0.875rem;color:var(--text-muted);margin-left:1.5rem;">
                            <li>Chrome or Edge browser (Web Serial API)</li>
                            <li>USB-to-Serial adapter connected to scale</li>
                            <li>Scale configured for continuous output or polling</li>
                        </ul>
                    </div>

                    <button class="btn btn-secondary" onclick="testScaleConnection()">üîå Test Connection</button>

                    <hr style="border:none;border-top:1px solid var(--border);margin:1.5rem 0;">

                    <div class="form-group">
                        <label>App Version</label>
                        <p style="color:var(--text-muted);">DivertScan ¬© 2026 v2.2.0</p>
                    </div>

                    <div class="form-group">
                        <label>Current User</label>
                        <p id="settings-current-user" style="color:var(--text-muted);">-</p>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p><strong>DivertScan ¬© 2026</strong> | Powered by Dalmex Recycling LLC</p>
            <p style="margin-top:0.5rem;">Point-of-Capture Verification‚Ñ¢ | LEED v5 Compliant</p>
        </footer>
    </div>

    <!-- New Load Modal -->
    <div class="modal-overlay" id="new-load-modal">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header"><h3>Add New Load</h3><button class="modal-close" onclick="closeModal('new-load-modal')">√ó</button></div>
            <div class="modal-body">
                <div class="verification-badge">üõ°Ô∏è Point-of-Capture Verification Active</div>
                
                <!-- Step 1: Weight Source Selection -->
                <div style="margin-bottom:1.5rem;">
                    <div style="font-weight:600;margin-bottom:0.75rem;">üìä Step 1: Get Weight</div>
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem;">
                        <button type="button" class="btn btn-secondary weight-source-btn active" data-source="ticket" onclick="selectWeightSource('ticket')">
                            üé´ Scale Ticket
                        </button>
                        <button type="button" class="btn btn-secondary weight-source-btn" data-source="scale" onclick="selectWeightSource('scale')">
                            ‚öñÔ∏è Live Scale
                        </button>
                        <button type="button" class="btn btn-secondary weight-source-btn" data-source="manual" onclick="selectWeightSource('manual')">
                            ‚úèÔ∏è Manual Entry
                        </button>
                    </div>
                </div>

                <!-- Ticket Upload (default) -->
                <div id="weight-source-ticket" class="weight-source-panel">
                    <div class="upload-zone" id="ticket-zone">
                        <input type="file" id="ticket-input-camera" accept="image/*" capture="environment" onchange="handleTicketScan(this)" style="display:none;">
                        <input type="file" id="ticket-input-upload" accept="image/*,.pdf" onchange="handleTicketScan(this)" style="display:none;">
                        <div id="ticket-placeholder">
                            <div style="font-size:2rem;margin-bottom:0.5rem;">üé´</div>
                            <div style="margin-bottom:0.75rem;"><strong>Scan Scale Ticket</strong></div>
                            <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('ticket-input-camera').click()">üì∑ Camera</button>
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('ticket-input-upload').click()">üìÅ Upload</button>
                            </div>
                        </div>
                        <img id="ticket-preview" class="upload-preview" style="display:none;">
                    </div>
                    <div id="ocr-status" style="display:none;" class="ocr-loading">
                        <div class="loader-spinner" style="width:20px;height:20px;border-width:2px;"></div>
                        <span>Reading ticket...</span>
                    </div>
                    <div id="ocr-result" class="ocr-result" style="display:none;"></div>
                </div>

                <!-- Live Scale Connection -->
                <div id="weight-source-scale" class="weight-source-panel" style="display:none;">
                    <div class="card" style="margin-bottom:0;background:var(--bg-input);">
                        <div style="text-align:center;padding:1rem;">
                            <div style="font-size:2.5rem;margin-bottom:0.5rem;">‚öñÔ∏è</div>
                            <div style="font-weight:600;margin-bottom:0.5rem;">Avery Weigh-Tronix Scale</div>
                            <div id="scale-status" style="color:var(--text-muted);font-size:0.875rem;margin-bottom:1rem;">Not connected</div>
                            <div id="scale-reading" style="font-size:2rem;font-weight:700;color:var(--primary);display:none;">
                                <span id="scale-weight-display">0</span> <span style="font-size:1rem;">lbs</span>
                            </div>
                            <div style="margin-top:1rem;">
                                <button type="button" class="btn btn-primary" onclick="connectScale()">üîå Connect Scale</button>
                                <button type="button" class="btn btn-secondary" onclick="captureScaleWeight()" id="capture-scale-btn" disabled>üì• Capture Weight</button>
                            </div>
                            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:1rem;">
                                Requires Web Serial API (Chrome/Edge)<br>
                                Configure in Settings ‚Üí Scale Connection
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Entry -->
                <div id="weight-source-manual" class="weight-source-panel" style="display:none;">
                    <div style="background:var(--bg-input);padding:1rem;border-radius:8px;text-align:center;">
                        <div style="font-size:1.5rem;margin-bottom:0.5rem;">‚úèÔ∏è</div>
                        <div style="font-weight:600;margin-bottom:0.75rem;">Enter Weight Manually</div>
                        <div style="display:flex;gap:0.5rem;justify-content:center;align-items:center;">
                            <input type="number" id="manual-weight-lbs" step="1" min="0" placeholder="Weight" style="width:120px;text-align:center;font-size:1.25rem;">
                            <select id="manual-weight-unit" style="width:80px;">
                                <option value="lbs">lbs</option>
                                <option value="tons">tons</option>
                            </select>
                            <button type="button" class="btn btn-primary" onclick="applyManualWeight()">Apply</button>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <hr style="border:none;border-top:1px solid var(--border);margin:1.5rem 0;">

                <!-- Step 2: Debris Photo (Optional) -->
                <div style="margin-bottom:1rem;">
                    <div style="font-weight:600;margin-bottom:0.75rem;">üì∑ Step 2: Debris Analysis <span style="font-weight:400;color:var(--text-muted);">(Optional - improves LEED reporting)</span></div>
                    <div class="upload-zone" id="photo-zone" style="padding:1rem;">
                        <input type="file" id="photo-input" accept="image/*" capture="environment" onchange="handlePhotoUpload(this)" style="display:none;">
                        <input type="file" id="photo-input-multi" accept="image/*" multiple onchange="handleMultiPhotoUpload(this)" style="display:none;">
                        <div id="photo-placeholder">
                            <div style="display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;align-items:center;">
                                <span style="font-size:1.25rem;">üì∑</span>
                                <span>Add debris photos for AI material analysis</span>
                                <button type="button" class="btn btn-secondary" style="padding:0.375rem 0.75rem;" onclick="document.getElementById('photo-input').click()">Take Photo</button>
                                <button type="button" class="btn btn-secondary" style="padding:0.375rem 0.75rem;" onclick="document.getElementById('photo-input-multi').click()">Upload Multiple</button>
                            </div>
                        </div>
                        <div id="photo-previews" style="display:none;"></div>
                    </div>
                </div>
                <div id="ai-suggestion" style="display:none;padding:1rem;background:var(--bg-input);border-radius:8px;margin-bottom:1rem;">
                    <div id="ai-material"></div>
                </div>

                <!-- Divider -->
                <hr style="border:none;border-top:1px solid var(--border);margin:1.5rem 0;">

                <!-- Step 3: Load Details -->
                <div style="font-weight:600;margin-bottom:0.75rem;">üìã Step 3: Load Details</div>
                <form id="new-load-form">
                    <div class="form-grid">
                        <div class="form-group"><label>Project *</label><select id="load-project" required><option value="">Select Project</option></select></div>
                        <div class="form-group"><label>Date *</label><input type="date" id="load-date" required></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Material *</label><select id="load-material" required><option value="">Select Material</option></select></div>
                        <div class="form-group">
                            <label>Weight (tons) *</label>
                            <input type="number" id="load-weight" step="0.01" min="0" required placeholder="0.00">
                            <div id="weight-source-label" style="font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem;"></div>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Destination *</label>
                            <select id="load-destination-type" required>
                                <option value="">Select</option>
                                <option value="recycling">Recycling Facility</option>
                                <option value="reuse">Reuse/Donation</option>
                                <option value="landfill">Landfill</option>
                                <option value="composting">Composting</option>
                                <option value="wte">Waste-to-Energy</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Facility Name</label><input type="text" id="load-facility" placeholder="Destination facility"></div>
                    </div>
                    <div class="form-grid">
                        <div class="form-group"><label>Hauler</label><input type="text" id="load-hauler" placeholder="Hauler company"></div>
                        <div class="form-group"><label>Ticket/Manifest #</label><input type="text" id="load-ticket" placeholder="Scale ticket number"></div>
                    </div>
                    <div class="form-group"><label>Notes</label><textarea id="load-notes" rows="2" placeholder="Additional notes..."></textarea></div>
                    <div class="capture-info" id="capture-info">Capturing verification data...</div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('new-load-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLoad()">Save Load</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
    // ========== CONFIG ==========
    const CONFIG = {
        SUPABASE_URL: 'https://rnaujdajnrlvndhmhvbk.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJuYXVqZGFqbnJsdm5kaG1odmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc3NTY2NDUsImV4cCI6MjA1MzMzMjY0NX0.T-DPJVQkfhngFDgcPOVNgnbBJbRpWxgi3D7Ts3ZWSRM'
    };

    const USERS = [
        { id: 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa', name: 'Robert', company: 'DivertScan', role: 'admin', pin: '1234', initials: 'RA' },
        { id: 'bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb', name: 'Dalmex Floor', company: 'Dalmex Recycling', role: 'operator', pin: '5678', initials: 'DF' },
        { id: 'cccccccc-cccc-cccc-cccc-cccccccccccc', name: 'Jaguar Driver', company: 'Jaguar Waste', role: 'driver', pin: '9012', initials: 'JD' }
    ];

    const MATERIALS = [
        { name: 'Concrete', category: 'Aggregate', density: 4050, gwp: 0.107, tier: 'Standard' },
        { name: 'Asphalt', category: 'Aggregate', density: 3960, gwp: 0.094, tier: 'Standard' },
        { name: 'Wood - Clean', category: 'Wood', density: 600, gwp: 0.912, tier: 'Tier 1' },
        { name: 'Wood - Treated', category: 'Wood', density: 650, gwp: 0.312, tier: 'Standard' },
        { name: 'Metal - Ferrous', category: 'Metal', density: 1600, gwp: 1.831, tier: 'Standard' },
        { name: 'Metal - Non-Ferrous', category: 'Metal', density: 1200, gwp: 4.876, tier: 'Standard' },
        { name: 'Drywall/Gypsum', category: 'Drywall', density: 800, gwp: 0.184, tier: 'Standard' },
        { name: 'Cardboard/OCC', category: 'Paper', density: 200, gwp: 3.112, tier: 'Standard' },
        { name: 'Plastic - Mixed', category: 'Plastic', density: 400, gwp: 1.423, tier: 'Standard' },
        { name: 'Roofing Materials', category: 'Mixed', density: 1100, gwp: 0.156, tier: 'Standard' },
        { name: 'Brick/Masonry', category: 'Aggregate', density: 3200, gwp: 0.089, tier: 'Standard' },
        { name: 'Glass', category: 'Glass', density: 2500, gwp: 0.423, tier: 'Standard' },
        { name: 'Carpet', category: 'Mixed', density: 350, gwp: 2.156, tier: 'Standard' },
        { name: 'Insulation', category: 'Mixed', density: 150, gwp: 0.534, tier: 'Standard' },
        { name: 'Mixed C&D', category: 'Mixed', density: 1500, gwp: 0.267, tier: 'Standard' },
        { name: 'Land Clearing Debris', category: 'Organic', density: 500, gwp: 0.756, tier: 'Tier 1' },
        { name: 'Fixtures - Reuse', category: 'Reuse', density: 800, gwp: 2.5, tier: 'Tier 1' },
        { name: 'Appliances - Reuse', category: 'Reuse', density: 700, gwp: 3.2, tier: 'Tier 1' }
    ];

    const DEFAULT_PROJECTS = [
        { id: '11111111-1111-1111-1111-111111111111', name: "Children's Hospital Phase 2", client: "Children's Medical Center" },
        { id: '22222222-2222-2222-2222-222222222222', name: 'DFW Airport Terminal C', client: 'DFW Airport' },
        { id: '33333333-3333-3333-3333-333333333333', name: 'Frisco Town Center', client: 'City of Frisco' }
    ];

    // ========== STATE ==========
    let supabaseClient = null;
    let currentUser = null;
    let selectedUserId = null;
    let gpsData = null;
    let ipData = null;
    let isConnected = false;
    let photoDataUrl = null;
    let ticketDataUrl = null;

    // ========== INIT ==========
    async function initialize() {
        try {
            updateStatus('Connecting...');
            if (typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                const { error } = await supabaseClient.from('loads').select('id').limit(1);
                isConnected = !error;
            }
            updateStatus('Loading...');
            getGPSData().then(d => gpsData = d);
            getIPData().then(d => ipData = d);
            
            const saved = localStorage.getItem('divertscan_user');
            if (saved) { currentUser = JSON.parse(saved); showApp(); }
            else { showLogin(); }
            updateConnectionStatus();
        } catch (e) {
            console.error(e);
            showError('Connection failed: ' + e.message);
        }
    }

    function updateStatus(msg) { document.getElementById('loader-status').textContent = msg; }
    function showError(msg) {
        document.getElementById('loader-spinner').style.display = 'none';
        document.getElementById('loader-status').style.display = 'none';
        document.getElementById('error-message').textContent = msg;
        document.getElementById('loader-error').classList.add('show');
    }
    function continueOffline() { isConnected = false; showLogin(); }
    function showLogin() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
        renderUserSelect();
    }
    function showApp() {
        document.getElementById('loading-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app').classList.add('loaded');
        initApp();
        applyUserRole();
        updateApiKeyStatus();
    }

    // ========== LOGIN ==========
    function renderUserSelect() {
        document.getElementById('user-select-grid').innerHTML = USERS.map(u => `
            <button type="button" class="user-btn" data-id="${u.id}">
                <div class="user-avatar ${u.role}">${u.initials}</div>
                <div class="user-info"><h3>${u.name}</h3><p>${u.company} ‚Ä¢ ${u.role}</p></div>
            </button>
        `).join('');
        document.querySelectorAll('.user-btn').forEach(btn => btn.addEventListener('click', () => selectUser(btn.dataset.id)));
    }

    function selectUser(id) {
        selectedUserId = id;
        document.querySelectorAll('.user-btn').forEach(b => b.classList.remove('selected'));
        document.querySelector(`.user-btn[data-id="${id}"]`).classList.add('selected');
        document.getElementById('pin-group').classList.add('show');
        document.getElementById('pin-input').value = '';
        document.getElementById('pin-input').focus();
        document.getElementById('login-btn').disabled = false;
        document.getElementById('login-error').classList.remove('show');
    }

    document.getElementById('pin-input').addEventListener('input', function() { if (this.value.length === 4) doLogin(); });
    document.getElementById('login-btn').addEventListener('click', doLogin);

    function doLogin() {
        const pin = document.getElementById('pin-input').value;
        const user = USERS.find(u => u.id === selectedUserId);
        if (user && user.pin === pin) {
            currentUser = user;
            localStorage.setItem('divertscan_user', JSON.stringify(user));
            showApp();
            showToast('Welcome, ' + user.name + '!', 'success');
        } else {
            document.getElementById('login-error').classList.add('show');
            document.getElementById('pin-input').value = '';
        }
    }

    function logout() {
        localStorage.removeItem('divertscan_user');
        currentUser = null;
        document.getElementById('app').classList.remove('loaded');
        document.body.classList.remove('is-admin');
        showLogin();
    }

    function applyUserRole() {
        if (!currentUser) return;
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-avatar').textContent = currentUser.initials;
        document.getElementById('user-avatar').className = 'avatar ' + currentUser.role;
        document.body.classList.toggle('is-admin', currentUser.role === 'admin');
    }

    // ========== APP ==========
    function initApp() {
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });
        document.getElementById('load-date').valueAsDate = new Date();
        loadMaterials();
        loadProjects();
        loadLoads();
    }

    function loadMaterials() {
        document.getElementById('load-material').innerHTML = '<option value="">Select Material</option>' + MATERIALS.map(m => `<option value="${m.name}">${m.name}</option>`).join('');
        document.getElementById('materials-table').innerHTML = MATERIALS.map(m => `
            <tr>
                <td>${m.name}</td>
                <td>${m.category}</td>
                <td>${m.gwp.toFixed(3)}</td>
                <td><span class="badge ${m.tier === 'Tier 1' ? 'badge-success' : 'badge-info'}">${m.tier}</span></td>
            </tr>
        `).join('');
    }

    async function loadProjects() {
        let projects = DEFAULT_PROJECTS;
        if (isConnected && supabaseClient) {
            try {
                const { data } = await supabaseClient.from('projects').select('*');
                if (data?.length) projects = data;
            } catch (e) { console.warn('Projects fetch failed'); }
        }
        window.projectsData = projects;
        const opts = projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        document.getElementById('load-project').innerHTML = '<option value="">Select Project</option>' + opts;
        document.getElementById('report-project').innerHTML = '<option value="">All Projects</option>' + opts;
        document.getElementById('projects-list').innerHTML = projects.map(p => `
            <div style="padding:1rem;border:1px solid var(--border);border-radius:8px;margin-bottom:0.5rem;">
                <strong>${p.name}</strong><br><span style="color:var(--text-muted);font-size:0.875rem;">${p.client || ''}</span>
            </div>
        `).join('');
    }

    async function loadLoads() {
        let loads = [];
        if (isConnected && supabaseClient) {
            try {
                const { data } = await supabaseClient.from('loads').select('*').order('created_at', { ascending: false }).limit(50);
                if (data) loads = data;
            } catch (e) { console.warn('Loads fetch failed'); }
        }
        window.loadsData = loads;
        renderLoads(loads);
        updateStats();
    }

    function renderLoads(loads) {
        const tbody = document.getElementById('loads-table');
        if (!loads.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem;">No loads yet. Tap "+ New Load"</td></tr>'; return; }
        tbody.innerHTML = loads.map(l => {
            const proj = (window.projectsData || []).find(p => p.id === l.project_id);
            const isDiverted = ['recycling','reuse','composting'].includes(l.destination_type);
            const isVerified = l.gps_latitude && l.ip_address;
            return `<tr>
                <td>${new Date(l.load_date || l.created_at).toLocaleDateString()}</td>
                <td>${proj?.name || '-'}</td>
                <td>${l.material || '-'}</td>
                <td>${parseFloat(l.weight_tons||0).toFixed(2)}</td>
                <td><span class="badge ${isDiverted?'badge-success':'badge-warning'}">${l.destination_type || '-'}</span></td>
                <td>${l.entered_by_name || '-'}</td>
                <td>${isVerified ? '<span class="badge badge-success">‚úì</span>' : '<span class="badge badge-warning">‚Äî</span>'}</td>
            </tr>`;
        }).join('');
    }

    function updateStats() {
        const loads = window.loadsData || [];
        const total = loads.reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
        const diverted = loads.filter(l => ['recycling','reuse','composting'].includes(l.destination_type)).reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
        let carbon = 0;
        loads.forEach(l => {
            if (['recycling','reuse','composting'].includes(l.destination_type)) {
                const m = MATERIALS.find(x => x.name === l.material);
                if (m) carbon += parseFloat(l.weight_tons||0) * m.gwp;
            }
        });
        document.getElementById('stat-loads').textContent = loads.length;
        document.getElementById('stat-tonnage').textContent = total.toFixed(1);
        document.getElementById('stat-diversion').textContent = (total > 0 ? (diverted/total*100) : 0).toFixed(0) + '%';
        document.getElementById('stat-carbon').textContent = carbon.toFixed(1);
    }

    function updateConnectionStatus() {
        document.getElementById('status-dot').classList.toggle('connected', isConnected);
        document.getElementById('connection-text').textContent = isConnected ? 'Online' : 'Offline';
    }

    // ========== GPS/IP ==========
    async function getGPSData() {
        return new Promise(resolve => {
            if (!navigator.geolocation) { resolve(null); return; }
            navigator.geolocation.getCurrentPosition(
                p => resolve({ lat: p.coords.latitude.toFixed(6), lng: p.coords.longitude.toFixed(6), acc: p.coords.accuracy }),
                () => resolve(null), { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }
    async function getIPData() {
        try { const r = await fetch('https://api.ipify.org?format=json'); return await r.json(); }
        catch { return { ip: 'unavailable' }; }
    }

    // ========== WEIGHT SOURCE SELECTION ==========
    let currentWeightSource = 'ticket';
    let scalePort = null;
    let scaleReader = null;

    function selectWeightSource(source) {
        currentWeightSource = source;
        document.querySelectorAll('.weight-source-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.source === source);
        });
        document.querySelectorAll('.weight-source-panel').forEach(panel => {
            panel.style.display = 'none';
        });
        document.getElementById('weight-source-' + source).style.display = 'block';
    }

    function applyManualWeight() {
        const value = parseFloat(document.getElementById('manual-weight-lbs').value);
        const unit = document.getElementById('manual-weight-unit').value;
        if (!value || value <= 0) { showToast('Enter a valid weight', 'error'); return; }
        
        const tons = unit === 'tons' ? value : value / 2000;
        document.getElementById('load-weight').value = tons.toFixed(2);
        document.getElementById('weight-source-label').textContent = '‚úì Manual entry: ' + value + ' ' + unit;
        showToast('Weight: ' + tons.toFixed(2) + ' tons', 'success');
    }

    // ========== SCALE CONNECTION (Web Serial API) ==========
    async function connectScale() {
        if (!('serial' in navigator)) {
            showToast('Web Serial not supported. Use Chrome or Edge.', 'error');
            return;
        }

        try {
            document.getElementById('scale-status').textContent = 'Requesting port...';
            scalePort = await navigator.serial.requestPort();
            
            // Avery Weigh-Tronix typically uses 9600 baud, 8N1
            await scalePort.open({ 
                baudRate: 9600,
                dataBits: 8,
                stopBits: 1,
                parity: 'none'
            });

            document.getElementById('scale-status').innerHTML = '<span style="color:var(--success);">‚úÖ Connected</span>';
            document.getElementById('scale-reading').style.display = 'block';
            document.getElementById('capture-scale-btn').disabled = false;
            showToast('Scale connected!', 'success');

            // Start reading
            readScaleData();
        } catch (err) {
            console.error('Scale connection error:', err);
            document.getElementById('scale-status').textContent = '‚ùå ' + err.message;
            showToast('Connection failed: ' + err.message, 'error');
        }
    }

    async function readScaleData() {
        if (!scalePort || !scalePort.readable) return;

        const decoder = new TextDecoderStream();
        const inputDone = scalePort.readable.pipeTo(decoder.writable);
        scaleReader = decoder.readable.getReader();

        let buffer = '';
        try {
            while (true) {
                const { value, done } = await scaleReader.read();
                if (done) break;
                
                buffer += value;
                // Parse weight from common formats: "7580 LB" or "7580" or "GS,7580,LB"
                const match = buffer.match(/(\d+\.?\d*)\s*(LB|KG|lb|kg)?/);
                if (match) {
                    const weight = parseFloat(match[1]);
                    document.getElementById('scale-weight-display').textContent = weight.toLocaleString();
                    window.lastScaleWeight = weight;
                    buffer = '';
                }
                
                // Prevent buffer overflow
                if (buffer.length > 100) buffer = buffer.slice(-50);
            }
        } catch (err) {
            console.error('Scale read error:', err);
        }
    }

    function captureScaleWeight() {
        const weight = window.lastScaleWeight;
        if (!weight) {
            showToast('No weight reading available', 'error');
            return;
        }
        
        const tons = weight / 2000;
        document.getElementById('load-weight').value = tons.toFixed(2);
        document.getElementById('weight-source-label').textContent = '‚úì Live scale: ' + weight.toLocaleString() + ' lbs';
        showToast('Captured: ' + tons.toFixed(2) + ' tons', 'success');
    }

    // ========== PHOTO & OCR ==========
    let debrisPhotos = []; // Store multiple photos for analysis

    function handlePhotoUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            debrisPhotos = [e.target.result];
            showPhotoPreview([e.target.result]);
            analyzePhotos(debrisPhotos);
        };
        reader.readAsDataURL(file);
    }

    function handleMultiPhotoUpload(input) {
        const files = Array.from(input.files);
        if (!files.length) return;
        
        debrisPhotos = [];
        let loaded = 0;
        
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                debrisPhotos.push(e.target.result);
                loaded++;
                if (loaded === files.length) {
                    showPhotoPreview(debrisPhotos);
                    analyzePhotos(debrisPhotos);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    function showPhotoPreview(photos) {
        document.getElementById('photo-placeholder').style.display = 'none';
        const previewDiv = document.getElementById('photo-previews');
        previewDiv.style.display = 'flex';
        previewDiv.style.flexWrap = 'wrap';
        previewDiv.style.gap = '0.5rem';
        previewDiv.style.justifyContent = 'center';
        previewDiv.innerHTML = photos.map(p => 
            `<img src="${p}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid var(--primary);">`
        ).join('') + `<div style="width:100%;text-align:center;margin-top:0.5rem;font-size:0.8rem;color:var(--text-muted);">${photos.length} photo(s) selected</div>`;
    }

    async function analyzePhotos(photos) {
        if (!OPENAI_KEY) {
            document.getElementById('ai-material').innerHTML = '‚ö†Ô∏è OpenAI API key required. Go to <strong>Settings</strong> tab to add key.';
            document.getElementById('ai-suggestion').style.display = 'block';
            return;
        }

        document.getElementById('ai-material').innerHTML = `üîÑ Analyzing ${photos.length} photo(s)...`;
        document.getElementById('ai-suggestion').style.display = 'block';

        try {
            // Build message with all images
            const content = [{
                type: 'text',
                text: `Analyze these ${photos.length} construction/demolition debris photo(s). Estimate the COMBINED percentage breakdown of ALL visible materials.

Return TOP 5-7 materials. Return ONLY valid JSON:
{"materials":[{"name":"material name","percentage":number,"recyclable":true}],"diversion_potential":number,"confidence":number,"notes":"observation"}

Common C&D materials:
- Wood/Lumber (recyclable)
- Cardboard/OCC (recyclable)  
- Metal/Steel (recyclable)
- Concrete/Block/CMU (recyclable)
- Drywall/Gypsum (recyclable)
- Plastic/PVC (limited)
- Roofing/Shingles (limited)
- Mixed debris/Trash (not recyclable)

Percentages must total 100. diversion_potential = sum of recyclable %.`
            }];

            // Add each photo
            photos.forEach(photo => {
                content.push({ type: 'image_url', image_url: { url: photo, detail: 'high' } });
            });

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + OPENAI_KEY },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content: content }],
                    max_tokens: 800
                })
            });

            if (!response.ok) throw new Error('API error: ' + response.status);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
            if (!match) throw new Error('Could not parse response');

            displayDebrisAnalysis(JSON.parse(match[0]));
        } catch (err) {
            console.error('AI error:', err);
            document.getElementById('ai-material').innerHTML = '‚ùå ' + err.message;
        }
    }

    // OpenAI API Key - User should set this in Settings
    let OPENAI_KEY = localStorage.getItem('divertscan_openai_key') || '';

    function displayDebrisAnalysis(analysis) {
        let html = '<div style="margin-bottom:0.75rem;"><strong>üìä Material Breakdown:</strong></div>';
        html += '<div style="display:flex;flex-direction:column;gap:0.5rem;">';
        
        analysis.materials.forEach(m => {
            const icon = m.recyclable ? '‚ôªÔ∏è' : 'üóëÔ∏è';
            const barColor = m.recyclable ? 'var(--primary)' : 'var(--accent)';
            html += `<div style="display:flex;align-items:center;gap:0.5rem;">
                <span style="width:24px;">${icon}</span>
                <span style="flex:1;font-size:0.85rem;">${m.name}</span>
                <div style="width:80px;height:12px;background:var(--bg-dark);border-radius:6px;overflow:hidden;">
                    <div style="width:${m.percentage}%;height:100%;background:${barColor};"></div>
                </div>
                <span style="width:40px;text-align:right;font-weight:600;font-size:0.9rem;">${m.percentage}%</span>
            </div>`;
        });
        html += '</div>';
        
        const meetsLEED = analysis.diversion_potential >= 75;
        html += `<div style="margin-top:1rem;padding:0.75rem;background:${meetsLEED ? 'rgba(22,163,74,0.15)' : 'rgba(245,158,11,0.15)'};border-radius:8px;border-left:4px solid ${meetsLEED ? 'var(--success)' : 'var(--accent)'};">
            <div style="font-size:1.1rem;font-weight:600;">Diversion Potential: ${analysis.diversion_potential}%</div>
            <div style="font-size:0.85rem;">${meetsLEED ? '‚úÖ Meets LEED 75% target' : '‚ö†Ô∏è Below LEED 75% target'}</div>
        </div>`;

        if (analysis.confidence) {
            html += `<div style="margin-top:0.5rem;font-size:0.75rem;color:var(--text-muted);">AI Confidence: ${analysis.confidence}%</div>`;
        }
        
        if (analysis.notes) {
            html += `<div style="margin-top:0.5rem;font-size:0.8rem;color:var(--text-secondary);">üìù ${analysis.notes}</div>`;
        }

        // Add "Apply top material" button
        if (analysis.materials.length > 0) {
            const topMaterial = analysis.materials[0].name;
            const matchedMaterial = MATERIALS.find(m => 
                m.name.toLowerCase().includes(topMaterial.toLowerCase().split('/')[0]) ||
                topMaterial.toLowerCase().includes(m.name.toLowerCase().split(' ')[0])
            );
            if (matchedMaterial) {
                html += `<button type="button" class="btn btn-primary" style="margin-top:1rem;width:100%;" onclick="document.getElementById('load-material').value='${matchedMaterial.name}';showToast('Material set to ${matchedMaterial.name}','success');">
                    ‚úì Apply: ${matchedMaterial.name}
                </button>`;
            }
        }

        document.getElementById('ai-material').innerHTML = html;
        document.getElementById('ai-suggestion').style.display = 'block';
        document.getElementById('ai-suggestion').style.background = 'var(--bg-input)';
        document.getElementById('ai-suggestion').style.padding = '1rem';
        document.getElementById('ai-suggestion').style.borderRadius = '8px';
    }

    function promptApiKey() {
        const key = prompt('Enter your OpenAI API key (starts with sk-):');
        if (key && key.startsWith('sk-')) {
            OPENAI_KEY = key;
            localStorage.setItem('divertscan_openai_key', key);
            showToast('API key saved!', 'success');
        } else if (key) {
            showToast('Invalid key format', 'error');
        }
    }

    function handleTicketScan(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async e => {
            const dataUrl = e.target.result;
            document.getElementById('ticket-preview').src = dataUrl;
            document.getElementById('ticket-preview').style.display = 'block';
            document.getElementById('ticket-placeholder').style.display = 'none';
            document.getElementById('ocr-status').style.display = 'flex';
            document.getElementById('ocr-result').style.display = 'none';
            
            // Use OpenAI if key available (much better accuracy)
            if (OPENAI_KEY) {
                await ocrWithOpenAI(dataUrl);
            } else {
                await ocrWithTesseract(dataUrl);
            }
        };
        reader.readAsDataURL(file);
    }

    async function ocrWithOpenAI(dataUrl) {
        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + OPENAI_KEY },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{
                        role: 'user',
                        content: [
                            { type: 'text', text: `Extract data from this scale ticket/weight ticket image. Return ONLY valid JSON:
{"ticket_number":"string or null","date":"YYYY-MM-DD or null","time":"HH:MM or null","hauler":"company name or null","customer":"customer name or null","gross_lbs":number or null,"tare_lbs":number or null,"net_lbs":number or null,"net_tons":number or null,"material":"material type or null","facility":"facility name or null","vehicle":"truck/vehicle info or null"}

Look for: Ticket #, Date, Time, Gross weight, Tare weight, Net weight. If weight is in lbs, also calculate net_tons (lbs / 2000). Extract hauler/customer names, material type if visible.` },
                            { type: 'image_url', image_url: { url: dataUrl } }
                        ]
                    }],
                    max_tokens: 600
                })
            });

            if (!response.ok) throw new Error('API error: ' + response.status);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const match = data.choices[0].message.content.match(/\{[\s\S]*\}/);
            if (match) {
                const ticket = JSON.parse(match[0]);
                applyTicketData(ticket);
                document.getElementById('ocr-result').innerHTML = '<div style="color:var(--success);margin-bottom:0.5rem;">‚úÖ AI extracted data:</div>' + formatTicketData(ticket);
            } else {
                throw new Error('Could not parse');
            }
        } catch (err) {
            console.warn('OpenAI OCR failed:', err);
            await ocrWithTesseract(dataUrl);
            return;
        }
        document.getElementById('ocr-status').style.display = 'none';
        document.getElementById('ocr-result').style.display = 'block';
    }

    async function ocrWithTesseract(dataUrl) {
        try {
            if (typeof Tesseract !== 'undefined') {
                const result = await Tesseract.recognize(dataUrl, 'eng');
                const text = result.data.text;
                
                // Basic parsing
                const ticket = {};
                const weightMatch = text.match(/(\d+[,.]?\d*)\s*(ton|lb|pound)/i);
                if (weightMatch) {
                    let weight = parseFloat(weightMatch[1].replace(',', ''));
                    if (weightMatch[2].toLowerCase().includes('lb')) weight = weight / 2000;
                    ticket.net_tons = weight;
                }
                const ticketMatch = text.match(/(ticket|manifest|#)\s*:?\s*(\w+)/i);
                if (ticketMatch) ticket.ticket_number = ticketMatch[2];

                applyTicketData(ticket);
                document.getElementById('ocr-result').innerHTML = '<div style="color:var(--accent);margin-bottom:0.5rem;">‚ö†Ô∏è Basic OCR (add API key for better results)</div><pre style="font-size:0.7rem;max-height:80px;overflow:auto;white-space:pre-wrap;">' + text.substring(0, 300) + '</pre>';
            } else {
                document.getElementById('ocr-result').innerHTML = '‚ö†Ô∏è OCR not available. Add OpenAI API key in Settings for best results, or enter data manually.';
            }
        } catch (err) {
            document.getElementById('ocr-result').innerHTML = '‚ùå OCR failed: ' + err.message;
        }
        document.getElementById('ocr-status').style.display = 'none';
        document.getElementById('ocr-result').style.display = 'block';
    }

    function applyTicketData(ticket) {
        if (ticket.net_tons) {
            document.getElementById('load-weight').value = ticket.net_tons.toFixed(2);
            document.getElementById('weight-source-label').textContent = '‚úì From ticket: ' + ticket.net_tons.toFixed(2) + ' tons';
            showToast('Weight: ' + ticket.net_tons.toFixed(2) + ' tons', 'success');
        } else if (ticket.net_lbs) {
            const tons = ticket.net_lbs / 2000;
            document.getElementById('load-weight').value = tons.toFixed(2);
            document.getElementById('weight-source-label').textContent = '‚úì From ticket: ' + ticket.net_lbs.toLocaleString() + ' lbs';
            showToast('Weight: ' + tons.toFixed(2) + ' tons', 'success');
        }
        if (ticket.ticket_number) document.getElementById('load-ticket').value = ticket.ticket_number;
        if (ticket.date) document.getElementById('load-date').value = ticket.date;
        if (ticket.hauler) document.getElementById('load-hauler').value = ticket.hauler;
        if (ticket.facility) document.getElementById('load-facility').value = ticket.facility;
    }

    function formatTicketData(t) {
        let html = '<table style="font-size:0.8rem;width:100%;">';
        if (t.ticket_number) html += `<tr><td style="color:var(--text-muted);">Ticket #</td><td style="text-align:right;"><strong>${t.ticket_number}</strong></td></tr>`;
        if (t.date) html += `<tr><td style="color:var(--text-muted);">Date</td><td style="text-align:right;">${t.date}${t.time ? ' ' + t.time : ''}</td></tr>`;
        if (t.gross_lbs) html += `<tr><td style="color:var(--text-muted);">Gross</td><td style="text-align:right;">${t.gross_lbs.toLocaleString()} lbs</td></tr>`;
        if (t.tare_lbs) html += `<tr><td style="color:var(--text-muted);">Tare</td><td style="text-align:right;">${t.tare_lbs.toLocaleString()} lbs</td></tr>`;
        if (t.net_lbs || t.net_tons) {
            const tons = t.net_tons || (t.net_lbs / 2000);
            const lbs = t.net_lbs || (t.net_tons * 2000);
            html += `<tr><td style="color:var(--text-muted);">Net</td><td style="text-align:right;"><strong>${tons.toFixed(2)} tons</strong> (${Math.round(lbs).toLocaleString()} lbs)</td></tr>`;
        }
        if (t.hauler) html += `<tr><td style="color:var(--text-muted);">Hauler</td><td style="text-align:right;">${t.hauler}</td></tr>`;
        if (t.material) html += `<tr><td style="color:var(--text-muted);">Material</td><td style="text-align:right;">${t.material}</td></tr>`;
        if (t.facility) html += `<tr><td style="color:var(--text-muted);">Facility</td><td style="text-align:right;">${t.facility}</td></tr>`;
        html += '</table>';
        return html;
    }

    // ========== MODAL ==========
    function openNewLoadModal() {
        document.getElementById('new-load-modal').classList.add('active');
        document.getElementById('load-date').valueAsDate = new Date();
        resetUploadZones();
        updateCaptureInfo();
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    function resetUploadZones() {
        debrisPhotos = [];
        document.getElementById('photo-previews').style.display = 'none';
        document.getElementById('photo-previews').innerHTML = '';
        document.getElementById('photo-placeholder').style.display = 'block';
        document.getElementById('ticket-preview').style.display = 'none';
        document.getElementById('ticket-placeholder').style.display = 'block';
        document.getElementById('ai-suggestion').style.display = 'none';
        document.getElementById('ocr-result').style.display = 'none';
        document.getElementById('ocr-status').style.display = 'none';
    }

    function updateCaptureInfo() {
        const parts = [];
        parts.push(gpsData ? 'GPS: ' + gpsData.lat + ', ' + gpsData.lng : 'GPS: N/A');
        parts.push(ipData ? 'IP: ' + ipData.ip : 'IP: N/A');
        parts.push('User: ' + (currentUser?.name || 'Unknown'));
        parts.push('Time: ' + new Date().toLocaleString());
        document.getElementById('capture-info').textContent = parts.join(' | ');
    }

    // ========== SAVE ==========
    async function saveLoad() {
        const data = {
            project_id: document.getElementById('load-project').value,
            load_date: document.getElementById('load-date').value,
            material: document.getElementById('load-material').value,
            weight_tons: parseFloat(document.getElementById('load-weight').value),
            destination_type: document.getElementById('load-destination-type').value,
            facility_name: document.getElementById('load-facility').value || null,
            hauler: document.getElementById('load-hauler').value || null,
            ticket_number: document.getElementById('load-ticket').value || null,
            notes: document.getElementById('load-notes').value || null,
            gps_latitude: gpsData?.lat || null,
            gps_longitude: gpsData?.lng || null,
            ip_address: ipData?.ip || null,
            capture_timestamp: new Date().toISOString(),
            entered_by: currentUser?.id || null,
            entered_by_name: currentUser?.name || 'Unknown'
        };

        if (!data.project_id || !data.material || !data.weight_tons || !data.destination_type) {
            showToast('Fill all required fields', 'error'); return;
        }

        try {
            if (isConnected && supabaseClient) {
                const { error } = await supabaseClient.from('loads').insert([data]);
                if (error) throw error;
            } else {
                data.id = 'local-' + Date.now();
                data.created_at = new Date().toISOString();
                window.loadsData = window.loadsData || [];
                window.loadsData.unshift(data);
            }
            showToast('Load saved!', 'success');
            closeModal('new-load-modal');
            document.getElementById('new-load-form').reset();
            if (isConnected) loadLoads(); else { renderLoads(window.loadsData); updateStats(); }
        } catch (e) {
            console.error(e);
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ========== TOAST ==========
    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = 'toast toast-' + type;
        t.textContent = msg;
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
    }

    // ========== EXPORTS ==========
    async function loadSheetJS() {
        if (window.XLSX) return;
        return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
            s.onload = resolve; s.onerror = reject;
            document.head.appendChild(s);
        });
    }

    async function exportExcel() {
        showToast('Generating Excel...', 'info');
        try {
            await loadSheetJS();
            const loads = window.loadsData || [];
            const projects = window.projectsData || [];
            const wb = XLSX.utils.book_new();

            // Summary Sheet
            const totalTons = loads.reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
            const divertedTons = loads.filter(l => ['recycling','reuse','composting'].includes(l.destination_type)).reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
            const summary = [
                ['DivertScan ¬© 2026'],
                ['The Carbon Truth in Every Load'],
                ['Powered by Dalmex Recycling LLC'],
                [''],
                ['Report Generated:', new Date().toLocaleString()],
                ['Generated By:', currentUser?.name || 'Unknown'],
                [''],
                ['SUMMARY'],
                ['Total Loads:', loads.length],
                ['Total Tonnage:', totalTons.toFixed(2)],
                ['Diverted Tonnage:', divertedTons.toFixed(2)],
                ['Landfill Tonnage:', (totalTons - divertedTons).toFixed(2)],
                ['Diversion Rate:', (totalTons > 0 ? (divertedTons/totalTons*100) : 0).toFixed(1) + '%']
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');

            // Loads Detail (24 columns)
            const headers = ['ID','Date','Project ID','Project Name','Client','Material','Category','Weight (tons)','Weight (lbs)','Destination Type','Facility','Hauler','Ticket #','Diverted','GWP Factor','CO2e Avoided','GPS Lat','GPS Long','IP Address','Capture Time','Entered By','LEED Tier','Verified','Notes'];
            const rows = loads.map(l => {
                const proj = projects.find(p => p.id === l.project_id) || {};
                const mat = MATERIALS.find(m => m.name === l.material) || {};
                const isDiverted = ['recycling','reuse','composting'].includes(l.destination_type);
                const co2e = isDiverted ? (parseFloat(l.weight_tons||0) * (mat.gwp||0)) : 0;
                return [
                    l.id, l.load_date, l.project_id, proj.name||'', proj.client||'',
                    l.material, mat.category||'', parseFloat(l.weight_tons||0).toFixed(2), (parseFloat(l.weight_tons||0)*2000).toFixed(0),
                    l.destination_type, l.facility_name||'', l.hauler||'', l.ticket_number||'',
                    isDiverted?'Yes':'No', mat.gwp||0, co2e.toFixed(3),
                    l.gps_latitude||'', l.gps_longitude||'', l.ip_address||'', l.capture_timestamp||'',
                    l.entered_by_name||'', mat.tier||'', (l.gps_latitude && l.ip_address)?'Yes':'No', l.notes||''
                ];
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([headers, ...rows]), 'Loads Detail');

            // Materials Sheet
            const matHeaders = ['Material','Category','Density (lb/yd¬≥)','GWP (MT CO2e/ton)','LEED Tier'];
            const matRows = MATERIALS.map(m => [m.name, m.category, m.density, m.gwp, m.tier]);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([matHeaders, ...matRows]), 'Materials');

            // Watchtower Sheet
            const watch = [
                ['DivertScan ¬© 2026 - Industry Watchtower'],
                [''],
                ['LEED v5 KEY UPDATES'],
                ['‚Ä¢ Tier 1 Circularity credits provide 2x weighted multiplier for reuse materials'],
                ['‚Ä¢ GWP coefficients required for all carbon tracking'],
                ['‚Ä¢ Chain-of-custody documentation with point-of-capture verification'],
                [''],
                ['RESOURCES'],
                ['USGBC LEED', 'https://www.usgbc.org/leed'],
                ['EPA WARM Calculator', 'https://www.epa.gov/warm'],
                ['LEED Credit Library', 'https://www.usgbc.org/credits'],
                ['Texas TCEQ', 'https://www.tceq.texas.gov']
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(watch), 'Industry Watchtower');

            XLSX.writeFile(wb, 'DivertScan_Report_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showToast('Excel downloaded!', 'success');
        } catch (e) { console.error(e); showToast('Export failed', 'error'); }
    }

    async function exportLEEDReport() {
        showToast('Generating LEED report...', 'info');
        try {
            await loadSheetJS();
            const loads = window.loadsData || [];
            const wb = XLSX.utils.book_new();

            const totalTons = loads.reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);
            const divertedTons = loads.filter(l => ['recycling','reuse','composting'].includes(l.destination_type)).reduce((s,l) => s + parseFloat(l.weight_tons||0), 0);

            const leed = [
                ['LEED v5 Construction Waste Management Report'],
                ['DivertScan ¬© 2026 - Point-of-Capture Verified'],
                [''],
                ['Report Date:', new Date().toLocaleString()],
                [''],
                ['DIVERSION SUMMARY'],
                ['Total Waste Generated (tons):', totalTons.toFixed(2)],
                ['Total Waste Diverted (tons):', divertedTons.toFixed(2)],
                ['Total to Landfill (tons):', (totalTons - divertedTons).toFixed(2)],
                ['Diversion Rate:', (totalTons > 0 ? (divertedTons/totalTons*100) : 0).toFixed(1) + '%'],
                [''],
                ['COMPLIANCE NOTES'],
                ['‚Ä¢ Diversion rate calculated per MR Credit requirements'],
                ['‚Ä¢ Point-of-capture verification provides chain-of-custody'],
                ['‚Ä¢ Tier 1 materials tracked for enhanced credits'],
                ['‚Ä¢ Certification level determined by LEED reviewer'],
                [''],
                ['VERIFICATION METHOD'],
                ['All entries captured with GPS + IP verification'],
                ['Timestamps recorded at moment of data entry']
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(leed), 'LEED Summary');

            // Material breakdown
            const matBreakdown = {};
            loads.forEach(l => {
                const m = l.material || 'Unknown';
                if (!matBreakdown[m]) matBreakdown[m] = { total: 0, diverted: 0 };
                matBreakdown[m].total += parseFloat(l.weight_tons||0);
                if (['recycling','reuse','composting'].includes(l.destination_type)) matBreakdown[m].diverted += parseFloat(l.weight_tons||0);
            });
            const mbHeaders = ['Material','Total (tons)','Diverted (tons)','Rate'];
            const mbRows = Object.entries(matBreakdown).map(([m, d]) => [m, d.total.toFixed(2), d.diverted.toFixed(2), (d.total > 0 ? (d.diverted/d.total*100) : 0).toFixed(1) + '%']);
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([mbHeaders, ...mbRows]), 'Material Breakdown');

            XLSX.writeFile(wb, 'LEED_Report_' + new Date().toISOString().split('T')[0] + '.xlsx');
            showToast('LEED report downloaded!', 'success');
        } catch (e) { console.error(e); showToast('Export failed', 'error'); }
    }

    function exportAuditLog() {
        showToast('Audit export coming soon', 'info');
    }

    // ========== SETTINGS ==========
    function saveApiKey() {
        const key = document.getElementById('settings-api-key').value.trim();
        if (key && key.startsWith('sk-')) {
            OPENAI_KEY = key;
            localStorage.setItem('divertscan_openai_key', key);
            showToast('API key saved!', 'success');
            updateApiKeyStatus();
        } else if (key) {
            showToast('Invalid key - must start with sk-', 'error');
        }
    }

    function updateApiKeyStatus() {
        const statusEl = document.getElementById('api-key-status');
        const inputEl = document.getElementById('settings-api-key');
        const userEl = document.getElementById('settings-current-user');
        
        if (statusEl) {
            if (OPENAI_KEY) {
                statusEl.innerHTML = '<span style="color:var(--success);">‚úÖ API key configured</span><br><small style="color:var(--text-muted);">Key: ' + OPENAI_KEY.substring(0,7) + '...' + OPENAI_KEY.slice(-4) + '</small>';
                if (inputEl) inputEl.value = OPENAI_KEY;
            } else {
                statusEl.innerHTML = '<span style="color:var(--accent);">‚ö†Ô∏è No API key set</span><br><small style="color:var(--text-muted);">AI debris analysis and OCR will not work without a key</small>';
            }
        }
        if (userEl && currentUser) {
            userEl.textContent = currentUser.name + ' (' + currentUser.role + ') - ' + currentUser.company;
        }
    }

    async function testScaleConnection() {
        if (!('serial' in navigator)) {
            showToast('Web Serial not supported. Use Chrome or Edge.', 'error');
            return;
        }
        showToast('Select your scale port in the popup...', 'info');
        await connectScale();
    }

    // ========== START ==========
    window.addEventListener('online', () => { isConnected = true; updateConnectionStatus(); showToast('Back online', 'success'); });
    window.addEventListener('offline', () => { isConnected = false; updateConnectionStatus(); showToast('Offline mode', 'info'); });
    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', initialize) : initialize();
    </script>
</body>
</html>
